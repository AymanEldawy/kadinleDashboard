USE [master]
GO
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE TABLE [dbo].[Account](
	[Number] [int] NOT NULL IDENTITY(1,1),
	[Guid] [uniqueidentifier] NOT NULL,
	[SecLvl] [int] NULL,
	[Name] [varchar](250) NULL,
	[LtnName] [varchar](250) NULL,
	[Code] [varchar](250) NULL,
	[CDate] [date] NULL,
	[NSons] [int] NULL,
	[Note] [varchar](250) NULL,
	[CurrencyGUID] [uniqueidentifier] NULL,
	[CurrencyVal] [float] NULL,
	[Type] [int] NULL,
	[ParentGUID] [uniqueidentifier] NULL,
	[FinalGUID] [uniqueidentifier] NULL,
	[MaxDebit] [float] NULL,
	[MinDebit] [float] NULL,
	[MaxCredit] [float] NULL,
	[MinCredit] [float] NULL,
	[SumDebit] [float] NULL,
	[SumCredit] [float] NULL,
PRIMARY KEY CLUSTERED 
(
	[Guid] ASC
)WITH (PAD_INDEX = OFF, STATISTICS_NORECOMPUTE = OFF, IGNORE_DUP_KEY = OFF, ALLOW_ROW_LOCKS = ON, ALLOW_PAGE_LOCKS = ON, OPTIMIZE_FOR_SEQUENTIAL_KEY = OFF) ON [PRIMARY]
) ON [PRIMARY]
GO
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE TABLE [dbo].[AccountAccumulate](
	[Number] [int] NOT NULL IDENTITY(1,1),
	[ParentGuid] [uniqueidentifier] NULL,
	[AccountGuid] [uniqueidentifier] NULL
) ON [PRIMARY]
GO
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE TABLE [dbo].[Alerts](
	[Guid] [uniqueidentifier] NOT NULL,
	[Number] [int] NOT NULL IDENTITY(1,1),
	[isRead] [bit] NULL,
	[Expdate] [date] NULL,
	[Details] [varchar](250) NULL,
	[Table_name] [varchar](50) NULL,
	[Entry_number] [int] NULL,
	[Date] [datetime] NULL,
PRIMARY KEY CLUSTERED 
(
	[Number] ASC
)WITH (PAD_INDEX = OFF, STATISTICS_NORECOMPUTE = OFF, IGNORE_DUP_KEY = OFF, ALLOW_ROW_LOCKS = ON, ALLOW_PAGE_LOCKS = ON, OPTIMIZE_FOR_SEQUENTIAL_KEY = OFF) ON [PRIMARY]
) ON [PRIMARY]
GO
CREATE TABLE [dbo].[AccountConformity](
	[Date] [date] NULL,
	[Guid] [uniqueidentifier] NOT NULL,
	[UserGuid] [uniqueidentifier] NULL,
	[AccountGuid] [uniqueidentifier] NULL,
	[CostGuid] [uniqueidentifier] NULL,
	[CurrencyGuid] [uniqueidentifier] NULL,
	[Debit] [float] NULL,
	[Credit] [float] NULL,
	[Note] [varchar](255) NULL,
PRIMARY KEY CLUSTERED 
(
	[Guid] ASC
)WITH (PAD_INDEX = OFF, STATISTICS_NORECOMPUTE = OFF, IGNORE_DUP_KEY = OFF, ALLOW_ROW_LOCKS = ON, ALLOW_PAGE_LOCKS = ON, OPTIMIZE_FOR_SEQUENTIAL_KEY = OFF) ON [PRIMARY]
) ON [PRIMARY]
GO
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE TABLE [dbo].[AccountDistributive](
	[Number] [int] NOT NULL IDENTITY(1,1),
	[ParentGuid] [uniqueidentifier] NULL,
	[AccountGuid] [uniqueidentifier] NULL,
	[Percent] [float] NULL
) ON [PRIMARY]
GO
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE TABLE [dbo].[AccountFavoriteConfig](
	[Number] [int] NOT NULL IDENTITY(1,1),
	[UserGuid] [uniqueidentifier] NULL,
	[AccountGuid] [uniqueidentifier] NULL
) ON [PRIMARY]
GO
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE TABLE [dbo].[AccumulateFlat](
	[Number] [int] NOT NULL IDENTITY(1,1),
	[ParentGuid] [uniqueidentifier] NULL,
	[FlatGuid] [uniqueidentifier] NULL
) ON [PRIMARY]
GO
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE TABLE [dbo].[AccumulateLand](
	[Number] [int] NOT NULL IDENTITY(1,1),
	[ParentGuid] [uniqueidentifier] NULL,
	[LandGuid] [uniqueidentifier] NULL
) ON [PRIMARY]
GO
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE TABLE [dbo].[AccumulateParking](
	[Number] [int] NOT NULL IDENTITY(1,1),
	[ParentGuid] [uniqueidentifier] NULL,
	[ParkingGuid] [uniqueidentifier] NULL
) ON [PRIMARY]
GO
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE TABLE [dbo].[AccumulateShop](
	[Number] [int] NOT NULL IDENTITY(1,1),
	[ParentGuid] [uniqueidentifier] NULL,
	[ShopGuid] [uniqueidentifier] NULL
) ON [PRIMARY]
GO
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE TABLE [dbo].[AlarmCheckTypeSource](
	[UserGuid] [uniqueidentifier] NULL,
	[CheckTypeGuid] [uniqueidentifier] NULL
) ON [PRIMARY]
GO
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE TABLE [dbo].[Apartment](
	[Number] [int] NOT NULL IDENTITY(1,1),
	[Guid] [uniqueidentifier] NOT NULL,
	[SecLvl] [int] NULL,
	[CardKind] [int] NULL,
	[Judicial] [bit] NULL,
	[Ban] [bit] NULL,
	[NO] [varchar](256) NULL,
	[UnifiedNum] [varchar](256) NULL,
	[ManservantRoom] [int] NULL,
	[DriverRoom] [int] NULL,
	[BuildingGuid] [uniqueidentifier] NULL,
	[FloorNo] [varchar](256) NULL,
	[Area] [float] NULL,
	[unity] [varchar](256) NULL,
	[ApartmentType] [varchar](256) NULL,
	[FlatKind] [varchar](256) NULL,
	[Class] [varchar](256) NULL,
	[Overlooking] [varchar](256) NULL,
	[CostPrice] [float] NULL,
	[CostCurrencyGUID] [uniqueidentifier] NULL,
	[Note] [varchar](256) NULL,
	[CostGuid] [uniqueidentifier] NULL,
	[FlatOwner] [int] NULL,
	[Details] [varchar](256) NULL,
	[OfferState] [int] NULL,
	[OfferType] [int] NULL,
	[CustomerName] [varchar](256) NULL,
	[CustomerPhone] [varchar](256) NULL,
	[Restrained] [bit] NULL,
	[PayValue] [float] NULL,
	[BondType] [varchar](256) NULL,
	[BondNo] [varchar](256) NULL,
	[BondDate] [date] NULL,
	[BathroomCount] [int] NULL,
	[BalconyCount] [int] NULL,
	[WaterCounter] [varchar](256) NULL,
	[ElectricityCounter] [varchar](256) NULL,
	[RestrainedUserGuid] [uniqueidentifier] NULL,
	[PurchaseDate] [date] NULL,
	[BeginLandValue] [float] NULL,
	[CurrencyBeginLandGuid] [uniqueidentifier] NULL,
	[CurrencyValBeginLand] [float] NULL,
	[PurchaseAccountGuid] [uniqueidentifier] NULL,
	[CreatePurchaseEntry] [bit] NULL,
	[CommissionPercent] [float] NULL,
	[CustGuid] [uniqueidentifier] NULL,
	[FlatCost] [float] NULL,
	[LastContractGUID] [uniqueidentifier] NULL,
	[CustOwnerGuid] [uniqueidentifier] NULL,
	[LtnFlatKind] [varchar](256) NULL,
	[LtnApartmentType] [varchar](256) NULL,
	[LtnClass] [varchar](256) NULL,
	[LtnOverlooking] [varchar](256) NULL,
	[Rent] [float] NULL,
	[RentCurrencyGuid] [uniqueidentifier] NULL,
	[FlatBuildingDetailsGuid] [uniqueIdentifier] NOT NULL,
PRIMARY KEY CLUSTERED 
(
	[Guid] ASC
)WITH (PAD_INDEX = OFF, STATISTICS_NORECOMPUTE = OFF, IGNORE_DUP_KEY = OFF, ALLOW_ROW_LOCKS = ON, ALLOW_PAGE_LOCKS = ON, OPTIMIZE_FOR_SEQUENTIAL_KEY = OFF) ON [PRIMARY],
 CONSTRAINT [UK_ApartmentBuildingGuid_NO_UNIQUE] UNIQUE NONCLUSTERED 
(
	[BuildingGuid] ASC,
	[NO] ASC
)WITH (PAD_INDEX = OFF, STATISTICS_NORECOMPUTE = OFF, IGNORE_DUP_KEY = OFF, ALLOW_ROW_LOCKS = ON, ALLOW_PAGE_LOCKS = ON, OPTIMIZE_FOR_SEQUENTIAL_KEY = OFF) ON [PRIMARY]
) ON [PRIMARY]
GO
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE TABLE [dbo].[ApartmentOffer](
	[Number] [int] NOT NULL IDENTITY(1,1),
	[Guid] [uniqueidentifier] NOT NULL,
	[SecLvl] [int] NULL,
	[CardKind] [int] NULL,
	[NO] [varchar](256) NULL,
	[Building] [varchar](256) NULL,
	[Customer] [varchar](256) NULL,
	[FloorNo] [varchar](256) NULL,
	[Area] [float] NULL,
	[Address] [varchar](800) NULL,
	[unity] [varchar](256) NULL,
	[ApartmentType] [varchar](256) NULL,
	[FlatKind] [varchar](256) NULL,
	[Class] [varchar](256) NULL,
	[Overlooking] [varchar](256) NULL,
	[Note] [varchar](256) NULL,
	[FlatOwner] [int] NULL,
	[Details] [varchar](256) NULL,
	[BathroomCount] [int] NULL,
	[BalconyCount] [int] NULL,
	[WaterCounter] [varchar](256) NULL,
	[ElectricityCounter] [varchar](256) NULL,
	[OfferKind] [int] NULL,
	[OfferValue] [float] NULL,
	[Delegated] [varchar](256) NULL,
	[CustPhone] [varchar](256) NULL,
	[CustMobile] [varchar](256) NULL,
	[MaxOfferValue] [float] NULL,
PRIMARY KEY CLUSTERED 
(
	[Guid] ASC
)WITH (PAD_INDEX = OFF, STATISTICS_NORECOMPUTE = OFF, IGNORE_DUP_KEY = OFF, ALLOW_ROW_LOCKS = ON, ALLOW_PAGE_LOCKS = ON, OPTIMIZE_FOR_SEQUENTIAL_KEY = OFF) ON [PRIMARY],
 CONSTRAINT [UK_ApartmentOfferBuildingGuid_NO_UNIQUE] UNIQUE NONCLUSTERED 
(
	[Building] ASC,
	[NO] ASC
)WITH (PAD_INDEX = OFF, STATISTICS_NORECOMPUTE = OFF, IGNORE_DUP_KEY = OFF, ALLOW_ROW_LOCKS = ON, ALLOW_PAGE_LOCKS = ON, OPTIMIZE_FOR_SEQUENTIAL_KEY = OFF) ON [PRIMARY]
) ON [PRIMARY]
GO
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE TABLE [dbo].[AppReport](
	[date] [date] NULL,
	[HostName] [varchar](256) NULL,
	[Comp] [varchar](256) NULL,
	[hardlimit] [int] NULL,
	[SN] [int] NULL
) ON [PRIMARY]
GO
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE TABLE [dbo].[arv_files](
	[ParentGuid] [uniqueidentifier] NULL,
	[Blobfile] [varbinary](max) NULL
) ON [PRIMARY] TEXTIMAGE_ON [PRIMARY]
GO
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE TABLE [dbo].[arv_Filter](
	[Number] [int] NOT NULL IDENTITY(1,1),
	[Guid] [uniqueidentifier] NOT NULL,
	[SecLvl] [int] NULL,
	[Kind] [int] NULL,
	[Name] [varchar](250) NULL,
	[LtnName] [varchar](250) NULL,
	[TableGuid] [uniqueidentifier] NULL,
	[ParentName] [varchar](255) NULL,
	[Note] [varchar](256) NULL,
	[sqlCmd] [varchar](8000) NULL,
PRIMARY KEY CLUSTERED 
(
	[Guid] ASC
)WITH (PAD_INDEX = OFF, STATISTICS_NORECOMPUTE = OFF, IGNORE_DUP_KEY = OFF, ALLOW_ROW_LOCKS = ON, ALLOW_PAGE_LOCKS = ON, OPTIMIZE_FOR_SEQUENTIAL_KEY = OFF) ON [PRIMARY]
) ON [PRIMARY]
GO
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE TABLE [dbo].[arv_FilterDetail](
	[ParentGuid] [uniqueidentifier] NULL,
	[id] [int] NULL,
	[Parentid] [int] NULL,
	[IsGroup] [bit] NULL,
	[Link] [int] NULL,
	[FldCaption] [varchar](255) NULL,
	[FldName] [varchar](255) NULL,
	[Condition] [varchar](25) NULL,
	[ParamKind] [int] NULL,
	[Value1] [varchar](255) NULL,
	[Value2] [varchar](255) NULL
) ON [PRIMARY]
GO
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE TABLE [dbo].[arv_FilterParams](
	[ParentGuid] [uniqueidentifier] NULL,
	[id] [int] NULL,
	[ParamName] [varchar](255) NULL,
	[ParamType] [varchar](255) NULL,
	[ParamDef] [varchar](255) NULL,
	[ParamFld] [varchar](255) NULL
) ON [PRIMARY]
GO
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE TABLE [dbo].[Assets](
	[Number] [int] NOT NULL IDENTITY(1,1),
	[Guid] [uniqueidentifier] NOT NULL,
	[SecLvl] [int] NULL,
	[AssetsGroupGuid] [uniqueidentifier] NULL,
	[Code] [varchar](256) NULL,
	[Name] [varchar](256) NULL,
	[LtnName] [varchar](256) NULL,
	[Barcode] [varchar](256) NULL,
	[IsActive] [bit] NULL,
	[Note] [varchar](256) NULL,
	[CurrencyGUID] [uniqueidentifier] NULL,
	[CurrencyVal] [float] NULL,
	[AssetsAreaGuid] [uniqueidentifier] NULL,
	[CurrentAssetsAreaGuid] [uniqueidentifier] NULL,
	[State] [varchar](256) NULL,
	[Importer] [varchar](256) NULL,
	[EnterAccountGuid] [uniqueidentifier] NULL,
	[EnterCostGuid] [uniqueidentifier] NULL,
	[EnterCreditCostGuid] [uniqueidentifier] NULL,
	[EnterValue] [float] NULL,
	[EnterDate] [date] NULL,
	[Origin] [varchar](256) NULL,
	[Company] [varchar](256) NULL,
	[EnterNote] [varchar](256) NULL,
	[CreateEntry] [bit] NULL,
	[AsstesAccountGuid] [uniqueidentifier] NULL,
	[ExpenseAccountGuid] [uniqueidentifier] NULL,
	[DepreciationAccountGuid] [uniqueidentifier] NULL,
	[DepreciationTotalAccountGuid] [uniqueidentifier] NULL,
	[ProfitAccountGuid] [uniqueidentifier] NULL,
	[lossesAccountGuid] [uniqueidentifier] NULL,
	[EvaluationAccountGuid] [uniqueidentifier] NULL,
	[Shipping] [varchar](256) NULL,
	[ShippingNo] [varchar](256) NULL,
	[ShippingDate] [date] NULL,
	[ArriveDate] [date] NULL,
	[ArrivePlace] [varchar](256) NULL,
	[ImportPermit] [varchar](256) NULL,
	[CustomsNote] [varchar](256) NULL,
	[CustomsDate] [date] NULL,
	[CustomsExpense] [varchar](256) NULL,
	[ShippingNote] [varchar](256) NULL,
	[MaintenanceContract] [varchar](256) NULL,
	[MaintenanceBeginDate] [date] NULL,
	[MaintenanceEndDate] [date] NULL,
	[Guaranty] [varchar](256) NULL,
	[GuarantyBeginDate] [date] NULL,
	[GuarantyEndDate] [date] NULL,
	[DepreciationMode] [int] NULL,
	[IsDepreciationMonthly] [int] NULL,
	[DepreciationBeginDate] [date] NULL,
	[Age] [int] NULL,
	[DepreciationAvg] [float] NULL,
	[ScrapValue] [float] NULL,
	[OldYearExtra] [float] NULL,
	[OldYearDecrease] [float] NULL,
	[OldYearDepreciation] [float] NULL,
	[OldYearMaintenance] [float] NULL,
	[IsSale] [bit] NULL,
	[SaleDate] [date] NULL,
	[SaleCustomer] [varchar](256) NULL,
	[SalesAccountGuid] [uniqueidentifier] NULL,
	[SaleValue] [float] NULL,
	[CurrencySaleGUID] [uniqueidentifier] NULL,
	[CurrencySaleVal] [float] NULL,
	[SaleNote] [varchar](256) NULL,
PRIMARY KEY CLUSTERED 
(
	[Guid] ASC
)WITH (PAD_INDEX = OFF, STATISTICS_NORECOMPUTE = OFF, IGNORE_DUP_KEY = OFF, ALLOW_ROW_LOCKS = ON, ALLOW_PAGE_LOCKS = ON, OPTIMIZE_FOR_SEQUENTIAL_KEY = OFF) ON [PRIMARY]
) ON [PRIMARY]
GO
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE TABLE [dbo].[AssetsArea](
	[Number] [int] NOT NULL IDENTITY(1,1),
	[Guid] [uniqueidentifier] NOT NULL,
	[SecLvl] [int] NULL,
	[Code] [varchar](256) NULL,
	[Name] [varchar](256) NULL,
	[LtnName] [varchar](256) NULL,
	[Note] [varchar](256) NULL,
	[ParentGuid] [uniqueidentifier] NULL,
PRIMARY KEY CLUSTERED 
(
	[Guid] ASC
)WITH (PAD_INDEX = OFF, STATISTICS_NORECOMPUTE = OFF, IGNORE_DUP_KEY = OFF, ALLOW_ROW_LOCKS = ON, ALLOW_PAGE_LOCKS = ON, OPTIMIZE_FOR_SEQUENTIAL_KEY = OFF) ON [PRIMARY]
) ON [PRIMARY]
GO
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE TABLE [dbo].[AssetsChangeArea](
	[Number] [int] NOT NULL IDENTITY(1,1),
	[Guid] [uniqueidentifier] NOT NULL,
	[SecLvl] [int] NULL,
	[AssetsGuid] [uniqueidentifier] NULL,
	[Date] [date] NULL,
	[CurrentAreaGuid] [uniqueidentifier] NULL,
	[AreaGuid] [uniqueidentifier] NULL,
	[Note] [varchar](256) NULL,
PRIMARY KEY CLUSTERED 
(
	[Guid] ASC
)WITH (PAD_INDEX = OFF, STATISTICS_NORECOMPUTE = OFF, IGNORE_DUP_KEY = OFF, ALLOW_ROW_LOCKS = ON, ALLOW_PAGE_LOCKS = ON, OPTIMIZE_FOR_SEQUENTIAL_KEY = OFF) ON [PRIMARY]
) ON [PRIMARY]
GO
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE TABLE [dbo].[AssetsDepreciation](
	[Number] [int] NOT NULL IDENTITY(1,1),
	[Guid] [uniqueidentifier] NOT NULL,
	[SecLvl] [int] NULL,
	[Date] [date] NULL,
	[CurrencyGUID] [uniqueidentifier] NULL,
	[CurrencyVal] [float] NULL,
	[CreateEntry] [bit] NULL,
	[CreditCostGUID] [uniqueidentifier] NULL,
	[DebitCostGUID] [uniqueidentifier] NULL,
	[AssetsGroupGuid] [uniqueidentifier] NULL,
	[AssetsGuid] [uniqueidentifier] NULL,
	[AssetsAreaGuid] [uniqueidentifier] NULL,
	[IsRounded] [bit] NULL,
	[Note] [varchar](256) NULL,
PRIMARY KEY CLUSTERED 
(
	[Guid] ASC
)WITH (PAD_INDEX = OFF, STATISTICS_NORECOMPUTE = OFF, IGNORE_DUP_KEY = OFF, ALLOW_ROW_LOCKS = ON, ALLOW_PAGE_LOCKS = ON, OPTIMIZE_FOR_SEQUENTIAL_KEY = OFF) ON [PRIMARY]
) ON [PRIMARY]
GO
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE TABLE [dbo].[AssetsDepreciationDetail](
	[Number] [int] NOT NULL IDENTITY(1,1),
	[ParentGuid] [uniqueidentifier] NULL,
	[AssetsGuid] [uniqueidentifier] NULL,
	[BeginDate] [date] NULL,
	[EndDate] [date] NULL,
	[AssetsValue] [float] NULL,
	[ScrapValue] [float] NULL,
	[Add] [float] NULL,
	[Decrease] [float] NULL,
	[AssetsCalcValue] [float] NULL,
	[Age] [float] NULL,
	[IsDepreciationMonthly] [int] NULL,
	[DepreciationPercentYear] [float] NULL,
	[OldDepreciation] [float] NULL,
	[DepreciationValue] [float] NULL,
	[NewDepreciation] [float] NULL,
	[NewAssetsValue] [float] NULL,
	[Note] [varchar](256) NULL
) ON [PRIMARY]
GO
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE TABLE [dbo].[AssetsGroup](
	[Number] [int] NOT NULL IDENTITY(1,1),
	[Guid] [uniqueidentifier] NOT NULL,
	[SecLvl] [int] NULL,
	[Code] [varchar](256) NULL,
	[Name] [varchar](256) NULL,
	[LtnName] [varchar](256) NULL,
	[Note] [varchar](256) NULL,
	[ParentGuid] [uniqueidentifier] NULL,
PRIMARY KEY CLUSTERED 
(
	[Guid] ASC
)WITH (PAD_INDEX = OFF, STATISTICS_NORECOMPUTE = OFF, IGNORE_DUP_KEY = OFF, ALLOW_ROW_LOCKS = ON, ALLOW_PAGE_LOCKS = ON, OPTIMIZE_FOR_SEQUENTIAL_KEY = OFF) ON [PRIMARY]
) ON [PRIMARY]
GO
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE TABLE [dbo].[AssetsOperation](
	[Number] [int] NOT NULL IDENTITY(1,1),
	[Guid] [uniqueidentifier] NOT NULL,
	[SecLvl] [int] NULL,
	[Flag] [int] NULL,
	[TypeGuid] [uniqueidentifier] NULL,
	[AssetsGuid] [uniqueidentifier] NULL,
	[Date] [date] NULL,
	[AccountGuid] [uniqueidentifier] NULL,
	[Value] [float] NULL,
	[CurrencyGUID] [uniqueidentifier] NULL,
	[CurrencyVal] [float] NULL,
	[Age] [float] NULL,
	[ScrapValue] [float] NULL,
	[DebitCostGuid] [uniqueidentifier] NULL,
	[CreditCostGuid] [uniqueidentifier] NULL,
	[IsRounded] [bit] NULL,
	[Note] [varchar](256) NULL,
PRIMARY KEY CLUSTERED 
(
	[Guid] ASC
)WITH (PAD_INDEX = OFF, STATISTICS_NORECOMPUTE = OFF, IGNORE_DUP_KEY = OFF, ALLOW_ROW_LOCKS = ON, ALLOW_PAGE_LOCKS = ON, OPTIMIZE_FOR_SEQUENTIAL_KEY = OFF) ON [PRIMARY]
) ON [PRIMARY]
GO
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE TABLE [dbo].[Bill](
	[Number] [int] NOT NULL IDENTITY(1,1),
	[Guid] [uniqueidentifier] NOT NULL,
	[SecLvl] [int] NULL,
	[TypeGuid] [uniqueidentifier] NULL,
	[Date] [date] NULL,
	[CustGuid] [uniqueidentifier] NULL,
	[CurrencyGuid] [uniqueidentifier] NULL,
	[CurrencyVal] [float] NULL,
	[PayType] [int] NULL,
	[StoreGuid] [uniqueidentifier] NULL,
	[CustAccGuid] [uniqueidentifier] NULL,
	[CostGuid] [uniqueidentifier] NULL,
	[BranchGuid] [uniqueidentifier] NULL,
	[Class] [varchar](256) NULL,
	[Note] [varchar](256) NULL,
	[EntryGuid] [uniqueidentifier] NULL,
	[EntryNumber] [int] NULL,
	[CheckCreateEntry] [bit] NULL,
	[ItemsTotal] [float] NULL,
	[ItemsDiscount] [float] NULL,
	[ItemsExtra] [float] NULL,
	[BuExtra] [float] NULL,
	[BuDiscount] [float] NULL,
	[BuOnly] [varchar](500) NULL,
	[ContractGuid] [uniqueidentifier] NULL,
	[IsPosted] [bit] NULL,
	[AddFld1] [varchar](255) NULL,
	[AddFld2] [varchar](255) NULL,
	[AddFld3] [varchar](255) NULL,
	[AddFld4] [varchar](255) NULL,
	[AddFld5] [varchar](255) NULL,
	[AddFld6] [varchar](255) NULL,
	[AddFld7] [varchar](255) NULL,
	[AddFld8] [varchar](255) NULL,
PRIMARY KEY CLUSTERED 
(
	[Guid] ASC
)WITH (PAD_INDEX = OFF, STATISTICS_NORECOMPUTE = OFF, IGNORE_DUP_KEY = OFF, ALLOW_ROW_LOCKS = ON, ALLOW_PAGE_LOCKS = ON, OPTIMIZE_FOR_SEQUENTIAL_KEY = OFF) ON [PRIMARY]
) ON [PRIMARY]
GO
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE TABLE [dbo].[BillDetail](
	[Number] [int] NOT NULL IDENTITY(1,1),
	[Guid] [uniqueidentifier] NOT NULL,
	[ParentGuid] [uniqueidentifier] NULL,
	[MatGuid] [uniqueidentifier] NULL,
	[Qty] [float] NULL,
	[Qty2] [float] NULL,
	[Qty3] [float] NULL,
	[Price] [float] NULL,
	[TotalPrice] [float] NULL,
	[Bonus] [float] NULL,
	[StoreGuid] [uniqueidentifier] NULL,
	[DiscountPercent] [float] NULL,
	[Discount] [float] NULL,
	[ExtraPercent] [float] NULL,
	[Extra] [float] NULL,
	[Note] [varchar](256) NULL,
	[ProductDate] [date] NULL,
	[ExpireDate] [date] NULL,
	[CostGuid] [uniqueidentifier] NULL,
	[Class] [varchar](256) NULL,
	[Length] [float] NULL,
	[width] [float] NULL,
	[height] [float] NULL,
	[Count] [float] NULL,
	[unityFact2] [float] NULL,
	[unityFact3] [float] NULL,
	[unityfix2] [bit] NULL,
	[unityfix3] [bit] NULL,
	[ItemUnit] [int] NULL,
PRIMARY KEY CLUSTERED 
(
	[Guid] ASC
)WITH (PAD_INDEX = OFF, STATISTICS_NORECOMPUTE = OFF, IGNORE_DUP_KEY = OFF, ALLOW_ROW_LOCKS = ON, ALLOW_PAGE_LOCKS = ON, OPTIMIZE_FOR_SEQUENTIAL_KEY = OFF) ON [PRIMARY]
) ON [PRIMARY]
GO
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE TABLE [dbo].[BillDetail_Tmp](
	[Kind] [int] NULL,
	[Number] [int] NOT NULL IDENTITY(1,1),
	[ParentGuid] [uniqueidentifier] NULL,
	[BillKind] [int] NULL,
	[MatGuid] [uniqueidentifier] NULL,
	[Qty] [float] NULL,
	[Qty2] [float] NULL,
	[Qty3] [float] NULL,
	[Bonus] [float] NULL,
	[StoreGuid] [uniqueidentifier] NULL
) ON [PRIMARY]
GO
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE TABLE [dbo].[BillDiscount](
	[Number] [int] NOT NULL IDENTITY(1,1),
	[Guid] [uniqueidentifier] NOT NULL,
	[ParentGuid] [uniqueidentifier] NULL,
	[AccountGuid] [uniqueidentifier] NULL,
	[Discount] [float] NULL,
	[Extra] [float] NULL,
	[CurrencyGuid] [uniqueidentifier] NULL,
	[CurrencyVal] [float] NULL,
	[CostGuid] [uniqueidentifier] NULL,
	[obverseAccountGuid] [uniqueidentifier] NULL,
	[Note] [varchar](256) NULL,
PRIMARY KEY CLUSTERED 
(
	[Guid] ASC
)WITH (PAD_INDEX = OFF, STATISTICS_NORECOMPUTE = OFF, IGNORE_DUP_KEY = OFF, ALLOW_ROW_LOCKS = ON, ALLOW_PAGE_LOCKS = ON, OPTIMIZE_FOR_SEQUENTIAL_KEY = OFF) ON [PRIMARY]
) ON [PRIMARY]
GO
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE TABLE [dbo].[BillNumber](
	[Number] [int] NOT NULL IDENTITY(1,1),
	[Kind] [int] NULL
) ON [PRIMARY]
GO
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE TABLE [dbo].[BillOrder](
	[Number] [int] NOT NULL IDENTITY(1,1),
	[Guid] [uniqueidentifier] NOT NULL,
	[SecLvl] [int] NULL,
	[TypeGuid] [uniqueidentifier] NULL,
	[No] [int] NULL,
	[StoreNo] [int] NULL,
	[Date] [date] NULL,
	[CustGuid] [uniqueidentifier] NULL,
	[StoreGuid] [uniqueidentifier] NULL,
	[CostGuid] [uniqueidentifier] NULL,
	[UserGuid] [uniqueidentifier] NULL,
	[CurrencyGuid] [uniqueidentifier] NULL,
	[CurrencyVal] [float] NULL,
	[ExpireDay] [int] NULL,
	[Note] [varchar](256) NULL,
	[CloseOrder] [bit] NULL,
PRIMARY KEY CLUSTERED 
(
	[Guid] ASC
)WITH (PAD_INDEX = OFF, STATISTICS_NORECOMPUTE = OFF, IGNORE_DUP_KEY = OFF, ALLOW_ROW_LOCKS = ON, ALLOW_PAGE_LOCKS = ON, OPTIMIZE_FOR_SEQUENTIAL_KEY = OFF) ON [PRIMARY]
) ON [PRIMARY]
GO
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE TABLE [dbo].[BillOrderDetail](
	[Number] [int] NOT NULL IDENTITY(1,1),
	[Guid] [uniqueidentifier] NOT NULL,
	[ParentGuid] [uniqueidentifier] NULL,
	[MatGuid] [uniqueidentifier] NULL,
	[unit] [int] NULL,
	[Qty] [float] NULL,
	[Price] [float] NULL,
	[StoreGuid] [uniqueidentifier] NULL,
	[Note] [varchar](256) NULL,
PRIMARY KEY CLUSTERED 
(
	[Guid] ASC
)WITH (PAD_INDEX = OFF, STATISTICS_NORECOMPUTE = OFF, IGNORE_DUP_KEY = OFF, ALLOW_ROW_LOCKS = ON, ALLOW_PAGE_LOCKS = ON, OPTIMIZE_FOR_SEQUENTIAL_KEY = OFF) ON [PRIMARY]
) ON [PRIMARY]
GO
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE TABLE [dbo].[BillOrderRecipient](
	[Number] [int] NOT NULL IDENTITY(1,1),
	[Guid] [uniqueidentifier] NOT NULL,
	[SecLvl] [int] NULL,
	[Srl] [float] NULL,
	[ParentGuid] [uniqueidentifier] NULL,
	[No] [varchar](256) NULL,
	[UserGuid] [uniqueidentifier] NULL,
	[SaleBillType] [uniqueidentifier] NULL,
	[Date] [date] NULL,
	[CurrencyGuid] [uniqueidentifier] NULL,
	[CurrencyVal] [float] NULL,
	[Driver] [varchar](256) NULL,
	[CarNo] [varchar](256) NULL,
	[Note] [varchar](256) NULL,
PRIMARY KEY CLUSTERED 
(
	[Guid] ASC
)WITH (PAD_INDEX = OFF, STATISTICS_NORECOMPUTE = OFF, IGNORE_DUP_KEY = OFF, ALLOW_ROW_LOCKS = ON, ALLOW_PAGE_LOCKS = ON, OPTIMIZE_FOR_SEQUENTIAL_KEY = OFF) ON [PRIMARY]
) ON [PRIMARY]
GO
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE TABLE [dbo].[BillOrderRecipientDetail](
	[Number] [int] NOT NULL IDENTITY(1,1),
	[ParentGuid] [uniqueidentifier] NULL,
	[MatGuid] [uniqueidentifier] NULL,
	[StoreGuid] [uniqueidentifier] NULL,
	[Qty] [float] NULL,
	[Qty2] [float] NULL,
	[Qty3] [float] NULL,
	[Price] [float] NULL,
	[ClassPtr] [varchar](256) NULL,
	[Note] [varchar](256) NULL
) ON [PRIMARY]
GO
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE TABLE [dbo].[BillOrderRecipientDiscountExtra](
	[Number] [int] NOT NULL IDENTITY(1,1),
	[ParentGuid] [uniqueidentifier] NULL,
	[AccountGUID] [uniqueidentifier] NULL,
	[Discount] [float] NULL,
	[Extra] [float] NULL,
	[CostGUID] [uniqueidentifier] NULL,
	[ContraAccGUID] [uniqueidentifier] NULL,
	[Notes] [varchar](250) NULL
) ON [PRIMARY]
GO
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE TABLE [dbo].[BillType](
	[Number] [int] NOT NULL IDENTITY(1,1),
	[Guid] [uniqueidentifier] NOT NULL,
	[SecLvl] [int] NULL,
	[Code] [varchar](256) NULL,
	[Name] [varchar](256) NULL,
	[LtnName] [varchar](256) NULL,
	[BillKind] [int] NULL,
	[Menu] [varchar](256) NULL,
	[LtnMenu] [varchar](256) NULL,
	[ShortCut] [varchar](256) NULL,
	[DefPrintPath] [varchar](256) NULL,
	[BillBarcode] [bit] NULL,
	[Note] [varchar](256) NULL,
	[PayType] [int] NULL,
	[Color1] [float] NULL,
	[Color2] [float] NULL,
	[DefMatAccountGuid] [uniqueidentifier] NULL,
	[DefCashAccountGuid] [uniqueidentifier] NULL,
	[DefCostGuid] [uniqueidentifier] NULL,
	[DefStoreGuid] [uniqueidentifier] NULL,
	[DefDiscountAccountGuid] [uniqueidentifier] NULL,
	[DefExtraAccountGuid] [uniqueidentifier] NULL,
	[CurrencyGuid] [uniqueidentifier] NULL,
	[PostToStores] [bit] NULL,
	[PostToStoresAuto] [bit] NULL,
	[EntryCreated] [bit] NULL,
	[EntryCreatedAuto] [bit] NULL,
	[AutoPostedEntry] [bit] NULL,
	[OpPrice] [int] NULL,
	[SpecificPrice] [int] NULL,
	[PriceEffected] [bit] NULL,
	[DetailEntryByMat] [bit] NULL,
PRIMARY KEY CLUSTERED 
(
	[Guid] ASC
)WITH (PAD_INDEX = OFF, STATISTICS_NORECOMPUTE = OFF, IGNORE_DUP_KEY = OFF, ALLOW_ROW_LOCKS = ON, ALLOW_PAGE_LOCKS = ON, OPTIMIZE_FOR_SEQUENTIAL_KEY = OFF) ON [PRIMARY]
) ON [PRIMARY]
GO
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE TABLE [dbo].[BillTypeField](
	[BillTypeGuid] [uniqueidentifier] NULL,
	[FieldName] [varchar](256) NULL,
	[Visible] [bit] NULL
) ON [PRIMARY]
GO
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE TABLE [dbo].[BillTypePrivilege](
	[UserGuid] [uniqueidentifier] NULL,
	[BillTypeGuid] [uniqueidentifier] NULL,
	[Open] [bit] NULL,
	[Add] [bit] NULL,
	[Edit] [bit] NULL,
	[Del] [bit] NULL,
	[Print] [bit] NULL,
	[Design] [bit] NULL
) ON [PRIMARY]
GO
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE TABLE [dbo].[Branch](
	[Number] [int] NOT NULL IDENTITY(1,1),
	[Guid] [uniqueidentifier] NOT NULL,
	[SecLvl] [int] NULL,
	[Code] [varchar](256) NULL,
	[Name] [varchar](256) NULL,
	[ltnName] [varchar](256) NULL,
	[Phone] [varchar](256) NULL,
	[Address] [varchar](256) NULL,
	[Note] [varchar](256) NULL,
	[ParentGuid] [uniqueidentifier] NULL,
PRIMARY KEY CLUSTERED 
(
	[Guid] ASC
)WITH (PAD_INDEX = OFF, STATISTICS_NORECOMPUTE = OFF, IGNORE_DUP_KEY = OFF, ALLOW_ROW_LOCKS = ON, ALLOW_PAGE_LOCKS = ON, OPTIMIZE_FOR_SEQUENTIAL_KEY = OFF) ON [PRIMARY]
) ON [PRIMARY]
GO
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE TABLE [dbo].[BrowsCard](
	[IdCard] [int] NULL,
	[CardGuid] [uniqueidentifier] NULL,
	[ComputerName] [varchar](50) NULL,
	[CheckRefrech] [bit] NULL
) ON [PRIMARY]
GO
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE TABLE [dbo].[Building](
	[Number] [int] NOT NULL IDENTITY(1,1),
	[Guid] [uniqueidentifier] NOT NULL,
	[SecLvl] [int] NULL,
	[Name] [varchar](256) NULL,
	[LtnName] [varchar](256) NULL,
	[BuildingCode] [varchar](256) NULL,
	[Emirate] [varchar](256) NULL,
	[Area] [varchar](256) NULL,
	[Suburb] [varchar](256) NULL,
	[Street] [varchar](256) NULL,
	[LtnEmirate] [varchar](256) NULL,
	[LtnArea] [varchar](256) NULL,
	[LtnSuburb] [varchar](256) NULL,
	[LtnStreet] [varchar](256) NULL,
	[BasinNo] [varchar](256) NULL,
	[PieceNo] [varchar](256) NULL,
	[BuildAutoNumber] [varchar](256) NULL,
	[CouponNum] [varchar](256) NULL,
	[BuildingArea] [varchar](256) NULL,
	[LicenseType] [varchar](256) NULL,
	[BuildYear] [varchar](256) NULL,
	[ElecCounterNo] [varchar](256) NULL,
	[FloorCount] [int] NULL,
	[ApartmentCount] [int] NULL,
	[ApartmentCountOfFloor] [int] NULL,
	[ShopCount] [int] NULL,
	[Costunity] [float] NULL,
	[AccountGuid] [uniqueidentifier] NULL,
	[AccountBankBuildingGuid] [uniqueidentifier] NULL,
	[BuildingAccountGuid] [uniqueidentifier] NULL,
	[CashAccountGuid] [uniqueidentifier] NULL,
	[InsuranceAccountGuid] [uniqueidentifier] NULL,
	[CostGuid] [uniqueidentifier] NULL,
	[BankName] [varchar](256) NULL,
	[BankAccCode] [varchar](256) NULL,
	[ParentRentAccountGuid] [uniqueidentifier] NULL,
	[ParentRentInsuranceAccountGuid] [uniqueidentifier] NULL,
	[OpOwner] [int] NULL,
	[DatePurchase] [date] NULL,
	[AmountPurchase] [float] NULL,
	[CurrencyPurchase] [uniqueidentifier] NULL,
	[CurrencyvalPurchase] [float] NULL,
	[CustomerPurchase] [uniqueidentifier] NULL,
	[PurchaseNotes] [varchar](256) NULL,
	[CkReceiptBuilding] [bit] NULL,
	[ReceiptDate] [date] NULL,
	[ReceiptAmount] [float] NULL,
	[CurrencyReceipt] [uniqueidentifier] NULL,
	[CurrencyvalReceipt] [float] NULL,
	[ReceiptNote] [varchar](256) NULL,
	[Note] [varchar](256) NULL,
	[OwnerAccountGuid] [uniqueidentifier] NULL,
	[IdentityValue] [float] NULL,
	[CurrencyIdentityGUID] [uniqueidentifier] NULL,
	[CurrencyValIdentity] [float] NULL,
	[IdentityBeginDate] [date] NULL,
	[IdentityEndDate] [date] NULL,
	[UsedEndDate] [bit] NULL,
	[BHouseFloor] [int] NULL,
	[BHouseFlatCount] [int] NULL,
	[MBalanceFloor] [int] NULL,
	[MBalanceFlatCount] [int] NULL,
	[OfficeFloor] [int] NULL,
	[OfficeCount] [int] NULL,
	[ParkingFloor] [int] NULL,
	[ParkingCount] [int] NULL,
	[ParkingFloorUnder] [int] NULL,
	[ParkingCountUnder] [int] NULL,
	[FlatDriverCount] [int] NULL,
	[FlatServantCount] [int] NULL,
	[StoreCount] [int] NULL,
	[CreateEntryPurchase] [bit] NULL,
	[CrearteEntryInvestment] [bit] NULL,
	[OwnerName] [uniqueidentifier] NULL,
	[CommissionPercent] [float] NULL,
	[AccountCommIncomeGuid] [uniqueidentifier] NULL,
	[AcCommissionFromOwnerGUID] [uniqueidentifier] NULL,
	[BuildingCost] [float] NULL,
	[BuildingNo] [varchar](256) NULL,
	[BondType] [varchar](256) NULL,
	[BondNo] [varchar](256) NULL,
	[BondDate] [date] NULL,
	[RentInfoGuid] [uniqueidentifier] NULL,
	[CkBuildingPayTypelow] [bit] NULL,
	[OwnerGuid] [uniqueidentifier] NULL,
	[ShowInContract] [bit] NULL,
	[ShowInReport] [bit] NULL,
PRIMARY KEY CLUSTERED 
(
	[Guid] ASC
)WITH (PAD_INDEX = OFF, STATISTICS_NORECOMPUTE = OFF, IGNORE_DUP_KEY = OFF, ALLOW_ROW_LOCKS = ON, ALLOW_PAGE_LOCKS = ON, OPTIMIZE_FOR_SEQUENTIAL_KEY = OFF) ON [PRIMARY],
 CONSTRAINT [UK_Building_Name_UNIQUE] UNIQUE NONCLUSTERED 
(
	[Name] ASC
)WITH (PAD_INDEX = OFF, STATISTICS_NORECOMPUTE = OFF, IGNORE_DUP_KEY = OFF, ALLOW_ROW_LOCKS = ON, ALLOW_PAGE_LOCKS = ON, OPTIMIZE_FOR_SEQUENTIAL_KEY = OFF) ON [PRIMARY]
) ON [PRIMARY]
GO
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE TABLE [dbo].[BuildingAssets](
	[Number] [int] NOT NULL IDENTITY(1,1),
	[ParentGuid] [uniqueidentifier] NULL,
	[AssetsGuid] [uniqueidentifier] NULL,
	[Value] [float] NULL,
	[Note] [varchar](255) NULL
) ON [PRIMARY]
GO
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE TABLE [dbo].[BuildingGuard](
	[Number] [int] NOT NULL IDENTITY(1,1),
	[Guid] [uniqueidentifier] NOT NULL,
	[SecLvl] [int] NULL,
	[Name] [varchar](256) NULL,
	[LtnName] [varchar](256) NULL,
	[Adjective] [varchar](256) NULL,
	[PassportNO] [varchar](256) NULL,
	[PassportExpireDate] [date] NULL,
	[Nationality] [varchar](256) NULL,
	[LtnNationality] [varchar](256) NULL,
	[PersonalityNo] [varchar](256) NULL,
	[Address] [varchar](256) NULL,
	[Phone] [varchar](256) NULL,
	[Mobile] [varchar](256) NULL,
	[EMail] [varchar](256) NULL,
PRIMARY KEY CLUSTERED 
(
	[Guid] ASC
)WITH (PAD_INDEX = OFF, STATISTICS_NORECOMPUTE = OFF, IGNORE_DUP_KEY = OFF, ALLOW_ROW_LOCKS = ON, ALLOW_PAGE_LOCKS = ON, OPTIMIZE_FOR_SEQUENTIAL_KEY = OFF) ON [PRIMARY]
) ON [PRIMARY]
GO
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE TABLE [dbo].[BuildingIdentity](
	[BuildingGuid] [uniqueidentifier] NULL,
	[OwnerAccountGuid] [uniqueidentifier] NULL,
	[Value] [float] NULL,
	[CurrencyGUID] [uniqueidentifier] NULL,
	[BeginDate] [date] NULL,
	[cachEntryGuid] [uniqueidentifier] NULL,
	[InsuranceEntryGuid] [uniqueidentifier] NULL,
	[DoReconciliation] [bit] NULL
) ON [PRIMARY]
GO
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE TABLE [dbo].[BuildingIdentityDetail](
	[BuildingGuid] [uniqueidentifier] NULL,
	[RentName] [varchar](256) NULL,
	[BeginContractDate] [date] NULL,
	[EndContractDate] [date] NULL,
	[ContractPeriod] [float] NULL,
	[ContractValue] [float] NULL,
	[BeginInvestmentDate] [date] NULL,
	[DeservedDay] [float] NULL,
	[DeservedValue] [float] NULL,
	[checkValue] [float] NULL,
	[DeservedCashValue] [float] NULL,
	[InsuranceValue] [float] NULL,
	[FlatGuid] [uniqueidentifier] NULL,
	[Mobile] [varchar](256) NULL,
	[ContractNo] [varchar](256) NULL
) ON [PRIMARY]
GO
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE TABLE [dbo].[Buildinglicense](
	[Number] [int] NOT NULL IDENTITY(1,1),
	[BuildingGuid] [uniqueidentifier] NULL,
	[No] [varchar](255) NULL,
	[Date] [date] NULL,
	[IssueDate] [date] NULL,
	[EndIssueDate] [date] NULL,
	[Owner] [varchar](255) NULL,
	[trademark] [varchar](255) NULL,
	[Worker] [varchar](255) NULL,
	[NoWorker] [varchar](255) NULL,
	[Note] [varchar](255) NULL
) ON [PRIMARY]
GO
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE TABLE [dbo].[BuildingOffer](
	[Number] [int] NOT NULL IDENTITY(1,1),
	[Guid] [uniqueidentifier] NOT NULL,
	[SecLvl] [int] NULL,
	[Name] [varchar](256) NULL,
	[LtnName] [varchar](256) NULL,
	[BuildingCode] [varchar](256) NULL,
	[Emirate] [varchar](256) NULL,
	[Area] [varchar](256) NULL,
	[Suburb] [varchar](256) NULL,
	[Street] [varchar](256) NULL,
	[BasinNo] [varchar](256) NULL,
	[PieceNo] [varchar](256) NULL,
	[FloorCount] [int] NULL,
	[ApartmentCount] [int] NULL,
	[ApartmentCountOfFloor] [int] NULL,
	[ShopCount] [int] NULL,
	[Costunity] [float] NULL,
	[Note] [varchar](256) NULL,
	[BHouseFloor] [int] NULL,
	[BHouseFlatCount] [int] NULL,
	[MBalanceFloor] [int] NULL,
	[MBalanceFlatCount] [int] NULL,
	[OfficeFloor] [int] NULL,
	[OfficeCount] [int] NULL,
	[ParkingFloor] [int] NULL,
	[ParkingCount] [int] NULL,
	[ParkingFloorUnder] [int] NULL,
	[ParkingCountUnder] [int] NULL,
	[FlatDriverCount] [int] NULL,
	[FlatServantCount] [int] NULL,
	[StoreCount] [int] NULL,
	[BuildingNo] [varchar](256) NULL,
	[BondType] [varchar](256) NULL,
	[BondNo] [varchar](256) NULL,
	[BondDate] [date] NULL,
	[OfferKind] [int] NULL,
	[OfferValue] [float] NULL,
	[Delegated] [varchar](256) NULL,
	[MaxOfferValue] [float] NULL,
	[LandArea] [float] NULL,
	[LandAreaUnit] [varchar](256) NULL,
	[CustName] [varchar](256) NULL,
	[CustPhone] [varchar](256) NULL,
	[CustMobile] [varchar](256) NULL,
	[CustAddress] [varchar](256) NULL,
PRIMARY KEY CLUSTERED 
(
	[Guid] ASC
)WITH (PAD_INDEX = OFF, STATISTICS_NORECOMPUTE = OFF, IGNORE_DUP_KEY = OFF, ALLOW_ROW_LOCKS = ON, ALLOW_PAGE_LOCKS = ON, OPTIMIZE_FOR_SEQUENTIAL_KEY = OFF) ON [PRIMARY],
 CONSTRAINT [UK_BuildingOffer_Name_UNIQUE] UNIQUE NONCLUSTERED 
(
	[Name] ASC
)WITH (PAD_INDEX = OFF, STATISTICS_NORECOMPUTE = OFF, IGNORE_DUP_KEY = OFF, ALLOW_ROW_LOCKS = ON, ALLOW_PAGE_LOCKS = ON, OPTIMIZE_FOR_SEQUENTIAL_KEY = OFF) ON [PRIMARY]
) ON [PRIMARY]
GO
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE TABLE [dbo].[BuildingPayType](
	[Number] [int] NOT NULL IDENTITY(1,1),
	[Guid] [uniqueidentifier] NULL,
	[BuildingGuid] [uniqueidentifier] NULL,
	[Date] [date] NULL,
	[Percentage] [float] NULL,
	[PayValue] [float] NULL,
	[Note] [varchar](256) NULL
) ON [PRIMARY]
GO
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE TABLE [dbo].[BuildingPlanConfig](
	[Tag] [int] NULL,
	[Kind] [varchar](256) NULL
) ON [PRIMARY]
GO
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE TABLE [dbo].[BuildingPrivilege](
	[UserGuid] [uniqueidentifier] NULL,
	[BuildingGuid] [uniqueidentifier] NULL
) ON [PRIMARY]
GO
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE TABLE [dbo].[BuildingRecElecCounter](
	[Number] [int] NOT NULL IDENTITY(1,1),
	[Guid] [uniqueidentifier] NOT NULL,
	[SecLvl] [int] NULL,
	[BuildingGuid] [uniqueidentifier] NULL,
	[UnNo] [varchar](255) NULL,
	[Service] [varchar](255) NULL,
	[Address] [varchar](255) NULL,
	[ElecCounterNo] [varchar](255) NULL,
	[UserGuid] [uniqueidentifier] NULL,
	[Date] [date] NULL,
	[OldCounter] [float] NULL,
	[OldDate] [date] NULL,
	[Counter] [float] NULL,
	[Note] [varchar](255) NULL,
PRIMARY KEY CLUSTERED 
(
	[Guid] ASC
)WITH (PAD_INDEX = OFF, STATISTICS_NORECOMPUTE = OFF, IGNORE_DUP_KEY = OFF, ALLOW_ROW_LOCKS = ON, ALLOW_PAGE_LOCKS = ON, OPTIMIZE_FOR_SEQUENTIAL_KEY = OFF) ON [PRIMARY]
) ON [PRIMARY]
GO
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE TABLE [dbo].[CalcQty](
	[Number] [int] NOT NULL IDENTITY(1,1),
	[Guid] [uniqueidentifier] NOT NULL,
	[SecLvl] [int] NULL,
	[Name] [varchar](256) NULL,
	[Equality] [varchar](8000) NULL,
	[Note] [varchar](256) NULL,
PRIMARY KEY CLUSTERED 
(
	[Guid] ASC
)WITH (PAD_INDEX = OFF, STATISTICS_NORECOMPUTE = OFF, IGNORE_DUP_KEY = OFF, ALLOW_ROW_LOCKS = ON, ALLOW_PAGE_LOCKS = ON, OPTIMIZE_FOR_SEQUENTIAL_KEY = OFF) ON [PRIMARY]
) ON [PRIMARY]
GO
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE TABLE [dbo].[ChangeBuildingGuard](
	[Number] [int] NOT NULL IDENTITY(1,1),
	[BuildingGuid] [uniqueidentifier] NULL,
	[GuardGuid] [uniqueidentifier] NULL,
	[Date] [date] NULL,
	[Note] [varchar](255) NULL
) ON [PRIMARY]
GO
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE TABLE [dbo].[ChangeCurrencyRate](
	[Number] [int] NOT NULL IDENTITY(1,1),
	[Guid] [uniqueidentifier] NOT NULL,
	[SecLvl] [int] NULL,
	[Date] [date] NULL,
	[CurrencyGUID] [uniqueidentifier] NULL,
	[Rate] [float] NULL,
	[Note] [varchar](256) NULL,
PRIMARY KEY CLUSTERED 
(
	[Guid] ASC
)WITH (PAD_INDEX = OFF, STATISTICS_NORECOMPUTE = OFF, IGNORE_DUP_KEY = OFF, ALLOW_ROW_LOCKS = ON, ALLOW_PAGE_LOCKS = ON, OPTIMIZE_FOR_SEQUENTIAL_KEY = OFF) ON [PRIMARY]
) ON [PRIMARY]
GO
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE TABLE [dbo].[ChangeFlatPrice](
	[Number] [int] NOT NULL IDENTITY(1,1),
	[ParentGuid] [uniqueidentifier] NULL,
	[Date] [date] NULL,
	[Price] [float] NULL,
	[CurrencyGuid] [uniqueidentifier] NULL,
	[Kind] [int] NULL
) ON [PRIMARY]
GO
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE TABLE [dbo].[ChangeFlatRent](
	[Number] [int] NOT NULL IDENTITY(1,1),
	[ParentGuid] [uniqueidentifier] NULL,
	[Date] [date] NULL,
	[Price] [float] NULL,
	[CurrencyGuid] [uniqueidentifier] NULL
) ON [PRIMARY]
GO
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE TABLE [dbo].[ChangeLandRent](
	[Number] [int] NOT NULL IDENTITY(1,1),
	[ParentGuid] [uniqueidentifier] NULL,
	[Date] [date] NULL,
	[Price] [float] NULL,
	[CurrencyGuid] [uniqueidentifier] NULL
) ON [PRIMARY]
GO
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE TABLE [dbo].[ChangeParkingPrice](
	[Number] [int] NOT NULL IDENTITY(1,1),
	[ParentGuid] [uniqueidentifier] NULL,
	[Date] [date] NULL,
	[Price] [float] NULL,
	[CurrencyGuid] [uniqueidentifier] NULL
) ON [PRIMARY]
GO
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE TABLE [dbo].[ChangeParkingRent](
	[Number] [int] NOT NULL IDENTITY(1,1),
	[ParentGuid] [uniqueidentifier] NULL,
	[Date] [date] NULL,
	[Price] [float] NULL,
	[CurrencyGuid] [uniqueidentifier] NULL
) ON [PRIMARY]
GO
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE TABLE [dbo].[ChangeShopPrice](
	[Number] [int] NOT NULL IDENTITY(1,1),
	[ParentGuid] [uniqueidentifier] NULL,
	[Date] [date] NULL,
	[Price] [float] NULL,
	[CurrencyGuid] [uniqueidentifier] NULL
) ON [PRIMARY]
GO
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE TABLE [dbo].[ChangeShopRent](
	[Number] [int] NOT NULL IDENTITY(1,1),
	[ParentGuid] [uniqueidentifier] NULL,
	[Date] [date] NULL,
	[Price] [float] NULL,
	[CurrencyGuid] [uniqueidentifier] NULL
) ON [PRIMARY]
GO
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE TABLE [dbo].[ChangeVillaPrice](
	[Number] [int] NOT NULL IDENTITY(1,1),
	[ParentGuid] [uniqueidentifier] NULL,
	[Date] [date] NULL,
	[Price] [float] NULL,
	[CurrencyGuid] [uniqueidentifier] NULL,
	[Kind] [int] NULL
) ON [PRIMARY]
GO
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE TABLE [dbo].[ChangeVillaRent](
	[Number] [int] NOT NULL IDENTITY(1,1),
	[ParentGuid] [uniqueidentifier] NULL,
	[Date] [date] NULL,
	[Price] [float] NULL,
	[CurrencyGuid] [uniqueidentifier] NULL
) ON [PRIMARY]
GO
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE TABLE [dbo].[Checks](
	[Number] [int] NOT NULL IDENTITY(1,1),
	[Guid] [uniqueidentifier] NOT NULL,
	[SecLvl] [int] NULL,
	[Mark] [bit] NULL,
	[TypeGuid] [uniqueidentifier] NULL,
	[NO] [varchar](256) NULL,
	[InternalNO] [varchar](256) NULL,
	[ReceiptNo] [float] NULL,
	[Value] [float] NULL,
	[CurrencyGUID] [uniqueidentifier] NULL,
	[CurrencyVal] [float] NULL,
	[Date] [date] NULL,
	[DueDate] [date] NULL,
	[endDueDate] [date] NULL,
	[NoneDueDate] [bit] NULL,
	[BankName] [varchar](256) NULL,
	[Account] [uniqueidentifier] NULL,
	[CostGuid] [uniqueidentifier] NULL,
	[ObverseAccount] [uniqueidentifier] NULL,
	[CostObverseGuid] [uniqueidentifier] NULL,
	[Beneficiary] [varchar](256) NULL,
	[Note] [varchar](256) NULL,
	[Note2] [varchar](256) NULL,
	[Note3] [varchar](4000) NULL,
	[Note4] [varchar](4000) NULL,
	[ContractGuid] [uniqueidentifier] NULL,
	[UserGuid] [uniqueidentifier] NULL,
	[BranchGuid] [uniqueidentifier] NULL,
	[SalesManGuid] [uniqueidentifier] NULL,
	[FolderDate] [date] NULL,
	[FolderInternalNo] [varchar](256) NULL,
	[FolderExternalNo] [varchar](256) NULL,
	[CheckCreateEntry] [bit] NULL,
	[IsRounded] [bit] NULL,
	[Deposition] [bit] NULL,
	[Lawsuit] [bit] NULL,
PRIMARY KEY CLUSTERED 
(
	[Guid] ASC
)WITH (PAD_INDEX = OFF, STATISTICS_NORECOMPUTE = OFF, IGNORE_DUP_KEY = OFF, ALLOW_ROW_LOCKS = ON, ALLOW_PAGE_LOCKS = ON, OPTIMIZE_FOR_SEQUENTIAL_KEY = OFF) ON [PRIMARY]
) ON [PRIMARY]
GO
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE TABLE [dbo].[ChecksAccountDetail](
	[ParentGuid] [uniqueidentifier] NULL,
	[Number] [int] NOT NULL IDENTITY(1,1),
	[Kind] [int] NULL,
	[AccountGuid] [uniqueidentifier] NULL,
	[CostGuid] [uniqueidentifier] NULL,
	[Percent] [float] NULL,
	[Value] [float] NULL,
	[Note] [varchar](255) NULL
) ON [PRIMARY]
GO
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE TABLE [dbo].[ChecksCollection](
	[SecLvl] [int] NULL,
	[Date] [date] NULL,
	[CheckGuid] [uniqueidentifier] NULL,
	[DebitAccountGuid] [uniqueidentifier] NULL,
	[DebitCostGuid] [uniqueidentifier] NULL,
	[CreditAccountGuid] [uniqueidentifier] NULL,
	[CreditCostGuid] [uniqueidentifier] NULL,
	[Value] [float] NULL,
	[Commission] [float] NULL,
	[LossComm] [bit] NULL,
	[ReturnCause] [varchar](256) NULL,
	[CommAccountGuid] [uniqueidentifier] NULL,
	[CommAccountCreditGuid] [uniqueidentifier] NULL,
	[CommCostGuid] [uniqueidentifier] NULL,
	[CommNote] [varchar](256) NULL,
	[CurrencyGUID] [uniqueidentifier] NULL,
	[CurrencyVal] [float] NULL,
	[Note] [varchar](256) NULL,
	[Kind] [int] NULL,
	[Delay] [float] NULL,
	[DelayAccountDebitGuid] [uniqueidentifier] NULL,
	[DelayAccountCreditGuid] [uniqueidentifier] NULL,
	[DelayNote] [varchar](256) NULL,
	[DelayCostGuid] [uniqueidentifier] NULL,
	[Finished] [bit] NULL,
	[FinishDate] [date] NULL,
	[FixReturn] [bit] NULL,
	[FixReturnNote] [varchar](255) NULL,
	[IsRounded] [bit] NULL,
	[OperationCreateEntry] [bit] NULL,
	[ReturnCreateEntry] [bit] NULL,
	[CommCreateEntry] [bit] NULL,
	[Mark] [bit] NULL
) ON [PRIMARY]
GO
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE TABLE [dbo].[ChecksCostDetail](
	[ParentGuid] [uniqueidentifier] NULL,
	[Number] [int] NOT NULL IDENTITY(1,1),
	[Kind] [int] NULL,
	[CostGuid] [uniqueidentifier] NULL,
	[Percent] [float] NULL,
	[Value] [float] NULL,
	[Note] [varchar](255) NULL
) ON [PRIMARY]
GO
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE TABLE [dbo].[ChecksPartialCollection](
	[Number] [int] NOT NULL IDENTITY(1,1),
	[Guid] [uniqueidentifier] NOT NULL,
	[SecLvl] [int] NULL,
	[Mark] [bit] NULL,
	[Date] [date] NULL,
	[CheckGuid] [uniqueidentifier] NULL,
	[DebitAccountGuid] [uniqueidentifier] NULL,
	[DebitCostGuid] [uniqueidentifier] NULL,
	[CreditAccountGuid] [uniqueidentifier] NULL,
	[CreditCostGuid] [uniqueidentifier] NULL,
	[Value] [float] NULL,
	[Commission] [float] NULL,
	[LossComm] [bit] NULL,
	[CommAccountGuid] [uniqueidentifier] NULL,
	[CommAccountCreditGuid] [uniqueidentifier] NULL,
	[CommCostGuid] [uniqueidentifier] NULL,
	[CommNote] [varchar](256) NULL,
	[CurrencyGUID] [uniqueidentifier] NULL,
	[CurrencyVal] [float] NULL,
	[Note] [varchar](256) NULL,
	[IsRounded] [bit] NULL,
	[SecEntryGuid] [uniqueidentifier] NULL,
PRIMARY KEY CLUSTERED 
(
	[Guid] ASC
)WITH (PAD_INDEX = OFF, STATISTICS_NORECOMPUTE = OFF, IGNORE_DUP_KEY = OFF, ALLOW_ROW_LOCKS = ON, ALLOW_PAGE_LOCKS = ON, OPTIMIZE_FOR_SEQUENTIAL_KEY = OFF) ON [PRIMARY]
) ON [PRIMARY]
GO
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE TABLE [dbo].[CheckType](
	[Number] [int] NOT NULL IDENTITY(1,1),
	[Guid] [uniqueidentifier] NOT NULL,
	[SecLvl] [int] NULL,
	[CheckKind] [int] NULL,
	[Code] [varchar](256) NULL,
	[Name] [varchar](256) NULL,
	[ltnName] [varchar](256) NULL,
	[Menu] [varchar](256) NULL,
	[LtnMenu] [varchar](256) NULL,
	[ShortCut] [varchar](256) NULL,
	[CreatedEntry] [bit] NULL,
	[AutoCreatedEntry] [bit] NULL,
	[AutoPostedEntry] [bit] NULL,
	[DefAccountGuid] [uniqueidentifier] NULL,
	[Posted] [bit] NULL,
	[PosdetCreatedEntry] [bit] NULL,
	[PosdetAutoCreatedEntry] [bit] NULL,
	[PosdetAutoPostedEntry] [bit] NULL,
	[PostedDefAccountGuid] [uniqueidentifier] NULL,
	[PostedDefCreditAccountGuid] [uniqueidentifier] NULL,
	[DefOwnerBuildingPosted] [bit] NULL,
	[DefCustPosted] [bit] NULL,
	[PostMoveCostDebit] [bit] NULL,
	[PostMoveCostCredit] [bit] NULL,
	[collected] [bit] NULL,
	[collectedCreatedEntry] [bit] NULL,
	[collectedAutoCreatedEntry] [bit] NULL,
	[CollectedEntryTypeGuid] [uniqueidentifier] NULL,
	[collectedAutoPostedEntry] [bit] NULL,
	[collectedSanctionBankAccountBuilding] [bit] NULL,
	[collectedSanctionCustObverse] [bit] NULL,
	[collectedDefAccountGuid] [uniqueidentifier] NULL,
	[collectedDefAccountObverseGuid] [uniqueidentifier] NULL,
	[CommAccountDebitGuid] [uniqueidentifier] NULL,
	[CommAccountCreditGuid] [uniqueidentifier] NULL,
	[CommOwnerBuilding] [bit] NULL,
	[DefBuildingComm] [bit] NULL,
	[CommType] [int] NULL,
	[DefBuildingIncomComm] [bit] NULL,
	[collectedMoveCostDebit] [bit] NULL,
	[collectedMoveCostCredit] [bit] NULL,
	[CommMoveCost] [bit] NULL,
	[CommMoveCostCredit] [bit] NULL,
	[partialcollected] [bit] NULL,
	[partialcollectedCreatedEntry] [bit] NULL,
	[partialcollectedAutoCreatedEntry] [bit] NULL,
	[partialCollectedEntryTypeGuid] [uniqueidentifier] NULL,
	[partialcollectedAutoPostedEntry] [bit] NULL,
	[partialcollectedSanctionBankAccountBuilding] [bit] NULL,
	[partialcollectedCachBankAccountBuilding] [bit] NULL,
	[partialcollectedSanctionCustObverse] [bit] NULL,
	[partialcollectedDefAccountGuid] [uniqueidentifier] NULL,
	[partialcollectedDefAccountObverseGuid] [uniqueidentifier] NULL,
	[partialMoveCostDebit] [bit] NULL,
	[partialMoveCostCredit] [bit] NULL,
	[Endorsement] [bit] NULL,
	[EndorsementCreatedEntry] [bit] NULL,
	[EndorsementAutoCreatedEntry] [bit] NULL,
	[EndorsementAutoPostedEntry] [bit] NULL,
	[EndorsementDefAccountDebitGuid] [uniqueidentifier] NULL,
	[EndorsementDefAccountCreateGuid] [uniqueidentifier] NULL,
	[EndorsementMoveCostDebit] [bit] NULL,
	[EndorsementMoveCostCredit] [bit] NULL,
	[Returned] [bit] NULL,
	[ReturnedCreatedEntry] [bit] NULL,
	[ReturnedAutoCreatedEntry] [bit] NULL,
	[ReturnedAutoPostedEntry] [bit] NULL,
	[ReturnedSanctionBankBuilding] [bit] NULL,
	[ReturnedSanctionBankBuildingCaseCollOnly] [bit] NULL,
	[ReturnedSanctionCustAccountDefAccount] [bit] NULL,
	[ReturnedDefAccountGuid] [uniqueidentifier] NULL,
	[ReturnedDefAccountCreditGuid] [uniqueidentifier] NULL,
	[EnableAtherOperationOnReturn] [bit] NULL,
	[ReturnMoveCostDebit] [bit] NULL,
	[ReturnMoveCostCredit] [bit] NULL,
	[delayDefAccountGuid] [uniqueidentifier] NULL,
	[delayDefAccountObverseGuid] [uniqueidentifier] NULL,
	[delaySanctionCustAccountDefAccount] [bit] NULL,
	[DefPrintPath] [varchar](256) NULL,
	[NoteForm1] [varchar](256) NULL,
	[LtnNoteForm1] [varchar](256) NULL,
	[NoteForm2] [varchar](256) NULL,
	[LtnNoteForm2] [varchar](256) NULL,
	[NotePosted] [varchar](256) NULL,
	[LtnNotePosted] [varchar](256) NULL,
	[Notecollected] [varchar](256) NULL,
	[LtnNotecollected] [varchar](256) NULL,
	[NotecollectedPartial] [varchar](256) NULL,
	[LtnNotecollectedPartial] [varchar](256) NULL,
	[NoteEndorsement] [varchar](256) NULL,
	[LtnNoteEndorsement] [varchar](256) NULL,
	[NoteReturn] [varchar](256) NULL,
	[LtnNoteReturn] [varchar](256) NULL,
	[NoteCommission] [varchar](256) NULL,
	[LtnNoteCommission] [varchar](256) NULL,
	[PartialNoteCommission] [varchar](256) NULL,
	[PartialLtnNoteCommission] [varchar](256) NULL,
	[ReturnNoteCommission] [varchar](256) NULL,
	[LtnReturnNoteCommission] [varchar](256) NULL,
	[PostedDate] [int] NULL,
	[partialcollectedDate] [int] NULL,
	[collectedDate] [int] NULL,
	[EndorsementDate] [int] NULL,
	[ReturnedDate] [int] NULL,
	[AutoSMSAfterAdd] [bit] NULL,
	[SMSMsg] [varchar](256) NULL,
	[SMSMsgEn] [varchar](256) NULL,
	[SMSChecksCollectionAutoSend] [bit] NULL,
	[SMSChecksCollectionImmediate] [bit] NULL,
	[SMSChecksCollectionDay] [int] NULL,
	[SMSChecksCollectionMsg] [varchar](800) NULL,
	[SMSChecksCollectionMsgEN] [varchar](800) NULL,
	[SMSChecksPartialCollectionAutoSend] [bit] NULL,
	[SMSChecksPartialCollectionMsg] [varchar](800) NULL,
	[SMSChecksPartialCollectionMsgEN] [varchar](800) NULL,
	[SMSCheckReturnAutoSend] [bit] NULL,
	[SMSCheckReturnImmediate] [bit] NULL,
	[SMSCheckReturnDay] [int] NULL,
	[SMSCheckReturnMsg] [varchar](800) NULL,
	[SMSCheckReturnMsgEn] [varchar](800) NULL,
	[SMSChecksDue] [bit] NULL,
	[SMSChecksDueDay] [int] NULL,
	[SMSChecksDueMsg] [varchar](800) NULL,
	[SMSChecksDueMsgEn] [varchar](800) NULL,
PRIMARY KEY CLUSTERED 
(
	[Guid] ASC
)WITH (PAD_INDEX = OFF, STATISTICS_NORECOMPUTE = OFF, IGNORE_DUP_KEY = OFF, ALLOW_ROW_LOCKS = ON, ALLOW_PAGE_LOCKS = ON, OPTIMIZE_FOR_SEQUENTIAL_KEY = OFF) ON [PRIMARY]
) ON [PRIMARY]
GO
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE TABLE [dbo].[CheckTypePrivilege](
	[UserGuid] [uniqueidentifier] NULL,
	[CheckTypeGuid] [uniqueidentifier] NULL,
	[Open] [bit] NULL,
	[Add] [bit] NULL,
	[Edit] [bit] NULL,
	[Del] [bit] NULL,
	[Mark] [bit] NULL,
	[MarkEdit] [bit] NULL,
	[Markdel] [bit] NULL,
	[ShowMark] [bit] NULL,
	[Print] [bit] NULL,
	[Design] [bit] NULL,
	[Posted] [bit] NULL,
	[DelPosted] [bit] NULL,
	[collected] [bit] NULL,
	[Delcollected] [bit] NULL,
	[partialcollected] [bit] NULL,
	[partialcollectedEdit] [bit] NULL,
	[partialcollectedDel] [bit] NULL,
	[Endorsement] [bit] NULL,
	[DelEndorsement] [bit] NULL,
	[Returned] [bit] NULL,
	[DelReturned] [bit] NULL,
	[CreateEntry] [bit] NULL,
	[ChangeAcc] [bit] NULL
) ON [PRIMARY]
GO
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE TABLE [dbo].[Complaint](
	[Number] [int] NOT NULL IDENTITY(1,1),
	[Guid] [uniqueidentifier] NOT NULL,
	[SecLvl] [int] NULL,
	[No] [varchar](256) NULL,
	[Date] [date] NULL,
	[CustGuid] [uniqueidentifier] NULL,
	[RealtyKind] [int] NULL,
	[BuildingGuid] [uniqueidentifier] NULL,
	[FlatGuid] [uniqueidentifier] NULL,
	[ShopGuid] [uniqueidentifier] NULL,
	[ParkingGuid] [uniqueidentifier] NULL,
	[VillaGuid] [uniqueidentifier] NULL,
	[LandGuid] [uniqueidentifier] NULL,
	[Note] [varchar](500) NULL,
	[ComplaintState] [int] NULL,
	[CloseDate] [date] NULL,
PRIMARY KEY CLUSTERED 
(
	[Guid] ASC
)WITH (PAD_INDEX = OFF, STATISTICS_NORECOMPUTE = OFF, IGNORE_DUP_KEY = OFF, ALLOW_ROW_LOCKS = ON, ALLOW_PAGE_LOCKS = ON, OPTIMIZE_FOR_SEQUENTIAL_KEY = OFF) ON [PRIMARY]
) ON [PRIMARY]
GO
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE TABLE [dbo].[ContractAccountDetail](
	[ParentGuid] [uniqueidentifier] NULL,
	[Number] [int] NOT NULL IDENTITY(1,1),
	[AccountGuid] [uniqueidentifier] NULL,
	[Percent] [float] NULL,
	[Value] [float] NULL,
	[Note] [varchar](255) NULL
) ON [PRIMARY]
GO
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE TABLE [dbo].[ContractCachPayment](
	[ContractGuid] [uniqueidentifier] NULL,
	[EntryGuid] [uniqueidentifier] NULL
) ON [PRIMARY]
GO
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE TABLE [dbo].[ContractFlatAssets](
	[Number] [int] NOT NULL IDENTITY(1,1),
	[ContractGuid] [uniqueidentifier] NULL,
	[AssetsGuid] [uniqueidentifier] NULL,
	[Value] [float] NULL,
	[Note] [varchar](255) NULL
) ON [PRIMARY]
GO
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE TABLE [dbo].[ContractLandAssets](
	[Number] [int] NOT NULL IDENTITY(1,1),
	[ContractGuid] [uniqueidentifier] NULL,
	[AssetsGuid] [uniqueidentifier] NULL,
	[Value] [float] NULL,
	[Note] [varchar](255) NULL
) ON [PRIMARY]
GO
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE TABLE [dbo].[ContractLog](
	[Guid] [uniqueidentifier] NOT NULL,
	[ContractGuid] [uniqueidentifier] NULL,
	[Number] [int] NOT NULL IDENTITY(1,1),
	[SecLvl] [int] NULL,
	[Date] [date] NULL,
	[UserGuid] [uniqueidentifier] NULL,
	[Note] [varchar](2500) NULL,
PRIMARY KEY CLUSTERED 
(
	[Guid] ASC
)WITH (PAD_INDEX = OFF, STATISTICS_NORECOMPUTE = OFF, IGNORE_DUP_KEY = OFF, ALLOW_ROW_LOCKS = ON, ALLOW_PAGE_LOCKS = ON, OPTIMIZE_FOR_SEQUENTIAL_KEY = OFF) ON [PRIMARY]
) ON [PRIMARY]
GO
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE TABLE [dbo].[ContractParkingCachPayment](
	[ContractGuid] [uniqueidentifier] NULL,
	[EntryGuid] [uniqueidentifier] NULL
) ON [PRIMARY]
GO
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE TABLE [dbo].[ContractType](
	[Number] [int] NOT NULL IDENTITY(1,1),
	[Guid] [uniqueidentifier] NOT NULL,
	[SecLvl] [int] NULL,
	[Code] [varchar](256) NULL,
	[Name] [varchar](256) NULL,
	[ltnName] [varchar](256) NULL,
	[Menu] [varchar](256) NULL,
	[LtnMenu] [varchar](256) NULL,
	[ShortCut] [varchar](256) NULL,
	[ContractKind] [int] NULL,
	[IsAutoRenewal] [bit] NULL,
	[RevenueAccountGUID] [uniqueidentifier] NULL,
	[AcCommissionFromCustGUID] [uniqueidentifier] NULL,
	[AcCommissionFromOwnerGUID] [uniqueidentifier] NULL,
	[AccountContractPriceGUID] [uniqueidentifier] NULL,
	[AccountCertificatValueGUID] [uniqueidentifier] NULL,
	[FineAccountGUID] [uniqueidentifier] NULL,
	[DiscountAccountGUID] [uniqueidentifier] NULL,
	[TaxAccount] [uniqueidentifier] NULL,
	[OtherFeeAccount1GUID] [uniqueidentifier] NULL,
	[OtherFeeAccount2GUID] [uniqueidentifier] NULL,
	[OtherFeeAccount3GUID] [uniqueidentifier] NULL,
	[OtherFeeAccount4GUID] [uniqueidentifier] NULL,
	[OtherFeeAccount5GUID] [uniqueidentifier] NULL,
	[InsuranceAccountGuid] [uniqueidentifier] NULL,
	[ServesComm] [float] NULL,
	[Rentcondition] [varchar](2048) NULL,
	[MoveCost] [bit] NULL,
	[MoveCostCredit] [bit] NULL,
	[DefPrintPath] [varchar](256) NULL,
	[DefPrintLogPath] [varchar](256) NULL,
	[CreateEntry] [bit] NULL,
	[AutoCreateEntry] [bit] NULL,
	[AutoPostedEntry] [bit] NULL,
	[EntryDate] [int] NULL,
	[MoveCostWithIncom] [bit] NULL,
	[MoveCostWithInsurance] [bit] NULL,
	[MoveCostWithContractPrice] [bit] NULL,
	[MoveCostWithCertificat] [bit] NULL,
	[MoveCostWithFee] [bit] NULL,
	[MoveCostWithclientComm] [bit] NULL,
	[MoveCostWithOwnerComm] [bit] NULL,
	[MoveCostWithInconEndContract] [bit] NULL,
	[MoveCostWithFineEndContract] [bit] NULL,
	[MoveCostWithIncomCredit] [bit] NULL,
	[MoveCostWithInsuranceCredit] [bit] NULL,
	[MoveCostWithContractPriceCredit] [bit] NULL,
	[MoveCostWithCertificatCredit] [bit] NULL,
	[MoveCostWithFeeCredit] [bit] NULL,
	[MoveCostWithclientCommCredit] [bit] NULL,
	[MoveCostWithOwnerCommCredit] [bit] NULL,
	[MoveCostWithInconEndContractCredit] [bit] NULL,
	[MoveCostWithFineEndContractCredit] [bit] NULL,
	[MoveCostWithDiscount] [bit] NULL,
	[MoveCostWithDiscountCredit] [bit] NULL,
	[DefSmsMobile] [varchar](256) NULL,
	[AutoSMSAfterAdd] [bit] NULL,
	[SMSMsg] [varchar](256) NULL,
	[SMSMsgEn] [varchar](256) NULL,
	[AutoSMSAfterEnd] [bit] NULL,
	[EndSMSMsg] [varchar](256) NULL,
	[EndSMSMsgEn] [varchar](256) NULL,
	[EndContract] [bit] NULL,
	[ConstraintInsurance] [bit] NULL,
	[DefPrintReceipt] [varchar](256) NULL,
	[DefPrintacquittance] [varchar](256) NULL,
	[DeflawsuitDebitAccountGUID] [uniqueidentifier] NULL,
	[DeflawsuitCreditAccountGUID] [uniqueidentifier] NULL,
	[LawsuitCustAccount] [bit] NULL,
	[LawsuitCostwithDebitAccount] [bit] NULL,
	[LawsuitCostwithCreditAccount] [bit] NULL,
	[LawsuitLinkUser] [bit] NULL,
	[LawsuitLinkUserExpense] [bit] NULL,
	[UnearnedrRevenue] [bit] NULL,
	[AcIncomNextYearGUID] [uniqueidentifier] NULL,
	[AcCommissionExpenseGuid] [uniqueidentifier] NULL,
	[OpNewContract] [varchar](10) NULL,
	[FirstPayNote] [varchar](255) NULL,
	[FirstPayNoteLtn] [varchar](255) NULL,
	[ContractNote] [varchar](255) NULL,
	[ContractNoteLtn] [varchar](255) NULL,
	[FeeEntryNote] [varchar](255) NULL,
	[CanBeginDateAfterDate2] [bit] NULL,
	[GenEntryEnd] [bit] NULL,
	[DefPicTab] [varchar](255) NULL,
PRIMARY KEY CLUSTERED 
(
	[Guid] ASC
)WITH (PAD_INDEX = OFF, STATISTICS_NORECOMPUTE = OFF, IGNORE_DUP_KEY = OFF, ALLOW_ROW_LOCKS = ON, ALLOW_PAGE_LOCKS = ON, OPTIMIZE_FOR_SEQUENTIAL_KEY = OFF) ON [PRIMARY]
) ON [PRIMARY]
GO
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE TABLE [dbo].[ContractTypeFeeAccount](
	[Number] [int] NOT NULL IDENTITY(1,1),
	[ParentGuid] [uniqueidentifier] NULL,
	[AccountGuid] [uniqueidentifier] NULL,
	[Note] [varchar](255) NULL
) ON [PRIMARY]
GO
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE TABLE [dbo].[ContractTypeFineAccount](
	[Number] [int] NOT NULL IDENTITY(1,1),
	[ParentGuid] [uniqueidentifier] NULL,
	[AccountGuid] [uniqueidentifier] NULL,
	[Note] [varchar](255) NULL
) ON [PRIMARY]
GO
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE TABLE [dbo].[ContractTypePrivilege](
	[UserGuid] [uniqueidentifier] NULL,
	[ContractTypeGuid] [uniqueidentifier] NULL,
	[Open] [bit] NULL,
	[Add] [bit] NULL,
	[Edit] [bit] NULL,
	[Del] [bit] NULL,
	[Mark] [bit] NULL,
	[MarkEdit] [bit] NULL,
	[MarkDel] [bit] NULL,
	[ShowMark] [bit] NULL,
	[Print] [bit] NULL,
	[Design] [bit] NULL,
	[Field7] [bit] NULL,
	[Field8] [bit] NULL,
	[Field9] [bit] NULL,
	[Field10] [bit] NULL,
	[Field11] [bit] NULL,
	[Field12] [bit] NULL,
	[Field13] [bit] NULL,
	[Field14] [bit] NULL,
	[Field15] [bit] NULL,
	[Field16] [bit] NULL,
	[Field17] [bit] NULL,
	[Field18] [bit] NULL,
	[Field19] [bit] NULL,
	[Field20] [bit] NULL,
	[Field21] [bit] NULL,
	[MaxDiscount] [float] NULL,
	[CustBalance] [int] NULL
) ON [PRIMARY]
GO
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE TABLE [dbo].[ContractWorkFlow](
	[Number] [int] NOT NULL IDENTITY(1,1),
	[Guid] [uniqueidentifier] NOT NULL,
	[SecLvl] [int] NULL,
	[ContractGuid] [uniqueidentifier] NULL,
	[Printed] [int] NULL,
	[Certification] [int] NULL,
	[CustStep1] [bit] NULL,
	[CustStepDate1] [date] NULL,
	[CustStep2] [bit] NULL,
	[CustStepDate2] [date] NULL,
	[CompStep1] [bit] NULL,
	[CompStepDate1] [date] NULL,
	[CompStep2] [bit] NULL,
	[CompStepDate2] [date] NULL,
	[CompStep3] [bit] NULL,
	[CompStepDate3] [date] NULL,
	[CompStep4] [bit] NULL,
	[CompStepDate4] [date] NULL,
	[CompStep5] [bit] NULL,
	[CompStepDate5] [date] NULL,
	[CompStep6] [bit] NULL,
	[CompStepDate6] [date] NULL,
	[CompStep7] [bit] NULL,
	[CompStepDate7] [date] NULL,
	[Note] [varchar](256) NULL,
PRIMARY KEY CLUSTERED 
(
	[Guid] ASC
)WITH (PAD_INDEX = OFF, STATISTICS_NORECOMPUTE = OFF, IGNORE_DUP_KEY = OFF, ALLOW_ROW_LOCKS = ON, ALLOW_PAGE_LOCKS = ON, OPTIMIZE_FOR_SEQUENTIAL_KEY = OFF) ON [PRIMARY]
) ON [PRIMARY]
GO
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE TABLE [dbo].[Cost](
	[Number] [int] NOT NULL IDENTITY(1,1),
	[Guid] [uniqueidentifier] NOT NULL,
	[SecLvl] [int] NULL,
	[Code] [varchar](250) NULL,
	[Name] [varchar](250) NULL,
	[LtnName] [varchar](250) NULL,
	[ParentGUID] [uniqueidentifier] NULL,
	[Note] [varchar](256) NULL,
PRIMARY KEY CLUSTERED 
(
	[Guid] ASC
)WITH (PAD_INDEX = OFF, STATISTICS_NORECOMPUTE = OFF, IGNORE_DUP_KEY = OFF, ALLOW_ROW_LOCKS = ON, ALLOW_PAGE_LOCKS = ON, OPTIMIZE_FOR_SEQUENTIAL_KEY = OFF) ON [PRIMARY]
) ON [PRIMARY]
GO
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE TABLE [dbo].[Currency](
	[Number] [int] NOT NULL IDENTITY(1,1),
	[Guid] [uniqueidentifier] NOT NULL,
	[SecLvl] [int] NULL,
	[Code] [varchar](250) NULL,
	[LtnCode] [varchar](250) NULL,
	[Name] [varchar](250) NULL,
	[LtnName] [varchar](250) NULL,
	[CurrencyVal] [float] NULL,
	[EnPartName] [varchar](250) NULL,
	[ArPartName] [varchar](250) NULL,
	[Part] [float] NULL,
	[CurrencyRate] [float] NULL,
	[Note] [varchar](250) NULL,
	[OnlyName] [varchar](255) NULL,
	[OnlyPluralName] [varchar](255) NULL,
	[OnlyByCountryName] [varchar](255) NULL,
	[OnlyPartPlularName] [varchar](255) NULL,
	[OnlyLtnName] [varchar](255) NULL,
	[OnlyPluralLtnName] [varchar](255) NULL,
	[OnlyByCountryLtnName] [varchar](255) NULL,
	[OnlyPartPlularLtnName] [varchar](255) NULL,
PRIMARY KEY CLUSTERED 
(
	[Guid] ASC
)WITH (PAD_INDEX = OFF, STATISTICS_NORECOMPUTE = OFF, IGNORE_DUP_KEY = OFF, ALLOW_ROW_LOCKS = ON, ALLOW_PAGE_LOCKS = ON, OPTIMIZE_FOR_SEQUENTIAL_KEY = OFF) ON [PRIMARY]
) ON [PRIMARY]
GO
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE TABLE [dbo].[CurrentUsers](
	[UserGuid] [uniqueidentifier] NULL,
	[Spid] [int] NULL,
	[SecLvl] [int] NULL,
	[Admin] [bit] NULL
) ON [PRIMARY]
GO
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE TABLE [dbo].[Customer](
	[Number] [int] NOT NULL IDENTITY(1,1),
	[Guid] [uniqueidentifier] NOT NULL,
	[SecLvl] [int] NULL,
	[Barcode] [varchar](256) NULL,
	[Name] [varchar](256) NULL,
	[LtnName] [varchar](256) NULL,
	[CardKind] [int] NULL,
	[CardKind2] [int] NULL,
	[CustKind] [int] NULL,
	[Nationality] [varchar](256) NULL,
	[LtnNationality] [varchar](256) NULL,
	[Profession] [varchar](256) NULL,
	[LtnProfession] [varchar](256) NULL,
	[PassportNO] [varchar](256) NULL,
	[PassportExpireDate] [date] NULL,
	[Domicile] [varchar](256) NULL,
	[Security] [varchar](256) NULL,
	[LtnSecurity] [varchar](256) NULL,
	[PhoneJob] [varchar](256) NULL,
	[Mobile] [varchar](256) NULL,
	[Note] [varchar](256) NULL,
	[Trademark] [varchar](256) NULL,
	[LtnTrademark] [varchar](256) NULL,
	[AcGuid] [uniqueidentifier] NULL,
	[InsuranceAccountGuid] [uniqueidentifier] NULL,
	[MemoSecurity] [varchar](256) NULL,
	[LtnMemoSecurity] [varchar](256) NULL,
	[Address] [varchar](256) NULL,
	[LtnAddress] [varchar](256) NULL,
	[BoxNo] [varchar](256) NULL,
	[PersonalityNo1] [varchar](256) NULL,
	[PersonalityNo2] [varchar](256) NULL,
	[Fax] [varchar](256) NULL,
	[EMail] [varchar](256) NULL,
	[Adjective] [varchar](256) NULL,
	[LtnAdjective] [varchar](256) NULL,
	[CkHideInSearch] [bit] NULL,
	[ban] [bit] NULL,
	[banContract] [bit] NULL,
	[BankName] [varchar](256) NULL,
	[BankAccCode] [varchar](256) NULL,
	[Birthday] [date] NULL,
	[DomicileEndDate] [date] NULL,
	[PersonalityEndDate] [date] NULL,
	[CustNote1] [varchar](256) NULL,
	[CustNote2] [varchar](256) NULL,
	[CustNote3] [varchar](256) NULL,
	[CustNote4] [varchar](256) NULL,
	[CustNote5] [varchar](256) NULL,
	[CustNote6] [varchar](256) NULL,
	[CustNote7] [varchar](256) NULL,
PRIMARY KEY CLUSTERED 
(
	[Guid] ASC
)WITH (PAD_INDEX = OFF, STATISTICS_NORECOMPUTE = OFF, IGNORE_DUP_KEY = OFF, ALLOW_ROW_LOCKS = ON, ALLOW_PAGE_LOCKS = ON, OPTIMIZE_FOR_SEQUENTIAL_KEY = OFF) ON [PRIMARY],
 CONSTRAINT [UK_Customer_Name_UNIQUE] UNIQUE NONCLUSTERED 
(
	[Name] ASC
)WITH (PAD_INDEX = OFF, STATISTICS_NORECOMPUTE = OFF, IGNORE_DUP_KEY = OFF, ALLOW_ROW_LOCKS = ON, ALLOW_PAGE_LOCKS = ON, OPTIMIZE_FOR_SEQUENTIAL_KEY = OFF) ON [PRIMARY]
) ON [PRIMARY]
GO
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE TABLE [dbo].[DefaultMenuBank](
	[id] [int] IDENTITY(1,1) NOT NULL,
	[Name] [varchar](255) NULL
) ON [PRIMARY]
GO
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE TABLE [dbo].[DefaultMenuLtnNationality](
	[id] [int] IDENTITY(1,1) NOT NULL,
	[Name] [varchar](255) NULL
) ON [PRIMARY]
GO
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE TABLE [dbo].[DefaultMenuNationality](
	[id] [int] IDENTITY(1,1) NOT NULL,
	[Name] [varchar](255) NULL
) ON [PRIMARY]
GO
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE TABLE [dbo].[DEntry](
	[Number] [int] NOT NULL IDENTITY(1,1),
	[Guid] [uniqueidentifier] NULL,
	[ParentGuid] [uniqueidentifier] NULL,
	[AcGuid] [uniqueidentifier] NULL,
	[Debit] [float] NULL,
	[Credit] [float] NULL,
	[CurrencyGuid] [uniqueidentifier] NULL,
	[CurrencyVal] [float] NULL,
	[ObverseAcGuid] [uniqueidentifier] NULL,
	[CostGuid] [uniqueidentifier] NULL,
	[Note] [varchar](256) NULL,
	[IsVisible] [bit] NULL
) ON [PRIMARY]
GO
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE TABLE [dbo].[DMD_const](
	[VName] [nvarchar](2048) NULL,
	[Value] [nvarchar](2048) NULL
) ON [PRIMARY]
GO
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE TABLE [dbo].[Earth](
	[Number] [int] NOT NULL IDENTITY(1,1),
	[Guid] [uniqueidentifier] NOT NULL,
	[SecLvl] [int] NULL,
	[No] [varchar](256) NULL,
	[Ban] [bit] NULL,
	[EarthNo] [varchar](256) NULL,
	[Name] [varchar](256) NULL,
	[ltnName] [varchar](256) NULL,
	[CustomerGuid] [uniqueidentifier] NULL,
	[Date] [date] NULL,
	[City] [varchar](256) NULL,
	[Region] [varchar](256) NULL,
	[Space] [varchar](256) NULL,
	[Area] [float] NULL,
	[Unity] [varchar](256) NULL,
	[Price] [float] NULL,
	[licenseNo] [varchar](256) NULL,
	[license] [varchar](256) NULL,
	[licenseDate] [date] NULL,
	[Details] [varchar](256) NULL,
	[LandType] [varchar](256) NULL,
	[Side] [varchar](256) NULL,
	[StreetName] [varchar](256) NULL,
	[StreetCount] [int] NULL,
	[Buildble] [bit] NULL,
	[LandOwner] [int] NULL,
	[BeginLandValue] [float] NULL,
	[CurrencyBeginLandGuid] [uniqueidentifier] NULL,
	[CurrencyValBeginLand] [float] NULL,
	[BeginLandCostGuid] [uniqueidentifier] NULL,
	[CurrencyPurchaseGuid] [uniqueidentifier] NULL,
	[CurrencyValPurchase] [float] NULL,
	[PurchaseNote] [varchar](256) NULL,
	[AccountGuid] [uniqueidentifier] NULL,
	[CuOwnerGuid] [uniqueidentifier] NULL,
	[CostGuid] [uniqueidentifier] NULL,
	[BankAccountGuid] [uniqueidentifier] NULL,
	[CommissionPercent] [float] NULL,
	[AccountCommIncomeGuid] [uniqueidentifier] NULL,
	[UsedEndDate] [bit] NULL,
	[CustomerOwnerGuid] [uniqueidentifier] NULL,
	[OwnerAccountGuid] [uniqueidentifier] NULL,
	[IdentityValue] [float] NULL,
	[CurrencyIdentityGUID] [uniqueidentifier] NULL,
	[CurrencyValIdentity] [float] NULL,
	[IdentityBeginDate] [date] NULL,
	[IdentityEndDate] [date] NULL,
	[CrearteEntryInvestment] [bit] NULL,
	[IdentityEntryGuid] [uniqueidentifier] NULL,
	[IdentityNote] [varchar](256) NULL,
	[LtnLandType] [varchar](256) NULL,
	[LtnCity] [varchar](256) NULL,
	[LtnRegion] [varchar](256) NULL,
	[LtnSpace] [varchar](256) NULL,
	[Ltnlicense] [varchar](256) NULL,
	[Ltnside] [varchar](256) NULL,
	[Rent] [float] NULL,
	[RentCurrencyGuid] [uniqueidentifier] NULL,
PRIMARY KEY CLUSTERED 
(
	[Guid] ASC
)WITH (PAD_INDEX = OFF, STATISTICS_NORECOMPUTE = OFF, IGNORE_DUP_KEY = OFF, ALLOW_ROW_LOCKS = ON, ALLOW_PAGE_LOCKS = ON, OPTIMIZE_FOR_SEQUENTIAL_KEY = OFF) ON [PRIMARY]
) ON [PRIMARY]
GO
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE TABLE [dbo].[ElectricityBill](
	[Number] [int] NOT NULL IDENTITY(1,1),
	[Guid] [uniqueidentifier] NOT NULL,
	[SecLvl] [int] NULL,
	[Mark] [bit] NULL,
	[TypeGuid] [uniqueidentifier] NULL,
	[IsCollect] [bit] NULL,
	[Date] [date] NULL,
	[BuildingGuid] [uniqueidentifier] NULL,
	[RealtyType] [int] NULL,
	[FlatGuid] [uniqueidentifier] NULL,
	[ShopGuid] [uniqueidentifier] NULL,
	[ContractGuid] [uniqueidentifier] NULL,
	[CustGuid] [uniqueidentifier] NULL,
	[ElecCounterNo] [varchar](255) NULL,
	[Counter] [float] NULL,
	[OldCounter] [float] NULL,
	[Discount] [float] NULL,
	[Extra] [float] NULL,
	[Consumption] [float] NULL,
	[WaterCounterNo] [varchar](255) NULL,
	[WCounter] [float] NULL,
	[WOldCounter] [float] NULL,
	[RoundKind] [int] NULL,
	[TotalValue] [float] NULL,
	[IncomeAccountGuid] [uniqueidentifier] NULL,
	[ExtraAccountGuid] [uniqueidentifier] NULL,
	[DiscountAccountGuid] [uniqueidentifier] NULL,
	[WaterAccountGuid] [uniqueidentifier] NULL,
	[DrainageAccountGuid] [uniqueidentifier] NULL,
	[WaterValue] [float] NULL,
	[DrainageValue] [float] NULL,
	[FineAccountGuid] [uniqueidentifier] NULL,
	[FeeAccountGuid] [uniqueidentifier] NULL,
	[FineValue] [float] NULL,
	[FeeValue] [float] NULL,
	[Overdue] [float] NULL,
	[WaterNote] [varchar](256) NULL,
	[DrainageNote] [varchar](256) NULL,
	[DiscountNote] [varchar](256) NULL,
	[ExtraNote] [varchar](256) NULL,
	[ConsumptionNote] [varchar](256) NULL,
	[FineNote] [varchar](256) NULL,
	[FeeNote] [varchar](256) NULL,
	[CurrencyGuid] [uniqueidentifier] NULL,
	[CurrencyVal] [float] NULL,
	[CreateBilltEntry] [bit] NULL,
	[Note] [varchar](256) NULL,
PRIMARY KEY CLUSTERED 
(
	[Guid] ASC
)WITH (PAD_INDEX = OFF, STATISTICS_NORECOMPUTE = OFF, IGNORE_DUP_KEY = OFF, ALLOW_ROW_LOCKS = ON, ALLOW_PAGE_LOCKS = ON, OPTIMIZE_FOR_SEQUENTIAL_KEY = OFF) ON [PRIMARY]
) ON [PRIMARY]
GO
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE TABLE [dbo].[ElectricityCachPayment](
	[ContractGuid] [uniqueidentifier] NULL,
	[EntryGuid] [uniqueidentifier] NULL
) ON [PRIMARY]
GO
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE TABLE [dbo].[ElectricityType](
	[Number] [int] NOT NULL IDENTITY(1,1),
	[Guid] [uniqueidentifier] NOT NULL,
	[SecLvl] [int] NULL,
	[Name] [varchar](256) NULL,
	[ltnName] [varchar](256) NULL,
	[Menu] [varchar](256) NULL,
	[LtnMenu] [varchar](256) NULL,
	[ShortCut] [varchar](256) NULL,
	[CreatedEntry] [bit] NULL,
	[AutoCreatedEntry] [bit] NULL,
	[AutoPostedEntry] [bit] NULL,
	[BuildingGuid] [uniqueidentifier] NULL,
	[IncomeAccountGuid] [uniqueidentifier] NULL,
	[ExtraAccountGuid] [uniqueidentifier] NULL,
	[DiscountAccountGuid] [uniqueidentifier] NULL,
	[WaterAccountGuid] [uniqueidentifier] NULL,
	[DrainageAccountGuid] [uniqueidentifier] NULL,
	[WaterValue] [float] NULL,
	[DrainageValue] [float] NULL,
	[FineAccountGuid] [uniqueidentifier] NULL,
	[FeeAccountGuid] [uniqueidentifier] NULL,
	[FineValue] [float] NULL,
	[FeeValue] [float] NULL,
	[DefPrintPath] [varchar](256) NULL,
	[CurrencyGuid] [uniqueidentifier] NULL,
	[CurrencyVal] [float] NULL,
	[Calculate] [varchar](800) NULL,
	[Calculate2] [varchar](800) NULL,
	[DefCheckTypeGuid] [uniqueidentifier] NULL,
	[DefEntryTypeGuid] [uniqueidentifier] NULL,
PRIMARY KEY CLUSTERED 
(
	[Guid] ASC
)WITH (PAD_INDEX = OFF, STATISTICS_NORECOMPUTE = OFF, IGNORE_DUP_KEY = OFF, ALLOW_ROW_LOCKS = ON, ALLOW_PAGE_LOCKS = ON, OPTIMIZE_FOR_SEQUENTIAL_KEY = OFF) ON [PRIMARY]
) ON [PRIMARY]
GO
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE TABLE [dbo].[ElectricityTypePrivilege](
	[UserGuid] [uniqueidentifier] NULL,
	[ElectricityTypeGuid] [uniqueidentifier] NULL,
	[Open] [bit] NULL,
	[Add] [bit] NULL,
	[Edit] [bit] NULL,
	[Del] [bit] NULL,
	[Mark] [bit] NULL,
	[MarkEdit] [bit] NULL,
	[MarkDel] [bit] NULL,
	[ShowMark] [bit] NULL,
	[Print] [bit] NULL,
	[Design] [bit] NULL,
	[Field1] [bit] NULL,
	[Field2] [bit] NULL,
	[MaxDiscount] [float] NULL
) ON [PRIMARY]
GO
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE TABLE [dbo].[EntryDate](
	[Guid] [uniqueidentifier] NOT NULL,
	[Number] [int] NOT NULL IDENTITY(1,1),
	[SecLvl] [int] NULL,
	[TypeGuid] [uniqueidentifier] NULL,
	[Kind] [int] NULL,
	[Mark] [bit] NULL,
	[AccountGuid] [uniqueidentifier] NULL,
	[Date] [date] NULL,
	[Note] [varchar](256) NULL,
	[CurrencyGuid] [uniqueidentifier] NULL,
	[CurrencyVal] [float] NULL,
	[UserGuid] [uniqueidentifier] NULL,
	[BranchGuid] [uniqueidentifier] NULL,
PRIMARY KEY CLUSTERED 
(
	[Guid] ASC
)WITH (PAD_INDEX = OFF, STATISTICS_NORECOMPUTE = OFF, IGNORE_DUP_KEY = OFF, ALLOW_ROW_LOCKS = ON, ALLOW_PAGE_LOCKS = ON, OPTIMIZE_FOR_SEQUENTIAL_KEY = OFF) ON [PRIMARY]
) ON [PRIMARY]
GO
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE TABLE [dbo].[EntryDateDetail](
	[Number] [int] NOT NULL IDENTITY(1,1),
	[Guid] [uniqueidentifier] NOT NULL,
	[Date] [date] NULL,
	[ParentGuid] [uniqueidentifier] NULL,
	[AcGuid] [uniqueidentifier] NULL,
	[Debit] [float] NULL,
	[Credit] [float] NULL,
	[CurrencyGuid] [uniqueidentifier] NULL,
	[CurrencyVal] [float] NULL,
	[ObverseAcGuid] [uniqueidentifier] NULL,
	[CostGuid] [uniqueidentifier] NULL,
	[Note] [varchar](256) NULL,
PRIMARY KEY CLUSTERED 
(
	[Guid] ASC
)WITH (PAD_INDEX = OFF, STATISTICS_NORECOMPUTE = OFF, IGNORE_DUP_KEY = OFF, ALLOW_ROW_LOCKS = ON, ALLOW_PAGE_LOCKS = ON, OPTIMIZE_FOR_SEQUENTIAL_KEY = OFF) ON [PRIMARY]
) ON [PRIMARY]
GO
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE TABLE [dbo].[EntryDateType](
	[Number] [int] NOT NULL IDENTITY(1,1),
	[Guid] [uniqueidentifier] NOT NULL,
	[SecLvl] [int] NULL,
	[Code] [varchar](256) NULL,
	[Name] [varchar](256) NULL,
	[ltnName] [varchar](256) NULL,
	[Menu] [varchar](256) NULL,
	[LtnMenu] [varchar](256) NULL,
	[ShortCut] [varchar](256) NULL,
	[DefAccountGuid] [uniqueidentifier] NULL,
	[DebitField] [bit] NULL,
	[CreditField] [bit] NULL,
	[DebitCaption] [varchar](256) NULL,
	[CreditCaption] [varchar](256) NULL,
	[LtnDebitCaption] [varchar](256) NULL,
	[LtnCreditCaption] [varchar](256) NULL,
	[CkCurrency] [bit] NULL,
	[CkCost] [bit] NULL,
	[CkNote] [bit] NULL,
	[Color1] [int] NULL,
	[Color2] [int] NULL,
	[AutoPostedEntry] [bit] NULL,
	[OpMoveCostwithDefAccount] [bit] NULL,
	[NeedCostItem] [bit] NULL,
	[NeedNoteItem] [bit] NULL,
	[AutoSMSAfterAdd] [bit] NULL,
	[SMSMsg] [varchar](256) NULL,
	[SMSMsgEn] [varchar](256) NULL,
	[DefPrintPath] [varchar](256) NULL,
PRIMARY KEY CLUSTERED 
(
	[Guid] ASC
)WITH (PAD_INDEX = OFF, STATISTICS_NORECOMPUTE = OFF, IGNORE_DUP_KEY = OFF, ALLOW_ROW_LOCKS = ON, ALLOW_PAGE_LOCKS = ON, OPTIMIZE_FOR_SEQUENTIAL_KEY = OFF) ON [PRIMARY]
) ON [PRIMARY]
GO
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE TABLE [dbo].[EntryDateTypePrivilege](
	[UserGuid] [uniqueidentifier] NULL,
	[EntryTypeGuid] [uniqueidentifier] NULL,
	[Open] [bit] NULL,
	[Add] [bit] NULL,
	[Edit] [bit] NULL,
	[Del] [bit] NULL,
	[Mark] [bit] NULL,
	[MarkEdit] [bit] NULL,
	[MarkDel] [bit] NULL,
	[ShowMark] [bit] NULL,
	[Print] [bit] NULL,
	[Design] [bit] NULL,
	[CreateEntry] [bit] NULL,
	[ChangeAcc] [bit] NULL
) ON [PRIMARY]
GO
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE TABLE [dbo].[EntryType](
	[Number] [int] NOT NULL IDENTITY(1,1),
	[Guid] [uniqueidentifier] NOT NULL,
	[SecLvl] [int] NULL,
	[Code] [varchar](256) NULL,
	[Name] [varchar](256) NULL,
	[ltnName] [varchar](256) NULL,
	[Menu] [varchar](256) NULL,
	[LtnMenu] [varchar](256) NULL,
	[ShortCut] [varchar](256) NULL,
	[DefAccountGuid] [uniqueidentifier] NULL,
	[DebitField] [bit] NULL,
	[CreditField] [bit] NULL,
	[DebitCaption] [varchar](256) NULL,
	[CreditCaption] [varchar](256) NULL,
	[LtnDebitCaption] [varchar](256) NULL,
	[LtnCreditCaption] [varchar](256) NULL,
	[CkCurrency] [bit] NULL,
	[CkCurrencyRate] [bit] NULL,
	[CkCost] [bit] NULL,
	[CkNote] [bit] NULL,
	[Color1] [int] NULL,
	[Color2] [int] NULL,
	[ShowContractField] [bit] NULL,
	[ShowCostFromContract] [bit] NULL,
	[CreateEntry] [bit] NULL,
	[AutoCreateEntry] [bit] NULL,
	[AutoPostedEntry] [bit] NULL,
	[OpMoveCostwithDefAccount] [bit] NULL,
	[OpEntryForOneItem] [bit] NULL,
	[OpObverseNoteItem] [bit] NULL,
	[ObitemNotefromNote] [bit] NULL,
	[NeedCostItem] [bit] NULL,
	[NeedNoteItem] [bit] NULL,
	[AutoSMSAfterAdd] [bit] NULL,
	[SMSMsg] [varchar](256) NULL,
	[SMSMsgEn] [varchar](256) NULL,
	[DefPrintPath] [varchar](256) NULL,
PRIMARY KEY CLUSTERED 
(
	[Guid] ASC
)WITH (PAD_INDEX = OFF, STATISTICS_NORECOMPUTE = OFF, IGNORE_DUP_KEY = OFF, ALLOW_ROW_LOCKS = ON, ALLOW_PAGE_LOCKS = ON, OPTIMIZE_FOR_SEQUENTIAL_KEY = OFF) ON [PRIMARY]
) ON [PRIMARY]
GO
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE TABLE [dbo].[EntryTypePrivilege](
	[UserGuid] [uniqueidentifier] NULL,
	[EntryTypeGuid] [uniqueidentifier] NULL,
	[Open] [bit] NULL,
	[Add] [bit] NULL,
	[Edit] [bit] NULL,
	[Del] [bit] NULL,
	[Mark] [bit] NULL,
	[MarkEdit] [bit] NULL,
	[MarkDel] [bit] NULL,
	[ShowMark] [bit] NULL,
	[Print] [bit] NULL,
	[Design] [bit] NULL,
	[CreateEntry] [bit] NULL,
	[ChangeAcc] [bit] NULL
) ON [PRIMARY]
GO
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE TABLE [dbo].[ExternalTools](
	[Number] [int] NOT NULL IDENTITY(1,1),
	[Guid] [uniqueidentifier] NOT NULL,
	[SecLvl] [int] NULL,
	[Name] [varchar](250) NULL,
	[Prog] [varchar](250) NULL,
	[ShortCut] [varchar](250) NULL,
PRIMARY KEY CLUSTERED 
(
	[Guid] ASC
)WITH (PAD_INDEX = OFF, STATISTICS_NORECOMPUTE = OFF, IGNORE_DUP_KEY = OFF, ALLOW_ROW_LOCKS = ON, ALLOW_PAGE_LOCKS = ON, OPTIMIZE_FOR_SEQUENTIAL_KEY = OFF) ON [PRIMARY]
) ON [PRIMARY]
GO
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE TABLE [dbo].[FlatAssets](
	[Number] [int] NOT NULL IDENTITY(1,1),
	[ParentGuid] [uniqueidentifier] NULL,
	[AssetsGuid] [uniqueidentifier] NULL,
	[Value] [float] NULL,
	[Note] [varchar](255) NULL
) ON [PRIMARY]
GO
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE TABLE [dbo].[FlatBuilding](
	[BuildingGuid] [uniqueidentifier] NULL,
	[CostGuid] [uniqueidentifier] NULL,
	[BuildingAcGuid] [uniqueidentifier] NULL,
	[ProjectAcGuid] [uniqueidentifier] NULL,
	[ClientAcGuid] [uniqueidentifier] NULL,
	[CreateEntry] [bit] NULL,
	[EntryDate] [date] NULL,
	[FloorCount] [int] NULL,
	[FlatByFloor] [int] NULL,
	[RealFlatCount] [int] NULL,
	[Area] [float] NULL,
	[CostProject] [float] NULL,
	[Costunity] [float] NULL,
	[CurrencyGuid] [uniqueidentifier] NULL,
	[CurrencyVal] [float] NULL,
	[MBalanceFloor] [int] NULL,
	[BHouseFloor] [int] NULL,
	[ShopFloor] [int] NULL
) ON [PRIMARY]
GO
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE TABLE [dbo].[FlatBuildingDetails](
	[Number] [int] NOT NULL IDENTITY(1,1),
	[Guid] [uniqueidentifier] NOT NULL,
	[BuildingGuid] [uniqueidentifier] NULL,
	[Color] [int] NULL,
	[Count] [int] NULL,
	[FlatKind] [varchar](256) NULL,
	[Type] [varchar](256) NULL,
	[Class] [varchar](256) NULL,
	[Area] [float] NULL,
	[Unity] [varchar](256) NULL,
	[Rent] [float] NULL,
	[CostPrice] [float] NULL,
	[SalePrice] [float] NULL,
	[SalePrice2] [float] NULL,
	[SalePrice3] [float] NULL,
	[FlatOwner] [int] NULL,
	[CustGuid] [uniqueidentifier] NULL,
	[Details] [varchar](256) NULL,
	[Overlooking] [varchar](256) NULL,
	[OfferType] [int] NULL,
	[Restrained] [bit] NULL,
	[BathroomCount] [int] NULL,
	[BalconyCount] [int] NULL,
	[Note] [varchar](256) NULL
) ON [PRIMARY]
GO
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE TABLE [dbo].[FlatBuildingDetails_2](
	[Number] [int] NOT NULL IDENTITY(1,1),
	[BuildingGuid] [uniqueidentifier] NULL,
	[Floor] [varchar](8000) NULL,
	[Note] [varchar](256) NULL
) ON [PRIMARY]
GO
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE TABLE [dbo].[FlatBuildingDetails_BHouse](
	[Number] [int] NOT NULL IDENTITY(1,1),
	[BuildingGuid] [uniqueidentifier] NULL,
	[Floor] [varchar](8000) NULL,
	[Note] [varchar](256) NULL
) ON [PRIMARY]
GO
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE TABLE [dbo].[FlatBuildingDetails_FlatDriver](
	[Number] [int] NOT NULL IDENTITY(1,1),
	[BuildingGuid] [uniqueidentifier] NULL,
	[Floor] [varchar](8000) NULL,
	[Note] [varchar](256) NULL
) ON [PRIMARY]
GO
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE TABLE [dbo].[FlatBuildingDetails_FlatServant](
	[Number] [int] NOT NULL IDENTITY(1,1),
	[BuildingGuid] [uniqueidentifier] NULL,
	[Floor] [varchar](8000) NULL,
	[Note] [varchar](256) NULL
) ON [PRIMARY]
GO
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE TABLE [dbo].[FlatBuildingDetails_MBalance](
	[Number] [int] NOT NULL IDENTITY(1,1),
	[BuildingGuid] [uniqueidentifier] NULL,
	[Floor] [varchar](8000) NULL,
	[Note] [varchar](256) NULL
) ON [PRIMARY]
GO
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE TABLE [dbo].[FlatBuildingDetails_Office](
	[Number] [int] NOT NULL IDENTITY(1,1),
	[BuildingGuid] [uniqueidentifier] NULL,
	[Floor] [varchar](8000) NULL,
	[Note] [varchar](256) NULL
) ON [PRIMARY]
GO
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE TABLE [dbo].[FlatBuildingDetails_Parking](
	[Number] [int] NOT NULL IDENTITY(1,1),
	[BuildingGuid] [uniqueidentifier] NULL,
	[Floor] [varchar](8000) NULL,
	[Note] [varchar](256) NULL
) ON [PRIMARY]
GO
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE TABLE [dbo].[FlatBuildingDetails_Shop](
	[Number] [int] NOT NULL IDENTITY(1,1),
	[BuildingGuid] [uniqueidentifier] NULL,
	[Floor] [varchar](8000) NULL,
	[Note] [varchar](256) NULL
) ON [PRIMARY]
GO
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE TABLE [dbo].[FlatBuildingDetails_Store](
	[Number] [int] NOT NULL IDENTITY(1,1),
	[BuildingGuid] [uniqueidentifier] NULL,
	[Floor] [varchar](8000) NULL,
	[Note] [varchar](256) NULL
) ON [PRIMARY]
GO
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE TABLE [dbo].[FlatContractFee](
	[Number] [int] NOT NULL IDENTITY(1,1),
	[EntryNumber] [int] NULL,
	[Guid] [uniqueidentifier] NOT NULL,
	[ParentGuid] [uniqueidentifier] NULL,
	[Date] [date] NULL,
	[AccountGuid] [uniqueidentifier] NULL,
	[Value] [float] NULL,
	[CreateEntry] [bit] NULL,
	[Note] [varchar](255) NULL,
PRIMARY KEY CLUSTERED 
(
	[Guid] ASC
)WITH (PAD_INDEX = OFF, STATISTICS_NORECOMPUTE = OFF, IGNORE_DUP_KEY = OFF, ALLOW_ROW_LOCKS = ON, ALLOW_PAGE_LOCKS = ON, OPTIMIZE_FOR_SEQUENTIAL_KEY = OFF) ON [PRIMARY]
) ON [PRIMARY]
GO
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE TABLE [dbo].[FlatContractFine](
	[Number] [int] NOT NULL IDENTITY(1,1),
	[ParentGuid] [uniqueidentifier] NULL,
	[AccountGuid] [uniqueidentifier] NULL,
	[Value] [float] NULL,
	[Note] [varchar](255) NULL
) ON [PRIMARY]
GO
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE TABLE [dbo].[FlatContractReceiptNO](
	[Number] [int] NOT NULL IDENTITY(1,1),
	[Guid] [uniqueidentifier] NOT NULL,
	[SecLvl] [int] NULL,
	[ParentGuid] [uniqueidentifier] NULL,
	[No] [varchar](256) NULL,
	[Date] [date] NULL,
	[Note] [varchar](256) NULL,
PRIMARY KEY CLUSTERED 
(
	[Guid] ASC
)WITH (PAD_INDEX = OFF, STATISTICS_NORECOMPUTE = OFF, IGNORE_DUP_KEY = OFF, ALLOW_ROW_LOCKS = ON, ALLOW_PAGE_LOCKS = ON, OPTIMIZE_FOR_SEQUENTIAL_KEY = OFF) ON [PRIMARY]
) ON [PRIMARY]
GO
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE TABLE [dbo].[Flatwallet](
	[Number] [int] NOT NULL IDENTITY(1,1),
	[ParentGuid] [uniqueidentifier] NULL,
	[BuildingGuid] [uniqueidentifier] NULL,
	[FlatGuid] [uniqueidentifier] NULL,
	[MainCost] [float] NULL,
	[Expense] [float] NULL,
	[BeginDate] [date] NULL,
	[SaleDate] [date] NULL,
	[SaleValue] [float] NULL
) ON [PRIMARY]
GO
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE TABLE [dbo].[HEntry](
	[Guid] [uniqueidentifier] NOT NULL,
	[Number] [int] NOT NULL IDENTITY(1,1),
	[SecLvl] [int] NULL,
	[Mark] [bit] NULL,
	[Date] [date] NULL,
	[CurrencyGuid] [uniqueidentifier] NULL,
	[CurrencyVal] [float] NULL,
	[Note] [varchar](256) NULL,
	[ParentKind] [int] NULL,
	[UserGuid] [uniqueidentifier] NULL,
	[BranchGuid] [uniqueidentifier] NULL,
	[IsPosted] [bit] NULL,
	[Debit] [float] NULL,
	[Credit] [float] NULL,
	[ItemCount] [int] NULL,
PRIMARY KEY CLUSTERED 
(
	[Guid] ASC
)WITH (PAD_INDEX = OFF, STATISTICS_NORECOMPUTE = OFF, IGNORE_DUP_KEY = OFF, ALLOW_ROW_LOCKS = ON, ALLOW_PAGE_LOCKS = ON, OPTIMIZE_FOR_SEQUENTIAL_KEY = OFF) ON [PRIMARY],
 CONSTRAINT [HEntry_Unique_Number] UNIQUE NONCLUSTERED 
(
	[Number] ASC
)WITH (PAD_INDEX = OFF, STATISTICS_NORECOMPUTE = OFF, IGNORE_DUP_KEY = OFF, ALLOW_ROW_LOCKS = ON, ALLOW_PAGE_LOCKS = ON, OPTIMIZE_FOR_SEQUENTIAL_KEY = OFF) ON [PRIMARY]
) ON [PRIMARY]
GO
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE TABLE [dbo].[HjrConfig](
	[hjrYear] [int] NULL,
	[hjrMonth] [int] NULL,
	[Date] [date] NULL,
	[Day] [int] NULL
) ON [PRIMARY]
GO
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE TABLE [dbo].[HjrMonthDayCount](
	[Month] [int] NULL,
	[DayCount] [int] NULL
) ON [PRIMARY]
GO
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE TABLE [dbo].[ImportAccTmp](
	[Id] [int] NULL,
	[Livel1Code] [varchar](255) NULL,
	[Livel2Code] [varchar](255) NULL,
	[Livel3Code] [varchar](255) NULL,
	[Livel4Code] [varchar](255) NULL,
	[Livel1Name] [varchar](255) NULL,
	[Livel2Name] [varchar](255) NULL,
	[Livel3Name] [varchar](255) NULL,
	[Livel4Name] [varchar](255) NULL
) ON [PRIMARY]
GO
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE TABLE [dbo].[ImportMatTmp](
	[Id] [int] NULL,
	[GroupCode] [varchar](255) NULL,
	[GroupName] [varchar](255) NULL,
	[Code] [varchar](255) NULL,
	[Name] [varchar](255) NULL,
	[LtnName] [varchar](255) NULL,
	[MatType] [int] NULL,
	[SecLvl] [int] NULL,
	[unity1] [varchar](255) NULL,
	[Defunity1] [float] NULL,
	[Barcode] [varchar](255) NULL,
	[unity2] [varchar](255) NULL,
	[Defunity2] [bit] NULL,
	[unityFact2] [float] NULL,
	[UnityFix2] [bit] NULL,
	[Barcode2] [varchar](255) NULL,
	[unity3] [varchar](255) NULL,
	[Defunity3] [bit] NULL,
	[unityFact3] [float] NULL,
	[UnityFix3] [bit] NULL,
	[Barcode3] [varchar](255) NULL,
	[Price11] [float] NULL,
	[Price12] [float] NULL,
	[Price13] [float] NULL,
	[Price14] [float] NULL,
	[Price15] [float] NULL,
	[Price16] [float] NULL,
	[Price17] [float] NULL,
	[Price21] [float] NULL,
	[Price22] [float] NULL,
	[Price23] [float] NULL,
	[Price24] [float] NULL,
	[Price25] [float] NULL,
	[Price26] [float] NULL,
	[Price27] [float] NULL,
	[Price31] [float] NULL,
	[Price32] [float] NULL,
	[Price33] [float] NULL,
	[Price34] [float] NULL,
	[Price35] [float] NULL,
	[Price36] [float] NULL,
	[Price37] [float] NULL,
	[Note] [varchar](255) NULL,
	[State] [varchar](255) NULL
) ON [PRIMARY]
GO
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE TABLE [dbo].[IncAccount](
	[Number] [int] NOT NULL IDENTITY(1,1),
	[Guid] [uniqueidentifier] NOT NULL,
	[SecLvl] [int] NULL,
	[Code] [varchar](256) NULL,
	[Name] [varchar](256) NULL,
	[LtnName] [varchar](256) NULL,
	[Note] [varchar](256) NULL,
	[Band] [int] NULL,
	[Band2] [int] NULL,
	[CalcoldYearBalance] [bit] NULL,
	[ShowBalanceInListFinCenter] [bit] NULL,
	[ParentGuid] [uniqueidentifier] NULL,
PRIMARY KEY CLUSTERED 
(
	[Guid] ASC
)WITH (PAD_INDEX = OFF, STATISTICS_NORECOMPUTE = OFF, IGNORE_DUP_KEY = OFF, ALLOW_ROW_LOCKS = ON, ALLOW_PAGE_LOCKS = ON, OPTIMIZE_FOR_SEQUENTIAL_KEY = OFF) ON [PRIMARY]
) ON [PRIMARY]
GO
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE TABLE [dbo].[IncAccountDetailAc](
	[Number] [int] NOT NULL IDENTITY(1,1),
	[ParentGuid] [uniqueidentifier] NULL,
	[AccountGuid] [uniqueidentifier] NULL
) ON [PRIMARY]
GO
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE TABLE [dbo].[IncAccountListDetail](
	[ParentGuid] [uniqueidentifier] NULL,
	[AccountGuid] [uniqueidentifier] NULL
) ON [PRIMARY]
GO
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE TABLE [dbo].[IncomeSaved](
	[Number] [int] NOT NULL IDENTITY(1,1),
	[Guid] [uniqueidentifier] NOT NULL,
	[SecLvl] [int] NULL,
	[Date] [date] NULL,
	[FromDate] [date] NULL,
	[ToDate] [date] NULL,
	[Note] [varchar](256) NULL,
PRIMARY KEY CLUSTERED 
(
	[Guid] ASC
)WITH (PAD_INDEX = OFF, STATISTICS_NORECOMPUTE = OFF, IGNORE_DUP_KEY = OFF, ALLOW_ROW_LOCKS = ON, ALLOW_PAGE_LOCKS = ON, OPTIMIZE_FOR_SEQUENTIAL_KEY = OFF) ON [PRIMARY]
) ON [PRIMARY]
GO
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE TABLE [dbo].[IncomeSavedDetail](
	[Number] [int] NOT NULL IDENTITY(1,1),
	[ParentGuid] [uniqueidentifier] NULL,
	[ContractGuid] [uniqueidentifier] NULL,
	[strKind] [varchar](256) NULL,
	[RentPrice] [float] NULL,
	[FromDate] [date] NULL,
	[ToDate] [date] NULL,
	[EndDate] [date] NULL,
	[Days] [int] NULL,
	[DayPrice] [float] NULL,
	[DayPeriod] [int] NULL,
	[Income] [float] NULL,
	[ContractFinish] [bit] NULL,
	[Collection] [float] NULL,
	[CheckNotCollection] [float] NULL,
	[Cash] [float] NULL,
	[TotalPays] [float] NULL,
	[ContractRest] [float] NULL,
	[CustBalance] [float] NULL
) ON [PRIMARY]
GO
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE TABLE [dbo].[InfofldCaption](
	[Cardid] [int] NULL,
	[id] [int] NULL,
	[FldCaption] [varchar](255) NULL
) ON [PRIMARY]
GO
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE TABLE [dbo].[InfofldValue](
	[CardGuid] [uniqueidentifier] NULL,
	[Cardid] [int] NULL,
	[id] [int] NULL,
	[FldValue] [varchar](255) NULL
) ON [PRIMARY]
GO
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE TABLE [dbo].[LandContract](
	[Number] [int] NOT NULL IDENTITY(1,1),
	[EditDate] [date] NULL,
	[DeliverDate] [date] NULL,
	[Guid] [uniqueidentifier] NOT NULL,
	[SecLvl] [int] NULL,
	[Mark] [bit] NULL,
	[IsAutoRenewal] [bit] NULL,
	[TypeGuid] [uniqueidentifier] NULL,
	[ContractNo] [varchar](256) NULL,
	[CustomerGuid] [uniqueidentifier] NULL,
	[SalesManGuid] [uniqueidentifier] NULL,
	[RentInfoGuid] [uniqueidentifier] NULL,
	[LandGuid] [uniqueidentifier] NULL,
	[VillaGuid] [uniqueidentifier] NULL,
	[CostGuid] [uniqueidentifier] NULL,
	[Rent] [float] NULL,
	[RentContractType] [int] NULL,
	[MonthlyValue] [float] NULL,
	[CurrencyGuid] [uniqueidentifier] NULL,
	[CurrencyVal] [float] NULL,
	[PayType] [int] NULL,
	[Note] [varchar](8000) NULL,
	[Note2] [varchar](8000) NULL,
	[Purpose] [varchar](256) NULL,
	[NewState] [int] NULL,
	[Whereabouts] [varchar](256) NULL,
	[RevenueAccountGuid] [uniqueidentifier] NULL,
	[CustAccountGuid] [uniqueidentifier] NULL,
	[CommissionFromCustPercent] [float] NULL,
	[CommissionFromCustValue] [float] NULL,
	[AcCommissionFromCustGuid] [uniqueidentifier] NULL,
	[CommissionFromOwnerPercent] [float] NULL,
	[CommissionFromOwnerValue] [float] NULL,
	[AcCommissionFromOwnerGuid] [uniqueidentifier] NULL,
	[CommissionFromSalesManrPercent] [float] NULL,
	[CommissionFromSalesManValue] [float] NULL,
	[AcSalesManCommissionGuid] [uniqueidentifier] NULL,
	[AcCommissionExpenseGuid] [uniqueidentifier] NULL,
	[SalesManCommNote] [varchar](256) NULL,
	[CreateContractEntry] [bit] NULL,
	[AcIncomNextYearGUID] [uniqueidentifier] NULL,
	[InsuranceAccountGuid] [uniqueidentifier] NULL,
	[Step1Complete] [bit] NULL,
	[Step2Complete] [bit] NULL,
	[Step3Complete] [bit] NULL,
	[Step4Complete] [bit] NULL,
	[Step5Complete] [bit] NULL,
	[Certification] [varchar](256) NULL,
	[DiscountPercent] [float] NULL,
	[DiscountValue] [float] NULL,
	[DiscountAccountGuid] [uniqueidentifier] NULL,
	[UserGuid] [uniqueidentifier] NULL,
	[BranchGuid] [uniqueidentifier] NULL,
	[RentDuration] [varchar](256) NULL,
	[Rentype] [varchar](256) NULL,
	[TermsOfPayment] [varchar](256) NULL,
	[InsuranceValuePercent] [float] NULL,
	[InsuranceValue] [float] NULL,
	[InsuranceValueOld] [float] NULL,
	[ContractPrice] [float] NULL,
	[CertificatValue] [float] NULL,
	[ElectricityInsurance] [float] NULL,
	[ElectricityCounter] [varchar](256) NULL,
	[FromDate] [date] NULL,
	[ToDate] [date] NULL,
	[Period] [int] NULL,
	[OtherFee] [float] NULL,
	[OtherFeeAccountGUID] [uniqueidentifier] NULL,
	[OtherFee1] [float] NULL,
	[OtherFeeAccount1GUID] [uniqueidentifier] NULL,
	[OtherFee2] [float] NULL,
	[OtherFeeAccount2GUID] [uniqueidentifier] NULL,
	[OtherFee3] [float] NULL,
	[OtherFeeAccount3GUID] [uniqueidentifier] NULL,
	[OtherFee4] [float] NULL,
	[OtherFeeAccount4GUID] [uniqueidentifier] NULL,
	[OtherFee5] [float] NULL,
	[OtherFeeAccount5GUID] [uniqueidentifier] NULL,
	[ContractFinish] [bit] NULL,
	[ContractFinishDate] [date] NULL,
	[EditContractFinishDate] [date] NULL,
	[ResultingAmount2] [float] NULL,
	[ResultingAmount] [float] NULL,
	[RoundKind] [int] NULL,
	[FineRevenueAccountGUID] [uniqueidentifier] NULL,
	[ResultingNote] [varchar](256) NULL,
	[Fine] [float] NULL,
	[FineAccount] [uniqueidentifier] NULL,
	[FineNote] [varchar](256) NULL,
	[CreateResultingEntry] [bit] NULL,
	[AccountContractPrice] [uniqueidentifier] NULL,
	[AccountCertificatValue] [uniqueidentifier] NULL,
	[License1No] [varchar](256) NULL,
	[License2No] [varchar](256) NULL,
	[License3No] [varchar](256) NULL,
	[License1Date1] [date] NULL,
	[License2Date1] [date] NULL,
	[License3Date1] [date] NULL,
	[License1Date2] [date] NULL,
	[License2Date2] [date] NULL,
	[License3Date2] [date] NULL,
	[Ltnwhereabouts] [varchar](256) NULL,
	[LtnPurpose] [varchar](256) NULL,
	[LtnRentDuration] [varchar](256) NULL,
	[LtnRentype] [varchar](256) NULL,
	[LtnTermsOfPayment] [varchar](256) NULL,
	[IsRounded] [bit] NULL,
	[Leave] [bit] NULL,
	[LeaveDate] [date] NULL,
	[AcquittancePrinted] [bit] NULL,
	[AcquittancePrintDate] [date] NULL,
	[AcquittancePrintedByGuid] [uniqueidentifier] NULL,
	[Judicial] [bit] NULL,
	[Trademark] [varchar](256) NULL,
	[PrvContractGuid] [uniqueidentifier] NULL,
	[AddPercent] [float] NULL,
	[AddValue] [float] NULL,
PRIMARY KEY CLUSTERED 
(
	[Guid] ASC
)WITH (PAD_INDEX = OFF, STATISTICS_NORECOMPUTE = OFF, IGNORE_DUP_KEY = OFF, ALLOW_ROW_LOCKS = ON, ALLOW_PAGE_LOCKS = ON, OPTIMIZE_FOR_SEQUENTIAL_KEY = OFF) ON [PRIMARY]
) ON [PRIMARY]
GO
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE TABLE [dbo].[LandContractCachPayment](
	[ContractGuid] [uniqueidentifier] NULL,
	[EntryGuid] [uniqueidentifier] NULL
) ON [PRIMARY]
GO
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE TABLE [dbo].[LandContractFee](
	[Number] [int] NOT NULL IDENTITY(1,1),
	[EntryNumber] [int] NULL,
	[Guid] [uniqueidentifier] NOT NULL,
	[ParentGuid] [uniqueidentifier] NULL,
	[Date] [date] NULL,
	[AccountGuid] [uniqueidentifier] NULL,
	[Value] [float] NULL,
	[CreateEntry] [bit] NULL,
	[Note] [varchar](255) NULL,
PRIMARY KEY CLUSTERED 
(
	[Guid] ASC
)WITH (PAD_INDEX = OFF, STATISTICS_NORECOMPUTE = OFF, IGNORE_DUP_KEY = OFF, ALLOW_ROW_LOCKS = ON, ALLOW_PAGE_LOCKS = ON, OPTIMIZE_FOR_SEQUENTIAL_KEY = OFF) ON [PRIMARY]
) ON [PRIMARY]
GO
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE TABLE [dbo].[LandContractReceiptNO](
	[Number] [int] NOT NULL IDENTITY(1,1),
	[Guid] [uniqueidentifier] NOT NULL,
	[SecLvl] [int] NULL,
	[ParentGuid] [uniqueidentifier] NULL,
	[No] [varchar](256) NULL,
	[Date] [date] NULL,
	[Note] [varchar](256) NULL,
PRIMARY KEY CLUSTERED 
(
	[Guid] ASC
)WITH (PAD_INDEX = OFF, STATISTICS_NORECOMPUTE = OFF, IGNORE_DUP_KEY = OFF, ALLOW_ROW_LOCKS = ON, ALLOW_PAGE_LOCKS = ON, OPTIMIZE_FOR_SEQUENTIAL_KEY = OFF) ON [PRIMARY]
) ON [PRIMARY]
GO
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE TABLE [dbo].[LandOffer](
	[Number] [int] NOT NULL IDENTITY(1,1),
	[Guid] [uniqueidentifier] NOT NULL,
	[SecLvl] [int] NULL,
	[LandNo] [varchar](256) NULL,
	[Name] [varchar](256) NULL,
	[ltnName] [varchar](256) NULL,
	[Customer] [varchar](256) NULL,
	[Address] [varchar](256) NULL,
	[OfferKind] [int] NULL,
	[OfferValue] [float] NULL,
	[City] [varchar](256) NULL,
	[Region] [varchar](256) NULL,
	[Space] [varchar](256) NULL,
	[Area] [float] NULL,
	[Unity] [varchar](256) NULL,
	[license] [varchar](256) NULL,
	[Details] [varchar](256) NULL,
	[LandType] [varchar](256) NULL,
	[Side] [varchar](256) NULL,
	[StreetCount] [int] NULL,
	[Buildble] [bit] NULL,
	[Delegated] [varchar](256) NULL,
	[CustPhone] [varchar](256) NULL,
	[CustMobile] [varchar](256) NULL,
	[MaxOfferValue] [float] NULL,
PRIMARY KEY CLUSTERED 
(
	[Guid] ASC
)WITH (PAD_INDEX = OFF, STATISTICS_NORECOMPUTE = OFF, IGNORE_DUP_KEY = OFF, ALLOW_ROW_LOCKS = ON, ALLOW_PAGE_LOCKS = ON, OPTIMIZE_FOR_SEQUENTIAL_KEY = OFF) ON [PRIMARY]
) ON [PRIMARY]
GO
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE TABLE [dbo].[Landwallet](
	[Number] [int] NOT NULL IDENTITY(1,1),
	[ParentGuid] [uniqueidentifier] NULL,
	[LandGuid] [uniqueidentifier] NULL,
	[MainCost] [float] NULL,
	[Expense] [float] NULL,
	[BeginDate] [date] NULL,
	[SaleDate] [date] NULL,
	[SaleValue] [float] NULL
) ON [PRIMARY]
GO
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE TABLE [dbo].[LastLoginUser](
	[UserName] [varchar](256) NULL,
	[HostName] [varchar](256) NULL,
	[Date] [date] NULL
) ON [PRIMARY]
GO
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE TABLE [dbo].[Lawsuit](
	[Number] [int] NOT NULL IDENTITY(1,1),
	[Guid] [uniqueidentifier] NOT NULL,
	[SecLvl] [int] NULL,
	[ContractGuid] [uniqueidentifier] NULL,
	[StartDate] [date] NULL,
	[No] [varchar](256) NULL,
	[OpenDate] [date] NULL,
	[ExecDate] [date] NULL,
	[StopExec] [bit] NULL,
	[StopExecDate] [date] NULL,
	[StopExecNote] [varchar](256) NULL,
	[StopPayDate] [date] NULL,
	[QuittanceDate] [date] NULL,
	[QuittanceElectricityDate] [date] NULL,
	[Rent] [float] NULL,
	[IsEnded] [bit] NULL,
	[EndDate] [date] NULL,
	[ExeNo] [varchar](256) NULL,
	[CurrencyGUID] [uniqueidentifier] NULL,
	[CurrencyVal] [float] NULL,
	[LawyerRent] [float] NULL,
	[LawyerRentDate] [date] NULL,
	[LawyerEntry] [bit] NULL,
	[LawyerDebitAccountGuid] [uniqueidentifier] NULL,
	[LawyerCreditAccountGuid] [uniqueidentifier] NULL,
	[LawyerNote] [varchar](256) NULL,
	[maintenanceRent] [float] NULL,
	[maintenanceRentDate] [date] NULL,
	[maintenanceEntry] [bit] NULL,
	[maintenanceDebitAccountGuid] [uniqueidentifier] NULL,
	[maintenanceCreditAccountGuid] [uniqueidentifier] NULL,
	[maintenanceNote] [varchar](256) NULL,
	[Furniture] [float] NULL,
	[FurnitureDate] [date] NULL,
	[FurnitureEntry] [bit] NULL,
	[FurnitureDebitAccountGuid] [uniqueidentifier] NULL,
	[FurnitureCreditAccountGuid] [uniqueidentifier] NULL,
	[FurnitureNote] [varchar](256) NULL,
	[Note] [varchar](256) NULL,
	[EntryGuid1] [uniqueidentifier] NULL,
	[EntryGuid2] [uniqueidentifier] NULL,
	[EntryGuid3] [uniqueidentifier] NULL,
PRIMARY KEY CLUSTERED 
(
	[Guid] ASC
)WITH (PAD_INDEX = OFF, STATISTICS_NORECOMPUTE = OFF, IGNORE_DUP_KEY = OFF, ALLOW_ROW_LOCKS = ON, ALLOW_PAGE_LOCKS = ON, OPTIMIZE_FOR_SEQUENTIAL_KEY = OFF) ON [PRIMARY]
) ON [PRIMARY]
GO
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE TABLE [dbo].[LawsuitExpense](
	[Number] [int] NOT NULL IDENTITY(1,1),
	[Guid] [uniqueidentifier] NOT NULL,
	[SecLvl] [int] NULL,
	[ParentGuid] [uniqueidentifier] NULL,
	[CreateEntry] [bit] NULL,
	[EntryDate] [date] NULL,
	[CustRecovery] [bit] NULL,
	[ReceiptNo] [varchar](256) NULL,
	[ReceiptDate] [date] NULL,
	[ReceiptValue] [float] NULL,
	[CurrencyGUID] [uniqueidentifier] NULL,
	[CurrencyVal] [float] NULL,
	[Reference] [varchar](256) NULL,
	[ReceiptNote] [varchar](256) NULL,
	[DebitAccountGuid] [uniqueidentifier] NULL,
	[CreditAccountGuid] [uniqueidentifier] NULL,
	[DebitCostGuid] [uniqueidentifier] NULL,
	[CreditCostGuid] [uniqueidentifier] NULL,
	[DebitNote] [varchar](256) NULL,
	[CreditNote] [varchar](256) NULL,
	[UserGuid] [uniqueidentifier] NULL,
	[Note] [varchar](256) NULL,
	[OneNote] [bit] NULL,
	[IsRounded] [bit] NULL,
PRIMARY KEY CLUSTERED 
(
	[Guid] ASC
)WITH (PAD_INDEX = OFF, STATISTICS_NORECOMPUTE = OFF, IGNORE_DUP_KEY = OFF, ALLOW_ROW_LOCKS = ON, ALLOW_PAGE_LOCKS = ON, OPTIMIZE_FOR_SEQUENTIAL_KEY = OFF) ON [PRIMARY]
) ON [PRIMARY]
GO
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE TABLE [dbo].[LawsuitState](
	[Number] [int] NOT NULL IDENTITY(1,1),
	[Guid] [uniqueidentifier] NOT NULL,
	[SecLvl] [int] NULL,
	[ParentGuid] [uniqueidentifier] NULL,
	[State] [varchar](256) NULL,
	[Date] [date] NULL,
	[UserGuid] [uniqueidentifier] NULL,
	[Note] [varchar](256) NULL,
PRIMARY KEY CLUSTERED 
(
	[Guid] ASC
)WITH (PAD_INDEX = OFF, STATISTICS_NORECOMPUTE = OFF, IGNORE_DUP_KEY = OFF, ALLOW_ROW_LOCKS = ON, ALLOW_PAGE_LOCKS = ON, OPTIMIZE_FOR_SEQUENTIAL_KEY = OFF) ON [PRIMARY]
) ON [PRIMARY]
GO
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE TABLE [dbo].[LeaseApartment](
	[Number] [int] NOT NULL IDENTITY(1,1),
	[Guid] [uniqueidentifier] NOT NULL,
	[SecLvl] [int] NULL,
	[EditDate] [date] NULL,
	[DeliverDate] [date] NULL,
	[Mark] [bit] NULL,
	[TypeGuid] [uniqueidentifier] NULL,
	[ContractNo] [varchar](256) NULL,
	[IsAutoRenewal] [bit] NULL,
	[CustomerGuid] [uniqueidentifier] NULL,
	[RentInfoGuid] [uniqueidentifier] NULL,
	[SalesManGuid] [uniqueidentifier] NULL,
	[BuildingGuid] [uniqueidentifier] NULL,
	[ApartmentGuid] [uniqueidentifier] NULL,
	[ApartmentType] [varchar](256) NULL,
	[CostGuid] [uniqueidentifier] NULL,
	[FromDate] [date] NULL,
	[ToDate] [date] NULL,
	[Period] [int] NULL,
	[RentContractType] [int] NULL,
	[Rent] [float] NULL,
	[MonthlyValue] [float] NULL,
	[CurrencyGuid] [uniqueidentifier] NULL,
	[CurrencyVal] [float] NULL,
	[PayType] [int] NULL,
	[Note] [varchar](8000) NULL,
	[Note2] [varchar](8000) NULL,
	[Trademark] [varchar](256) NULL,
	[Purpose] [varchar](256) NULL,
	[Whereabouts] [varchar](256) NULL,
	[LeaseKind] [int] NULL,
	[RevenueAccountGuid] [uniqueidentifier] NULL,
	[CustAccountGuid] [uniqueidentifier] NULL,
	[CommissionFromCustPercent] [float] NULL,
	[CommissionFromCustValue] [float] NULL,
	[AcCommissionFromCustGuid] [uniqueidentifier] NULL,
	[AcCommissionFromCustNote] [varchar](256) NULL,
	[CommissionFromOwnerPercent] [float] NULL,
	[CommissionFromOwnerValue] [float] NULL,
	[AcCommissionFromOwnerGuid] [uniqueidentifier] NULL,
	[AcCommissionFromOwnerNote] [varchar](256) NULL,
	[CommissionFromSalesManrPercent] [float] NULL,
	[CommissionFromSalesManValue] [float] NULL,
	[AcSalesManCommissionGuid] [uniqueidentifier] NULL,
	[AcCommissionExpenseGuid] [uniqueidentifier] NULL,
	[SalesManCommNote] [varchar](256) NULL,
	[CreateContractEntry] [bit] NULL,
	[ContractFinish] [bit] NULL,
	[ContractFinishDate] [date] NULL,
	[EditContractFinishDate] [date] NULL,
	[ResultingAmount] [float] NULL,
	[ResultingAmount2] [float] NULL,
	[RoundKind] [int] NULL,
	[ResultingNote] [varchar](256) NULL,
	[Fine] [float] NULL,
	[FineAccount] [uniqueidentifier] NULL,
	[CreateResultingEntry] [bit] NULL,
	[FineNote] [varchar](256) NULL,
	[InsuranceValuePercent] [float] NULL,
	[InsuranceValue] [float] NULL,
	[InsuranceAccountGuid] [uniqueidentifier] NULL,
	[InsuranceValueOld] [float] NULL,
	[ContractPrice] [float] NULL,
	[AccountContractPrice] [uniqueidentifier] NULL,
	[CertificatValue] [float] NULL,
	[AccountCertificatValue] [uniqueidentifier] NULL,
	[AcIncomNextYearGUID] [uniqueidentifier] NULL,
	[RentDuration] [varchar](256) NULL,
	[Rentype] [varchar](256) NULL,
	[TermsOfPayment] [varchar](256) NULL,
	[ResidentCount] [int] NULL,
	[ElectricityInsurance] [float] NULL,
	[Step1Complete] [bit] NULL,
	[Step2Complete] [bit] NULL,
	[Step3Complete] [bit] NULL,
	[Step4Complete] [bit] NULL,
	[Step5Complete] [bit] NULL,
	[Certification] [varchar](256) NULL,
	[DiscountPercent] [float] NULL,
	[DiscountValue] [float] NULL,
	[DiscountAccountGuid] [uniqueidentifier] NULL,
	[UserGuid] [uniqueidentifier] NULL,
	[BranchGuid] [uniqueidentifier] NULL,
	[ElectricityCounter] [float] NULL,
	[FineRevenueAccountGUID] [uniqueidentifier] NULL,
	[NewState] [int] NULL,
	[OtherFee] [float] NULL,
	[OtherFeeAccountGUID] [uniqueidentifier] NULL,
	[License1No] [varchar](256) NULL,
	[License2No] [varchar](256) NULL,
	[License3No] [varchar](256) NULL,
	[License1Date1] [date] NULL,
	[License2Date1] [date] NULL,
	[License3Date1] [date] NULL,
	[License1Date2] [date] NULL,
	[License2Date2] [date] NULL,
	[License3Date2] [date] NULL,
	[Ltnwhereabouts] [varchar](256) NULL,
	[LtnPurpose] [varchar](256) NULL,
	[LtnRentDuration] [varchar](256) NULL,
	[LtnRentype] [varchar](256) NULL,
	[LtnTermsOfPayment] [varchar](256) NULL,
	[IsRounded] [bit] NULL,
	[Leave] [bit] NULL,
	[LeaveDate] [date] NULL,
	[CountOldContract] [int] NULL,
	[CountCurrentContract] [int] NULL,
	[AcquittancePrinted] [bit] NULL,
	[AcquittancePrintDate] [date] NULL,
	[AcquittancePrintedByGuid] [uniqueidentifier] NULL,
	[Judicial] [bit] NULL,
	[IsReturnInsurance] [bit] NULL,
	[ReturnInsuranceDate] [date] NULL,
	[PrvContractGuid] [uniqueidentifier] NULL,
	[AddPercent] [float] NULL,
	[AddValue] [float] NULL,
PRIMARY KEY CLUSTERED 
(
	[Guid] ASC
)WITH (PAD_INDEX = OFF, STATISTICS_NORECOMPUTE = OFF, IGNORE_DUP_KEY = OFF, ALLOW_ROW_LOCKS = ON, ALLOW_PAGE_LOCKS = ON, OPTIMIZE_FOR_SEQUENTIAL_KEY = OFF) ON [PRIMARY]
) ON [PRIMARY]
GO
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE TABLE [dbo].[LinkCe](
	[Guid] [uniqueidentifier] NULL,
	[CeGuid] [uniqueidentifier] NULL,
	[Kind] [int] NULL
) ON [PRIMARY]
GO
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE TABLE [dbo].[LinkCheckContract](
	[Number] [int] NOT NULL IDENTITY(1,1),
	[ParentGuid] [uniqueidentifier] NULL,
	[Kind] [int] NULL,
	[ContractGuid] [uniqueidentifier] NULL,
	[Percent] [float] NULL,
	[Value] [float] NULL,
	[Note] [varchar](255) NULL
) ON [PRIMARY]
GO
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE TABLE [dbo].[LinkEntry_Checks](
	[CheckGuid] [uniqueidentifier] NULL,
	[EntryGuid] [uniqueidentifier] NULL,
	[EntryNum] [int] NULL,
	[Kind] [int] NULL
) ON [PRIMARY]
GO
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE TABLE [dbo].[LinkEntryType_Checks](
	[CheckGuid] [uniqueidentifier] NULL,
	[EntryGuid] [uniqueidentifier] NULL,
	[EntryNum] [int] NULL,
	[Kind] [int] NULL
) ON [PRIMARY]
GO
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE TABLE [dbo].[LinkParkingContract](
	[Number] [int] NOT NULL IDENTITY(1,1),
	[ParentGuid] [uniqueidentifier] NULL,
	[ParkingContractGuid] [uniqueidentifier] NULL
) ON [PRIMARY]
GO
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE TABLE [dbo].[ListOrderTypeGroups](
	[Spid] [int] NULL,
	[GroupGuid] [uniqueidentifier] NULL,
	[OrderTypeGuid] [uniqueidentifier] NULL
) ON [PRIMARY]
GO
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE TABLE [dbo].[LockCard](
	[IdCard] [int] NULL,
	[CardGuid] [uniqueidentifier] NULL,
	[ComputerName] [varchar](50) NULL
) ON [PRIMARY]
GO
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE TABLE [dbo].[LogFile](
	[Id] [int] IDENTITY(1,1) NOT NULL,
	[Username] [varchar](50) NULL,
	[UserGuid] [uniqueidentifier] NULL,
	[ComputerName] [varchar](50) NULL,
	[CardId] [int] NULL,
	[ODate] [date] NULL,
	[Opration] [varchar](100) NULL,
	[Note] [varchar](250) NULL
) ON [PRIMARY]
GO
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE TABLE [dbo].[MaintenanceContract](
	[Number] [int] NOT NULL IDENTITY(1,1),
	[Guid] [uniqueidentifier] NOT NULL,
	[SecLvl] [int] NULL,
	[EditDate] [date] NULL,
	[Mark] [bit] NULL,
	[TypeGuid] [uniqueidentifier] NULL,
	[ContractNo] [varchar](256) NULL,
	[CustomerGuid] [uniqueidentifier] NULL,
	[BuildingGuid] [uniqueidentifier] NULL,
	[CostGuid] [uniqueidentifier] NULL,
	[FromDate] [date] NULL,
	[ToDate] [date] NULL,
	[Period] [int] NULL,
	[PeriodType] [int] NULL,
	[Rent] [float] NULL,
	[MonthlyValue] [float] NULL,
	[CurrencyGuid] [uniqueidentifier] NULL,
	[CurrencyVal] [float] NULL,
	[PayType] [int] NULL,
	[Note] [varchar](8000) NULL,
	[Note2] [varchar](8000) NULL,
	[Trademark] [varchar](256) NULL,
	[Purpose] [varchar](256) NULL,
	[Whereabouts] [varchar](256) NULL,
	[IncomeAccountGUID] [uniqueidentifier] NULL,
	[CustAccountGuid] [uniqueidentifier] NULL,
	[CreateContractEntry] [bit] NULL,
	[ContractFinish] [bit] NULL,
	[ContractFinishDate] [date] NULL,
	[ResultingAmount] [float] NULL,
	[ResultingAmount2] [float] NULL,
	[RoundKind] [int] NULL,
	[ResultingNote] [varchar](256) NULL,
	[CreateResultingEntry] [bit] NULL,
	[RentDuration] [varchar](256) NULL,
	[Rentype] [varchar](256) NULL,
	[TermsOfPayment] [varchar](256) NULL,
	[DiscountPercent] [float] NULL,
	[DiscountValue] [float] NULL,
	[DiscountAccountGuid] [uniqueidentifier] NULL,
	[UserGuid] [uniqueidentifier] NULL,
	[BranchGuid] [uniqueidentifier] NULL,
	[FineExpenceAccountGUID] [uniqueidentifier] NULL,
	[NewState] [int] NULL,
	[OtherFee] [float] NULL,
	[OtherFeeAccountGUID] [uniqueidentifier] NULL,
	[License1No] [varchar](256) NULL,
	[License2No] [varchar](256) NULL,
	[License3No] [varchar](256) NULL,
	[License1Date1] [date] NULL,
	[License2Date1] [date] NULL,
	[License3Date1] [date] NULL,
	[License1Date2] [date] NULL,
	[License2Date2] [date] NULL,
	[License3Date2] [date] NULL,
	[Ltnwhereabouts] [varchar](256) NULL,
	[LtnPurpose] [varchar](256) NULL,
	[LtnRentDuration] [varchar](256) NULL,
	[LtnRentype] [varchar](256) NULL,
	[LtnTermsOfPayment] [varchar](256) NULL,
	[IsRounded] [bit] NULL,
	[CountOldContract] [int] NULL,
	[AcquittancePrinted] [bit] NULL,
	[AcquittancePrintDate] [date] NULL,
	[AcquittancePrintedByGuid] [uniqueidentifier] NULL,
PRIMARY KEY CLUSTERED 
(
	[Guid] ASC
)WITH (PAD_INDEX = OFF, STATISTICS_NORECOMPUTE = OFF, IGNORE_DUP_KEY = OFF, ALLOW_ROW_LOCKS = ON, ALLOW_PAGE_LOCKS = ON, OPTIMIZE_FOR_SEQUENTIAL_KEY = OFF) ON [PRIMARY]
) ON [PRIMARY]
GO
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE TABLE [dbo].[MaintenanceContractCachPayment](
	[ContractGuid] [uniqueidentifier] NULL,
	[EntryGuid] [uniqueidentifier] NULL
) ON [PRIMARY]
GO
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE TABLE [dbo].[MaintenanceContractMaintenanceItem](
	[Number] [int] NOT NULL IDENTITY(1,1),
	[ContractGuid] [uniqueidentifier] NULL,
	[MaintenanceItemGuid] [uniqueidentifier] NULL,
	[Value] [float] NULL,
	[Note] [varchar](255) NULL
) ON [PRIMARY]
GO
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE TABLE [dbo].[MaintenanceContractType](
	[Number] [int] NOT NULL IDENTITY(1,1),
	[Guid] [uniqueidentifier] NOT NULL,
	[SecLvl] [int] NULL,
	[Code] [varchar](256) NULL,
	[Name] [varchar](256) NULL,
	[ltnName] [varchar](256) NULL,
	[Menu] [varchar](256) NULL,
	[LtnMenu] [varchar](256) NULL,
	[ShortCut] [varchar](256) NULL,
	[IncomeAccountGUID] [uniqueidentifier] NULL,
	[DiscountAccountGUID] [uniqueidentifier] NULL,
	[Rentcondition] [varchar](2048) NULL,
	[DefPrintPath] [varchar](256) NULL,
	[CreateEntry] [bit] NULL,
	[AutoCreateEntry] [bit] NULL,
	[AutoPostedEntry] [bit] NULL,
	[EntryDate] [int] NULL,
	[MoveCostWithExpenceDebit] [bit] NULL,
	[MoveCostWithExpenceCredit] [bit] NULL,
	[MoveCostWithDiscountDebit] [bit] NULL,
	[MoveCostWithDiscountCredit] [bit] NULL,
	[DefPrintReceipt] [varchar](256) NULL,
	[DefPrintLogPath] [varchar](256) NULL,
	[DefPrintacquittance] [varchar](256) NULL,
	[FirstPayNote] [varchar](255) NULL,
	[FirstPayNoteLtn] [varchar](255) NULL,
	[ContractNote] [varchar](255) NULL,
	[ContractNoteLtn] [varchar](255) NULL,
PRIMARY KEY CLUSTERED 
(
	[Guid] ASC
)WITH (PAD_INDEX = OFF, STATISTICS_NORECOMPUTE = OFF, IGNORE_DUP_KEY = OFF, ALLOW_ROW_LOCKS = ON, ALLOW_PAGE_LOCKS = ON, OPTIMIZE_FOR_SEQUENTIAL_KEY = OFF) ON [PRIMARY]
) ON [PRIMARY]
GO
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE TABLE [dbo].[MaintenanceContractTypePrivilege](
	[UserGuid] [uniqueidentifier] NULL,
	[ContractTypeGuid] [uniqueidentifier] NULL,
	[Open] [bit] NULL,
	[Add] [bit] NULL,
	[Edit] [bit] NULL,
	[Del] [bit] NULL,
	[Mark] [bit] NULL,
	[MarkEdit] [bit] NULL,
	[MarkDel] [bit] NULL,
	[ShowMark] [bit] NULL,
	[Print] [bit] NULL,
	[Design] [bit] NULL,
	[Field7] [bit] NULL,
	[Field8] [bit] NULL,
	[Field9] [bit] NULL,
	[Field10] [bit] NULL,
	[Field11] [bit] NULL,
	[Field12] [bit] NULL,
	[Field13] [bit] NULL,
	[Field14] [bit] NULL,
	[Field15] [bit] NULL,
	[Field16] [bit] NULL,
	[Field17] [bit] NULL,
	[Field18] [bit] NULL,
	[Field19] [bit] NULL,
	[Field20] [bit] NULL,
	[Field21] [bit] NULL,
	[MaxDiscount] [float] NULL
) ON [PRIMARY]
GO
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE TABLE [dbo].[MaintenanceContractVisit](
	[Number] [int] NOT NULL IDENTITY(1,1),
	[Guid] [uniqueidentifier] NOT NULL,
	[SecLvl] [int] NULL,
	[WithOutContract] [bit] NULL,
	[ContractGuid] [uniqueidentifier] NULL,
	[CustGuid] [uniqueidentifier] NULL,
	[No] [varchar](255) NULL,
	[Date] [date] NULL,
	[ExecState] [int] NULL,
	[ExecDate] [date] NULL,
	[MaintenanceWorkerGuid] [uniqueidentifier] NULL,
	[FeeAccountGuid] [uniqueidentifier] NULL,
	[ExecNote] [varchar](max) NULL,
	[NotExecNote] [varchar](max) NULL,
	[WorkNote] [varchar](max) NULL,
	[CreateEntry] [bit] NULL,
	[CurrencyGuid] [uniqueidentifier] NULL,
	[CurrencyVal] [float] NULL,
	[EntryDebitCostGuid] [uniqueidentifier] NULL,
	[EntryCreditCostGuid] [uniqueidentifier] NULL,
	[EntryNote] [varchar](255) NULL,
	[Note] [varchar](255) NULL,
PRIMARY KEY CLUSTERED 
(
	[Guid] ASC
)WITH (PAD_INDEX = OFF, STATISTICS_NORECOMPUTE = OFF, IGNORE_DUP_KEY = OFF, ALLOW_ROW_LOCKS = ON, ALLOW_PAGE_LOCKS = ON, OPTIMIZE_FOR_SEQUENTIAL_KEY = OFF) ON [PRIMARY]
) ON [PRIMARY] TEXTIMAGE_ON [PRIMARY]
GO
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE TABLE [dbo].[MaintenanceContractVisitRealty](
	[Number] [int] NOT NULL IDENTITY(1,1),
	[ParentGuid] [uniqueidentifier] NULL,
	[RealtyGuid] [uniqueidentifier] NULL,
	[Note] [varchar](255) NULL
) ON [PRIMARY]
GO
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE TABLE [dbo].[MaintenanceContractVisitWorker](
	[Number] [int] NOT NULL IDENTITY(1,1),
	[ParentGuid] [uniqueidentifier] NULL,
	[HourCount] [float] NULL,
	[Fee] [float] NULL,
	[WorkerGuid] [uniqueidentifier] NULL,
	[Note] [varchar](255) NULL
) ON [PRIMARY]
GO
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE TABLE [dbo].[MaintenanceItem](
	[Number] [int] NOT NULL IDENTITY(1,1),
	[Guid] [uniqueidentifier] NOT NULL,
	[SecLvl] [int] NULL,
	[Name] [varchar](255) NULL,
	[LtnName] [varchar](255) NULL,
	[DefValue] [float] NULL,
	[Note] [varchar](255) NULL,
PRIMARY KEY CLUSTERED 
(
	[Guid] ASC
)WITH (PAD_INDEX = OFF, STATISTICS_NORECOMPUTE = OFF, IGNORE_DUP_KEY = OFF, ALLOW_ROW_LOCKS = ON, ALLOW_PAGE_LOCKS = ON, OPTIMIZE_FOR_SEQUENTIAL_KEY = OFF) ON [PRIMARY]
) ON [PRIMARY]
GO
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE TABLE [dbo].[MaintenanceOrder](
	[Number] [int] NOT NULL IDENTITY(1,1),
	[Guid] [uniqueidentifier] NOT NULL,
	[SecLvl] [int] NULL,
	[No] [varchar](256) NULL,
	[ComplaintGuid] [uniqueidentifier] NULL,
	[MaintenanceWorkerGuid] [uniqueidentifier] NULL,
	[WorkKInd] [varchar](256) NULL,
	[StartDate] [date] NULL,
	[EndExpectedDate] [date] NULL,
	[CloseDate] [date] NULL,
	[OrderState] [int] NULL,
	[ReasonNotRealized] [varchar](256) NULL,
	[Convertto] [varchar](256) NULL,
	[ConvertNote] [varchar](256) NULL,
	[Realized] [varchar](256) NULL,
	[Mat] [varchar](256) NULL,
	[Reason] [varchar](256) NULL,
	[repitition] [int] NULL,
	[delay] [int] NULL,
	[DelayReason] [varchar](256) NULL,
	[CreateEntry] [bit] NULL,
	[EntryDate] [date] NULL,
	[EntryValue] [float] NULL,
	[EntryCurrencyGUID] [uniqueidentifier] NULL,
	[EntryCurrencyVal] [float] NULL,
	[DebitAccountGuid] [uniqueidentifier] NULL,
	[CreditAccountGuid] [uniqueidentifier] NULL,
	[DebitCostGuid] [uniqueidentifier] NULL,
	[CreditCostGuid] [uniqueidentifier] NULL,
	[EntryNote] [varchar](255) NULL,
	[Note2] [varchar](255) NULL,
PRIMARY KEY CLUSTERED 
(
	[Guid] ASC
)WITH (PAD_INDEX = OFF, STATISTICS_NORECOMPUTE = OFF, IGNORE_DUP_KEY = OFF, ALLOW_ROW_LOCKS = ON, ALLOW_PAGE_LOCKS = ON, OPTIMIZE_FOR_SEQUENTIAL_KEY = OFF) ON [PRIMARY]
) ON [PRIMARY]
GO
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE TABLE [dbo].[MaintenanceWorker](
	[Number] [int] NOT NULL IDENTITY(1,1),
	[Guid] [uniqueidentifier] NOT NULL,
	[SecLvl] [int] NULL,
	[Name] [varchar](256) NULL,
	[LtnName] [varchar](256) NULL,
	[BirthDate] [date] NULL,
	[PassportNO] [varchar](256) NULL,
	[PassportExpireDate] [date] NULL,
	[StayExpireDate] [date] NULL,
	[PersonalityNo1] [varchar](256) NULL,
	[PersonalityNo2] [varchar](256) NULL,
	[Profession] [varchar](256) NULL,
	[Address] [varchar](256) NULL,
	[Phone] [varchar](256) NULL,
	[Mobile] [varchar](256) NULL,
	[Nationality] [varchar](256) NULL,
	[LtnNationality] [varchar](256) NULL,
	[Security] [varchar](256) NULL,
	[MemoSecurity] [varchar](256) NULL,
	[Domicile] [varchar](256) NULL,
	[AccountGuid] [uniqueidentifier] NULL,
	[Note] [varchar](256) NULL,
PRIMARY KEY CLUSTERED 
(
	[Guid] ASC
)WITH (PAD_INDEX = OFF, STATISTICS_NORECOMPUTE = OFF, IGNORE_DUP_KEY = OFF, ALLOW_ROW_LOCKS = ON, ALLOW_PAGE_LOCKS = ON, OPTIMIZE_FOR_SEQUENTIAL_KEY = OFF) ON [PRIMARY],
 CONSTRAINT [UK_MaintenanceWorker_Name_UNIQUE] UNIQUE NONCLUSTERED 
(
	[Name] ASC
)WITH (PAD_INDEX = OFF, STATISTICS_NORECOMPUTE = OFF, IGNORE_DUP_KEY = OFF, ALLOW_ROW_LOCKS = ON, ALLOW_PAGE_LOCKS = ON, OPTIMIZE_FOR_SEQUENTIAL_KEY = OFF) ON [PRIMARY]
) ON [PRIMARY]
GO
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE TABLE [dbo].[MapsConfig](
	[Number] [int] NOT NULL IDENTITY(1,1),
	[Guid] [uniqueidentifier] NOT NULL,
	[SecLvl] [int] NULL,
	[Country] [varchar](256) NULL,
	[City] [varchar](256) NULL,
	[Map1] [varchar](256) NULL,
	[Map2] [varchar](256) NULL,
	[Map3] [varchar](256) NULL,
PRIMARY KEY CLUSTERED 
(
	[Guid] ASC
)WITH (PAD_INDEX = OFF, STATISTICS_NORECOMPUTE = OFF, IGNORE_DUP_KEY = OFF, ALLOW_ROW_LOCKS = ON, ALLOW_PAGE_LOCKS = ON, OPTIMIZE_FOR_SEQUENTIAL_KEY = OFF) ON [PRIMARY]
) ON [PRIMARY]
GO
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE TABLE [dbo].[MapsObject](
	[Guid] [uniqueidentifier] NOT NULL,
	[MapGuid] [uniqueidentifier] NULL,
	[X] [int] NULL,
	[Y] [int] NULL,
	[Kind] [int] NULL,
	[BuildingGuid] [uniqueidentifier] NULL,
	[LandGuid] [uniqueidentifier] NULL,
	[VillaGuid] [uniqueidentifier] NULL,
	[Note] [varchar](256) NULL,
PRIMARY KEY CLUSTERED 
(
	[Guid] ASC
)WITH (PAD_INDEX = OFF, STATISTICS_NORECOMPUTE = OFF, IGNORE_DUP_KEY = OFF, ALLOW_ROW_LOCKS = ON, ALLOW_PAGE_LOCKS = ON, OPTIMIZE_FOR_SEQUENTIAL_KEY = OFF) ON [PRIMARY]
) ON [PRIMARY]
GO
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE TABLE [dbo].[Mat](
	[Number] [int] NOT NULL IDENTITY(1,1),
	[Guid] [uniqueidentifier] NOT NULL,
	[SecLvl] [int] NULL,
	[Code] [varchar](256) NULL,
	[Name] [varchar](256) NULL,
	[LtnName] [varchar](256) NULL,
	[Unity1] [varchar](256) NULL,
	[Unity2] [varchar](256) NULL,
	[Unity3] [varchar](256) NULL,
	[Barcode1] [varchar](256) NULL,
	[Barcode2] [varchar](256) NULL,
	[Barcode3] [varchar](256) NULL,
	[DefUnity] [int] NULL,
	[unityFact2] [float] NULL,
	[unityFact3] [float] NULL,
	[unityfix2] [bit] NULL,
	[unityfix3] [bit] NULL,
	[Note] [varchar](256) NULL,
	[GroupGuid] [uniqueidentifier] NULL,
	[MatType] [int] NULL,
	[CurrencyGuid] [uniqueidentifier] NULL,
	[CurrencyVal] [float] NULL,
	[AvgPrice] [float] NULL,
	[LastPriceDate] [date] NULL,
	[LastPrice] [float] NULL,
	[MaxPrice] [float] NULL,
	[SaleAvgPrice] [float] NULL,
	[SaleLastPriceDate] [date] NULL,
	[SaleLastPrice] [float] NULL,
	[SaleMaxPrice] [float] NULL,
PRIMARY KEY CLUSTERED 
(
	[Guid] ASC
)WITH (PAD_INDEX = OFF, STATISTICS_NORECOMPUTE = OFF, IGNORE_DUP_KEY = OFF, ALLOW_ROW_LOCKS = ON, ALLOW_PAGE_LOCKS = ON, OPTIMIZE_FOR_SEQUENTIAL_KEY = OFF) ON [PRIMARY]
) ON [PRIMARY]
GO
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE TABLE [dbo].[MatBalance](
	[ParentGuid] [uniqueidentifier] NULL,
	[StoreGuid] [uniqueidentifier] NULL,
	[Qty] [float] NULL,
	[Qty2] [float] NULL,
	[Qty3] [float] NULL,
	[Note] [varchar](256) NULL
) ON [PRIMARY]
GO
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE TABLE [dbo].[MatDescription](
	[Number] [int] NOT NULL IDENTITY(1,1),
	[MatGuid] [uniqueidentifier] NULL,
	[Name] [varchar](256) NULL,
	[Value] [varchar](256) NULL,
	[Note] [varchar](256) NULL
) ON [PRIMARY]
GO
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE TABLE [dbo].[MatDescriptionConfig](
	[Number] [int] NOT NULL IDENTITY(1,1),
	[Name] [varchar](256) NULL,
	[LtnName] [varchar](256) NULL,
	[Kind] [int] NULL
) ON [PRIMARY]
GO
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE TABLE [dbo].[MatGroup](
	[Number] [int] NOT NULL IDENTITY(1,1),
	[Guid] [uniqueidentifier] NOT NULL,
	[SecLvl] [int] NULL,
	[Code] [varchar](256) NULL,
	[Name] [varchar](256) NULL,
	[LtnName] [varchar](256) NULL,
	[Note] [varchar](256) NULL,
	[ParentGuid] [uniqueidentifier] NULL,
PRIMARY KEY CLUSTERED 
(
	[Guid] ASC
)WITH (PAD_INDEX = OFF, STATISTICS_NORECOMPUTE = OFF, IGNORE_DUP_KEY = OFF, ALLOW_ROW_LOCKS = ON, ALLOW_PAGE_LOCKS = ON, OPTIMIZE_FOR_SEQUENTIAL_KEY = OFF) ON [PRIMARY]
) ON [PRIMARY]
GO
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE TABLE [dbo].[MatMinMax](
	[Number] [int] NOT NULL IDENTITY(1,1),
	[ParentGuid] [uniqueidentifier] NULL,
	[StoreGuid] [uniqueidentifier] NULL,
	[Minimum] [float] NULL,
	[Maximum] [float] NULL,
	[Note] [varchar](256) NULL
) ON [PRIMARY]
GO
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE TABLE [dbo].[MatUnitsPrice](
	[Number] [int] NOT NULL IDENTITY(1,1),
	[MatGuid] [uniqueidentifier] NULL,
	[PriceKind] [varchar](256) NULL,
	[Price1] [float] NULL,
	[Price2] [float] NULL,
	[Price3] [float] NULL
) ON [PRIMARY]
GO
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE TABLE [dbo].[MenuPrivilege](
	[Number] [int] NOT NULL IDENTITY(1,1),
	[UserGuid] [uniqueidentifier] NULL,
	[MenuName] [varchar](256) NULL
) ON [PRIMARY]
GO
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE TABLE [dbo].[MovingAccount](
	[AccountGuid] [uniqueidentifier] NULL
) ON [PRIMARY]
GO
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE TABLE [dbo].[MsgTbl](
	[Guid] [uniqueidentifier] NULL,
	[Date] [date] NULL,
	[Msg] [varchar](256) NULL,
	[ToUserGuid] [uniqueidentifier] NULL,
	[FromUserGuid] [uniqueidentifier] NULL,
	[FlagSend] [bit] NULL
) ON [PRIMARY]
GO
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE TABLE [dbo].[OfferPrice](
	[Number] [int] NOT NULL IDENTITY(1,1),
	[Guid] [uniqueidentifier] NOT NULL,
	[SecLvl] [int] NULL,
	[Date] [date] NULL,
	[No] [varchar](256) NULL,
	[CustomerName] [varchar](256) NULL,
	[CustomerPhone] [varchar](256) NULL,
	[OfferKind] [int] NULL,
	[BuildingGuid] [uniqueidentifier] NULL,
	[RealtyGuid] [uniqueidentifier] NULL,
	[Price] [float] NULL,
	[DiscountPercent] [float] NULL,
	[DiscountValue] [float] NULL,
	[PriceAfterDiscount] [float] NULL,
	[CurrencyGUID] [uniqueidentifier] NULL,
	[CurrencyVal] [float] NULL,
	[FirstPay] [float] NULL,
	[FirstPayDate] [date] NULL,
	[InstCount] [int] NULL,
	[More] [int] NULL,
	[InstType] [int] NULL,
	[FirstinsDate] [date] NULL,
	[OneInstallment] [float] NULL,
	[LastPay] [float] NULL,
	[Details] [varchar](500) NULL,
	[Note] [varchar](255) NULL,
PRIMARY KEY CLUSTERED 
(
	[Guid] ASC
)WITH (PAD_INDEX = OFF, STATISTICS_NORECOMPUTE = OFF, IGNORE_DUP_KEY = OFF, ALLOW_ROW_LOCKS = ON, ALLOW_PAGE_LOCKS = ON, OPTIMIZE_FOR_SEQUENTIAL_KEY = OFF) ON [PRIMARY]
) ON [PRIMARY]
GO
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE TABLE [dbo].[OfferPriceFee](
	[Number] [int] NOT NULL IDENTITY(1,1),
	[ParentGuid] [uniqueidentifier] NULL,
	[Value] [float] NULL,
	[Note] [varchar](256) NULL
) ON [PRIMARY]
GO
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE TABLE [dbo].[OfferPriceIns](
	[Number] [int] NOT NULL IDENTITY(1,1),
	[ParentGuid] [uniqueidentifier] NULL,
	[DueDate] [date] NULL,
	[Value] [float] NULL,
	[Note] [varchar](256) NULL
) ON [PRIMARY]
GO
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE TABLE [dbo].[OldYearConfig](
	[Number] [int] NOT NULL IDENTITY(1,1),
	[dbName] [varchar](256) NULL,
	[BeginEntryNo] [varchar](256) NULL
) ON [PRIMARY]
GO
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE TABLE [dbo].[OnlyCheck](
	[Spid] [int] NULL,
	[Guid] [uniqueidentifier] NULL,
	[Only] [varchar](256) NULL,
	[LtnOnly] [varchar](256) NULL
) ON [PRIMARY]
GO
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE TABLE [dbo].[OrderCheckMatBalance_Tmp](
	[Spid] [int] NULL,
	[Number] [int] NOT NULL IDENTITY(1,1),
	[MatGuid] [uniqueidentifier] NULL,
	[StoreGuid] [uniqueidentifier] NULL,
	[Qty] [float] NULL,
	[unit] [int] NULL
) ON [PRIMARY]
GO
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE TABLE [dbo].[OrderType](
	[Number] [int] NOT NULL IDENTITY(1,1),
	[Guid] [uniqueidentifier] NOT NULL,
	[SecLvl] [int] NULL,
	[Name] [varchar](256) NULL,
	[LtnName] [varchar](256) NULL,
	[Menu] [varchar](256) NULL,
	[LtnMenu] [varchar](256) NULL,
	[ShortCut] [varchar](256) NULL,
	[DefStoreGuid] [uniqueidentifier] NULL,
	[DefCostGuid] [uniqueidentifier] NULL,
	[BillTypeGuid] [uniqueidentifier] NULL,
	[CurrencyGuid] [uniqueidentifier] NULL,
	[CurrencyVal] [float] NULL,
	[ChangeBillType] [bit] NULL,
	[ChangeCurrency] [bit] NULL,
	[CheckStore] [bit] NULL,
	[CheckStoreRecipient] [bit] NULL,
	[RestraintMat] [bit] NULL,
	[Note] [varchar](256) NULL,
	[DefUnity] [int] NULL,
PRIMARY KEY CLUSTERED 
(
	[Guid] ASC
)WITH (PAD_INDEX = OFF, STATISTICS_NORECOMPUTE = OFF, IGNORE_DUP_KEY = OFF, ALLOW_ROW_LOCKS = ON, ALLOW_PAGE_LOCKS = ON, OPTIMIZE_FOR_SEQUENTIAL_KEY = OFF) ON [PRIMARY]
) ON [PRIMARY]
GO
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE TABLE [dbo].[OrderTypeGroup](
	[Number] [int] NOT NULL IDENTITY(1,1),
	[ParentGuid] [uniqueidentifier] NULL,
	[GroupGuid] [uniqueidentifier] NULL
) ON [PRIMARY]
GO
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE TABLE [dbo].[OrderTypePrivilege](
	[UserGuid] [uniqueidentifier] NULL,
	[TypeGuid] [uniqueidentifier] NULL,
	[Open] [bit] NULL,
	[Add] [bit] NULL,
	[Edit] [bit] NULL,
	[Del] [bit] NULL,
	[Print] [bit] NULL,
	[Design] [bit] NULL,
	[CloseOrder] [bit] NULL
) ON [PRIMARY]
GO
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE TABLE [dbo].[Owner](
	[Number] [int] NOT NULL IDENTITY(1,1),
	[Guid] [uniqueidentifier] NOT NULL,
	[SecLvl] [int] NULL,
	[Name] [varchar](256) NULL,
	[LtnName] [varchar](256) NULL,
	[Nationality] [varchar](256) NULL,
	[LtnNationality] [varchar](256) NULL,
	[PersonalityNo] [varchar](256) NULL,
	[Address] [varchar](256) NULL,
	[Phone] [varchar](256) NULL,
	[Mobile] [varchar](256) NULL,
	[Fax] [varchar](256) NULL,
	[BoxNo] [varchar](256) NULL,
	[EMail] [varchar](256) NULL,
PRIMARY KEY CLUSTERED 
(
	[Guid] ASC
)WITH (PAD_INDEX = OFF, STATISTICS_NORECOMPUTE = OFF, IGNORE_DUP_KEY = OFF, ALLOW_ROW_LOCKS = ON, ALLOW_PAGE_LOCKS = ON, OPTIMIZE_FOR_SEQUENTIAL_KEY = OFF) ON [PRIMARY]
) ON [PRIMARY]
GO
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE TABLE [dbo].[OwnerUnionFee](
	[Number] [int] NOT NULL IDENTITY(1,1),
	[Guid] [uniqueidentifier] NOT NULL,
	[SecLvl] [int] NULL,
	[Date] [date] NULL,
	[BuildingGuid] [uniqueidentifier] NULL,
	[CkFlat] [bit] NULL,
	[CkShop] [bit] NULL,
	[CkParking] [bit] NULL,
	[AccountGuid] [uniqueidentifier] NULL,
	[CkMoveCreditCost] [bit] NULL,
	[CkMoveDebitCost] [bit] NULL,
	[Fee] [float] NULL,
	[RoundKind] [int] NULL,
	[CurrencyGUID] [uniqueidentifier] NULL,
	[CurrencyVal] [float] NULL,
	[ItemNote] [varchar](255) NULL,
	[Note] [varchar](255) NULL,
PRIMARY KEY CLUSTERED 
(
	[Guid] ASC
)WITH (PAD_INDEX = OFF, STATISTICS_NORECOMPUTE = OFF, IGNORE_DUP_KEY = OFF, ALLOW_ROW_LOCKS = ON, ALLOW_PAGE_LOCKS = ON, OPTIMIZE_FOR_SEQUENTIAL_KEY = OFF) ON [PRIMARY]
) ON [PRIMARY]
GO
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE TABLE [dbo].[OwnerUnionFeeDetail](
	[Number] [int] NOT NULL IDENTITY(1,1),
	[parentGuid] [uniqueidentifier] NULL,
	[Kind] [int] NULL,
	[FlatGuid] [uniqueidentifier] NULL,
	[Area] [float] NULL,
	[Fee] [float] NULL,
	[AccountGuid] [uniqueidentifier] NULL,
	[CostGuid] [uniqueidentifier] NULL,
	[Note] [varchar](255) NULL
) ON [PRIMARY]
GO
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE TABLE [dbo].[parking](
	[Number] [int] NOT NULL IDENTITY(1,1),
	[Guid] [uniqueidentifier] NOT NULL,
	[SecLvl] [int] NULL,
	[NO] [varchar](256) NULL,
	[Judicial] [bit] NULL,
	[Ban] [bit] NULL,
	[BuildingGuid] [uniqueidentifier] NULL,
	[FloorNo] [int] NULL,
	[Area] [float] NULL,
	[unity] [varchar](256) NULL,
	[Note] [varchar](256) NULL,
	[ParkingKind] [varchar](256) NULL,
	[Description] [varchar](256) NULL,
	[Overlooking] [varchar](256) NULL,
	[CostPrice] [float] NULL,
	[CostCurrencyGUID] [uniqueidentifier] NULL,
	[Rent] [float] NULL,
	[RentCurrencyGUID] [uniqueidentifier] NULL,
	[Sale] [float] NULL,
	[SaleCurrencyGUID] [uniqueidentifier] NULL,
	[CostGuid] [uniqueidentifier] NULL,
	[FlatOwner] [int] NULL,
	[CustGuid] [uniqueidentifier] NULL,
	[Details] [varchar](256) NULL,
	[OfferState] [int] NULL,
	[OfferType] [int] NULL,
	[CustomerName] [varchar](256) NULL,
	[CustomerPhone] [varchar](256) NULL,
	[Restrained] [bit] NULL,
	[PurchaseDate] [date] NULL,
	[PayValue] [float] NULL,
	[LastContractGuid] [uniqueidentifier] NULL,
	[RestrainedUserGuid] [uniqueidentifier] NULL,
PRIMARY KEY CLUSTERED 
(
	[Guid] ASC
)WITH (PAD_INDEX = OFF, STATISTICS_NORECOMPUTE = OFF, IGNORE_DUP_KEY = OFF, ALLOW_ROW_LOCKS = ON, ALLOW_PAGE_LOCKS = ON, OPTIMIZE_FOR_SEQUENTIAL_KEY = OFF) ON [PRIMARY],
 CONSTRAINT [UK_parking_NO_UNIQUE] UNIQUE NONCLUSTERED 
(
	[BuildingGuid] ASC,
	[NO] ASC
)WITH (PAD_INDEX = OFF, STATISTICS_NORECOMPUTE = OFF, IGNORE_DUP_KEY = OFF, ALLOW_ROW_LOCKS = ON, ALLOW_PAGE_LOCKS = ON, OPTIMIZE_FOR_SEQUENTIAL_KEY = OFF) ON [PRIMARY]
) ON [PRIMARY]
GO
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE TABLE [dbo].[ParkingContract](
	[Number] [int] NOT NULL IDENTITY(1,1),
	[Guid] [uniqueidentifier] NOT NULL,
	[SecLvl] [int] NULL,
	[Mark] [bit] NULL,
	[EditDate] [date] NULL,
	[DeliverDate] [date] NULL,
	[TypeGuid] [uniqueidentifier] NULL,
	[ContractKind] [int] NULL,
	[IsAutoRenewal] [bit] NULL,
	[ContractNo] [varchar](256) NULL,
	[CustomerGuid] [uniqueidentifier] NULL,
	[BuildingGuid] [uniqueidentifier] NULL,
	[ParkingGuid] [uniqueidentifier] NULL,
	[Description] [varchar](255) NULL,
	[CostGuid] [uniqueidentifier] NULL,
	[RentInfoGuid] [uniqueidentifier] NULL,
	[SalesManGuid] [uniqueidentifier] NULL,
	[FlatContractGuid] [uniqueidentifier] NULL,
	[FromDate] [date] NULL,
	[ToDate] [date] NULL,
	[Period] [int] NULL,
	[Rent] [float] NULL,
	[RentContractType] [int] NULL,
	[MonthlyValue] [float] NULL,
	[CurrencyGuid] [uniqueidentifier] NULL,
	[CurrencyVal] [float] NULL,
	[DiscountPercent] [float] NULL,
	[DiscountValue] [float] NULL,
	[DiscountAccountGuid] [uniqueidentifier] NULL,
	[PayType] [int] NULL,
	[Note] [varchar](8000) NULL,
	[Note2] [varchar](8000) NULL,
	[RevenueAccountGuid] [uniqueidentifier] NULL,
	[CustAccountGuid] [uniqueidentifier] NULL,
	[CommissionFromCustPercent] [float] NULL,
	[CommissionFromCustValue] [float] NULL,
	[AcCommissionFromCustGuid] [uniqueidentifier] NULL,
	[CommissionFromOwnerPercent] [float] NULL,
	[CommissionFromOwnerValue] [float] NULL,
	[AcCommissionFromOwnerGuid] [uniqueidentifier] NULL,
	[AcIncomNextYearGUID] [uniqueidentifier] NULL,
	[AcCommissionFromOwnerNote] [varchar](256) NULL,
	[AcCommissionFromCustNote] [varchar](256) NULL,
	[CommissionFromSalesManrPercent] [float] NULL,
	[CommissionFromSalesManValue] [float] NULL,
	[AcSalesManCommissionGuid] [uniqueidentifier] NULL,
	[AcCommissionExpenseGuid] [uniqueidentifier] NULL,
	[SalesManCommNote] [varchar](256) NULL,
	[OtherFee1] [float] NULL,
	[OtherFeeAccount1GUID] [uniqueidentifier] NULL,
	[OtherFee2] [float] NULL,
	[OtherFeeAccount2GUID] [uniqueidentifier] NULL,
	[OtherFee3] [float] NULL,
	[OtherFeeAccount3GUID] [uniqueidentifier] NULL,
	[OtherFee4] [float] NULL,
	[OtherFeeAccount4GUID] [uniqueidentifier] NULL,
	[OtherFee5] [float] NULL,
	[OtherFeeAccount5GUID] [uniqueidentifier] NULL,
	[ContractFinish] [bit] NULL,
	[ContractFinishDate] [date] NULL,
	[EditContractFinishDate] [date] NULL,
	[ResultingAmount] [float] NULL,
	[ResultingAmount2] [float] NULL,
	[ResultingNote] [varchar](256) NULL,
	[Fine] [float] NULL,
	[FineAccount] [uniqueidentifier] NULL,
	[FineNote] [varchar](256) NULL,
	[CreateResultingEntry] [bit] NULL,
	[InsuranceValue] [float] NULL,
	[InsuranceValueOld] [float] NULL,
	[ContractPrice] [float] NULL,
	[AccountContractPrice] [uniqueidentifier] NULL,
	[CertificatValue] [float] NULL,
	[AccountCertificatValue] [uniqueidentifier] NULL,
	[RentDuration] [varchar](256) NULL,
	[Rentype] [varchar](256) NULL,
	[TermsOfPayment] [varchar](256) NULL,
	[Step1Complete] [bit] NULL,
	[Step2Complete] [bit] NULL,
	[Step3Complete] [bit] NULL,
	[Step4Complete] [bit] NULL,
	[Step5Complete] [bit] NULL,
	[Certification] [varchar](256) NULL,
	[BranchGuid] [uniqueidentifier] NULL,
	[CardNo] [varchar](256) NULL,
	[CarNo] [varchar](256) NULL,
	[CarType] [varchar](256) NULL,
	[CarColor] [varchar](256) NULL,
	[Emirate] [varchar](256) NULL,
	[CreateContractEntry] [bit] NULL,
	[FineRevenueAccountGUID] [uniqueidentifier] NULL,
	[NewState] [int] NULL,
	[License1No] [varchar](256) NULL,
	[License2No] [varchar](256) NULL,
	[License3No] [varchar](256) NULL,
	[License1Date1] [date] NULL,
	[License2Date1] [date] NULL,
	[License3Date1] [date] NULL,
	[License1Date2] [date] NULL,
	[License2Date2] [date] NULL,
	[License3Date2] [date] NULL,
	[LtnRentDuration] [varchar](256) NULL,
	[LtnRentype] [varchar](256) NULL,
	[LtnTermsOfPayment] [varchar](256) NULL,
	[IsRounded] [bit] NULL,
	[Judicial] [bit] NULL,
	[IsReturnInsurance] [bit] NULL,
	[ReturnInsuranceDate] [date] NULL,
	[PrvContractGuid] [uniqueidentifier] NULL,
	[AddPercent] [float] NULL,
	[AddValue] [float] NULL,
PRIMARY KEY CLUSTERED 
(
	[Guid] ASC
)WITH (PAD_INDEX = OFF, STATISTICS_NORECOMPUTE = OFF, IGNORE_DUP_KEY = OFF, ALLOW_ROW_LOCKS = ON, ALLOW_PAGE_LOCKS = ON, OPTIMIZE_FOR_SEQUENTIAL_KEY = OFF) ON [PRIMARY]
) ON [PRIMARY]
GO
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE TABLE [dbo].[ParkingContractFee](
	[Number] [int] NOT NULL IDENTITY(1,1),
	[EntryNumber] [int] NULL,
	[Guid] [uniqueidentifier] NOT NULL,
	[ParentGuid] [uniqueidentifier] NULL,
	[Date] [date] NULL,
	[AccountGuid] [uniqueidentifier] NULL,
	[Value] [float] NULL,
	[CreateEntry] [bit] NULL,
	[Note] [varchar](255) NULL,
PRIMARY KEY CLUSTERED 
(
	[Guid] ASC
)WITH (PAD_INDEX = OFF, STATISTICS_NORECOMPUTE = OFF, IGNORE_DUP_KEY = OFF, ALLOW_ROW_LOCKS = ON, ALLOW_PAGE_LOCKS = ON, OPTIMIZE_FOR_SEQUENTIAL_KEY = OFF) ON [PRIMARY]
) ON [PRIMARY]
GO
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE TABLE [dbo].[ParkingContractReceiptNO](
	[Number] [int] NOT NULL IDENTITY(1,1),
	[Guid] [uniqueidentifier] NOT NULL,
	[SecLvl] [int] NULL,
	[ParentGuid] [uniqueidentifier] NULL,
	[No] [varchar](256) NULL,
	[Date] [date] NULL,
	[Note] [varchar](256) NULL,
PRIMARY KEY CLUSTERED 
(
	[Guid] ASC
)WITH (PAD_INDEX = OFF, STATISTICS_NORECOMPUTE = OFF, IGNORE_DUP_KEY = OFF, ALLOW_ROW_LOCKS = ON, ALLOW_PAGE_LOCKS = ON, OPTIMIZE_FOR_SEQUENTIAL_KEY = OFF) ON [PRIMARY]
) ON [PRIMARY]
GO
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE TABLE [dbo].[ParkingWallet](
	[Number] [int] NOT NULL IDENTITY(1,1),
	[ParentGuid] [uniqueidentifier] NULL,
	[BuildingGuid] [uniqueidentifier] NULL,
	[ParkingGuid] [uniqueidentifier] NULL,
	[MainCost] [float] NULL,
	[Expense] [float] NULL,
	[BeginDate] [date] NULL,
	[SaleDate] [date] NULL,
	[SaleValue] [float] NULL
) ON [PRIMARY]
GO
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE TABLE [dbo].[Partnerwallet](
	[Number] [int] NOT NULL IDENTITY(1,1),
	[ParentGuid] [uniqueidentifier] NULL,
	[CustGuid] [uniqueidentifier] NULL,
	[Value] [float] NULL,
	[BeginDate] [date] NULL,
	[EndDate] [date] NULL,
	[RealWorkDay] [int] NULL
) ON [PRIMARY]
GO
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE TABLE [dbo].[PathCustomPrint](
	[FormName] [varchar](256) NULL,
	[Path] [varchar](512) NULL
) ON [PRIMARY]
GO
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE TABLE [dbo].[Photos](
	[Number] [int] NOT NULL IDENTITY(1,1),
	[Guid] [uniqueidentifier] NOT NULL,
	[ParentGuid] [uniqueidentifier] NULL,
	[TableGUID] [uniqueidentifier] NULL,
	[userGuid] [uniqueidentifier] NULL,
	[Date] [date] NULL,
	[Path] [varchar](255) NULL,
	[Tab] [varchar](255) NULL,
	[Desc] [varchar](255) NULL,
	[Note] [varchar](255) NULL,
PRIMARY KEY CLUSTERED 
(
	[Guid] ASC
)WITH (PAD_INDEX = OFF, STATISTICS_NORECOMPUTE = OFF, IGNORE_DUP_KEY = OFF, ALLOW_ROW_LOCKS = ON, ALLOW_PAGE_LOCKS = ON, OPTIMIZE_FOR_SEQUENTIAL_KEY = OFF) ON [PRIMARY]
) ON [PRIMARY]
GO
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE TABLE [dbo].[Pricing](
	[Number] [int] NOT NULL IDENTITY(1,1),
	[Guid] [uniqueidentifier] NOT NULL,
	[SecLvl] [int] NULL,
	[RepNo] [varchar](255) NULL,
	[RepDate] [date] NULL,
	[RegNo] [varchar](255) NULL,
	[Attachment] [varchar](255) NULL,
	[CustGuid] [uniqueidentifier] NULL,
	[OwnerName] [varchar](255) NULL,
	[IssueSide] [varchar](255) NULL,
	[DocNo] [varchar](255) NULL,
	[DocDate] [date] NULL,
	[Country] [varchar](255) NULL,
	[Region] [varchar](255) NULL,
	[City] [varchar](255) NULL,
	[Quarter] [varchar](255) NULL,
	[Street] [varchar](255) NULL,
	[DesignName] [varchar](255) NULL,
	[PieceNo] [varchar](255) NULL,
	[RealtyNote] [varchar](255) NULL,
	[RegionState] [varchar](255) NULL,
	[Building] [bit] NULL,
	[pubUtil1] [bit] NULL,
	[pubUtil2] [bit] NULL,
	[pubUtil3] [bit] NULL,
	[Service1] [bit] NULL,
	[Service2] [bit] NULL,
	[Service3] [bit] NULL,
	[Service4] [bit] NULL,
	[RegionNote] [varchar](255) NULL,
	[Area] [varchar](255) NULL,
	[AreaState1] [bit] NULL,
	[AreaState2] [bit] NULL,
	[AreaState3] [bit] NULL,
	[BuildSys] [varchar](255) NULL,
	[ParamBuild] [varchar](255) NULL,
	[RegionClass] [varchar](255) NULL,
	[Dimension1] [varchar](255) NULL,
	[Dimension2] [varchar](255) NULL,
	[Dimension3] [varchar](255) NULL,
	[Dimension4] [varchar](255) NULL,
	[Boundary1] [varchar](255) NULL,
	[Boundary2] [varchar](255) NULL,
	[Boundary3] [varchar](255) NULL,
	[Boundary4] [varchar](255) NULL,
	[LandState] [varchar](255) NULL,
	[DimensionNote] [varchar](255) NULL,
	[Coordinate] [varchar](255) NULL,
	[Resume] [varchar](500) NULL,
	[Merit] [varchar](500) NULL,
	[Drawback] [varchar](500) NULL,
	[ProjectEffect] [varchar](2500) NULL,
	[RealtyValue] [float] NULL,
	[CostValue] [float] NULL,
	[MeterPrice] [float] NULL,
	[CurrentLandPrice] [varchar](255) NULL,
	[PricingWay] [varchar](255) NULL,
	[PricingValue] [varchar](255) NULL,
	[MaxPrice] [varchar](255) NULL,
	[MinPrice] [varchar](255) NULL,
	[EstimationValue] [varchar](255) NULL,
	[EstimationNote] [varchar](500) NULL,
	[MapPath1] [varchar](255) NULL,
	[MapPath2] [varchar](255) NULL,
	[MapPath3] [varchar](255) NULL,
	[Note] [varchar](255) NULL,
	[CreateEntry] [bit] NULL,
	[EntryDate] [date] NULL,
	[EntryValue] [float] NULL,
	[EntryCurrencyGUID] [uniqueidentifier] NULL,
	[EntryCurrencyVal] [float] NULL,
	[DebitAccountGuid] [uniqueidentifier] NULL,
	[CreditAccountGuid] [uniqueidentifier] NULL,
	[DebitCostGuid] [uniqueidentifier] NULL,
	[CreditCostGuid] [uniqueidentifier] NULL,
	[EntryNote] [varchar](255) NULL,
PRIMARY KEY CLUSTERED 
(
	[Guid] ASC
)WITH (PAD_INDEX = OFF, STATISTICS_NORECOMPUTE = OFF, IGNORE_DUP_KEY = OFF, ALLOW_ROW_LOCKS = ON, ALLOW_PAGE_LOCKS = ON, OPTIMIZE_FOR_SEQUENTIAL_KEY = OFF) ON [PRIMARY]
) ON [PRIMARY]
GO
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE TABLE [dbo].[PricingDetail](
	[Number] [int] NOT NULL IDENTITY(1,1),
	[Kind] [int] NULL,
	[ParentGuid] [uniqueidentifier] NULL,
	[Note] [varchar](255) NULL,
	[Analysis] [varchar](255) NULL,
	[Value] [float] NULL
) ON [PRIMARY]
GO
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE TABLE [dbo].[Progress_Tbl](
	[Spid] [int] NULL,
	[Msg] [varchar](255) NULL,
	[SubMsg] [varchar](255) NULL,
	[MaxPos] [int] NULL,
	[Pos] [int] NULL,
	[Time] [date] NULL
) ON [PRIMARY]
GO
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE TABLE [dbo].[ProjectCost](
	[BuildingGuid] [uniqueidentifier] NOT NULL,
	[AccountGuid] [uniqueidentifier] NULL,
	[CurrencyGuid] [uniqueidentifier] NULL,
	[CurrencyVal] [float] NULL,
	[CostTotal] [float] NULL,
	[AreaTotal] [float] NULL,
	[Unity] [varchar](256) NULL,
	[Note] [varchar](256) NULL,
	[CostGuid] [uniqueidentifier] NULL,
PRIMARY KEY CLUSTERED 
(
	[BuildingGuid] ASC
)WITH (PAD_INDEX = OFF, STATISTICS_NORECOMPUTE = OFF, IGNORE_DUP_KEY = OFF, ALLOW_ROW_LOCKS = ON, ALLOW_PAGE_LOCKS = ON, OPTIMIZE_FOR_SEQUENTIAL_KEY = OFF) ON [PRIMARY]
) ON [PRIMARY]
GO
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE TABLE [dbo].[ProjectCostDetail](
	[Number] [int] NOT NULL IDENTITY(1,1),
	[Guid] [uniqueidentifier] NULL,
	[ParentGuid] [uniqueidentifier] NULL,
	[Date] [date] NULL,
	[AccountGuid] [uniqueidentifier] NULL,
	[Value] [float] NULL,
	[Note] [varchar](256) NULL
) ON [PRIMARY]
GO
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE TABLE [dbo].[pRun](
	[id] [int] IDENTITY(1,1) NOT NULL,
	[Date] [date] NULL,
	[Note] [varchar](256) NULL
) ON [PRIMARY]
GO
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE TABLE [dbo].[QtyGroup](
	[Number] [int] NOT NULL IDENTITY(1,1),
	[Guid] [uniqueidentifier] NOT NULL,
	[SecLvl] [int] NULL,
	[GroupGuid] [uniqueidentifier] NULL,
	[CalcQtyGuid] [uniqueidentifier] NULL,
	[Note] [varchar](256) NULL,
PRIMARY KEY CLUSTERED 
(
	[Guid] ASC
)WITH (PAD_INDEX = OFF, STATISTICS_NORECOMPUTE = OFF, IGNORE_DUP_KEY = OFF, ALLOW_ROW_LOCKS = ON, ALLOW_PAGE_LOCKS = ON, OPTIMIZE_FOR_SEQUENTIAL_KEY = OFF) ON [PRIMARY]
) ON [PRIMARY]
GO
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE TABLE [dbo].[QueryDefaultValue](
	[UserGuid] [uniqueidentifier] NULL,
	[RepName] [varchar](256) NULL,
	[FormName] [varchar](256) NULL,
	[ComponentName] [varchar](256) NULL,
	[Value] [varchar](256) NULL
) ON [PRIMARY]
GO
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE TABLE [dbo].[QueryFeature](
	[No] [int] IDENTITY(1,1) NOT NULL,
	[ID] [int] NULL,
	[Value] [varchar](800) NULL
) ON [PRIMARY]
GO
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE TABLE [dbo].[Realty_Detail_users](
	[id] [int] IDENTITY(1,1) NOT NULL,
	[Number] [int] NOT NULL IDENTITY(1,1),
	[ParentGuid] [uniqueidentifier] NULL,
	[IdCard] [int] NULL,
	[Permit] [varchar](25) NULL,
	[Str] [varchar](256) NULL
) ON [PRIMARY]
GO
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE TABLE [dbo].[Realty_LogCard](
	[Number] [int] NOT NULL IDENTITY(1,1),
	[UserGuid] [uniqueidentifier] NULL,
	[ComputerName] [varchar](50) NULL,
	[CardId] [int] NULL,
	[CardGuid] [uniqueidentifier] NULL,
	[Date] [date] NULL,
	[Opration] [varchar](100) NULL,
	[Note] [varchar](250) NULL
) ON [PRIMARY]
GO
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE TABLE [dbo].[Realty_Users](
	[Number] [int] NOT NULL IDENTITY(1,1),
	[Guid] [uniqueidentifier] NOT NULL,
	[SecLvl] [int] NULL,
	[LoginName] [varchar](50) NULL,
	[Password] [varchar](50) NULL,
	[bAdmin] [bit] NULL,
	[UserSecLvl] [int] NULL,
	[BranchGuid] [uniqueidentifier] NULL,
PRIMARY KEY CLUSTERED 
(
	[Guid] ASC
)WITH (PAD_INDEX = OFF, STATISTICS_NORECOMPUTE = OFF, IGNORE_DUP_KEY = OFF, ALLOW_ROW_LOCKS = ON, ALLOW_PAGE_LOCKS = ON, OPTIMIZE_FOR_SEQUENTIAL_KEY = OFF) ON [PRIMARY],
 CONSTRAINT [Realty_Users_LoginName_Primary_Users] UNIQUE NONCLUSTERED 
(
	[LoginName] ASC
)WITH (PAD_INDEX = OFF, STATISTICS_NORECOMPUTE = OFF, IGNORE_DUP_KEY = OFF, ALLOW_ROW_LOCKS = ON, ALLOW_PAGE_LOCKS = ON, OPTIMIZE_FOR_SEQUENTIAL_KEY = OFF) ON [PRIMARY]
) ON [PRIMARY]
GO
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE TABLE [dbo].[RealtyMaintenanceContract](
	[Number] [int] NOT NULL IDENTITY(1,1),
	[ParentGuid] [uniqueidentifier] NULL,
	[RealtyGuid] [uniqueidentifier] NULL,
	[CostGuid] [uniqueidentifier] NULL,
	[Value] [float] NULL,
	[Percent] [float] NULL,
	[Note] [varchar](255) NULL
) ON [PRIMARY]
GO
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE TABLE [dbo].[RealtyRestrained](
	[Number] [int] NOT NULL IDENTITY(1,1),
	[Guid] [uniqueidentifier] NOT NULL,
	[SecLvl] [int] NULL,
	[RestrainedCanceld] [bit] NULL,
	[CustomerGuid] [uniqueidentifier] NULL,
	[BuildingGuid] [uniqueidentifier] NULL,
	[FlatGuid] [uniqueidentifier] NULL,
	[ParkingNo] [uniqueidentifier] NULL,
	[VillaGuid] [uniqueidentifier] NULL,
	[LandGuid] [uniqueidentifier] NULL,
	[Shop] [uniqueidentifier] NULL,
	[RealtyType] [int] NULL,
	[EditDate] [date] NULL,
	[Date] [date] NULL,
	[EndDate] [date] NULL,
	[EndDateSpecific] [bit] NULL,
	[Note] [varchar](256) NULL,
	[Pay] [bit] NULL,
	[PayValue] [float] NULL,
	[CurrencyGuid] [uniqueidentifier] NULL,
	[Currencyval] [float] NULL,
	[PayType] [int] NULL,
	[DebitAccountGuid] [uniqueidentifier] NULL,
	[CreditAccountGuid] [uniqueidentifier] NULL,
	[CostDebitGuid] [uniqueidentifier] NULL,
	[CostCreditGuid] [uniqueidentifier] NULL,
	[CheckTypeGuid] [uniqueidentifier] NULL,
PRIMARY KEY CLUSTERED 
(
	[Guid] ASC
)WITH (PAD_INDEX = OFF, STATISTICS_NORECOMPUTE = OFF, IGNORE_DUP_KEY = OFF, ALLOW_ROW_LOCKS = ON, ALLOW_PAGE_LOCKS = ON, OPTIMIZE_FOR_SEQUENTIAL_KEY = OFF) ON [PRIMARY]
) ON [PRIMARY]
GO
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE TABLE [dbo].[ReceiptOrder](
	[Number] [int] NOT NULL IDENTITY(1,1),
	[Guid] [uniqueidentifier] NOT NULL,
	[SecLvl] [int] NULL,
	[TypeGuid] [uniqueidentifier] NULL,
	[Date] [date] NULL,
	[ContractGuid] [uniqueidentifier] NULL,
	[mark] [bit] NULL,
	[Note] [varchar](255) NULL,
PRIMARY KEY CLUSTERED 
(
	[Guid] ASC
)WITH (PAD_INDEX = OFF, STATISTICS_NORECOMPUTE = OFF, IGNORE_DUP_KEY = OFF, ALLOW_ROW_LOCKS = ON, ALLOW_PAGE_LOCKS = ON, OPTIMIZE_FOR_SEQUENTIAL_KEY = OFF) ON [PRIMARY]
) ON [PRIMARY]
GO
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE TABLE [dbo].[ReceiptOrderDetail](
	[Number] [int] NOT NULL IDENTITY(1,1),
	[Guid] [uniqueidentifier] NOT NULL,
	[ParentGuid] [uniqueidentifier] NULL,
	[Label] [varchar](255) NULL,
	[AccountGuid] [uniqueidentifier] NULL,
	[Date] [date] NULL,
	[Value] [float] NULL,
	[CashValue] [float] NULL,
	[checkValue] [float] NULL,
	[Note] [varchar](255) NULL,
	[IsReceipt] [bit] NULL,
PRIMARY KEY CLUSTERED 
(
	[Guid] ASC
)WITH (PAD_INDEX = OFF, STATISTICS_NORECOMPUTE = OFF, IGNORE_DUP_KEY = OFF, ALLOW_ROW_LOCKS = ON, ALLOW_PAGE_LOCKS = ON, OPTIMIZE_FOR_SEQUENTIAL_KEY = OFF) ON [PRIMARY]
) ON [PRIMARY]
GO
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE TABLE [dbo].[ReceiptOrderType](
	[Number] [int] NOT NULL IDENTITY(1,1),
	[Guid] [uniqueidentifier] NOT NULL,
	[SecLvl] [int] NULL,
	[Code] [varchar](256) NULL,
	[Name] [varchar](256) NULL,
	[ltnName] [varchar](256) NULL,
	[Menu] [varchar](256) NULL,
	[LtnMenu] [varchar](256) NULL,
	[ShortCut] [varchar](256) NULL,
	[EntryTypeGuid] [uniqueidentifier] NULL,
PRIMARY KEY CLUSTERED 
(
	[Guid] ASC
)WITH (PAD_INDEX = OFF, STATISTICS_NORECOMPUTE = OFF, IGNORE_DUP_KEY = OFF, ALLOW_ROW_LOCKS = ON, ALLOW_PAGE_LOCKS = ON, OPTIMIZE_FOR_SEQUENTIAL_KEY = OFF) ON [PRIMARY]
) ON [PRIMARY]
GO
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE TABLE [dbo].[ReceiptOrderTypeDetail](
	[Number] [int] NOT NULL IDENTITY(1,1),
	[ParentGuid] [uniqueidentifier] NULL,
	[Label] [varchar](255) NULL,
	[AccountGuid] [uniqueidentifier] NULL,
	[ArNote] [varchar](255) NULL,
	[EnNote] [varchar](255) NULL
) ON [PRIMARY]
GO
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE TABLE [dbo].[ReceiptOrderTypePrivilege](
	[UserGuid] [uniqueidentifier] NULL,
	[TypeGuid] [uniqueidentifier] NULL,
	[Open] [bit] NULL,
	[Add] [bit] NULL,
	[Edit] [bit] NULL,
	[Del] [bit] NULL,
	[Mark] [bit] NULL,
	[MarkEdit] [bit] NULL,
	[MarkDel] [bit] NULL,
	[ShowMark] [bit] NULL,
	[Print] [bit] NULL,
	[Design] [bit] NULL
) ON [PRIMARY]
GO
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE TABLE [dbo].[Reminder](
	[Number] [int] NOT NULL IDENTITY(1,1),
	[Guid] [uniqueidentifier] NOT NULL,
	[SecLvl] [int] NULL,
	[Subject] [varchar](256) NULL,
	[Date] [date] NULL,
	[RemindDate] [date] NULL,
	[Finished] [bit] NULL,
	[Mobile] [varchar](256) NULL,
	[Note] [varchar](800) NULL,
	[ForAllUser] [bit] NULL,
	[UserGuid] [uniqueidentifier] NULL,
PRIMARY KEY CLUSTERED 
(
	[Guid] ASC
)WITH (PAD_INDEX = OFF, STATISTICS_NORECOMPUTE = OFF, IGNORE_DUP_KEY = OFF, ALLOW_ROW_LOCKS = ON, ALLOW_PAGE_LOCKS = ON, OPTIMIZE_FOR_SEQUENTIAL_KEY = OFF) ON [PRIMARY]
) ON [PRIMARY]
GO
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE TABLE [dbo].[RentInfo](
	[Number] [int] NOT NULL IDENTITY(1,1),
	[Guid] [uniqueidentifier] NOT NULL,
	[SecLvl] [int] NULL,
	[Name] [varchar](256) NULL,
	[LtnName] [varchar](256) NULL,
	[Adjective] [varchar](256) NULL,
	[PassportNO] [varchar](256) NULL,
	[PassportExpireDate] [date] NULL,
	[WorkCardNo] [varchar](256) NULL,
	[Nationality] [varchar](256) NULL,
	[LtnNationality] [varchar](256) NULL,
	[Work] [varchar](256) NULL,
	[PersonalityNo] [varchar](256) NULL,
	[Address] [varchar](256) NULL,
	[Phone] [varchar](256) NULL,
	[Mobile] [varchar](256) NULL,
	[Fax] [varchar](256) NULL,
	[BoxNo] [varchar](256) NULL,
	[EMail] [varchar](256) NULL,
PRIMARY KEY CLUSTERED 
(
	[Guid] ASC
)WITH (PAD_INDEX = OFF, STATISTICS_NORECOMPUTE = OFF, IGNORE_DUP_KEY = OFF, ALLOW_ROW_LOCKS = ON, ALLOW_PAGE_LOCKS = ON, OPTIMIZE_FOR_SEQUENTIAL_KEY = OFF) ON [PRIMARY]
) ON [PRIMARY]
GO
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE TABLE [dbo].[RepCheck](
	[ObjGuid] [uniqueidentifier] NULL,
	[UserGuid] [uniqueidentifier] NULL,
	[IdReport] [int] NULL,
	[date] [date] NULL
) ON [PRIMARY]
GO
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE TABLE [dbo].[RepCheckCount](
	[ObjGuid] [uniqueidentifier] NULL,
	[UserGuid] [uniqueidentifier] NULL,
	[IdReport] [int] NULL,
	[date] [date] NULL,
	[Count] [int] NULL
) ON [PRIMARY]
GO
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE TABLE [dbo].[ReportSort](
	[UserGuid] [uniqueidentifier] NULL,
	[ReportName] [varchar](256) NULL,
	[SortValue] [varchar](500) NULL
) ON [PRIMARY]
GO
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE TABLE [dbo].[RepSMS](
	[ObjGuid] [uniqueidentifier] NULL,
	[UserGuid] [uniqueidentifier] NULL,
	[IdReport] [int] NULL,
	[date] [date] NULL
) ON [PRIMARY]
GO
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE TABLE [dbo].[RepSMSCount](
	[ObjGuid] [uniqueidentifier] NULL,
	[UserGuid] [uniqueidentifier] NULL,
	[IdReport] [int] NULL,
	[date] [date] NULL,
	[Count] [int] NULL
) ON [PRIMARY]
GO
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE TABLE [dbo].[Resource](
	[Spid] [int] NULL,
	[Guid] [uniqueidentifier] NULL,
	[Kind] [int] NULL,
	[Tag] [int] NULL
) ON [PRIMARY]
GO
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE TABLE [dbo].[Salesman](
	[Number] [int] NOT NULL IDENTITY(1,1),
	[Guid] [uniqueidentifier] NOT NULL,
	[SecLvl] [int] NULL,
	[Name] [varchar](256) NULL,
	[LtnName] [varchar](256) NULL,
	[WorkCardNo] [varchar](256) NULL,
	[Nationality] [varchar](256) NULL,
	[LtnNationality] [varchar](256) NULL,
	[PersonalityNo] [varchar](256) NULL,
	[PassportNo] [varchar](256) NULL,
	[Address] [varchar](256) NULL,
	[Phone] [varchar](256) NULL,
	[Mobile] [varchar](256) NULL,
	[Fax] [varchar](256) NULL,
	[BoxNo] [varchar](256) NULL,
	[EMail] [varchar](256) NULL,
	[Commissionlimit] [float] NULL,
	[DiscountPercent] [float] NULL,
	[AccountGuid] [uniqueidentifier] NULL,
PRIMARY KEY CLUSTERED 
(
	[Guid] ASC
)WITH (PAD_INDEX = OFF, STATISTICS_NORECOMPUTE = OFF, IGNORE_DUP_KEY = OFF, ALLOW_ROW_LOCKS = ON, ALLOW_PAGE_LOCKS = ON, OPTIMIZE_FOR_SEQUENTIAL_KEY = OFF) ON [PRIMARY]
) ON [PRIMARY]
GO
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE TABLE [dbo].[Secondary_Entry](
	[Guid] [uniqueidentifier] NOT NULL,
	[TypeGuid] [uniqueidentifier] NULL,
	[Number] [int] NOT NULL IDENTITY(1,1),
	[SecLvl] [int] NULL,
	[Mark] [bit] NULL,
	[Kind] [int] NULL,
	[AccountGuid] [uniqueidentifier] NULL,
	[Date] [date] NULL,
	[Note] [varchar](256) NULL,
	[CurrencyGuid] [uniqueidentifier] NULL,
	[CurrencyVal] [float] NULL,
	[UserGuid] [uniqueidentifier] NULL,
	[BranchGuid] [uniqueidentifier] NULL,
	[SalesManGuid] [uniqueidentifier] NULL,
	[ContractGuid] [uniqueidentifier] NULL,
	[CheckCreateEntry] [bit] NULL,
	[IsRounded] [bit] NULL,
	[ReceiptNo] [varchar](256) NULL,
	[Debit] [float] NULL,
	[Credit] [float] NULL,
	[Itemcount] [int] NULL,
PRIMARY KEY CLUSTERED 
(
	[Guid] ASC
)WITH (PAD_INDEX = OFF, STATISTICS_NORECOMPUTE = OFF, IGNORE_DUP_KEY = OFF, ALLOW_ROW_LOCKS = ON, ALLOW_PAGE_LOCKS = ON, OPTIMIZE_FOR_SEQUENTIAL_KEY = OFF) ON [PRIMARY],
 CONSTRAINT [Secondary_Entry_Unique_Number] UNIQUE NONCLUSTERED 
(
	[Number] ASC,
	[TypeGuid] ASC
)WITH (PAD_INDEX = OFF, STATISTICS_NORECOMPUTE = OFF, IGNORE_DUP_KEY = OFF, ALLOW_ROW_LOCKS = ON, ALLOW_PAGE_LOCKS = ON, OPTIMIZE_FOR_SEQUENTIAL_KEY = OFF) ON [PRIMARY]
) ON [PRIMARY]
GO
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE TABLE [dbo].[Secondary_EntryDetail](
	[Number] [int] NOT NULL IDENTITY(1,1),
	[ParentGuid] [uniqueidentifier] NULL,
	[AcGuid] [uniqueidentifier] NULL,
	[Debit] [float] NULL,
	[Credit] [float] NULL,
	[CurrencyGuid] [uniqueidentifier] NULL,
	[CurrencyVal] [float] NULL,
	[ObverseAcGuid] [uniqueidentifier] NULL,
	[CostGuid] [uniqueidentifier] NULL,
	[Note] [varchar](256) NULL
) ON [PRIMARY]
GO
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE TABLE [dbo].[ServicesContract](
	[Number] [int] NOT NULL IDENTITY(1,1),
	[Guid] [uniqueidentifier] NOT NULL,
	[SecLvl] [int] NULL,
	[EditDate] [date] NULL,
	[Mark] [bit] NULL,
	[TypeGuid] [uniqueidentifier] NULL,
	[ContractNo] [varchar](256) NULL,
	[CustomerGuid] [uniqueidentifier] NULL,
	[BuildingGuid] [uniqueidentifier] NULL,
	[CostGuid] [uniqueidentifier] NULL,
	[FromDate] [date] NULL,
	[ToDate] [date] NULL,
	[Period] [int] NULL,
	[PeriodType] [int] NULL,
	[Rent] [float] NULL,
	[MonthlyValue] [float] NULL,
	[CurrencyGuid] [uniqueidentifier] NULL,
	[CurrencyVal] [float] NULL,
	[PayType] [int] NULL,
	[Note] [varchar](8000) NULL,
	[Note2] [varchar](8000) NULL,
	[Trademark] [varchar](256) NULL,
	[Purpose] [varchar](256) NULL,
	[Whereabouts] [varchar](256) NULL,
	[ExpenceAccountGUID] [uniqueidentifier] NULL,
	[CustAccountGuid] [uniqueidentifier] NULL,
	[CreateContractEntry] [bit] NULL,
	[ContractFinish] [bit] NULL,
	[ContractFinishDate] [date] NULL,
	[ResultingAmount] [float] NULL,
	[ResultingAmount2] [float] NULL,
	[RoundKind] [int] NULL,
	[ResultingNote] [varchar](256) NULL,
	[CreateResultingEntry] [bit] NULL,
	[RentDuration] [varchar](256) NULL,
	[Rentype] [varchar](256) NULL,
	[TermsOfPayment] [varchar](256) NULL,
	[DiscountPercent] [float] NULL,
	[DiscountValue] [float] NULL,
	[DiscountAccountGuid] [uniqueidentifier] NULL,
	[UserGuid] [uniqueidentifier] NULL,
	[BranchGuid] [uniqueidentifier] NULL,
	[FineExpenceAccountGUID] [uniqueidentifier] NULL,
	[NewState] [int] NULL,
	[OtherFee] [float] NULL,
	[OtherFeeAccountGUID] [uniqueidentifier] NULL,
	[License1No] [varchar](256) NULL,
	[License2No] [varchar](256) NULL,
	[License3No] [varchar](256) NULL,
	[License1Date1] [date] NULL,
	[License2Date1] [date] NULL,
	[License3Date1] [date] NULL,
	[License1Date2] [date] NULL,
	[License2Date2] [date] NULL,
	[License3Date2] [date] NULL,
	[Ltnwhereabouts] [varchar](256) NULL,
	[LtnPurpose] [varchar](256) NULL,
	[LtnRentDuration] [varchar](256) NULL,
	[LtnRentype] [varchar](256) NULL,
	[LtnTermsOfPayment] [varchar](256) NULL,
	[IsRounded] [bit] NULL,
	[CountOldContract] [int] NULL,
	[AcquittancePrinted] [bit] NULL,
	[AcquittancePrintDate] [date] NULL,
	[AcquittancePrintedByGuid] [uniqueidentifier] NULL,
PRIMARY KEY CLUSTERED 
(
	[Guid] ASC
)WITH (PAD_INDEX = OFF, STATISTICS_NORECOMPUTE = OFF, IGNORE_DUP_KEY = OFF, ALLOW_ROW_LOCKS = ON, ALLOW_PAGE_LOCKS = ON, OPTIMIZE_FOR_SEQUENTIAL_KEY = OFF) ON [PRIMARY]
) ON [PRIMARY]
GO
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE TABLE [dbo].[ServicesContractCachPayment](
	[ContractGuid] [uniqueidentifier] NULL,
	[EntryGuid] [uniqueidentifier] NULL
) ON [PRIMARY]
GO
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE TABLE [dbo].[ServicesContractDetail](
	[Number] [int] NOT NULL IDENTITY(1,1),
	[ParentGuid] [uniqueidentifier] NULL,
	[TypeName] [varchar](255) NULL,
	[Count] [float] NULL,
	[Model] [varchar](255) NULL,
	[WithChangePiece] [bit] NULL,
	[visitCount] [int] NULL,
	[VisitKind] [int] NULL,
	[Note] [varchar](255) NULL
) ON [PRIMARY]
GO
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE TABLE [dbo].[ServicesContractType](
	[Number] [int] NOT NULL IDENTITY(1,1),
	[Guid] [uniqueidentifier] NOT NULL,
	[SecLvl] [int] NULL,
	[Code] [varchar](256) NULL,
	[Name] [varchar](256) NULL,
	[ltnName] [varchar](256) NULL,
	[Menu] [varchar](256) NULL,
	[LtnMenu] [varchar](256) NULL,
	[ShortCut] [varchar](256) NULL,
	[ExpenceAccountGUID] [uniqueidentifier] NULL,
	[DiscountAccountGUID] [uniqueidentifier] NULL,
	[Rentcondition] [varchar](2048) NULL,
	[DefPrintPath] [varchar](256) NULL,
	[CreateEntry] [bit] NULL,
	[AutoCreateEntry] [bit] NULL,
	[AutoPostedEntry] [bit] NULL,
	[EntryDate] [int] NULL,
	[MoveCostWithExpenceDebit] [bit] NULL,
	[MoveCostWithExpenceCredit] [bit] NULL,
	[MoveCostWithDiscountDebit] [bit] NULL,
	[MoveCostWithDiscountCredit] [bit] NULL,
	[DefPrintReceipt] [varchar](256) NULL,
	[DefPrintLogPath] [varchar](256) NULL,
	[DefPrintacquittance] [varchar](256) NULL,
	[FirstPayNote] [varchar](255) NULL,
	[FirstPayNoteLtn] [varchar](255) NULL,
	[ContractNote] [varchar](255) NULL,
	[ContractNoteLtn] [varchar](255) NULL,
PRIMARY KEY CLUSTERED 
(
	[Guid] ASC
)WITH (PAD_INDEX = OFF, STATISTICS_NORECOMPUTE = OFF, IGNORE_DUP_KEY = OFF, ALLOW_ROW_LOCKS = ON, ALLOW_PAGE_LOCKS = ON, OPTIMIZE_FOR_SEQUENTIAL_KEY = OFF) ON [PRIMARY]
) ON [PRIMARY]
GO
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE TABLE [dbo].[ServicesContractTypePrivilege](
	[UserGuid] [uniqueidentifier] NULL,
	[ContractTypeGuid] [uniqueidentifier] NULL,
	[Open] [bit] NULL,
	[Add] [bit] NULL,
	[Edit] [bit] NULL,
	[Del] [bit] NULL,
	[Mark] [bit] NULL,
	[MarkEdit] [bit] NULL,
	[MarkDel] [bit] NULL,
	[ShowMark] [bit] NULL,
	[Print] [bit] NULL,
	[Design] [bit] NULL,
	[Field7] [bit] NULL,
	[Field8] [bit] NULL,
	[Field9] [bit] NULL,
	[Field10] [bit] NULL,
	[Field11] [bit] NULL,
	[Field12] [bit] NULL,
	[Field13] [bit] NULL,
	[Field14] [bit] NULL,
	[Field15] [bit] NULL,
	[Field16] [bit] NULL,
	[Field17] [bit] NULL,
	[Field18] [bit] NULL,
	[Field19] [bit] NULL,
	[Field20] [bit] NULL,
	[Field21] [bit] NULL,
	[MaxDiscount] [float] NULL
) ON [PRIMARY]
GO
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE TABLE [dbo].[Shop](
	[Number] [int] NOT NULL IDENTITY(1,1),
	[Guid] [uniqueidentifier] NOT NULL,
	[SecLvl] [int] NULL,
	[NO] [varchar](256) NULL,
	[Judicial] [bit] NULL,
	[Ban] [bit] NULL,
	[BuildingGuid] [uniqueidentifier] NULL,
	[Area] [float] NULL,
	[Unity] [varchar](256) NULL,
	[ShopKind] [varchar](256) NULL,
	[Description] [varchar](256) NULL,
	[Overlooking] [varchar](256) NULL,
	[UnifiedNum] [varchar](256) NULL,
	[ManservantRoom] [int] NULL,
	[DriverRoom] [int] NULL,
	[CostPrice] [float] NULL,
	[CostCurrencyGUID] [uniqueidentifier] NULL,
	[Rent] [float] NULL,
	[RentCurrencyGUID] [uniqueidentifier] NULL,
	[Sale] [float] NULL,
	[SaleCurrencyGUID] [uniqueidentifier] NULL,
	[Note] [varchar](256) NULL,
	[CostGuid] [uniqueidentifier] NULL,
	[FlatOwner] [int] NULL,
	[CustGuid] [uniqueidentifier] NULL,
	[Details] [varchar](256) NULL,
	[OfferState] [int] NULL,
	[OfferType] [int] NULL,
	[Restrained] [bit] NULL,
	[RestrainedUserGuid] [uniqueidentifier] NULL,
	[WaterCounter] [varchar](256) NULL,
	[ElectricityCounter] [varchar](256) NULL,
	[LtnShopKind] [varchar](256) NULL,
	[LtnDescription] [varchar](256) NULL,
	[LtnOverlooking] [varchar](256) NULL,
	[Class] [varchar](256) NULL,
	[BondType] [varchar](256) NULL,
	[BondNo] [varchar](256) NULL,
	[BondDate] [date] NULL,
	[License1] [varchar](256) NULL,
	[License2] [varchar](256) NULL,
	[LastContractGUID] [uniqueidentifier] NULL,
PRIMARY KEY CLUSTERED 
(
	[Guid] ASC
)WITH (PAD_INDEX = OFF, STATISTICS_NORECOMPUTE = OFF, IGNORE_DUP_KEY = OFF, ALLOW_ROW_LOCKS = ON, ALLOW_PAGE_LOCKS = ON, OPTIMIZE_FOR_SEQUENTIAL_KEY = OFF) ON [PRIMARY],
 CONSTRAINT [UK_ShopBuildingGuid_NO_UNIQUE] UNIQUE NONCLUSTERED 
(
	[BuildingGuid] ASC,
	[NO] ASC
)WITH (PAD_INDEX = OFF, STATISTICS_NORECOMPUTE = OFF, IGNORE_DUP_KEY = OFF, ALLOW_ROW_LOCKS = ON, ALLOW_PAGE_LOCKS = ON, OPTIMIZE_FOR_SEQUENTIAL_KEY = OFF) ON [PRIMARY]
) ON [PRIMARY]
GO
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE TABLE [dbo].[ShopAssets](
	[Number] [int] NOT NULL IDENTITY(1,1),
	[ParentGuid] [uniqueidentifier] NULL,
	[AssetsGuid] [uniqueidentifier] NULL,
	[Value] [float] NULL,
	[Note] [varchar](255) NULL
) ON [PRIMARY]
GO
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE TABLE [dbo].[ShopOffer](
	[Number] [int] NOT NULL IDENTITY(1,1),
	[Guid] [uniqueidentifier] NOT NULL,
	[SecLvl] [int] NULL,
	[NO] [varchar](256) NULL,
	[Building] [varchar](256) NULL,
	[Customer] [varchar](256) NULL,
	[Area] [float] NULL,
	[Unity] [varchar](256) NULL,
	[Address] [varchar](256) NULL,
	[ShopKind] [varchar](256) NULL,
	[Description] [varchar](256) NULL,
	[Overlooking] [varchar](256) NULL,
	[Note] [varchar](256) NULL,
	[Details] [varchar](256) NULL,
	[WaterCounter] [varchar](256) NULL,
	[ElectricityCounter] [varchar](256) NULL,
	[OfferKind] [int] NULL,
	[OfferValue] [float] NULL,
	[Delegated] [varchar](256) NULL,
	[CustPhone] [varchar](256) NULL,
	[CustMobile] [varchar](256) NULL,
	[MaxOfferValue] [float] NULL,
PRIMARY KEY CLUSTERED 
(
	[Guid] ASC
)WITH (PAD_INDEX = OFF, STATISTICS_NORECOMPUTE = OFF, IGNORE_DUP_KEY = OFF, ALLOW_ROW_LOCKS = ON, ALLOW_PAGE_LOCKS = ON, OPTIMIZE_FOR_SEQUENTIAL_KEY = OFF) ON [PRIMARY]
) ON [PRIMARY]
GO
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE TABLE [dbo].[ShopWallet](
	[Number] [int] NOT NULL IDENTITY(1,1),
	[ParentGuid] [uniqueidentifier] NULL,
	[BuildingGuid] [uniqueidentifier] NULL,
	[ShopGuid] [uniqueidentifier] NULL,
	[MainCost] [float] NULL,
	[Expense] [float] NULL,
	[BeginDate] [date] NULL,
	[SaleDate] [date] NULL,
	[SaleValue] [float] NULL
) ON [PRIMARY]
GO
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE TABLE [dbo].[SMSInfo](
	[Guid] [uniqueidentifier] NOT NULL,
	[ServerName] [varchar](256) NULL,
	[Unicode] [int] NULL,
	[ArLink] [varchar](1000) NULL,
	[EnLink] [varchar](1000) NULL,
	[BalanceLink] [varchar](1000) NULL,
	[Note] [varchar](256) NULL,
PRIMARY KEY CLUSTERED 
(
	[Guid] ASC
)WITH (PAD_INDEX = OFF, STATISTICS_NORECOMPUTE = OFF, IGNORE_DUP_KEY = OFF, ALLOW_ROW_LOCKS = ON, ALLOW_PAGE_LOCKS = ON, OPTIMIZE_FOR_SEQUENTIAL_KEY = OFF) ON [PRIMARY]
) ON [PRIMARY]
GO
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE TABLE [dbo].[SMSInfoDetail](
	[Number] [int] NOT NULL IDENTITY(1,1),
	[ParentGuid] [uniqueidentifier] NULL,
	[Result] [varchar](256) NULL,
	[ArNote] [varchar](256) NULL,
	[EnNote] [varchar](256) NULL,
	[IsSend] [bit] NULL
) ON [PRIMARY]
GO
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE TABLE [dbo].[SMSLog](
	[UserGuid] [uniqueidentifier] NULL,
	[Date] [date] NULL,
	[Host_Name] [varchar](256) NULL,
	[Phone] [varchar](256) NULL,
	[Msg] [varchar](256) NULL,
	[Result] [varchar](256) NULL
) ON [PRIMARY]
GO
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE TABLE [dbo].[SMSSetup](
	[Number] [int] NOT NULL IDENTITY(1,1),
	[Guid] [uniqueidentifier] NOT NULL,
	[Tag] [int] NULL,
	[AutoSend] [bit] NULL,
	[immediateSend] [bit] NULL,
	[Day] [int] NULL,
	[ArMsg] [varchar](500) NULL,
	[EnMsg] [varchar](500) NULL,
	[Note] [varchar](256) NULL,
PRIMARY KEY CLUSTERED 
(
	[Guid] ASC
)WITH (PAD_INDEX = OFF, STATISTICS_NORECOMPUTE = OFF, IGNORE_DUP_KEY = OFF, ALLOW_ROW_LOCKS = ON, ALLOW_PAGE_LOCKS = ON, OPTIMIZE_FOR_SEQUENTIAL_KEY = OFF) ON [PRIMARY]
) ON [PRIMARY]
GO
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE TABLE [dbo].[Store](
	[Number] [int] NOT NULL IDENTITY(1,1),
	[Guid] [uniqueidentifier] NOT NULL,
	[SecLvl] [int] NULL,
	[Code] [varchar](256) NULL,
	[Name] [varchar](256) NULL,
	[LtnName] [varchar](256) NULL,
	[Address] [varchar](256) NULL,
	[warehouseman] [varchar](256) NULL,
	[Note] [varchar](256) NULL,
	[ParentGuid] [uniqueidentifier] NULL,
	[AcFinalGUID] [uniqueidentifier] NULL,
PRIMARY KEY CLUSTERED 
(
	[Guid] ASC
)WITH (PAD_INDEX = OFF, STATISTICS_NORECOMPUTE = OFF, IGNORE_DUP_KEY = OFF, ALLOW_ROW_LOCKS = ON, ALLOW_PAGE_LOCKS = ON, OPTIMIZE_FOR_SEQUENTIAL_KEY = OFF) ON [PRIMARY]
) ON [PRIMARY]
GO
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE TABLE [dbo].[StrSource](
	[Ar] [varchar](256) NULL,
	[En] [varchar](256) NULL
) ON [PRIMARY]
GO
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE TABLE [dbo].[TableDescription](
	[Number] [int] IDENTITY(1,1) NOT NULL,
	[TblName] [varchar](256) NULL,
	[ArName] [varchar](256) NULL,
	[EnName] [varchar](256) NULL
) ON [PRIMARY]
GO
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE TABLE [dbo].[TableNumber](
	[TableName] [varchar](50) NULL,
	[TypeGuid] [uniqueidentifier] NULL,
	[LastNumber] [int] NULL,
	[RecCount] [int] NULL
) ON [PRIMARY]
GO
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE TABLE [dbo].[TblLangauge](
	[Spid] [int] NULL,
	[Lang] [int] NULL
) ON [PRIMARY]
GO
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE TABLE [dbo].[TblShortCut](
	[Number] [int] NOT NULL IDENTITY(1,1),
	[Guid] [uniqueidentifier] NOT NULL,
	[SecLvl] [int] NULL,
	[ItemName] [varchar](256) NULL,
	[ItemIndex] [int] NULL,
	[Kind] [int] NULL,
	[Text] [varchar](4000) NULL,
	[ShortCut] [varchar](30) NULL,
	[UserGuid] [uniqueidentifier] NULL,
PRIMARY KEY CLUSTERED 
(
	[Guid] ASC
)WITH (PAD_INDEX = OFF, STATISTICS_NORECOMPUTE = OFF, IGNORE_DUP_KEY = OFF, ALLOW_ROW_LOCKS = ON, ALLOW_PAGE_LOCKS = ON, OPTIMIZE_FOR_SEQUENTIAL_KEY = OFF) ON [PRIMARY]
) ON [PRIMARY]
GO
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE TABLE [dbo].[TblUpdateFlatSpecifications](
	[NO] [varchar](255) NULL,
	[NewNo] [varchar](255) NULL,
	[FloorNo] [varchar](255) NULL,
	[FlatKind] [varchar](255) NULL,
	[ApartmentType] [varchar](255) NULL,
	[Overlooking] [varchar](255) NULL,
	[ltnFlatKind] [varchar](255) NULL,
	[ltnApartmentType] [varchar](255) NULL,
	[ltnOverlooking] [varchar](255) NULL,
	[Class] [varchar](255) NULL,
	[Area] [float] NULL,
	[unity] [varchar](255) NULL,
	[Note] [varchar](255) NULL,
	[UnifiedNum] [varchar](256) NULL,
	[ManservantRoom] [int] NULL,
	[DriverRoom] [int] NULL,
	[CustOwnerGuid] [uniqueidentifier] NULL
) ON [PRIMARY]
GO
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE TABLE [dbo].[TblUpdateParkingSpecifications](
	[NO] [varchar](255) NULL,
	[NewNo] [varchar](255) NULL,
	[ParkingKind] [varchar](255) NULL,
	[Description] [varchar](255) NULL,
	[Overlooking] [varchar](255) NULL,
	[FloorNo] [int] NULL,
	[Area] [float] NULL,
	[unity] [varchar](255) NULL,
	[Note] [varchar](255) NULL,
	[CustGuid] [uniqueidentifier] NULL
) ON [PRIMARY]
GO
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE TABLE [dbo].[TblUpdateShopSpecifications](
	[NO] [varchar](255) NULL,
	[NewNo] [varchar](255) NULL,
	[ShopKind] [varchar](255) NULL,
	[Description] [varchar](255) NULL,
	[Overlooking] [varchar](255) NULL,
	[ltnShopKind] [varchar](255) NULL,
	[LtnDescription] [varchar](255) NULL,
	[ltnOverlooking] [varchar](255) NULL,
	[Class] [varchar](255) NULL,
	[Area] [float] NULL,
	[unity] [varchar](255) NULL,
	[Note] [varchar](255) NULL,
	[UnifiedNum] [varchar](256) NULL,
	[ManservantRoom] [int] NULL,
	[DriverRoom] [int] NULL,
	[CustGuid] [uniqueidentifier] NULL
) ON [PRIMARY]
GO
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE TABLE [dbo].[Term](
	[Old] [varchar](256) NULL,
	[New] [varchar](256) NULL,
	[Wind] [varchar](256) NULL,
 CONSTRAINT [Uk_OldTerm] UNIQUE NONCLUSTERED 
(
	[Old] ASC
)WITH (PAD_INDEX = OFF, STATISTICS_NORECOMPUTE = OFF, IGNORE_DUP_KEY = OFF, ALLOW_ROW_LOCKS = ON, ALLOW_PAGE_LOCKS = ON, OPTIMIZE_FOR_SEQUENTIAL_KEY = OFF) ON [PRIMARY]
) ON [PRIMARY]
GO
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE TABLE [dbo].[testing](
	[Number] [int] NOT NULL IDENTITY(1,1),
	[Guid] [uniqueidentifier] NOT NULL,
	[ParentGuid] [uniqueidentifier] NULL,
	[MatGuid] [uniqueidentifier] NULL,
	[Qty] [float] NULL,
	[Qty2] [float] NULL,
	[Qty3] [float] NULL,
	[Price] [float] NULL,
	[TotalPrice] [float] NULL,
	[Bonus] [float] NULL,
	[StoreGuid] [uniqueidentifier] NULL,
	[DiscountPercent] [float] NULL,
	[Discount] [float] NULL,
	[ExtraPercent] [float] NULL,
	[Extra] [float] NULL,
	[Note] [varchar](256) NULL,
	[ProductDate] [date] NULL,
	[ExpireDate] [date] NULL,
	[CostGuid] [uniqueidentifier] NULL,
	[Class] [varchar](256) NULL,
	[Length] [float] NULL,
	[width] [float] NULL,
	[height] [float] NULL,
	[Count] [float] NULL,
	[unityFact2] [float] NULL,
	[unityFact3] [float] NULL,
	[unityfix2] [bit] NULL,
	[unityfix3] [bit] NULL,
	[ItemUnit] [int] NULL,
PRIMARY KEY CLUSTERED 
(
	[Guid] ASC
)WITH (PAD_INDEX = OFF, STATISTICS_NORECOMPUTE = OFF, IGNORE_DUP_KEY = OFF, ALLOW_ROW_LOCKS = ON, ALLOW_PAGE_LOCKS = ON, OPTIMIZE_FOR_SEQUENTIAL_KEY = OFF) ON [PRIMARY]
) ON [PRIMARY]
GO
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE TABLE [dbo].[TmpCSV](
	[id] [int] IDENTITY(1,1) NOT NULL,
	[txt] [varchar](8000) NULL
) ON [PRIMARY]
GO
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE TABLE [dbo].[Trace](
	[ParentGuid] [uniqueidentifier] NULL,
	[Guid] [uniqueidentifier] NOT NULL,
	[Date] [date] NULL,
	[userGuid] [uniqueidentifier] NULL,
	[HostName] [varchar](256) NULL,
	[ParentTbl] [varchar](256) NULL,
PRIMARY KEY CLUSTERED 
(
	[Guid] ASC
)WITH (PAD_INDEX = OFF, STATISTICS_NORECOMPUTE = OFF, IGNORE_DUP_KEY = OFF, ALLOW_ROW_LOCKS = ON, ALLOW_PAGE_LOCKS = ON, OPTIMIZE_FOR_SEQUENTIAL_KEY = OFF) ON [PRIMARY]
) ON [PRIMARY]
GO
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE TABLE [dbo].[TraceDetail](
	[ParentGuid] [uniqueidentifier] NULL,
	[Caption] [varchar](256) NULL,
	[Old] [varchar](500) NULL,
	[New] [varchar](500) NULL,
	[Tbl] [varchar](50) NULL
) ON [PRIMARY]
GO
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE TABLE [dbo].[Trans](
	[Number] [int] NOT NULL IDENTITY(1,1),
	[Guid] [uniqueidentifier] NOT NULL,
	[SecLvl] [int] NULL,
	[TypeGuid] [uniqueidentifier] NULL,
	[Date] [date] NULL,
	[CurrencyGuid] [uniqueidentifier] NULL,
	[CurrencyVal] [float] NULL,
	[PayType] [int] NULL,
	[StoreOutGuid] [uniqueidentifier] NULL,
	[AcMatOutGuid] [uniqueidentifier] NULL,
	[TmpAcOutGuid] [uniqueidentifier] NULL,
	[CostOutGuid] [uniqueidentifier] NULL,
	[StoreInGuid] [uniqueidentifier] NULL,
	[AcMatInGuid] [uniqueidentifier] NULL,
	[TmpAcInGuid] [uniqueidentifier] NULL,
	[CostInGuid] [uniqueidentifier] NULL,
	[BranchGuid] [uniqueidentifier] NULL,
	[Class] [varchar](256) NULL,
	[Note] [varchar](256) NULL,
	[EntryOutGuid] [uniqueidentifier] NULL,
	[EntryInGuid] [uniqueidentifier] NULL,
	[EntryOutNumber] [int] NULL,
	[EntryInNumber] [int] NULL,
	[CheckCreateEntry] [bit] NULL,
	[IsPosted] [bit] NULL,
PRIMARY KEY CLUSTERED 
(
	[Guid] ASC
)WITH (PAD_INDEX = OFF, STATISTICS_NORECOMPUTE = OFF, IGNORE_DUP_KEY = OFF, ALLOW_ROW_LOCKS = ON, ALLOW_PAGE_LOCKS = ON, OPTIMIZE_FOR_SEQUENTIAL_KEY = OFF) ON [PRIMARY]
) ON [PRIMARY]
GO
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE TABLE [dbo].[TransDetail](
	[Number] [int] NOT NULL IDENTITY(1,1),
	[Guid] [uniqueidentifier] NOT NULL,
	[ParentGuid] [uniqueidentifier] NULL,
	[MatGuid] [uniqueidentifier] NULL,
	[Qty] [float] NULL,
	[Qty2] [float] NULL,
	[Qty3] [float] NULL,
	[Price] [float] NULL,
	[TotalPrice] [float] NULL,
	[Bonus] [float] NULL,
	[DiscountPercent] [float] NULL,
	[Discount] [float] NULL,
	[ExtraPercent] [float] NULL,
	[Extra] [float] NULL,
	[Note] [varchar](256) NULL,
	[ProductDate] [date] NULL,
	[ExpireDate] [date] NULL,
	[CostGuid] [uniqueidentifier] NULL,
	[Class] [varchar](256) NULL,
	[Length] [float] NULL,
	[width] [float] NULL,
	[height] [float] NULL,
	[Count] [float] NULL,
	[ItemUnit] [int] NULL,
PRIMARY KEY CLUSTERED 
(
	[Guid] ASC
)WITH (PAD_INDEX = OFF, STATISTICS_NORECOMPUTE = OFF, IGNORE_DUP_KEY = OFF, ALLOW_ROW_LOCKS = ON, ALLOW_PAGE_LOCKS = ON, OPTIMIZE_FOR_SEQUENTIAL_KEY = OFF) ON [PRIMARY]
) ON [PRIMARY]
GO
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE TABLE [dbo].[TransDiscount](
	[Number] [int] NOT NULL IDENTITY(1,1),
	[Guid] [uniqueidentifier] NOT NULL,
	[ParentGuid] [uniqueidentifier] NULL,
	[AccountGuid] [uniqueidentifier] NULL,
	[Discount] [float] NULL,
	[Extra] [float] NULL,
	[CurrencyGuid] [uniqueidentifier] NULL,
	[CurrencyVal] [float] NULL,
	[CostGuid] [uniqueidentifier] NULL,
	[obverseAccountGuid] [uniqueidentifier] NULL,
	[Note] [varchar](256) NULL,
PRIMARY KEY CLUSTERED 
(
	[Guid] ASC
)WITH (PAD_INDEX = OFF, STATISTICS_NORECOMPUTE = OFF, IGNORE_DUP_KEY = OFF, ALLOW_ROW_LOCKS = ON, ALLOW_PAGE_LOCKS = ON, OPTIMIZE_FOR_SEQUENTIAL_KEY = OFF) ON [PRIMARY]
) ON [PRIMARY]
GO
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE TABLE [dbo].[TransType](
	[Number] [int] NOT NULL IDENTITY(1,1),
	[Guid] [uniqueidentifier] NOT NULL,
	[SecLvl] [int] NULL,
	[Code] [varchar](256) NULL,
	[Name] [varchar](256) NULL,
	[LtnName] [varchar](256) NULL,
	[Menu] [varchar](256) NULL,
	[LtnMenu] [varchar](256) NULL,
	[ShortCut] [varchar](256) NULL,
	[DefPrintPath] [varchar](256) NULL,
	[Note] [varchar](256) NULL,
	[Color1] [float] NULL,
	[Color2] [float] NULL,
	[DefCostinGuid] [uniqueidentifier] NULL,
	[DefStoreInGuid] [uniqueidentifier] NULL,
	[DefCostOutGuid] [uniqueidentifier] NULL,
	[DefStoreOutGuid] [uniqueidentifier] NULL,
	[PostToStores] [bit] NULL,
	[PostToStoresAuto] [bit] NULL,
PRIMARY KEY CLUSTERED 
(
	[Guid] ASC
)WITH (PAD_INDEX = OFF, STATISTICS_NORECOMPUTE = OFF, IGNORE_DUP_KEY = OFF, ALLOW_ROW_LOCKS = ON, ALLOW_PAGE_LOCKS = ON, OPTIMIZE_FOR_SEQUENTIAL_KEY = OFF) ON [PRIMARY]
) ON [PRIMARY]
GO
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE TABLE [dbo].[TransTypeField](
	[TransTypeGuid] [uniqueidentifier] NULL,
	[FieldName] [varchar](256) NULL,
	[Visible] [bit] NULL
) ON [PRIMARY]
GO
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE TABLE [dbo].[TransTypePrivilege](
	[UserGuid] [uniqueidentifier] NULL,
	[TransTypeGuid] [uniqueidentifier] NULL,
	[Open] [bit] NULL,
	[Add] [bit] NULL,
	[Edit] [bit] NULL,
	[Del] [bit] NULL,
	[Print] [bit] NULL,
	[Design] [bit] NULL
) ON [PRIMARY]
GO
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE TABLE [dbo].[Tree_ParentList](
	[Spid] [int] NULL,
	[Id] [int] NULL,
	[Guid] [uniqueidentifier] NULL
) ON [PRIMARY]
GO
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE TABLE [dbo].[ucsTbl](
	[Char] [varchar](2) NULL,
	[ucs] [varchar](4) NULL,
	[UCS2] [varchar](8) NULL
) ON [PRIMARY]
GO
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE TABLE [dbo].[ucsTbl2](
	[Char] [varchar](2) NULL,
	[ucs] [varchar](10) NULL,
	[unicode] [int] NULL
) ON [PRIMARY]
GO
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE TABLE [dbo].[Villa](
	[Number] [int] NOT NULL IDENTITY(1,1),
	[Guid] [uniqueidentifier] NOT NULL,
	[SecLvl] [int] NULL,
	[Ban] [bit] NULL,
	[WaterCounter] [int] NULL,
	[ElectricityCounter] [float] NULL,
	[ComplexName] [varchar](256) NULL,
	[Emirate] [varchar](256) NULL,
	[Area] [varchar](256) NULL,
	[unity] [varchar](256) NULL,
	[Street] [varchar](256) NULL,
	[Suburb] [varchar](256) NULL,
	[PieceNo] [varchar](256) NULL,
	[BasinNo] [varchar](256) NULL,
	[VillaNo] [varchar](256) NULL,
	[DocType] [varchar](256) NULL,
	[DocNo] [varchar](256) NULL,
	[DocDate] [date] NULL,
	[VillaAccountGuid] [uniqueidentifier] NULL,
	[CashAccountGuid] [uniqueidentifier] NULL,
	[InsuranceAccountGuid] [uniqueidentifier] NULL,
	[AccountCommIncomeGuid] [uniqueidentifier] NULL,
	[CuOwnerGuid] [uniqueidentifier] NULL,
	[CostGuid] [uniqueidentifier] NULL,
	[AccountBankVillaGuid] [uniqueidentifier] NULL,
	[RentInfoGuid] [uniqueidentifier] NULL,
	[BranchGuid] [uniqueidentifier] NULL,
	[FloorCount] [int] NULL,
	[BalconyCount] [int] NULL,
	[RoomCount] [int] NULL,
	[OtherRoomCount] [int] NULL,
	[ServiceRoomCount] [int] NULL,
	[BathroomCount] [int] NULL,
	[StairsInternal] [bit] NULL,
	[RoomState] [varchar](256) NULL,
	[LandArea] [varchar](256) NULL,
	[LandAreaBuilding] [varchar](256) NULL,
	[FinishingState] [varchar](256) NULL,
	[SecurityType] [varchar](256) NULL,
	[SecuritySystem] [bit] NULL,
	[wall] [varchar](256) NULL,
	[wallState] [varchar](256) NULL,
	[lightingCount] [int] NULL,
	[ParkingCount] [int] NULL,
	[ParkingArea] [varchar](256) NULL,
	[ParkingShaded] [bit] NULL,
	[PoolCount] [int] NULL,
	[PoolState] [varchar](256) NULL,
	[PoolSystem] [varchar](256) NULL,
	[PlaygroundCount] [int] NULL,
	[PlaygroundArea] [varchar](256) NULL,
	[GardenCount] [int] NULL,
	[GardenArea] [varchar](256) NULL,
	[GardenState] [varchar](256) NULL,
	[OfferType] [int] NULL,
	[OfferState] [int] NULL,
	[Restrained] [bit] NULL,
	[RestrainedUserGuid] [uniqueidentifier] NULL,
	[CustomerName] [varchar](256) NULL,
	[CustomerPhone] [varchar](256) NULL,
	[Details] [varchar](512) NULL,
	[LtnArea] [varchar](256) NULL,
	[LtnEmirate] [varchar](256) NULL,
	[LtnSuburb] [varchar](256) NULL,
	[LtnStreet] [varchar](256) NULL,
	[LtnDocType] [varchar](256) NULL,
	[VillaOwner] [int] NULL,
PRIMARY KEY CLUSTERED 
(
	[Guid] ASC
)WITH (PAD_INDEX = OFF, STATISTICS_NORECOMPUTE = OFF, IGNORE_DUP_KEY = OFF, ALLOW_ROW_LOCKS = ON, ALLOW_PAGE_LOCKS = ON, OPTIMIZE_FOR_SEQUENTIAL_KEY = OFF) ON [PRIMARY]
) ON [PRIMARY]
GO
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE TABLE [dbo].[VillaAssets](
	[Number] [int] NOT NULL IDENTITY(1,1),
	[ParentGuid] [uniqueidentifier] NULL,
	[AssetsGuid] [uniqueidentifier] NULL,
	[Value] [float] NULL,
	[Note] [varchar](255) NULL
) ON [PRIMARY]
GO
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE TABLE [dbo].[VillaOffer](
	[Number] [int] NOT NULL IDENTITY(1,1),
	[Guid] [uniqueidentifier] NOT NULL,
	[SecLvl] [int] NULL,
	[WaterCounter] [int] NULL,
	[ElectricityCounter] [float] NULL,
	[ComplexName] [varchar](256) NULL,
	[Emirate] [varchar](256) NULL,
	[Area] [varchar](256) NULL,
	[Street] [varchar](256) NULL,
	[Suburb] [varchar](256) NULL,
	[PieceNo] [varchar](256) NULL,
	[BasinNo] [varchar](256) NULL,
	[VillaNo] [varchar](256) NULL,
	[DocType] [varchar](256) NULL,
	[DocNo] [varchar](256) NULL,
	[DocDate] [date] NULL,
	[Customer] [varchar](256) NULL,
	[Address] [varchar](256) NULL,
	[OfferKind] [int] NULL,
	[OfferValue] [float] NULL,
	[FloorCount] [int] NULL,
	[BalconyCount] [int] NULL,
	[RoomCount] [int] NULL,
	[OtherRoomCount] [int] NULL,
	[ServiceRoomCount] [int] NULL,
	[BathroomCount] [int] NULL,
	[StairsInternal] [bit] NULL,
	[RoomState] [varchar](256) NULL,
	[LandArea] [varchar](256) NULL,
	[LandAreaBuilding] [varchar](256) NULL,
	[FinishingState] [varchar](256) NULL,
	[SecurityType] [varchar](256) NULL,
	[SecuritySystem] [bit] NULL,
	[wall] [varchar](256) NULL,
	[wallState] [varchar](256) NULL,
	[lightingCount] [int] NULL,
	[ParkingCount] [int] NULL,
	[ParkingArea] [varchar](256) NULL,
	[ParkingShaded] [bit] NULL,
	[PoolCount] [int] NULL,
	[PoolState] [varchar](256) NULL,
	[PoolSystem] [varchar](256) NULL,
	[PlaygroundCount] [int] NULL,
	[PlaygroundArea] [varchar](256) NULL,
	[GardenCount] [int] NULL,
	[GardenArea] [varchar](256) NULL,
	[GardenState] [varchar](256) NULL,
	[Details] [varchar](512) NULL,
	[Delegated] [varchar](256) NULL,
	[CustPhone] [varchar](256) NULL,
	[CustMobile] [varchar](256) NULL,
	[MaxOfferValue] [float] NULL,
PRIMARY KEY CLUSTERED 
(
	[Guid] ASC
)WITH (PAD_INDEX = OFF, STATISTICS_NORECOMPUTE = OFF, IGNORE_DUP_KEY = OFF, ALLOW_ROW_LOCKS = ON, ALLOW_PAGE_LOCKS = ON, OPTIMIZE_FOR_SEQUENTIAL_KEY = OFF) ON [PRIMARY]
) ON [PRIMARY]
GO
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE TABLE [dbo].[Villawallet](
	[Number] [int] NOT NULL IDENTITY(1,1),
	[ParentGuid] [uniqueidentifier] NULL,
	[VillaGuid] [uniqueidentifier] NULL,
	[MainCost] [float] NULL,
	[Expense] [float] NULL,
	[BeginDate] [date] NULL,
	[SaleDate] [date] NULL,
	[SaleValue] [float] NULL
) ON [PRIMARY]
GO
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE TABLE [dbo].[wallet](
	[Number] [int] NOT NULL IDENTITY(1,1),
	[Guid] [uniqueidentifier] NOT NULL,
	[SecLvl] [int] NULL,
	[Code] [nvarchar](256) NULL,
	[Name] [nvarchar](256) NULL,
	[LtnName] [nvarchar](256) NULL,
	[CurrencyGUID] [uniqueidentifier] NULL,
	[CurrencyVal] [float] NULL,
	[Note] [nvarchar](256) NULL,
	[BranchGuid] [uniqueidentifier] NULL,
PRIMARY KEY CLUSTERED 
(
	[Guid] ASC
)WITH (PAD_INDEX = OFF, STATISTICS_NORECOMPUTE = OFF, IGNORE_DUP_KEY = OFF, ALLOW_ROW_LOCKS = ON, ALLOW_PAGE_LOCKS = ON, OPTIMIZE_FOR_SEQUENTIAL_KEY = OFF) ON [PRIMARY]
) ON [PRIMARY]
GO
ALTER TABLE [dbo].[Account] ADD  DEFAULT (newid()) FOR [Guid]
GO
ALTER TABLE [dbo].[AccountConformity] ADD  DEFAULT (newid()) FOR [Guid]
GO
ALTER TABLE [dbo].[Apartment] ADD  DEFAULT (newid()) FOR [Guid]
GO
ALTER TABLE [dbo].[Apartment] ADD  DEFAULT ('') FOR [CustomerName]
GO
ALTER TABLE [dbo].[Apartment] ADD  DEFAULT ('') FOR [CustomerPhone]
GO
ALTER TABLE [dbo].[ApartmentOffer] ADD  DEFAULT (newid()) FOR [Guid]
GO
ALTER TABLE [dbo].[AppReport] ADD  DEFAULT (getdate()) FOR [date]
GO
ALTER TABLE [dbo].[AppReport] ADD  DEFAULT (host_name()) FOR [HostName]
GO
ALTER TABLE [dbo].[arv_Filter] ADD  DEFAULT (newid()) FOR [Guid]
GO
ALTER TABLE [dbo].[Assets] ADD  DEFAULT ((0)) FOR [Number]
GO
ALTER TABLE [dbo].[Assets] ADD  DEFAULT (newid()) FOR [Guid]
GO
ALTER TABLE [dbo].[AssetsArea] ADD  DEFAULT ((0)) FOR [Number]
GO
ALTER TABLE [dbo].[AssetsArea] ADD  DEFAULT (newid()) FOR [Guid]
GO
ALTER TABLE [dbo].[AssetsChangeArea] ADD  DEFAULT ((0)) FOR [Number]
GO
ALTER TABLE [dbo].[AssetsChangeArea] ADD  DEFAULT (newid()) FOR [Guid]
GO
ALTER TABLE [dbo].[AssetsDepreciation] ADD  DEFAULT ((0)) FOR [Number]
GO
ALTER TABLE [dbo].[AssetsDepreciation] ADD  DEFAULT (newid()) FOR [Guid]
GO
ALTER TABLE [dbo].[AssetsDepreciation] ADD  DEFAULT ((0)) FOR [IsRounded]
GO
ALTER TABLE [dbo].[AssetsGroup] ADD  DEFAULT ((0)) FOR [Number]
GO
ALTER TABLE [dbo].[AssetsGroup] ADD  DEFAULT (newid()) FOR [Guid]
GO
ALTER TABLE [dbo].[AssetsOperation] ADD  DEFAULT ((0)) FOR [Number]
GO
ALTER TABLE [dbo].[AssetsOperation] ADD  DEFAULT (newid()) FOR [Guid]
GO
ALTER TABLE [dbo].[AssetsOperation] ADD  DEFAULT ((0)) FOR [IsRounded]
GO
ALTER TABLE [dbo].[Bill] ADD  DEFAULT (newid()) FOR [Guid]
GO
ALTER TABLE [dbo].[BillDetail] ADD  DEFAULT (newid()) FOR [Guid]
GO
ALTER TABLE [dbo].[BillDiscount] ADD  DEFAULT (newid()) FOR [Guid]
GO
ALTER TABLE [dbo].[BillOrder] ADD  DEFAULT (newid()) FOR [Guid]
GO
ALTER TABLE [dbo].[BillOrderDetail] ADD  DEFAULT (newid()) FOR [Guid]
GO
ALTER TABLE [dbo].[BillOrderRecipient] ADD  DEFAULT (newid()) FOR [Guid]
GO
ALTER TABLE [dbo].[BillType] ADD  DEFAULT (newid()) FOR [Guid]
GO
ALTER TABLE [dbo].[Branch] ADD  DEFAULT ((0)) FOR [Number]
GO
ALTER TABLE [dbo].[Branch] ADD  DEFAULT (newid()) FOR [Guid]
GO
ALTER TABLE [dbo].[BrowsCard] ADD  DEFAULT ('') FOR [ComputerName]
GO
ALTER TABLE [dbo].[BrowsCard] ADD  DEFAULT ((0)) FOR [CheckRefrech]
GO
ALTER TABLE [dbo].[Building] ADD  DEFAULT (newid()) FOR [Guid]
GO
ALTER TABLE [dbo].[BuildingAssets] ADD  DEFAULT ((0)) FOR [Number]
GO
ALTER TABLE [dbo].[BuildingGuard] ADD  DEFAULT (newid()) FOR [Guid]
GO
ALTER TABLE [dbo].[BuildingOffer] ADD  DEFAULT (newid()) FOR [Guid]
GO
ALTER TABLE [dbo].[BuildingPayType] ADD  DEFAULT (newid()) FOR [Guid]
GO
ALTER TABLE [dbo].[BuildingRecElecCounter] ADD  DEFAULT (newid()) FOR [Guid]
GO
ALTER TABLE [dbo].[CalcQty] ADD  DEFAULT (newid()) FOR [Guid]
GO
ALTER TABLE [dbo].[ChangeCurrencyRate] ADD  DEFAULT (newid()) FOR [Guid]
GO
ALTER TABLE [dbo].[Checks] ADD  DEFAULT (newid()) FOR [Guid]
GO
ALTER TABLE [dbo].[Checks] ADD  DEFAULT ((0)) FOR [IsRounded]
GO
ALTER TABLE [dbo].[ChecksCollection] ADD  DEFAULT ((0)) FOR [IsRounded]
GO
ALTER TABLE [dbo].[ChecksCollection] ADD  DEFAULT ((1)) FOR [OperationCreateEntry]
GO
ALTER TABLE [dbo].[ChecksCollection] ADD  DEFAULT ((1)) FOR [ReturnCreateEntry]
GO
ALTER TABLE [dbo].[ChecksCollection] ADD  DEFAULT ((1)) FOR [CommCreateEntry]
GO
ALTER TABLE [dbo].[ChecksPartialCollection] ADD  DEFAULT (newid()) FOR [Guid]
GO
ALTER TABLE [dbo].[ChecksPartialCollection] ADD  DEFAULT ((0)) FOR [IsRounded]
GO
ALTER TABLE [dbo].[CheckType] ADD  DEFAULT ((0)) FOR [Number]
GO
ALTER TABLE [dbo].[CheckType] ADD  DEFAULT (newid()) FOR [Guid]
GO
ALTER TABLE [dbo].[CheckType] ADD  DEFAULT ('') FOR [Menu]
GO
ALTER TABLE [dbo].[Complaint] ADD  DEFAULT ((0)) FOR [Number]
GO
ALTER TABLE [dbo].[Complaint] ADD  DEFAULT (newid()) FOR [Guid]
GO
ALTER TABLE [dbo].[ContractFlatAssets] ADD  DEFAULT ((0)) FOR [Number]
GO
ALTER TABLE [dbo].[ContractLandAssets] ADD  DEFAULT ((0)) FOR [Number]
GO
ALTER TABLE [dbo].[ContractType] ADD  DEFAULT (newid()) FOR [Guid]
GO
ALTER TABLE [dbo].[ContractWorkFlow] ADD  DEFAULT ((0)) FOR [Number]
GO
ALTER TABLE [dbo].[ContractWorkFlow] ADD  DEFAULT (newid()) FOR [Guid]
GO
ALTER TABLE [dbo].[Cost] ADD  DEFAULT (newid()) FOR [Guid]
GO
ALTER TABLE [dbo].[Currency] ADD  DEFAULT (newid()) FOR [Guid]
GO
ALTER TABLE [dbo].[CurrentUsers] ADD  DEFAULT (@@spid) FOR [Spid]
GO
ALTER TABLE [dbo].[Customer] ADD  DEFAULT (newid()) FOR [Guid]
GO
ALTER TABLE [dbo].[Customer] ADD  DEFAULT ((0)) FOR [CardKind]
GO
ALTER TABLE [dbo].[Customer] ADD  DEFAULT ((0)) FOR [CustKind]
GO
ALTER TABLE [dbo].[DEntry] ADD  DEFAULT (newid()) FOR [Guid]
GO
ALTER TABLE [dbo].[DEntry] ADD  DEFAULT ((1)) FOR [IsVisible]
GO
ALTER TABLE [dbo].[DMD_const] ADD  DEFAULT ('') FOR [VName]
GO
ALTER TABLE [dbo].[DMD_const] ADD  DEFAULT ('') FOR [Value]
GO
ALTER TABLE [dbo].[Earth] ADD  DEFAULT (newid()) FOR [Guid]
GO
ALTER TABLE [dbo].[ElectricityBill] ADD  DEFAULT (newid()) FOR [Guid]
GO
ALTER TABLE [dbo].[ElectricityType] ADD  DEFAULT ((0)) FOR [Number]
GO
ALTER TABLE [dbo].[ElectricityType] ADD  DEFAULT (newid()) FOR [Guid]
GO
ALTER TABLE [dbo].[EntryDateType] ADD  DEFAULT ((0)) FOR [Number]
GO
ALTER TABLE [dbo].[EntryDateType] ADD  DEFAULT (newid()) FOR [Guid]
GO
ALTER TABLE [dbo].[EntryType] ADD  DEFAULT ((0)) FOR [Number]
GO
ALTER TABLE [dbo].[EntryType] ADD  DEFAULT (newid()) FOR [Guid]
GO
ALTER TABLE [dbo].[ExternalTools] ADD  DEFAULT (newid()) FOR [Guid]
GO
ALTER TABLE [dbo].[FlatAssets] ADD  DEFAULT ((0)) FOR [Number]
GO
ALTER TABLE [dbo].[FlatContractFee] ADD  DEFAULT (newid()) FOR [Guid]
GO
ALTER TABLE [dbo].[FlatContractReceiptNO] ADD  DEFAULT ((0)) FOR [Number]
GO
ALTER TABLE [dbo].[FlatContractReceiptNO] ADD  DEFAULT (newid()) FOR [Guid]
GO
ALTER TABLE [dbo].[HEntry] ADD  DEFAULT ((0)) FOR [ParentKind]
GO
ALTER TABLE [dbo].[HEntry] ADD  DEFAULT ((0)) FOR [IsPosted]
GO
ALTER TABLE [dbo].[IncAccount] ADD  DEFAULT (newid()) FOR [Guid]
GO
ALTER TABLE [dbo].[IncomeSaved] ADD  DEFAULT ((0)) FOR [Number]
GO
ALTER TABLE [dbo].[IncomeSaved] ADD  DEFAULT (newid()) FOR [Guid]
GO
ALTER TABLE [dbo].[IncomeSaved] ADD  DEFAULT (getdate()) FOR [Date]
GO
ALTER TABLE [dbo].[LandContract] ADD  DEFAULT (newid()) FOR [Guid]
GO
ALTER TABLE [dbo].[LandContract] ADD  DEFAULT ((0)) FOR [IsRounded]
GO
ALTER TABLE [dbo].[LandContractFee] ADD  DEFAULT (newid()) FOR [Guid]
GO
ALTER TABLE [dbo].[LandContractReceiptNO] ADD  DEFAULT ((0)) FOR [Number]
GO
ALTER TABLE [dbo].[LandContractReceiptNO] ADD  DEFAULT (newid()) FOR [Guid]
GO
ALTER TABLE [dbo].[LandOffer] ADD  DEFAULT (newid()) FOR [Guid]
GO
ALTER TABLE [dbo].[Lawsuit] ADD  DEFAULT ((0)) FOR [Number]
GO
ALTER TABLE [dbo].[Lawsuit] ADD  DEFAULT (newid()) FOR [Guid]
GO
ALTER TABLE [dbo].[LawsuitExpense] ADD  DEFAULT ((0)) FOR [Number]
GO
ALTER TABLE [dbo].[LawsuitExpense] ADD  DEFAULT (newid()) FOR [Guid]
GO
ALTER TABLE [dbo].[LawsuitExpense] ADD  DEFAULT ((0)) FOR [IsRounded]
GO
ALTER TABLE [dbo].[LawsuitState] ADD  DEFAULT ((0)) FOR [Number]
GO
ALTER TABLE [dbo].[LawsuitState] ADD  DEFAULT (newid()) FOR [Guid]
GO
ALTER TABLE [dbo].[LeaseApartment] ADD  DEFAULT (newid()) FOR [Guid]
GO
ALTER TABLE [dbo].[LeaseApartment] ADD  DEFAULT ((0)) FOR [IsRounded]
GO
ALTER TABLE [dbo].[LinkCe] ADD  DEFAULT (newid()) FOR [Guid]
GO
ALTER TABLE [dbo].[ListOrderTypeGroups] ADD  DEFAULT (@@spid) FOR [Spid]
GO
ALTER TABLE [dbo].[LockCard] ADD  DEFAULT ('') FOR [ComputerName]
GO
ALTER TABLE [dbo].[LogFile] ADD  DEFAULT ('') FOR [Username]
GO
ALTER TABLE [dbo].[LogFile] ADD  DEFAULT ('') FOR [ComputerName]
GO
ALTER TABLE [dbo].[LogFile] ADD  DEFAULT ((0)) FOR [CardId]
GO
ALTER TABLE [dbo].[LogFile] ADD  DEFAULT (getdate()) FOR [ODate]
GO
ALTER TABLE [dbo].[LogFile] ADD  DEFAULT ('') FOR [Opration]
GO
ALTER TABLE [dbo].[LogFile] ADD  DEFAULT ('') FOR [Note]
GO
ALTER TABLE [dbo].[MaintenanceContract] ADD  DEFAULT (newid()) FOR [Guid]
GO
ALTER TABLE [dbo].[MaintenanceContract] ADD  DEFAULT ((0)) FOR [IsRounded]
GO
ALTER TABLE [dbo].[MaintenanceContractType] ADD  DEFAULT (newid()) FOR [Guid]
GO
ALTER TABLE [dbo].[MaintenanceContractVisit] ADD  DEFAULT (newid()) FOR [Guid]
GO
ALTER TABLE [dbo].[MaintenanceItem] ADD  DEFAULT (newid()) FOR [Guid]
GO
ALTER TABLE [dbo].[MaintenanceOrder] ADD  DEFAULT ((0)) FOR [Number]
GO
ALTER TABLE [dbo].[MaintenanceOrder] ADD  DEFAULT (newid()) FOR [Guid]
GO
ALTER TABLE [dbo].[MaintenanceWorker] ADD  DEFAULT ((0)) FOR [Number]
GO
ALTER TABLE [dbo].[MaintenanceWorker] ADD  DEFAULT (newid()) FOR [Guid]
GO
ALTER TABLE [dbo].[MapsConfig] ADD  DEFAULT (newid()) FOR [Guid]
GO
ALTER TABLE [dbo].[MapsObject] ADD  DEFAULT (newid()) FOR [Guid]
GO
ALTER TABLE [dbo].[Mat] ADD  DEFAULT (newid()) FOR [Guid]
GO
ALTER TABLE [dbo].[MatGroup] ADD  DEFAULT (newid()) FOR [Guid]
GO
ALTER TABLE [dbo].[MsgTbl] ADD  DEFAULT (newid()) FOR [Guid]
GO
ALTER TABLE [dbo].[MsgTbl] ADD  DEFAULT (getdate()) FOR [Date]
GO
ALTER TABLE [dbo].[OfferPrice] ADD  DEFAULT ((0)) FOR [Number]
GO
ALTER TABLE [dbo].[OfferPrice] ADD  DEFAULT (newid()) FOR [Guid]
GO
ALTER TABLE [dbo].[OfferPrice] ADD  DEFAULT (getdate()) FOR [Date]
GO
ALTER TABLE [dbo].[OnlyCheck] ADD  DEFAULT (@@spid) FOR [Spid]
GO
ALTER TABLE [dbo].[OrderType] ADD  DEFAULT (newid()) FOR [Guid]
GO
ALTER TABLE [dbo].[Owner] ADD  DEFAULT (newid()) FOR [Guid]
GO
ALTER TABLE [dbo].[OwnerUnionFee] ADD  DEFAULT (newid()) FOR [Guid]
GO
ALTER TABLE [dbo].[FlatBuildingDetails] ADD  DEFAULT (newid()) FOR [Guid]
GO
ALTER TABLE [dbo].[parking] ADD  DEFAULT (newid()) FOR [Guid]
GO
ALTER TABLE [dbo].[parking] ADD  DEFAULT ('') FOR [CustomerName]
GO
ALTER TABLE [dbo].[parking] ADD  DEFAULT ('') FOR [CustomerPhone]
GO
ALTER TABLE [dbo].[ParkingContract] ADD  DEFAULT (newid()) FOR [Guid]
GO
ALTER TABLE [dbo].[ParkingContract] ADD  DEFAULT ((0)) FOR [IsRounded]
GO
ALTER TABLE [dbo].[ParkingContractFee] ADD  DEFAULT (newid()) FOR [Guid]
GO
ALTER TABLE [dbo].[ParkingContractReceiptNO] ADD  DEFAULT ((0)) FOR [Number]
GO
ALTER TABLE [dbo].[ParkingContractReceiptNO] ADD  DEFAULT (newid()) FOR [Guid]
GO
ALTER TABLE [dbo].[Photos] ADD  DEFAULT (newid()) FOR [Guid]
GO
ALTER TABLE [dbo].[Pricing] ADD  DEFAULT ((0)) FOR [Number]
GO
ALTER TABLE [dbo].[Pricing] ADD  DEFAULT (newid()) FOR [Guid]
GO
ALTER TABLE [dbo].[PricingDetail] ADD  DEFAULT ((-1)) FOR [Number]
GO
ALTER TABLE [dbo].[Progress_Tbl] ADD  DEFAULT (@@spid) FOR [Spid]
GO
ALTER TABLE [dbo].[Progress_Tbl] ADD  DEFAULT (getdate()) FOR [Time]
GO
ALTER TABLE [dbo].[ProjectCostDetail] ADD  DEFAULT (newid()) FOR [Guid]
GO
ALTER TABLE [dbo].[pRun] ADD  DEFAULT (getdate()) FOR [Date]
GO
ALTER TABLE [dbo].[QtyGroup] ADD  DEFAULT (newid()) FOR [Guid]
GO
ALTER TABLE [dbo].[Realty_Detail_users] ADD  DEFAULT ((-1)) FOR [Number]
GO
ALTER TABLE [dbo].[Realty_Detail_users] ADD  DEFAULT ((0)) FOR [IdCard]
GO
ALTER TABLE [dbo].[Realty_LogCard] ADD  DEFAULT ('') FOR [ComputerName]
GO
ALTER TABLE [dbo].[Realty_LogCard] ADD  DEFAULT ((0)) FOR [CardId]
GO
ALTER TABLE [dbo].[Realty_LogCard] ADD  DEFAULT (getdate()) FOR [Date]
GO
ALTER TABLE [dbo].[Realty_LogCard] ADD  DEFAULT ('') FOR [Opration]
GO
ALTER TABLE [dbo].[Realty_LogCard] ADD  DEFAULT ('') FOR [Note]
GO
ALTER TABLE [dbo].[Realty_Users] ADD  DEFAULT ((0)) FOR [Number]
GO
ALTER TABLE [dbo].[Realty_Users] ADD  DEFAULT (newid()) FOR [Guid]
GO
ALTER TABLE [dbo].[Realty_Users] ADD  DEFAULT ('') FOR [Password]
GO
ALTER TABLE [dbo].[Realty_Users] ADD  DEFAULT ((0)) FOR [bAdmin]
GO
ALTER TABLE [dbo].[RealtyRestrained] ADD  DEFAULT (newid()) FOR [Guid]
GO
ALTER TABLE [dbo].[ReceiptOrder] ADD  DEFAULT ((0)) FOR [Number]
GO
ALTER TABLE [dbo].[ReceiptOrder] ADD  DEFAULT (newid()) FOR [Guid]
GO
ALTER TABLE [dbo].[ReceiptOrderDetail] ADD  DEFAULT ((0)) FOR [Number]
GO
ALTER TABLE [dbo].[ReceiptOrderDetail] ADD  DEFAULT (newid()) FOR [Guid]
GO
ALTER TABLE [dbo].[ReceiptOrderType] ADD  DEFAULT ((0)) FOR [Number]
GO
ALTER TABLE [dbo].[ReceiptOrderType] ADD  DEFAULT (newid()) FOR [Guid]
GO
ALTER TABLE [dbo].[ReceiptOrderTypeDetail] ADD  DEFAULT ((0)) FOR [Number]
GO
ALTER TABLE [dbo].[Reminder] ADD  DEFAULT (newid()) FOR [Guid]
GO
ALTER TABLE [dbo].[Reminder] ADD  DEFAULT ((0)) FOR [Finished]
GO
ALTER TABLE [dbo].[RentInfo] ADD  DEFAULT (newid()) FOR [Guid]
GO
ALTER TABLE [dbo].[Resource] ADD  DEFAULT (@@spid) FOR [Spid]
GO
ALTER TABLE [dbo].[Resource] ADD  DEFAULT ((0)) FOR [Kind]
GO
ALTER TABLE [dbo].[Resource] ADD  DEFAULT ((0)) FOR [Tag]
GO
ALTER TABLE [dbo].[Salesman] ADD  DEFAULT (newid()) FOR [Guid]
GO
ALTER TABLE [dbo].[Secondary_Entry] ADD  DEFAULT ((0)) FOR [IsRounded]
GO
ALTER TABLE [dbo].[ServicesContract] ADD  DEFAULT (newid()) FOR [Guid]
GO
ALTER TABLE [dbo].[ServicesContract] ADD  DEFAULT ((0)) FOR [IsRounded]
GO
ALTER TABLE [dbo].[ServicesContractType] ADD  DEFAULT (newid()) FOR [Guid]
GO
ALTER TABLE [dbo].[Shop] ADD  DEFAULT (newid()) FOR [Guid]
GO
ALTER TABLE [dbo].[ShopAssets] ADD  DEFAULT ((0)) FOR [Number]
GO
ALTER TABLE [dbo].[ShopOffer] ADD  DEFAULT (newid()) FOR [Guid]
GO
ALTER TABLE [dbo].[SMSInfo] ADD  DEFAULT (newid()) FOR [Guid]
GO
ALTER TABLE [dbo].[SMSLog] ADD  DEFAULT (getdate()) FOR [Date]
GO
ALTER TABLE [dbo].[SMSLog] ADD  DEFAULT (host_name()) FOR [Host_Name]
GO
ALTER TABLE [dbo].[SMSSetup] ADD  DEFAULT (newid()) FOR [Guid]
GO
ALTER TABLE [dbo].[Store] ADD  DEFAULT (newid()) FOR [Guid]
GO
ALTER TABLE [dbo].[TblShortCut] ADD  DEFAULT (newid()) FOR [Guid]
GO
ALTER TABLE [dbo].[testing] ADD  DEFAULT (newid()) FOR [Guid]
GO
ALTER TABLE [dbo].[Trace] ADD  DEFAULT (newid()) FOR [Guid]
GO
ALTER TABLE [dbo].[Trans] ADD  DEFAULT (newid()) FOR [Guid]
GO
ALTER TABLE [dbo].[TransDetail] ADD  DEFAULT (newid()) FOR [Guid]
GO
ALTER TABLE [dbo].[TransDiscount] ADD  DEFAULT (newid()) FOR [Guid]
GO
ALTER TABLE [dbo].[TransType] ADD  DEFAULT (newid()) FOR [Guid]
GO
ALTER TABLE [dbo].[Tree_ParentList] ADD  DEFAULT (@@spid) FOR [Spid]
GO
ALTER TABLE [dbo].[Villa] ADD  DEFAULT ((0)) FOR [Number]
GO
ALTER TABLE [dbo].[Villa] ADD  DEFAULT (newid()) FOR [Guid]
GO
ALTER TABLE [dbo].[VillaAssets] ADD  DEFAULT ((0)) FOR [Number]
GO
ALTER TABLE [dbo].[VillaOffer] ADD  DEFAULT ((0)) FOR [Number]
GO
ALTER TABLE [dbo].[VillaOffer] ADD  DEFAULT (newid()) FOR [Guid]
GO
ALTER TABLE [dbo].[wallet] ADD  DEFAULT (newid()) FOR [Guid]
GO

Create Procedure [dbo].[PrcCreateLawsuitEntry]
(
	@Guid uniqueidentifier = '{EBDF23D5-26CF-46DB-84AD-D3589FC8CAF7}'
)

as
	Set Nocount on 
	Declare @EntryGuid1 uniqueidentifier
	
	Select
		@EntryGuid1 = [EntryGuid1]
	From
		[Lawsuit]
	where
		Guid = @Guid
			
	if @EntryGuid1 is Null
	begin
		Set @EntryGuid1 = NEWID()
		update [Lawsuit] Set [EntryGuid1] = @EntryGuid1 where Guid = @Guid
	end
	
	Declare @CeNumber Int
	Select
		@CeNumber = [Number]
	From
		HEntry
	where
		Guid = @EntryGuid1
		
	if isNull(@CeNumber,0) = 0
	Set @CeNumber = (Select isNull(MAX(Number),0) + 1 From HEntry)

	Delete
		HEntry
	where
		Guid = @EntryGuid1
		
	if Not exists(
		Select Top 1 Guid 
		from 
			[Lawsuit] 
		where 
			Guid = @Guid 
			and LawyerEntry = 1 
			and LawyerRent <> 0
				) 
	return				

	Declare @CostGuid uniqueidentifier
	Select
		@CostGuid = [UnitCostGuid]
	from
		[vwAllContract] C
		inner join Lawsuit L on L.ContractGuid = C.Guid
	where
		L.Guid = @Guid
		
	Insert Into [HEntry]
	([Guid],[SecLvl],[Number],[Date], [CurrencyGuid], [CurrencyVal], [Note], [ParentKind], [BranchGuid], [IsPosted])
	Select
		@EntryGuid1,
		[SecLvl],
		@CeNumber,
		[LawyerRentDate],
		[CurrencyGuid],
		[CurrencyVal],
		[Note],
		157,
		Null,
		1
	From
		[Lawsuit]
	where
		Guid = @Guid

	Declare @DetailNum Int
	Set @DetailNum = 0

	Set @DetailNum = @DetailNum + 1
	Insert into [DEntry]
 	([ParentGuid],[Number],[AcGuid],[Debit],[Credit],[CurrencyGuid],[CurrencyVal],[CostGuid],[ObverseAcGuid],[Note])
	Select
		@EntryGuid1,
		@DetailNum,
		[LawyerDebitAccountGuid],
		A.LawyerRent,
		0,
		A.CurrencyGUID,
		A.CurrencyVal,
		@CostGuid as [debitCostGuid],
		[LawyerCreditAccountGuid],
		A.LawyerNote
	From
		[Lawsuit] A
	where
		A.[Guid] = @Guid
		and LawyerEntry = 1
		and LawyerRent <> 0
		
		
	Set @DetailNum = @DetailNum + 1
	Insert into [DEntry]
 	([ParentGuid],[Number],[AcGuid],[Debit],[Credit],[CurrencyGuid],[CurrencyVal],[CostGuid],[ObverseAcGuid],[Note])
	Select
		@EntryGuid1,
		@DetailNum,
		[LawyerCreditAccountGuid],
		0,
		A.LawyerRent,
		A.CurrencyGUID,
		A.CurrencyVal,
		@CostGuid as [debitCostGuid],
		[LawyerDebitAccountGuid],
		A.LawyerNote
	From
		[Lawsuit] A
	where
		A.[Guid] = @Guid
		and LawyerEntry = 1
		and LawyerRent <> 0

	update [HEntry] Set isPosted = 1 where Guid = @Guid
	
	Select * from [HEntry] where Guid = @Guid
	Select * from [DEntry] where parentGuid = @Guid
			

GO

SET ANSI_NULLS, QUOTED_IDENTIFIER ON
GO

Create Procedure [dbo].[PrcUpdateNameCostChild]
(
	@BuildingGuid uniqueidentifier = 'B49C15C4-7419-453D-AEB9-60C2475A9A14',
	@NewName Varchar(256) = '',
	@NewLtnName Varchar(256) = 'Karfan'
)
 
as
	Declare @OldName Varchar(256),
			@OldLtnName Varchar(256),
			@BuildingCostGuid uniqueidentifier
			
	Select 
		@OldName = [Name],
		@OldLtnName = [ltnName],
		@BuildingCostGuid = CostGuid
	From 
		[Building]
	where
		Guid = @BuildingGuid
		
	if IsNull(@BuildingCostGuid,0x0) = 0x0
	return
	
	
	Update
		[Cost]
	Set
		Name = REPLACE(Name, @OldName, @NewName),
		LtnName = REPLACE(LtnName, @OldLtnName, @NewLtnName)
	From	
		Cost C
		inner join dbo.fnGetCostList(@BuildingCostGuid) L on L.GUID = C.Guid
	where
		L.GUID <> @BuildingCostGuid
		

GO

SET ANSI_NULLS, QUOTED_IDENTIFIER ON
GO

Create Trigger [TRG_SetUser]
on [HEntry]
 
For insert
As
	update [Hentry] Set [userGuid] = (Select Top  1 [UserGuid] From CurrentUsers where [spid] = @@spid)
	From
		[Hentry] [H],[inserted] [I]
	where [H].[Guid] = [I].[Guid]

GO

SET ANSI_NULLS, QUOTED_IDENTIFIER ON
GO
Create View vwMaintenanceContractMaintenanceItem
 
as
	Select
		I.Name,
		a.*
	From
		[MaintenanceContractMaintenanceItem] [a]
		inner join MaintenanceItem [I] on [I].Guid = [a].MaintenanceItemGuid

GO

SET ANSI_NULLS, QUOTED_IDENTIFIER ON
GO

Create Procedure [PrcTestLandUsed2]
(
	@MotherLandGuid uniqueidentifier = '773E9079-47D2-48E4-BF75-EB5EE596ACEC',
	@Date1 DateTime = '10/1/2007',
	@Date2 DateTime = '10/1/2009'
)
 
as
	Select
		[L].*,
		Case when [ContractFinish] = 0 then [ToDate] else [ContractFinishDate]  end as [EndDate]
	into #Contract
	From
		[LandContract] [L]
		inner join [AccumulateLand] [A] on [A].[LandGuid] = [L].[LandGuid]
	where 
		([A].[ParentGuid] = @MotherLandGuid)		

		
	Select 
		[L].[Number],
		[T].[Name] as [ContractName],
		[L].[FromDate],
		[L].[ToDate],
		[T].[ContractKind],
		[L].[LandGuid],
		[L].[Guid]
	From 
		#Contract [L] 
		inner join [ContractType] [T] On [T].[Guid] = [L].[TypeGuid]
		inner join [AccumulateLand] [A] on [A].[LandGuid] = [L].[LandGuid]
	where 
		([A].[ParentGuid] = @MotherLandGuid)		
		and 
		(
				(
					[ContractKind] = 8
					and	(
							([FromDate] <= @Date1 )
						 or ([FromDate] <= @Date2 )
						)
				)
				or 
				(
					[ContractKind] = 6
					and	(
							(
								  (@Date1 between [FromDate] and [EndDate])
								or(@Date2 between [FromDate] and [EndDate])
								or([FromDate] between @Date1 and @Date2)
								or([EndDate] between @Date1 and @Date2)
							)
						)
				)

			)
			

GO

SET ANSI_NULLS, QUOTED_IDENTIFIER ON
GO
Create View [vwLastParkingRentPrice]
 
as
	Select 
		[C].[ParentGuid],
		[Price] as [Rent],
		[CurrencyGuid] as [RentCurrencyGuid]
	From
		[ChangeParkingRent] [C]
		inner join (
						Select 
								[ParentGuid],
								Max(Date) as [MaxDate],
								Max([Number]) as [MaxNumber]
						From
							[ChangeParkingRent]
						Group By
							[ParentGuid]
					) [C2] on [C2].[ParentGuid] = [C].[ParentGuid] 
							and [C].[Date] = [C2].[MaxDate] 
							and (Case when [C].[Date] = [C2].[MaxDate] then [MaxNumber] else [C].[Number] end = [C].[Number])

GO

SET ANSI_NULLS, QUOTED_IDENTIFIER ON
GO

	Create View [vbIncAccount]
	 
	as
		Select 
			[T].*
		From
			[IncAccount] [T]
			inner join [CurrentUsers] [U] on ([u].[Seclvl] >= Isnull([T].[SecLvl],0)  or [u].[Admin] = 1) and [u].[spid] = @@Spid
GO

SET ANSI_NULLS, QUOTED_IDENTIFIER ON
GO

Create Procedure [dbo].[PrcAccountsChart]
(
	@AccountGuid uniqueidentifier = '3D2B933E-C93D-49E8-A9C0-8DC4FAA91850',
	@CostGuid [uniqueidentifier]= 0x0,
	@CurrencyGuid [uniqueidentifier] = '11111111-C748-4B13-8B91-1E9B299DF1C1',
	@CurrencyVal Float = 1,
	@CalcKind int = 0,
	@InstType int = 1, --0  Day 1 w 2 m
	@Date1 DateTime = '1/1/2007',
	@Date2 DateTime = '1/1/2018'
)
 
as
	Select * Into #fnGetAccountList_GL from [dbo].[fnGetAccountList](@AccountGuid)

	Select O.* 
	Into #fnGetCostList_GL 
	from 
		[dbo].[fnGetCostList](@CostGuid) C
		inner join [Cost] O on O.Guid = C.GUID
	
	Select 
		Case 
			when @InstType = 0 then dbo.FnFormatNumber( Datepart(day,[H_Date]),2)+'-'+dbo.FnFormatNumber( Datepart(Month,[H_Date]),2)
			when @InstType = 1 then dbo.FnFormatNumber( Datepart(wk,[H_Date]),2)
			when @InstType = 2 then dbo.FnFormatNumber( Datepart(Month,[H_Date]),2)
		end as [Date],
		
		Case 
			when @CalcKind = 0 then 
			Isnull(Sum(case when ([En].[D_Debit] - [En].[D_Credit]) <> 0 then ([En].[D_Debit] - [En].[D_Credit]) * 
				Case when [En].[D_CurrencyGuid] = @CurrencyGuid then 1 
				else [En].[D_CurrencyVal] / @CurrencyVal end
			end),0) 

			when @CalcKind = 1 then 
			Isnull(Sum(case when ([En].[D_Credit] - [En].[D_Debit]) <> 0 then ([En].[D_Credit] - [En].[D_Debit]) * 
				Case when [En].[D_CurrencyGuid] = @CurrencyGuid then 1 
				else [En].[D_CurrencyVal] / @CurrencyVal end
			end),0) 
		end as Balance
	From 
		[vwOldYearEntry] En
		inner Join #fnGetAccountList_GL [Ac] on [Ac].[Guid] = [En].[D_AcGuid]
		left Join #fnGetCostList_GL [Co2] on [Co2].[Guid] = [En].[D_CostGuid]
	where
		(H_Date between @Date1 and @Date2)
		and ([Co2].[Guid] Is Not Null or @CostGuid = 0x0)
	Group by
		Case 
			when @InstType = 0 then dbo.FnFormatNumber( Datepart(day,[H_Date]),2)+'-'+dbo.FnFormatNumber( Datepart(Month,[H_Date]),2)
			when @InstType = 1 then dbo.FnFormatNumber( Datepart(wk,[H_Date]),2)
			when @InstType = 2 then dbo.FnFormatNumber( Datepart(Month,[H_Date]),2)
		end
	order by
		Case 
			when @InstType = 0 then dbo.FnFormatNumber( Datepart(day,[H_Date]),2)+'-'+dbo.FnFormatNumber( Datepart(Month,[H_Date]),2)
			when @InstType = 1 then dbo.FnFormatNumber( Datepart(wk,[H_Date]),2)
			when @InstType = 2 then dbo.FnFormatNumber( Datepart(Month,[H_Date]),2)
		end

GO

SET ANSI_NULLS, QUOTED_IDENTIFIER ON
GO

Create view [vwLandOffer]
 
as
	Select 
		[Number], [Guid], [SecLvl], [LandNo], [ltnName], [Customer], 
		[Address], [OfferKind], [OfferValue], [City], [Region], [Space], 
		[Area], [Unity], [license], [Details], [LandType], [Side], [StreetCount], [Buildble]
		,Case when (dbo.FnGetLangauge(@@spid) = 1) and (Isnull([A].[LtnName],'') <> '') then [A].[LtnName] else [A].[Name] end as [Name]
	From
		[vbLandOffer] [A]
		

GO

SET ANSI_NULLS, QUOTED_IDENTIFIER ON
GO

CREATE FUNCTION [FnFormatNumber] (@Number int, @digit int)
RETURNS Varchar(256)
 
AS
BEGIN
	Declare @R Varchar(256)
	Set @R = ''

	while (len(@Number) < @digit )
	begin
		Set @R = @R+'0'
		Set @digit = @digit -1
	end
	
	Set @R = @R + Cast(@Number as Varchar(256))

	RETURN @R
END

GO

SET ANSI_NULLS, QUOTED_IDENTIFIER ON
GO

	Create View [vbTransType]
	 
	as
		Select 
			[T].*
		From
			[TransType] [T]
			inner join [CurrentUsers] [U] on ([u].[Seclvl] >= Isnull([T].[SecLvl],0)  or [u].[Admin] = 1) and [u].[spid] = @@Spid
GO

SET ANSI_NULLS, QUOTED_IDENTIFIER ON
GO

Create Procedure PrcTestEntrys

as

	Select 
		H.[Number], 
		Sum(d.Debit * D.CurrencyVal)- Sum(d.Credit * D.CurrencyVal) As Diff 
	From 
		DEntry D
		inner join HEntry H On H.[Guid] = [D].[ParentGuid] and D.AcGuid is Not Null
	Group By
		H.[Number]
	Having Sum(d.Debit * D.CurrencyVal)- Sum(d.Credit * D.CurrencyVal) > 0.01


GO

SET ANSI_NULLS, QUOTED_IDENTIFIER ON
GO
CREATE FUNCTION [dbo].[fnObjectExists]
(
	@ObjectName [VARCHAR](128)
) 
RETURNS [INT] 
 
AS BEGIN 
/* 
	This function 
	- searches in sysobjects for a given object in current db, including visible temporary tables. 
	- @ObjectName examples 
		- trg_general 
		- account 
		- Account.GUID 
		- #Result 
		- #Result.Security 
	- returns 1 if founded, 0 if not. 
*/ 
	DECLARE @i [INT] 
	-- remove Full-Brackets if any 
	SET @ObjectName = REPLACE(REPLACE(@ObjectName, ']', ''), '[', '') 
	SET @i = CHARINDEX('.', @ObjectName) 
	IF @ObjectName LIKE '#%' 
		IF @i = 0 
			IF EXISTS(SELECT * FROM [tempdb]..[sysobjects] WHERE [id] = OBJECT_ID('tempdb..' + @ObjectName)) 
				RETURN 1 
			ELSE 
				RETURN 0 
		ELSE 
			IF EXISTS(SELECT * FROM [tempdb]..[syscolumns] WHERE [id] = OBJECT_ID('tempdb..' + LEFT(@ObjectName, @i - 1)) AND [name] = SUBSTRING(@ObjectName, @i + 1, 128)) 
				RETURN 1 
			ELSE 
				RETURN 0 
	ELSE 
		IF @i = 0 
			IF EXISTS(SELECT * FROM [sysobjects] WHERE [ID] = OBJECT_ID (@ObjectName)) 
				RETURN 1 
			ELSE 
				RETURN 0 
		ELSE 
			IF EXISTS(SELECT * FROM [syscolumns] WHERE [id] = OBJECT_ID(LEFT(@ObjectName, @i - 1)) AND [name] = SUBSTRING(@ObjectName, @i + 1, 128)) 
				RETURN 1 
			ELSE 
				RETURN 0 
	RETURN -1 
END 


GO

SET ANSI_NULLS, QUOTED_IDENTIFIER ON
GO

Create Procedure [PrcNewContract]
(
	@Guid uniqueidentifier = 0x0
)
 
as
	Select
		(Select Isnull(Max([Number]),0) + 1 From [LeaseApartment]) as [Number],
		[Guid],
		[ContractNo],
		[CustomerGuid],
		[BuildingGuid],
		[ApartmentGuid],
		[ShopGuid],
		[ApartmentType],
		[Period],
		Case 
			when [ContractFinish] = 0 then Dateadd(Day,1,[ToDate]) 
			when [ContractFinish] = 1 then Dateadd(Day,1,[ContractFinishDate]) 
		end as [FromDate],
		Dateadd(year,1,
						Case 
							when [ContractFinish] = 0 then [ToDate]
							when [ContractFinish] = 1 then [ContractFinishDate]
						end
				) as [ToDate],
		[Rent]+ISNULL(AddValue,0) as [Rent],
		[CurrencyGuid],
		[CurrencyVal],
		[PayType],
		[Note],
		[Note2],
		[Purpose],
		[LeaseKind],
		[RevenueAccountGuid],
		[CustAccountGuid],
		case when SUBSTRING([OpNewContract], 4, 1) = '1' then [CommissionFromCustPercent] else 0 end [CommissionFromCustPercent],
		case when SUBSTRING([OpNewContract], 4, 1) = '1' then [CommissionFromCustValue] else 0 end as [CommissionFromCustValue],
		[AcCommissionFromCustGuid],
		case when SUBSTRING([OpNewContract], 5, 1) = '1' then [CommissionFromOwnerPercent] else 0 end [CommissionFromOwnerPercent],
		case when SUBSTRING([OpNewContract], 5, 1) = '1' then [CommissionFromOwnerValue] else 0 end [CommissionFromOwnerValue],
		[AcCommissionFromOwnerGuid],
		[FlatOwner],
		Cast( 0 as bit) as [ContractFinish],
		Cast( Null as DateTime)  as [ContractFinishDate],
		0 as [ResultingAmount],
		0 as [ResultingAmount2],
		[RoundKind],
		0 as [Fine],
		[FineAccount],
		Cast( 0 as bit) as [CreateResultingEntry],
	
		0 as [InsuranceValue],
		[InsuranceValue] + Isnull([InsuranceValueOld],0) as [InsuranceValueOld],
		case when SUBSTRING([OpNewContract], 1, 1) = '1' then [ContractPrice] else 0 end as [ContractPrice], 
		[AccountContractPrice],
		case when SUBSTRING([OpNewContract], 2, 1) = '1' then [CertificatValue] else 0 end [CertificatValue],
		case when SUBSTRING([OpNewContract], 3, 1) = '1' then [OtherFee] else 0 end OtherFee,
		[AccountCertificatValue],

		[RentDuration],
		[Rentype],
		[TermsOfPayment],
		[RentInfoGuid],
		[SalesManGuid],
		[ResidentCount],
		[whereabouts],
		[CountOldContract],
		[CostGuid],
		[BranchGuid],
		[FlatArea],
		[FlatAreaunity],
		IsAutoRenewal
	From
		[vwLeaseApartment]
	where
		[Guid] = @Guid Or @Guid = 0x0


GO

SET ANSI_NULLS, QUOTED_IDENTIFIER ON
GO

Create Procedure [PrcGC]
(
	@TableName Varchar(256) = 'BuildingOffer'
)
 
as
	Declare @S varchar(8000), @ColType int
	Declare @ColName Varchar(30)
			,@Columns Varchar(8000)

	set @Columns = ''

	DECLARE cursor_Name CURSOR FOR 
	SELECT 
		[c].[Name]
	FROM 
		SysColumns [C]
		inner join [sysobjects] [O] on [O].[id] = [C].[ID]
	where
		[O].[Name] = @TableName
	Order By [C].ColId
	
	Print '    Columns = <
'
	OPEN cursor_Name
	FETCH NEXT FROM cursor_Name INTO @ColName
	
	WHILE @@FETCH_STATUS = 0
	BEGIN
		Print '      item
        Alignment = taLeftJustify
        Color = clBlack
        FieldName = '''+@ColName+'''
        Caption = '''+@ColName+'''
        EnCaption = '''+@ColName+'''
        Font.Charset = DEFAULT_CHARSET
        Font.Color = clBlack
        Font.Height = -11
        Font.Name = ''Tahoma''
        Font.Style = []
        HeaderFont.Charset = DEFAULT_CHARSET
        HeaderFont.Color = clBlack
        HeaderFont.Height = -11
        HeaderFont.Name = ''Tahoma''
        HeaderFont.Style = []
        ReadOnly = False
        Width = 0
        Visible = True
        DataType = dtString
      end
'
		
	  FETCH NEXT FROM cursor_Name INTO @ColName
	
	END
	
	CLOSE cursor_Name
	DEALLOCATE cursor_Name


GO

SET ANSI_NULLS, QUOTED_IDENTIFIER ON
GO

Create Procedure [FlatProfit]
(
	@Flat Bit = 1,
	@Shop Bit = 1,
	@CurrencyVal Float = 1,
	@Date1 DateTime = '1/1/2007',
	@Date2 DateTime = '1/1/2008'
)
 
as

	Exec PrcInsertSC ''	
	Exec PrcInsertSC ''	
	Exec PrcInsertSC ''
	
	
	Declare @Tbl Table
	(
		[ContractNo] Varchar(256)
		,[Date] DateTime
		,[BuildingName] Varchar(256)
		,[StrKind] Varchar(256)
		,[FlatName] Varchar(256)
		,[CostPice] Float
		,[SalePrice] Float
		,[ContractGuid] uniqueidentifier
		,[FlatGuid] uniqueidentifier
		,[Kind] Int
		,[Sort] int
	)

	if @Flat = 1	
	Insert Into @Tbl
	Select 
		[ContractNo]
		,[FromDate] as [Date]
		,[F].[BuildingName]
		,dbo.SC('')
		,[F].[No]+' '+[F].[ApartmentType] as [FlatName]
		,[F].[CostPrice] * [CostCurrnecyVal] / @CurrencyVal as [CostPice]
		,[C].[Rent] * [C].[CurrencyVal] / @CurrencyVal as [SalePrice]
		,[C].[Guid] as [ContractGuid]
		,[F].[Guid]
		,0
		,0 
	From 
		[LeaseApartment] [C]
		inner join [vwApartment] [F] on [F].[Guid] = [C].[ApartmentGuid]
		inner join [Resource] [R] on [R].[Guid] = [C].[BuildingGuid] and [R].[Spid] = @@Spid
	where
		([LeaseKind] = 2) and ([C].[Fromdate] Between @Date1 And @Date2)
		
	if @Shop = 1	
	Insert Into @Tbl
	Select 
		[ContractNo]
		,[FromDate] as [Date]
		,[F].[BuildingName]
		,dbo.SC('')
		,[F].[No]+' ' as [FlatName]
		,[F].[CostPrice] * [CostCurrnecyVal] / @CurrencyVal as [CostPice]
		,[C].[Rent] * [C].[CurrencyVal] / @CurrencyVal as [SalePrice]
		,[C].[Guid] as [ContractGuid]
		,[F].[Guid]
		,1
		,0
	From 
		[LeaseApartment] [C]
		inner join [vwShop] [F] on [F].[Guid] = [C].[ApartmentGuid]
		inner join [Resource] [R] on [R].[Guid] = [C].[BuildingGuid] and [R].[Spid] = @@Spid
	where
		([LeaseKind] = 3)
		and ([C].[Fromdate] Between @Date1 And @Date2)

	Insert Into @Tbl
	Select 
		'' as [ContractNo]
		,Null as [Date]
		,'' as [BuildingName]
		,'' as [StrKind]
		,'' as [FlatName]
		,Sum([CostPice])
		,Sum([SalePrice])
		,0x0 as [ContractGuid]
		,0x0 as [FlatGuid]
		,-1 as [Kind]
		,1 [Sort]
	from 
		@Tbl 
	Order By [Date]
	
	Select 
		* 
		,isnull([SalePrice],0) - isnull([CostPice],0)  as [Profit]
	from @Tbl 
	Order By Sort

GO

SET ANSI_NULLS, QUOTED_IDENTIFIER ON
GO

CREATE FUNCTION FnGregToHijriDate (@Date Datetime, @Format Varchar(256))
RETURNS Varchar(256)
 
AS
BEGIN
	if DatePart(Year, @Date) = 1900
	Set @Date = '12/30/1899'
	
	Declare @R Varchar(256)
			,@Y Varchar(256)
			,@m Varchar(256)
			,@d Varchar(256)

	if @Date = '12/30/1899' 
	begin
		Set @R = ''
		Return @R
	end

	Declare @LastDay int
	Select Top 1 
		@LastDay = [Day]
	from 
		[HjrConfig] H
	where
		(Date <= @Date) 
	Order By
		Date desc

	Select Top 1 
		@D = 1 + (DATEDIFF(DAY, Date, @Date)),
		@M = hjrMonth ,
		@y = hjrYear
	from 
		[HjrConfig] H
	where
		(Date <= @Date) 
		and (DATEDIFF(DAY, Date, @Date) < @LastDay)
	Order By
		Date desc

	
	if isNull(@D,-1) = -1
	begin
		Set @R = Convert(Varchar(256), @Date , 131)
	
		Set @Y = SUBSTRING (@R, 7, 4)
		Set @m = SUBSTRING (@R, 4, 2)
		Set @d = SUBSTRING (@R, 1, 2)
	end

	Set @d = Replace(@d,' ','0')

	Set @m = dbo.FnFormatNumber(@m, 2)
	Set @d = dbo.FnFormatNumber(@d, 2)
	
	Set @R = @Format

	Set @R = REPLACE(@R, UPPER('dddd'), 'D')
	Set @R = REPLACE(@R, UPPER('ddd'), 'D')
	Set @R = REPLACE(@R, UPPER('dd'), 'D')
	
	Set @R = REPLACE(@R, UPPER('mmmm'), 'M')
	Set @R = REPLACE(@R, UPPER('mmm'), 'M')
	Set @R = REPLACE(@R, UPPER('mm'), 'M')
	
	Set @R = REPLACE(@R, UPPER('YYYY'), 'Y')
	Set @R = REPLACE(@R, UPPER('YYY'), 'Y')
	Set @R = REPLACE(@R, UPPER('YY'), 'Y')
	
	Set @R = REPLACE(@R, UPPER('d'), Cast(@d as varchar(256)))
	Set @R = REPLACE(@R, UPPER('m'), Cast(@m as varchar(256)))
	Set @R = REPLACE(@R, UPPER('y'), Cast(@Y as varchar(256)))
	
	RETURN @r

END

GO

SET ANSI_NULLS, QUOTED_IDENTIFIER ON
GO

CREATE function FnAddDate 
(
	@Kind varchar(2) = 'm', 
	@inc int = 0, 
	@Date Datetime = '2/10/2016'
)
RETURNS datetime
 
AS
BEGIN
	Declare @RDate Datetime

	Declare @Hijridate int
	Select 
		@Hijridate = Value
	From
		dmd_Const where vName = 'Hijridate'

	if @Hijridate = 1
	begin
		if LOWER(@Kind) = 'm'
		Set @RDate = dbo.fnIncMonthHijriDate(@Date, @inc)
		if LOWER(@Kind) = 'y'
		Set @RDate = dbo.fnIncYearHijriDate(@Date, @inc)
	end
	else
	begin
		if LOWER(@Kind) = 'm'
		Set @RDate = dateadd(m ,@inc, @Date)
		if LOWER(@Kind) = 'y'
		Set @RDate = dateadd(y ,@inc, @Date)
	end

	if LOWER(@Kind) = 'wk'
	Set @RDate = dateadd(wk ,@inc, @Date)
		
	return @RDate

END

GO

SET ANSI_NULLS, QUOTED_IDENTIFIER ON
GO

Create Procedure [PrcLandOffer]
(
	@LandNo Varchar(256) = '',
	@Name Varchar(256) = '',
	@ltnName Varchar(256) = '',
	@Customer Varchar(256) = '',
	@OfferKind int = 3,
	@OfferValue1 Float = 0,
	@OfferValue2 Float = 0,
	@City Varchar(256) = '',
	@Region Varchar(256) = '',
	@Space Varchar(256) = '',
	@Area1 Float = 0,
	@Area2 Float = 0,
	@license Varchar(256) = '',
	@LandType Varchar(256) = '',
	@Side Varchar(256) = '',
	@Delegated VARCHAR(256) = '',
	@CustPhone VARCHAR(256) = '',
	@CustMobile VARCHAR(256) = ''
)
 
as
	Select 
		*,
		Case when OfferKind = 0 then ''
			 when OfferKind = 1 then ''
			 when OfferKind = 2 then ''
		end as OfferKindStr
	From 
		[LandOffer]
	where
		([LandNo] = @LandNo or @LandNo = '')
		and ([Name] Like '%'+@Name+'%')
		and ([ltnName] Like '%'+@ltnName+'%')
		and ([Customer] Like '%'+@Customer+'%')
		and ([OfferKind] = @OfferKind Or @OfferKind = 3)
		and ([OfferValue] between @OfferValue1 and @OfferValue2 or @OfferValue2 = 0)
		and ([City] Like '%'+@City+'%')
		and ([Region] Like '%'+@Region+'%')
		and ([Space] Like '%'+@Space+'%')
		and ([Area] between @Area1 and @Area2 or @Area2 = 0)
		and ([license] Like '%'+@license+'%')
		and ([LandType] Like '%'+@LandType+'%')
		and ([Side] Like '%'+@Side+'%')
		and ([Delegated] Like '%'+@Delegated+'%')
		and ([CustPhone] Like '%'+@CustPhone+'%')
		and ([CustMobile] Like '%'+@CustMobile+'%')
		

GO

SET ANSI_NULLS, QUOTED_IDENTIFIER ON
GO

CREATE FUNCTION [FnGetLastDayFromHijriMonth] (@Year int, @Month int)
RETURNS int  
AS
BEGIN
	Declare @R int
			,@BDate Datetime
			,@EDate Datetime

	Select @BDate = Date from [HjrConfig]
	where
		hjrMonth = @MONTH
		and hjrYear = @Year
	Order By
		[hjrMonth]

	if @Month = 12
	begin
		Set @Month = 1
		Set @Year = @Year + 1
	end
	else
	begin
		Set @Month = @Month + 1
	end
	
	Select @EDate = Date from [HjrConfig]
	where
		hjrMonth = @MONTH
		and hjrYear = @Year
	Order By
		[hjrMonth]

	Set @R = (DATEDIFF(DAY, @BDate, @EDate))

	RETURN @R 

END

GO

SET ANSI_NULLS, QUOTED_IDENTIFIER ON
GO
Create View [vwAllFlatKind]
 
as
		Select Distinct FlatKind from Apartment
		where FlatKind <> ''
		union 
		Select Distinct ShopKind from Shop
		where ShopKind <> ''
	

GO

SET ANSI_NULLS, QUOTED_IDENTIFIER ON
GO

	Create View [vbLawsuitState]
	 
	as
		Select 
			[T].*
		From
			[LawsuitState] [T]
			inner join [CurrentUsers] [U] on ([u].[Seclvl] >= Isnull([T].[SecLvl],0)  or [u].[Admin] = 1) and [u].[spid] = @@Spid
GO

SET ANSI_NULLS, QUOTED_IDENTIFIER ON
GO

Create View [vwMaintenanceContractType]
 
as
	Select
		[A].[Number],
		[A].[Guid],
		[A].[SecLvl],
		[A].[Code] as [Code],
		[A].[Name] as [ArName],

		[A].[Name] as [TypeNameAr],
		[A].[Name] as [TypeNameLtn],

		Case when (dbo.FnGetLangauge(@@spid) = 1) and (Isnull([A].[LtnName],'') <> '') then [A].[LtnName] else [A].[Name] end as [Name], 
		[A].[ltnName],
		[A].[Menu] as [arMenu],
		Case when (dbo.FnGetLangauge(@@spid) = 1) and (Isnull([A].[LtnMenu],'') <> '') then [A].[LtnMenu] else [A].[Menu] end as [Menu], 
		[A].[LtnMenu],
		[A].[defprintPath],
		A.ShortCut,

		IncomeAccountGUID,
		[DiscountAccountGUID],

		[Rentcondition],
		[CreateEntry],
		[AutoCreateEntry],
		[AutoPostedEntry],
		[EntryDate],

		[MoveCostWithExpenceDebit],
		[MoveCostWithExpenceCredit],
		
		[MoveCostWithDiscountDebit],
		[MoveCostWithDiscountCredit],
		
		[DefPrintLogPath],
		[DefPrintReceipt],
		[DefPrintacquittance],
		
		[FirstPayNoteLtn],

		[ContractNoteLtn],
		
		Case when (dbo.FnGetLangauge(@@spid) = 1) and (Isnull([A].[FirstPayNoteLtn],'') <> '') then [A].[FirstPayNoteLtn] else [A].[FirstPayNote] end as [FirstPayNote],
		Case when (dbo.FnGetLangauge(@@spid) = 1) and (Isnull([A].[ContractNoteLtn],'') <> '') then [A].[ContractNoteLtn] else [A].[ContractNote] end as [ContractNote]
		
	From
		[MaintenanceContractType] [A]


GO

SET ANSI_NULLS, QUOTED_IDENTIFIER ON
GO

Create view [vwComplaint]
 
as
	Select 
		GetDate() as [NowDate],
		[C].[Name] as [CustName],
		[C].[ArName] as [CustArName],
		[C].[LtnName] as [CustLtnName],
		[C].[Address] as [CustomerAddress],
		[C].[Nationality] as [CustomerNationality],
		[C].[Profession] as [CustomerProfession],
		[C].[Domicile] as [CustomerDomicile],
		[C].[Security] as [CustomerSecurity],
		[C].[MemoSecurity] as [CustomerMemoSecurity],
		[C].[BoxNo] as [CustomerBoxNo],
		[C].[PersonalityNo1] as [CustomerPersonalityNo1],
		[C].[PersonalityNo2] as [CustomerPersonalityNo2],
		[C].[Adjective]as [CustomerAdjective],
		[C].[Fax]	as [CustomerFax],
		[C].[PhoneJob]	as [CustomerPhoneJob],
		[C].[Mobile]	as [CustomerMobile],
		[C].[Email]	as [CustomerEmail],
		[C].[PassportNO] as [CustomerPassportNO],
		[C].[PassportExpireDate] as [CustomerPassportExpireDate],	

		[B].[Name] as [BuildingName],
		[B].[ArName] as [BuildingArName],
		[B].[LtnName] as [BuildingLtnName],
		[B].[Emirate],
		[B].[Suburb],
		[B].[Area],
		[B].[Street],
		[B].[BuildingNo],
		[B].[BondType] as [BuildingBondType],
		[B].[BondNo] as [BuildingBondNo],
		[B].[BondDate] as [BuildingBondDate],
		[B].[LtnEmirate],
		[B].[LtnArea],
		[B].[LtnSuburb],
		[B].[LtnStreet],
		
		[B].[PieceNo],
		[B].[BasinNo],	
		
		[P].[FloorNo],
		
		Case 
			when [RealtyKind] = 0 then [P].[NO] 
			when [RealtyKind] = 1 then [S].[No]
			when [RealtyKind] = 2 then [K].[No]
			when [RealtyKind] = 3 then [V].[VillaNo]
			when [RealtyKind] = 4 then [L].[Name]
		end as [RealtyNO],

		Case 
			when [RealtyKind] = 0 then [P].[Guid] 
			when [RealtyKind] = 1 then [S].[Guid]
			when [RealtyKind] = 2 then [K].[Guid]
			when [RealtyKind] = 3 then  [V].[Guid]
			when [RealtyKind] = 4 then [L].[Guid]
		end as [RealtyGuid],
		
		Case when [a].ComplaintState = 0 then dbo.SC('')
			 when [a].ComplaintState = 1 then dbo.SC('')

			 when [a].ComplaintState = 2 then dbo.SC('')
			 when [a].ComplaintState = 3 then dbo.SC('')
			 when [a].ComplaintState = 4 then dbo.SC('  ')
		end as ComplaintStateStr,

		[A].*
	from 
		[vbComplaint] [A]
		left join [vwBuilding] [B] On [A].[BuildingGuid] = [B].[Guid]
		left join [vwApartment] [P] on [P].[Guid] = [A].[FlatGuid]
		left join [vwShop] [S] on [S].[Guid] = [A].[ShopGuid]
		left join [vwParking] [K] on [K].[Guid] = [A].[ParkingGuid]
		left join [Villa] [V] on [v].[Guid] = [A].[VillaGuid]
		left join [vwEarth] [L] on [L].[Guid] = [A].[LandGuid]
		left join [vwCustomer] [C] on [C].[Guid] = [A].[CustGuid]


GO

SET ANSI_NULLS, QUOTED_IDENTIFIER ON
GO

CREATE FUNCTION [fnDecodeHijriDatetoGergDate] (@Year int, @Month int, @Day int)
RETURNS Datetime
 
AS
BEGIN
	Declare @R Datetime

	Select Top 1 
		@R = Date + @Day -1
	from 
		[HjrConfig] H
	where
		hjrMonth = @Month
		and hjrYear = @year
	Order By
		[hjrMonth]

	
	if @R is Null
	begin
		Declare @DayCount int, @S Varchar(256)
		Declare @Gdate Datetime Set @Gdate = dbo.fnDateonly(GETDATE())
		Declare @Hy int
		Declare @Hm int
		Declare @Hd int

		Declare @y int 
		Declare @m int 
		Declare @d int 
		
		Set @y = DatePart(Year, @Gdate)
		Set @m = DatePart(Month, @Gdate)
		Set @d = DatePart(Day, @Gdate)
		
		Set @S = Convert(Varchar(256), @Gdate , 131)
	
		Set @Hy = SUBSTRING (@S, 7, 4)
		Set @Hm = SUBSTRING (@S, 4, 2)
		Set @Hd = SUBSTRING (@S, 1, 2)

		Set @hd = Replace(@hd,' ','0')
		Set @hm = dbo.FnFormatNumber(@hm, 2)
		Set @hd = dbo.FnFormatNumber(@hd, 2)
			 
		Declare @IntGDate int, @intHdate int
		Set @intHdate = Cast(dbo.FnFormatNumber(@hy, 4)+dbo.FnFormatNumber(@hm, 2)+dbo.FnFormatNumber(@hd, 2) as int)
		Set @IntGDate = Cast(dbo.FnFormatNumber(@Year, 4)+dbo.FnFormatNumber(@Month, 2)+dbo.FnFormatNumber(@Day, 2) as int)	
		
		Declare @CC int
		Set @CC = @IntGDate - @intHdate + 2
		Set @CC = abs(@CC) + 2
		
		if @CC > 21
		begin
			if @IntGDate > @intHdate
			Set @Gdate = @Gdate + (ABS(@hy - @Year) * 354) + (ABS(@Hm - @Month ) *28) + (ABS(@Hd - @Day ) )- 20
			else
			Set @Gdate = @Gdate - (ABS(@hy - @Year) * 354) + (ABS(@Hm - @Month ) *28) + (ABS(@Hd - @Day ) )- 20
			
			Set @CC = 2 * (ABS(@hy - @Year) * 354) + (ABS(@Hm - @Month ) *28) + (ABS(@Hd - @Day ) )
		end
		
		
		Declare @I int
		Set @I = 0
		while (@intHdate <> @IntGDate)  and (@i < 100000)--and (@i < @CC) --and (@i < 370)
		begin
			Set @i = @I + 1
			
			if @IntGDate > @intHdate
			Set @Gdate = @Gdate + 1
			else
			Set @Gdate = @Gdate - 1

			Set @y = DatePart(Year, @Gdate)
			Set @m = DatePart(Month, @Gdate)
			Set @d = DatePart(Day, @Gdate)
			
			Set @S = Convert(Varchar(256), @Gdate , 131)
		
			Set @Hy = SUBSTRING (@S, 7, 4)
			Set @Hm = SUBSTRING (@S, 4, 2)
			Set @Hd = SUBSTRING (@S, 1, 2)

			Set @hd = Replace(@hd,' ','0')
			Set @hm = dbo.FnFormatNumber(@hm, 2)
			Set @hd = dbo.FnFormatNumber(@hd, 2)

			Set @intHdate = Cast(dbo.FnFormatNumber(@hy, 4)+dbo.FnFormatNumber(@hm, 2)+dbo.FnFormatNumber(@hd, 2) as int)
			Set @IntGDate = Cast(dbo.FnFormatNumber(@Year, 4)+dbo.FnFormatNumber(@Month, 2)+dbo.FnFormatNumber(@Day, 2) as int)	
		end
		
		Set @R = @Gdate
	end
	RETURN dbo.fnDateonly(@R)

END

GO

SET ANSI_NULLS, QUOTED_IDENTIFIER ON
GO
Create view vwMaintenanceWorker
 
as
	Select 
		[Number],
		[Guid],
		[SecLvl],
		[Name] as [ArName],
		[LtnName], 
		Case when (dbo.FnGetLangauge(@@spid) = 1) and (Isnull([LtnName],'') <> '') then [LtnName] else [Name] end as [Name],  
		[BirthDate],	
		[PassportNO],
		[PassportExpireDate],	
		[StayExpireDate],	
		[PersonalityNo1],
		[PersonalityNo2],
		[Profession],
		[Address],
		[Phone],
		[Mobile],
		[Nationality],
		[Security],
		[MemoSecurity],
		[Domicile],
		[Note]
	From 
		vbMaintenanceWorker

GO

SET ANSI_NULLS, QUOTED_IDENTIFIER ON
GO

	Create View [vbContractWorkFlow]
	 
	as
		Select 
			[T].*
		From
			[ContractWorkFlow] [T]
			inner join [CurrentUsers] [U] on ([u].[Seclvl] >= Isnull([T].[SecLvl],0)  or [u].[Admin] = 1) and [u].[spid] = @@Spid
GO

SET ANSI_NULLS, QUOTED_IDENTIFIER ON
GO
Create View vwLinkCheckContract
 
as

	Select 
		Number,
		[ParentGuid],
		Case 
			when Kind = 1 then dbo.SC('')
			when Kind = 2 then dbo.SC('')
			when Kind = 3 then dbo.SC(' ')
			when Kind = 4 then dbo.SC(' ')
			when Kind = 5 then dbo.SC(' ')
		end AS [Kind] ,
		
		Kind as orgKind,
		
		Case 
			when Kind = 1 then (Select TypeNameAndFlatNo From vwAllContract where Guid = LL.ContractGuid)
			when Kind = 2 then (Select [No] +'-'+ CustName From vwLawsuitSearch where Guid = LL.ContractGuid)
			when Kind = 3 then (Select CAST(Number as varchar(255)) +'-'+ TypeName From vwElectricityBill where Guid = LL.ContractGuid)
			when Kind = 4 then (Select ContractNo +'-'+ BuildingName From vwServicesContract where Guid = LL.ContractGuid)
			when Kind = 5 then (Select ContractNo  From vwMaintenanceContract where Guid = LL.ContractGuid)
		end AS [Contract],
		
		[ContractGuid],
		[Percent],
		[Value],
		[Note]
	from 
		LinkCheckContract LL

GO

SET ANSI_NULLS, QUOTED_IDENTIFIER ON
GO

CREATE FUNCTION dbo.[fnHijriStrtoGergDate] (@hijristr Varchar(256), @Formt Varchar(256))
RETURNS Datetime
 
AS
BEGIN
	--if LEN(@hijristr) < 6
	--Set @Formt = REVERSE(@Formt)
	--Set @Formt = REVERSE(@hijristr)
	
	Declare
		@D Varchar(256),
		@M Varchar(256),
		@Y Varchar(256)
	
	Set @D = ''
	Set @M = ''
	Set @Y = ''
	
	Declare @Ix_d int, @Ix_m int, @Ix_y int
	
	Declare @SpIx int

	Select @Ix_d = CHARINDEX(UPPER('d'), UPPER(@Formt))
	--Select @Ix_d
	
	Select @Ix_m = CHARINDEX(UPPER('m'), UPPER(@Formt))
	--Select @Ix_m

	Select @Ix_y = CHARINDEX(UPPER('y'), UPPER(@Formt))
	--Select @Ix_y
	
	
	
	Declare @Sp Varchar(1)
	if CHARINDEX('/', @Formt) <> 0
	Set @Sp = '/'
	else
	Set @Sp = '-'
	
	Declare @V Varchar(256)
	Declare @I int
	Declare @f Bit
	Set @I = 0
	Set @hijristr = @hijristr + @Sp
	
	if LEN(@hijristr) > 7
	begin
			while LEN(@hijristr) > 0
			begin
				Set @f = 0
				Set @I = @I + 1
				
				Select @SpIx = CHARINDEX(@Sp, @hijristr)
				
				Set @V = SUBSTRING(@hijristr, 1, @SpIx-1)
				
				if (@Ix_d < @Ix_m) and (@Ix_d < @Ix_y) and @f = 0
				begin
					Set @D = @v
					Set @f = 1
					Set @Ix_d = 100
				end
				
				if (@Ix_m < @Ix_d) and (@Ix_m < @Ix_y) and @f = 0 
				begin
					Set @m = @v
					Set @f = 1
					Set @Ix_m = 100
				end

				if (@Ix_y < @Ix_d) and (@Ix_y < @Ix_d) and @f = 0
				begin
					Set @y = @v
					Set @f = 1
					Set @Ix_y = 100
				end

				Set	@hijristr = SUBSTRING(@hijristr, @SpIx +1, LEN(@hijristr))
			end
	end
	else
	begin
			while LEN(@hijristr) > 0
			begin
				
				Set @f = 0
				Set @I = @I + 1
				
				Select @SpIx = CHARINDEX(@Sp, @hijristr)
				
				Set @V = SUBSTRING(@hijristr, 1, @SpIx-1)
				
				if @I = 1
				begin
					Set @D = @v
				end
				
				if @I = 2
				begin
					Set @M = @v
				end

				Set	@hijristr = SUBSTRING(@hijristr, @SpIx +1, LEN(@hijristr))
			end
	end	

	if @M > 12 
	begin
		declare @T int
		Set @T = @D
		
		Set @D = @M
		
		Set @M = @T
	end


	Set @D = REPLACE(@D, '/', '')
	Set @D = REPLACE(@D, '-', '')
	
	if @d = ''
	Set @D = dbo.FnGregToHijriDate (getDate(), 'dd') 
	
	Set @M = REPLACE(@M, '/', '')
	Set @M = REPLACE(@M, '-', '')
	
	if @M = ''
	Set @M = dbo.FnGregToHijriDate (getDate(), 'mm') 
	
	Set @Y = REPLACE(@Y, '/', '')
	Set @Y = REPLACE(@Y, '-', '')
	
	if @Y = ''
	Set @Y = dbo.FnGregToHijriDate (getDate(), 'yyyy') 

	RETURN dbo.fnDecodeHijriDatetoGergDate(Cast(@y as int), Cast(@m as int), Cast(@d as int))

END

GO

SET ANSI_NULLS, QUOTED_IDENTIFIER ON
GO

Create Procedure [PrcComplaint]
(
	@No Varchar(256) = '',
	@CustomerGuid uniqueidentifier = 0x0,
	@FlatGuid uniqueidentifier = 0x0,
	@ComplaintState int = 2,
	@Datewith int = 0,
	@ActiveDate Bit = 0,
	@Date1 DateTime = '1/1/2007',
	@Date2 DateTime = '1/1/2012',
	@OpNote int = 0,
	@ActiveNote bit = 1,
	@Note Varchar(256) = '',
	@ActiveBuildingList Bit = 1,
	@RealtyKind int = 6
)
 
as
	--  
	if @OpNote = 0 or @OpNote = 1--
	Set @Note = '%'+@Note+'%'

	Select 
		C.*
	From 
		[vwComplaint] C
		left join vwBuilding B on C.BuildingGuid = B.Guid
		left join [Resource] [R] on [R].[Guid] = C.BuildingGuid and [R].[Kind] = 94 and [R].[Spid] = @@Spid 
	where
		(C.No = @No or @No = '')

		and (C.CustGuid = @CustomerGuid or @CustomerGuid = 0x0)
		and (C.RealtyGuid = @FlatGuid or @FlatGuid = 0x0)
		and (C.RealtyKind = @RealtyKind or @RealtyKind = 6)
		and (C.ComplaintState = @ComplaintState or @ComplaintState = 2)
		and (C.Date between @Date1 and @Date2 or @Datewith = 1 or @ActiveDate = 0)
		and (C.CloseDate between @Date1 and @Date2 or @Datewith = 0 or @ActiveDate = 0)
		and (C.Note Like @Note or @OpNote = 1 or @ActiveNote = 0)
		and (C.Note not Like @Note or @OpNote = 0 or @OpNote = 2 or @ActiveNote = 0)
		and ([R].[Guid] Is Not Null or @ActiveBuildingList = 0 or @RealtyKind > 2)
	Order By
		C.Date, C.Number
		

GO

SET ANSI_NULLS, QUOTED_IDENTIFIER ON
GO

Create Procedure [PrcDebitCreditMonthly_Years]
(
	@AccountGuid uniqueidentifier = 0x0,
	@BranchGuid uniqueidentifier = 0x0,
	@CurrencyGuid uniqueidentifier = 0x0,
	@CurrencyVal Float = 1,
	@IsPosted Bit = 1,
	@IsNotPosted Bit = 1,
	@Date1 DateTime = '5/1/2008',
	@Date2 DateTime = '7/1/2012'
)
 
as
	Create Table #Tbl
	(
		[Account] Varchar(256),
		[Month] Varchar(256),
		[Debit] Float,
		[Credit] Float,
		[Balance] Float,
		[AcGuid] uniqueidentifier,
		[Sort] int
	)
	Select * Into #fnGetAccountList From [dbo].[fnGetAccountList](@AccountGuid)
	
	Insert Into #TBL
	Select 
		[Ac].[Code]+'-'+[Ac].[Name],
		dbo.SC('  : ')+dbo.fnmonthName([M].[Date]) as [month],
		Sum([En].[Debit]) as [Debit],
		Sum([En].[Credit]) as [Credit],
		Sum([En].[Debit]) - Sum([En].[Credit]) as [Balance],
		[Ac].[Guid],
		dbo.FnMonth([M].[Date]) - 1
	From 
		dbo.[FnDEntry](@CurrencyGuid, @CurrencyVal) [En]
		inner Join [vwEntry] [m] on [M].[Guid] = [En].[ParentGuid]
		inner Join #fnGetAccountList [Ac] on [Ac].[Guid] = [En].[AcGuid]
		inner join [Account] [Ac2] on [Ac2].[Guid] = [En].[AcGuid]
	where
		[M].[Date] < @Date1
		and ([M].[BranchGuid] = @BranchGuid or @BranchGuid = 0x0)
		and ([En].[IsVisible] = 1 or [En].[CurrencyGuid] = @CurrencyGuid)
		and (
				([M].[IsPosted] = 1 and @IsPosted = 1)
				or ([M].[IsPosted] = 0  and @IsNotPosted = 1)
			)
	Group By
		[Ac].[Code]+'-'+[Ac].[Name]
		,[Ac].[Guid]
		,dbo.SC('  : ')+dbo.fnmonthName([M].[Date])
		,dbo.FnMonth([M].[Date])-1

	Insert Into #TBL
	Select 
		[Ac].[Code]+'-'+[Ac].[Name],
		dbo.fnmonthName([M].[Date]) as [month],
		Sum([En].[Debit]) as [Debit],
		Sum([En].[Credit]) as [Credit],
		Sum([En].[Debit]) - Sum([En].[Credit]) as [Balance],
		[Ac].[Guid],
		dbo.FnMonth([M].[Date])
	From 
		dbo.[FnDEntry](@CurrencyGuid, @CurrencyVal) [En]
		inner Join [vwEntry] [m] on [M].[Guid] = [En].[ParentGuid]
		inner Join [dbo].[#fnGetAccountList]  [Ac] on [Ac].[Guid] = [En].[AcGuid]
		inner join [Account] [Ac2] on [Ac2].[Guid] = [En].[AcGuid]
	where
		([M].[Date] Between @Date1 And @Date2)
		and ([M].[BranchGuid] = @BranchGuid or @BranchGuid = 0x0)
		and ([En].[IsVisible] = 1 or [En].[CurrencyGuid] = @CurrencyGuid)
		and (
				([M].[IsPosted] = 1 and @IsPosted = 1)
				or ([M].[IsPosted] = 0  and @IsNotPosted = 1)
			)
	Group By
		[Ac].[Code]+'-'+[Ac].[Name]
		,[Ac].[Guid]
		,dbo.fnmonthName([M].[Date])
		,dbo.FnMonth([M].[Date])


	Select 
		*
		,(SELECT SUM(Debit - Credit) FROM #TBL [t2] WHERE [t2].[Sort] <= [t1].[Sort] and [t1].[AcGuid] = [t2].[AcGuid]) AS [RunTotal]
	from 
		#TBL [t1]
	Order By
		[Account], [Sort]

GO

SET ANSI_NULLS, QUOTED_IDENTIFIER ON
GO

	Create View [vbServicesContractType]
	 
	as
		Select 
			[T].*
		From
			[ServicesContractType] [T]
			inner join [CurrentUsers] [U] on ([u].[Seclvl] >= Isnull([T].[SecLvl],0)  or [u].[Admin] = 1) and [u].[spid] = @@Spid
GO

SET ANSI_NULLS, QUOTED_IDENTIFIER ON
GO

CREATE Procedure dbo.[PrcHijriStrtoGergDate] (@hijristr Varchar(256), @Formt Varchar(256))
 
AS
	--if LEN(@hijristr) < 6
	--Set @Formt = REVERSE(@Formt)
	--Set @Formt = REVERSE(@hijristr)
	
	Declare
		@D Varchar(256),
		@M Varchar(256),
		@Y Varchar(256)
	
	Set @D = ''
	Set @M = ''
	Set @Y = ''
	
	Declare @Ix_d int, @Ix_m int, @Ix_y int
	
	Declare @SpIx int

	Select @Ix_d = CHARINDEX(UPPER('d'), UPPER(@Formt))
	--Select @Ix_d
	
	Select @Ix_m = CHARINDEX(UPPER('m'), UPPER(@Formt))
	--Select @Ix_m

	Select @Ix_y = CHARINDEX(UPPER('y'), UPPER(@Formt))
	--Select @Ix_y
	
	
	Declare @Sp Varchar(1)
	if CHARINDEX('/', @Formt) <> 0
	Set @Sp = '/'
	else
	Set @Sp = '-'
	
	Declare @V Varchar(256)
	Declare @I int
	Declare @f Bit
	Set @I = 0
	Set @hijristr = @hijristr + @Sp
	
	if LEN(@hijristr) > 7
	begin
			while LEN(@hijristr) > 0
			begin
				Set @f = 0
				Set @I = @I + 1
				
				Select @SpIx = CHARINDEX(@Sp, @hijristr)
				
				Set @V = SUBSTRING(@hijristr, 1, @SpIx-1)
				
				if (@Ix_d < @Ix_m) and (@Ix_d < @Ix_y) and @f = 0
				begin
					Set @D = @v
					Set @f = 1
					Set @Ix_d = 100
				end
				
				if (@Ix_m < @Ix_d) and (@Ix_m < @Ix_y) and @f = 0 
				begin
					Set @m = @v
					Set @f = 1
					Set @Ix_m = 100
				end

				if (@Ix_y < @Ix_d) and (@Ix_y < @Ix_d) and @f = 0
				begin
					Set @y = @v
					Set @f = 1
					Set @Ix_y = 100
				end
				--Select @D d, @M m , @Y y
				
				Set	@hijristr = SUBSTRING(@hijristr, @SpIx +1, LEN(@hijristr))
			end
	end
	else
	begin
			while LEN(@hijristr) > 0
			begin
				
				Set @f = 0
				Set @I = @I + 1
				
				Select @SpIx = CHARINDEX(@Sp, @hijristr)
				
				Set @V = SUBSTRING(@hijristr, 1, @SpIx-1)
				
				if @I = 1
				begin
					Set @D = @v
				end
				
				if @I = 2
				begin
					Set @M = @v
				end

				Set	@hijristr = SUBSTRING(@hijristr, @SpIx +1, LEN(@hijristr))
			end
	end	

	if @M > 12 
	begin
		declare @T int
		Set @T = @D
		
		Set @D = @M
		
		Set @M = @T
	end


	Set @D = REPLACE(@D, '/', '')
	Set @D = REPLACE(@D, '-', '')
	
	if @d = ''
	Set @D = dbo.FnGregToHijriDate (getDate(), 'dd') 
	
	Set @M = REPLACE(@M, '/', '')
	Set @M = REPLACE(@M, '-', '')
	
	if @M = ''
	Set @M = dbo.FnGregToHijriDate (getDate(), 'mm') 
	
	Set @Y = REPLACE(@Y, '/', '')
	Set @Y = REPLACE(@Y, '-', '')
	
	if @Y = ''
	Set @Y = dbo.FnGregToHijriDate (getDate(), 'yyyy') 
	
	
	Select @Y, @M, @d
	Select dbo.fnDecodeHijriDatetoGergDate(Cast(@y as int), Cast(@m as int), Cast(@d as int))



GO

SET ANSI_NULLS, QUOTED_IDENTIFIER ON
GO

	Create View [vbPricing]
	 
	as
		Select 
			[T].*
		From
			[Pricing] [T]
			inner join [CurrentUsers] [U] on ([u].[Seclvl] >= Isnull([T].[SecLvl],0)  or [u].[Admin] = 1) and [u].[spid] = @@Spid
GO

SET ANSI_NULLS, QUOTED_IDENTIFIER ON
GO

Create Procedure [dbo].[PrcGetOwnerUnionFeeDetail]
(
	@BuildingGuid uniqueidentifier = 0x0,
	@CkFlat bit = 1,
	@CkShop bit = 1,
	@CkParking bit = 1,
	@Fee Float = 35,
	@RoundKind int = 0,
	@ItemNote varchar(255) = '[B]  [O] [N]'
)
 
as
	Create Table #UnionFeeDetail
	(
		[Number] int,
		[NO] varchar(255),
		[FlatKind] varchar(255),
		[ApartmentType] varchar(255),
		[Area] Float,
		[unity] varchar(255),
		[Fee] Float,
		[AccountName] varchar(255),
		[Cost] varchar(255),
		[AccountGuid] uniqueidentifier,
		[CostGuid] uniqueidentifier,
		[Note] varchar(255),
		[Kind] int,
		[FlatGuid] uniqueidentifier
	)
	
	if @CkFlat = 1
	insert into #UnionFeeDetail
	Select 
		F.Number,
		F.NO,
		F.FlatKind,
		F.[ApartmentType],
		F.[Area],
		F.[unity],
		dbo.FnMyRound(@Fee * F.[Area] ,@RoundKind) as [Fee],
		Cu.Name as [AccountName],
		Co.Name as [Cost] ,
		Cu.acGuid [AccountGuid] ,
		F.CostGuid,
		REPLACE(
			REPLACE(
					REPLACE(@ItemNote, '[B]', b.Name) 
					,'[O]', ISNULL(Cu.Name,'')
					)
				,'[N]', F.[No])
		as [Note],
		1 as [Kind],
		F.Guid as [FlatGuid]
	From 
		[Apartment] F
		inner join Building B on B.Guid = F.BuildingGuid
		left join vwCustomer Cu on Cu.Guid = F.CustOwnerGuid
		left join Cost Co on Co.Guid = F.CostGuid
	where
		F.BuildingGuid = @BuildingGuid
		

	if @CkShop = 1
	insert into #UnionFeeDetail
	Select 
		F.Number,
		F.NO,
		F.ShopKind,
		F.[Description],
		F.[Area],
		F.[unity],
		dbo.FnMyRound(@Fee * F.[Area] ,@RoundKind) as [Fee],
		Cu.Name as [AccountName],
		Co.Name as [Cost] ,
		Cu.acGuid [AccountGuid] ,
		F.CostGuid,
		REPLACE(
			REPLACE(
					REPLACE(@ItemNote, '[B]', b.Name) 
					,'[O]', ISNULL(Cu.Name,'')
					)
				,'[N]', F.[No])
		as [Note],
		2 as [Kind],
		F.Guid as [FlatGuid]
	From 
		[Shop] F
		inner join Building B on B.Guid = F.BuildingGuid
		left join vwCustomer Cu on Cu.Guid = F.CustGuid
		left join Cost Co on Co.Guid = F.CostGuid
	where
		F.BuildingGuid = @BuildingGuid

	if @CkParking = 1
	insert into #UnionFeeDetail
	Select 
		F.Number,
		F.NO,
		F.ParkingKind,
		F.[Description],
		F.[Area],
		F.[unity],
		dbo.FnMyRound(@Fee * F.[Area] ,@RoundKind) as [Fee],
		Cu.Name as [AccountName],
		Co.Name as [Cost] ,
		Cu.acGuid [AccountGuid] ,
		F.CostGuid,
		REPLACE(
			REPLACE(
					REPLACE(@ItemNote, '[B]', b.Name) 
					,'[O]', ISNULL(Cu.Name,'')
					)
				,'[N]', F.[No])
		as [Note],
		3 as [Kind],
		F.Guid as [FlatGuid]
	From 
		[Parking] F
		inner join Building B on B.Guid = F.BuildingGuid
		left join vwCustomer Cu on Cu.Guid = F.CustGuid
		left join Cost Co on Co.Guid = F.CostGuid
	where
		F.BuildingGuid = @BuildingGuid

	Select * from #UnionFeeDetail
	Order By Kind, Number

GO

SET ANSI_NULLS, QUOTED_IDENTIFIER ON
GO

Create Procedure [DeleteChecksCollection]
(
	@CheckGuid uniqueidentifier = 0x0,
	@Kind INT = 0
)
 
as
	DELETE [ChecksCollection]
	WHERE	
		[CheckGuid] = @CheckGuid
		AND [Kind] = @Kind

	--   
	Delete
		[LinkEntry_Checks]
	where
		[CheckGuid] = @CheckGuid
		AND [kind] = 1660 + @Kind

	--   
	Delete
		[LinkEntryType_Checks]
	where
		[CheckGuid] = @CheckGuid
		AND [kind] = 1660 + @Kind
		

GO

SET ANSI_NULLS, QUOTED_IDENTIFIER ON
GO

Create Procedure [dbo].[PrcGetinfoFld]
(
	@Guid uniqueidentifier = 0x0,
	@CardId int = 0
)
 

as
	Select 
		C.id,
		C.fldCaption,
		V.[FldValue] 
	From 
		[InfofldCaption] C
		left join [InfofldValue] v on V.Cardid = C.Cardid and V.id = C.id and [CardGuid] = @Guid
	where
		(C.Cardid = @CardId)
	order by
		C.id

GO

SET ANSI_NULLS, QUOTED_IDENTIFIER ON
GO

Create Procedure [PrcRecodeIncAccount]
(
	@CoGuid uniqueidentifier = '4125827A-BA45-49E7-81C0-EC3E342977A9'
)
 
as
	Set NoCount on
	Declare @CoCount int
	Select 
		@CoCount = Count(*)
	From 
		[IncAccount]
	where
		[ParentGuid] = @CoGuid

	Set @CoCount = Len(Cast(@CoCount as Varchar(25)))

	Declare @Code Varchar(256)
	Select 
		@Code = Code
	From 
		[IncAccount]
	where
		[Guid] = @CoGuid

	Create Table #R
	(
		[Id] int identity(1,1),
		[Guid] uniqueidentifier 
	)
	
	insert into #R
		([Guid])
	Select 
		[Guid]
	From
		[IncAccount]
	where
		[ParentGuid] = @CoGuid
	Order By
		[Number]
 
	--    
	Declare @C Int
	Select 
		@C = Count(*)
	from 
		[IncAccount] [Ac] 
		inner join #R R on @Code+ dbo.FnFormatNumber([R].[id], @CoCount) = [Ac].[Code] and [R].[Guid] <> [Ac].[Guid]
	where
		[Ac].[ParentGuid] <> @CoGuid

	if isnull(@C,0) > 0
	begin
		Declare @AcR Varchar(256)
		Declare @Msgerror Varchar(256)
	
		Select Top 1 
			@AcR = [Ac].[Code]+'-'+[Ac].[Name]
		from 
			[IncAccount] [Ac] 
			inner join #R R on @Code+ dbo.FnFormatNumber([R].[id], @CoCount) = [Ac].[Code] and [R].[Guid] <> [Ac].[Guid]
		where
			[Ac].[ParentGuid] <> @CoGuid

		--print @AcR
		
		Set @Msgerror = '           ' + @AcR
		RAISERROR (@Msgerror, 16, 1)
	end

	
	Alter Table [IncAccount] disable trigger all
	
	update 
		[IncAccount]
	Set 
		[Code] = @Code+ dbo.FnFormatNumber([id], @CoCount)
	From
		[IncAccount] [Ac]
		inner join [#R] On [#R].[Guid] = [Ac].[Guid]

	Alter Table [IncAccount] enable trigger all
	

GO

SET ANSI_NULLS, QUOTED_IDENTIFIER ON
GO

CREATE FUNCTION dbo.[FnGetDayName] (@Date Datetime, @Lang int = 0)
RETURNS Varchar(256)
 AS
BEGIN
	Declare @R Varchar(256)
	Set @R = DATENAME(Dw,@Date)
	
	if @Lang = 0
	Set @R = Case
				when @R = 'Monday' then ''
				when @R = 'Tuesday' then ''
				when @R = 'Wednesday' then ''
				when @R = 'Thursday' then ''
				when @R = 'Friday' then ''
				when @R = 'Saturday' then ''
				when @R = 'Sunday' then ''
			end
	return @R
END

GO

SET ANSI_NULLS, QUOTED_IDENTIFIER ON
GO

Create Trigger [TRG_Trace_EntryDate]
on [EntryDate]
 
for update
As
	SET NOCOUNT ON;
	if Not exists(Select Value from DMD_const where vName = 'ActiveLogCardUpdate' and Value = '1' ) return
	
	Declare @UserGuid uniqueidentifier, @Guid uniqueidentifier
	Set @Guid = NEWID()
	
	Select Top 1 @UserGuid = userGuid From CurrentUsers where Spid = @@SPID
			
	insert into [Trace]
	([Guid],[ParentGuid],[Date],[userGuid],[HostName],ParentTbl )
	Select Top 1
		@Guid,
		N.Guid,
		GETDATE(),
		@UserGuid,
		Host_Name(),
		'EntryDate'
	From
		[inserted] n 
		
	insert into [TraceDetail]
	([ParentGuid],[Caption],[Old],[New],[Tbl])
	Select Top 1
		@Guid,
		' ' as [Caption],
		D.[SecLvl] as [old],
		N.[SecLvl] as [New],
		''
	From
		[deleted] d
		inner join [inserted] n on D.Guid = N.Guid
	where
		N.[SecLvl] <> D.[SecLvl]
		
	insert into [TraceDetail]
	([ParentGuid],[Caption],[Old],[New],[Tbl])
	Select Top 1
		@Guid,
		'' as [Caption],
		D.[Mark] as [old],
		N.[Mark] as [New],
		''
	From
		[deleted] d
		inner join [inserted] n on D.Guid = N.Guid
	where
		N.[Mark] <> D.[Mark]
		
	insert into [TraceDetail]
	([ParentGuid],[Caption],[Old],[New],[Tbl])
	Select Top 1
		@Guid,
		'' as [Caption],
		D.[AccountGuid] as [old],
		N.[AccountGuid] as [New],
		'[Account]'
	From
		[deleted] d
		inner join [inserted] n on D.Guid = N.Guid
	where
		N.[AccountGuid] <> D.[AccountGuid]
		
	insert into [TraceDetail]
	([ParentGuid],[Caption],[Old],[New],[Tbl])
	Select Top 1
		@Guid,
		'' as [Caption],
		dbo.fnDate(D.[Date]) as [old],
		dbo.fnDate(N.[Date]) as [New],
		''
	From
		[deleted] d
		inner join [inserted] n on D.Guid = N.Guid
	where
		N.[Date] <> D.[Date]
		
	insert into [TraceDetail]
	([ParentGuid],[Caption],[Old],[New],[Tbl])
	Select Top 1
		@Guid,
		'' as [Caption],
		D.[Note] as [old],
		N.[Note] as [New],
		''
	From
		[deleted] d
		inner join [inserted] n on D.Guid = N.Guid
	where
		N.[Note] <> D.[Note]
		
	insert into [TraceDetail]
	([ParentGuid],[Caption],[Old],[New],[Tbl])
	Select Top 1
		@Guid,
		'' as [Caption],
		D.[CurrencyGuid] as [old],
		N.[CurrencyGuid] as [New],
		'[Currency]'
	From
		[deleted] d
		inner join [inserted] n on D.Guid = N.Guid
	where
		N.[CurrencyGuid] <> D.[CurrencyGuid]
		
	insert into [TraceDetail]
	([ParentGuid],[Caption],[Old],[New],[Tbl])
	Select Top 1
		@Guid,
		' ' as [Caption],
		D.[CurrencyVal] as [old],
		N.[CurrencyVal] as [New],
		''
	From
		[deleted] d
		inner join [inserted] n on D.Guid = N.Guid
	where
		N.[CurrencyVal] <> D.[CurrencyVal]
		
	insert into [TraceDetail]
	([ParentGuid],[Caption],[Old],[New],[Tbl])
	Select Top 1
		@Guid,
		'' as [Caption],
		D.[UserGuid] as [old],
		N.[UserGuid] as [New],
		'[strikt_Users]'
	From
		[deleted] d
		inner join [inserted] n on D.Guid = N.Guid
	where
		N.[UserGuid] <> D.[UserGuid]
		
	insert into [TraceDetail]
	([ParentGuid],[Caption],[Old],[New],[Tbl])
	Select Top 1
		@Guid,
		'' as [Caption],
		D.[BranchGuid] as [old],
		N.[BranchGuid] as [New],
		'[Branch]'
	From
		[deleted] d
		inner join [inserted] n on D.Guid = N.Guid
	where
		N.[BranchGuid] <> D.[BranchGuid]
		
	delete Trace From Trace t left join [TraceDetail] D on T.guid = D.ParentGuid
	where
		d.ParentGuid is Null and t.Guid = @Guid


GO

SET ANSI_NULLS, QUOTED_IDENTIFIER ON
GO

CREATE FUNCTION [FnMonthName] (@Date Datetime)
RETURNS Varchar(256)  AS
BEGIN
	Declare @R Varchar(256)
			,@Y Varchar(256)
			,@m Varchar(256)
			,@d Varchar(256)

	Set @R = ''

	Declare @Hijridate int
	Select 
		@Hijridate = Value
	From
		dmd_Const where vName = 'Hijridate'

	if @Hijridate = 1
	begin
		Set @m = Case 
					when dbo.fnMonth(@Date) = 1 then ''
					when dbo.fnMonth(@Date) = 2 then ''
					when dbo.fnMonth(@Date) = 3 then ' '
					when dbo.fnMonth(@Date) = 4 then ' '
					when dbo.fnMonth(@Date) = 5 then ' '
					when dbo.fnMonth(@Date) = 6 then ' '
					when dbo.fnMonth(@Date) = 7 then ''
					when dbo.fnMonth(@Date) = 8 then ''
					when dbo.fnMonth(@Date) = 9 then ''
					when dbo.fnMonth(@Date) = 10 then ''
					when dbo.fnMonth(@Date) = 11 then ' '
					when dbo.fnMonth(@Date) = 12 then ' '
				 end
	end
	else
	begin
		Set @m = DateName(month, @Date)
	end

	
	RETURN @m

END

GO

SET ANSI_NULLS, QUOTED_IDENTIFIER ON
GO

	Create View [vbBuildingRecElecCounter]
	 
	as
		Select 
			[T].*
		From
			[BuildingRecElecCounter] [T]
			inner join [CurrentUsers] [U] on ([u].[Seclvl] >= Isnull([T].[SecLvl],0)  or [u].[Admin] = 1) and [u].[spid] = @@Spid
GO

SET ANSI_NULLS, QUOTED_IDENTIFIER ON
GO

CREATE FUNCTION dbo.[FnDate] (@Date Datetime)
RETURNS Varchar(256)
 AS
BEGIN
	Declare @R Varchar(256)
			,@Y Varchar(256)
			,@m Varchar(256)
			,@d Varchar(256)

	Set @R = ''

	Declare @Hijridate int
	Select 
		@Hijridate = Value
	From
		dmd_Const where vName = 'Hijridate'

	if @Hijridate = 1
	begin
		Declare @FromatDate Varchar(256)
		Set @FromatDate = (Select value From DMD_const where VName = 'DateFormat')
		if isNull(@FromatDate,'') = '' set @FromatDate = 'yyyy/mm/dd'
		RETURN dbo.FnGregToHijriDate(@Date,@FromatDate)
	end
	else
	begin
		Set @R = Convert(Varchar(256), @Date , 101)
	
		Set @Y = SUBSTRING (@R, 7, 4)
		Set @d = Replace(SUBSTRING (@R, 4, 2),' ','0')
		Set @m = SUBSTRING (@R, 1, 2)
	end

	Set @d = Replace(@d,' ','0')
	
	if @Y = '1900'
	Set @R = ''
	else
	Set @R = @y+'/'+@m+'/'+@d
	
	return @R
END

GO

SET ANSI_NULLS, QUOTED_IDENTIFIER ON
GO

Create Procedure [PrcTreeStore]
(
	@AcGuid uniqueidentifier = 0x0
)
 
as
	Declare @Level int
	Set @Level = Case when @AcGuid = 0x0 then 0 else 3 end

	Create Table #Res 
	(
		[Number] int, 
		[Guid] uniqueidentifier, 
		[Type] int, 
		[Code] Varchar(256) COLLATE database_default, 
		[Name] Varchar(256) COLLATE database_default, 
		[LtnName] Varchar(256) COLLATE database_default, 
		[ParentGuid]uniqueidentifier,
		[Path]  Varchar(256) COLLATE database_default
	)

	insert into #Res
	Select
		[A].[Number], 
		[A].[Guid], 
		1 as [Type], 
		[A].[Code], 
		Case when (dbo.FnGetLangauge(@@spid) = 1) and (Isnull([A].[LtnName],'') <> '') then [A].[LtnName] else [A].[Name] end as [Name], 
		[A].[LtnName],
		case when [A].[ParentGuid] is Not Null then [A].[ParentGuid] else 0x0 end as [Parent],
		[F].[Path]
	From 
		[vbStore] [A]
		inner join [dbo].[fnGetStoreList](@AcGuid) [F] on [F].[Guid] = [A].[Guid]


	CREATE INDEX IXS_Guid ON #Res ([Guid])
	-----------------------------------------------------------------------------------

	Select 
		*
		,Len([Path]) / 9 as [level]
	from 
		#Res

	ORDER BY [Path], [Type], [Code]

GO

SET ANSI_NULLS, QUOTED_IDENTIFIER ON
GO

Create Procedure [PrcTestShopUsed]
(
	@ShopGuid uniqueidentifier = 'FAC0771A-ABC6-4D88-BC6B-DA13C5110A91',
	@Date DateTime = '10/1/2008'
)
 
as
	Select 
		[L].[Number],
		[T].[Name] as [ContractName],
		[L].[FromDate],
		[L].[ToDate],
		[L].[Leasekind],
		[L].[Guid]
	From 
		[LeaseApartment] [L] 
		inner join [ContractType] [T] On [T].[Guid] = [L].[TypeGuid]
	where 
		([ApartmentGuid] = @ShopGuid)
		and (
				(
					(
						([FromDate] <= @Date )
					)
				and ( [Leasekind] = 3 )
				)
				or 
				(
					(
					   (@Date between [FromDate] and [ToDate])
                     )
                	and ([Leasekind] = 0 or [Leasekind] = 1)
				)
			)
			and [ContractFinish] = 0
			

GO

SET ANSI_NULLS, QUOTED_IDENTIFIER ON
GO

Create View [AllBranch]
 
as
	Select
		[Number], [Guid], [Code], [ParentGuid], [Note], [Address], [Phone], [LtnName],[Name]
		,case when [ParentGuid] is Not Null then [ParentGuid] else 0x0 end as [Parent]
	From 
		[vwBranch]


GO

SET ANSI_NULLS, QUOTED_IDENTIFIER ON
GO
Create Procedure [PrcDeleteOfficeBuilding]
(
	@BuildingGuid uniqueidentifier = 'B6B748F3-3B52-4A89-882D-17278C210E4C',
	@Class Varchar(256) = ''
)
 
as
	Set NoCount On
	-- Flat
	Select 
		[A].[CostGuid]
		Into #R
	From 
		[Apartment] [A]
	    inner Join [Building] [B] on [B].[Guid] = [A].[BuildingGuid]
    where 
		[B].[Guid] = @BuildingGuid
	and ([A].[Class] = @Class)

	Delete 
		[Apartment]
	From 
		[Apartment] [A]
	    inner Join [Building] [B] on [B].[Guid] = [A].[BuildingGuid]
    where 
		[B].[Guid] = @BuildingGuid
	and ([A].[Class] = @Class)

	Delete 
		[Cost]
	From 
		[Cost] [C]
		inner join [#R] [A] on [A].[CostGuid] = [C].[Guid]


GO

SET ANSI_NULLS, QUOTED_IDENTIFIER ON
GO

--    
Create Procedure [PrcCheckAccountWithOutIncAccount]
(
	@Guid uniqueidentifier = '375AAD94-0B6B-456A-BFA1-6DAC550C96A2'
)
 
as
	Select 
		* 
	from 
		[vwMovingAccount] M
		left join IncAccountListDetail l on l.accountguid = m.guid
	

GO

SET ANSI_NULLS, QUOTED_IDENTIFIER ON
GO

Create procedure PrcIncomeSaved
(
	@Guid uniqueidentifier = 0x0
)
 
as

	Select 
		c.FlatNo as [RealtyNo],
		C.[ContractNo],
		[C].[BuildingName],
		C.FlatNo as [FlatName],
		D.*,
		0 as Kind
	into #IncomeSaved_tmp
	From 
		[vwAllContract] [C]
		inner join [IncomeSavedDetail] D on d.contractGuid = C.Guid
	where
		D.parentGuid = @Guid
-------------------------

	Insert into #IncomeSaved_tmp
	Select
		''
		,'' as [ContractNo]
		,'' as [BuildingName]
		,'' as [FlatName]
		,max(Number) as Number 

		,0x0 as [ParentGuid]
		,0x0 as [ContractGuid]
		,'' as [strKind]

		,Sum([RentPrice])
		,0 as [FromDate]
		,0 as [ToDate]
		,0 as [EndDate]
		,Sum([Days])
		,Sum([DayPrice])
		,Sum([DayPeriod])
		,Sum([Income])
		,0 as [ContractFinish]
		,Sum([Collection])
		,Sum([CheckNotCollection])
		,Sum([Cash])
		,Sum([TotalPays])
		,Sum([ContractRest])
		,Sum([CustBalance])
		,1 as Kind
	From
		#IncomeSaved_tmp
		
	Select 
		[E].*
	from 
		#IncomeSaved_tmp [E]
	order By
		Number
	
	Select
		Sum([RentPrice]) as [RentPrice]
		,Sum([Days]) as [Days]
		,Sum([DayPeriod]) as [DayPeriod]
		,Sum([Income]) as  [Income]
		,Sum([Collection]) as [Collection]
		,Sum([CheckNotCollection]) as [CheckNotCollection]
		,Sum([Cash]) as [Cash]
		,Sum([TotalPays]) as [TotalPays]
		,Sum([ContractRest]) as [ContractRest]
		,Sum([CustBalance]) as [CustBalance]
	From
		#IncomeSaved_tmp
	where
		[Kind] = 0
	

GO

SET ANSI_NULLS, QUOTED_IDENTIFIER ON
GO

Create Procedure [dbo].[PrcRenewalCount]
(
	@CustGuid uniqueidentifier = 0x0,
	@FlatGuid uniqueidentifier = 0x0
)
 
as
	Declare @ContractCount int
	Select 
		@ContractCount = IsNull(COUNT(*),0) + 1 
	From 
		[LeaseApartment]
	where
		CustomerGuid = @CustGuid
		and ApartmentGuid = @FlatGuid
		
	Declare @CountOldContract int
	Select 
		@CountOldContract = Max([CountOldContract])
	From 
		[LeaseApartment]
	where
		CustomerGuid = @CustGuid
		and ApartmentGuid = @FlatGuid	
		
	Select @CountOldContract as CountOldContract, @ContractCount as ContractCount

GO

SET ANSI_NULLS, QUOTED_IDENTIFIER ON
GO

CREATE FUNCTION [SC] (@ArStr Varchar(256))
RETURNS Varchar(256)
 
AS
BEGIN

	Declare @R Varchar(256)
    Select Top 1 @R = [En] from [StrSource] where [Ar]=@ArStr
	
	if (isnull(@R, '')  <> '') and (dbo.FnGetLangauge(@@spid) = 1)
	Return @R

    Return @ArStr	

end

GO

SET ANSI_NULLS, QUOTED_IDENTIFIER ON
GO

Create Procedure [PrcPaperMonetaryOfMaintenanceContract]
(
	@ContractGuid UniqueIdentifier = 0x0
)
 
as
	Set NoCount On
	
	Select 
		dbo.SC([P].[TypeName]) as [PaperKind],
		[P].[No],
		[LL].[Value],
		[P].[BankName],
		[P].[CurrencyCode],
		[P].[DueDate],
		Case 		
			when  [C3].[CheckGuid] is not null then dbo.SC('')

			when  ([C1].[CheckGuid] is not null) or 
				  ([C4].[CheckGuid] is Not Null ) and ([C4].[Value] >= [P].[Value])	 then dbo.SC('') 

			when ([C4].[CheckGuid] is Not Null ) and ([C4].[Value] < [P].[Value]) then dbo.SC(' ')

			when  [C].[CheckGuid] is not null then dbo.SC('') 
			when  [C2].[CheckGuid] is not null then dbo.SC('') 
		end as [State],
		[P].[Note3],
		[P].[Note],
		1 as [Print],
		[P].[Guid]
	From
		[vwChecks] [P]
		inner join [LinkCheckContract] LL on LL.ParentGuid = P.Guid
		left join vwMaintenanceContract [L] on [L].[Guid] = [LL].[ContractGuid]
		left join [vwChecksCollection] [C] on [C].[CheckGuid] = [P].[Guid] and [C].[Kind] = 0
		left join [vwChecksCollection] [C1] on [C1].[CheckGuid] = [P].[Guid] and [C1].[Kind] = 1
		left join [vwChecksCollection] [C2] on [C2].[CheckGuid] = [P].[Guid] and [C2].[Kind] = 2
		left join [vwChecksCollection] [C3] on [C3].[CheckGuid] = [P].[Guid] and [C3].[Kind] = 3
		left join (
						Select 
							[CheckGuid],
							Sum([Value]) as [Value] 
						From
							[ChecksPartialCollection] 
						Group By
							[CheckGuid]
					) [C4] on [C4].[CheckGuid] = [P].[Guid]
 	where
 		(LL.[ContractGuid] = @ContractGuid or @ContractGuid = 0x0)
--		and [P].[Number] = 2905
 	Order By 
 		[P].[dueDate], [P].[No]

GO

SET ANSI_NULLS, QUOTED_IDENTIFIER ON
GO

Create  PROCEDURE prcBackupJob
	@DbName varchar(128) = 'Aq',
	@Path varchar(4000) = 'D:\',
	@Path2 varchar(4000) = ''
 
AS
	IF RIGHT(@Path, 1) <> '\' 
	SET @Path = @Path + '\'	

	SET @Path = @Path + @DbName

	Declare @Disk varchar(4000),
			@SQL varchar(4000)
	SET @Disk = ''''+ @Path +'_'+ 
				Cast(DatePart(dd, GetDate()) AS varchar(2)) + '_' +
				Cast(DatePart(mm, GetDate()) AS varchar(2)) + '_' +
				Cast(DatePart(yyyy, GetDate()) AS varchar(4)) + '_'+

				Cast(DatePart(hh, GetDate()) AS varchar(2)) + '_' +
				Cast(DatePart(mi, GetDate()) AS varchar(2)) +'.bak' + ''''

	--Print(@Disk)
	SET @SQL = 'BACKUP DATABASE' +' '+ @DbName + ' TO DISK = '+ @Disk+'WITH INIT,SKIP, NOREWIND, NOUNLOAD, COMPRESSION,  STATS = 10'
        print (@SQL)
	Exec(@SQL)

	---- Backup2
	IF (@path2 <> '')
	BEGIN
		IF (RIGHT(@Path2, 1) <> '\' )
		SET @Path2 = @Path2 + '\'	
	
		SET @Path2 = @Path2 + @DbName
	
		SET @Disk = ''''+ @Path2 +'_'+ 
					Cast(DatePart(dd, GetDate()) AS varchar(2)) + '_' +
					Cast(DatePart(mm, GetDate()) AS varchar(2)) + '_' +
					Cast(DatePart(yyyy, GetDate()) AS varchar(4)) + '_'+
	
					Cast(DatePart(hh, GetDate()) AS varchar(2)) + '_' +
					Cast(DatePart(mi, GetDate()) AS varchar(2)) +'.bak' + ''''
	
		--Print(@Disk)
	SET @SQL = 'BACKUP DATABASE' +' '+ @DbName + ' TO DISK = '+ @Disk+'WITH INIT,SKIP, NOREWIND, NOUNLOAD, COMPRESSION,  STATS = 10'
	        print (@SQL)
		Exec(@SQL)
	END


GO

SET ANSI_NULLS, QUOTED_IDENTIFIER ON
GO

Create Procedure [dbo].[PrcQOfferPrice]
(
	@CustomerName varchar(255) = '',
	@OfferKind int = 5,
	@BuildingGuid [uniqueidentifier] = 0x0,
	@RealtyGuid [uniqueidentifier] = 0x0,
	@Price1 Float = 0,
	@Price2 Float = 0,
	@ActiveDate Bit = 0,
	@Date1 Datetime = 0,
	@Date2 Datetime = 0
)
 
as
	Select
		*
	From
		[vwOfferPrice]
	
	where
		([CustomerName] = @CustomerName or @CustomerName = '')
		and (OfferKind = @OfferKind or @OfferKind = 5)
		and (BuildingGuid = @BuildingGuid or @BuildingGuid = 0x0)
		and ([RealtyGuid] = @RealtyGuid or @RealtyGuid = 0x0)
		and (
				([PriceAfterDiscount] between @Price1 and @Price2 and @Price2 <> 0)
			 or ([PriceAfterDiscount] = @Price1 and @Price2 = 0)
			)
		and ([Date] between @Date1 and @Date2 or @ActiveDate = 0)	
	order By
		[DATE]
		

GO

SET ANSI_NULLS, QUOTED_IDENTIFIER ON
GO

Create Proc [Prc_AddToLogFile]
  (
   @UserName varchar(100) = '' ,
   @CardId int =0,
   @Opration varchar(50) = '',
   @Note varchar(100) = ''
  )
 
AS
 
   insert into LogFile
   (Username,UserGuid,ComputerName,CardId,Opration,Note)  
   Select
		@Username,
		(Select Top 1 Guid From Realty_Users where [LoginName] = @Username),
		Host_name(),
		@CardId,
		@Opration,
		@Note
	

GO

SET ANSI_NULLS, QUOTED_IDENTIFIER ON
GO
Create view vwServicesContract_br
 
as
	Select
		A.*
	from 
		[vbServicesContract] [A]
		inner join [vwBuilding] [B] On [A].[BuildingGuid] = [B].[Guid]


GO

SET ANSI_NULLS, QUOTED_IDENTIFIER ON
GO
Create View [vwTransType]
 
as
	Select
		[A].[Number],
		[A].[Guid],
		[A].[SecLvl],
		[A].[Code],
		[A].[Name] as [ArName],
		Case when (dbo.FnGetLangauge(@@spid) = 1) and (Isnull([A].[LtnName],'') <> '') then [A].[LtnName] else [A].[Name] end as [Name], 
		[A].[ltnName],
		[A].[Menu] as [arMenu],
		Case when (dbo.FnGetLangauge(@@spid) = 1) and (Isnull([A].[LtnMenu],'') <> '') then [A].[LtnMenu] else [A].[Menu] end as [Menu], 
		[A].[LtnMenu],
		[A].[ShortCut],
		[A].[DefPrintPath],
		[A].[Note],
		[A].[Color1],
		[A].[Color2]
	From
		[vbTransType] [A]

GO

SET ANSI_NULLS, QUOTED_IDENTIFIER ON
GO

Create Trigger [TRG_ParkingContract_Del]
on [ParkingContract]
 
For delete
As
	Delete [Hentry] From [HEntry] Inner join [Deleted] On [Deleted].[Guid] = [HEntry].[Guid]

	Delete [Checks] From [Checks] inner join [Deleted] On [Deleted].[Guid] = [Checks].[ContractGuid]

	Delete [Hentry] 
	From 
		[HEntry] [H]
		Inner join [LinkCe] [L] on [L].[CeGuid] = [H].[Guid]
		Inner join [Deleted] On [Deleted].[Guid] = [L].[Guid]
		
	Delete [Secondary_Entry] 
	From 
		[Secondary_Entry] [H]
		Inner join [Deleted] On [Deleted].[Guid] = [H].[ContractGuid]
		
	Delete [Trace] From [Trace] inner join [Deleted] On [Deleted].[Guid] = [Trace].[ParentGuid]
	
	Delete ContractWorkFlow From ContractWorkFlow inner join [Deleted] On [Deleted].[Guid] = ContractWorkFlow.[ContractGuid]

	
	Declare @Guid uniqueidentifier
	DECLARE cursor_Name CURSOR FAST_FORWARD FOR 
	Select Guid From deleted
	
	OPEN cursor_Name
	FETCH NEXT FROM cursor_Name INTO @Guid
	
	WHILE @@FETCH_STATUS = 0
	BEGIN
	
	  exec [PrcDeleteEntryContractFee] @Guid
		  
	  FETCH NEXT FROM cursor_Name INTO @Guid
	END
	
	CLOSE cursor_Name
	DEALLOCATE cursor_Name
	
	

GO

SET ANSI_NULLS, QUOTED_IDENTIFIER ON
GO
Create View dbo.vwElectricityBill
 
as
	Select
		E.*,
		B.Name as [Building],
		C.FlatNo,
		C.ContractNo,
		C.CustName,
		C.[CustLtnName],
		[C].[BuildingName],
		[C].[BuildingArName],
		[C].[BuildingLtnName],
		C.CustAcGuid,
		Case when [RealtyType] = 0 then FlatGuid else ShopGuid End as [RealtyGuid],
		E.Counter - E.OldCounter as [ElectricityUsing],
		T.Name as [TypeName]
	From
		[ElectricityBill] E
		inner join [ElectricityType] T on T.Guid = E.TypeGuid
		inner join [vwBuilding] B on b.Guid = e.BuildingGuid
		left join vwAllContract C on C.Guid = E.ContractGuid

GO

SET ANSI_NULLS, QUOTED_IDENTIFIER ON
GO

CREATE Procedure [dbo].[prc__AddJob]
	@JobName		[VARCHAR]( 256), --name of job 
	@JobType		[INT], -- type of job 4 d, 8 w, 16 m 
	@JobTime		[INT],  
	@Jobday			[INT],  
	@JobStartDate	[INT],  
	@DBName			[VARCHAR]( 256),  
	@Command		[VARCHAR]( 8000) 
 
AS 
/* 
	this procedure Add Job To database 
	this job Execute the Command 
*/ 
	/* Delete Job If Exsist*/
--	EXECUTE [msdb].[dbo].[sp_delete_job] @job_name = @JobName
	
	SET XACT_ABORT ON  
	BEGIN TRANSACTION  
	DECLARE @JobID [BINARY](16)  
	DECLARE @ReturnCode [INT]  
	DECLARE @RetryNum [INT]  
	DECLARE @RetryInter [INT]  
	IF(@JobType = 4)  
	BEGIN 
		SELECT @RetryNum = 23  
		SELECT @RetryInter = 60  
	END ELSE BEGIN  
		SELECT @RetryNum = 4  
		SELECT @RetryInter = 1440  
	END  
	SET @ReturnCode = 0 
--	IF (SELECT COUNT(*) FROM msdb.dbo.syscategories WHERE name = N'[Uncategorized (Local)]') < 1  
	IF NOT EXISTS(SELECT * FROM [msdb].[dbo].[syscategories] WHERE [name] = N'[Uncategorized (Local)]') 
		EXECUTE [msdb].[dbo].[sp_add_category] @name = N'[Uncategorized (Local)]' 
	-- Delete the job with the same name (if it exists)  
	SELECT @JobID = [job_id] FROM [msdb].[dbo].[sysjobs] WHERE ([name] = @JobName) 
	IF (@JobID IS NOT NULL)  
	BEGIN -- Check if the job is a multi-server job  
		IF (EXISTS (SELECT * FROM [msdb].[dbo].[sysjobservers] WHERE ([job_id] = @JobID) AND ([server_id] <> 0)))  
		BEGIN -- There is, so abort the script  
			RAISERROR (N'Unable to import job | '' since there is already a multi-server job with this name.', 16, 1)  
			
			IF (@@TRANCOUNT > 0) 
			ROLLBACK TRANSACTION 
  
		END  
		ELSE -- Delete the [local] job  
			EXECUTE [msdb].[dbo].[sp_delete_job] @job_name = @JobName  
		SELECT @JobID = NULL  
	END 
	-- Add the job  
	EXECUTE @ReturnCode = [msdb].[dbo].[sp_add_job] @job_id = @JobID OUTPUT , @job_name = @JobName , @owner_login_name = NULL, @description = N'No description available.', @category_name = N'[Uncategorized (Local)]', @enabled = 1, @notify_level_email = 0, @notify_level_page = 0, @notify_level_netsend = 0, @notify_level_eventlog = 2, @delete_level= 0  
	IF (@@ERROR <> 0 OR @ReturnCode <> 0) 
		IF (@@TRANCOUNT > 0) 
		ROLLBACK TRANSACTION 

	-- Add the job steps  
	EXECUTE @ReturnCode = [msdb].[dbo].[sp_add_jobstep] @job_id = @JobID, @step_id = 1, @step_name = N'Step 1', @command = @Command, @database_name = @DBName, @server = N'', @database_user_name = N'', @subsystem = N'TSQL', @cmdexec_success_code = 0, @flags = 0, @retry_attempts = @RetryNum, @retry_interval = @RetryInter, @output_file_name = N'', @on_success_step_id = 0, @on_success_action = 1, @on_fail_step_id = 0, @on_fail_action = 2  
	IF (@@ERROR <> 0 OR @ReturnCode <> 0) 
		IF (@@TRANCOUNT > 0) 
		ROLLBACK TRANSACTION 

	EXECUTE @ReturnCode = [msdb].[dbo].[sp_update_job] @job_id = @JobID, @start_step_id = 1 
	IF (@@ERROR <> 0 OR @ReturnCode <> 0) 
		IF (@@TRANCOUNT > 0) 
		ROLLBACK TRANSACTION 
	
	-- Add the job schedules  
	EXECUTE @ReturnCode = [msdb].[dbo].[sp_add_jobschedule] @job_id = @JobID, @name = N'Schedule 1', @enabled = 1, @freq_type = @JobType , @active_start_date = @JobStartDate, @active_start_time = @JobTime, @freq_interval = @Jobday, @freq_subday_type = 1, @freq_subday_interval = 0, @freq_relative_interval = 0, @freq_recurrence_factor = 1, @active_end_date = 99991231, @active_end_time = 235959 
	IF (@@ERROR <> 0 OR @ReturnCode <> 0) 
		IF (@@TRANCOUNT > 0) 
		ROLLBACK TRANSACTION 

	-- Add the Target Servers  
	EXECUTE @ReturnCode = [msdb].[dbo].[sp_add_jobserver] @job_id = @JobID, @server_name = N'(local)' 
	IF (@@ERROR <> 0 OR @ReturnCode <> 0) 
		IF (@@TRANCOUNT > 0) 
		ROLLBACK TRANSACTION 

	COMMIT TRANSACTION  
	RETURN 


GO

SET ANSI_NULLS, QUOTED_IDENTIFIER ON
GO

Create Procedure [dbo].[PrcSMSLog]
(	
	@UserGuid uniqueidentifier = 0x0,
	@Phone Varchar(256) = '',
	@OperationNote int = 0,
	@ActiveNote Bit = 0,
	@Msg Varchar(256) = '',
	@ActiveDate Bit = 0,
	@Date1 DateTime = '1/1/2007',
	@Date2 DateTime = '1/1/2008'
)
 
as
	if @OperationNote = 0 --
	Set @Msg  = '%'+@Msg+'%'

	Select 
		S.*,
		S.Date as [Time],
		U.loginName as [UserName],
		Cast('' as VARchar(256)) as CustName,
		Cast(0x0 as uniqueidentifier) as CustGuid
	into #SMSLog_Tmp
	From 
		[SMSLog] S		
		inner join Realty_Users U on U.Guid = S.UserGuid
	where
		(S.userGuid = @UserGuid or @UserGuid = 0x0)
		and (S.Phone = @Phone or @Phone = '')
 		and 
 			(
 				[S].[Msg] Like @Msg
 				or @ActiveNote = 0
 			)
 		and (dbo.fndateOnly([Date]) Between @Date1 And @Date2 or @ActiveDate = 0)
	
	Update #SMSLog_Tmp Set CustGuid = C.Guid, CustName = C.Name
	From
		#SMSLog_Tmp S
		inner join Customer C on C.mobile = s.phone
		
	Select 
		*
	from 
		#SMSLog_Tmp S
	Order By 
		DATe
		

GO

SET ANSI_NULLS, QUOTED_IDENTIFIER ON
GO

Create View [vwAssetsGroup]
 
as
	Select
		[A].[Number], [A].[Guid], [A].[Code], [A].[ParentGuid], [A].[Note], [A].[LtnName],
		[A].[Name] as [ArName],
		Case when (dbo.FnGetLangauge(@@spid) = 1) and (Isnull([A].[LtnName],'') <> '') then [A].[LtnName] else [A].[Name] end as [Name]
	From 
		[vbAssetsGroup] [A]


GO

SET ANSI_NULLS, QUOTED_IDENTIFIER ON
GO

Create Procedure dbo.[PrcReCreateEntryChecksPartialCollection]
(
	@Guid uniqueidentifier = 0x0
)
 
as
	Declare @PartGuid uniqueidentifier, 
			@CheckGuid uniqueidentifier, 
			@TypeGuid uniqueidentifier

	DECLARE cursor_Name_2 CURSOR FAST_FORWARD FOR 
	Select 
			p.Guid, CheckGuid, C.TypeGuid
	From 
			ChecksPartialCollection P 
			inner join checks c on C.Guid = p.CheckGuid
	where
		p.CheckGuid = @Guid
	
	OPEN cursor_Name_2
	FETCH NEXT FROM cursor_Name_2 INTO @PartGuid, @CheckGuid, @TypeGuid
	
	WHILE @@FETCH_STATUS = 0
	BEGIN
		exec [PrcCreateEntryChecksPartialCollection] @PartGuid, @CheckGuid, @TypeGuid, 1
		
	  FETCH NEXT FROM cursor_Name_2 INTO @PartGuid, @CheckGuid, @TypeGuid
	END
	
	CLOSE cursor_Name_2
	DEALLOCATE cursor_Name_2

GO

SET ANSI_NULLS, QUOTED_IDENTIFIER ON
GO
Create View [vwLastFlatSalesPrice]
 
as
	Select 
		[C].[ParentGuid],
		[Price] as [Sale],
		[CurrencyGuid] as [SaleCurrencyGuid]
	From
		[ChangeFlatPrice] [C]
		inner join (
						Select 
								[ParentGuid],
								Max(Date) as [MaxDate],
								Max([Number]) as [MaxNumber]
						From
							[ChangeFlatPrice]
						where
							[Kind] = 1
						Group By
							[ParentGuid]
					) [C2] on [C2].[ParentGuid] = [C].[ParentGuid] 
							and [C].[Date] = [C2].[MaxDate] 
							and (Case when [C].[Date] = [C2].[MaxDate] then [MaxNumber] else [C].[Number] end = [C].[Number])
	where
		[Kind] = 1
							

GO

SET ANSI_NULLS, QUOTED_IDENTIFIER ON
GO
Create View [vwChangeBuildingGuard]
 
as
	Select
		C.*,
		G.Name
	From
		[ChangeBuildingGuard] [C]
		inner join Building [b] on [b].Guid = [C].[BuildingGuid]
		inner join BuildingGuard [G] on [G].Guid = [C].[GuardGuid]

GO

SET ANSI_NULLS, QUOTED_IDENTIFIER ON
GO
CREATE PROCEDURE crosstab 
	@select varchar(8000),
	@sumfunc varchar(100), 
	@pivot varchar(100), 
	@table varchar(100),
	@TotalRowName varchar(100),
	@TotalColName varchar(100)	
 
AS

	DECLARE @sql varchar(8000), @delim varchar(1)
	SET NOCOUNT ON
	SET ANSI_WARNINGS OFF

	Print 'SELECT ' + @pivot + ' AS [pivot] INTO ##pivot FROM ' + @table + ' WHERE 1=2'
	EXEC ('SELECT ' + @pivot + ' AS [pivot] INTO ##pivot FROM ' + @table + ' WHERE 1=2')

	Print 'INSERT INTO ##pivot SELECT DISTINCT ' + @pivot + ' FROM ' + @table + ' WHERE ' 
	+ @pivot + ' Is Not Null'

	EXEC ('INSERT INTO ##pivot SELECT DISTINCT ' + @pivot + ' FROM ' + @table + ' WHERE ' 
	+ @pivot + ' Is Not Null')

	SELECT @sql='',  @sumfunc=stuff(@sumfunc, len(@sumfunc), 1, ' END)' )

	SELECT @delim=CASE Sign( CharIndex('char', data_type)+CharIndex('date', data_type) ) 
	WHEN 0 THEN '' ELSE '''' END 
	FROM tempdb.information_schema.columns 
	WHERE table_name='##pivot' AND column_name='pivot'

	
	SELECT @sql=@sql + '''' + convert(varchar(100), [pivot]) + ''' = ' + 
	stuff(@sumfunc,charindex( '(', @sumfunc )+1, 0, ' CASE ' + @pivot + ' WHEN ' 
	+ @delim + convert(varchar(100), [pivot]) + @delim + ' THEN ' ) 
	+ ', ' FROM ##pivot


	SELECT @sql=@sql +''''+ @TotalRowName+''''+' = ' + replace(@sumfunc, 'END', '')+','

	DROP TABLE ##pivot


	SELECT @sql=left(@sql, len(@sql)-1)

	-- For Sum Column
	Declare @Sq Varchar(8000),
			@Sq2 Varchar(8000)
	Set @Sq = Left (@select, charindex('Group', @select)-1)
	Set @Sq2 = 'Select '''+@TotalColName+''''+','+@sql + ' From '+@table
	

	SELECT @select=stuff(@select, charindex(' FROM ', @select)+1, 0, ', ' + @sql + ' ')
	+'union All
'+@Sq2

	

	Print @select
	EXEC (@select)
	SET ANSI_WARNINGS ON

GO

SET ANSI_NULLS, QUOTED_IDENTIFIER ON
GO

Create View [vwServicesContractType]
 
as
	Select
		[A].[Number],
		[A].[Guid],
		[A].[SecLvl],
		[A].[Code] as [Code],
		[A].[Name] as [ArName],

		[A].[Name] as [TypeNameAr],
		[A].[Name] as [TypeNameLtn],

		Case when (dbo.FnGetLangauge(@@spid) = 1) and (Isnull([A].[LtnName],'') <> '') then [A].[LtnName] else [A].[Name] end as [Name], 
		[A].[ltnName],
		[A].[Menu] as [arMenu],
		Case when (dbo.FnGetLangauge(@@spid) = 1) and (Isnull([A].[LtnMenu],'') <> '') then [A].[LtnMenu] else [A].[Menu] end as [Menu], 
		[A].[LtnMenu],
		[A].[defprintPath],
		A.ShortCut,

		[ExpenceAccountGUID],
		[DiscountAccountGUID],

		[Rentcondition],
		[CreateEntry],
		[AutoCreateEntry],
		[AutoPostedEntry],
		[EntryDate],

		[MoveCostWithExpenceDebit],
		[MoveCostWithExpenceCredit],
		
		[MoveCostWithDiscountDebit],
		[MoveCostWithDiscountCredit],
		
		[DefPrintLogPath],
		[DefPrintReceipt],
		[DefPrintacquittance],
		
		[FirstPayNoteLtn],

		[ContractNoteLtn],
		
		Case when (dbo.FnGetLangauge(@@spid) = 1) and (Isnull([A].[FirstPayNoteLtn],'') <> '') then [A].[FirstPayNoteLtn] else [A].[FirstPayNote] end as [FirstPayNote],
		Case when (dbo.FnGetLangauge(@@spid) = 1) and (Isnull([A].[ContractNoteLtn],'') <> '') then [A].[ContractNoteLtn] else [A].[ContractNote] end as [ContractNote]
		
	From
		[ServicesContractType] [A]


GO

SET ANSI_NULLS, QUOTED_IDENTIFIER ON
GO
Create Procedure PrcIncMonthHijridate
(
	@MonthCount int = 10,
	@Date Datetime = 42200
)
 
as
	Declare 
		@Y int, @M int, @D int,
		@Hdate Varchar(256),
		@Sign int

	 
	Set @Hdate = CONVERT(char(10), @Date, 131)

	Set @Y = SUBSTRING(@Hdate, 7, 4)
	Set @M = SUBSTRING(@Hdate, 4, 2)
	Set @d = SUBSTRING(@Hdate, 1, 2)

	If @MonthCount > 0
	Set @Sign = 1 else Set @Sign = -1

	Set @M = @M + @MonthCount


	while @M -1 > 11
	begin
		Set @Y = @Y + @Sign;
		Set @M = @M + ( -12 * @Sign)
	end;

	--Select @Hdate as [HD], @Y as [Year], @M as [Month], @d As [Day], @Sign
	Select dbo.fnDecodeHijriDatetoGergDate(@y, @m, @d),
		CONVERT(char(10), dbo.fnDecodeHijriDatetoGergDate(@y, @m, @d), 131)

	

GO

SET ANSI_NULLS, QUOTED_IDENTIFIER ON
GO

Create Procedure [dbo].[PrcGetLinkRefCardNo]
(
	@Guid uniqueidentifier = '{06B9D35A-3D01-47FD-9B65-F01737A41ACD}',
	@TblName varchar(256) = 'DEntry',
	@FieldName  varchar(256) = 'ObverseAcGuid'
)

as
	Declare @Sql varchar(5000)
	if UPPER(@TblName) = UPPER('DEntry')
	begin
		Set @Sql = '
		Select 
			H.Number
		From 
			[Hentry] H
			inner join [Dentry] D on D.ParentGuid = H.Guid
		where
			D.'+@FieldName+' ='+''''+ CAST(@Guid as varchar(256))+'''
		'
		
		Print @Sql
		exec (@Sql)
	end

GO

SET ANSI_NULLS, QUOTED_IDENTIFIER ON
GO
CREATE PROCEDURE CrossTabToTable 
	@select varchar(8000),
	@sumfunc varchar(100), 
	@pivot varchar(100), 
	@table varchar(100),
	@TotalRowName varchar(100),
	@TotalColName varchar(100)	
 
AS

	DECLARE @sql varchar(8000), @delim varchar(1)
	SET NOCOUNT ON
	SET ANSI_WARNINGS OFF

	--Print 'SELECT ' + @pivot + ' AS [pivot] INTO ##pivot FROM ' + @table + ' WHERE 1=2'
	EXEC ('SELECT ' + @pivot + ' AS [pivot] INTO ##pivot FROM ' + @table + ' WHERE 1=2')

	--Print 'INSERT INTO ##pivot SELECT DISTINCT ' + @pivot + ' FROM ' + @table + ' WHERE ' 
	--+ @pivot + ' Is Not Null'

	EXEC ('INSERT INTO ##pivot SELECT DISTINCT ' + @pivot + ' FROM ' + @table + ' WHERE ' 
	+ @pivot + ' Is Not Null')

	SELECT @sql='',  @sumfunc=stuff(@sumfunc, len(@sumfunc), 1, ' END)' )

	SELECT @delim=CASE Sign( CharIndex('char', data_type)+CharIndex('date', data_type) ) 
	WHEN 0 THEN '' ELSE '''' END 
	FROM tempdb.information_schema.columns 
	WHERE table_name='##pivot' AND column_name='pivot'

	
	SELECT @sql=@sql + '''' + convert(varchar(100), [pivot]) + ''' = ' + 
	stuff(@sumfunc,charindex( '(', @sumfunc )+1, 0, ' CASE ' + @pivot + ' WHEN ' 
	+ @delim + convert(varchar(100), [pivot]) + @delim + ' THEN ' ) 
	+ ', ' FROM ##pivot


	SELECT @sql=@sql +''''+ @TotalRowName+''''+' = ' + replace(@sumfunc, 'END', '')+','

	DROP TABLE ##pivot


	SELECT @sql=left(@sql, len(@sql)-1)

	-- For Sum Column
	Declare @Sq Varchar(8000),
			@Sq2 Varchar(8000)
	Set @Sq = Left (@select, charindex('Group', @select)-1)
	Set @Sq2 = 'Select '''+@TotalColName+''''+','+@sql + ' From '+@table
	
	Declare @SSS Varchar(800)
	Set @SSS = @Sq
	
	SELECT @SSS=stuff(@select, charindex(' FROM ', @select)+1, 0, ', ' + @sql + ' ')
	SELECT @SSS=stuff(@SSS, charindex(' FROM ', @SSS)+1, 0, ' Into ResTblValue ')
	--Set @SSS = Left (@SSS, LEN(@SSS)-1)
	
	-- End 
	SELECT @select=stuff(@select, charindex(' FROM ', @select)+1, 0, ', ' + @sql + ' ')
	+'union All
'+@Sq2


	Set @select = 'insert into ResTblValue ' + @select
	
	if exists(Select * from SysObjects where name = 'ResTblValue')
	Drop Table ResTblValue
	
	Print @SSS
	exec (@SSS)

--	Select * from ResTblValue
	
	Truncate Table ResTblValue
	Print @select
	EXEC (@select)

	--Select * from ResTblValue

	SET ANSI_WARNINGS ON

GO

SET ANSI_NULLS, QUOTED_IDENTIFIER ON
GO

Create View [vwShop]
 
as

	Select
		*
	From
		[vwShopAll] [A]
	where
		isNull(A.Ban,0) = 0 


GO

SET ANSI_NULLS, QUOTED_IDENTIFIER ON
GO

	Create View [vbEarth]
	 
	as
		Select 
			[T].*
		From
			[Earth] [T]
			inner join [CurrentUsers] [U] on ([u].[Seclvl] >= Isnull([T].[SecLvl],0)  or [u].[Admin] = 1) and [u].[spid] = @@Spid
GO

SET ANSI_NULLS, QUOTED_IDENTIFIER ON
GO

Create Procedure [dbo].[PrcReCodeBuildingCost]
(
	@BuildingGuid uniqueidentifier = '7E3BF848-F210-4A0C-91B8-119C9C5EBB15'
)
 
as

	Declare @CoGuid uniqueidentifier 
	
	Select
		@CoGuid = CostGuid
	From 
		Building B 
	where
		b.Guid = @BuildingGuid

	if ISNULL(@CoGuid, 0x0) <> 0x0
	exec [PrcRecodeCost] @CoGuid
	


GO

SET ANSI_NULLS, QUOTED_IDENTIFIER ON
GO

Create Procedure [dbo].[PrcCreateAssetsOperationEntry]
(
	@Guid uniqueidentifier = 'C5D0C5DC-964A-4596-AE42-761427E00350'
)
 
as
	Declare @CeNumber Int
	Select
		@CeNumber = Number
	From
		HEntry
	where
		Guid = @Guid
		
	if isNull(@CeNumber,0) = 0
	Set @CeNumber = (Select isNull(MAX(Number),0) + 1 From HEntry)
	

	Delete
		HEntry
	where
		Guid = @Guid
		
	Declare @AccountGuid uniqueidentifier, 
			@ObverseAcGuid uniqueidentifier
			
	
	if exists(Select Top 1 IsRounded From [AssetsOperation] where  [Guid] = @Guid and isNull(IsRounded,0) = 1)
	begin
		Select * from [HEntry] where Guid = @Guid
		return
	end
			
	Declare @Flag int
	Select @Flag = [Flag] from [AssetsOperation] where Guid = @Guid
	
	if @Flag = 1
	Select
		@AccountGuid = S.AsstesAccountGuid,
		@ObverseAcGuid = A.AccountGuid
	From
		[AssetsOperation] A
		inner join Assets S on S.Guid = A.AssetsGuid
	where
		A.[Guid] = @Guid
				
	if @Flag = 2
	Select
		@AccountGuid = A.AccountGuid,
		@ObverseAcGuid = S.AsstesAccountGuid
	From
		[AssetsOperation] A
		inner join Assets S on S.Guid = A.AssetsGuid
	where
		A.[Guid] = @Guid

	if @Flag = 3
	Select
		@AccountGuid = S.ExpenseAccountGuid,
		@ObverseAcGuid = A.AccountGuid
	From
		[AssetsOperation] A
		inner join Assets S on S.Guid = A.AssetsGuid
	where
		A.[Guid] = @Guid

	Insert Into [HEntry]
	([Guid],[SecLvl],[Number],[Date], [CurrencyGuid], [CurrencyVal], [Note], [ParentKind], [BranchGuid], [IsPosted])
	Select
		@Guid,
		[SecLvl],
		@CeNumber,
		[Date],
		[CurrencyGuid],
		[CurrencyVal],
		[Note],
		150+Flag, --150, 151, 152
		Null,
		1
	From
		[AssetsOperation]
	where
		Guid = @Guid
			

	Declare @DetailNum Int
	Set @DetailNum = 0

	Insert into [DEntry]
 	([ParentGuid],[Number],[AcGuid],[Debit],[Credit],[CurrencyGuid],[CurrencyVal],[CostGuid],[ObverseAcGuid],[Note])
	Select
		@Guid,
		@DetailNum,
		@AccountGuid,
		A.[Value],
		0,
		A.CurrencyGUID,
		A.CurrencyVal,
		DebitCostGuid,
		@ObverseAcGuid,
		A.[Note]
	From
		[AssetsOperation] A
	where
		A.[Guid] = @Guid
				
	Set @DetailNum = @DetailNum + 1
	
	Insert into [DEntry]
 	([ParentGuid],[Number],[AcGuid],[Debit],[Credit],[CurrencyGuid],[CurrencyVal],[CostGuid],[ObverseAcGuid],[Note])
	Select
		@Guid,
		@DetailNum,
		@ObverseAcGuid,
		0,
		A.[Value],
		A.CurrencyGUID,
		A.CurrencyVal,
		CreditCostGuid,
		@AccountGuid,
		A.[Note]
	From
		[AssetsOperation] A
	where
		A.[Guid] = @Guid

	Select * from [HEntry] where Guid = @Guid
	Select * from [DEntry] where parentGuid = @Guid
			

GO

SET ANSI_NULLS, QUOTED_IDENTIFIER ON
GO

	Create View [vbparking]
	 
	as
		Select 
			[T].*
		From
			[parking] [T]
			inner join [CurrentUsers] [U] on ([u].[Seclvl] >= Isnull([T].[SecLvl],0)  or [u].[Admin] = 1) and [u].[spid] = @@Spid
GO

SET ANSI_NULLS, QUOTED_IDENTIFIER ON
GO
Create Procedure [PrcDeleteTable]
(
	@TblName Varchar(256) = '',
	@ToDataBaseName Varchar(256) = ''
)
 
as
	if @TblName = '' Return 

	Declare @Sql Varchar(5000)

	Set @sql = ' 
	Delete '+@ToDataBaseName+'..['+@TblName+']'
	--Print @sql
	
	exec(@sql)


GO

SET ANSI_NULLS, QUOTED_IDENTIFIER ON
GO

	Create View [vbRentInfo]
	 
	as
		Select 
			[T].*
		From
			[RentInfo] [T]
			inner join [CurrentUsers] [U] on ([u].[Seclvl] >= Isnull([T].[SecLvl],0)  or [u].[Admin] = 1) and [u].[spid] = @@Spid
GO

SET ANSI_NULLS, QUOTED_IDENTIFIER ON
GO

	Create View [vbChangeCurrencyRate]
	 
	as
		Select 
			[T].*
		From
			[ChangeCurrencyRate] [T]
			inner join [CurrentUsers] [U] on ([u].[Seclvl] >= Isnull([T].[SecLvl],0)  or [u].[Admin] = 1) and [u].[spid] = @@Spid
GO

SET ANSI_NULLS, QUOTED_IDENTIFIER ON
GO
Create View [vwShopPrint]
 
as
	Select
		[S].[Number] as [Number], 		[S].[Guid] as [Guid], 		[S].[SecLvl] as [SecLvl], 		[S].[NO] as [NO], 		[S].[Judicial] as [Judicial], 		[S].[Ban] as [Ban], 		[B].[Name] as [Building], 		[S].[Area] as [Area], 		[S].[Unity] as [Unity], 		[S].[ShopKind] as [ShopKind], 		[S].[Description] as [Description], 		[S].[Overlooking] as [Overlooking], 		[S].[CostPrice] as [CostPrice], 		[S].[CostCurrencyGUID] as [CostCurrencyGUID], 		[S].[Rent] as [Rent], 		[S].[RentCurrencyGUID] as [RentCurrencyGUID], 		[S].[Sale] as [Sale], 		[S].[SaleCurrencyGUID] as [SaleCurrencyGUID], 		[S].[Note] as [Note], 		[Co].[Name] as [Cost], 		[S].[FlatOwner] as [FlatOwner], 		[Cu].[Name] as [Cust], 		[S].[Details] as [Details], 		[S].[OfferState] as [OfferState], 		[S].[OfferType] as [OfferType], 		[S].[Restrained] as [Restrained], 		[S].[RestrainedUserGuid] as [RestrainedUserGuid], 		[S].[WaterCounter] as [WaterCounter], 		[S].[ElectricityCounter] as [ElectricityCounter], 		[S].[LtnShopKind] as [LtnShopKind], 		[S].[LtnDescription] as [LtnDescription], 		[S].[LtnOverlooking] as [LtnOverlooking], 		[S].[Class] as [Class], 		[S].[License1] as [License1], 		[S].[License2] as [License2]
	From
		[Shop] [S]
		inner join vwBuilding [b] on [b].Guid = [S].[BuildingGuid]
		left join vwCost [Co] on [Co].Guid = [S].[CostGuid]
		left join vwCustomer [Cu] on [Cu].Guid = [S].[CustGuid]

GO

SET ANSI_NULLS, QUOTED_IDENTIFIER ON
GO

	Create View [vbElectricityType]
	 
	as
		Select 
			[T].*
		From
			[ElectricityType] [T]
			inner join [CurrentUsers] [U] on ([u].[Seclvl] >= Isnull([T].[SecLvl],0)  or [u].[Admin] = 1) and [u].[spid] = @@Spid
GO

SET ANSI_NULLS, QUOTED_IDENTIFIER ON
GO

Create Trigger [TRG_UpdateAccountBalance]
on [Dentry]
 
For delete, insert--, update
As
	Select
		AcGuid,
		D.CurrencyGuid,
		D.CurrencyVal,
		Sum(D.Debit) as [Debit],	
		Sum(D.Credit) as [Credit]
		into #Del
	from
		deleted D
	Group By
		D.CurrencyGuid,
		D.CurrencyVal,
		AcGuid
		
	update Account 
	Set 
		SumDebit = isNull(SumDebit,0) - isNull(D.Debit * Case when ac.CurrencyGUID <> D.CurrencyGuid then D.CurrencyVal / Case when ac.CurrencyVal <> 0 then ac.CurrencyVal else 1 end else 1 end ,0),
		SumCredit = isNull(SumCredit,0) - isNull(D.Credit * Case when ac.CurrencyGUID <> D.CurrencyGuid then D.CurrencyVal / Case when ac.CurrencyVal <> 0 then ac.CurrencyVal else 1 end else 1 end ,0)
	from
		Account Ac
		inner join #del D on D.AcGuid = Ac.Guid
		
	Select
		AcGuid,
		D.CurrencyGuid,
		D.CurrencyVal,
		Sum(D.Debit) as [Debit],	
		Sum(D.Credit) as [Credit]
		into #insert
	from
		inserted D
	Group By
		D.CurrencyGuid,
		D.CurrencyVal,
		AcGuid
	
	update Account 
	Set 
		SumDebit = isNull(SumDebit,0) + isNull(D.Debit * Case when ac.CurrencyGUID <> D.CurrencyGuid then D.CurrencyVal / Case when ac.CurrencyVal <> 0 then ac.CurrencyVal else 1 end else 1 end ,0),
		SumCredit = isNull(SumCredit,0) + isNull(D.Credit * Case when ac.CurrencyGUID <> D.CurrencyGuid then D.CurrencyVal / Case when ac.CurrencyVal <> 0 then ac.CurrencyVal else 1 end else 1 end ,0)
	from
		Account Ac
		inner join #insert D on D.AcGuid = Ac.Guid
	

GO

SET ANSI_NULLS, QUOTED_IDENTIFIER ON
GO
Create Procedure [PrcBill_TransPost]
(
	@BillGuid uniqueidentifier = '235A2188-A90C-472D-8E24-AB496F988AAC'
)
 
as
	Declare @IsPost Bit 
	Select @IsPost = [IsPosted] From Bill where Guid = @BillGuid
	
	if @IsPost = 0 return
	
	Declare @MatGuid uniqueidentifier,
			@StoreInGuid uniqueidentifier,
			@StoreOutGuid uniqueidentifier,
			@mtQnt Float, 
			@Direction int, 
			@biQty Float, 
			@biQty2 Float, 
			@biQty3 Float
	
	DECLARE @cursor_Name CURSOR 
	Set @cursor_Name = CURSOR FAST_FORWARD FOR 

	SELECT 
		D.MatGuid,
		[B].[StoreInGuid],
		[B].[StoreOutGuid],
		[d].[Qty], 
		[d].[Qty2], 
		[d].[Qty3]	From
		[Trans] B
		inner join [TransDetail] D on D.parentGuid = B.Guid
	where
		B.Guid = @BillGuid
	
	OPEN @cursor_Name
	FETCH NEXT FROM @cursor_Name INTO @MatGuid ,@StoreInGuid, @StoreOutGuid,@biQty,@biQty2,@biQty3
	
	WHILE @@FETCH_STATUS = 0
	BEGIN
		SET @mtQnt = (@biQty)  
		
		UPDATE MatBalance 
		SET 
			[Qty] = [Qty] + @mtQnt ,
			[Qty2] = [Qty2] + @BiQty2 ,
			[Qty3] = [Qty3] + @BiQty3 
		WHERE 
			[StoreGUID] = @StoreInGuid
			AND [ParentGUID] = @MatGuid
			
		IF @@ROWCOUNT = 0 
		INSERT INTO [MatBalance]
		([ParentGuid], [StoreGUID],[Qty],[Qty2],[Qty3]) VALUES 
		(@MatGuid, @StoreInGuid, @mtQnt, @BiQty2, @BiQty3)


		UPDATE MatBalance 
		SET 
			[Qty] = [Qty] - @mtQnt ,
			[Qty2] = [Qty2] - @BiQty2 ,
			[Qty3] = [Qty3] - @BiQty3 
		WHERE 
			[StoreGUID] = @StoreOutGuid
			AND [ParentGUID] = @MatGuid

		IF @@ROWCOUNT = 0 
		INSERT INTO [MatBalance]
		([ParentGuid], [StoreGUID],[Qty],[Qty2],[Qty3]) VALUES 
		(@MatGuid, @StoreOutGuid, -@mtQnt, -@BiQty2, -@BiQty3)

	FETCH NEXT FROM @cursor_Name INTO @MatGuid ,@StoreInGuid, @StoreOutGuid,@biQty,@biQty2,@biQty3
	
	END
	
	CLOSE @cursor_Name
	DEALLOCATE @cursor_Name
	
	Select * from MatBalance

GO

SET ANSI_NULLS, QUOTED_IDENTIFIER ON
GO

	Create View [vbMapsConfig]
	 
	as
		Select 
			[T].*
		From
			[MapsConfig] [T]
			inner join [CurrentUsers] [U] on ([u].[Seclvl] >= Isnull([T].[SecLvl],0)  or [u].[Admin] = 1) and [u].[spid] = @@Spid
GO

SET ANSI_NULLS, QUOTED_IDENTIFIER ON
GO

Create Procedure [dbo].[PrcSetParkingPrice]
(
	@ParkingGuid uniqueidentifier = 0x0
)
 
as
	update Parking
	Set
		Sale = S.Sale,
		SaleCurrencyGUID = S.SaleCurrencyGuid
	from
		Parking P
		inner join (
					Select
						[ParentGuid],
						[Price] as [Sale],
						[CurrencyGuid] as [SaleCurrencyGuid]	
					From
						[ChangeParkingPrice] [C]
					where
						[Number] = (
									Select 
										Max([Number]) 
									From 
										[ChangeParkingPrice] [C2] 
									where 
										[C2].[ParentGuid] = [C].[ParentGuid]
									)
					) S on S.[ParentGuid] = p.Guid
	where
		P.Guid = @ParkingGuid or @ParkingGuid = 0x0
			

	update Parking
	Set
		Rent = S.Rent,
		RentCurrencyGUID = S.RentCurrencyGuid
	from
		Parking P
		inner join (
					Select
						[ParentGuid],
						[Price] as [Rent],
						[CurrencyGuid] as [RentCurrencyGuid]	
					From
						[ChangeParkingRent] [C]
					where
						[Number] = (
									Select 
										Max([Number]) 
									From 
										[ChangeParkingPrice] [C2] 
									where 
										[C2].[ParentGuid] = [C].[ParentGuid]
									)
					) S on S.[ParentGuid] = p.Guid
	where
		P.Guid = @ParkingGuid or @ParkingGuid = 0x0


GO

SET ANSI_NULLS, QUOTED_IDENTIFIER ON
GO

Create View [vwOwner]
 
as
	Select
		[A].[Number],[A].[Guid],[A].[SecLvl],[A].[Name] as [ArName],
		[A].[LtnName],[A].[Nationality],[A].[PersonalityNo],[A].[Address],[A].[Phone],[A].[Mobile],[A].[Fax],[A].[BoxNo],[A].[EMail],
		Case when (dbo.FnGetLangauge(@@spid) = 1) and (Isnull([A].[LtnName],'') <> '') then [A].[LtnName] else [A].[Name] end as [Name]
	From 
		[Owner] [A]


GO

SET ANSI_NULLS, QUOTED_IDENTIFIER ON
GO

	Create View [vbBuildingOffer]
	 
	as
		Select 
			[T].*
		From
			[BuildingOffer] [T]
			inner join [CurrentUsers] [U] on ([u].[Seclvl] >= Isnull([T].[SecLvl],0)  or [u].[Admin] = 1) and [u].[spid] = @@Spid
GO

SET ANSI_NULLS, QUOTED_IDENTIFIER ON
GO

Create Procedure [DropObject]
(
	@ObjName Varchar(256) = '#CountCurrentContract'
)
 
as
	Declare @Id Int

	Select 
		@id = Id
	From
		dbo.sysobjects 
	where 
		id = object_id(@ObjName) 

	if OBJECTPROPERTY(@id, N'IsView') = 1
	EXEC ('DROP View '+ @ObjName)

	if OBJECTPROPERTY(@id, N'IsProcedure') = 1
	EXEC ('DROP Procedure '+ @ObjName)


	if OBJECTPROPERTY(@id, N'IsTrigger') = 1
	EXEC ('DROP trigger '+ @ObjName)


	if exists (select * from dbo.sysobjects where id = @id and xtype in (N'FN', N'IF', N'TF'))
	EXEC ('DROP Function '+ @ObjName)


	if exists( Select *	From dbo.sysobjects where Name = @ObjName and Type = 'f')
	begin
		Declare @TblName Varchar(256)
		Set @TblName = (Select Name From dbo.sysobjects where Id = 
							( Select Parent_obj	From dbo.sysobjects where Name = @ObjName and Type = 'f')
						)	
						
		print 'Alter Table '+@TblName+' Drop '+@ObjName
		exec ('Alter Table '+@TblName+' Drop '+@ObjName)
	end

	if (
	Select 
		[xtype]
	From
		dbo.sysobjects 
	where 
		id = object_id(@ObjName) 
		) = 'U'
	begin
		Print 'DROP Table '+ @ObjName
		EXEC ('DROP Table '+ @ObjName)
	end


	
	if LEFT(@ObjName, 1) = '#'
	begin
		Declare @tmptblName varchar(255)
		
		Select @tmptblName = Name from tempdb.sys.objects where name like  @ObjName+'%'
		begin
			if @tmptblName is Not Null 
			begin
				Print 'DROP Table tempdb..'+ @tmptblName
				EXEC ('DROP Table tempdb..'+ @tmptblName)
			end
		end
	end


GO

SET ANSI_NULLS, QUOTED_IDENTIFIER ON
GO

Create Procedure [dbo].[PrcPrintLawsuitState]
(
	@Guid uniqueidentifier = 0x0
)
 
as
	Select 
		S.* ,
		L.[StartDate],
		L.[No],
		L.[StopPayDate],
		L.[QuittanceDate],
		L.[QuittanceElectricityDate],
		L.[Rent],
	
		L.[IsEnded],
		L.[EndDate],
		L.[ExeNo]
	From 
		[Lawsuit] L
		inner join [vwLawsuitState] S on S.ParentGuid = L.Guid
		inner join [Resource] R on r.Guid = S.Guid
	order By
		S.number

GO

SET ANSI_NULLS, QUOTED_IDENTIFIER ON
GO
Create view [vwCheckPartialCollection]
 
as
	Select 
		[P].[Number],
		[P].[TypeName],
		[Cu].[Name] as [CustName],
		[Cu].[ArName] as [CustArName],
		[Cu].[LtnName] as [CustLtnName]
		,[P].[No]
		,[P].[Value]
		,[P].[Date]
		,[P].[DueDate]
		,[P].[BankName]
		,[P].[Note]
		,[P].[Note3]
		,DateDiff(Day,  [C3].[Date], GetDate()) as [DayDiff]
		,[L].[BuildingName]
		,[L].[BuildingArName]
		,[L].[BuildingltnName]
		,[L].[FlatNo]
		,[L].[FloorNo]
		,[L].[ContractNo]
		,[C3].[Date] as [CollectionDate]
		,(Select SUM(Value) From [ChecksPartialCollection] where [CheckGuid] = P.Guid) as [CollectionValue]
		,[P].[Guid]

		,[P].[AccountCode]
		,[P].[AccountName]

		,[L].[Emirate]
		,[L].[BuildingArea]
		,[L].[Suburb]
		,[L].[Street]
		,[L].[BasinNo]
		,[L].[PieceNo]
		,[L].[BuildingNo]
		,[L].[BondType]
		,[L].[BondNo]
		,[L].[FlatKind]
		,[L].[ApartmentType]
		,[L].[Class]
		,[L].[FlatArea]
		,[L].[FlatAreaunity]
		,[Cu].[Mobile] as [CustomerMobile]
		,[L].[BuildingGuid]
		,[P].[CurrencyGuid] as [CheckCurrencyGuid]
	From
		[vwChecks] [P]
		left join [vwCustomer] [Cu] on [Cu].[AcGuid] = [P].[Account]
		left join [vwLeaseApartment] [L] on [L].[Guid] = [P].[ContractGuid]
		inner join [ChecksPartialCollection] [C3] on [C3].[CheckGuid] = [P].[Guid] 

--		left join [RepSMS] [SMS2] on [SMS2].[ObjGuid] = [P].[Guid] and [SMS2].[IdReport] = 1200

GO

SET ANSI_NULLS, QUOTED_IDENTIFIER ON
GO

Create view [vwVillaOffer]
 
as
	Select 
		*
	From
		[vbVillaOffer] [A]


GO

SET ANSI_NULLS, QUOTED_IDENTIFIER ON
GO

	Create View [vbTrans]
	 
	as
		Select 
			[T].*
		From
			[Trans] [T]
			inner join [CurrentUsers] [U] on ([u].[Seclvl] >= Isnull([T].[SecLvl],0)  or [u].[Admin] = 1) and [u].[spid] = @@Spid
GO

SET ANSI_NULLS, QUOTED_IDENTIFIER ON
GO
Create View vwarv_FilterParams

as
	Select 
		C.ParamName as Caption ,
		'Prm' + Cast(id  as varchar(20)) as Name ,
		Case 
			when (C.ParamType = 'Float') or (C.ParamType = ' ') then 'Float'
			when (C.ParamType = 'Date') or (C.ParamType = '') then 'Date'
			when (C.ParamType = 'char') or (C.ParamType = '') then 'text'
			when (C.ParamType = 'Bit') or (C.ParamType = '/') then 'bit'
			when (C.ParamType = '')  then 'Guid'
			when (C.ParamType = 'Time') or (C.ParamType = '') then 'Time'
			when (C.ParamType = 'integer') or (C.ParamType = ' ') then 'int'
		end as [ColType],
		Case 
			when (C.ParamType = 'Float') or (C.ParamType = ' ') then 1
			when (C.ParamType = 'Date') or (C.ParamType = '') then 2
			when (C.ParamType = 'char') or (C.ParamType = '') then 3
			when (C.ParamType = 'Bit') or (C.ParamType = '/') then 4
			when (C.ParamType = '')  then 5
			when (C.ParamType = 'Time') or (C.ParamType = '') then 6
			when (C.ParamType = 'integer') or (C.ParamType = ' ') then 7
		end as [ColintType],
		C.ParamDef,
		C.ParamFld,
		C.ParentGuid,
		C.id
	from 
		arv_FilterParams C


GO

SET ANSI_NULLS, QUOTED_IDENTIFIER ON
GO
Create Procedure [PrcDropColumn]
(
	@TableName  Varchar(256) = 'LeaseApartment', 
	@ColumnName Varchar(256) = 'OtherFeeAccount1GUID'
)
 
as
	SET @TableName = REPLACE(REPLACE(@TableName, ']', ''), '[', '') 
	SET @ColumnName = REPLACE(REPLACE(@ColumnName, ']', ''), '[', '') 

	Declare @TblId Int,
			@DF_Id Int,
			@DFName Varchar(256)			

	Select @TblId = [id] from Sysobjects
	where Name = @TableName

	
	--Print @TblId

	Select @DF_Id = [Cdefault] from SysColumns
	where 
		[Name] = @ColumnName 
		and ([id]=@TblId)

	
	--Print @DF_Id

	Select @DFName = [Name] from Sysobjects
	where 
		([id]= @DF_Id)

	Declare @Sql Varchar(800)

	if @DF_Id <> 0
	begin	
		Set @Sql = 'alter Table '+@TableName+' Drop '+@DFName
		
		Print @Sql
		Exec (@SQl)
		Print 'successfully'
	end

	Select
		@DFName = F.Name
	from 
		SysObjects F
		inner join SysObjects T on T.id = F.Parent_Obj
		inner join syscolumns clmns ON clmns.id = T.id
		inner join dbo.sysforeignkeys AS colfk 	on colfk.fkey = clmns.colid and colfk.fkeyid = clmns.id
		inner join dbo.sysobjects Ftbl On Ftbl.id = colfk.rkeyid and F.Name = 'FK_'+T.name+'_'+clmns.[Name]
		inner join dbo.syscolumns AS Fclmns ON Fclmns.id = colfk.rkeyid and Fclmns.ColId = colfk.rkey
	where 
		F.XType = 'F'
		and T.name = @TableName 
		and clmns.[Name] = @ColumnName
	
	if isNull(@DFName,'') <> ''
	begin	
		Set @Sql = '	
		alter Table '+@TableName+' Drop '+@DFName
		
		Print @Sql
		Exec (@SQl)
		Print 'successfully'
	end

	if Exists(	Select * from SysColumns where Name = @ColumnName
	and Id = @TblId)
	begin

		Set @Sql = 'alter Table '+@TableName+' Drop Column '+@ColumnName
		Print @Sql
		Exec (@SQl)
		Print 'successfully'
	end
	else
	Print 'Field '+@ColumnName+' Not exists'


GO

SET ANSI_NULLS, QUOTED_IDENTIFIER ON
GO

Create Trigger [TRG_Trace_MatGroup]
on [MatGroup]
 
for update
As
	SET NOCOUNT ON;
	if Not exists(Select Value from DMD_const where vName = 'ActiveLogCardUpdate' and Value = '1' ) return
	
	Declare @UserGuid uniqueidentifier, @Guid uniqueidentifier
	Set @Guid = NEWID()
	
	Select Top 1 @UserGuid = userGuid From CurrentUsers where Spid = @@SPID
			
	insert into [Trace]
	([Guid],[ParentGuid],[Date],[userGuid],[HostName],[ParentTbl] )
	Select Top 1
		@Guid,
		N.Guid,
		GETDATE(),
		@UserGuid,
		Host_Name(),
		'MatGroup'
	From
		[inserted] n 
		
	insert into [TraceDetail]
	([ParentGuid],[Caption],[Old],[New],[Tbl])
	Select Top 1
		@Guid,
		' ' as [Caption],
		D.[SecLvl] as [old],
		N.[SecLvl] as [New],
		''
	From
		[deleted] d
		inner join [inserted] n on D.Guid = N.Guid
	where
		N.[SecLvl] <> D.[SecLvl]
		
	insert into [TraceDetail]
	([ParentGuid],[Caption],[Old],[New],[Tbl])
	Select Top 1
		@Guid,
		'' as [Caption],
		D.[Code] as [old],
		N.[Code] as [New],
		''
	From
		[deleted] d
		inner join [inserted] n on D.Guid = N.Guid
	where
		N.[Code] <> D.[Code]
		
	insert into [TraceDetail]
	([ParentGuid],[Caption],[Old],[New],[Tbl])
	Select Top 1
		@Guid,
		'' as [Caption],
		D.[Name] as [old],
		N.[Name] as [New],
		''
	From
		[deleted] d
		inner join [inserted] n on D.Guid = N.Guid
	where
		N.[Name] <> D.[Name]
		
	insert into [TraceDetail]
	([ParentGuid],[Caption],[Old],[New],[Tbl])
	Select Top 1
		@Guid,
		' ' as [Caption],
		D.[LtnName] as [old],
		N.[LtnName] as [New],
		''
	From
		[deleted] d
		inner join [inserted] n on D.Guid = N.Guid
	where
		N.[LtnName] <> D.[LtnName]
		
	insert into [TraceDetail]
	([ParentGuid],[Caption],[Old],[New],[Tbl])
	Select Top 1
		@Guid,
		'' as [Caption],
		D.[Note] as [old],
		N.[Note] as [New],
		''
	From
		[deleted] d
		inner join [inserted] n on D.Guid = N.Guid
	where
		N.[Note] <> D.[Note]
		
	insert into [TraceDetail]
	([ParentGuid],[Caption],[Old],[New],[Tbl])
	Select Top 1
		@Guid,
		' ' as [Caption],
		D.[ParentGuid] as [old],
		N.[ParentGuid] as [New],
		'[MatGroup]'
	From
		[deleted] d
		inner join [inserted] n on D.Guid = N.Guid
	where
		N.[ParentGuid] <> D.[ParentGuid]
		
	delete Trace From Trace t left join [TraceDetail] D on T.guid = D.ParentGuid
	where
		d.ParentGuid is Null and t.Guid = @Guid


GO

SET ANSI_NULLS, QUOTED_IDENTIFIER ON
GO

Create Procedure PrcCalcMaxStorecode
(
	@Guid uniqueidentifier = '{ADCE91EB-16AD-49DB-8F74-410DC81E3E1C}'
)
 as

	Declare @LenCode int
	Set @LenCode = (Select Len([Code]) From Store where [Guid] = @Guid)
	Declare @mxCode varchar(255)
	Set @mxCode = '' 
	select
		@mxCode = 
		Case when ISNUMERIC( RIGHT(Max([Code]), Len(Max([Code])) - @LenCode)) = 1
		then RIGHT(Max([Code]), Len(Max([Code])) - @LenCode)
		end
	From 
		Store
	where 
		[ParentGuid] = @Guid	
	
	Declare @ChildCount int
	Select @ChildCount = COUNT(*) From Store where ParentGUID = @Guid
	
	if (ISNULL(@mxCode,'') = '') and (ISNULL(@ChildCount,0) <> 0)

	Declare @Ms Varchar(256)
	Set @Ms = dbo.SC('      ') + '  ' + @mxCode

	if ISNULL(@mxCode,'') <> ''
	begin
		RAISERROR (@Ms, 16, 1)
		return
	end


	Declare @Code Varchar(20)
	Set @Code = (Select [Code] From Store where [Guid] = @Guid)
	
	Declare @MaxCode varchar(255)
	Select 
		@MaxCode = Max(Cast([Code] as numeric(20)))
	From 
		Store where ParentGuid =@Guid	
							
	
	Declare @LenNewCode int
	Set @LenNewCode = Len(@MaxCode)  - @LenCode

	if ISNULL(@LenNewCode, 0) = 0 Set @LenNewCode = 1
		
	Select 
		@Code + 
		ISNULL(
		Cast(
				dbo.FnFormatNumber(
									Right(Cast(RIGHT(@MaxCode, Len(@MaxCode) - @LenCode)as int)+1 , 
									@LenNewCode), @LenNewCode) as Varchar(256
								  )
			), '01') as [Code]
			

GO

SET ANSI_NULLS, QUOTED_IDENTIFIER ON
GO
Create View [vwChangeCurrencyRate]
 
as
	Select
		a.*,
		b.Name
	From
		[ChangeCurrencyRate] [a]
		inner join vwCurrency [b] on [b].Guid = [a].[CurrencyGUID]

GO

SET ANSI_NULLS, QUOTED_IDENTIFIER ON
GO
Create Procedure dbo.[ReNumberTable]
(
	@TableName Varchar(256) = 'GeneralBill',
	@SortBy Varchar(256) = 'BillDate, Number'
)
 
as
	Declare @Sql Varchar(2000)
	
	Set @Sql = 'Alter Table '+@TableName+' Disable Trigger All'
	Print @Sql
	exec (@Sql)		
	
	Set @Sql = '
	Create Table #T
	(
		[ID] int identity(1,1),
		[Guid] uniqueidentifier
	)

	Insert into #T
	([Guid])
	Select 
		Guid
	From
		'+@TableName+'
	Order By
		'+@SortBy+'

	Update '+@TableName+'
	Set Number = id
	From
		#T t
		inner join '+@TableName+' b on b.Guid = t.Guid'

	Print @Sql
	exec (@Sql)	

	Set @Sql = 'Alter Table '+@TableName+' Enable Trigger All'
	Print @Sql
	exec (@Sql)		
	

GO

SET ANSI_NULLS, QUOTED_IDENTIFIER ON
GO

Create Procedure [PrcTestRentedFlat]
(
	@CardGuid uniqueidentifier = '2AC942CE-CCAF-4871-B2AB-A044564D8EF9',
	@FlatGuid uniqueidentifier = '3AFE1F3B-44F3-49F1-9850-7A2A6A7CBF93',
	@FromDate DateTime = '2011-06-01 00:00:00',
	@ToDate DateTime = '2012-02-15 00:00:00'
)
 
as
	Select
		Number,ApartmentGuid
	from
		[LeaseApartment]
	where
		([ApartmentGuid] = @FlatGuid)
		and (
				(
					--[ContractFinish] = 0
					--and
					(
						   (@FromDate between [FromDate] and (Case when [ContractFinish] = 0 then [ToDate] else [ContractFinishDate] end))
						or(
							[FromDate] between @FromDate and @ToDate
						   )
						or(
							 @ToDate between [FromDate] and (Case when [ContractFinish] = 0 then [ToDate] else [ContractFinishDate] end)
						   )
						or(
							 @ToDate between [FromDate] and (Case when [ContractFinish] = 0 then [ToDate] else [ContractFinishDate] end)
						   )
						--or(
						--	(@FromDate < [ContractFinishDate] and [ContractFinish] = 1)
						--   )
						or((Case when [ContractFinish] = 0 then [ToDate] else [ContractFinishDate] end) between @FromDate and @ToDate)
				   )
				)
		   )
		and ([Leasekind] = 0 or [Leasekind] = 1)
	   and [Guid] <> @CardGuid


GO

SET ANSI_NULLS, QUOTED_IDENTIFIER ON
GO

Create Procedure [PrcGetLandWallet]
(
	@Guid uniqueidentifier = '88337EB2-DBD4-42D1-A535-34662BFF6BE8'
)
 
as
	Select 
		'' as [Building],
		[F].[Name] as [Land],
		[W].[MainCost],
		[Expense],
		[W].[BeginDate],
		[C].[SaleDate],
		DATEDIFF(Day,[W].[BeginDate], [C].[SaleDate]) as [DayCount],
		[C].[SaleValue] * Case when [Wl].[CurrencyGuid] <> [C].[CurrencyGuid] then [C].[CurrencyVal] / [Wl].[CurrencyVal] else 1 end as [SaleValue],
		[C].[SaleValue] * Case when [Wl].[CurrencyGuid] <> [C].[CurrencyGuid] then [C].[CurrencyVal] / [Wl].[CurrencyVal] else 1 end
		-
		( isnull([w].[Expense],0) + [W].[MainCost] )
		as  [Profit],
		0x0 as [BuildingGuid],
		[W].[LandGuid]
	From 
		[wallet] [Wl]
		inner join [Landwallet] [W] on [W].[ParentGuid] = [Wl].[Guid]
		inner join [vwEarth] [F] on [F].[Guid] = [w].[LandGuid]
		left join (
					Select 
						[LandGuid],
						[FromDate] as [SaleDate],
						[Rent] as [SaleValue],
						[CurrencyGuid],
						[CurrencyVal]
					From
						[vwLandContract]
					where 
						[ContractKind] = 6
					) [C] on [C].[LandGuid] = [W].[LandGuid]
	where
		[W].[ParentGuid] = @Guid
	Order By
		[W].[Number]

GO

SET ANSI_NULLS, QUOTED_IDENTIFIER ON
GO
Create Procedure dbo.[ReNumberTableType]
(
	@TableName Varchar(256) = 'GeneralBill',
	@FiledType Varchar(256) = 'BillTypeGuid',
	@SortBy Varchar(256) = 'BillDate, Number',
	@DataType Varchar(256) = 'uniqueidentifier',
	@Where Varchar(256) = ''
)
 
as
	Declare @Sql Varchar(2000)
	
	Set @Sql = 'Alter Table '+@TableName+' disable Trigger all'
	Print @Sql
	exec (@Sql)	

	Set @Sql = '
	
	Create Table #Tbl
	(
		[ID] int identity(1,1),
		[Guid] uniqueidentifier
	)


	Declare @TypeGuid '+@DataType+'

	DECLARE @CURSOR_NAME CURSOR 
	SET @CURSOR_NAME = CURSOR FAST_FORWARD FOR 

	SELECT Distinct '+@FiledType+'
	FROM '+@TableName+'

	OPEN @CURSOR_NAME
	FETCH NEXT FROM @CURSOR_NAME INTO @TypeGuid

	WHILE @@FETCH_STATUS = 0
	BEGIN
		Truncate Table #Tbl
		
		Insert into #Tbl
		([Guid])
		Select 
			Guid
		From
			'+@TableName+'
		where
			'+@FiledType+' = @TypeGuid
			'+Case when @Where <> '' then 'and '+@Where+'' else '' end +'
		Order By
			'+@SortBy+'

		Update '+@TableName+'
		Set [Number] = id
		From
			#Tbl t
			inner join '+@TableName+' b on b.Guid = t.Guid

	  FETCH NEXT FROM @CURSOR_NAME INTO @TypeGuid

	END

	CLOSE @CURSOR_NAME
	DEALLOCATE @CURSOR_NAME
	
	Drop Table #Tbl'

	Print @Sql
	exec (@Sql)	
	
	Set @Sql = 'Alter Table '+@TableName+' Enable Trigger all'
	Print @Sql
	exec (@Sql)	
	
	

GO

SET ANSI_NULLS, QUOTED_IDENTIFIER ON
GO

CREATE FUNCTION dbo.[FnGetTraceValue] (@TblName Varchar(256), @Value Varchar(256))
RETURNS Varchar(256)  AS BEGIN
	
	Declare @R Varchar(256), 
			@Sql Varchar(256)
			
	if upper(@TblName) = '[ACCOUNT]' or upper(@TblName) = 'ACCOUNT'
	Select @R = Code +'-'+ Name From VwAccount where Guid = @Value

	if upper(@TblName) = '[CUSTOMER]' or upper(@TblName) = 'CUSTOMER'
	Select @R = Name From VwCUSTOMER where Guid = @Value

	if upper(@TblName) = upper('[ContractType]') or upper(@TblName) = upper('ContractType')
	Select @R = Name From VwContractType where Guid = @Value
	
	if upper(@TblName) = upper('[RentInfo]') or upper(@TblName) = upper('RentInfo')
	Select @R = Name From RentInfo where Guid = @Value

	if upper(@TblName) = upper('[SalesMan]') or upper(@TblName) = upper('SalesMan')
	Select @R = Name From SalesMan where Guid = @Value

	if upper(@TblName) = upper('[Building]') or upper(@TblName) = upper('Building')
	Select @R = Name From vwBuilding where Guid = @Value

	if upper(@TblName) = upper('[Apartment]') or upper(@TblName) = upper('Apartment')
	Select @R = NO+'-'+BuildingName From vwApartment where Guid = @Value

	if upper(@TblName) = upper('[Cost]') or upper(@TblName) = upper('Cost')
	Select @R = Name From vwCost where Guid = @Value

	if upper(@TblName) = upper('[Currency]') or upper(@TblName) = upper('Currency')
	Select @R = Name From vwCurrency where Guid = @Value

	if upper(@TblName) = upper('[Realty_Users]') or upper(@TblName) = upper('Realty_Users')
	Select @R = LoginName From Realty_Users where Guid = @Value

	if upper(@TblName) = upper('[Branch]') or upper(@TblName) = upper('Branch')
	Select @R = Name From Branch where Guid = @Value

	if upper(@TblName) = upper('[vwAllContract]') or upper(@TblName) = upper('vwAllContract')
	Select @R = TypeName From vwAllContract where Guid = @Value

	if upper(@TblName) = upper('[Owner]') or upper(@TblName) = upper('Owner')
	Select @R = Name From vwOwner where Guid = @Value

	RETURN @R
END

GO

SET ANSI_NULLS, QUOTED_IDENTIFIER ON
GO

Create Procedure [dbo].[PrcTrace]
(
	@UserGuid uniqueidentifier = 0x0,
	@HostName Varchar(256) = '',
	@CardName Varchar(256) = '   ',
	@FieldName Varchar(256) = '',
	@CardNumber int = 0,
	@CkDate bit = 1,
	@Date1 DateTime = '1/1/2007',
	@Date2 DateTime = '1/1/2016'
)
 
as
	Select 
		D.*,
		D.Date as [Time] ,
		Cast(0 as int) as [CardNumber],
		Cast('' as varchar(256)) as [TypeName],
		Cast(0x0 as uniqueidentifier) as [TypeGuid]
	into #PrcTraceRs
	From 
		[vwTraceDetail] D
	where
		(D.userGuid = @UserGuid or @UserGuid = 0x0)
		and (D.hostName = @HostName or @HostName = '')
		and (D.CardName = @CardName or @CardName = '')
		and (D.FieldName = @FieldName or @FieldName = '')
		and (dbo.fnDateOnly(D.Date) between @Date1 and @Date2 or @CkDate = 0)
		
	update #PrcTraceRs 
	Set 
		[CardNumber] = S.Number,
		[TypeName] = S.TypeName,
		[TypeGuid] = S.TypeGuid
	from
		 #PrcTraceRs R
		 inner join vwAllContract S on S.Guid = R.parentGuid


	update #PrcTraceRs 
	Set 
		[CardNumber] = S.Number,
		[TypeName] = S.Name
	from
		 #PrcTraceRs R
		 inner join vwbuilding S on S.Guid = R.parentGuid

	update #PrcTraceRs 
	Set 
		[CardNumber] = S.Number
	from
		 #PrcTraceRs R
		 inner join HEntry S on S.Guid = R.parentGuid

	update #PrcTraceRs 
	Set 
		[CardNumber] = S.Number,
		[TypeName] = t.Name,
		[TypeGuid] = S.TypeGuid
	from
		 #PrcTraceRs R
		 inner join Secondary_Entry S on S.Guid = R.parentGuid
		 inner join [EntryType] T on T.Guid = S.TypeGuid

	update #PrcTraceRs 
	Set 
		[CardNumber] = S.Number,
		[TypeName] = s.TypeName,
		[TypeGuid] = S.TypeGuid
	from
		 #PrcTraceRs R
		 inner join vwchecks S on S.Guid = R.parentGuid
		 
	--    
	Delete #PrcTraceRs
	From
		#PrcTraceRs T
		left join [Resource] R on R.Guid = T.TypeGuid and Kind = 2 and R.Spid = @@SPID
	where
		(R.Guid is Null)
		and (
				T.ParentTbl = 'LeaseApartment'
				or T.ParentTbl = 'ParkingContract'
				or T.ParentTbl = 'LandContract'
			)

	--    
	Delete #PrcTraceRs
	From
		#PrcTraceRs T
		left join [Resource] R on R.Guid = T.TypeGuid and Kind = 1 and R.Spid = @@SPID
	where
		(R.Guid is Null)
		and (
				T.ParentTbl = 'EntryType'
			)

	--    
	Delete #PrcTraceRs
	From
		#PrcTraceRs T
		left join [Resource] R on R.Guid = T.TypeGuid and Kind = 3 and R.Spid = @@SPID
	where
		(R.Guid is Null)
		and (
				T.ParentTbl = 'Checks'
			)

	if @CardNumber <> 0
	delete #PrcTraceRs where CardNumber <> @CardNumber
	
	Select * from #PrcTraceRs
	order by Date		
	

GO

SET ANSI_NULLS, QUOTED_IDENTIFIER ON
GO

CREATE FUNCTION [FnMyRound] (@Number Float, @RoundKind  Float) 
RETURNS Float  AS
BEGIN
	Declare @IsMinus Bit
	if @Number >= 0
	Set @IsMinus = 0 Else Set @IsMinus = 1

	Set @Number = Abs(@Number)

	Declare @R Float
	Set @R = 0

	if @RoundKind = 0 --  
	Set @R = @Number

	if @RoundKind = 1 -- 
	Set @R = Round(@Number,0)
	
	if @RoundKind = 2 --    
	begin
		if @Number > Round(@Number,0) 	
		Set @R = Round(@Number,0) + 1

		if @Number <= Round(@Number,0) 	
		Set @R = Round(@Number,0)
	end

	if @RoundKind = 3 --    
	begin
		if @Number < Round(@Number,0) 	
		Set @R = Round(@Number,0) - 1

		if @Number >= Round(@Number,0) 	
		Set @R = Round(@Number,0)
	end

	Declare @A Int
		Set @A = Floor(@Number)- Floor(Floor(@Number)/10)*10
	
	if @RoundKind = 4 --    
	begin
		if @A < 5
		Set @R = Round(@Number,0) + 5 - @A

		if @A > 5
		Set @R = Round(@Number,0) + 10 - @A

		if (@A = 5) or (@A = 0)
		Set @R = Round(@Number,0)

		if @Number = 0 Set @R = 0
	end

	if @RoundKind = 5 --    
	begin
		if @A < 5 
		Set @R = Round(@Number,0) - @A

		if @A > 5
		Set @R = Round(@Number,0) - @A + 5

		if @A = 5
		Set @R = Round(@Number,0)

		if @Number = 0 Set @R = 0
	end


	if @RoundKind = 6 --    
	begin
		if @A < 10
		Set @R = Round(@Number,0) + 10 - @A

		if @A > 10
		Set @R = Round(@Number,0) + 10 - @A

		if (@A = 10) or (@A = 0)
		Set @R = @Number

	end

	if @RoundKind = 7 --    
	begin
		if @A < 10
		Set @R = Round(@Number,0) - @A

		if @A > 10
		Set @R = Round(@Number,0) - @A 

		if @A = 0
		Set @R = @Number

	end
	
	if Not (@RoundKind between 0 and 7)
	Set @R = @Number

	RETURN Case when @IsMinus = 1 then @R * -1 else @R end
END

GO

SET ANSI_NULLS, QUOTED_IDENTIFIER ON
GO

Create Function dbo.FnDayDiff (@D1 DateTime, @D2 DateTime, @RD1 DateTime, @RD2 DateTime )
returns int
 
begin

	Declare 
		@Date1 DateTime
		,@Date2 DateTime
	
	if @RD1 > @D1 
		Set @Date1 = @RD1
	else
		Set @Date1 = @D1

	if @RD2 > @D2
		Set @Date2 = @D2
	else
		Set @Date2 = @RD2

	declare @R int
	Set @R = DateDiff(Day, @Date1, @Date2)
	if @R < 0 set @R = 0
	return	@R

End

GO

SET ANSI_NULLS, QUOTED_IDENTIFIER ON
GO

Create Procedure [dbo].[PrcRenewalMaintenanceContractCount]
(
	@CustGuid uniqueidentifier = 0x0
)
 
as
	Declare @ContractCount int
	Select 
		@ContractCount = IsNull(COUNT(*),0) + 1 
	From 
		[MaintenanceContract]
	where
		CustomerGuid = @CustGuid
		
	Declare @CountOldContract int
	Select 
		@CountOldContract = Max([CountOldContract])
	From 
		[MaintenanceContract]
	where
		CustomerGuid = @CustGuid
		
	Select @CountOldContract as CountOldContract, @ContractCount as ContractCount

GO

SET ANSI_NULLS, QUOTED_IDENTIFIER ON
GO

CREATE proc Gold_PrcAddToextendedproperty
  @PropertyName varchar (50) = 'verstion',
  @PropertyValue varchar (50) = ''
 
as
   EXEC  sp_addextendedproperty @PropertyName,@PropertyValue



GO

SET ANSI_NULLS, QUOTED_IDENTIFIER ON
GO

Create Trigger [TRG_LeaseApartment_Del]
on [LeaseApartment]
 
For delete
As
	Delete [Hentry] From [HEntry] Inner join [Deleted] On [Deleted].[Guid] = [HEntry].[Guid]

	Delete [Checks] From [Checks] inner join [Deleted] On [Deleted].[Guid] = [Checks].[ContractGuid]

	Delete [Hentry] 
	From 
		[HEntry] [H]
		Inner join [LinkCe] [L] on [L].[CeGuid] = [H].[Guid]
		Inner join [Deleted] On [Deleted].[Guid] = [L].[Guid]
		
	Delete [Secondary_Entry] 
	From 
		[Secondary_Entry] [H]
		Inner join [Deleted] On [Deleted].[Guid] = [H].[ContractGuid]
		
	Delete [Trace] From [Trace] inner join [Deleted] On [Deleted].[Guid] = [Trace].[ParentGuid]
	
	Delete ContractWorkFlow From ContractWorkFlow inner join [Deleted] On [Deleted].[Guid] = ContractWorkFlow.[ContractGuid]
	
	Declare @Guid uniqueidentifier
	DECLARE cursor_Name CURSOR FAST_FORWARD FOR 
	Select Guid From deleted
	
	OPEN cursor_Name
	FETCH NEXT FROM cursor_Name INTO @Guid
	
	WHILE @@FETCH_STATUS = 0
	BEGIN
	
	  exec [PrcDeleteEntryContractFee] @Guid
		  
	  FETCH NEXT FROM cursor_Name INTO @Guid
	END
	
	CLOSE cursor_Name
	DEALLOCATE cursor_Name
		

GO

SET ANSI_NULLS, QUOTED_IDENTIFIER ON
GO
Create View [vwTransDiscount]
 
as

	Select
		[d].[Number], 
		[d].[Guid], 
		[d].[ParentGuid], 
		[d].[AccountGuid], 
		[a].[Code]+'-'+[a].[Name] as [Account], 
		[d].[Discount], 
		[d].[Extra], 
		[my].[Code] as [Currency], 
		[d].[CurrencyGuid], 
		[d].[CurrencyVal], 
		[Co].[Code]+'-'+[Co].[Name] as [Cost], 
		[d].[CostGuid], 
		[d].[obverseAccountGuid], 
		[o].[Code]+'-'+[o].[Name] as [obverseAccount], 
		[d].[Note]
	From
		[TransDiscount] [d]
		inner join [vwAccount] [a] on [a].[Guid] = [d].[AccountGuid]
		left join [vwAccount] [o] on [o].[Guid] = [d].[obverseAccountGuid]
		left join [vwCost] [Co] on [Co].[Guid] = [d].[CostGuid]
		left join [vwCurrency] [My] on [My].[Guid] = [d].[CurrencyGuid]


GO

SET ANSI_NULLS, QUOTED_IDENTIFIER ON
GO

Create Trigger [TRG_LandContract_Del]
on [LandContract]
 
For delete
As
	Delete [Hentry] From [HEntry] Inner join [Deleted] On [Deleted].[Guid] = [HEntry].[Guid]

	Delete [Checks] From [Checks] inner join [Deleted] On [Deleted].[Guid] = [Checks].[ContractGuid]

	Delete [Hentry] 
	From 
		[HEntry] [H]
		Inner join [LinkCe] [L] on [L].[CeGuid] = [H].[Guid]
		Inner join [Deleted] On [Deleted].[Guid] = [L].[Guid]
		
	Delete [Secondary_Entry] 
	From 
		[Secondary_Entry] [H]
		Inner join [Deleted] On [Deleted].[Guid] = [H].[ContractGuid]
		
	Delete [Trace] From [Trace] inner join [Deleted] On [Deleted].[Guid] = [Trace].[ParentGuid]
	
	Delete ContractWorkFlow From ContractWorkFlow inner join [Deleted] On [Deleted].[Guid] = ContractWorkFlow.[ContractGuid]

	Declare @Guid uniqueidentifier
	DECLARE cursor_Name CURSOR FAST_FORWARD FOR 
	Select Guid From deleted
	
	OPEN cursor_Name
	FETCH NEXT FROM cursor_Name INTO @Guid
	
	WHILE @@FETCH_STATUS = 0
	BEGIN
	
	  exec [PrcDeleteEntryContractFee] @Guid
		  
	  FETCH NEXT FROM cursor_Name INTO @Guid
	END
	
	CLOSE cursor_Name
	DEALLOCATE cursor_Name
	

GO

SET ANSI_NULLS, QUOTED_IDENTIFIER ON
GO

Create Procedure [PrcCheckSMS]
(
	@SMSText varchar(256) = '[A]'
)
 
as
	Set NoCount on

	Select 
		T.[CustName],
		T.[CustMobile],
		[T].[CustArName],
		[T].[CustLtnName],
		[T].[BuildingArName],
		[T].[BuildingltnName],
		[T].[FlatNo],
		[C].[NO],
		[C].[Value],
		t.ContractNo,
		C.DueDate,
		C.date,
		C.endDueDate,
		C.BankName,
		L.Date as CollDate,
		RT.Date as ReturnDate,
		C.Guid,
		@SMSText as [SMSText]
	into #CheckSMS
	From
		[vwChecks] [C]
		inner join vwAllContract T on T.Guid = C.ContractGuid
		left join [ChecksCollection] L on L.CheckGuid = C.Guid and L.Kind = 1
		left join [ChecksCollection] Rt on RT.CheckGuid = C.Guid and Rt.Kind = 3
		inner join [Resource] R on R.Guid = C.Guid and R.kind = 3700 and R.Spid = @@Spid
	
	update #CheckSMS Set [SMSText] = REPLACE([SMSText], '[A]', IsNull([CustArName],''))
	update #CheckSMS Set [SMSText] = REPLACE([SMSText], '[B]', IsNull([CustLtnName],''))
	update #CheckSMS Set [SMSText] = REPLACE([SMSText], '[T]', IsNull([BuildingArName],''))
	update #CheckSMS Set [SMSText] = REPLACE([SMSText], '[R]', IsNull([BuildingltnName],''))
	update #CheckSMS Set [SMSText] = REPLACE([SMSText], '[C]', IsNull([FlatNo],''))
	update #CheckSMS Set [SMSText] = REPLACE([SMSText], '[D]', IsNull([NO],''))
	update #CheckSMS Set [SMSText] = REPLACE([SMSText], '[E]',IsNull( ContractNo,''))
	update #CheckSMS Set [SMSText] = REPLACE([SMSText], '[F]',IsNull( dbo.fndate(DueDate),''))
	update #CheckSMS Set [SMSText] = REPLACE([SMSText], '[G]',IsNull( dbo.fndate(Date),''))
	update #CheckSMS Set [SMSText] = REPLACE([SMSText], '[H]',IsNull( dbo.fndate(endDueDate),''))
	update #CheckSMS Set [SMSText] = REPLACE([SMSText], '[J]',IsNull( BankName,''))
	update #CheckSMS Set [SMSText] = REPLACE([SMSText], '[K]',IsNull( dbo.fndate(CollDate),''))
	update #CheckSMS Set [SMSText] = REPLACE([SMSText], '[L]',IsNull( dbo.fndate(ReturnDate),''))
	update #CheckSMS Set [SMSText] = REPLACE([SMSText], '[V]',IsNull( Cast ([Value] as varchar(20)),''))
	
	Select * from #CheckSMS
	order By
		duedate
	


GO

SET ANSI_NULLS, QUOTED_IDENTIFIER ON
GO

Create Trigger [TRG_ElectricityBill_Delete]
on [ElectricityBill] 
 
For delete
As
	Delete [Hentry] From [HEntry] Inner join [Deleted] On [Deleted].[Guid] = [HEntry].[Guid]


GO

SET ANSI_NULLS, QUOTED_IDENTIFIER ON
GO

Create Trigger [TRG_ReceiptOrder_Delete]
on [dbo].[ReceiptOrder] 
 
For delete
As
	Declare @RowGuid uniqueidentifier

	Declare @I int
	Set @I = 1
	while @I < 10
	begin
		Select
			@RowGuid = D.Guid		
		From
			deleted O
			inner join ReceiptOrderDetail D on D.parentGuid = O.Guid
		where
			D.Guid = @RowGuid
			and D.Number = @I
	
		Delete [Secondary_Entry] where Guid = @RowGuid
		
		Set @I = @I + 1
	end

GO

SET ANSI_NULLS, QUOTED_IDENTIFIER ON
GO

Create Proc [Prc_sp_Who]
 
as
	Select 
		p.hostName,
		p.nt_username as loginname,
		p.login_time,
		p.Spid,
		p.Status,
		R.LoginName as UserName,
		p.cmd,
		Case when p.Spid = @@SPID then 1 else 0 end as [CurrentSession]
	from 
		master..sysprocesses P
		inner join master..sysDataBases d on p.[dbid] = d.[dbid]
		inner join [CurrentUsers] U on U.Spid = P.Spid
		inner join [Realty_Users] R on R.Guid = U.UserGuid
	where
		d.name = DB_NAME()
		and p.spid <> @@spid	
	Order By
		p.Spid

GO

SET ANSI_NULLS, QUOTED_IDENTIFIER ON
GO

Create Procedure [dbo].[PrcCalcElectricityOverdue]
(
	@Guid uniqueidentifier = '{1A1D6ECB-5D1B-44F5-9AAF-9A41AC704834}',
	@CustGuid uniqueidentifier = '{966B9012-AE38-4747-A505-5F0F9E5A8874}',
	@CurrencyGuid  uniqueidentifier = '{11111111-C748-4B13-8B91-1E9B299DF1C1}',
	@CurrencyVal Float = 1
)
 
as
	if @Guid is Null
	Select @Guid = Guid From ElectricityBill where Number = 1
	
	Declare @CheckValue Float,
			@CachValue Float,
			@SumElectricityValue Float
	
	Select 
		@SumElectricityValue = 
		Sum(	
		(isNull([P].Consumption,0) + isNull([P].WaterValue ,0) +isNull([P].DrainageValue ,0) +isNull([P].FineValue ,0) +isNull([P].FeeValue ,0) +
		isNull([P].Extra  ,0) - isNull([P].Discount  ,0)) * 
		Case when @CurrencyGuid = [CurrencyGUID] then 1 else [CurrencyVal] / @CurrencyVal end
		)
	From 
		[ElectricityBill] P
	where
		(Guid <> @Guid)
		and ([CustGuid] = @CustGuid)

	

	Select 
		@CheckValue = Sum([LL].[Value] * Case when @CurrencyGuid = P.[CurrencyGUID] then 1 else p.[CurrencyVal] / @CurrencyVal end)
	From
		[vwChecks] [P]
		inner join [LinkCheckContract] LL on LL.ParentGuid = P.Guid
		inner join ElectricityBill B on B.Guid = LL.ContractGuid 
 	where
 		(LL.[ContractGuid] <> @Guid)
 		and (b.CustGuid = @CustGuid )
 		
 	
	select
		@CachValue = Sum([P].[Value] * Case when @CurrencyGuid = p.[CurrencyGUID] then 1 else p.[CurrencyVal] / @CurrencyVal end)
	from
		vwElectricityCachPayment  [P]
		inner join ElectricityBill B on B.Guid = P.ContractGuid 
 	where
 		(P.[ContractGuid] <> @Guid)
 		and (b.CustGuid = @CustGuid )
 		
 	Select 
 			IsNull(@SumElectricityValue, 0) , IsNull(@CachValue,0) , IsNull(@CheckValue,0),
 			IsNull(@SumElectricityValue, 0) - (IsNull(@CachValue,0) + IsNull(@CheckValue,0)) as [Value]


GO

SET ANSI_NULLS, QUOTED_IDENTIFIER ON
GO

Create Procedure [PrcGetParameters]
(
	@PrcName Varchar(256) = 'PrcPrintReceipt'
)
 
as
	Declare @PrName Varchar(256)
			,@S Varchar(8000)
			,@PS Varchar(8000)

	Set @Ps = ''
	Set @S = '
	ShowWait(Rparameters, '');
    with QPublic Do
    begin
    	Close;
    	Sql.Clear;
    	Sql.Add(''Exec ['+@PrcName+']'');'
	DECLARE cursor_Name CURSOR FAST_FORWARD FOR 
	Select [Name] from SysColumns  where Id = (Select Id from SysObjects  where Name = @PrcName)
	Order By Colid
	
	OPEN cursor_Name
	FETCH NEXT FROM cursor_Name INTO @PrName
	
	WHILE @@FETCH_STATUS = 0
	BEGIN
	  
	Set @S = @S + +'
		Sql.Add('''+@PrName+' = :'+RIGHT(@PrName, len(@PrName) -1)+','');'
	Set @Ps = @Ps + '
		Parameters.ParamByName('''+RIGHT(@PrName, len(@PrName) -1)+''').Value := '+RIGHT(@PrName, len(@PrName) -1)+';'

	  FETCH NEXT FROM cursor_Name INTO @PrName
	
	END
	
	CLOSE cursor_Name
	DEALLOCATE cursor_Name

	Set @S = Left(@S, len(@S) -4)+''');' + @Ps
	Set @S = @S + '
   		Open;
    end;
    
    if Not Assigned(FrmShow__) then
    FrmShow__ := TFrmShow__.Create(Self);

    for I := 0 to ColList.Count -1 do
    if Not ColList.Checked[i] then
    begin
        FrmShow__.MyGrid1.ColWidths[I+1] := -1;
    end;

    CloseWait;

    FrmShow__.LBDate.Caption := ''  ''+ Date1.Text + ''  '' + Date2.Text;

    FrmShow__.MyGrid1.DataSet := QPublic;
    FrmShow__.MyGrid1.LoadFromDataSet(True);

    FrmShow__.Show;
    '

	Print @S

	Exec @PrcName

GO

SET ANSI_NULLS, QUOTED_IDENTIFIER ON
GO

Create Procedure [PrcGetShopWallet]
(
	@Guid uniqueidentifier = '369CF34D-31AA-4381-BBCA-78E27197A9AA'
)
 
as
	Select 
		[B].[Name] as [Building],
		[F].[No] as [Shop],
		[W].[MainCost],
		[Expense],
		[W].[BeginDate],
		[C].[SaleDate],
		DATEDIFF(Day,[W].[BeginDate], [C].[SaleDate]) as [DayCount],
		[C].[SaleValue] * Case when [Wl].[CurrencyGuid] <> [C].[CurrencyGuid] then [C].[CurrencyVal] / [Wl].[CurrencyVal] else 1 end as [SaleValue],
		[C].[SaleValue] * Case when [Wl].[CurrencyGuid] <> [C].[CurrencyGuid] then [C].[CurrencyVal] / [Wl].[CurrencyVal] else 1 end
		-
		( isnull([w].[Expense],0) + [W].[MainCost] )
		as  [Profit],
		[W].[BuildingGuid],
		[W].[ShopGuid]
	From 
		[wallet] [Wl]
		inner join [Shopwallet] [W] on [W].[ParentGuid] = [Wl].[Guid]
		inner join [vwBuilding] [B] on [B].[Guid] = [W].[BuildingGuid]
		inner join [vwShop] [F] on [F].[Guid] = [w].[ShopGuid]
		left join (
					Select 
						[ShopGuid],
						[FromDate] as [SaleDate],
						([Rent]-[Discountvalue]) as [SaleValue],
						[CurrencyGuid],
						[CurrencyVal]
					From
						[vwLeaseApartment] 
					where 
						[LeaseKind] = 3
					) [C] on [C].[ShopGuid] = [W].[ShopGuid]
	where
		[W].[ParentGuid] = @Guid
	Order By
		[W].[Number]

GO

SET ANSI_NULLS, QUOTED_IDENTIFIER ON
GO
Create Procedure [PrcTransfer_ServicesContract]
(
	@RoKind int = 2,
	@ToDataBaseName Varchar(256) = 'AR1',
	@UntilDate Datetime = '2015-12-31',
	@BeginDate Datetime = '2016-1-1',
	@RoundContractWithCheckNotCollection bit = 0
)
 
as
	if (@RoKind = 1) Return --  
	
	Declare @V Varchar(8000)
	
	EXEC PrcDeleteTable 'ServicesContract',@ToDataBaseName
	
	Set @V = '
			where 
				[ContractFinish] = 0'
				
	if (@RoKind = 2) --    
	Set @V = @v + '
	or EditDate >='+''''+CAST(@UntilDate as varchar(255))+''''
				
	if (@RoundContractWithCheckNotCollection = 1) --       
	Set @V = @v + '
	or ([Guid] in (Select ContractGuid from vwChecksCollectionState where [IsCollection] = 0))'

	EXEC PrcTransferTable  'ServicesContract',@ToDataBaseName, @V
							
	
	Set @V = '
	Alter Table '+@ToDataBaseName+'..[ServicesContract] Disable Trigger All'
	exec (@v)

	--        
	Set @V = '
	UpDate '+@ToDataBaseName+'..[ServicesContract] Set [IsRounded] = 1 where EditDate <'+''''+CAST(@UntilDate as varchar(255))+''''
	exec(@V)

	--        
	Set @V = '
	UpDate '+@ToDataBaseName+'..[ServicesContract] Set [IsRounded] = 1 
	From
		'+@ToDataBaseName+'..[ServicesContract] L
		inner join HEntry H on L.Guid = H.Guid 
	where H.Date <'+''''+CAST(@UntilDate as varchar(255))+''''
	Print(@V)
	exec(@V)


 	Set @V = 'Update '+@ToDataBaseName+'..[ServicesContract] Set EditDate = '''+CAST(@BeginDate as VARchar(20))+'''where [IsRounded] = 1 '
	exec(@V)

	Set @V = '
	Alter Table '+@ToDataBaseName+'..[ServicesContract] Enable Trigger All'
	exec (@v)

	 
	Set @V = '
	exec '+@ToDataBaseName+'..ReNumberTableType
		''ServicesContract'',
		''[TypeGuid]'',
		''Number, FromDate'',
		''uniqueidentifier'',
		''''			
	'
	exec(@V)
	
        	
	--  
	Set @V = '
	Delete '+@ToDataBaseName+'..[Resource]'
	exec (@v)
	
	Set @V = '
	insert into '+@ToDataBaseName+'..[Resource]
	([Guid], [Kind])
	Select Guid, 1 from '+@ToDataBaseName+'..ServicesContractType'
	exec (@v)
	
	Set @V = '
	exec '+@ToDataBaseName+'..[PrcReCreateServicesContract] 0,0,0,0,0,0,0 '

	Print @v
	exec (@v)



GO

SET ANSI_NULLS, QUOTED_IDENTIFIER ON
GO

Create View [vwContractType]
 
as
	Select
		[A].[Number],
		[A].[Guid],
		[A].[SecLvl],
		[A].[Contractkind],
		[A].[Code] as [Code],
		[A].[Name] as [ArName],
		Case when (dbo.FnGetLangauge(@@spid) = 1) and (Isnull([A].[LtnName],'') <> '') then [A].[LtnName] else [A].[Name] end as [Name], 
		[A].[ltnName],
		[A].[Menu] as [arMenu],
		Case when (dbo.FnGetLangauge(@@spid) = 1) and (Isnull([A].[LtnMenu],'') <> '') then [A].[LtnMenu] else [A].[Menu] end as [Menu], 
		[A].[LtnMenu],
		[A].[defprintPath],
		[A].[defprintLogPath],
		[RevenueAccountGUID],
		[AcCommissionFromCustGUID],
		[AcCommissionFromOwnerGUID],
		[AccountContractPriceGUID],
		[AccountCertificatValueGUID],
		[FineAccountGUID],
		[DiscountAccountGUID],
		[ServesComm],
		[Rentcondition],
		[MoveCost],
		[MoveCostCredit],
		[AutoCreateEntry],
		[AutoPostedEntry],
		[MoveCostWithIncom],
		[CreateEntry],
		[TaxAccount],
		[ShortCut],

		[MoveCostWithInsurance],
		[MoveCostWithContractPrice],
		[MoveCostWithCertificat],
		[MoveCostWithFee],
		[MoveCostWithclientComm],
		[MoveCostWithOwnerComm],
		[MoveCostWithInconEndContract],
		[MoveCostWithFineEndContract],
		
		[MoveCostWithIncomCredit],
		[MoveCostWithInsuranceCredit],
		[MoveCostWithContractPriceCredit],
		[MoveCostWithCertificatCredit],
		[MoveCostWithFeeCredit],
		[MoveCostWithclientCommCredit],
		[MoveCostWithOwnerCommCredit],
		[MoveCostWithInconEndContractCredit],
		[MoveCostWithFineEndContractCredit],
		
		[MoveCostWithDiscount],
		[MoveCostWithDiscountCredit],
		
		[InsuranceAccountGuid],
		[EndContract],
		[ConstraintInsurance],
		[DefPrintReceipt],
		[DefPrintacquittance],
		[UnearnedrRevenue] ,
		[AcIncomNextYearGuid],
		[OpNewContract],

		[EntryDate],
		IsAutoRenewal,
		[GenEntryEnd],
		CanBeginDateAfterDate2,

		[AutoSMSAfterEnd],
		[EndSMSMsg],
		[EndSMSMsgEn],
		[DefSmsMobile],

		Case when (dbo.FnGetLangauge(@@spid) = 1) and (Isnull([A].[FirstPayNoteLtn],'') <> '') then [A].[FirstPayNoteLtn] else [A].[FirstPayNote] end as [FirstPayNote],
		Case when (dbo.FnGetLangauge(@@spid) = 1) and (Isnull([A].[ContractNoteLtn],'') <> '') then [A].[ContractNoteLtn] else [A].[ContractNote] end as [ContractNote],
		AcCommissionExpenseGuid,
		DefPicTab
	From
		[ContractType] [A]


GO

SET ANSI_NULLS, QUOTED_IDENTIFIER ON
GO
Create Function [fnMonthCountToYearDigit] (@Month Float)
returns Float  
begin
	Declare @R Float
	
	Declare @y Float
	Set @y = Floor(@Month / 12)

	Declare @m Float
	Set @m = ((@Month / 12) - Floor(@Month / 12)) * 12

	Set @R = @y + (@m / 10)

	return @R
end


GO

SET ANSI_NULLS, QUOTED_IDENTIFIER ON
GO

Create Procedure [dbo].[PrcMarkCheckFromContract]
(
	@Guid uniqueidentifier = '4A098C65-3D29-42E6-91AF-5BE1BC75D64C',
	@Mark bit = 1
)
 
as
	update
		[Checks] 
	Set
		Mark = @Mark
	from
		[Checks] [C]
	where
		[C].[ContractGuid] = @Guid 

GO

SET ANSI_NULLS, QUOTED_IDENTIFIER ON
GO

Create View [vwAssetsArea]
 
as
	Select
		[A].[Number], [A].[Guid], [A].[Code], [A].[ParentGuid], [A].[Note], [A].[LtnName],
		[A].[Name] as [ArName],
		Case when (dbo.FnGetLangauge(@@spid) = 1) and (Isnull([A].[LtnName],'') <> '') then [A].[LtnName] else [A].[Name] end as [Name]
	From 
		[vbAssetsArea] [A]


GO

SET ANSI_NULLS, QUOTED_IDENTIFIER ON
GO
Create View [vwLastFlatSalesPrice3]
 
as
	Select 
		[C].[ParentGuid],
		[Price] as [Sale],
		[CurrencyGuid] as [SaleCurrencyGuid]
	From
		[ChangeFlatPrice] [C]
		inner join (
						Select 
								[ParentGuid],
								Max(Date) as [MaxDate],
								Max([Number]) as [MaxNumber]
						From
							[ChangeFlatPrice]
						where
							[Kind] = 3
						Group By
							[ParentGuid]
					) [C2] on [C2].[ParentGuid] = [C].[ParentGuid] 
							and [C].[Date] = [C2].[MaxDate] 
							and (Case when [C].[Date] = [C2].[MaxDate] then [MaxNumber] else [C].[Number] end = [C].[Number])
	where
		[Kind] = 3
							

GO

SET ANSI_NULLS, QUOTED_IDENTIFIER ON
GO

CREATE FUNCTION [FnFormatCode] (@Number Varchar(256), @digit int)
RETURNS Varchar(256)
 
AS
BEGIN
	Declare @R Varchar(256)
	Set @R = ''

	while (len(@Number) < @digit )
	begin
		Set @R = @R+'0'
		Set @digit = @digit -1
	end
	
	Set @R = @R + @Number

	RETURN @R
END

GO

SET ANSI_NULLS, QUOTED_IDENTIFIER ON
GO

Create Procedure [dbo].[PrcMarkCashFromContract]
(
	@Guid uniqueidentifier = '89636B45-51F1-407A-B5D7-8297109745B5',
	@Mark bit = 1
)
 
as
	update
		Secondary_Entry 
	Set
		Mark = @Mark
	from
		Secondary_Entry S
		left join [ContractCachPayment] C on C.EntryGuid = S.Guid
	where
		[S].[ContractGuid] = @Guid 
		
	update
		HEntry
	Set
		Mark = @Mark
	from
		HEntry H
		inner join Secondary_Entry S on H.Guid = S.Guid
		left join [ContractCachPayment] C on C.EntryGuid = S.Guid
	where
		[S].[ContractGuid] = @Guid 
	
		

GO

SET ANSI_NULLS, QUOTED_IDENTIFIER ON
GO
Create View [vwAssetsDepreciationDetail]
 
as
	Select
		S.code, S.Name ,
		D.*,
		Case when D.IsDepreciationMonthly = 0 then dbo.SC('')	else dbo.SC('') end as [DepreciationKind],

		Case 
			when D.IsDepreciationMonthly = 0 then 
			(DATEDIFF(DAY , D.BeginDate , D.EndDate ) )
		else
			(DATEDIFF(Month, D.BeginDate , D.EndDate )) +1
		end	[Period]		
	From
		[AssetsDepreciationDetail] [D]
		inner join Assets [S] on [S].Guid = [D].[AssetsGuid]

GO

SET ANSI_NULLS, QUOTED_IDENTIFIER ON
GO

Create Procedure [PrcReminderForming]
 
as
	Set noCount on
	Declare 
			@Subject Varchar(256),
			@Date Datetime,
			@Note Varchar(256),
			@UserName Varchar(256),
			@I int,

			@StrReminder Varchar(2000)
	Set @StrReminder =''
	Set @I = 0

	DECLARE cursor_Name CURSOR FAST_FORWARD FOR 
	Select 
		[Subject],
		[Date],
		[Note],
		Case when ForAllUser = 1 and isnull([U].[UserName],'') <> '' then '/'+isnull([U].[UserName],'')+'/' else '' end as [UserName]
	From 
		[Reminder] [R]
		left join (
					Select
						[C].[UserGuid],
						[R].[LoginName] as [UserName]
					From
						[CurrentUsers] [C]
						inner join [Realty_Users] [R] on [R].[Guid] = [C].[UserGuid] And [C].[Spid] = @@Spid
					)[U] On [U].[UserGuid] = [R].[UserGuid] 
	where
		([RemindDate] < GetDate())
		and ([Finished] = 0)
		and ([U].[userGuid] is Not Null Or ForAllUser = 1)
	Order By
		[Date], [Number]
		
		
	
	OPEN cursor_Name
	FETCH NEXT FROM cursor_Name INTO @Subject, @Date, @Note, @UserName
	
	WHILE @@FETCH_STATUS = 0
	BEGIN
		Set @I = @I + 1
		Set @StrReminder = @StrReminder + '             :::'+Cast(@I as Varchar(4))+':::     ' + @Subject
		Set @StrReminder = @StrReminder + ' '+ Dbo.SC(' ')
 		Set @StrReminder = @StrReminder + ' '+  
 												Cast(Day(@Date) as Varchar(5)) +'-'+
 												Cast(Month(@Date) as Varchar(5)) +'-'+
												Cast(Year(@Date) as Varchar(5)) +' '+
												+ Dbo.SC('') + ' '+
 												Cast(DatePart(hh, @Date) as Varchar(5)) +':'+
 												dbo.FnFormatNumber(DatePart(Minute, @Date) ,2)

 		Set @StrReminder = @StrReminder + Case when @Note <> '' then ' '+  @Note+' ' else '' end
 		Set @StrReminder = @StrReminder + ' '+  @UserName
		  
	FETCH NEXT FROM cursor_Name INTO @Subject, @Date, @Note, @UserName
	END
	
	CLOSE cursor_Name
	DEALLOCATE cursor_Name

	Select  @StrReminder  as  [StrReminder]
-- 	where
-- 		([Subject] Like '%'+@Subject+'%')
-- 		and ([Note] Like '%'+@Note+'%')
-- 		and (dbo.fndateonly([RemindDate]) between @Date1 and @Date2)

GO

SET ANSI_NULLS, QUOTED_IDENTIFIER ON
GO

	Create View [vbCost]
	 
	as
		Select 
			[T].*
		From
			[Cost] [T]
			inner join [CurrentUsers] [U] on ([u].[Seclvl] >= Isnull([T].[SecLvl],0)  or [u].[Admin] = 1) and [u].[spid] = @@Spid
GO

SET ANSI_NULLS, QUOTED_IDENTIFIER ON
GO

Create Procedure [PrcAutoRenewalContractLand]
(
	@MaxDate int = 42644
)
 
as	
	Select 0 as [RowCount], 0 as FailCount
	return	


GO

SET ANSI_NULLS, QUOTED_IDENTIFIER ON
GO

Create Procedure [dbo].[PrcAssetsOperation]
(
	@AssetsGruopGuid uniqueidentifier = 0x0,
	@AssetsGuid uniqueidentifier = 0x0,
	@AssetsAreaGuid uniqueidentifier = 0x0,
	@Flag1 Bit = 1,
	@Flag2 Bit = 1,
	@Flag3 Bit = 1,
	@CurrencyGuid [uniqueidentifier] = '11111111-C748-4B13-8B91-1E9B299DF1C1',
	@CurrencyVal Float = 1,
	@Date1 DateTime = '1/1/2007',
	@Date2 DateTime = '1/1/2014'
)  
as
	if @CurrencyVal = 0 
	Set @CurrencyVal = 1

	Select 
		A.Date,
		A.Number,
		S.Code,
		S.name,
		s.ltnName,
		S.[AssetsGroup],
		S.CurrentArea,
		Case 
			when A.Flag = 1 then dbo.SC('')
			when A.Flag = 2 then dbo.SC('')
			when A.Flag = 3 then dbo.SC('')
		end as [StrFlag],
		C.Code as AccountCode,
		C.Name as AccountName,
		A.value *
		Case when [A].[CurrencyGuid] = @CurrencyGuid then 1 
				else [A].[CurrencyVal] / @CurrencyVal 
		end as Value,
		My.Code as Currency,
		A.age,
		A.Note,
		A.[flag],
		A.Guid,
		S.Guid as AssetsGuid,
		0 as [Sort]
	into #RPrcAssetsOperation
	From 
		[AssetsOperation] A
		inner join [vwAssets] S on S.Guid = A.AssetsGuid
		inner join [vwAccount] C on C.Guid = A.accountGuid
		inner join [vwCurrency] My on My.Guid = A.CurrencyGuid
	where
		 (S.[AssetsGroupGuid] = @AssetsGruopGuid or @AssetsGruopGuid = 0x0)
		and (A.Guid = @AssetsGuid or @AssetsGuid = 0x0)
		and (S.CurrentAssetsAreaGuid = @AssetsAreaGuid or @AssetsAreaGuid = 0x0)
		and (A.Date between @Date1 and @Date2)
		and (
				(A.flag = 1 and @Flag1 = 1)
				or (A.flag = 2 and @Flag2 = 1)
				or (A.flag = 3 and @Flag3 = 1)
			)

	insert into #RPrcAssetsOperation
	Select 
		Null as Date,
		Null as Number,
		Null as Code,
		Null as name,
		Null as ltnName,
		Null as [AssetsGroup],
		Null as CurrentArea,
		Null as [StrFlag],
		Null as AccountCode,
		Null as AccountName,
		Sum(value),
		Null as Currency,
		Null as age,
		Null as Note,
		0 as [flag],
		0x0 as Guid,
		0x0 as AssetsGuid,
		1 as [Sort]
	From 
		#RPrcAssetsOperation
		
	Select
		*
	From
		#RPrcAssetsOperation
	Order By
		Sort, Date, Code
	

GO

SET ANSI_NULLS, QUOTED_IDENTIFIER ON
GO

Create View [vwApartmentFull]
 
as

	Select
		[A].[Number], [A].[Guid], [A].[SecLvl],  [A].[BuildingGuid], [A].[FloorNo], [A].[Area], [A].[unity], [A].[ApartmentType], [A].[FlatKind], [A].[CostPrice], [A].[CostCurrencyGUID], [A].[Note], [A].[CostGuid], [A].[FlatOwner], [A].[CustGuid], [A].[Details], [A].[OfferState], [A].[OfferType], [A].[CustomerName], [A].[CustomerPhone], [A].[Restrained], [A].[PurchaseDate], [A].[PayValue], [A].[BathroomCount], [A].[BalconyCount], [A].[WaterCounter], [A].[ElectricityCounter], [A].[RestrainedUserGuid], [A].[Class], [A].[CardKind], [A].[Overlooking], [A].[Judicial],
		[A].[LtnFlatKind],[A].[LtnApartmentType],[A].[LtnClass],[A].[LtnOverlooking] ,
		[B].[BuildingCode]+[A].[NO] as [NO],
		[A].[Rent],
		[A].[RentCurrencyGuid],
		[S].[Sale],
		[S].[SaleCurrencyGuid],
		[B].[Name] as [BuildingName],
		[B].[Emirate],
		[B].[Area] as [BuildingArea],
		[B].[Suburb],
		[B].[Street],
		[B].[BuildingNo],
		[B].[PieceNo],
		[B].[BasinNo],
		Isnull([My].[CurrencyVal],1) as [CostCurrnecyVal],
		[B].[OpOwner] as [BuildingOpOwner],
		[B].[OwnerName] as [BuildingOwnerName],
		[B].[AccountCommIncomeGuid],
		[B].[AcCommissionFromOwnerGuid],
		[B].[CommissionPercent] as [BuildingCommissionPercent]

		,[L].[Guid] as [LastContractGuid]
		,[L].[ContractState]
		,[L].[FlatState]
	From
		[vbApartment] [A]
		inner join [vwBuilding] [B] On [B].[Guid] = [A].[BuildingGuid]
		left join [vwLastFlatSalesPrice] [S] on [S].[ParentGuid] = [A].[Guid]
		left join [Currency] [My] on [My].[Guid] = [A].[CostCurrencyGuid]
  		left join [vwLastFlatContract] [L] on [L].[ApartmentGuid] = [A].[Guid]

GO

SET ANSI_NULLS, QUOTED_IDENTIFIER ON
GO

	Create View [vbShop]
	 
	as
		Select 
			[T].*
		From
			[Shop] [T]
			inner join [CurrentUsers] [U] on ([u].[Seclvl] >= Isnull([T].[SecLvl],0)  or [u].[Admin] = 1) and [u].[spid] = @@Spid
GO

SET ANSI_NULLS, QUOTED_IDENTIFIER ON
GO

Create Procedure [PrcRemindBackupDay]
 
as
	Declare @RemindBackupDay int
	
	Select
		@RemindBackupDay = Value
	From
		DMD_const
	where
		VName = 'RemindBackupDay'
	
	Declare @BackpupDate Datetime
	Select Top 1
		@BackpupDate = Backupset.bACKUP_fINISH_dATE
	from
		msdb..Backupset as Backupset
	where
		DataBase_Name = dB_nAME()
	order by
		backup_finish_date DESC
		
	Select 
		@BackpupDate as [BackpupDate],
		IsNull(Datediff(Day, @BackpupDate, GETDATE()),-1) as DayCount,
		Case when Datediff(Day, @BackpupDate, GETDATE()) >= IsNull(@RemindBackupDay,0) 
				  or @BackpupDate IS Null
		then 1 end as Show

GO

SET ANSI_NULLS, QUOTED_IDENTIFIER ON
GO

Create Trigger [TRG_Bill_Delete]
on [Bill] 
 
For delete
As
	Delete [Hentry] From [HEntry] Inner join [Deleted] On [Deleted].[Guid] = [HEntry].[Guid]

GO

SET ANSI_NULLS, QUOTED_IDENTIFIER ON
GO

Create FUNCTION [dbo].[fnGetAccountList]( @AccGUID [UNIQUEIDENTIFIER])  
	RETURNS @Result TABLE ([GUID] [UNIQUEIDENTIFIER], [Code] Varchar(256) COLLATE ARABIC_CI_AI, [Name] Varchar(256) COLLATE ARABIC_CI_AI, [Level] [INT] DEFAULT 0, [Path] [VARCHAR](8000) COLLATE ARABIC_CI_AI)   
 
AS 
BEGIN  
		---- 
	Declare @AcType int
	Set @AcType = (Select [Type] From [Account] where [Guid] = @AccGUID)
	if isnull(@AcType,0) <> 2
	begin
		DECLARE @FatherBuf_S	TABLE
		(
			[GUID] [UNIQUEIDENTIFIER], 
			[Level] [INT], 
			[Path] [VARCHAR](8000) COLLATE ARABIC_CI_AI, 
			[ID] [INT] IDENTITY( 1, 1)
		)   
		DECLARE  @Continue_S [INT], @Level_S [INT]  
		SET @Level_S = 0   
		  
		SET @AccGUID = ISNULL(@AccGUID, 0x0)   
		IF @AccGUID = 0x0   
		BEGIN 
			INSERT INTO @FatherBuf_S ( [GUID], [Level], [Path]) SELECT [ac1].[Guid], @Level_S, ''  FROM [Account] [ac1] WHERE ( ISNULL( [ac1].[ParentGuid], 0x0) = 0x0 ) ORDER BY [ac1].[Code]
			INSERT INTO @fatherBuf_s ( [GUID], [Level], [Path]) SELECT [ac1].[Guid], @Level_S, ''  
			FROM  
				[Account] [ac1] 
				LEFT JOIN [Account] [ac2] ON [ac1].[ParentGuid] = [ac2].[Guid] 
				LEFT JOIN @fatherBuf_s [f] ON [ac1].[Guid] = [f].[Guid]  
			WHERE  
				ISNULL( [ac1].[ParentGuid], 0x0) != 0x0 
				AND [ac2].[Guid] IS NULL 
				AND [f].[Guid]IS NULL 
			ORDER BY  
				[Ac1].[Code]
		END 
		ELSE   
			INSERT INTO @FatherBuf_S ([GUID] , [Level], [Path]) SELECT [Guid], @Level_S, '' FROM [Account] WHERE [Guid] = @AccGUID ORDER BY [Code]
		  
		UPDATE @FatherBuf_S  SET [Path] = CAST( ( 0.0000001 * ID) AS [VARCHAR](40))   
	  
		SET @Continue_S = 1   
		IF (@AccGUID = 0x0) 
		BEGIN   
			WHILE @Continue_S <> 0   
			BEGIN   
				SET @Level_S = @Level_S + 1   
				INSERT INTO @FatherBuf_S([GUID],[Level],[Path])  
					SELECT  
						[ac].[Guid], @Level_S,[fb].[Path]  
					FROM  
						[Account] AS [ac] 
						INNER JOIN @FatherBuf_S AS [fb] ON [ac].[ParentGuid] = [fb].[GUID]   
					WHERE  
						[fb].[Level] = @Level_S - 1   
					ORDER BY  
						[ac].[Code]
				SET @Continue_S = @@ROWCOUNT   
				UPDATE @FatherBuf_S  SET [Path] = [Path] + CAST( ( 0.0000001 * [ID]) AS VARCHAR(40))  WHERE [Level] = @Level_S 
			END   
		END  
		ELSE  
		BEGIN   
			WHILE @Continue_S <> 0   
			BEGIN   
				SET @Level_S = @Level_S + 1   
				INSERT INTO @FatherBuf_S([GUID], [Level], [Path])  
					SELECT  
						[ac].[Guid],@Level_S,[fb].[Path]  
					FROM  
						[Account] AS [ac] INNER JOIN @FatherBuf_S AS [fb]  
						ON [ac].[ParentGuid] = [fb].[GUID]   
					WHERE  
						[fb].[Level] = @Level_S - 1  
					ORDER BY  
						[ac].[Code]
				SET @Continue_S = @@ROWCOUNT   
				UPDATE @FatherBuf_S  SET [Path] = [Path] + CAST( ( 0.0000001 * ID) AS [VARCHAR](40))  WHERE [Level] = @Level_S 
			END   
		END   
	end
	else
	begin
		insert into @FatherBuf_S
		(
			[GUID],
			[Level], 
			[Path]
		)   
		Select
			[AccountGuid],
			0,
			0
		From
			[AccountAccumulate] 
		where
			[ParentGuid] = @AccGuid
			
		Set @Level_S = 0
		SET @Continue_S = 1   
		BEGIN   
			WHILE @Continue_S <> 0   
			BEGIN   
				SET @Level_S = @Level_S + 1   
				INSERT INTO @FatherBuf_S([GUID],[Level],[Path])  
					SELECT  
						[ac].[Guid], @Level_S,[fb].[Path]  
					FROM  
						[Account] AS [ac] 
						INNER JOIN @FatherBuf_S AS [fb] ON [ac].[ParentGuid] = [fb].[GUID]   
					WHERE  
						[fb].[Level] = @Level_S - 1   
					ORDER BY  
						[ac].[Code]
				SET @Continue_S = @@ROWCOUNT   
				UPDATE @FatherBuf_S  SET [Path] = [Path] + CAST( ( 0.0000001 * [ID]) AS VARCHAR(40))  WHERE [Level] = @Level_S 
			END   
		END  
		
		
	end	


	INSERT INTO @Result 
	SELECT 
		[S].[GUID], [Code], [Name], [Level], [Path] 
	FROM 
		@FatherBuf_S [S]
		Inner join [vwAccount] [Ac] on [Ac].[Guid] = [S].[Guid] 
	GROUP BY 
		[S].[GUID], [Level], [Path] ,[Code], [Name]
	ORDER BY [Path] 

	RETURN  
END 


GO

SET ANSI_NULLS, QUOTED_IDENTIFIER ON
GO

	Create View [vbParkingContract]
	 
	as
		Select 
			[T].*
		From
			[ParkingContract] [T]
			inner join [CurrentUsers] [U] on ([u].[Seclvl] >= Isnull([T].[SecLvl],0)  or [u].[Admin] = 1) and [u].[spid] = @@Spid
GO

SET ANSI_NULLS, QUOTED_IDENTIFIER ON
GO

Create Procedure [PrcDoDistributiveEntry]
(
	@Guid uniqueidentifier = '118F99D6-7A6A-4961-BEBE-43FA8632898F'
)
 
as
	Select
		D.AcGuid as Guid
	into #DisAccount
	From 
		DEntry D
		inner join Account Ac on Ac.Guid = D.AcGuid and Ac.Type = 3
	where
		D.ParentGuid = @Guid
		
	--return

	insert into DEntry
	([Number],[Guid],[ParentGuid],[AcGuid],[Debit],[Credit],[CurrencyGuid],[CurrencyVal],[ObverseAcGuid],[CostGuid],[Note],[IsVisible])
	Select
		D.Number,
		NEWID(),
		D.ParentGuid,
		S.AccountGuid,
		d.Debit * s.[Percent] / 100,
		d.Credit * s.[Percent] / 100,
		D.CurrencyGuid,
		D.CurrencyVal,
		D.ObverseAcGuid,
		D.CostGuid,
		D.Note,
		D.IsVisible
	From 
		DEntry D
		inner join Account Ac on Ac.Guid = D.AcGuid and Ac.Type = 3
		inner join [AccountDistributive] S on S.ParentGuid = Ac.Guid
	where
		D.ParentGuid = @Guid
		
	Delete DEntry
	From 
		DEntry D
		inner join #DisAccount Ac on Ac.Guid = D.AcGuid 
	where
		D.ParentGuid = @Guid	
		
	if exists(Select 
					Top 1 * 
			  From 
					DEntry D
					inner join Account Ac on Ac.Guid = D.AcGuid 
			  where
				D.ParentGuid = @Guid
				and Ac.Type = 3)
				
	exec [PrcDoDistributiveEntry] @Guid
	
	

GO

SET ANSI_NULLS, QUOTED_IDENTIFIER ON
GO
Create Procedure [dbo].[PrcCreateoldYearView]
 
as
	Declare @SQL Varchar(8000)
	Set @Sql = '
	Create view [vwOldYearEntry]
	as
	Select
		cast( DB_NAME() as Varchar(256) ) as DBNAME,
		[H].[Guid] as [H_Guid],
		[H].[Number] as [H_Number],
		[H].[SecLvl] as [H_SecLvl],
		[H].[Date] as [H_Date]  ,
		[H].[Note] COLLATE Arabic_CI_AI as [H_Note],
		[H].[ParentKind] as [H_ParentKind],
		[H].[BranchGuid] as [H_BranchGuid],
		[H].[IsPosted] as [H_IsPosted],
		Case when (dbo.FnGetLangauge(@@spid) = 1) then ''Entry'' else '' '' end as [H_Name],
		[D].[Guid]  as [D_Guid],
		[D].[ParentGuid] as [D_ParentGuid],
		[D].[AcGuid] as [D_AcGuid] ,
		[D].[Debit] as [D_Debit] ,
		[D].[Credit] as [D_Credit] ,
		[D].[CurrencyGuid] as [D_CurrencyGuid] ,
		[D].[CurrencyVal] as [D_CurrencyVal],
		[D].[ObverseAcGuid] as [D_ObverseAcGuid]  ,
		[D].[CostGuid] as [D_CostGuid] ,
		[D].[Note] COLLATE Arabic_CI_AI as [D_Note],
		[D].[IsVisible] as [D_IsVisible],
		H.Mark,
		0 as [IsOldEntry]
	From
		[vbHEntry] H
		inner join [DEntry] D on H.Guid = D.ParentGuid'
		
	Declare @DbName nVarchar(256) , @BeginEntryNo nVarchar(256)
	DECLARE cursor_Name CURSOR FAST_FORWARD FOR 
	SELECT 
		y.dbName, y.[BeginEntryNo]
	FROM 
		[OldYearConfig] Y
		inner join sys.databases Sd on Sd.[Name] COLLATE Arabic_CI_AI = Y.[dbName] COLLATE Arabic_CI_AI
	Order By 
		y.Number
	
	OPEN cursor_Name
	FETCH NEXT FROM cursor_Name INTO @DbName, @BeginEntryNo
	
	WHILE @@FETCH_STATUS = 0
	BEGIN
	  
	Set @Sql = @Sql + '
	union all
	Select
		'''+@DbName+''',
		[H].[Guid] as [H_Guid],
		[H].[Number] as [H_Number],
		[H].[SecLvl] as [H_SecLvl],
		[H].[Date] as [H_Date]  ,
		[H].[Note] COLLATE Arabic_CI_AI as [H_Note],
		[H].[ParentKind] as [H_ParentKind],
		[H].[BranchGuid] as [H_BranchGuid],
		[H].[IsPosted] as [H_IsPosted],
		Case when (dbo.FnGetLangauge(@@spid) = 1) then ''Entry'' else '' '' end as [H_Name],
		[D].[Guid]  as [D_Guid],
		[D].[ParentGuid] as [D_ParentGuid],
		[D].[AcGuid] as [D_AcGuid] ,
		[D].[Debit] as [D_Debit] ,
		[D].[Credit] as [D_Credit] ,
		[D].[CurrencyGuid] as [D_CurrencyGuid] ,
		[D].[CurrencyVal] as [D_CurrencyVal],
		[D].[ObverseAcGuid] as [D_ObverseAcGuid]  ,
		[D].[CostGuid] as [D_CostGuid] ,
		[D].[Note] COLLATE Arabic_CI_AI as [D_Note],
		[D].[IsVisible] as [D_IsVisible],
		H.Mark,
		1 as [IdOldEntry]
	From
		'+@DbName+'..[vbHEntry] H
		inner join '+@DbName+'..[DEntry] D on H.Guid = D.ParentGuid
		inner join sys.databases S on UPPER(S.Name) = UPPER('''+@DbName+''')
	where
		H.Number Not in (SELECT str from dbo.FnStrToTable ('''+@BeginEntryNo+'''))'
	

	  FETCH NEXT FROM cursor_Name INTO @DbName, @BeginEntryNo
	
	END
	
	CLOSE cursor_Name
	DEALLOCATE cursor_Name
	print @sql
	exec (@sql)

GO

SET ANSI_NULLS, QUOTED_IDENTIFIER ON
GO
Create View [vwFlatPrint]
 
as
	Select
		[F].[Number] as [Number], 		[F].[Guid] as [Guid], 		[F].[SecLvl] as [SecLvl], 		[F].[CardKind] as [CardKind], 		[F].[Judicial] as [Judicial], 		[F].[Ban] as [Ban], 		[F].[NO] as [NO], 		[B].[Name] as [Building], 		[F].[FloorNo] as [FloorNo], 		[F].[Area] as [Area], 		[F].[unity] as [unity], 		[F].[ApartmentType] as [ApartmentType], 		[F].[FlatKind] as [FlatKind], 		[F].[Class] as [Class], 		[F].[Overlooking] as [Overlooking], 		[F].[CostPrice] as [CostPrice], 		[F].[CostCurrencyGUID] as [CostCurrencyGUID], 		[F].[Note] as [Note], 		[Co].[Name] as [Cost], 		[F].[FlatOwner] as [FlatOwner], 		[F].[Details] as [Details], 		[F].[OfferState] as [OfferState], 		[F].[OfferType] as [OfferType], 		[F].[CustomerName] as [CustomerName], 		[F].[CustomerPhone] as [CustomerPhone], 		[F].[Restrained] as [Restrained], 		[F].[PayValue] as [PayValue], 		[F].[BathroomCount] as [BathroomCount], 		[F].[BalconyCount] as [BalconyCount], 		[F].[WaterCounter] as [WaterCounter], 		[F].[ElectricityCounter] as [ElectricityCounter], 		[F].[RestrainedUserGuid] as [RestrainedUserGuid], 		[F].[PurchaseDate] as [PurchaseDate], 		[Cu1].[Name] as [Cust], 		[F].[LastContractGUID] as [LastContractGUID], 		[F].[LtnFlatKind] as [LtnFlatKind], 		[F].[LtnApartmentType] as [LtnApartmentType], 		[F].[LtnClass] as [LtnClass], 		[F].[LtnOverlooking] as [LtnOverlooking], 		[Cu2].[Name] as [CustOwner]
	From
		[Apartment] [F]
		inner join vwBuilding [b] on [b].Guid = [F].[BuildingGuid]
		left join Cost [Co] on [Co].Guid = [F].[CostGuid]
		left join Customer [Cu1] on [Cu1].Guid = [F].[CustGuid]
		left join Customer [Cu2] on [Cu2].Guid = [F].[CustOwnerGuid]

GO

SET ANSI_NULLS, QUOTED_IDENTIFIER ON
GO

Create Proc [Prc_GeneralLedgerMultiAccount]
(
	@AccountGuid [uniqueidentifier]= 'ADCE91EB-16AD-49DB-8F74-410DC81E3E1C'
	,@CostGuid [uniqueidentifier]= 0x0
	,@ObverseAcGuid [uniqueidentifier] = 0x0
	,@CurrencyGuid [uniqueidentifier] = '11111111-C748-4B13-8B91-1E9B299DF1C1'
	,@CurrencyVal Float = 1
	,@Date1 DateTime = '2010-1-2'
	,@Date2 DateTime = '2016-12-31'
	,@BranchGuid [uniqueidentifier] = 0x0
	,@ShowIsCheck Bit = 1
	,@ShowIsNotCheck Bit = 1
	,@LikeNote varchar(256) = ''
	,@NotLikeNote varchar(256) = ''
	,@IsPosted Bit = 1
	,@IsNotPosted Bit = 1

	,@IsMark Bit = 1
	,@IsNotMark Bit = 1

	,@CkDate Bit = 1
	,@ShowEmptyBranchAccount Bit = 0
	,@ShowMainAccount bit = 0
	,@level int = 0
	,@ShowDebit Bit = 1
    ,@ShowCredit Bit = 1
    ,@ContainOldEntry Bit = 0
    ,@BeginEntryNo varchar(256) = ''
)
 
as
	Set nocount on
	

	CREATE TABLE [dbo].[#MultiAccount]
	(
		[RepAccountGuid] [uniqueidentifier] NULL,
		[AccountCardNote] [varchar](255) NULL,
		[AcountName] [varchar](513) NULL,
		[Date] [datetime] NULL,
		[AcCode] [varchar](256) NULL,
		[AcName] [varchar](256) NULL,
		[AcPath] [varchar](256) NULL,
		[Note] [varchar](256) NULL,
		[Debit] [float] NULL,
		[Credit] [float] NULL,
		[RunTotal] [float] NULL,
		[Cost] [varchar](256) NULL,
		[CostCode] [varchar](256) NULL,
		[Posted] [bit] NULL,
		[Mark] [bit] NULL,
		[Kind] [int] NULL,
		[Name] [varchar](256) NULL,
		[ObverseAc] [varchar](256) NULL,
		[EntryNo] [int] NULL,
		[OrgNumber] [varchar](256) NULL,
		[OrgName] [varchar](256) NULL,
		[Sort] [int] NULL,
		[SortNum] [int] NULL,
		[Guid] [uniqueidentifier] NULL,
		[ItemGuid] [uniqueidentifier] NULL,
		[AcGuid] [uniqueidentifier] NULL,
		[CostGuid] [uniqueidentifier] NULL,
		[AcNSons] [int] NULL,
		[Id] [int] NOT NULL,
		[Check] [int] NULL,
		[Operation] [int] NOT NULL
	)
	
	Declare @MltAccountGuid uniqueidentifier
	DECLARE @cursor_Name CURSOR 
	Set @cursor_Name = CURSOR FAST_FORWARD FOR 

	Select Guid from [dbo].[fnGetAccountList](@AccountGuid)
	where
		Guid <> @AccountGuid
	OPEN @cursor_Name
	FETCH NEXT FROM @cursor_Name INTO @MltAccountGuid
	
	WHILE @@FETCH_STATUS = 0
	BEGIN
		insert into [#MultiAccount]
		exec [Prc_GeneralLedger]
		@MltAccountGuid 
		,1
		,@CostGuid 
		,@ObverseAcGuid 
		,@CurrencyGuid 
		,@CurrencyVal 
		,@Date1 
		,@Date2 
		,@BranchGuid 
		,@ShowIsCheck 
		,@ShowIsNotCheck 
		,@LikeNote 
		,@NotLikeNote 
		,@IsPosted 
		,@IsNotPosted 
		,@IsMark 
		,@IsNotMark 
		,@CkDate 
		,@ShowEmptyBranchAccount 
		,@ShowMainAccount 
		,@level 
		,@ShowDebit 
		,@ShowCredit
		,@ContainOldEntry 
		,@BeginEntryNo 
	  
	  FETCH NEXT FROM @cursor_Name INTO @MltAccountGuid
	
	END
	
	CLOSE @cursor_Name
	DEALLOCATE @cursor_Name
	
	Select
		RepAccountGuid
	into #EmptyAccount
	From
		[#MultiAccount]
	Group by
		RepAccountGuid
	having 
		COUNT(*) = 1
	
	Delete [#MultiAccount]
	From
		[#MultiAccount] M
		inner join #EmptyAccount E on E.RepAccountGuid = m.RepAccountGuid
		
	Select 
		Ac.Code as AccountCode,
		Ac.Name as AccountName,
		@Date1 as [Date1],
		@Date2 as [Date2],
		 M.id,
		M.*
	from 
		[#MultiAccount]	M
		inner join Account ac on Ac.Guid = M.RepAccountGuid
	Order by
		ac.Code, M.id

	Select
		Ac.Code as AccountCode,
		Ac.Name as AccountName,
		0 as [Balance],
		@Date1 as [Date1],
		@Date2 as [Date2]
	From
		Account Ac
	where
		Guid = @AccountGuid
	


GO

SET ANSI_NULLS, QUOTED_IDENTIFIER ON
GO

Create view [vwEarthAll]
 
as
	Select 
		[A].[Number],[A].[Guid],[A].[SecLvl],
		[A].[Name] as [ArName],
		[A].[CustomerGuid],
		[A].[Date],
		[A].[City],
		[A].[Region],
		[A].[Space],
		[A].[EarthNo],
		[A].[Area],
		[A].[Unity],
		[A].[Rent],
		[A].[RentCurrencyGuid],
		[A].[Price],
		[A].[license],
		[A].[Details],
		[A].[LandType],
		[A].[LandOwner]
		,[A].[BeginLandValue],
		[A].[CurrencyBeginLandGuid],
		[A].[CurrencyValBeginLand],
		[A].[CurrencyPurchaseGuid]
		,[A].[Side]
		,[A].[CurrencyValPurchase],
		[A].[AccountGuid],
		[A].[CostGuid],
		[A].[CustomerOwnerGuid],
		[A].[ltnName]
		,[A].[LtnLandType] ,
		[A].[LtnCity] ,
		[A].[LtnRegion] ,
		[A].[LtnSpace] ,
		[A].[Ltnlicense] ,
		[A].[Ltnside] 
		,Case when (dbo.FnGetLangauge(@@spid) = 1) and (Isnull([A].[LtnName],'') <> '') then [A].[LtnName] else [A].[Name] end as [Name], 
		[Cu].[Name] as [CustomerName],
		[A].[No],
		[A].[licenseNo],
		[A].[licenseDate],
		[A].[StreetName],
		A.[CuOwnerGuid],
		A.AccountCommIncomeGuid,
		A.[CommissionPercent],
		isNull(A.Ban,0) as Ban
	From
		[vbEarth] [A]
		left join [vwCustomer] [Cu] On [Cu].[Guid] = [A].[CustomerGuid]

GO

SET ANSI_NULLS, QUOTED_IDENTIFIER ON
GO

Create Trigger [TRG_ParkingContractFee_Del]
on [ParkingContractFee]
 
For delete
As
	Update [Hentry] Set isPosted = 0
	From [HEntry] Inner join [Deleted] On [Deleted].[Guid] = [HEntry].[Guid]

	Delete [Hentry] From [HEntry] Inner join [Deleted] On [Deleted].[Guid] = [HEntry].[Guid]
		

GO

SET ANSI_NULLS, QUOTED_IDENTIFIER ON
GO

	Create View [vbChecks]
	 
	as
		Select 
			[T].*
		From
			[Checks] [T]
			inner join [CurrentUsers] [U] on ([u].[Seclvl] >= Isnull([T].[SecLvl],0)  or [u].[Admin] = 1) and [u].[spid] = @@Spid
GO

SET ANSI_NULLS, QUOTED_IDENTIFIER ON
GO

	Create View [vbwallet]
	 
	as
		Select 
			[T].*
		From
			[wallet] [T]
			inner join [CurrentUsers] [U] on ([u].[Seclvl] >= Isnull([T].[SecLvl],0)  or [u].[Admin] = 1) and [u].[spid] = @@Spid
GO

SET ANSI_NULLS, QUOTED_IDENTIFIER ON
GO

Create Procedure [dbo].[PrcSetShopLastContract]
(
	@ShopGuid uniqueidentifier = 0x0
)
 
as
	update Shop
	Set
		[LastContractGuid] = S.Guid
	from
		Shop P
		inner join (
  						Select
							[C].[Guid],
  							[C].[ApartmentGuid]
  						From
  							[LeaseApartment]  [C]
  						where
  							[FromDate] = 
 							(
 								Select 
 									Max([FromDate]) 
 								From 
 									[LeaseApartment] [C2] 
 								where 
 									[C].[ApartmentGuid] = [C2].[ApartmentGuid]
 							)
					) S on S.[ApartmentGuid] = p.Guid
	where
		P.Guid = @ShopGuid or @ShopGuid = 0x0
			

GO

SET ANSI_NULLS, QUOTED_IDENTIFIER ON
GO
Create Procedure [PrcBill_UpdateMatBalanceBeforePost_Trans]
(
	@BillGuid uniqueidentifier = 'B7606AD9-6CC3-4FEB-BF4C-A925053B9793'
)
 
as

	Declare @IsPost Bit 
	Select @IsPost = [IsPosted] From [Trans] where Guid = @BillGuid
	
	if @IsPost = 0 return

	Declare @MatGuid uniqueidentifier,
			@StoreInGuid uniqueidentifier,
			@StoreOutGuid uniqueidentifier,
			@mtQnt Float, 
			@Direction int, 
			@biQty Float, 
			@biQty2 Float, 
			@biQty3 Float
	
	DECLARE @cursor_Name CURSOR 
	Set @cursor_Name = CURSOR FAST_FORWARD FOR 

	SELECT 
		[D].[MatGuid],
		[B].[StoreInGuid],
		[B].[StoreOutGuid],
		[d].[Qty], 
		[d].[Qty2], 
		[d].[Qty3]	From
		[Trans] B
		inner join [TransDetail] D on D.parentGuid = B.Guid
	where
		B.Guid = @BillGuid
	
	OPEN @cursor_Name
	FETCH NEXT FROM @cursor_Name INTO @MatGuid ,@StoreInGuid, @StoreOutGuid,@biQty,@biQty2,@biQty3
	
	WHILE @@FETCH_STATUS = 0
	BEGIN
		SET @mtQnt = (@biQty)  
		
		UPDATE MatBalance 
		SET 
			[Qty] = [Qty] - @mtQnt ,
			[Qty2] = [Qty2] - @BiQty2 ,
			[Qty3] = [Qty3] - @BiQty3 
		WHERE 
			[StoreGUID] = @StoreInGuid
			AND [ParentGUID] = @MatGuid
			
		IF @@ROWCOUNT = 0 
		INSERT INTO [MatBalance]
		([ParentGuid], [StoreGUID],[Qty],[Qty2],[Qty3]) VALUES 
		(@MatGuid, @StoreInGuid, -@mtQnt, -@BiQty2, -@BiQty3)


		UPDATE MatBalance 
		SET 
			[Qty] = [Qty] + @mtQnt ,
			[Qty2] = [Qty2] + @BiQty2 ,
			[Qty3] = [Qty3] + @BiQty3 
		WHERE 
			[StoreGUID] = @StoreOutGuid
			AND [ParentGUID] = @MatGuid

		IF @@ROWCOUNT = 0 
		INSERT INTO [MatBalance]
		([ParentGuid], [StoreGUID],[Qty],[Qty2],[Qty3]) VALUES 
		(@MatGuid, @StoreOutGuid, @mtQnt, @BiQty2, @BiQty3)

	FETCH NEXT FROM @cursor_Name INTO @MatGuid ,@StoreInGuid, @StoreOutGuid,@biQty,@biQty2,@biQty3
	
	END
	
	CLOSE @cursor_Name
	DEALLOCATE @cursor_Name
	
	Select * from MatBalance

GO

SET ANSI_NULLS, QUOTED_IDENTIFIER ON
GO

Create view [vwCustMail]

as
	SELECT
		[Guid],
		[Barcode],
		[Name] as [ArName],
		[LtnName],
		Case when (dbo.FnGetLangauge(@@spid) = 1) and (Isnull([LtnName],'') <> '') then [LtnName] else [Name] end as [Name],  
		[Nationality], 
		[PhoneJob], 
		[Mobile], 
		[Note], 
		[Address],
		[BoxNo],
		[Fax],
		[EMail]	,
		Case when CardKind2 = 1 then DBO.SC('') else DBO.SC('') end as [CardKind2_Str]
	FROM 
		[vbCustomer]
	where
		EMail <> ''

GO

SET ANSI_NULLS, QUOTED_IDENTIFIER ON
GO

Create Procedure [dbo].[PrcBill_CheckMatBalance]
(
	@GroupGuid uniqueidentifier = 0x0,
	@MatGuid uniqueidentifier = 0x0,
	@StoreGuid uniqueidentifier = 0x0
)
 
as
	CREATE TABLE #MatCheckMatBalance
	(
		[MatCode] [varchar](256) COLLATE database_default,
		[MatName] [varchar](256) COLLATE database_default,
		[MatltnName] [varchar](256) COLLATE database_default,
		[GroupName] [varchar](513) COLLATE database_default,
		[StCode] [varchar](256) COLLATE database_default,
		[StName] [varchar](256) COLLATE database_default,
		[Qty] [float],
		[Unit] [varchar](256) COLLATE database_default,
		[Qty2] [float],
		[Unity2] [varchar](256) COLLATE database_default,
		[Qty3] [float],
		[Unity3] [varchar](256) COLLATE database_default,
		[Price] [float],
		[TotalPrice] [float],
		[Class] [varchar](256) COLLATE database_default,
		[MatGuid] [uniqueidentifier],
		[StoreGuid] [uniqueidentifier],
		[Kind] int
	)

	Insert into #MatCheckMatBalance
	Exec [dbo].[PrcMatInventory] 		@GroupGuid = @GroupGuid, 		@MatGuid = @MatGuid ,		@StoreGuid = @StoreGuid, 		@CostGuid = 0x0, 		@Class = '', 		@ClassGrouping = 0, 		@Unit = 0, 		@BillPost = 1, 		@CkDate = 0, 		@PriceMode = 0, 		@SpecificPrice = 0, 				@CurrencyGuid  = '11111111-C748-4B13-8B91-1E9B299DF1C1',
		@CurrencyVal = 1,				@ShowEmpltyMat = 0, 		@ShowDetailStore = 1, 		@ShowMatTypeStore = 1, 		@ShowMatTypeService = 1, 		@Date1 = 0, 		@Date2 = 0,		@RepKind = 3		Delete Matbalance	From		Matbalance M		inner join [Mat] [mt] on [mt].Guid = [M].[ParentGuid]
		inner join dbo.[fnGetGroupList](@GroupGuid) [G] on [G].Guid = [mt].[GroupGuid]
		inner join dbo.[fnGetStoreList](@StoreGuid) [Sl] on [Sl].Guid = M.[StoreGuid]
		insert into [Matbalance]	(ParentGuid, StoreGuid,Qty, Qty2, Qty3, Note)	Select		MatGuid,		StoreGuid,		Qty, Qty2, Qty3, ''	From		#MatCheckMatBalance				Select * from Matbalance

GO

SET ANSI_NULLS, QUOTED_IDENTIFIER ON
GO

	Create View [vbVilla]
	 
	as
		Select 
			[T].*
		From
			[Villa] [T]
			inner join [CurrentUsers] [U] on ([u].[Seclvl] >= Isnull([T].[SecLvl],0)  or [u].[Admin] = 1) and [u].[spid] = @@Spid
GO

SET ANSI_NULLS, QUOTED_IDENTIFIER ON
GO

Create Proc [PrcGetChatUsers]
 
as
	Create Table #Tbl
	(
		Spid int,
		ecid int,
		Status Nvarchar(30),
		loginname  Nvarchar(30),
		hostName  Nvarchar(30),
		blk int,
		dbname  Nvarchar(30),
		cmd  Nvarchar(30),
		Request_id int
	)

	Insert into #Tbl
	exec sp_who

	Select 
		R.loginname,
		R.Guid,
		Case when U.userGuid is Null then 0 else 1 end as [On]
	from 
		[Realty_Users] R
		left join (
					Select
						T.Spid,
						U.UserGuid
					From
						#Tbl T 
						inner join [CurrentUsers] U on U.Spid = T.Spid
					where
						[dbname] = Db_Name()
					) U on U.userGuid = R.Guid
	where
		(Case when U.Spid = @@SPID then 1 else 0 end = 0 )
	order By
		Case when U.userGuid is Null then 1 else 0 end, 
		R.loginname

GO

SET ANSI_NULLS, QUOTED_IDENTIFIER ON
GO

Create Procedure [PrcOfferBuilding]
(
	@CustGuid [uniqueidentifier] = 0x0,
	@CityGuid [uniqueidentifier] = 0x0,
	@RegionGuid [uniqueidentifier] = 0x0,
	@Area1 Float = 0,
	@Area2 Float = 0,
	@Price1 Float = 0,
	@Price2 Float = 0,
	@CkSale Bit = 1,
	@CkNotSale Bit = 1,
	@CkLease Bit = 1,
	@CkNotLease Bit = 1,
	@Restrained Bit = 1,
	@NotRestrained Bit = 1,
	@Date1 DateTime = '1/1/2007',
	@Date2 DateTime = '1/1/2008',
	@Lang Int = 0
)
 
as
	Select
		*,
		Case when [OfferType] = 1 then 
			case when @Lang = 0 then ''
				 when @Lang = 1 then 'Sale' end
			when [OfferType] = 0 then 
			case when @Lang = 0 then ''
				 when @Lang = 1 then 'rent' end 
		end as [StrOfferType],

		Case when [OfferType] = 1 and [OfferState] = 0 then 
			case when @Lang = 0 then ''
				 when @Lang = 1 then 'Sale' end

			 when [OfferType] = 1 and [OfferState] = 1 then 
			case when @Lang = 0 then ' '
				 when @Lang = 1 then 'Not Sale' end

			 when [OfferType] = 0 and [OfferState] = 0 then 
			case when @Lang = 0 then ''
				 when @Lang = 1 then 'rent' end

			 when [OfferType] = 0 and [OfferState] = 1 then 
			case when @Lang = 0 then ' '
				 when @Lang = 1 then 'Not rent' end
		end as [StrOfferState]

	From
		[vwOfferBuilding]
	where
		([CityGuid] = @CityGuid or @CityGuid = 0x0)
		and ([RegionGuid] = @RegionGuid or @RegionGuid = 0x0)
		and ([CustomerGuid] = @CustGuid or @CustGuid = 0x0)
		and ([Area] between @Area1 and @Area2 or @Area2 = 0)
		and (
				([Area] = @Area1 and @Area2 = 0)
				or (@Area1 = 0)
				or (@Area1 <> 0 and @Area2 <> 0)
			)
		and ([Price] between @Price1 and @Price2 or @Price2 = 0)
		and (
				([Price] = @Price1 and @Price2 = 0)
				or (@Price1 = 0)
				or (@Price1 <> 0 and @Price2 <> 0)
			)

		and (
				([OfferType] = 1 and [OfferState] = 0 and @CkSale = 1 )
				or ([OfferType] = 0)
				Or ([OfferState] = 1)
				or (@CkSale <> 0)
			)

		and (
				([OfferType] = 1 and [OfferState] = 1 and @CkNotSale = 1 )
				or ([OfferType] = 0)
				Or ([OfferState] = 0)
				or (@CkNotSale <> 0)
			)

		-- 
		and (
				([OfferType] = 0 and [OfferState] = 0 and @CkLease = 1 )
				or ([OfferType] = 1)
				Or ([OfferState] = 1)
				or (@CkLease <> 0)
			)

		and (
				([OfferType] = 0 and [OfferState] = 1 and @CkNotLease = 1 )
				or ([OfferType] = 1)
				Or ([OfferState] = 0)
				or (@CkNotLease <> 0)
			)
		and ([Restrained] = 1 or @NotRestrained = 1)
		and ([Restrained] = 0 or @Restrained = 1)

GO

SET ANSI_NULLS, QUOTED_IDENTIFIER ON
GO

	Create View [vbReminder]
	 
	as
		Select 
			[T].*
		From
			[Reminder] [T]
			inner join [CurrentUsers] [U] on ([u].[Seclvl] >= Isnull([T].[SecLvl],0)  or [u].[Admin] = 1) and [u].[spid] = @@Spid
GO

SET ANSI_NULLS, QUOTED_IDENTIFIER ON
GO
Create Procedure [PrcBill_BillPost]
(
	@BillGuid uniqueidentifier = '6D16C88A-93DD-4A8E-9C45-6A5AF8D62838'
)
 
as
	Declare @IsPost Bit 
	Select @IsPost = [IsPosted] From Bill where Guid = @BillGuid
	
	if @IsPost = 0 return
	
	Declare 
			@BuDate datetime,
			@MatGuid uniqueidentifier,
			@StoreGuid uniqueidentifier,
			@mtQnt Float, 
			@Direction int, 
			@biQty Float, 
			@biQty2 Float, 
			@biQty3 Float, 
			@biBonusQnt Float,
			@btPriceEffected bit
	

	DECLARE @cursor_Name CURSOR 
	Set @cursor_Name = CURSOR FAST_FORWARD FOR 

	SELECT
		D.MatGuid,
		[D].[StoreGuid],
		Case when [t].[BillKind] = 0 then 1			 when [t].[BillKind] = 3 then 1			 when [t].[BillKind] = 4 then 1			 when [t].[BillKind] = 1 then -1			 when [t].[BillKind] = 2 then -1			 when [t].[BillKind] = 5 then -1		end [Direction],		[d].[Qty], 
		[d].[Qty2],
		[d].[Qty3],
		[d].[Bonus],		t.PriceEffected	From
		Bill B
		inner join BillType [t] on [t].Guid = [b].TypeGuid
		inner join [BillDetail] D on D.parentGuid = B.Guid
	where
		B.Guid = @BillGuid
	
	OPEN @cursor_Name
	FETCH NEXT FROM @cursor_Name INTO @MatGuid ,@StoreGuid ,@Direction ,@biQty,@biQty2,@biQty3,@biBonusQnt,@btPriceEffected
	
	WHILE @@FETCH_STATUS = 0
	BEGIN
		--  
		SET @mtQnt = @Direction * (@biQty + @biBonusQnt)  
		Set @BiQty2 = @Direction * @BiQty2
		Set @BiQty3 = @Direction * @BiQty3
		
		UPDATE MatBalance 
		SET 
			[Qty] = [Qty]+ @mtQnt ,
			[Qty2] = [Qty2]+ @BiQty2 ,
			[Qty3] = [Qty3]+ @BiQty3 
		WHERE 
			[StoreGUID] = @StoreGuid
			AND [ParentGUID] = @MatGuid
			
		IF @@ROWCOUNT = 0 
		INSERT INTO [MatBalance]
		([ParentGuid], [StoreGUID],[Qty],[Qty2],[Qty3]) VALUES 
		(@MatGuid, @StoreGuid, @mtQnt, @BiQty2, @BiQty3)
		--end --  
		

	FETCH NEXT FROM @cursor_Name INTO @MatGuid ,@StoreGuid ,@Direction ,@biQty,@biQty2,@biQty3,@biBonusQnt, @btPriceEffected
	
	END
	
	CLOSE @cursor_Name
	DEALLOCATE @cursor_Name
	
	-- 	
	Delete [Resource] where Spid = @@Spid
	insert into [Resource] ([Guid]) Select MatGuid from BillDetail where ParentGuid = @billGuid
	exec [PrcUpdateMatPrice]

GO

SET ANSI_NULLS, QUOTED_IDENTIFIER ON
GO
Create Procedure PrcGetTables
(
	@TableName Varchar(256) = ''
)
 
as
	if @TableName = '' 
	Set @TableName = '%'
	Set @TableName = (Select replace(@TableName, ' ', '%') )
	Select 
		* 
	from 
		SysObjects 
	where
		[Name] Like @TableName
	Order By
		Case 
			when Xtype = 'U' then 0
		else 1
		end,
		[Name]


GO

SET ANSI_NULLS, QUOTED_IDENTIFIER ON
GO

	Create View [vbChecksPartialCollection]
	 
	as
		Select 
			[T].*
		From
			[ChecksPartialCollection] [T]
			inner join [CurrentUsers] [U] on ([u].[Seclvl] >= Isnull([T].[SecLvl],0)  or [u].[Admin] = 1) and [u].[spid] = @@Spid
GO

SET ANSI_NULLS, QUOTED_IDENTIFIER ON
GO
Create Procedure PrcGetColumns
(
	@TableName Varchar(256) = 'LeaseApartment'
)
 
as
/*
	Select 
		[C].* 
	from 
		SysObjects [S]
		inner join sysColumns [C] on [C].[Id] = [S].[Id] 
	where
		[S].[Name] = @TableName
	Order By
		[C].[Name]
*/



	Declare @S varchar(8000), @ColType int
	Declare @ColName Varchar(30)
			,@Columns Varchar(8000)

	set @Columns = ''

	DECLARE cursor_Name CURSOR FOR 
	SELECT 
		[c].[Name]
	FROM 
		SysColumns [C]
		inner join [sysobjects] [O] on [O].[id] = [C].[ID]
	where
		[O].[Name] = @TableName
	Order By [C].ColId
	
	OPEN cursor_Name
	FETCH NEXT FROM cursor_Name INTO @ColName
	
	WHILE @@FETCH_STATUS = 0
	BEGIN
	  
		Set @Columns = @Columns + '[L].['+@ColName+'], '+CHAR(13)
	  FETCH NEXT FROM cursor_Name INTO @ColName
	
	END
	
	CLOSE cursor_Name
	DEALLOCATE cursor_Name

	
	Set @Columns = SUBSTRING(@Columns,1, len(@Columns)-1)
	Print @Columns

		

GO

SET ANSI_NULLS, QUOTED_IDENTIFIER ON
GO

Create Procedure [PrcAlarmPaperMonetary]
(	
	@DayPayable Int = 10,
	@DayReceivable Int = 30,
	@ShowAll Bit = 0
)
 
as
	Declare @Check Bit,
			@NotCheck Bit
	Set @Check = 1
	Set @NotCheck = 0

	Set NoCount On
	Select
		[v].[Guid], 
		[v].[TypeName],
		[v].[No],
		[v].[Value],
		[v].[CurrencyCode],
		[v].[CurrencyVal],
		[v].[Date],
		[v].[dueDate],
		[v].[BankName]	

		,[L].[BuildingName]
		,[L].[FlatNo]
		,[L].[FloorNo]

		,[Ac].[Code] as [AccountCode]
		,[Ac].[Name] as [AccountName]
		,(Select Top 1 Mobile from Customer where AcGuid = V.account) as [CustMobile]
		,C4.Value as [PartialCollectionValue]
	Into #R
	From
		[vwChecks] [v]
		left join [vwChecksCollection] [C] on [C].[CheckGuid] = [V].[Guid] --and [C].[Kind] = 1
		left join (
						Select 
							[CheckGuid],
							Sum([Value]) as [Value] 
						From
							[ChecksPartialCollection] 
						Group By
							[CheckGuid]
					) [C4] on [C4].[CheckGuid] = [V].[Guid]

		left join (Select
						[CheckTypeGuid]
					From
						[AlarmCheckTypeSource]  [A]
						inner join [CurrentUsers] [U] on [A].[UserGuid] = [U].[UserGuid] And [U].[spid] = @@Spid
					) [AU] on [Au].[CheckTypeGuid] = [V].[TypeGuid]
		left join [vwAllContract] [L] on [L].[Guid] = [V].[ContractGuid]
		Inner Join [vwAccount] [Ac] On [V].[Account] = [Ac].[Guid]

	where
		(
			(([v].[DueDate] <= DateAdd(d, @DayPayable, GetDate()))
			and [checkkind] = 1)
			or
			(([v].[DueDate] <= DateAdd(d, @DayReceivable, GetDate()))
			and [checkkind] = 0)
		)
		and (([C].[CheckGuid] Is null) and ([C4].[CheckGuid] is Null or [C4].[Value] < [V].[Value] ))
		and ([Au].[CheckTypeGuid] is Not Null or @ShowAll = 1)
		and (
				(IsNull([V].[NoneDueDate],1) = 0)
				or [v].[DueDate] = 0
			)
	Order By 
		[v].[DueDate] 


	Update #R Set AccountName = dbo.SC(' '), 
				  AccountCode = dbo.SC(' ')
	From
		#R R
		inner join ChecksAccountDetail D on D.[ParentGuid] = R.Guid and Kind = 1

	Select *, 0 as [Operation] from #R
	Order By
		[DueDate] 

	Select 
		[TypeName],
		Count(*) As [Count],
		Sum([Value] * [CurrencyVal])  as [Total]
	From
		#R
	Group By
		[TypeName]
		


GO

SET ANSI_NULLS, QUOTED_IDENTIFIER ON
GO

	Create View [vbRealtyRestrained]
	 
	as
		Select 
			[T].*
		From
			[RealtyRestrained] [T]
			inner join [CurrentUsers] [U] on ([u].[Seclvl] >= Isnull([T].[SecLvl],0)  or [u].[Admin] = 1) and [u].[spid] = @@Spid
GO

SET ANSI_NULLS, QUOTED_IDENTIFIER ON
GO

Create Procedure [dbo].[PrcSetShopPrice]
(
	@ShopGuid uniqueidentifier = 0x0
)
 
as
	update Shop
	Set
		Sale = S.Sale,
		SaleCurrencyGUID = S.SaleCurrencyGuid
	from
		Shop P
		inner join (
					Select
						[ParentGuid],
						[Price] as [Sale],
						[CurrencyGuid] as [SaleCurrencyGuid]	
					From
						[ChangeShopPrice] [C]
					where
						[Number] = (
									Select 
										Max([Number]) 
									From 
										[ChangeShopPrice] [C2] 
									where 
										[C2].[ParentGuid] = [C].[ParentGuid]
									)
					) S on S.[ParentGuid] = p.Guid
	where
		P.Guid = @ShopGuid or @ShopGuid = 0x0
			

	update Shop
	Set
		Rent = S.Rent,
		RentCurrencyGUID = S.RentCurrencyGuid
	from
		Shop P
		inner join (
					Select
						[ParentGuid],
						[Price] as [Rent],
						[CurrencyGuid] as [RentCurrencyGuid]	
					From
						[ChangeShopRent] [C]
					where
						[Number] = (
									Select 
										Max([Number]) 
									From 
										[ChangeShopPrice] [C2] 
									where 
										[C2].[ParentGuid] = [C].[ParentGuid]
									)
					) S on S.[ParentGuid] = p.Guid
	where
		P.Guid = @ShopGuid or @ShopGuid = 0x0


GO

SET ANSI_NULLS, QUOTED_IDENTIFIER ON
GO
Create Procedure PrcSelect
(
	@TableName Varchar(256) = ''
)
 
as
	if @TableName = ''
	return

	Declare @S Varchar(256)
	Set @S = '
	Select 
		* 
	from 
		 '+@TableName

	Exec (@S)
		

GO

SET ANSI_NULLS, QUOTED_IDENTIFIER ON
GO

Create Procedure [PrcAlarmEndLease]
(	
	@Day Int = 30,
	@All bit = 1
)
 
as
	Declare @Check Bit,
			@NotCheck Bit
	Set @Check = 1
	Set @NotCheck = 0

	Select 
		[ContractNo],
		[B].[Name] as [BuildingName],
		[B].[ltnName] as [BuildingltnName],
		[B].[ArName] as [BuildingArName],
		Case when Isnull([A].[No], '') <> '' then [A].[No] else [S].[No] end as [No],
		Case when Isnull([A].[No], '') <> '' then dbo.SC('') else dbo.SC('') end as [FlatKind],
		Case when Isnull([A].[No], '') <> '' then [A].[FloorNo] else Null end as [Floor],
		[cu].[Name] as [CustomerName],
		[cu].[ltnName] as [CustomerltnName],
		[cu].[arName] as [CustomerArName],
		[FromDate],
		[ToDate],
		DateDiff(Day, GetDate(), [ToDate]) as [Datediff],
		[LeaseKind],
		[L].[Note2],
		Case when [R2].[ObjGuid] is null then ( @NotCheck )
			 when [R2].[ObjGuid] is not null  then @Check end as [AlertPrinted],
		Null as [AlertPrint],
		[L].[Guid]
	From
		[vbLeaseApartment] [L]
		inner join [vwBuilding] [B] On [L].[BuildingGuid] = [B].[Guid]
		inner join [vwCustomer] [cu] on [cu].[Guid] = [L].[CustomerGuid]
		left join [vwApartment] [A] On [A].[Guid] = [L].[ApartmentGuid]
		left join [vwShop] [S] On [S].[Guid] = [L].[ApartmentGuid]
		left join [RepCheck] [R] on [R].[ObjGuid] = [L].[Guid] and [R].[IdReport] = 7001
		left join [RepCheck] [R2] on [R2].[ObjGuid] = [L].[Guid] and [R2].[IdReport] = 7000
	where
		(DateDiff(Day, GetDate(), [ToDate]) < @Day)
		and (DateDiff(Day, GetDate(), [ToDate]) > 0)
		and ([LeaseKind] = 0 or [LeaseKind] = 1)
		and ([Contractfinish] = 0)
		and ([R].[ObjGuid] is Not Null or @All = 1)
	Order By 
		[B].[Name],
		DateDiff(Day, GetDate(), [ToDate]),
		[ContractNo],
		[ToDate]

GO

SET ANSI_NULLS, QUOTED_IDENTIFIER ON
GO

	Create View [vbVillaOffer]
	 
	as
		Select 
			[T].*
		From
			[VillaOffer] [T]
			inner join [CurrentUsers] [U] on ([u].[Seclvl] >= Isnull([T].[SecLvl],0)  or [u].[Admin] = 1) and [u].[spid] = @@Spid
GO

SET ANSI_NULLS, QUOTED_IDENTIFIER ON
GO

Create Procedure [dbo].[PrcUpdateParkingContractWithDefaultType]
(
	@Date1 DateTime = '3/1/2011',
	@Date2 DateTime = '3/1/2012',
	@ActiveDate bit = 0,
	@Datewith int = 0,
	@Num1 int = 1,
	@Num2 int = 100,
	@ActiveNum bit = 1
)
 
as
	Alter Table [ParkingContract] Disable Trigger All
	
	update [ParkingContract]
	Set
		RevenueAccountGuid = Case when T.RevenueAccountGuid is Not Null then T.RevenueAccountGuid else L.RevenueAccountGuid end
		,AcCommissionFromCustGuid = Case when T.AcCommissionFromCustGuid is Not Null then T.AcCommissionFromCustGuid else L.AcCommissionFromCustGuid end
		,AcCommissionFromOwnerGuid = Case when T.AcCommissionFromOwnerGuid is Not Null then T.AcCommissionFromOwnerGuid else L.AcCommissionFromOwnerGuid end
		,AccountContractPrice = Case when T.AccountContractPriceGuid is Not Null then T.AccountContractPriceGuid else L.AccountContractPrice end
		,AccountCertificatValue = Case when T.AccountCertificatValueGuid is Not Null then T.AccountCertificatValueGuid else L.AccountCertificatValue end
		,FineAccount = Case when T.FineAccountGuid is Not Null then T.FineAccountGuid else L.FineAccount end
		,AcIncomNextYearGuid = Case when T.AcIncomNextYearGuid is Not Null then T.AcIncomNextYearGuid else L.AcIncomNextYearGuid end
	From
		[ParkingContract] L
		inner join [ContractType] T on T.Guid = L.TypeGuid
		inner join [Resource] R on R.Guid = L.TypeGuid and R.Spid = @@SPID
	where
		((L.number between @num1 and @Num2) or @ActiveNum = 0)
		and (
			(
				([L].[FromDate] between @Date1 and @Date2 and @Datewith = 0)
			)
			or
			(
				([L].[ToDate] between @Date1 and @Date2 and @Datewith = 1)
			)

			or
			(
				([L].[ContractFinishDate] between @Date1 and @Date2 and @Datewith = 2)
				and ([L].[ContractFinish] = 1)
			)

			or
			(
				([L].[EditDate] between @Date1 and @Date2 and @Datewith = 3)
			)
			or @ActiveDate = 0
		) 
		
		Alter Table [ParkingContract] Enable Trigger All


GO

SET ANSI_NULLS, QUOTED_IDENTIFIER ON
GO

Create view [vwLawsuitExpense]
 
as
	Select 
		L.*,
		U.LoginName as [UserName],
		(Select Top 1 Path from Photos where ParentGuid = L.Guid and Number = 0) as [Photo]
	from
		[vbLawsuitExpense] L
		left join [realty_Users] U on U.Guid = l.UserGuid

GO

SET ANSI_NULLS, QUOTED_IDENTIFIER ON
GO

Create FUNCTION [dbo].[fnGetCostList]( @CoGuid [UNIQUEIDENTIFIER])  
	RETURNS @Result TABLE ([GUID] [UNIQUEIDENTIFIER], [Level] [INT] DEFAULT 0, [Path] [VARCHAR](8000) COLLATE ARABIC_CI_AI)   
 
AS 
BEGIN  
		---- 
		DECLARE @FatherBuf_S	TABLE([GUID] [UNIQUEIDENTIFIER], [Level] [INT], [Path] [VARCHAR](8000) COLLATE ARABIC_CI_AI, [ID] [INT] IDENTITY( 1, 1))   
		DECLARE  @Continue_S [INT], @Level_S [INT]  
		SET @Level_S = 0   
		  
		SET @CoGuid = ISNULL(@CoGuid, 0x0)   
		IF @CoGuid = 0x0   
		BEGIN 
			INSERT INTO @FatherBuf_S ( [GUID], [Level], [Path]) SELECT [ac1].[Guid], @Level_S, ''  FROM [Cost] [ac1] WHERE ( ISNULL( [ac1].[ParentGuid], 0x0) = 0x0 ) ORDER BY [ac1].[Code]
			INSERT INTO @fatherBuf_s ( [GUID], [Level], [Path]) SELECT [ac1].[Guid], @Level_S, ''  
			FROM  
				[Cost] [ac1] 
				LEFT JOIN [Cost] [ac2] ON [ac1].[ParentGuid] = [ac2].[Guid] 
				LEFT JOIN @fatherBuf_s [f] ON [ac1].[Guid] = [f].[Guid]  
			WHERE  
				ISNULL( [ac1].[ParentGuid], 0x0) != 0x0 
				AND [ac2].[Guid] IS NULL 
				AND [f].[Guid]IS NULL 
			ORDER BY  
				[Ac1].[Code]
		END 
		ELSE   
			INSERT INTO @FatherBuf_S ([GUID] , [Level], [Path]) SELECT [Guid], @Level_S, '' FROM [Cost] WHERE [Guid] = @CoGuid ORDER BY [Code]
		  
		UPDATE @FatherBuf_S  SET [Path] = CAST( ( 0.0000001 * ID) AS [VARCHAR](40))   
	  
		SET @Continue_S = 1   
		IF (@CoGuid = 0x0) 
		BEGIN   
			WHILE @Continue_S <> 0   
			BEGIN   
				SET @Level_S = @Level_S + 1   
				INSERT INTO @FatherBuf_S([GUID],[Level],[Path])  
					SELECT  
						[ac].[Guid], @Level_S,[fb].[Path]  
					FROM  
						[Cost] AS [ac] INNER JOIN @FatherBuf_S AS [fb]  
						ON [ac].[ParentGuid] = [fb].[GUID]   
					WHERE  
						[fb].[Level] = @Level_S - 1   
					ORDER BY  
						[ac].[Code]
				SET @Continue_S = @@ROWCOUNT   
				UPDATE @FatherBuf_S  SET [Path] = [Path] + CAST( ( 0.0000001 * [ID]) AS VARCHAR(40))  WHERE [Level] = @Level_S 
			END   
		END  
		ELSE  
		BEGIN   
			WHILE @Continue_S <> 0   
			BEGIN   
				SET @Level_S = @Level_S + 1   
				INSERT INTO @FatherBuf_S([GUID], [Level], [Path])  
					SELECT  
						[ac].[Guid],@Level_S,[fb].[Path]  
					FROM  
						[Cost] AS [ac] INNER JOIN @FatherBuf_S AS [fb]  
						ON [ac].[ParentGuid] = [fb].[GUID]   
					WHERE  
						[fb].[Level] = @Level_S - 1  
					ORDER BY  
						[ac].[Code]
				SET @Continue_S = @@ROWCOUNT   
				UPDATE @FatherBuf_S  SET [Path] = [Path] + CAST( ( 0.0000001 * ID) AS [VARCHAR](40))  WHERE [Level] = @Level_S 
			END   
		END   
		INSERT INTO @Result 
		SELECT 
			[GUID], [Level], [Path] 
		FROM 
			@FatherBuf_S 
		GROUP BY 
			[GUID], [Level], [Path] 
		ORDER BY [Path] 

	RETURN  
END 


GO

SET ANSI_NULLS, QUOTED_IDENTIFIER ON
GO

	Create View [vbStore]
	 
	as
		Select 
			[T].*
		From
			[Store] [T]
			inner join [CurrentUsers] [U] on ([u].[Seclvl] >= Isnull([T].[SecLvl],0)  or [u].[Admin] = 1) and [u].[spid] = @@Spid
GO

SET ANSI_NULLS, QUOTED_IDENTIFIER ON
GO

Create Procedure [dbo].[PrcPrintLawsuitExpense]
(
	@Guid uniqueidentifier = 0x0
)
 
as
	Select 
		S.* ,
		L.[StartDate],
		L.[No],
		L.[StopPayDate],
		L.[QuittanceDate],
		L.[QuittanceElectricityDate],
		L.[Rent],
	
		L.[IsEnded],
		L.[EndDate],
		L.[ExeNo],
		C.*
	From 
		[Lawsuit] L
		inner join [vwLawsuitExpense] S on S.ParentGuid = L.Guid
		inner join vwLeaseApartment C on C.Guid = L.ContractGuid
		inner join [Resource] R on r.Guid = S.Guid and R.Spid = @@spid
	order By
		S.number

GO

SET ANSI_NULLS, QUOTED_IDENTIFIER ON
GO

Create view [vwBuildingOffer]
 
as
	SELECT 
		[Name] as [ArName],
		Case when (dbo.FnGetLangauge(@@spid) = 1) and (Isnull([LtnName],'') <> '') then [LtnName] else [Name] end as [Name],
		[Number], [Guid], [SecLvl], 
		[LtnName], 
		[BuildingCode], 
		[Emirate], 
		[Area], 
		[Suburb], 
		[Street], 
		[BasinNo], 
		[PieceNo], 
		[FloorCount], 
		[ApartmentCount], 
		[ApartmentCountOfFloor], 
		[ShopCount], 
		[Costunity], 
		[Note], 
		[BHouseFloor], 
		[BHouseFlatCount], 
		[MBalanceFloor], 
		[MBalanceFlatCount], 
		[OfficeFloor], 
		[OfficeCount], 
		[ParkingFloor], 
		[ParkingCount], 
		[ParkingFloorUnder], 
		[ParkingCountUnder], 
		[FlatDriverCount], 
		[FlatServantCount], 
		[StoreCount], 
		[BuildingNo], 
		[BondType], 
		[BondNo], 
		[BondDate], 
		[OfferKind], 
		[OfferValue]
	FROM 
		[vbBuildingOffer]

GO

SET ANSI_NULLS, QUOTED_IDENTIFIER ON
GO
Create Procedure [PrcDeleteFlatBuilding]
(
	@BuildingGuid uniqueidentifier = 'B30C0236-34E9-4292-914F-E6C7B19CD6B9',
	@CardKind int = -1
)
 
as
	Set NoCount On
	Create Table #R
	([CostGuid] uniqueidentifier)
	-- 
	if @CardKind = -1
	Delete 
		[LinkCe]
	where 
		[Guid]= @BuildingGuid and [Kind] = 200

	-- Flat
	if (@CardKind = 0) or (@CardKind = 1) or (@CardKind = 2) or (@CardKind = 3) or (@CardKind = 7) or (@CardKind = 8) or (@CardKind = -1) 
	insert into #R
	Select 
		[A].[CostGuid]
	From 
		[Apartment] [A]
	    inner Join [Building] [B] on [B].[Guid] = [A].[BuildingGuid]
    where 
		[B].[Guid] = @BuildingGuid
		and ([A].[CardKind] = @CardKind or @CardKind = -1)

	if (@CardKind = 0) or (@CardKind = 1) or (@CardKind = 2) or (@CardKind = 3) or (@CardKind = 7) or (@CardKind = 8) or (@CardKind = -1) 
	Delete 
		[Apartment]
	From 
		[Apartment] [A]
	    inner Join [Building] [B] on [B].[Guid] = [A].[BuildingGuid]
    where 
		[B].[Guid] = @BuildingGuid
		and ([A].[CardKind] = @CardKind or @CardKind = -1)


	if (@CardKind = 0) or (@CardKind = 1) or (@CardKind = 2) or (@CardKind = 3) or (@CardKind = 7) or (@CardKind = 8) or (@CardKind = -1) 
	Delete 
		[Cost]
	From 
		[Cost] [C]
		inner join [#R] [A] on [A].[CostGuid] = [C].[Guid]


	--Shop
	if (@CardKind = 4 or @CardKind = 6 or @CardKind = -1)
 	insert Into #R
 	Select 
		[A].[CostGuid]
 	From 
 		[Shop] [A]
 	    inner Join [Building] [B] on [B].[Guid] = [A].[BuildingGuid]
     where 
 		[B].[Guid] = @BuildingGuid
 
	if (@CardKind = 4 or @CardKind = 6 or @CardKind = -1)
	Delete 
 		[Shop]
	From 
 		[Shop] [A]
 	    inner Join [Building] [B] on [B].[Guid] = [A].[BuildingGuid]
    where 
 		[B].[Guid] = @BuildingGuid

	if (@CardKind = 4 or @CardKind = 6 or @CardKind = -1)
	Delete 
		[Cost]
	From 
		[Cost] [C]
		inner join [#R] [A] on [A].[CostGuid] = [C].[Guid]



	--Parking
	if (@CardKind = 5 or @CardKind = -1)
 	insert Into #R
 	Select 
		[A].[CostGuid]
 	From 
 		[Parking] [A]
 	    inner Join [Building] [B] on [B].[Guid] = [A].[BuildingGuid]
     where 
 		[B].[Guid] = @BuildingGuid
 
	if (@CardKind = 5 or @CardKind = -1)
 	Delete 
 		[Parking]
	From 
 		[Parking] [A]
 	    inner Join [Building] [B] on [B].[Guid] = [A].[BuildingGuid]
    where 
 		[B].[Guid] = @BuildingGuid

	if (@CardKind = 5 or @CardKind = -1)
	Delete 
		[Cost]
	From 
		[Cost] [C]
		inner join [#R] [A] on [A].[CostGuid] = [C].[Guid]



GO

SET ANSI_NULLS, QUOTED_IDENTIFIER ON
GO

	Create View [vbCalcQty]
	 
	as
		Select 
			[T].*
		From
			[CalcQty] [T]
			inner join [CurrentUsers] [U] on ([u].[Seclvl] >= Isnull([T].[SecLvl],0)  or [u].[Admin] = 1) and [u].[spid] = @@Spid
GO

SET ANSI_NULLS, QUOTED_IDENTIFIER ON
GO
Create Procedure [PrcSetLastLandRentPrice]
(
	@ParentGuid uniqueidentifier = 0x0
)
 
as
	Select 
		[C].[ParentGuid],
		[Price] as [Rent],
		[CurrencyGuid] as [RentCurrencyGuid]
	into #ChangeLandRent
	From
		[ChangeLandRent] [C]
		inner join (
						Select 
								[ParentGuid],
								Max(Date) as [MaxDate],
								Max([Number]) as [MaxNumber]
						From
							[ChangeLandRent]
						where
							ParentGuid = @ParentGuid or @ParentGuid = 0x0
						Group By
							[ParentGuid]
					) [C2] on [C2].[ParentGuid] = [C].[ParentGuid] 
							and [C].[Date] = [C2].[MaxDate] 
							and (Case when [C].[Date] = [C2].[MaxDate] then [MaxNumber] else [C].[Number] end = [C].[Number])
	where
		C.ParentGuid = @ParentGuid or @ParentGuid = 0x0
		
	update Earth  
	Set 
		Rent = C.Rent,
		RentCurrencyGuid = C.RentCurrencyGuid
	From
		 Earth a
		 inner join #ChangeLandRent C on C.ParentGuid = a.Guid

GO

SET ANSI_NULLS, QUOTED_IDENTIFIER ON
GO

Create View [vwShopOffer]
 
as

	Select
		[A].*
	From
		[vbShopOffer] [A]


GO

SET ANSI_NULLS, QUOTED_IDENTIFIER ON
GO

Create Procedure [PrcGetBuildingIdentityDetail]
(
	@BuildingGuid uniqueidentifier = '696C763B-9272-49AB-BB72-41BB43E1B063'
)
 
as
	Select 
		[F].[No] as [FlatNo]
	    ,[RentName]
		,[D].[Mobile]
		,[ContractNo]
	    ,[BeginContractDate]
	    ,[EndContractDate]
	    ,[ContractPeriod]
	    ,[ContractValue]
	    ,[BeginInvestmentDate]
	    ,[DeservedDay]
	    ,[DeservedValue]
	    ,[checkValue]
	    ,[DeservedCashValue]
	    ,[InsuranceValue]
	    ,[F].[Guid] as [FlatGuid]
		,[C].[AcGuid] as [CustomerRentAccountGuid]
		,[C].[InsuranceAccountGuid] as [CustomerInsuranceAccountGuid]
	From 
		[Building] [B]
		inner join [Apartment] [F] on [B].[Guid] = [F].[BuildingGuid]
		left join [BuildingIdentityDetail] [D] On [D].[FlatGuid] = [F].[Guid]
		left join [vwCustomer] [C] on [C].[Name] = [D].[RentName]
	where
		[B].[Guid] = @BuildingGuid
	Order By
		[F].[NO]

GO

SET ANSI_NULLS, QUOTED_IDENTIFIER ON
GO

	Create View [vbQtyGroup]
	 
	as
		Select 
			[T].*
		From
			[QtyGroup] [T]
			inner join [CurrentUsers] [U] on ([u].[Seclvl] >= Isnull([T].[SecLvl],0)  or [u].[Admin] = 1) and [u].[spid] = @@Spid
GO

SET ANSI_NULLS, QUOTED_IDENTIFIER ON
GO

Create Trigger [TRG_DEntry_AddWithNonAccount]
on [DEntry] 
 
For INSERT , Update
As

	Declare @S Varchar(256)
	Set @S = dbo.sc('       '+char(13)+char(13)+'     ')
	if exists(Select Top 1 * From inserted I where AcGuid is Null) 
	BEGIN
		RAISERROR (@s, 16, 1)
		ROLLBACK TRANSACTION
	END


GO

SET ANSI_NULLS, QUOTED_IDENTIFIER ON
GO
Create View [vwLawsuitCachPayment]
 
as
	Select
		[L].[Guid] as [LawsuitGuid],
		[H].[HNumber] as [Number],
		[H].[DNumber],
		[H].[HDate] as [Date],
		[H].[DCredit] as [Value],
		[H].[CurrencyGuid],
		[H].[CurrencyName] as [Currency],
		[H].[CurrencyVal],
		[H].[HNote],
		[H].[DNote],
		[h].AcGuid,
		1 as [Print],
		[S].[contractGuid],
		[H].[HGuid] as [Guid]
	from
		Secondary_Entry S
		inner join HEntry E on E.Guid = S.Guid
		inner join [vwDetailEntry] [H] on [H].[HGuid] = [E].[Guid] 
		inner join Lawsuit L on L.Guid = S.contractGuid
	where
		[H].[DCredit] <> 0


GO

SET ANSI_NULLS, QUOTED_IDENTIFIER ON
GO

	Create View [vbFlatContractReceiptNO]
	 
	as
		Select 
			[T].*
		From
			[FlatContractReceiptNO] [T]
			inner join [CurrentUsers] [U] on ([u].[Seclvl] >= Isnull([T].[SecLvl],0)  or [u].[Admin] = 1) and [u].[spid] = @@Spid
GO

SET ANSI_NULLS, QUOTED_IDENTIFIER ON
GO

CREATE function dbo.FnTestCheckCollection
(
	@CheckGuid uniqueidentifier = 0x0
)
RETURNS Bit
 
AS
BEGIN
	Declare @RBit bit
	
	Set @RBit = 0

	if Exists( Select * from ChecksCollection where CheckGuid = @CheckGuid and [Kind] = 1)
	Set @RBit = 1

	--if @RBit = 0
	--if Exists( Select * from ChecksPartialCollection where CheckGuid = @CheckGuid )
	--Set @RBit = 1
	
	return @RBit

END

GO

SET ANSI_NULLS, QUOTED_IDENTIFIER ON
GO
CREATE PROCEDURE [dbo].[prcAddFld] 
(
	@Table [VARCHAR](128), 
	@Column [VARCHAR](128), 
	@Type [VARCHAR](300) 
)
 
AS 
	SET @Table = REPLACE(REPLACE(@Table, ']', ''), '[', '') 
	SET @Column = REPLACE(REPLACE(@Column, ']', ''), '[', '') 

	-- assure that the table exists, and the column doesn't 
	IF [dbo].[fnObjectExists](@Table + '.' + @Column) <> 0 OR [dbo].[fnObjectExists](@Table) = 0 
	begin
		Print 'Field is exists  '+@Table +'.'+@Column 
		RETURN 0 
	end
	DECLARE @Sql AS [VARCHAR](500) 

	SET @Sql = 'ALTER TABLE [' + @Table + '] ADD [' + @Column + '] ' + @Type 
	EXEC( @Sql) 
	RETURN 1 


GO

SET ANSI_NULLS, QUOTED_IDENTIFIER ON
GO

Create Procedure [PrcMapsObject]
(
	@MapGuid uniqueidentifier = 0x0,
	@Filter Varchar(256) = ''
)
 
as
	Select 
		[B].[Name] as [Name],
		[M].[BuildingGuid] as [ObjGuid],
		[M].[Kind],
		[M].[X],
		[M].[Y]
	Into #R
	From 
		[MapsObject] [M]
		inner join [Building] [B] on [B].[Guid] = [M].[BuildingGuid]
	where
		[M].[MapGuid] = @MapGuid

	Insert Into #R
	Select 
		[B].[Name] as [Name],
		[M].[LandGuid] as [ObjGuid],
		[M].[Kind],
		[M].[X],
		[M].[Y]
	From 
		[MapsObject] [M]
		inner join [vwearth] [B] on [B].[Guid] = [M].[LandGuid]
	where
		[M].[MapGuid] = @MapGuid

	Insert Into #R
	Select 
		[B].[Name] as [Name],
		[M].[VillaGuid] as [ObjGuid],
		[M].[Kind],
		[M].[X],
		[M].[Y]
	From 
		[MapsObject] [M]
		inner join [vwVilla] [B] on [B].[Guid] = [M].[VillaGuid]
	where
		[M].[MapGuid] = @MapGuid


	Insert Into #R
	Select 
		[M].[Note] as [Name],
		0x0 as [ObjGuid],
		[M].[Kind],
		[M].[X],
		[M].[Y]
	From 
		[MapsObject] [M]
	where
		[M].[MapGuid] = @MapGuid
		and	[Kind] = 4
		and [Note] <> '' 

	Select * from #R
	where
		[Name] Like '%'+@Filter+'%'
	Order By
		[Name]


GO

SET ANSI_NULLS, QUOTED_IDENTIFIER ON
GO

	Create View [vbParkingContractReceiptNO]
	 
	as
		Select 
			[T].*
		From
			[ParkingContractReceiptNO] [T]
			inner join [CurrentUsers] [U] on ([u].[Seclvl] >= Isnull([T].[SecLvl],0)  or [u].[Admin] = 1) and [u].[spid] = @@Spid
GO

SET ANSI_NULLS, QUOTED_IDENTIFIER ON
GO

	Create View [vbLandContractReceiptNO]
	 
	as
		Select 
			[T].*
		From
			[LandContractReceiptNO] [T]
			inner join [CurrentUsers] [U] on ([u].[Seclvl] >= Isnull([T].[SecLvl],0)  or [u].[Admin] = 1) and [u].[spid] = @@Spid
GO

SET ANSI_NULLS, QUOTED_IDENTIFIER ON
GO

Create Proc [Prc_GeneralLedgerCost]
(
	@AccountGuid [uniqueidentifier]= 0x0
	,@BranchGuid uniqueidentifier = 0x0
	,@CostGuid [uniqueidentifier]= 'C1DC33AC-F73E-4C69-93BA-A8B25C4325C6'
	,@CurrencyGuid [uniqueidentifier] = 0x0
	,@CurrencyVal Float = 1
	,@IsPosted Bit = 1
	,@IsNotPosted Bit = 1
	,@CkDate Bit = 0
	,@Date1 DateTime = '1/1/2007'
	,@Date2 DateTime = '12/30/2008'
	,@Level int = 0
	,@ShowDebit Bit = 1
	,@ShowCredit Bit = 1
)
 
as
	--Set NoCount On
	Exec PrcInsertSC '' 

	Select * Into #fnGetAccountList from [dbo].[fnGetAccountList](@AccountGuid)
	Select * Into [dbo].#fnGetCostList From [dbo].[fnGetCostList](@CostGuid)
	
	Select Top 1
		@level = @level + IsNull([Level],0)
	From
		[dbo].[#fnGetAccountList]

	if @CurrencyVal = 0 
	Set @CurrencyVal = 1
	
	CREATE TABLE #Res
	(
		[Date] DATETIME
		,[AccountName] [varchar] (256) COLLATE Arabic_CI_AI
		,[Note] [varchar] (max) COLLATE Arabic_CI_AI
		,[Debit] FLOAT
		,[Credit] FLOAT
		,[Cost] [varchar] (256) COLLATE Arabic_CI_AI
		,[Kind] INT
		,[Name] [varchar] (256) COLLATE Arabic_CI_AI
		,Sort INT
		,[Guid] [uniqueidentifier]
		,[level] int
		,[Number] int
		,[Id] int identity(1,1)
	)

	

	INSERT INTO #Res
	(
		[Date]
		,[AccountName]
		,[Note]
		,[Debit]
		,[Credit]
		,[Cost]
		,[Kind]
		,[Name]
		,[Sort]
		,[level]
		,[Number]
		,[Guid]
	)
	Select 
		[m].[Date]
		,[Ac2].[Code]+'-'+[Ac2].[Name] as [AccountName]
		,'['+Cast([M].[Number] as Varchar(20) )+'] '+ [En].[Note] as [Note]
		,Isnull(case when [En].[Debit] <> 0 then [En].[Debit] * 
			Case when [En].[CurrencyGuid] = @CurrencyGuid then 1 
			else [En].[CurrencyVal] / @CurrencyVal end
		end,0) as [Debit]
		,Isnull(case when [En].[Credit] <> 0 then [En].[Credit] * 
			Case when [En].[CurrencyGuid] = @CurrencyGuid then 1 
			else [En].[CurrencyVal] / @CurrencyVal end
		end,0) as [Credit]
		,[Co2].[Code]+'-'+[Co2].[Name] as [Cost]
		,[M].[Kind]
		,[M].[Name]
		,1
		,Co.[Level]
		,m.Number
		,[M].[Guid]
	from 
		[DEntry] [En]
		inner Join [vwEntry] [m] on [M].[Guid] = [En].[ParentGuid]
		inner Join [dbo].[#fnGetAccountList] [Ac] on [Ac].[Guid] = [En].[AcGuid]
		inner join [Account] [Ac2] on [Ac2].[Guid] = [En].[AcGuid]
		inner Join [dbo].[#fnGetCostList] [Co] on [Co].[Guid] = [En].[CostGuid]
		inner join [Cost] [Co2] on [Co2].[Guid] = [Co].[Guid]
	where 
		([M].[Date] Between @Date1 and @Date2 or @CkDate = 0)
		and ([Co2].[Guid] Is Not Null or @CostGuid = 0x0)
		and ([Co].[Guid] Is Not Null)
		and ([M].[BranchGuid] = @BranchGuid or @BranchGuid = 0x0)
		and (
				([M].[IsPosted] = 1 and @IsPosted = 1)
				or ([M].[IsPosted] = 0  and @IsNotPosted = 1)
			)
	Order By 
		[M].[Date], M.Number, [AccountName]


	/*
	INSERT INTO #Res
	(
		[Date]
		,[AccountName]
		,[Note]
		,[Debit]
		,[Credit]
		,[Cost]
		,[Kind]
		,[Name]
		,[Sort]
		,[level]
		,[Guid]
	)
	SELECT
		Null
		,''
		,dbo.SC('')
		,SUM([Debit])
		,SUM([Credit])
		,0x0
		,-1
		,''
		,3
		,0
		,0x0
	FROM
		#Res
	where
		[Sort] <> 2
		*/

 	--
 	delete from #Res
 	where ([level] >= @Level and @Level <> 0)

	SELECT 
		*,
		(	SELECT 
				isnull(Sum([Debit]),0) - isnull(SUM([Credit]),0)
			FROM 
				#Res D 
			WHERE 
				D.[ID] <= E.[ID] 
				and [Kind] <> -1 
				--and ([D].[Id] <> 1 or E.[ID] = 1 or [E].[Id] = (Select Max([Id]) From #Res))
		) AS [RunTotal]
	FROM
		#Res [E]
  	where	
 		([Debit] <> 0 and @ShowDebit = 1)
 		Or
 		([Credit] <> 0 and @ShowCredit = 1)
	Order By 
		[Sort], [Date], Number, [AccountName]

	SELECT
		dbo.SC('') as [Note]
		,SUM([Debit]) as [Debit]
		,SUM([Credit]) as [Credit]
		,SUM([Debit] - [Credit]) as [RunTotal]
	FROM
		#Res
	where [Sort] <> 2
	

GO

SET ANSI_NULLS, QUOTED_IDENTIFIER ON
GO

	Create View [vbEntryDateType]
	 
	as
		Select 
			[T].*
		From
			[EntryDateType] [T]
			inner join [CurrentUsers] [U] on ([u].[Seclvl] >= Isnull([T].[SecLvl],0)  or [u].[Admin] = 1) and [u].[spid] = @@Spid
GO

SET ANSI_NULLS, QUOTED_IDENTIFIER ON
GO
Create View [vwContractLog]
 
as
	Select
		u.[LoginName] as [UserName],
		L.*
	From
		[vbContractLog] [L]
		inner join Realty_Users [U] on [u].Guid = [L].[UserGuid]

GO

SET ANSI_NULLS, QUOTED_IDENTIFIER ON
GO

CREATE FUNCTION [FnFormatZero] (@Number Varchar(256), @digit int)
RETURNS Varchar(256)
 
AS
BEGIN
	Declare @R Varchar(256)
	Set @R = ''

	while (len(@Number) < @digit )
	begin
		Set @R = @R+'0'
		Set @digit = @digit -1
	end
	
	Set @R = @R + Cast(@Number as Varchar(256))

	RETURN @R
END

GO

SET ANSI_NULLS, QUOTED_IDENTIFIER ON
GO
Create View [vwContractCachPayment]
 
as
	Select Distinct
		[C].[ContractGuid],
		[H].[HNumber] as [Number],
		S.Number as [RecieptVoucherNumber],
		[H].[DNumber],
		[H].[HDate] as [Date],
		isNull([H].[DCredit],0) + isNull([H].[DDebit],0) as [Value],
		[H].[CurrencyGuid],
		[H].[CurrencyName] as [Currency],
		[H].[CurrencyVal],
		[H].[HNote],
		[H].[DNote],
		[h].AcGuid,
		(Select Number from Secondary_Entry where Guid = [C].[EntryGuid] ) as SNumber,
		1 as [Print],
		[H].[HGuid] as [Guid]
	from 
		[ContractCachPayment] [C]
		inner join [vwDetailEntry] [H] on [H].[HGuid] = [C].[EntryGuid] 
		left join Secondary_Entry S on S.Guid = H.[HGuid]
		inner join LeaseApartment L on L.Guid = C.contractGuid and L.CustAccountGuid = H.AcGuid
	where
		((isNull([H].[DCredit],0) + isNull([H].[DDebit],0) <> 0) and L.PayType = 0)
		or ((isNull([H].[DCredit],0)  <> 0) and L.PayType <> 0)


GO

SET ANSI_NULLS, QUOTED_IDENTIFIER ON
GO

	Create View [vbAssetsGroup]
	 
	as
		Select 
			[T].*
		From
			[AssetsGroup] [T]
			inner join [CurrentUsers] [U] on ([u].[Seclvl] >= Isnull([T].[SecLvl],0)  or [u].[Admin] = 1) and [u].[spid] = @@Spid
GO

SET ANSI_NULLS, QUOTED_IDENTIFIER ON
GO
Create View vwRealtyRestrained
 
as
	Select
		R.*,
		Cu.Name as CustName,
		Cu.ArName as CustArName,
		Cu.LtnName as CustLtnName,
		Cu.Nationality as CustNationality,
		B.Name as BuildingName,
		
		[A].[No] as [FlatNo],
		[P].[No] as [ParkingName],
		[V].[VillaNo] as [VillaNo],
		L.Name as [LandName],
		S.NO as [ShopNo],
		
		Ac.Code as DebitAccountCode,
		Ac.Name as DebitAccountName,
		
		Ac2.Code as CreditAccountCode,
		Ac2.Name as CreditAccountName

	From
		[RealtyRestrained] [R]
		inner join vwCustomer [Cu] on [cu].Guid = [R].CustomerGuid
		inner join vwBuilding [b] on [b].Guid = [R].BuildingGuid
		left join vwApartment [A] on [A].Guid = [R].FlatGuid
		Left join vwparking [P] on [P].Guid = [R].[ParkingNo]
		left join vwVilla [V] on [V].Guid = [R].VillaGuid
		left join vwEarth [L] on [L].Guid = [R].LandGuid
		left join vwShop [S] on [S].Guid = [R].Shop
		left join vwAccount [Ac] on [Ac].Guid = [R].DebitAccountGuid
		left join vwAccount [Ac2] on [Ac2].Guid = [R].CreditAccountGuid
		left join vwCheckType [ct] on [ct].Guid = [R].CheckTypeGuid

GO

SET ANSI_NULLS, QUOTED_IDENTIFIER ON
GO

	Create View [vbAssetsChangeArea]
	 
	as
		Select 
			[T].*
		From
			[AssetsChangeArea] [T]
			inner join [CurrentUsers] [U] on ([u].[Seclvl] >= Isnull([T].[SecLvl],0)  or [u].[Admin] = 1) and [u].[spid] = @@Spid
GO

SET ANSI_NULLS, QUOTED_IDENTIFIER ON
GO

Create Function dbo.fnDateIsNull (@Date DateTime ) returns int
 
begin

	declare @R int
	
	Select @R = Case 
					when @Date = '1/1/1900' then 0 
					when @Date = '12/30/1899' then 0 
					else 1 
				end

	return	@R

End

GO

SET ANSI_NULLS, QUOTED_IDENTIFIER ON
GO
Create View [vwAllContractGuid]
 
as

	Select 
		L.[Guid],
		L.[CustomerGuid],
		L.BuildingGuid,
		L.[ApartmentGuid] as [RealtyGuid],
		T.[ContractKind],
		L.TypeGuid,
		T.Name,
		L.Number as ContractNumber
	From 
		[LeaseApartment] [L]
		inner join [ContractType] T on T.Guid = L.TypeGuid
		
	union all
	Select 
		L.Guid,
		L.[CustomerGuid],
		L.BuildingGuid,
		L.[ParkingGuid],
		T.[ContractKind],
		L.TypeGuid,
		T.Name,
		L.Number as ContractNumber
	From 
		[ParkingContract] [L]
		inner join [ContractType] T on T.Guid = L.TypeGuid
		
	union all
	Select
		L.Guid,
		L.[CustomerGuid],
		0x0 as BuildingGuid,
		L.[LandGuid],
		T.[ContractKind],
		L.TypeGuid,
		T.Name,
		L.Number as ContractNumber
	From 
		[LandContract] [L]
		inner join [ContractType] T on T.Guid = L.TypeGuid

	union all
	Select
		L.Guid,
		L.[CustomerGuid],
		0x0 as BuildingGuid,
		0x0 as [RealtyGuid],
		0 as [ContractKind],
		L.TypeGuid,
		T.Name,
		L.Number as ContractNumber
	From 
		[ServicesContract] [L]
		inner join [ServicesContractType] T on T.Guid = L.TypeGuid

	union all
	Select
		L.Guid,
		L.[CustomerGuid],
		0x0 as BuildingGuid,
		0x0 as [RealtyGuid],
		0 as [ContractKind],
		L.TypeGuid,
		T.Name,
		L.Number as ContractNumber
	From 
		[MaintenanceContract] [L]
		inner join [MaintenanceContractType] T on T.Guid = L.TypeGuid

GO

SET ANSI_NULLS, QUOTED_IDENTIFIER ON
GO

	Create View [vbAssetsDepreciation]
	 
	as
		Select 
			[T].*
		From
			[AssetsDepreciation] [T]
			inner join [CurrentUsers] [U] on ([u].[Seclvl] >= Isnull([T].[SecLvl],0)  or [u].[Admin] = 1) and [u].[spid] = @@Spid
GO

SET ANSI_NULLS, QUOTED_IDENTIFIER ON
GO
CREATE Procedure [PrcDecodeHijriDatetoGergDate] 
(
	@Year int, @Month int, @Day int
)
 
as
	Declare @R Datetime

			--,@Y Varchar(256)
			--,@m Varchar(256)
			--,@d Varchar(256)

	Select Top 1 
		@R = Date + @Day -1
	from 
		[HjrConfig] H
	where
		hjrMonth = @Month
		and hjrYear = @year
	Order By
		[hjrMonth]

	--Set @d = Replace(@d,' ','0')
	
	if @R is Null
	begin
			
		Declare @DayCount int, @S Varchar(256)
		Declare @Gdate Datetime Set @Gdate = dbo.fnDateonly(GETDATE())
		Declare @Hy int
		Declare @Hm int
		Declare @Hd int

		Declare @y int 
		Declare @m int 
		Declare @d int 
		
		Set @y = DatePart(Year, @Gdate)
		Set @m = DatePart(Month, @Gdate)
		Set @d = DatePart(Day, @Gdate)
		
		Set @S = Convert(Varchar(256), @Gdate , 131)
	
		Set @Hy = SUBSTRING (@S, 7, 4)
		Set @Hm = SUBSTRING (@S, 4, 2)
		Set @Hd = SUBSTRING (@S, 1, 2)

		Set @hd = Replace(@hd,' ','0')
		Set @hm = dbo.FnFormatNumber(@hm, 2)
		Set @hd = dbo.FnFormatNumber(@hd, 2)
			 
		Declare @IntGDate int, @intHdate int
		Set @intHdate = Cast(dbo.FnFormatNumber(@hy, 4)+dbo.FnFormatNumber(@hm, 2)+dbo.FnFormatNumber(@hd, 2) as int)
		Set @IntGDate = Cast(dbo.FnFormatNumber(@Year, 4)+dbo.FnFormatNumber(@Month, 2)+dbo.FnFormatNumber(@Day, 2) as int)	

		Declare @I int
		Set @I = 0
		while (@intHdate <> @IntGDate) and (@i < 365)
		begin
			Set @i = @I + 1
			--Select @IntGDate, @intHdate, @Gdate
			
			if @IntGDate > @intHdate
			begin
				Set @Gdate = @Gdate + 1
			end
			else
			begin
				Set @Gdate = @Gdate - 1
			end

			Set @y = DatePart(Year, @Gdate)
			Set @m = DatePart(Month, @Gdate)
			Set @d = DatePart(Day, @Gdate)
			
			Set @S = Convert(Varchar(256), @Gdate , 131)
			--Select @S S, @Gdate Date
		
			Set @Hy = SUBSTRING (@S, 7, 4)
			Set @Hm = SUBSTRING (@S, 4, 2)
			Set @Hd = SUBSTRING (@S, 1, 2)

			Set @hd = Replace(@hd,' ','0')
			Set @hm = dbo.FnFormatNumber(@hm, 2)
			Set @hd = dbo.FnFormatNumber(@hd, 2)

			Set @intHdate = Cast(dbo.FnFormatNumber(@hy, 4)+dbo.FnFormatNumber(@hm, 2)+dbo.FnFormatNumber(@hd, 2) as int)
			Set @IntGDate = Cast(dbo.FnFormatNumber(@Year, 4)+dbo.FnFormatNumber(@Month, 2)+dbo.FnFormatNumber(@Day, 2) as int)	
		end
		
		Set @R = @Gdate
	end
	
	if @i >= 365
	Set @R = 0

	Select dbo.fnDateonly(@R)


GO

SET ANSI_NULLS, QUOTED_IDENTIFIER ON
GO

	Create View [vbReceiptOrderType]
	 
	as
		Select 
			[T].*
		From
			[ReceiptOrderType] [T]
			inner join [CurrentUsers] [U] on ([u].[Seclvl] >= Isnull([T].[SecLvl],0)  or [u].[Admin] = 1) and [u].[spid] = @@Spid
GO

SET ANSI_NULLS, QUOTED_IDENTIFIER ON
GO
Create View [vwOwnerUnionFeeDetail]
 
as

	Select 
		D.ParentGuid,
		F.Number,
		F.NO,
		F.FlatKind,
		F.[ApartmentType],
		D.[Area],
		F.[unity],
		dbo.FnMyRound(P.Fee * D.[Area] ,P.RoundKind) as [Fee],
		Cu.Name as [AccountName],
		Co.Name as [Cost] ,
		Cu.acGuid [AccountGuid] ,
		F.CostGuid,
		D.[Note],
		1 as [Kind],
		F.Guid as [FlatGuid]
	From 
		OwnerUnionFee P 
		inner join [OwnerUnionFeeDetail] D on D.parentGuid = P.Guid
		inner join [Apartment] F on F.Guid = D.FlatGuid
		inner join Building B on B.Guid = F.BuildingGuid
		left join vwCustomer Cu on Cu.Guid = F.CustOwnerGuid
		left join Cost Co on Co.Guid = F.CostGuid

	union All
	Select 
		D.ParentGuid,
		F.Number,
		F.NO,
		F.ShopKind,
		F.[Description],
		D.[Area],
		F.[unity],
		dbo.FnMyRound(P.Fee * D.[Area] ,P.RoundKind) as [Fee],
		Cu.Name as [AccountName],
		Co.Name as [Cost] ,
		Cu.acGuid [AccountGuid] ,
		F.CostGuid,
		D.[Note],
		2 as [Kind],
		F.Guid as [FlatGuid]
	From 
		OwnerUnionFee P 
		inner join [OwnerUnionFeeDetail] D on D.parentGuid = P.Guid
		inner join [Shop] F on F.Guid = D.FlatGuid
		inner join Building B on B.Guid = F.BuildingGuid
		left join vwCustomer Cu on Cu.Guid = F.CustGuid
		left join Cost Co on Co.Guid = F.CostGuid

	union All
	Select 
		D.ParentGuid,
		F.Number,
		F.NO,
		F.ParkingKind,
		F.[Description],
		D.[Area],
		F.[unity],
		dbo.FnMyRound(P.Fee * D.[Area] ,P.RoundKind) as [Fee],
		Cu.Name as [AccountName],
		Co.Name as [Cost] ,
		Cu.acGuid [AccountGuid] ,
		F.CostGuid,
		D.[Note],
		3 as [Kind],
		F.Guid as [FlatGuid]
	From 
		OwnerUnionFee P 
		inner join [OwnerUnionFeeDetail] D on D.parentGuid = P.Guid
		inner join [Parking] F on F.Guid = D.FlatGuid
		inner join Building B on B.Guid = F.BuildingGuid
		left join vwCustomer Cu on Cu.Guid = F.CustGuid
		left join Cost Co on Co.Guid = F.CostGuid

GO

SET ANSI_NULLS, QUOTED_IDENTIFIER ON
GO

Create Procedure [PrcContractWorkFlow]
(
	@RealtyNo varchar(255) = '',

	@Printed int = 0,
	@Certification int = 0,
	
	@CustStep1 int = 0,
	@CustStep2 int = 0,
	
	@CompStep1 int = 0,
	@CompStep2 int = 0,
	@CompStep3 int = 0,
	@CompStep4 int = 0,
	
	@CompStep5 int = 0,
	@CompStep6 int = 0,
	@CompStep7 int = 0,

	@ActiveBuildingList Bit = 0,
	
	@ShowIsCheck Bit = 1,
	@ShowIsNotCheck Bit = 1,
	@ContractState int = 0
)
 
as
	Select
		[C].[BuildingName], 
		[C].[FlatNo],
		[C].[FloorNo],
		[C].[ContractNo],
		[C].[CustName], 

		Case 
			when [Printed] = 1 then dbo.sc('  ')  
			when [Printed] = 2 then dbo.sc('    ')  
			when [Printed] = 3 then dbo.sc(' ')  
			when isNull([Printed],-1) = -1 then dbo.sc(' ')  
		end 
		as [Printed],
		Case when [F].[Certification] = 1 then dbo.SC('') when [F].[Certification] = 1 then dbo.SC('') end as [Certification],

		Case when [F].[CustStep1] = 1 then dbo.SC('') else dbo.SC('') end [CustStep1],
		CustStepDate1,
		Case when [F].[CustStep2] = 1 then dbo.SC('') else dbo.SC('') end [CustStep2],
		CustStepDate2,

		Case when [F].[CompStep1] = 1 then dbo.SC('') else dbo.SC('') end [CompStep1],
		CompStepDate1,
		Case when [F].[CompStep2] = 1 then dbo.SC('') else dbo.SC('') end [CompStep2],
		CompStepDate2,
		Case when [F].[CompStep3] = 1 then dbo.SC('') else dbo.SC('') end [CompStep3],
		CompStepDate3,
		Case when [F].[CompStep4] = 1 then dbo.SC('') else dbo.SC('') end [CompStep4],
		CompStepDate4,

		Case when [F].[CompStep5] = 1 then dbo.SC('') else dbo.SC('') end [CompStep5],
		CompStepDate5,
		Case when [F].[CompStep6] = 1 then dbo.SC('') else dbo.SC('') end [CompStep6],
		CompStepDate6,
		Case when [F].[CompStep7] = 1 then dbo.SC('') else dbo.SC('') end [CompStep7],
		CompStepDate7,

		[C].[Guid] as [ContractGuid],
		
		Case when [R].[ObjGuid] is null then 0 
			 when [R].[ObjGuid] is not null  then 1 end as [Check],
		C.BuildingGuid,
		F.Guid 
	into #R_ContractWorkFlow
	from
		[ContractWorkFlow] F
		inner join vwAllContract C on C.Guid = f.ContractGuid
		inner join [Resource] [RS] on [RS].[Guid] = [C].[TypeGuid] and [RS].[Spid] = @@Spid and [RS].[Kind] = 100
		--left join [Resource] [Rb] on [Rb].[Guid] = [C].[BuildingGuid] and [RS].[Spid] = @@Spid and [RS].[Kind] = 101
		left join [RepCheck] [R] on [R].[ObjGuid] = [C].[Guid] and [R].[IdReport] = 4000
	where
		(C.FlatNo = @RealtyNo or @RealtyNo = '')
		and (F.Printed = @Printed +1 or @Printed = 3)
		and (F.Certification = @Certification+1 or @Certification = 2)
		and (F.CustStep1 = @CustStep1 or @CustStep1 = 2)
		and (F.CustStep2 = @CustStep2 or @CustStep2 = 2)
	
		and (F.CompStep1 = @CompStep1 or @CompStep1 = 2)
		and (F.CompStep2 = @CompStep2 or @CompStep2 = 2)
		and (F.CompStep3 = @CompStep3 or @CompStep3 = 2)
		and (F.CompStep4 = @CompStep4 or @CompStep4 = 2)
		
		and (F.CompStep5 = @CompStep5 or @CompStep5 = 2)
		and (F.CompStep6 = @CompStep6 or @CompStep6 = 2)
		and (F.CompStep7 = @CompStep7 or @CompStep7 = 2)

		and (
			([R].[ObjGuid] is not null and @ShowIsCheck = 1)
			or
			([R].[ObjGuid] is null and @ShowIsNotCheck = 1)
			)
		and (
				([C].[ContractFinish] = 0 and @ContractState = 2)
				or 
				([C].[ContractFinish] = 1 and @ContractState = 1)
				or 
				@ContractState = 0
			)
		
	-- 
	if @ActiveBuildingList = 1
	begin
		Delete #R_ContractWorkFlow
		From
			#R_ContractWorkFlow [L]
			left join [Resource] [R] on [R].[Guid] = [L].[BuildingGuid] and [R].[Kind] = 101 and [R].[Spid] = @@Spid 
		where
			[R].[Guid] Is Null
			and L.BuildingGuid <> 0x0
	end

	Select * from #R_ContractWorkFlow

GO

SET ANSI_NULLS, QUOTED_IDENTIFIER ON
GO

CREATE FUNCTION [fnIncMonthHijriDate] (@Date Datetime, @IncM int)
RETURNS Datetime  AS
BEGIN
	Declare @R Datetime

	Declare 
		@Y int, @M int, @D int,
		@Hdate Varchar(256),
		@Sign int

	 
	Select @Hdate = dbo.FnGregToHijriDate(@Date, 'dd/mm/yyy')

	Set @Y = SUBSTRING(@Hdate, 7, 4)
	Set @M = SUBSTRING(@Hdate, 4, 2)
	Set @d = SUBSTRING(@Hdate, 1, 2)

	If @IncM > 0
	Set @Sign = 1 
	else 
	Set @Sign = -1

	Set @M = @M + @IncM


	while @M -1 > 11
	begin
		Set @Y = @Y + @Sign;
		Set @M = @M + ( -12 * @Sign)
	end;
	
	RETURN dbo.fnDecodeHijriDatetoGergDate(@y, @m, @d)

END

GO

SET ANSI_NULLS, QUOTED_IDENTIFIER ON
GO

Create Procedure [PrcTransferCheckCardType]
(
	@TypeGuid1 uniqueidentifier = 0x0,
	@TypeGuid2 uniqueidentifier = 0x0,
	@Date1 DateTime = '1/1/2007',
	@Date2 DateTime = '1/1/2012',
	@Num1 int = 0,
	@Num2 int = 0
)
 
as
	Declare @RC int

	Update [Checks] Set TypeGuid = @TypeGuid2, Number  = Null
	where
		TypeGuid = @TypeGuid1
		and ([date] between @Date1 and @Date2 or (@Date1 = 0 and @Date2 = 0))
		and ([Number] between @Num1 and @Num2 or @Num1 = 0)
		
	Set @RC = @@ROWCOUNT	

	Delete [Checks] 
	where
		TypeGuid = @TypeGuid1
		and ([date] between @Date1 and @Date2)
		and ([Number] between @Num1 and @Num2 or @Num1 = 0)
			
	Create Table #Tbl
	(
		[id] Int identity(1,1),
		Guid uniqueidentifier
	)

	Insert Into #Tbl
	([Guid])
	Select
		Guid
	From
		Checks
	where 
		IsNull(Number,-1) = -1
	Order By
		[Date]


	Declare @MaxNum int
	Set @MaxNum = (Select isNull(Max(Number),0) + 1 From Checks where TypeGuid = @TypeGuid2)
	
	Update Checks Set Number = @MaxNum + [id]
	From
		Checks gr
		inner join #Tbl t On t.Guid = gr.Guid	
		

	Select @RC As [RC]
		

GO

SET ANSI_NULLS, QUOTED_IDENTIFIER ON
GO

	Create View [vbServicesContract]
	 
	as
		Select 
			[T].*
		From
			[ServicesContract] [T]
			inner join [CurrentUsers] [U] on ([u].[Seclvl] >= Isnull([T].[SecLvl],0)  or [u].[Admin] = 1) and [u].[spid] = @@Spid
GO

SET ANSI_NULLS, QUOTED_IDENTIFIER ON
GO

Create Procedure [PrcSaveRepCheck]
(
	@ObjGuid uniqueidentifier = '{50C88966-2CE3-4E9B-9A8C-FF7A9BB8DADC}',
	@UserGuid uniqueidentifier = 'BA39109E-54EA-479F-9C3F-5856C14842C7',
	@IsCheck bit = 0,
	@RepId int = 3000
)
 
as
	Delete [RepCheck]
	where
		[ObjGuid] = @ObjGuid
		and [IdReport] = @RepId
		--and [UserGuid] = @UserGuid

	if @IsCheck = 1
	begin
		insert into [RepCheck]
		(
			[ObjGuid],
			[UserGuid],
			[IdReport],
			[date]
		)
		Select
			@ObjGuid,
			@UserGuid,
			@RepId,
			GetDate()
	end


GO

SET ANSI_NULLS, QUOTED_IDENTIFIER ON
GO

	Create View [vbMaintenanceContract]
	 
	as
		Select 
			[T].*
		From
			[MaintenanceContract] [T]
			inner join [CurrentUsers] [U] on ([u].[Seclvl] >= Isnull([T].[SecLvl],0)  or [u].[Admin] = 1) and [u].[spid] = @@Spid
GO

SET ANSI_NULLS, QUOTED_IDENTIFIER ON
GO

Create View [vwIncAccount]
 
as
	Select
		[A].[Number], 
		[A].[Guid], 
		[A].[Code], 
		[A].[ParentGuid], 
		[A].[Note], 
		[A].[LtnName],
		[A].[Name] as [ArName],
		Case when (dbo.FnGetLangauge(@@spid) = 1) and (Isnull([A].[LtnName],'') <> '') then [A].[LtnName] else [A].[Name] end as [Name], 
		case when [A].[ParentGuid] is Not Null then [A].[ParentGuid] else 0x0 end as [Parent]
	from
		vbIncAccount A


GO

SET ANSI_NULLS, QUOTED_IDENTIFIER ON
GO

	Create View [vbBuildingGuard]
	 
	as
		Select 
			[T].*
		From
			[BuildingGuard] [T]
			inner join [CurrentUsers] [U] on ([u].[Seclvl] >= Isnull([T].[SecLvl],0)  or [u].[Admin] = 1) and [u].[spid] = @@Spid
GO

SET ANSI_NULLS, QUOTED_IDENTIFIER ON
GO

Create Procedure PrcCalcMaxIncAccountcode
(
	@Guid uniqueidentifier = '9A88A0D4-1A00-42F6-90F5-649308B14269'
)
 as

	Declare @LenCode int
	Set @LenCode = (Select Len([Code]) From [IncAccount] where [Guid] = @Guid)
	Declare @mxCode varchar(255)
	
	select Top 1
		@mxCode = 
		Case when ISNUMERIC( RIGHT([Code], Len([Code]) - @LenCode)) = 1
		then 
			[Code]
		end
	From 
		IncAccount
	where 
		[ParentGuid] = @Guid	
	order by
		len(Code) desc , Code desc

	if @mxCode = ''	Set @mxCode = Null

	Declare @Ms Varchar(256)
	Set @Ms = dbo.SC('      ') --+ '  ' + @mxCode

	Declare @ChildCount int
	Select @ChildCount = COUNT(*) From IncAccount where ParentGUID = @Guid
	
	if (ISNULL(@mxCode,'') = '') and (ISNULL(@ChildCount,0) <> 0)

	if ISNULL(@mxCode,'') = ''
	begin
		RAISERROR (@Ms, 16, 1)
		return
	end
	--return

	Declare @Code Varchar(20)
	Set @Code = (Select [Code] From [IncAccount] where [Guid] = @Guid)
	
	Declare @LenNewCode int
	Set @LenNewCode = Len(@mxCode)  - @LenCode

	if ISNULL(@LenNewCode, 0) = 0 Set @LenNewCode = 1
		
	Select 
		@Code + 
		ISNULL(
		Cast(
				dbo.FnFormatNumber(
									Right(Cast(RIGHT(@mxCode, Len(@mxCode) - @LenCode)as int)+1 , 
									@LenNewCode), @LenNewCode) as Varchar(256
								  )
			), '001') as [Code]
			

GO

SET ANSI_NULLS, QUOTED_IDENTIFIER ON
GO

Create Procedure [PrcTreeAccount]
(
	@AcGuid uniqueidentifier = 0x0
)
 
as
	Declare @Level int
	Set @Level = Case when @AcGuid = 0x0 then 0 else 3 end

	Create Table #Res 
	(
		[Number] int, 
		[Guid] uniqueidentifier, 
		[Code] Varchar(256), 
		[Type] int, 
		[FinalGUID]uniqueidentifier,
		[LtnName] Varchar(256), 
		[Name] Varchar(256), 
		[ParentGuid]uniqueidentifier,
		[NSons] int,
		[CustGuid]uniqueidentifier,
		[FinalAccount]Varchar(256),
		[Path]  Varchar(256)
	)

	Select * into #fnGetAccountList from [dbo].[fnGetAccountList](@AcGuid)

	insert into #Res
	Select
		[A].[Number], 
		[A].[Guid], 
		[A].[Code], 
		[A].[Type], 
		[A].[FinalGUID], 
		[A].[LtnName],
		Case when (dbo.FnGetLangauge(@@spid) = 1) and (Isnull([A].[LtnName],'') <> '') then [A].[LtnName] else [A].[Name] end as [Name], 
		case when [A].[ParentGuid] is Not Null then [A].[ParentGuid] else 0x0 end as [Parent],
		0 as [NSons],
		0x0 as [CustGuid],
		'' As [FinalAcount],
		[F].[Path]
	From 
		[vbAccount] [A]
		inner join [dbo].[#fnGetAccountList] [F] on [F].[Guid] = [A].[Guid]
--	where	(Len([Path]) / 9) between @Level and @Level + 3

	
	CREATE INDEX IXS_Guid ON #Res ([Guid])
	CREATE INDEX IXS_FinalGuid ON #Res ([FinalGuid])
	-----------------------------------------------------------------------------------

	UPDATE [R] SET   
 		[FinalAccount] = '('+[Ac].[Code] +'-'+ [Ac].[Name]+')'
 	FROM   
 		#Res [R]
		INNER JOIN [vwAccount] as [ac] ON [R].[FinalGuid] = [ac].[Guid]  


	-----------------------------------------------------------------------------------
	UPDATE [R] SET   
 		[CustGuid] = [Cu].[Guid]
 	FROM   
 		#Res [R]
		INNER JOIN [vwCustomer] as [Cu] ON [R].[Guid] = [Cu].[acGuid]  

	-----------------------------------------------------------------------------------


	UPDATE [R] SET   
 		[NSons] = [S].[NSons]
 	FROM   
 		#Res [R]
 		inner join (Select 
 						Count([Number]) as [NSons], 
						[ParentGuid] as [SGuid]
 					From 
 						[Account]
 					Group By
 						[ParentGuid]
 					) [S] On [S].[SGuid] = [R].[Guid]


	-----------------------------------------------------------------------------------
	/*
	Select 
		*
		,Len([Path]) / 9 as [level]
	from 
		#Res
	ORDER BY [Type], [Path]
	*/
		
	DROP INDEX IXS_Guid ON #Res WITH ( ONLINE = OFF )
	DROP INDEX IXS_FinalGuid ON #Res WITH ( ONLINE = OFF )
	
	CREATE INDEX IXS_Res_Path ON #Res ([Type], [Path])
	Alter Table #Res add Id int identity(1,1)
	
	Select
		*
		,Len([Path]) / 9 as [level]
		,(select id from #Res rp where rp.guid = r.Parentguid) as [ParentId]
	from 
		#Res r
	ORDER BY id
	

GO

SET ANSI_NULLS, QUOTED_IDENTIFIER ON
GO
Create View [vwRentinfo]
 
as
	Select
		[Number],
		[Guid],
		[SecLvl],
		[Name] as [arName],
		[LtnName],
		Case when (dbo.FnGetLangauge(@@spid) = 1) and (Isnull([A].[LtnName],'') <> '') then [A].[LtnName] else [A].[Name] end as [Name],
		[Adjective],
		[PassportNO],
		[PassportExpireDate],
		[WorkCardNo],
		[Nationality],
		[Work],
		[PersonalityNo],
		[Address],
		[Phone],
		[Mobile],
		[Fax],
		[BoxNo],
		[EMail],
		[LtnNationality]
	From
		[vbRentinfo] [a]

GO

SET ANSI_NULLS, QUOTED_IDENTIFIER ON
GO
Create View vwIncAccountDetailAc
 
as
	Select
		Ac.Code +'-'+ Ac.Name as Account,
		Ac.Code as AccountCode,
		Ac.Name as AccountName,
		a.*
	From
		[IncAccountDetailAc] [a]
		inner join Account [Ac] on [Ac].Guid = [a].[AccountGuid]

GO

SET ANSI_NULLS, QUOTED_IDENTIFIER ON
GO
Create Function dbo.[fnInfoFld] (@Guid uniqueidentifier, @cardid Float)
returns @Tbl Table (
						[Guid]  [uniqueidentifier] ,
						[FldValue1] Varchar(256),
						[FldValue2] Varchar(256),
						[FldValue3] Varchar(256),
						[FldValue4] Varchar(256),
						[FldValue5] Varchar(256),
						[FldValue6] Varchar(256),
						[FldValue7] Varchar(256),
						[FldValue8] Varchar(256),
						[FldValue9] Varchar(256),
						[FldValue10] Varchar(256),
						[FldValue11] Varchar(256),
						[FldValue12] Varchar(256),
						[FldValue13] Varchar(256),
						[FldValue14] Varchar(256),
						[FldValue15] Varchar(256)
					)
 
as
begin
	Insert Into @Tbl
	Select Distinct
		b.[CardGuid] as [CardGuid],
		(Select fldValue From [InfofldValue] v where (v.[CardGuid] = b.[CardGuid]) and (V.Cardid = @CardId) and v.id = 1) as [FldValue1],
		(Select fldValue From [InfofldValue] v where (v.[CardGuid] = b.[CardGuid]) and (V.Cardid = @CardId) and v.id = 2) as [FldValue2],
		(Select fldValue From [InfofldValue] v where (v.[CardGuid] = b.[CardGuid]) and (V.Cardid = @CardId) and v.id = 3) as [FldValue3],
		(Select fldValue From [InfofldValue] v where (v.[CardGuid] = b.[CardGuid]) and (V.Cardid = @CardId) and v.id = 4) as [FldValue4],
		(Select fldValue From [InfofldValue] v where (v.[CardGuid] = b.[CardGuid]) and (V.Cardid = @CardId) and v.id = 5) as [FldValue5],
		(Select fldValue From [InfofldValue] v where (v.[CardGuid] = b.[CardGuid]) and (V.Cardid = @CardId) and v.id = 6) as [FldValue6],
		(Select fldValue From [InfofldValue] v where (v.[CardGuid] = b.[CardGuid]) and (V.Cardid = @CardId) and v.id = 7) as [FldValue7],
		(Select fldValue From [InfofldValue] v where (v.[CardGuid] = b.[CardGuid]) and (V.Cardid = @CardId) and v.id = 8) as [FldValue8],
		(Select fldValue From [InfofldValue] v where (v.[CardGuid] = b.[CardGuid]) and (V.Cardid = @CardId) and v.id = 9) as [FldValue9],
		(Select fldValue From [InfofldValue] v where (v.[CardGuid] = b.[CardGuid]) and (V.Cardid = @CardId) and v.id = 1) as [FldValue10],
		(Select fldValue From [InfofldValue] v where (v.[CardGuid] = b.[CardGuid]) and (V.Cardid = @CardId) and v.id = 1) as [FldValue11],
		(Select fldValue From [InfofldValue] v where (v.[CardGuid] = b.[CardGuid]) and (V.Cardid = @CardId) and v.id = 1) as [FldValue12],
		(Select fldValue From [InfofldValue] v where (v.[CardGuid] = b.[CardGuid]) and (V.Cardid = @CardId) and v.id = 1) as [FldValue13],
		(Select fldValue From [InfofldValue] v where (v.[CardGuid] = b.[CardGuid]) and (V.Cardid = @CardId) and v.id = 1) as [FldValue14],
		(Select fldValue From [InfofldValue] v where (v.[CardGuid] = b.[CardGuid]) and (V.Cardid = @CardId) and v.id = 1) as [FldValue15]
	from
		[InfofldValue] B
	where
		B.cardGuid = @Guid or @Guid = 0x0
		
	Return
end

GO

SET ANSI_NULLS, QUOTED_IDENTIFIER ON
GO

Create View [vwBranch]
 
as
	Select
		[A].[Number], [A].[Guid], [A].[Code], [A].[ParentGuid], [A].[Note], [A].[Phone], [A].[Address],[A].[LtnName],
		Case when (dbo.FnGetLangauge(@@spid) = 1) and (Isnull([A].[LtnName],'') <> '') then [A].[LtnName] else [A].[Name] end as [Name], 
		case when [A].[ParentGuid] is Not Null then [A].[ParentGuid] else 0x0 end as [Parent],
		Isnull([S].[NSons],0) as [NSons]
	From 
		[vbBranch] [A]
		left join (Select 
						Count([Number]) as [NSons], 
						[ParentGuid] as [SGuid]
					From 
						[Branch]
					Group By
						[ParentGuid]
					) [S] On [S].[SGuid] = [A].[Guid]


GO

SET ANSI_NULLS, QUOTED_IDENTIFIER ON
GO

Create Procedure [PrcNewServicesContract]
(
	@Guid uniqueidentifier = 0x0
)
 
as
	Select
		(Select Isnull(Max([Number]),0) + 1 From [LeaseApartment]) as [Number],
		[Guid],
		[ContractNo],
		[CustomerGuid],
		[BuildingGuid],
		[Period],
		Case 
			when [ContractFinish] = 0 then Dateadd(Day,1,[ToDate]) 
			when [ContractFinish] = 1 then Dateadd(Day,1,[ContractFinishDate]) 
		end as [FromDate],
		Dateadd(year,1,
						Case 
							when [ContractFinish] = 0 then [ToDate]
							when [ContractFinish] = 1 then [ContractFinishDate]
						end
				) as [ToDate],
		[Rent] as [Rent],
		[CurrencyGuid],
		[CurrencyVal],
		[PayType],
		[Note],
		[Note2],
		[Purpose],
		[CustAccountGuid],
		--case when SUBSTRING([OpNewContract], 4, 1) = '1' then [CommissionFromCustPercent] else 0 end [CommissionFromCustPercent],
		--case when SUBSTRING([OpNewContract], 4, 1) = '1' then [CommissionFromCustValue] else 0 end as [CommissionFromCustValue],
		--[AcCommissionFromCustGuid],
		--case when SUBSTRING([OpNewContract], 5, 1) = '1' then [CommissionFromOwnerPercent] else 0 end [CommissionFromOwnerPercent],
		--case when SUBSTRING([OpNewContract], 5, 1) = '1' then [CommissionFromOwnerValue] else 0 end [CommissionFromOwnerValue],
		--[AcCommissionFromOwnerGuid],
		--[FlatOwner],
		Cast( 0 as bit) as [ContractFinish],
		Cast( Null as DateTime)  as [ContractFinishDate],
		0 as [ResultingAmount],
		0 as [ResultingAmount2],
		[RoundKind],
		--[FineAccount],
		Cast( 0 as bit) as [CreateResultingEntry],
	
		[RentDuration],
		[Rentype],
		[TermsOfPayment],
		[whereabouts],
		[CountOldContract],
		[CostGuid],
		ExpenceAccountGUID,
		OtherFee,
		
		[BranchGuid]
	From
		[vwServicesContract]
	where
		[Guid] = @Guid Or @Guid = 0x0


GO

SET ANSI_NULLS, QUOTED_IDENTIFIER ON
GO
Create Procedure [PrcStrtoUCS]
(
	@Str Varchar(256) = '',
	@SMSUnicode int = 2
)
 
as
	Declare @R Varchar(8000),
			@T Varchar(256)
	Set @R = ''
	Declare @I int
	
	Set @I = 1
	while @I <= Len(@Str)
	begin
			if @SMSUnicode = 3 
			Set @T = (substring(@str, @I, 1)) 
			else
			begin
					--print '/'+substring(@str, @I, 1)+'/' print ASCII(substring(@str, @I, 1))
 					Set @T = (Select Top 1
 								[UCS] 
 							  From 
 								[ucsTbl2] 
 							  where 
 								(ASCII([Char]) = ASCII(substring(@str, @I, 1)))
 								and ([Unicode] = @SMSUnicode)
 							)
		 			
 					if @T is Null
					Set @T = (substring(@str, @I, 1)) 
			end

		/*---- Set @T = '%'+(Select dbo.IntToHex(ASCII(substring(@str, @I, 1)) ))*/ --
		--Print @R Print substring(@str, @I, 1)
		
		--Set @T = '%'+(Select dbo.IntToHex(ASCII(substring(@str, @I, 1)) ))
		--Print @R Print substring(@str, @I, 1)

		Set @R = @R + @T

		Set @I = @I + 1
	end

	Select @R as [UCS], Len(@R) as [Len]

GO

SET ANSI_NULLS, QUOTED_IDENTIFIER ON
GO

create  proc prcLog
	@txt varchar(8000) = '',  
	@param0 varchar(128) = null,  
	@param1 varchar(128) = null,  
	@param2 varchar(128) = null,  
	@param3 varchar(128) = null,  
	@param4 varchar(128) = null,  
	@param5 varchar(128) = null,  
	@param6 varchar(128) = null, 
	@param7 varchar(128) = null, 
	@param8 varchar(128) = null, 
	@param9 varchar(128) = null 
 
as  
	if @txt = '' 
		set @txt = '<nothing>' 
	else 
		set @txt = dbo.fnFormatString (@txt, @param0, @param1, @param2, @param3, @param4, @param5, @param6, @param7, @param8, @param9) 
	print convert (varchar(128), getdate(), 14) +' [' + db_name() + ']: ' + @txt  
	if left(@txt, 9) = 'START OF:' or left(@txt, 7) = 'END OF:'  
		print '========================================================'  




GO

SET ANSI_NULLS, QUOTED_IDENTIFIER ON
GO

Create Procedure [PrcGetVillaWallet]
(
	@Guid uniqueidentifier = '369CF34D-31AA-4381-BBCA-78E27197A9AA'
)
 
as
	Select 
		'' as [Building],
		[F].[VillaNo] as [Villa],
		[W].[MainCost],
		[Expense],
		[W].[BeginDate],
		[C].[SaleDate],
		DATEDIFF(Day,[W].[BeginDate], [C].[SaleDate]) as [DayCount],
		[C].[SaleValue] * Case when [Wl].[CurrencyGuid] <> [C].[CurrencyGuid] then [C].[CurrencyVal] / [Wl].[CurrencyVal] else 1 end as [SaleValue],
		[C].[SaleValue] * Case when [Wl].[CurrencyGuid] <> [C].[CurrencyGuid] then [C].[CurrencyVal] / [Wl].[CurrencyVal] else 1 end
		-
		( isnull([w].[Expense],0) + [W].[MainCost] )
		as  [Profit],
		0x0 as [BuildingGuid],
		[W].[VillaGuid]
	From 
		[wallet] [Wl]
		inner join [Villawallet] [W] on [W].[ParentGuid] = [Wl].[Guid]
		inner join [vwVilla] [F] on [F].[Guid] = [w].[VillaGuid]
		left join (
					Select 
						[VillaGuid],
						[FromDate] as [SaleDate],
						[Rent] as [SaleValue],
						[CurrencyGuid],
						[CurrencyVal]
					From
						[vwLandContract]  
					where 
						[ContractKind] = 8
					) [C] on [C].[VillaGuid] = [W].[VillaGuid]
	where
		[W].[ParentGuid] = @Guid
	Order By
		[W].[Number]

GO

SET ANSI_NULLS, QUOTED_IDENTIFIER ON
GO
Create Function dbo.[FnVSDEntry] (@CurrencyGuid uniqueidentifier, @CurrencyVal Float)
returns @Tbl Table (
						[Number] int,
						[ParentGuid]  [uniqueidentifier] ,
						[AcGuid] [uniqueidentifier] ,
						[Debit] [Float],
						[Credit] [Float],
						[CurrencyGuid] [uniqueidentifier]  ,
						[CurrencyVal] Float,
						[ObverseAcGuid]  [uniqueidentifier] ,
						[CostGuid] [uniqueidentifier] ,
						[Note] Varchar(256),
						[isvisible] Bit
					)
 
as begin
	if @CurrencyVal = 0
	Set @CurrencyVal = 1
	Insert Into @Tbl
	Select
		[Number],
		[ParentGuid],
		[AcGuid],
		Case 
			when [CurrencyGuid] = @CurrencyGuid then [Debit] 
			else [Debit] * [CurrencyVal] / @CurrencyVal end 
		As [Debit],
		Case 
			when [CurrencyGuid] = @CurrencyGuid then [Credit] 
			else [Credit] * [CurrencyVal] / @CurrencyVal end 
		As [Credit],
		[CurrencyGuid],
		[CurrencyVal],
		[ObverseAcGuid],
		[CostGuid],
		[Note],
		[isvisible]
	From
		[DEntry]
	where
		([IsVisible] = 1 or [CurrencyGuid] = @CurrencyGuid)
	Return
end

GO

SET ANSI_NULLS, QUOTED_IDENTIFIER ON
GO

Create Procedure [prcgetAccountIncinfo]
(
	@Guid uniqueidentifier = 'A8F6012A-9082-4E93-93AD-E760AA08C08D'
)
 
as
	Select Guid into #fnGetAccountParents from fnGetAccountParents(@Guid) A
	
	exec [PrcCreatefnGetAccountList]
	--Select * into #fnGetAccountList from fnGetAccountList (0x0) --where 1 = 2
	
	insert into #fnGetAccountParents
	Select @Guid
	
	Select Top 1
			ac.Guid,
			ac.Code,
			ac.Name,
			L.*
	From
		#fnGetAccountParents A
		inner join [IncAccountDetailAc] dc on dc.[AccountGuid] = a.Guid
		inner join incAccount ac on ac.Guid = dc.ParentGuid
		left join ##fnGetAccountList l on l.Guid = dc.AccountGuid
	where
		dc.Number is Not Null
	order by
		L.[level] desc
	
	

GO

SET ANSI_NULLS, QUOTED_IDENTIFIER ON
GO
Create Procedure dbo.[prcTracedetail]
(
	@Guid uniqueidentifier = '0F8668F1-88DA-4FB8-8A0C-C1DCAA8FF599'
)
 
as
	Select 
		dbo.SC([Caption]) as [Caption],

		case when isnull([Tbl],'') <> '' then (dbo.[FnGetTraceValue] ([Tbl], [New])) 
		else [New]
		end as [new],

		case when isnull([Tbl],'') <> '' then (dbo.[FnGetTraceValue] ([Tbl], [Old])) 
		else [old]
		end as [Old]

	from 
		[Tracedetail]
	where
		ParentGuid = @Guid

GO

SET ANSI_NULLS, QUOTED_IDENTIFIER ON
GO
Create Procedure [PrcDeleteBackupFilesOver]
(
	@DbName varchar(128) = 'AQ',
	@Path varchar(4000) = 'E:\BK'
)
 
as
	Create Table #DT
	(
		Id Int identity(1,1),
		[date] Datetime,
		[name] Varchar(256)
		
	)
	
	insert into #DT
	([date], [name])
	Select distinct
		[Backupset].[backup_finish_date],
		[backupmediafamily].[physical_device_name]
	from
		msdb..Backupset as Backupset
		inner join
		msdb..backupmediafamily as backupmediafamily on backupmediafamily.media_set_id=Backupset.media_set_id
	where 
		DataBase_Name = @DbName
		and [backupmediafamily].[physical_device_name] Like @Path+'%'
	order by 
		backup_finish_date DESC
		
	Declare @BackupCount int
	Set @BackupCount = (Select value from DMD_const where VName = 'BkNum')
		
	
	DECLARE @cursor_Name CURSOR 
	Set @cursor_Name = CURSOR FAST_FORWARD FOR 
	Select 'Del '+Name from #DT where id > @BackupCount Order By Id
	
	Declare @FileName Varchar(256)
	Declare @DF  Varchar(256)
	OPEN @cursor_Name
	FETCH NEXT FROM @cursor_Name INTO @FileName

--	RECONFIGURE WITH OVERRIDE

--	EXEC sp_configure 'show advanced options', 1
--	EXEC sp_configure 'xp_cmdshell', 1
	

	WHILE @@FETCH_STATUS = 0
	BEGIN

		Set @DF = 'Del '+@FileName
		print @FileName
	  exec xp_cmdshell @DF
	  
	delete
		msdb..Backupset
	from
		msdb..Backupset as Backupset 
		inner join
		msdb..backupmediafamily as backupmediafamily on backupmediafamily.media_set_id=Backupset.media_set_id
	where 
		DataBase_Name = @DbName
		and [backupmediafamily].[physical_device_name] = @FileName
	  
	  FETCH NEXT FROM @cursor_Name INTO @FileName
	
	END
	
	CLOSE @cursor_Name
	DEALLOCATE @cursor_Name
	

GO

SET ANSI_NULLS, QUOTED_IDENTIFIER ON
GO
Create View vwTraceDetail
 
as
	Select 
		T.parentGuid,
		[ParentTbl],
		(
			Select 
				Case when (dbo.FnGetLangauge(@@spid) = 1) and (Isnull([A].[enName],'') <> '') then [A].[enName] else [A].[arName] end		
			from 
				[TableDescription] A
			where [TblName] = T.[ParentTbl]
		 ) as [CardName],
		 
		T.Date,
		U.loginName,
		T.HostName,
		dbo.SC([Caption]) as [FieldName],

		case when isnull([Tbl],'') <> '' then (dbo.[FnGetTraceValue] ([Tbl], [New])) 
		else [New]
		end as [new],

		case when isnull([Tbl],'') <> '' then (dbo.[FnGetTraceValue] ([Tbl], [Old])) 
		else [old]
		end as [Old],
		T.UserGuid
	from 
		[Trace] T
		inner join [Realty_Users] U on U.Guid = T.UserGuid		
		inner join [TraceDetail] D on d.ParentGuid = T.Guid

GO

SET ANSI_NULLS, QUOTED_IDENTIFIER ON
GO

Create Procedure [PrcAllCustomer]
(
	@CardKind int = 2,
	@CustKind int = 6,
	@Name Varchar(256) = '',
	@LtnName Varchar(256) = '',
	@Nationality Varchar(256) = '',
	@Security Varchar(256) = '',
	@Profession Varchar(256) = '',
	@Adjective Varchar(256) = '',
	@Address Varchar(256) = '',
	@Ban Int = 1,
	@ActiveDate Bit = 0,
	@Datewith int = 0,
	@Date1 DateTime = '2009-7-1',
	@Date2 DateTime = '2022-1-2'

)
 
as
	Select 
		* ,
		arName as [NewName],
		Case when isnull([Ban],0) = 0 then dbo.SC('') else dbo.SC('') end As [BanStr]
	From 
		[vwCustomer]
	where
		([CardKind] = @CardKind or @CardKind = 2)
		and ([CustKind] = @CustKind or @CustKind = 6)
 		and ([ArName] Like '%'+@Name+'%')
 		and ([LtnName] like '%'+@LtnName+'%')
 		and ([Nationality] = @Nationality or @Nationality = '')
 		and ([Security] = @Security or @Security = '')
 		and ([Profession] = @Profession or @Profession = '')
 		and ([Adjective] = @Adjective or @Adjective = '')
 		and ([Address] like '%'+@Address+'%' )
		and (IsNull([Ban],0) = @Ban  or @Ban = 2)
		and (
			 ([PassportExpireDate] Between @Date1 And @Date2 and @Datewith = 0)	
			 or ([DomicileEndDate] Between @Date1 And @Date2 and @Datewith = 1)	
			 or ([PersonalityEndDate] Between @Date1 And @Date2 and @Datewith = 2)	
			 or @ActiveDate = 0
			)
	Order By
		Number,[Name]
	

GO

SET ANSI_NULLS, QUOTED_IDENTIFIER ON
GO

Create Procedure [PrcInsertSC] (@ArStr Varchar(256))
 
AS
	Declare @R Varchar(256)
    Select Top 1 @R = [En] from [StrSource] where [Ar]=@ArStr
	
	if @R is null 
    insert into [StrSource]
    ([Ar],[En])
    Select @ArStr, @ArStr


GO

SET ANSI_NULLS, QUOTED_IDENTIFIER ON
GO
Create Procedure [CreateChildAccount]
(
	@ChildAccountGuid uniqueidentifier = 0x0,
	@ParentGuid uniqueidentifier = '{7F6A6D1D-D505-46E1-A6DD-A62E53990A26}',
	@Name Varchar(256) = 'fkhx',
	@LtnName Varchar(256) = ''
)
 
as
	Set NoCount On
	EXEC PrcInsertSC '  '
	Declare @Ms Varchar(256)
	Set @Ms = dbo.SC('  ')

	if exists(Select Top 1 * from Account 
	where [Name] = @Name and [ParentGuid] = @ParentGuid)
	begin
		RAISERROR (@Ms, 16, 1)
	end

	DECLARE @Code Varchar(256)
			,@NewCode  Varchar(256)
			,@CurrencyGUID uniqueidentifier
			,@CurrencyVal Float
			,@Type int
			,@FinalGUID uniqueidentifier
			,@NSons Int

	if @ChildAccountGuid = 0x0
	Set @ChildAccountGuid = Newid()

	--   		
	Select 
		@Code = [Code]				
		,@CurrencyGUID = [CurrencyGUID]
		,@CurrencyVal = [CurrencyVal]
		,@Type = [Type]
		,@FinalGUID = [FinalGUID]
		,@NSons = [NSons]
	from 
		[vwAccount] where [Guid] = @ParentGuid


	--  
	Create Table #Code_Ac
	(Code varchar(255))
	insert into #Code_Ac
	exec PrcCalcMaxAccountcode @ParentGuid
	
	Select @NewCode = Code from #Code_Ac
	
	------
	insert into [Account]
	([Number],[Guid],[Name],[LtnName],[Code],[CDate],[NSons],[Note],[CurrencyGUID],[CurrencyVal],[Type],[ParentGUID],[FinalGUID])
	Select
	(Select isnull(Max([Number]),0)+ 1 from [Account]) as [Number]
	,@ChildAccountGuid as [Guid]
	,@Name as [Name]
	,@LtnName as [LtnName]
	,@NewCode-- + dbo.FnFormatNumber (@Count, 4) as [Code]
	,GetDate() as [CDate]
	,0 as [NSons]
	,'' as [Note]
	,@CurrencyGUID as [CurrencyGUID]
	,@CurrencyVal as [CurrencyVal]
	,@Type as [Type]
	,@ParentGuid as [ParentGUID]
	,@FinalGUID as [FinalGUID]
  
	
	insert into [MovingAccount]
	Select
		@ChildAccountGuid
	
	Select * from Account where [Guid] = @ChildAccountGuid	

GO

SET ANSI_NULLS, QUOTED_IDENTIFIER ON
GO
Create View vwMaintenanceContractVisit
 
as
	Select
		v.[Number],v.[Guid],v.[SecLvl],
		iSNull(v.[ContractGuid],0x0) as [ContractGuid],
		CustGuid,
		FeeAccountGuid,
		[CreateEntry],
		[EntryNote],
		[CurrencyGuid],
		[CurrencyVal],
		[EntryDebitCostGuid],
		[EntryCreditCostGuid],
		v.[No],v.[Date],v.[ExecState],v.[ExecDate],v.[ExecNote],v.[NotExecNote],
		v.[Note],v.[WorkNote],v.[WithOutContract],
		Case 
			when (execState = 1) then dbo.SC(' ')
			when (Date > GetDate()) and (execState = 2) then dbo.SC('  ')
			when (Date <= GetDate()) and (execState = 2) then dbo.SC('   ')
			when (execState = 0) then dbo.SC('  ')
			else dbo.SC(' ')
		end
		as [visitState],
		Case 
			when (execState = 1) then 0
			when (Date > GetDate()) and (execState = 2) then 1
			when (Date <= GetDate()) and (execState = 2) then 2
			when (execState = 0) then 3
			else 4
		end
		as [visitStateId]
	From
		[vbMaintenanceContractVisit] [V]
		

GO

SET ANSI_NULLS, QUOTED_IDENTIFIER ON
GO

Create Procedure [PrcAllChecksCollectionCancel]
(
	@Kind int = 3,
	@ForTest Bit = 1,
	@FixDate DateTime = '1/1/2010'
)
 
as
	Exec PrcInsertSC '  '
	Exec PrcInsertSC '  '
	Exec PrcInsertSC '  '
	Exec PrcInsertSC '  '
	Exec PrcInsertSC '  '
	Exec PrcInsertSC '  '

	Create Table #R
	(
		[CheckNo] Varchar(256),
		[State] Varchar(256),
		[Guid] uniqueidentifier
	)


	Declare @CheckGuid uniqueidentifier
	

	DECLARE cursor_Name CURSOR FAST_FORWARD FOR 
	Select [Guid] From [Resource]
	where [Kind] = 8
		and [Spid] = @@Spid
	
	OPEN cursor_Name
	FETCH NEXT FROM cursor_Name INTO @CheckGuid

	Declare @Continue Bit,
			@Post Bit,
			@collecte bit,
			@Endor bit,
			@Return Bit,
			@Posted int,
			@collected int,
			@Endorsement int,
			@Returned int,
			@No Varchar(256),
			@CheckKind int,
			@OperationDate Datetime

	WHILE @@FETCH_STATUS = 0
	BEGIN

		Select 
			@No = [C].[No]
		From 
			[Checks] [C] 
		where 
			[C].[Guid] = @CheckGuid

		-- 
		Select
			@OperationDate = [Date]
		from
			ChecksCollection
		where
			[CheckGuid] = @CheckGuid

		if @OperationDate < @FixDate 
		begin
			insert into #R
			Select @No, dbo.SC('     '), @CheckGuid
			
			FETCH NEXT FROM cursor_Name INTO @CheckGuid
			CONTINUE 				
		end 

		--   
		Select
			@Posted = Sum(Case when Kind = 0 then 1 else 0 end ),
			@collected = Sum(Case when Kind = 1 then 1 else 0 end ),
			@Endorsement = Sum(Case when Kind = 2 then 1 else 0 end ),
			@Returned = Sum(Case when Kind = 3 then 1 else 0 end )
		from
			ChecksCollection
		where
		[CheckGuid] = @CheckGuid

		Select @Posted 		= isnull(@Posted,0)
		Select @collected 	= isnull(@collected,0)
		Select @Endorsement = isnull(@Endorsement,0)
		Select @Returned 	= isnull(@Returned,0)

		--  
		if (@Kind = 0) 
		begin
			-- 
			if (@Posted <= 0)
			begin
				insert into #R
				Select @No, dbo.SC('  ')
				,@CheckGuid
				
				FETCH NEXT FROM cursor_Name INTO @CheckGuid
				CONTINUE 				
			end
			
	
		end		
		
		--  
		if (@Kind = 1) 
		begin
			-- 
			if (@collected = 0)
			begin
				insert into #R
				Select @No, dbo.SC('  ')
				, @CheckGuid
				
				FETCH NEXT FROM cursor_Name INTO @CheckGuid
				CONTINUE 				
			end
		end		
		
		--  
		if (@Kind = 2) 
		begin
			-- 
			if (@Endorsement = 0)
			begin
				insert into #R
				Select @No, dbo.SC('  ')
				, @CheckGuid
				
				FETCH NEXT FROM cursor_Name INTO @CheckGuid
				CONTINUE 				
			end

		end

		--  
		if (@Kind = 3) 
		begin
			-- 
			if (@Returned = 0)
			begin
				insert into #R
				Select @No, dbo.SC('  ') 
				, @CheckGuid
				
				FETCH NEXT FROM cursor_Name INTO @CheckGuid
				CONTINUE 				
			end

		end

		-- 
		if @ForTest = 0
		begin
				Exec [DeleteChecksCollection] @CheckGuid ,@Kind 
		
				insert into #R
				Select @No, dbo.SC('  ') , @CheckGuid
		end
		if @ForTest = 1
			insert into #R
			Select @No, dbo.SC('  ') , @CheckGuid
	
	 	FETCH NEXT FROM cursor_Name INTO @CheckGuid
	
	END
	
	CLOSE cursor_Name
	DEALLOCATE cursor_Name

	Select * from #R	
	Order By [CheckNo]
		


GO

SET ANSI_NULLS, QUOTED_IDENTIFIER ON
GO

CREATE FUNCTION [dbo].[fnGetAccountParents](@StartGUID [UNIQUEIDENTIFIER]) 
	RETURNS @Result TABLE([GUID] [UNIQUEIDENTIFIER]) 
 
AS 
BEGIN 

	DECLARE @ParentGUID [UNIQUEIDENTIFIER] 
	SELECT @ParentGUID = [ParentGUID] FROM [Account] WHERE [GUID] = @StartGUID 
	WHILE @@ROWCOUNT <> 0 
	BEGIN 
		IF EXISTS(SELECT * FROM @Result WHERE [GUID] = @ParentGUID) 
			BREAK 
		INSERT INTO @Result VALUES(@ParentGUID) 
		SELECT @ParentGUID = [ParentGUID] FROM [Account] WHERE [GUID] = @ParentGUID 
	END 
	RETURN 
END 


GO

SET ANSI_NULLS, QUOTED_IDENTIFIER ON
GO

CREATE PROCEDURE [dbo].[PRC__GetJobSchedule] 
	@jobName [varchar](256) =  ''
 
AS  
SELECT  
	[sj].[name] [JobName],
--	CAST( [sjs].[freq_type] AS [VARCHAR](10)) AS [type],  
--	CAST( [sjs].[freq_interval] AS [VARCHAR](10)) AS [Interval],  
--	CAST( [sjs].[active_start_date] AS [VARCHAR](10)) AS [SDate],  
--	CAST( [sjs].[active_start_time] AS [VARCHAR](10)) AS [STime], 
	CAST( [js].[last_run_date] AS [VARCHAR](10)) AS [RunDate],  
	CAST( [js].[last_run_time] AS [VARCHAR](10)) AS [RunTime], 
	CAST( [js].[last_run_outcome] AS [VARCHAR](10)) AS [RunStat],  
	CAST( [sj].[enabled] AS [VARCHAR](10)) AS [Enable]
FROM  
	[msdb].[dbo].[sysjobschedules] AS [sjs] INNER JOIN [msdb].[dbo].[sysjobs] AS [sj]  
	ON [sjs].[job_id] = [sj].[job_id] INNER JOIN [msdb].[dbo].[sysjobservers] AS [js] 
	ON [sjs].[job_id] = [js].[job_id]  
WHERE  
		([sj].[name] = @jobName or @jobName = '')  


GO

SET ANSI_NULLS, QUOTED_IDENTIFIER ON
GO

Create Procedure [PrcCreateEntryTypeReceiptOrder]
(
	@Guid uniqueidentifier = '019E0F87-6AA6-48EC-B267-703A0937E8AA'
)
 
as
	Declare @RowGuid uniqueidentifier


	Delete
		[Secondary_Entry] 
	from
		[Secondary_Entry] S
		inner join ReceiptOrderDetail D on D.Guid = S.Guid
	where
		D.[ParentGuid] = @Guid
		
	Declare @I int, @C int
	Set @I = 1
	Select @C = COUNT(*) From ReceiptOrderDetail where parentGuid = @Guid
	while @I <= @C
	begin
		Set @RowGuid = 0x0
		
		Select
			@RowGuid = D.Guid		
		From
			ReceiptOrder O
			inner join ReceiptOrderDetail D on D.parentGuid = O.Guid
		where
			O.Guid = @Guid
			and D.Number = @I
			and IsReceipt = 1
			
		--Print @RowGuid return
		if ISNULL( @RowGuid,0x0) <> 0x0 
		exec PrcCreateEntryTypeReceiptOrderRow @RowGuid
		
		Set @I = @I + 1
	end

GO

SET ANSI_NULLS, QUOTED_IDENTIFIER ON
GO

Create Procedure [PrcRecodeAccount]
(
	@AcGuid uniqueidentifier = 'A3C61FE5-D1D6-4B8F-A5AC-C83D9A461318'
)
 
as
	Set NoCount on
	Declare @AcCount int
	Select 
		@AcCount = Count(*)
	From 
		[Account]
	where
		[ParentGuid] = @AcGuid

	Set @AcCount = Len(Cast(@AcCount as Varchar(25)))

	Declare @Code Varchar(256)
	Select 
		@Code = Code
	From 
		[Account]
	where
		[Guid] = @AcGuid

	Create Table #R
	(
		[Id] int identity(1,1),
		[Guid] uniqueidentifier 
	)
	
	insert into #R
		([Guid])
	Select 
		[Guid]
	From
		[Account]
	where
		[ParentGuid] = @AcGuid
	Order By
		[Number]

-- 
-- 	Select 
--  		[R].*,
--  		@Code+ dbo.FnFormatNumber([id], @AcCount) as Newcode,
--  		[Ac].*
-- 	from 
-- 		[Account] [Ac] 
-- 		inner join #R R on @Code+ dbo.FnFormatNumber([R].[id], @AcCount) = [Ac].[Code] and [R].[Guid] <> [Ac].[Guid]
-- 	where
-- 		[Ac].[ParentGuid] <> @AcGuid
	
	--    
	Declare @C Int
	Select 
		@C = Count(*)
-- 		[R].*,
-- 		@Code+ dbo.FnFormatNumber([id], @AcCount) as Newcode,
-- 		[Ac].*
	from 
		[Account] [Ac] 
		inner join #R R on @Code+ dbo.FnFormatNumber([R].[id], @AcCount) = [Ac].[Code] and [R].[Guid] <> [Ac].[Guid]
	where
		[Ac].[ParentGuid] <> @AcGuid

	if isnull(@C,0) > 0
	begin
		Declare @AcR Varchar(256)
		Declare @Msgerror Varchar(256)
	
		Select Top 1 
			@AcR = [Ac].[Code]+'-'+[Ac].[Name]
		from 
			[Account] [Ac] 
			inner join #R R on @Code+ dbo.FnFormatNumber([R].[id], @AcCount) = [Ac].[Code] and [R].[Guid] <> [Ac].[Guid]
		where
			[Ac].[ParentGuid] <> @AcGuid

		Set @Msgerror = '           ' + @AcR
		RAISERROR (@Msgerror, 16, 1)
	end

	update 
		Account
	Set 
		[Code] = @Code+ dbo.FnFormatNumber([id], @AcCount)
	From
		Account [Ac]
		inner join [#R] On [#R].[Guid] = [Ac].[Guid]


	

GO

SET ANSI_NULLS, QUOTED_IDENTIFIER ON
GO

Create view [vwCustomer]

as
	SELECT
		Cu.[CardKind],
		Cu.[Number], 
		Cu.[Guid],
		Cu.[Barcode],
		Cu.[Name] as [ArName],
		Cu.[LtnName],
		Case when (dbo.FnGetLangauge(@@spid) = 1) and (Isnull(Cu.[LtnName],'') <> '') then Cu.[LtnName] else Cu.[Name] end as [Name],  
		Cu.[Nationality], 
		Cu.[Profession], 
		Cu.[PassportNO], 
		Cu.[Domicile], 
		Cu.[Security], 
		Cu.[LtnSecurity],
		Cu.[MemoSecurity],
		Cu.[LtnMemoSecurity],
		Cu.[PhoneJob], 
		Cu.[Mobile], 
		Cu.[Note], 
		Cu.[AcGuid],
		Cu.[Address],
		Cu.[LtnAddress],
		Cu.[BoxNo],
		Cu.[InsuranceAccountGuid],
		Cu.[PersonalityNo1],
		Cu.[PersonalityNo2],
		Cu.[Adjective],
		Cu.[LtnAdjective],
		Cu.[Fax],
		Cu.[EMail],
		Cu.[Ban],
		Cu.[PassportExpireDate],
		Cu.[BankName],
		Cu.[BankAccCode],
		Cu.[Trademark],
		Cu.[LtnTrademark],
		Cu.[CardKind2],
		Case when Cu.CardKind2 = 1 then DBO.SC('') else DBO.SC('') end as [CardKind2_Str],
		CustKind,
		Case 
			when CustKind = 0 then dbo.sc('')
			when CustKind = 1 then dbo.sc('')
			when CustKind = 2 then dbo.sc('')
			when CustKind = 3 then dbo.sc('')
			when CustKind = 4 then dbo.sc('')
			when CustKind = 5 then dbo.sc(' ')
		end as CustKindStr,
		
		Cu.[Birthday],
		Cu.[DomicileEndDate],
		Cu.LtnNationality,
		Cu.LtnProfession,
		Cu.[PersonalityEndDate],
		Ac.Balance as AccountBalance,
		Cu.[banContract],
		Cu.CkHideInSearch,
		Cu.CustNote1,
		Cu.CustNote2,
		Cu.CustNote3,
		Cu.CustNote4,
		Cu.CustNote5,
		Cu.CustNote6,
		Cu.CustNote7
	FROM 
		[vbCustomer] Cu
		left join vwAccount Ac on Ac.Guid = Cu.AcGuid
		

GO

SET ANSI_NULLS, QUOTED_IDENTIFIER ON
GO

Create view [vwShowCustomer]
 
as
	SELECT 
		[Number], 
		[Guid], 
		[Name] as [ArName],
		[LtnName], 
		Case when (dbo.FnGetLangauge(@@spid) = 1) and (Isnull([LtnName],'') <> '') then [LtnName] else [Name] end as [Name],  
		[Nationality], 
		[Profession], 
		[PassportNO], 
		[Domicile], 
		[Security], 
		[PhoneJob], 
		[Mobile], 
		[Note], 
		[AcGuid],
		[InsuranceAccountGuid]
	FROM 
		[Customer]
	where
		[CkHideInSearch] = 0

GO

SET ANSI_NULLS, QUOTED_IDENTIFIER ON
GO

Create Procedure [PrcReCreateMaintenanceContract]
(
	@Date1 DateTime = 0,
	@Date2 DateTime = 0,
	@ActiveDate bit = 0,
	@Datewith int = 0,
	@Num1 int = 0,
	@Num2 int = 0,
	@ActiveNum bit = 0
)
 
as
	Set noCount on

	--Update [Resource] set spid = @@spid
	 
	exec PrcSetProgrss '', 100, 0
	
	Declare @Guid uniqueidentifier,
			@CreateEntry Bit
	Declare @RowCount int

	Declare @AllCount int	
	Select 
		L.[Guid],
		Case when T.[CreateEntry]  = 1 and L.CreateContractEntry = 1 then 1 else 0 end as [CreateEntry]
		into #TmpContract
	From 
		[MaintenanceContract] L
		inner join [MaintenanceContractType] T on T.Guid = L.TypeGuid
		inner join [Resource] R on R.Guid = L.TypeGuid and R.Spid = @@SPID
	where
		(ISNULL(IsRounded, 0) = 0)
		and ((L.number between @num1 and @Num2) or @ActiveNum = 0)
		and (
			(
				([L].[FromDate] between @Date1 and @Date2 and @Datewith = 0)
			)
			or
			(
				([L].[ToDate] between @Date1 and @Date2 and @Datewith = 1)
			)

			or
			(
				([L].[ContractFinishDate] between @Date1 and @Date2 and @Datewith = 2)
				and ([L].[ContractFinish] = 1)
			)

			or
			(
				([L].[EditDate] between @Date1 and @Date2 and @Datewith = 3)
			)
			or
			(
				([L].[AcquittancePrintdate] between @Date1 and @Date2 and @Datewith = 4)
			)

			or @ActiveDate = 0
		) 
		
	Set @AllCount = @@ROWCOUNT 
	
	Declare @Msg varchar(255)
	Set @Msg = dbo.SC('    ') +' '+'0 / '+Cast(@AllCount as Varchar(25))
	exec PrcSetProgrss @Msg, @AllCount, 0
	--Select * from #TmpContract
	
	Declare @Counter int
	Set @Counter = 0
	DECLARE cursor_Name CURSOR FAST_FORWARD FOR 
	Select * from #TmpContract
	Set @RowCount = 0
	
	OPEN cursor_Name
	FETCH NEXT FROM cursor_Name INTO @Guid, @CreateEntry
	
	WHILE @@FETCH_STATUS = 0
	BEGIN
		Set @Counter = @Counter + 1
		Set @Msg = dbo.SC('    ') +' '+Cast(@Counter as Varchar(25)) +' / '+Cast(@AllCount as Varchar(25))
		exec PrcSetProgrss @Msg, @AllCount, @Counter

		if @CreateEntry = 1
		begin
			
			exec PrcCreateMaintenanceContractEntry @Guid
			Set @RowCount = @RowCount + 1			
		end
		else
		begin
			Delete HEntry where Guid = @Guid 
			Set @RowCount = @RowCount + 1
		end
		
	  FETCH NEXT FROM cursor_Name INTO @Guid, @CreateEntry
	
	END
	
	CLOSE cursor_Name
	DEALLOCATE cursor_Name

	Set @Msg = dbo.SC('')
	exec PrcSetProgrss @Msg, 0, 0
		
	if dbo.fnInRoundProcess() = 0		
	Select @RowCount as [RowCount]
		

GO

SET ANSI_NULLS, QUOTED_IDENTIFIER ON
GO
Create View [vwLastFlatSalesPrice2]
 
as
	Select 
		[C].[ParentGuid],
		[Price] as [Sale],
		[CurrencyGuid] as [SaleCurrencyGuid]
	From
		[ChangeFlatPrice] [C]
		inner join (
						Select 
								[ParentGuid],
								Max(Date) as [MaxDate],
								Max([Number]) as [MaxNumber]
						From
							[ChangeFlatPrice]
						where
							[Kind] = 2
						Group By
							[ParentGuid]
					) [C2] on [C2].[ParentGuid] = [C].[ParentGuid] 
							and [C].[Date] = [C2].[MaxDate] 
							and (Case when [C].[Date] = [C2].[MaxDate] then [MaxNumber] else [C].[Number] end = [C].[Number])
	where
		[Kind] = 2
							

GO

SET ANSI_NULLS, QUOTED_IDENTIFIER ON
GO
Create View [vwBuildingRecElecCounter]
 
as
	Select
		E.*,
		[Counter] - oldCounter as Qty,
		b.Name as Building,
		U.LoginName as userName
	From
		[BuildingRecElecCounter] [E]
		inner join Building [b] on [b].Guid = [E].[BuildingGuid]
		inner join Realty_Users [U] on [U].Guid = [E].[UserGuid]

GO

SET ANSI_NULLS, QUOTED_IDENTIFIER ON
GO

Create Procedure [PrcPrintChecksPartialCollection]
(
	@Guid uniqueidentifier = 0x0,
	@Only Varchar(256) = '',
	@OnlyAr Varchar(256) = '',
	@OnlyEn Varchar(256) = ''
)
 
as

	Select Top 1 
		C.Guid as CardGuid,
		T.Name as [EntryTypeName],
		T.ltnName as [EntryTypeLtnName],
		S.Number as EntryNumber,
		H.Number as MainEntryNumber
	into #LinkEntryType_Checks
	From 
		[Secondary_Entry] S 
		left join HEntry H on H.Guid = S.Guid
		inner join ChecksPartialCollection C on C.SecEntryGuid = S.Guid
		inner join [EntryType] T on T.Guid = S.TypeGuid
	where
		C.Guid = @Guid

	insert into #LinkEntryType_Checks	
	Select Distinct
		L.CheckGuid,
		dbo.SC(' '),
		dbo.SC(' ') as [EntryTypeLtnName],
		H.Number as EntryNumber,
		H.Number as MainEntryNumber	
	From
		ChecksPartialCollection L
		inner join HEntry H on H.Guid = L.Guid
	where
		L.CheckGuid = @Guid

	Select 
			[T].[Code] as [TypeCode],
			[T].[Code]+CAST(P.Number as Varchar(256)) as [TypeCode_Number],
			[T].[Code]+CAST(C.Number as Varchar(256)) as [Check_TypeCode_Number],
			[P].[Number],
			[C].[No] as [CheckNo],
			[C].[DueDate] as [CheckDueDate],
			[BuildingName],
			[BuildingArName],
			[BuildingLtnName],
			[C1].[Code] as [DebitAccountCode],
			[C1].[ArName] as [DebitAccountArName],
			[C1].[LtnName] as [DebitAccountLtnName],
			[C2].[Code] as [CreditAccountCode],
			[C2].[ArName] as [CreditAccountArName],
			[C2].[LtnName] as [CreditAccountLtnName],
			[C].[AccountName],
			[C].ObverseAccountName,
			[M].[Code] as [CurrencyArCode],
			[M].[LtnCode] as [CurrencyltnCode],
			[M].[ArName] as [CurrencyArName],
			[M].[LtnName] as [CurrencyltnName],
			@Only as [Only],
			@OnlyAr as [OnlyAr],
			@OnlyEn as [OnlyEn],
			[FlatNo],
			[ContractNo],
			[L].[Rent] as [ContractValue],
			[P].[Date] as [CollectionDate],
			[P].[Value] as [CollectionValue],
			[C].[Value] as [CheckValue],
			[P2].[Value] as [OldCollectionValue],
			[C].[Value] - isnull([P2].[Value],0) - [P].[Value] as [RestCollectionValue],
			[P].[Note] as [CollectionNote],
			[P].[Commission],
			Case when [p].[Value] <> 0 then ([Commission] * 100) / [p].[Value] end as [CommissionPercent],
			[C3].[ArName] as [DebitCommissionAccountArName],
			[C3].[LtnName] as [DebitCommissionAccountLtnName],
			[C4].[ArName] as [CreditCommissionAccountArName],
			[C4].[LtnName] as [CreditCommissionAccountLtnName],
			[Emirate],
			[L].[BuildingArea],
			[Suburb],
			[Street],
			[BasinNo],
			[PieceNo],
			[BuildingNo],
			[BondType],
			[BondNo],
			[L].[FlatKind],
			[L].[ApartmentType],
			[Class],
			[FlatArea],
			[FlatAreaunity],
			[C].[beneficiary],
			[C].[BankName],
			L.FromDate as [ContractFromDate],
			L.ToDate as [ContractToDate],
			L.DiscountValue as [ContractDiscountValue],
			[L].RentAfterDiscount as [ContractValueAfterDiscount],
			
			Lk.*
	From 
		[ChecksPartialCollection] [P]
		inner join [vwChecks] [C] on [C].[Guid] = [P].[CheckGuid]
		inner join CheckType T on T.Guid = C.TypeGuid
		left join [vwLeaseApartment] [L] on [C].[ContractGuid] = [L].[Guid]
		inner join [vwaccount] [C1] on [C1].[Guid] = [P].[DebitAccountGuid]
		inner join [vwaccount] [C2] on [C2].[Guid] = [P].[CreditAccountGuid]
		inner join [vwCurrency] [M] on [M].[Guid] = [P].[CurrencyGuid]
		left join (
					Select 
						[PP].[CheckGuid],
						Sum([Value]) as [Value]
					From
						[ChecksPartialCollection] [PP]
					where
						[PP].[Guid] <> @Guid
					Group By
						[PP].[CheckGuid]
					) [P2] on [P2].[CheckGuid] = [P].[CheckGuid]
		left join [vwaccount] [C3] on [C3].[Guid] = [P].[CommAccountGuid]
		left join [vwaccount] [C4] on [C4].[Guid] = [P].[CommAccountCreditGuid]
		left join #LinkEntryType_Checks LK on Lk.CardGuid = P.Guid		
	where
		[P].[Guid] = @Guid

GO

SET ANSI_NULLS, QUOTED_IDENTIFIER ON
GO
Create View [vwLastFlatRentPrice]
 
as
	Select 
		[C].[ParentGuid],
		[Price] as [Rent],
		[CurrencyGuid] as [RentCurrencyGuid]
	From
		[ChangeFlatRent] [C]
		inner join (
						Select 
								[ParentGuid],
								Max(Date) as [MaxDate],
								Max([Number]) as [MaxNumber]
						From
							[ChangeFlatRent]
						Group By
							[ParentGuid]
					) [C2] on [C2].[ParentGuid] = [C].[ParentGuid] 
							and [C].[Date] = [C2].[MaxDate] 
							and (Case when [C].[Date] = [C2].[MaxDate] then [MaxNumber] else [C].[Number] end = [C].[Number])

GO

SET ANSI_NULLS, QUOTED_IDENTIFIER ON
GO
Create View [vwOrderType]
 
as
	Select
		[A].[Name] as [ArName],
		Case when (dbo.FnGetLangauge(@@spid) = 1) and (Isnull([A].[LtnName],'') <> '') then [A].[LtnName] else [A].[Name] end as [Name], 
		Case when (dbo.FnGetLangauge(@@spid) = 1) and (Isnull([A].[LtnMenu],'') <> '') then [A].[LtnMenu] else [A].[Menu] end as [Menu], 
		[A].[Number], 		[A].[Guid], 		[A].[ShortCut], 		[A].[DefStoreGuid], 		[A].[DefCostGuid], 		[A].[BillTypeGuid], 		[A].[CurrencyGuid], 		[A].[CurrencyVal], 		[A].[ChangeBillType], 		[A].[ChangeCurrency], 		[A].[CheckStore], 		[A].[CheckStoreRecipient], 		[A].[RestraintMat], 		[A].[Note], 		[A].[DefUnity]
	From
		[vbOrderType] [A]

GO

SET ANSI_NULLS, QUOTED_IDENTIFIER ON
GO

Create Procedure [SetLangauge]
(
	@Lang  int = 0
) 
 
as
	Delete [TblLangauge]
	where 
		Spid = @@Spid
	
	Insert Into [TblLangauge]
	(
		Spid,
		Lang
	)
	Select
		@@Spid
		,@Lang	


GO

SET ANSI_NULLS, QUOTED_IDENTIFIER ON
GO

Create Procedure [dbo].[PrcMarkCheckFromParkingContract]
(
	@Guid uniqueidentifier = '4A098C65-3D29-42E6-91AF-5BE1BC75D64C',
	@Mark bit = 1
)
 
as
	update
		[Checks] 
	Set
		Mark = @Mark
	from
		[Checks] [C]
	where
		[C].[ContractGuid] = @Guid 

GO

SET ANSI_NULLS, QUOTED_IDENTIFIER ON
GO

Create Procedure [PrcCheckReNote]
(
	@ReNoteAll Bit = 0
)
 
as

	Declare @Guid uniqueidentifier,
			@NoteForm1 Varchar(256),
			@NoteForm2 Varchar(256),
			@AccountName Varchar(256),
			@ObverseAccountName Varchar(256),
			@Value Float,
			@CurrencyName Varchar(256),
			@No Varchar(256),
			@BankName Varchar(256),
			@DueDate datetime,
			@Note1 Varchar(256),
			@Note2 Varchar(256)

	DECLARE cursor_Name CURSOR FAST_FORWARD FOR 
	Select 
		[S].[Guid],
		[S].[Note],
		[S].[Note2]
	From
		[Checks] [S]
		inner join [Resource] [C] on [C].[Guid] = [S].[Guid] and [C].[Kind] = 8 --and [spid] = @@Spid
	
	OPEN cursor_Name
	FETCH NEXT FROM cursor_Name INTO @Guid, @Note1, @Note2
	
	WHILE @@FETCH_STATUS = 0
	BEGIN
		Select 
			@NoteForm1 = [T].[NoteForm1],
			@NoteForm2 = [T].[NoteForm2],
			@AccountName = [C].[AccountName],
			@ObverseAccountName = [C].[ObverseAccountName],
			@Value = [C].[Value],
			@CurrencyName = [C].[CurrencyName],
			@No = [C].[No],
			@BankName = [C].[BankName],
			@DueDate = [C].[DueDate],
			@Note1 = [C].[Note],
			@Note2 = [C].[Note2]
		From		
			[CheckType] [T]
			inner join [vwChecks] [C] on [C].[TypeGuid] = [T].[Guid]
		where
			[C].[Guid] = @Guid

				
        Set @NoteForm1 = replace(@NoteForm1, '[A]', @AccountName)
        Set @NoteForm1 = replace(@NoteForm1, '[B]', @ObverseAccountName)
        Set @NoteForm1 = replace(@NoteForm1, '[C]', Cast(@Value as varchar(256)) + ' '+@CurrencyName)
        Set @NoteForm1 = replace(@NoteForm1, '[D]', @BankName)
        Set @NoteForm1 = replace(@NoteForm1, '[E]', @No)
        Set @NoteForm1 = replace(@NoteForm1, '[F]', Cast(DatePart(Day, @DueDate) as varchar(256))  +'-'+
													Cast(DatePart(Month, @DueDate) as varchar(256))  +'-'+
													Cast(DatePart(Year, @DueDate) as varchar(256)) )

		update [Checks]
		Set
			[Note] = @NoteForm1
		where
			[Guid] = @Guid
			and ([Note] = '' or @ReNoteAll = 1)

        Set @NoteForm2 = replace(@NoteForm2, '[A]', @AccountName)
        Set @NoteForm2 = replace(@NoteForm2, '[B]', @ObverseAccountName)
        Set @NoteForm2 = replace(@NoteForm2, '[C]', Cast(@Value as varchar(256)) + ' '+@CurrencyName)
        Set @NoteForm2 = replace(@NoteForm2, '[D]', @BankName)
        Set @NoteForm2 = replace(@NoteForm2, '[E]', @No)
        Set @NoteForm2 = replace(@NoteForm2, '[F]', Cast(DatePart(Day, @DueDate) as varchar(256))  +'-'+
													Cast(DatePart(Month, @DueDate) as varchar(256))  +'-'+
													Cast(DatePart(Year, @DueDate) as varchar(256)) )

		update [Checks]
		Set
			[Note2] = @NoteForm2
		where
			[Guid] = @Guid
			and ([Note2] = '' or @ReNoteAll = 1)

--		Select @NoteForm1, @NoteForm2

		FETCH NEXT FROM cursor_Name INTO @Guid, @Note1, @Note2
	END
	
	CLOSE cursor_Name
	DEALLOCATE cursor_Name

GO

SET ANSI_NULLS, QUOTED_IDENTIFIER ON
GO

Create View vwShopAll
 
as

	Select
		[A].[Number], 
		[A].[Guid], 
		[A].[SecLvl], 
		[A].[BuildingGuid], 
		[A].[Area], 
		[A].[Unity], 
		[A].[CostPrice], 
		[A].[CostCurrencyGUID], 
		[A].[Rent], 
		[A].[RentCurrencyGUID], 
		[A].[Sale], 
		[A].[SaleCurrencyGUID], 
		[A].[Note], 
		[A].[CostGuid], 
		[A].[FlatOwner], 
		[A].[CustGuid], 
		[A].[Details], 
		[A].[OfferState], 
		[A].[OfferType], 
		[A].[Restrained], 
		[A].[RestrainedUserGuid], 
		[A].[ShopKind], 
		[A].[Description], 
		[A].[WaterCounter], 
		[A].[ElectricityCounter], 
		[A].[Overlooking], 
		[A].[Judicial],
		[A].[Class],
		Case when [A].[Judicial] = 1 then dbo.SC('') else dbo.SC('') end as [Str_Judicial],
		[A].[LtnShopKind],
		[A].[LtnDescription] ,
		[A].[LtnOverlooking] ,
		[B].[BuildingCode]+[A].[NO] as [NO],
		[B].[Name] as [BuildingName],
		[B].[Emirate],
		[B].[Suburb],
		[B].[Area] as [BuildingArea],
		[B].[Street],
		[B].[BuildingNo],
		Isnull([My].[CurrencyVal],1) as [CostCurrnecyVal],

		[B].[OpOwner] as [BuildingOpOwner],
		[B].[AccountCommIncomeGuid],
		[B].[AcCommissionFromOwnerGuid],
		[B].[OwnerName] as [BuildingOwnerName],
		[B].[CommissionPercent] as [BuildingCommissionPercent],
		isNull(A.Ban,0) as Ban
		,(Select [ContractState] From [vwLeaseApartment] [E] where [E].[Guid] = A.[LastContractGuid]) [ContractState]
		,(Select [FlatState] From [vwLeaseApartment] [E] where [E].[Guid] = A.[LastContractGuid]) [shopState],

		[A].[BondType] as [ShopBondType],
		[A].[BondNo] as [ShopBondNo],
		[A].[BondDate] as [ShopBondDate]
	From
		[vbShop] [A]
		inner join [vwBuilding] [B] On [B].[Guid] = [A].[BuildingGuid]
		left join [Currency] [My] on [My].[Guid] = [CostCurrencyGuid]


GO

SET ANSI_NULLS, QUOTED_IDENTIFIER ON
GO
Create view vwLeaseApartment_br
 
as
	Select
		A.*
	from 
		[vbLeaseApartment] [A]
		inner join [vwBuilding] [B] On [A].[BuildingGuid] = [B].[Guid]


GO

SET ANSI_NULLS, QUOTED_IDENTIFIER ON
GO

Create Procedure [PrcSetMatDescriptionPriceFromTmp]
(
	@MatCode varchar(255) = '101'
)
 
as
	Declare @MatGuid uniqueidentifier
	Set @MatGuid = (Select Guid From Mat where Code = @MatCode)
	
	Delete [MatUnitsPrice] where MatGuid = @MatGuid
	
	insert into [MatUnitsPrice]
	([Number],[MatGuid],[PriceKind],[Price1],[Price2],[Price3])
	Select 
		G.Number,
		@MatGuid,
		[G].[Name] AS [PriceKind],
		Case 
			when G.Number = 1 then ( Select Top 1 Price11 From [ImportMatTmp] where Code = @MatCode order by id) 
			when G.Number = 2 then ( Select Top 1 Price12 From [ImportMatTmp] where Code = @MatCode order by id) 
			when G.Number = 3 then ( Select Top 1 Price13 From [ImportMatTmp] where Code = @MatCode order by id) 
			when G.Number = 4 then ( Select Top 1 Price14 From [ImportMatTmp] where Code = @MatCode order by id) 
			when G.Number = 5 then ( Select Top 1 Price15 From [ImportMatTmp] where Code = @MatCode order by id) 
			when G.Number = 6 then ( Select Top 1 Price16 From [ImportMatTmp] where Code = @MatCode order by id) 
			when G.Number = 7 then ( Select Top 1 Price17 From [ImportMatTmp] where Code = @MatCode order by id) 
		end, 
		Case 
			when G.Number = 1 then ( Select Top 1 Price21 From [ImportMatTmp] where Code = @MatCode order by id) 
			when G.Number = 2 then ( Select Top 1 Price22 From [ImportMatTmp] where Code = @MatCode order by id) 
			when G.Number = 3 then ( Select Top 1 Price23 From [ImportMatTmp] where Code = @MatCode order by id) 
			when G.Number = 4 then ( Select Top 1 Price24 From [ImportMatTmp] where Code = @MatCode order by id) 
			when G.Number = 5 then ( Select Top 1 Price25 From [ImportMatTmp] where Code = @MatCode order by id) 
			when G.Number = 6 then ( Select Top 1 Price26 From [ImportMatTmp] where Code = @MatCode order by id) 
			when G.Number = 7 then ( Select Top 1 Price27 From [ImportMatTmp] where Code = @MatCode order by id) 
		end, 
		Case 
			when G.Number = 1 then ( Select Top 1 Price31 From [ImportMatTmp] where Code = @MatCode order by id) 
			when G.Number = 2 then ( Select Top 1 Price32 From [ImportMatTmp] where Code = @MatCode order by id) 
			when G.Number = 3 then ( Select Top 1 Price33 From [ImportMatTmp] where Code = @MatCode order by id) 
			when G.Number = 4 then ( Select Top 1 Price34 From [ImportMatTmp] where Code = @MatCode order by id) 
			when G.Number = 5 then ( Select Top 1 Price35 From [ImportMatTmp] where Code = @MatCode order by id) 
			when G.Number = 6 then ( Select Top 1 Price36 From [ImportMatTmp] where Code = @MatCode order by id) 
			when G.Number = 7 then ( Select Top 1 Price37 From [ImportMatTmp] where Code = @MatCode order by id) 
		end
	From 
		[MatDescriptionConfig] [g]
	where
		[Kind] = 1
	Order By
		[G].[Number]
	

GO

SET ANSI_NULLS, QUOTED_IDENTIFIER ON
GO

Create View [vwApartmentAll]
 
as

	Select
		[A].[Number], 
		[A].[Guid], 
		[A].[SecLvl],  
		[A].[BuildingGuid], 
		[A].[FloorNo], 
		[A].[Area], 
		[A].[unity], 
		[A].[ApartmentType], 
		[A].[FlatKind], 
		[A].[CostPrice], 
		A.Rent,
		[A].[CostCurrencyGUID], 
		[A].[Note], 
		[A].[CostGuid], 
		[A].[FlatOwner], 
		[A].[CustGuid], 
		[A].[Details], 
		[A].[OfferState], 
		[A].[OfferType], 
		[A].[CustomerName], 
		[A].[CustomerPhone], 
		[A].[Restrained], 
		[A].[PurchaseDate], 
		[A].[PayValue], 
		[A].[BathroomCount], 
		[A].[BalconyCount], 
		[A].[WaterCounter], 
		[A].[ElectricityCounter], 
		[A].[RestrainedUserGuid], 
		[A].[Class], 
		[A].[CardKind], 
		[A].[Overlooking], 
		[A].[Judicial],
		Case when [A].[Judicial] = 1 then dbo.SC('') else dbo.SC('') end as [Str_Judicial],
		[A].[LtnFlatKind],[A].[LtnApartmentType],[A].[LtnClass],[A].[LtnOverlooking] ,
		IsNull([B].[BuildingCode], '')+	[A].[NO] as [NO],
		[A].[NO] as [FlatNO],
		[B].[Name] as [BuildingName],
		[B].[Emirate],
		[B].[Area] as [BuildingArea],
		[B].[Suburb],
		[B].[Street],
		[B].[BuildingNo],
		[B].[PieceNo],
		[B].[BasinNo],
		Isnull([My].[CurrencyVal],1) as [CostCurrnecyVal],
		[B].[OpOwner] as [BuildingOpOwner],
		[B].[OwnerName] as [BuildingOwnerName],
		[B].[CommissionPercent] as [BuildingCommissionPercent],
		isNull(A.Ban,0) as Ban
		,(Select [ContractState] From [vwLeaseApartment] [E] where [E].[Guid] = A.[LastContractGuid]) [ContractState]
		,(Select [FlatState] From [vwLeaseApartment] [E] where [E].[Guid] = A.[LastContractGuid]) [FlatState],
		[A].[BondType] as [FlatBondType],
		[A].[BondNo] as [FlatBondNo],
		[A].[BondDate] as [FlatBondDate],
		[A].CustOwnerGuid
	From
		[vbApartment] [A]
		inner join [vwBuilding] [B] On [B].[Guid] = [A].[BuildingGuid]
		left join [Currency] [My] on [My].[Guid] = [A].[CostCurrencyGuid]


GO

SET ANSI_NULLS, QUOTED_IDENTIFIER ON
GO

Create Procedure [PrcRecodeMatOfGroup]
(
	@GroupGuid uniqueidentifier = 'A3C61FE5-D1D6-4B8F-A5AC-C83D9A461318'
)
 
as
	Set NoCount on
	Declare @GrCount int
	Select 
		@GrCount = Count(*)
	From 
		[Mat]
	where
		[GroupGuid] = @GroupGuid

	Set @GrCount = Len(Cast(@GrCount as Varchar(25)))

	Declare @Code Varchar(256)
	Select 
		@Code = Code
	From 
		[MatGroup]
	where
		[Guid] = @GroupGuid

	Create Table #R
	(
		[Id] int identity(1,1),
		[Guid] uniqueidentifier 
	)
	
	insert into #R
		([Guid])
	Select 
		[Guid]
	From
		[Mat]
	where
		[GroupGuid] = @GroupGuid
	Order By
		[Number]

-- 
-- 	Select 
--  		[R].*,
--  		@Code+ dbo.FnFormatNumber([id], @GrCount) as Newcode,
--  		[Ac].*
-- 	from 
-- 		[MatGroup] [Ac] 
-- 		inner join #R R on @Code+ dbo.FnFormatNumber([R].[id], @GrCount) = [Ac].[Code] and [R].[Guid] <> [Ac].[Guid]
-- 	where
-- 		[Ac].[ParentGuid] <> @GroupGuid
	
	--    
	Declare @C Int
	Select 
		@C = Count(*)
-- 		[R].*,
-- 		@Code+ dbo.FnFormatNumber([id], @GrCount) as Newcode,
-- 		[Ac].*
	from 
		[Mat] [Ac] 
		inner join #R R on @Code+ dbo.FnFormatNumber([R].[id], @GrCount) = [Ac].[Code] and [R].[Guid] <> [Ac].[Guid]
	where
		[Ac].[GroupGuid] <> @GroupGuid

	if isnull(@C,0) > 0
	begin
		Declare @AcR Varchar(256)
		Declare @Msgerror Varchar(256)
	
		Select Top 1 
			@AcR = [Ac].[Code]+'-'+[Ac].[Name]
		from 
			[Mat] [Ac] 
			inner join #R R on @Code+ dbo.FnFormatNumber([R].[id], @GrCount) = [Ac].[Code] and [R].[Guid] <> [Ac].[Guid]
		where
			[Ac].[GroupGuid] <> @GroupGuid

		Set @Msgerror = '           ' + @AcR
		RAISERROR (@Msgerror, 16, 1)
	end

	update 
		[Mat]
	Set 
		[Code] = @Code+ dbo.FnFormatNumber([id], @GrCount)
	From
		[Mat] [Ac]
		inner join [#R] On [#R].[Guid] = [Ac].[Guid]



	

GO

SET ANSI_NULLS, QUOTED_IDENTIFIER ON
GO

	Create View [vbAccount]
	 
	as
		Select 
			[T].*
		From
			[Account] [T]
			inner join [CurrentUsers] [U] on ([u].[Seclvl] >= Isnull([T].[SecLvl],0)  or [u].[Admin] = 1) and [u].[spid] = @@Spid
GO

SET ANSI_NULLS, QUOTED_IDENTIFIER ON
GO

Create Procedure [dbo].[PrcReNameBuildingCost]
(
	@BuildingGuid uniqueidentifier = '42EEACF8-FE89-4F14-AFB5-3EF324139A61',
	@Flat bit = 0,
	@Shop bit = 0,
	@Parking bit = 1
)
 
as

	if @Flat = 1
	begin
		alter Table [Cost] disable trigger all
		
		update [Cost] set 
			Name = '' +' '+f.NO+' ' +b.Name,
			ltnName = 'Flat' +' '+f.NO+' ' +b.ltnName
		From 
			[Cost] co
			inner join Apartment F on f.CostGuid = co.Guid
			inner join Building B on f.BuildingGuid = b.Guid
		where
			b.Guid = @BuildingGuid
			
		alter Table [Cost] enable trigger all
	end

	if @Shop = 1
	begin
		alter Table [Cost] disable trigger all
		
		update [Cost] set 
			Name = '' +' '+f.NO+' ' +b.Name,
			ltnName = 'Shop' +' '+f.NO+' ' +b.ltnName
		From 
			[Cost] co
			inner join Shop F on f.CostGuid = co.Guid
			inner join Building B on f.BuildingGuid = b.Guid
		where
			b.Guid = @BuildingGuid
			
		alter Table [Cost] enable trigger all
	end

	if @Parking = 1
	begin
		alter Table [Cost] disable trigger all
		
		update [Cost] set 
			Name = '' +' '+f.NO+' ' +b.Name,
			ltnName = 'Parking' +' '+f.NO+' ' +b.ltnName
		From 
			[Cost] co
			inner join Parking F on f.CostGuid = co.Guid
			inner join Building B on f.BuildingGuid = b.Guid
		where
			b.Guid = @BuildingGuid
			
		alter Table [Cost] enable trigger all
	end
		

GO

SET ANSI_NULLS, QUOTED_IDENTIFIER ON
GO

Create Procedure [PrcDailyStatistic]
(
	@CurrencyGuid uniqueidentifier = '11111111-C748-4B13-8B91-1E9B299DF1C1',
	@CurrencyVal Float = 100,
	@ShowDetail Bit = 0,
	@Date1 DateTime = '1/1/2007',
	@Date2 DateTime = '1/1/2010'
)
 
as
	if isnull(@CurrencyVal, 0) = 0
	Set @CurrencyVal = 1

	Create Table [#R]
	(
		[TypeName] Varchar(256),
		[Number] int,
		[Date] Datetime,
		[Value] Float,
		[Kind] int,
		[SumKind] int,
		[Guid] uniqueidentifier
	)

	Insert into [#R]
	--
	Select 
		[TypeName],
		[Number],
		[EditDate],
		[Rent] * [CurrencyVal] / Case when [CurrencyGuid] = @CurrencyGuid then [CurrencyVal] else @CurrencyVal end as [Value],
		0 as [Kind],
		0 as [SumKind],
		[C].[Guid]
	From 
		[vwLeaseApartment] [C]
		inner join [Resource] [R] on [R].[Guid] = [C].[TypeGuid] and [spid] = @@Spid
	where
		[EditDate] between @Date1 And @Date2
	Order By
		[TypeName],[EditDate]

	-- 
	Insert into [#R]
	Select 
		[TypeName],
		[Number],
		[C].[Date],
		[Value] * [CurrencyVal] / Case when [CurrencyGuid] = @CurrencyGuid then [CurrencyVal] else @CurrencyVal end as [Value],
		1 as [Kind],
		0 as [SumKind],
		[C].[Guid]
	From 
		[vwChecks] [C]
		inner join [Resource] [R] on [R].[Guid] = [C].[TypeGuid] and [spid] = @@Spid
	where
		[Date] between @Date1 And @Date2
	Order By
		[TypeName],[Date]

	--  
	Insert into [#R]
	Select 
		[C].[TypeName] +' '+dbo.sc(''),
		[K].[Number],
		[C].[Date],
		[C].[Value] * [C].[CurrencyVal] / Case when [C].[CurrencyGuid] = @CurrencyGuid then [C].[CurrencyVal] else @CurrencyVal end as [Value],
		2 as [Kind],
		0 as [SumKind],
		[CheckGuid] as [Guid]
	From 
		[vwChecksCollection] [C]
		inner join [vwChecks] [K] on [K].[Guid] = [C].[CheckGuid]
		inner join [Resource] [R] on [R].[Guid] = [K].[TypeGuid] and [spid] = @@Spid
	where
		[C].[Date] between @Date1 And @Date2
	Order By
		[C].[TypeName],[C].[Date]

	-- 
	Insert into [#R]
	Select 
		[T].[Name] as [TypeName],
		[C].[Number],
		[C].[Date],
		Case 
			when isnull([D].[Debit],0) <> 0 then [D].[Debit] 
			when isnull([D].[Credit],0) <> 0 then [D].[Credit] 
		end	
		* [D].[CurrencyVal] / Case when [D].[CurrencyGuid] = @CurrencyGuid then [D].[CurrencyVal] else @CurrencyVal end as [Value],
		3 as [Kind],
		0 as [SumKind],
		[C].[Guid]
	From 
		[Secondary_Entry] [C]
		inner join [EntryType] [T] on [T].[Guid] = [C].[TypeGuid]
		inner join [Secondary_EntryDetail] [D] on [D].[ParentGuid] = [C].[Guid]
		inner join [Resource] [R] on [R].[Guid] = [C].[TypeGuid] and [spid] = @@Spid
	where
		[Date] between @Date1 And @Date2
	Order By
		[TypeName],[Date]

	insert into #R
	Select 
		--dbo.sc('') +' '+
		[TypeName],
		Count([Number]),
		Null as [Date],
		Sum([Value]) as [Value],
		[Kind],
		1 as [SumKind],
		0x0 as [Guid]
	From
		#R	
	Group By
		[Kind],
		[TypeName]

	
	Select 
		* 
	from 
		#R
	where
		([SumKind] = 1 And @ShowDetail = 0)
		or @ShowDetail = 1
	Order By
		[Kind],[TypeName], [SumKind], [Date], Number

	

		

GO

SET ANSI_NULLS, QUOTED_IDENTIFIER ON
GO

Create View [vwParkingAll]
 
as

	Select
		[A].[Number], [A].[Guid], [A].[SecLvl], [A].[BuildingGuid], [A].[FloorNo], [A].[Area], [A].[unity], [A].[Note], 
		[A].[CostPrice], [A].[CostCurrencyGUID], [A].[CostGuid], [A].[FlatOwner], 
		[A].[CustGuid], [A].[Details], [A].[OfferState], 
		[A].[OfferType], [A].[CustomerName], [A].[CustomerPhone], [A].[Restrained], 
		[A].[PurchaseDate], [A].[PayValue], [A].[RestrainedUserGuid], [A].[ParkingKind], [A].[Description], [A].[Overlooking], [A].[Judicial],
		[B].[BuildingCode]+[A].[NO] as [NO],
		[A].[Rent],
		[A].[RentCurrencyGuid],
		[A].[Sale],
		[A].[SaleCurrencyGuid],
		[B].[Name] as [BuildingName],
		[B].[Emirate],
		[B].[Area] as [BuildingArea],
		[B].[Suburb],
		[B].[Street],
		Case when [A].[Judicial] = 1 then dbo.SC('') else dbo.SC('') end as [Str_Judicial],
		Isnull([My].[CurrencyVal],1) as [CostCurrnecyVal],
		[B].[OpOwner] as [BuildingOpOwner],
		[B].[OwnerName] as [BuildingOwnerName],
		--0x0 as [BuildingOwnerName],
		[B].[AccountCommIncomeGuid],
		[B].[CommissionPercent] as [BuildingCommissionPercent],
		isNull(A.Ban,0) as Ban

		,(Select Top 1 [ContractState] From [vwParkingContract] [E] where [E].[Guid] = A.[LastContractGuid]) [ContractState]
		,(Select Top 1 [ParkingState] From [vwParkingContract] [E] where [E].[Guid] = A.[LastContractGuid]) [ParkingState]
		
	From
		[vbParking] [A]
		inner join [vwBuilding] [B] On [B].[Guid] = [A].[BuildingGuid]
		left join [Currency] [My] on [My].[Guid] = [CostCurrencyGuid]
		


GO

SET ANSI_NULLS, QUOTED_IDENTIFIER ON
GO

Create Procedure [PrcRecodeGroups]
(
	@GroupGuid uniqueidentifier = 'A3C61FE5-D1D6-4B8F-A5AC-C83D9A461318'
)
 
as
	Set NoCount on
	Declare @GrCount int
	Select 
		@GrCount = Count(*)
	From 
		[MatGroup]
	where
		[ParentGuid] = @GroupGuid

	Set @GrCount = Len(Cast(@GrCount as Varchar(25)))

	Declare @Code Varchar(256)
	Select 
		@Code = Code
	From 
		[MatGroup]
	where
		[Guid] = @GroupGuid

	Create Table #R
	(
		[Id] int identity(1,1),
		[Guid] uniqueidentifier 
	)
	
	insert into #R
		([Guid])
	Select 
		[Guid]
	From
		[MatGroup]
	where
		[ParentGuid] = @GroupGuid
	Order By
		[Number]

-- 
-- 	Select 
--  		[R].*,
--  		@Code+ dbo.FnFormatNumber([id], @GrCount) as Newcode,
--  		[Ac].*
-- 	from 
-- 		[MatGroup] [Ac] 
-- 		inner join #R R on @Code+ dbo.FnFormatNumber([R].[id], @GrCount) = [Ac].[Code] and [R].[Guid] <> [Ac].[Guid]
-- 	where
-- 		[Ac].[ParentGuid] <> @GroupGuid
	
	--    
	Declare @C Int
	Select 
		@C = Count(*)
-- 		[R].*,
-- 		@Code+ dbo.FnFormatNumber([id], @GrCount) as Newcode,
-- 		[Ac].*
	from 
		[MatGroup] [Ac] 
		inner join #R R on @Code+ dbo.FnFormatNumber([R].[id], @GrCount) = [Ac].[Code] and [R].[Guid] <> [Ac].[Guid]
	where
		[Ac].[ParentGuid] <> @GroupGuid

	if isnull(@C,0) > 0
	begin
		Declare @AcR Varchar(256)
		Declare @Msgerror Varchar(256)
	
		Select Top 1 
			@AcR = [Ac].[Code]+'-'+[Ac].[Name]
		from 
			[MatGroup] [Ac] 
			inner join #R R on @Code+ dbo.FnFormatNumber([R].[id], @GrCount) = [Ac].[Code] and [R].[Guid] <> [Ac].[Guid]
		where
			[Ac].[ParentGuid] <> @GroupGuid

		Set @Msgerror = '           ' + @AcR
		RAISERROR (@Msgerror, 16, 1)
	end

	update 
		[MatGroup]
	Set 
		[Code] = @Code+ dbo.FnFormatNumber([id], @GrCount)
	From
		[MatGroup] [Ac]
		inner join [#R] On [#R].[Guid] = [Ac].[Guid]


	exec PrcRecodeMatOfGroup @GroupGuid

GO

SET ANSI_NULLS, QUOTED_IDENTIFIER ON
GO

	Create View [vbSecondary_Entry]
	 
	as
		Select 
			[T].*
		From
			[Secondary_Entry] [T]
			inner join [CurrentUsers] [U] on ([u].[Seclvl] >= Isnull([T].[SecLvl],0)  or [u].[Admin] = 1) and [u].[spid] = @@Spid
GO

SET ANSI_NULLS, QUOTED_IDENTIFIER ON
GO
Create View [vwAllShortCut]
 
as
	Select 
		[Guid], [Shortcut],' ' as [Name], 0x0 as UserGuid
	From
		[ExternalTools]
	where
		[Shortcut] <> ''

	union all
	Select 
		[Guid], [Shortcut],'' as [Name], UserGuid
	From
		[TblShortCut]
	where
		[Shortcut] <> ''

	union all
	Select 
		[Guid], [Shortcut],' ' as [Name], 0x0 as UserGuid
	From
		[EntryType]
	where
		[Shortcut] <> ''

	union all
	Select 
		[Guid], [Shortcut],' ' as [Name], 0x0 as UserGuid
	From
		[ContractType]
	where
		[Shortcut] <> ''

	union all
	Select 
		[Guid], [Shortcut],' ' as [Name], 0x0 as UserGuid
	From
		[CheckType]
	where
		[Shortcut] <> ''

	union all
	Select 
		[Guid], [Shortcut],'  ' as [Name], 0x0 as UserGuid
	From
		[ElectricityType]
	where
		[Shortcut] <> ''
		
	union all
	Select 
		[Guid], [Shortcut],'  ' as [Name], 0x0 as UserGuid
	From
		[ReceiptOrderType]
	where
		[Shortcut] <> ''
	


GO

SET ANSI_NULLS, QUOTED_IDENTIFIER ON
GO

Create Trigger [TRG_Shop_Del]
on [Shop]
 
For delete
As
	Declare @ContractNo Varchar(256), @Msg Varchar(256)
	
	Select @ContractNo =  T.Name +' : '+ CAST(A.Number as Varchar(256))
	from 
		[LeaseApartment] [A]
		inner join [vwContractType] [T] on [T].[Guid] = [A].[TypeGuid]
		inner join [Deleted] [D] On [D].[Guid] = [A].[ApartmentGuid]
	
	Set @Msg = dbo.SC('      ')+char(13)+ @ContractNo
			   
	if @ContractNo is Not Null
	BEGIN
		RAISERROR (@Msg, 16, 1)
		ROLLBACK TRANSACTION
	END

GO

SET ANSI_NULLS, QUOTED_IDENTIFIER ON
GO

Create View [FinalAccount]
 
as
	Select
		*
	From 
		[vwAccount]
	where 
		([Type] = 1)


GO

SET ANSI_NULLS, QUOTED_IDENTIFIER ON
GO

	Create View [vbApartment]
	 
	as
		Select 
			[T].*
		From
			[Apartment] [T]
			inner join [CurrentUsers] [U] on ([u].[Seclvl] >= Isnull([T].[SecLvl],0)  or [u].[Admin] = 1) and [u].[spid] = @@Spid
GO

SET ANSI_NULLS, QUOTED_IDENTIFIER ON
GO

CREATE FUNCTION [dbo].[fnGetAccountsChild]
( 
	@AccGUID [UNIQUEIDENTIFIER]= 0x0
)

	RETURNS @Result TABLE 
								(
									GUID UNIQUEIDENTIFIER
								)   
 
AS 
BEGIN  
	Insert into @Result
	(Guid)values
	(@AccGUID)

	Insert into @Result
	select 
		[Guid]
	From	
		[Account]
	where 
		[ParentGuid]=@AccGUID

	RETURN  
END 


GO

SET ANSI_NULLS, QUOTED_IDENTIFIER ON
GO

Create Function dbo.[FnGetAccountCurrency]
(
	@AccountGuid uniqueidentifier = '0ACC7FE7-CA3C-475A-9F4D-DA2F6ECB16E9',
	@Date DateTime = '7/28/2008'
)
RETURNS @Result TABLE ([CurrencyGUID] [UNIQUEIDENTIFIER], CurrencyVal Float)   
 
begin
	
	Set @Date = ISNULL(@Date, GETDATE())

	Declare @CurrencyGuid uniqueidentifier
	
	Select
		@CurrencyGuid = CurrencyGuid 
	From
		Account
	where
		Guid = @AccountGuid
		
	INSERT INTO @Result 
	Select
	@CurrencyGuid ,
	(Select dbo.[FnGetCurrencyVal] (@CurrencyGuid, Null))

	RETURN  
	

end


GO

SET ANSI_NULLS, QUOTED_IDENTIFIER ON
GO

	Create View [vbSalesman]
	 
	as
		Select 
			[T].*
		From
			[Salesman] [T]
			inner join [CurrentUsers] [U] on ([u].[Seclvl] >= Isnull([T].[SecLvl],0)  or [u].[Admin] = 1) and [u].[spid] = @@Spid
GO

SET ANSI_NULLS, QUOTED_IDENTIFIER ON
GO

Create Procedure [dbo].[PrcRenewalServicesContractCount]
(
	@CustGuid uniqueidentifier = 0x0,
	@BuildingGuid uniqueidentifier = 0x0
)
 
as
	Declare @ContractCount int
	Select 
		@ContractCount = IsNull(COUNT(*),0) + 1 
	From 
		[ServicesContract]
	where
		CustomerGuid = @CustGuid
		and BuildingGuid = @BuildingGuid
		
	Declare @CountOldContract int
	Select 
		@CountOldContract = Max([CountOldContract])
	From 
		[ServicesContract]
	where
		CustomerGuid = @CustGuid
		and BuildingGuid = @BuildingGuid	
		
	Select @CountOldContract as CountOldContract, @ContractCount as ContractCount

GO

SET ANSI_NULLS, QUOTED_IDENTIFIER ON
GO

Create Procedure [dbo].[PrcStrSource]
 
as

	Declare @Country varchar(255)
	
	Select @Country = Value From DMD_Const where VName = 'Country'
	
	if (@Country = ' ') or (@Country = 'Kuwait') 
	exec [dbo].[PrcStrSource3]
	else
	exec [dbo].[PrcStrSource1]
	


GO

SET ANSI_NULLS, QUOTED_IDENTIFIER ON
GO
Create Procedure [PrcTransfer_ParkingContract]
(
	@RoKind int = 2,
	@ToDataBaseName Varchar(256) = 'RRR',
	@UntilDate Datetime = '2015-5-30',
	@BeginDate Datetime = '2016-1-1',
	@RoundContractWithCheckNotCollection bit = 1
)
 
as
	if (@RoKind = 1) Return --  
	
	Declare @V Varchar(8000)
	
	--EXEC PrcDeleteTable 'ParkingContract',@ToDataBaseName
	--EXEC PrcDeleteTable 'ParkingContract',@ToDataBaseName
	
	Set @V = 'ALTER TABLE '+@ToDataBaseName+'.[dbo].[ParkingContract] NOCHECK CONSTRAINT [UK_ParkingContract_FlatContractGuid]'
	exec (@v)
	

	Set @V = '
			where 
				[ContractFinish] = 0
				or ([Guid] in (Select ContractGuid from lawsuit where [IsEnded] = 0))'
	if (@RoKind = 2) --    
	Set @V = @v + '
	or EditDate >'+''''+CAST(@UntilDate as varchar(255))+''''
	
	if (@RoundContractWithCheckNotCollection = 1) --       
	Set @V = @v + '
	or ([Guid] in (Select ContractGuid from vwChecksCollectionState where [IsCollection] = 0))'

	EXEC PrcTransferTable  'ParkingContract',@ToDataBaseName, @V
							

	Set @V = '
	Alter Table '+@ToDataBaseName+'..[ParkingContract] Disable Trigger All'
	exec (@v)

	--   
	Set @V = 'Update '+@ToDataBaseName+'..[ParkingContract] Set FlatContractGuid = L.Guid
	From 
		ParkingContract [Tbl]
		inner join '+@ToDataBaseName+'..LeaseApartment L on L.Guid = [Tbl].[FlatContractGuid] 			'
	exec(@V)

	Set @V = 'ALTER TABLE '+@ToDataBaseName+'.[dbo].[ParkingContract] CHECK CONSTRAINT [UK_ParkingContract_FlatContractGuid]'
	exec (@v)

	--        
	Set @V = '
	UpDate '+@ToDataBaseName+'..[ParkingContract] Set [IsRounded] = 1 where EditDate <='+''''+CAST(@UntilDate as varchar(255))+''''
	exec(@V)

	--        
	Set @V = '
	UpDate '+@ToDataBaseName+'..[ParkingContract] Set [IsRounded] = 1 
	From
		'+@ToDataBaseName+'..[ParkingContract] L
		inner join HEntry H on L.Guid = H.Guid 
	where H.Date <'+''''+CAST(@UntilDate as varchar(255))+''''
	Print(@V)
	exec(@V)

 	Set @V = 'Update '+@ToDataBaseName+'..[ParkingContract] Set EditDate = '''+CAST(@BeginDate as VARchar(20))+''''
	exec(@V)

	Set @V = '
	inner Join '+@ToDataBaseName+'..[LeaseApartment] A on A.Guid = [Tb].ParentGuid
	inner Join '+@ToDataBaseName+'..[parkingContract] P on P.Guid = [Tb].parkingContractGuid
	'

	EXEC PrcTransferTable  'LinkParkingContract',@ToDataBaseName,@V

	Set @V = '
	Alter Table '+@ToDataBaseName+'..[ParkingContract] Enable Trigger All'
	exec (@v)

	-- 
	Set @V = '
	inner join '+@ToDataBaseName+'..ParkingContract L on L.Guid = [Tb].[ParentGuid]
	inner join '+@ToDataBaseName+'..Account Ac on Ac.Guid = [Tb].[AccountGuid]
	'
	EXEC PrcTransferTable  'ParkingContractFee',@ToDataBaseName, @V

	Set @V = '
	exec '+@ToDataBaseName+'..[PrcReNumberCard]
		0, --@Entry
		0, --@FirstEntryNum
		0, --@EntryType
		0x0, --@EntryTypeGuid
		0, --@FirstEntryTypeNum
		1, --@ContractType
		0x0, --@ContractTypeGuid =
		0, --@FirstContractTypeNum
		0, --@CheckType
		0x0, --@CheckTypeGuid 
		0, --@FirstCheckTypeNum
		0, --@Flat
		0, --@Shop
		0, --@Parking
		0, --@Land
		0, --@Villa
		0, --@Account
		0x0, --@ElectricityBillType
		0x0, --@ElectricityBillTypeGuid =
        0 --@Cus
		'
	exec(@V)


	--  
	Set @V = '
	Delete '+@ToDataBaseName+'..[Resource]'
	exec (@v)
	
	Set @V = '
	insert into '+@ToDataBaseName+'..[Resource]
	([Guid], [Kind])
	Select Guid, 1 from '+@ToDataBaseName+'..ContractType'
	exec (@v)
	
	Set @V = '
	exec '+@ToDataBaseName+'..PrcReCreateContractParkingEntry 0, 0, 0, 0, 0,0,0,0'
	--Sql.Add('exec PrcReCreateContractFlatShopEntry :Date1, :Date2, :ActiveDate, :Datewith, :Num1, :Num2, :ActiveNum, :MaxDate');

	exec (@v)



GO

SET ANSI_NULLS, QUOTED_IDENTIFIER ON
GO

Create View [vwMovingStore]
 
as
	Select
		S.*
	From 
		[vwStore] S
		left join [Store] [S2] on [S2].[ParentGuid]  = [S].[Guid]
	where 
		([S2].[Guid] is Null)


GO

SET ANSI_NULLS, QUOTED_IDENTIFIER ON
GO

Create Procedure [dbo].[PrcMatCardBalance]
(
	@MatGuid uniqueidentifier = 0x0,
	@StoreGuid uniqueidentifier = 0x0
)
 
as
	--if @MatGuid = 0x0
	--Select Top 1 @MatGuid = Guid from Mat
	
	Select 		st.code +'-'+ st.Name  COLLATE database_default as [Store],		M.[Qty],		Mt.[Unity1] COLLATE database_default as [Unity1],		M.[Qty2],		Mt.[Unity2] COLLATE database_default as [Unity2],		M.[Qty3],		Mt.[Unity3] COLLATE database_default as [Unity3],		0 as Kind	into #MatCardBalance_InvDetailStore1	from 		Matbalance M		inner join Store St on M.storeGuid = St.Guid		inner join [mat] mt on mt.Guid = M.ParentGuid	where		m.ParentGuid = @MatGuid		and (M.StoreGuid  = @StoreGuid or @StoreGuid = 0x0)
	insert into #MatCardBalance_InvDetailStore1
	Select 		dbo.sc(''),		Sum([Qty]),		[Unity1],		Sum([Qty2]),		[Unity2],		Sum([Qty3]),		[Unity3],		1 as Kind	from 		#MatCardBalance_InvDetailStore1	Group By		[Unity1],		[Unity2],		[Unity3]			Select 		* 	from 		#MatCardBalance_InvDetailStore1	Order By 		Kind , Store		

GO

SET ANSI_NULLS, QUOTED_IDENTIFIER ON
GO

Create Trigger [Trg_Account_Update]
on [Account]
 
for Delete, insert, update
As
	SET NOCOUNT ON;
	if dbo.fnObjectExists('##fnGetAccountList') = 1
	Drop Table ##fnGetAccountList

GO

SET ANSI_NULLS, QUOTED_IDENTIFIER ON
GO

	Create View [vbLandContract]
	 
	as
		Select 
			[T].*
		From
			[LandContract] [T]
			inner join [CurrentUsers] [U] on ([u].[Seclvl] >= Isnull([T].[SecLvl],0)  or [u].[Admin] = 1) and [u].[spid] = @@Spid
GO

SET ANSI_NULLS, QUOTED_IDENTIFIER ON
GO

Create Procedure [PrcExceptionCard]
(
	@EmptyAcc Bit = 1,
	@BalanceAcc Bit = 1,
	@BalanceCust Bit = 1,
	@ToDataBaseName Varchar(256) = 'AlAqaree2010'

	
)
 
as
	Declare @S varchar(8000)

	Declare @CustGuid uniqueidentifier

	-- 
	if @BalanceCust = 1
	begin
		DECLARE cursor_Name CURSOR FAST_FORWARD FOR 
		SELECT [Guid]
		FROM [Customer]
		
		OPEN cursor_Name
		FETCH NEXT FROM cursor_Name INTO @CustGuid
		
		WHILE @@FETCH_STATUS = 0
		BEGIN
			
			Set @S = '	
			Delete '+@ToDataBaseName+'..[Customer]
			From
				'+@ToDataBaseName+'..[Customer] [C]
				inner join [Account] [A] on [A].[Guid] = [C].[AcGuid]
				left join (
							Select 
								[AcGuid],
								Sum([Debit]) as [Debit],
								Sum([Credit]) as [Credit]
							From
								[DEntry] 
							Group By
								[AcGuid]
							) [D] on [D].[AcGuid] = [A].[Guid]
			where
				[Debit] = [Credit]
				and [C].[Guid] = '''+Cast(@CustGuid as Varchar(256))+''''

		  Print @S
		  Exec(@S)		

		  FETCH NEXT FROM cursor_Name INTO @CustGuid
		
		END
		
		CLOSE cursor_Name
		DEALLOCATE cursor_Name
	end
	
	-- 
	Declare @AcGuid Uniqueidentifier
	if @EmptyAcc = 1
	begin
		DECLARE cursor_Name CURSOR FAST_FORWARD FOR 
		SELECT [Guid]
		FROM [vwAccount] 
		where
			[Nsons] = 0
		
		OPEN cursor_Name
		FETCH NEXT FROM cursor_Name INTO @AcGuid
		
		WHILE @@FETCH_STATUS = 0
		BEGIN
		
		Set @S = '			
		Delete '+@ToDataBaseName+'..[Account]
		From
			'+@ToDataBaseName+'..[Account] [A]
			left join [DEntry] [D] on [A].[Guid] = [D].[AcGuid]
			left join [vwAccount] [A2] on [A2].[Guid] = [A].[Guid]
		where
			([D].[Guid] is Null)
			and ([A2].[NSons] = 0)
				and [A].[Guid] = '''+Cast(@AcGuid as Varchar(256))+''''

		  Print @S
		  Exec(@S)		

		  FETCH NEXT FROM cursor_Name INTO @AcGuid
		
		END
		
		CLOSE cursor_Name
		DEALLOCATE cursor_Name

	end


	-- 
	if @BalanceAcc = 1
	begin
		DECLARE cursor_Name CURSOR FAST_FORWARD FOR 
		Select [Guid]
		FROM [vwAccount] 
		where
			[Nsons] = 0
		
		OPEN cursor_Name
		FETCH NEXT FROM cursor_Name INTO @AcGuid
		
		WHILE @@FETCH_STATUS = 0
		BEGIN
		
		Set @S = '			
		Delete '+@ToDataBaseName+'..[Account]
		From
			'+@ToDataBaseName+'..[Account] [A]
			inner join (
						Select 
							[AcGuid],
							Sum([Debit]) as [Debit],
							Sum([Credit]) as [Credit]
						From
							[DEntry] 
						Group By
							[AcGuid]
						) [D] on [D].[AcGuid] = [A].[Guid]
			left join [vwAccount] [A2] on [A2].[Guid] = [A].[Guid]
		where
			([D].[Debit] = [D].[Credit])
			and ([A2].[NSons] = 0)
				and [A].[Guid] = '''+Cast(@AcGuid as Varchar(256))+''''

		  Print @S
		  Exec(@S)		

		  FETCH NEXT FROM cursor_Name INTO @AcGuid
		
		END
		
		CLOSE cursor_Name
		DEALLOCATE cursor_Name

	end


GO

SET ANSI_NULLS, QUOTED_IDENTIFIER ON
GO

Create View [vwChecks]
 
as
	select
		[C].[Number], [C].[Guid], [C].[SecLvl], [C].[Mark], [C].[TypeGuid], [C].[NO], [C].[InternalNO], 
		[C].[ReceiptNo], [C].[Value], [C].[CurrencyGUID], [C].[CurrencyVal], [C].[Date], 
		Case when Datepart(Year , [C].[DueDate]) = 1900 then Null else [C].[DueDate] end as [DueDate], 
		dbo.fnDate(Case when Datepart(Year , [C].[DueDate]) = 1900 then Null else [C].[DueDate] end) as [DueDateHG],
		Case when Datepart(Year , [C].[endDueDate]) = 1900 then Null else [C].[endDueDate] end as [endDueDate],
		[C].[NoneDueDate], 
		[C].[BankName], 
		[C].[Account], 
		[C].[CostGuid], 
		[C].[ObverseAccount], 
		[C].[CostObverseGuid], 
		[C].[Beneficiary], 
		[C].[Note], 
		[C].[Note2], 
		[C].[Note3], 
		[C].[Note4], 
		[C].[ContractGuid], 
		[C].[UserGuid], 
		[C].[BranchGuid], 
		[C].[SalesManGuid], 
		[C].[FolderDate], 
		[C].[FolderInternalNo], 
		[C].[FolderExternalNo], 
		[C].[CheckCreateEntry], 
		[C].[IsRounded], 
		[C].[Deposition],
		[C].[Lawsuit],
		[Ac].[Code] as [AccountCode],
		[Ac].[Name] as [AccountName],
		[Ac].[ArName] as [AccountNamear],
		[Ac].[LtnName] as [AccountNameLtn],
		[Ac2].[Code] as [ObverseAccountCode],
		[Ac2].[Name] as [ObverseAccountName],
		[T].[Name] as [TypeName],
		[M].[Code] as [CurrencyCode],
		[M].[Name] as [CurrencyName],
		[T].[Code] as [TypeCode],
		[T].[checkkind]
	From
		[vbchecks] [C]
		inner join [vwCheckType] [T] On [C].[TypeGuid] = [T].[Guid]
		inner join [vwCurrency] [M] on [M].[Guid] = [C].[CurrencyGuid]
		inner join [vwAccount] [Ac] on [Ac].[Guid] = [C].[Account]
		inner join [vwAccount] [Ac2] on [Ac2].[Guid] = [C].[ObverseAccount]

-- 		left join [vwChecksCollection] [C] on [C].[CheckGuid] = [P].[Guid] and [C].[Kind] = 0
-- 		left join [vwChecksCollection] [C1] on [C1].[CheckGuid] = [P].[Guid] and [C1].[Kind] = 1
-- 		left join [vwChecksCollection] [C2] on [C2].[CheckGuid] = [P].[Guid] and [C2].[Kind] = 2
-- 		left join [vwChecksCollection] [C3] on [C3].[CheckGuid] = [P].[Guid] and [C3].[Kind] = 3
-- 		left join [ChecksPartialCollection]  [C4] on [C4].[CheckGuid] = [P].[Guid] and [C3].[Kind] = 3


GO

SET ANSI_NULLS, QUOTED_IDENTIFIER ON
GO

Create Procedure [PrcOfferEarth]
(
	@CustGuid [uniqueidentifier] = 0x0,
	@CityGuid [uniqueidentifier] = 0x0,
	@RegionGuid [uniqueidentifier] = 0x0,
	@Space Varchar(256) = '',
	@Area1 Float = 0,
	@Area2 Float = 0,
	@Price1 Float = 0,
	@Price2 Float = 0,
	@CkSale Bit = 1,
	@CkNotSale Bit = 1,
	@CkLease Bit = 1,
	@CkNotLease Bit = 1,
	@Restrained Bit = 1,
	@NotRestrained Bit = 1,
	@Date1 DateTime = '1/1/2007',
	@Date2 DateTime = '1/1/2008',
	@Lang Int = 0
)
 
as
	Select
		*
	From
		vwEarth
	where
		([CustomerGuid] = @CustGuid or @CustGuid = 0x0)
		and ([Space] = @Space or @Space = '')
		and ([Area] between @Area1 and @Area2 or @Area2 = 0)
		and (
				([Area] = @Area1 and @Area2 = 0)
				or (@Area1 = 0)
				or (@Area1 <> 0 and @Area2 <> 0)
			)
		and ([Price] between @Price1 and @Price2 or @Price2 = 0)
		and (
				([Price] = @Price1 and @Price2 = 0)
				or (@Price1 = 0)
				or (@Price1 <> 0 and @Price2 <> 0)
			)


GO

SET ANSI_NULLS, QUOTED_IDENTIFIER ON
GO

	Create View [vbEntryDate]
	 
	as
		Select 
			[T].*
		From
			[EntryDate] [T]
			inner join [CurrentUsers] [U] on ([u].[Seclvl] >= Isnull([T].[SecLvl],0)  or [u].[Admin] = 1) and [u].[spid] = @@Spid
GO

SET ANSI_NULLS, QUOTED_IDENTIFIER ON
GO
Create View [vwCostUsed]
 
as
	Select
		[C].[Number], 
		[C].[Guid], 
		[C].[Code], 
		[C].[LtnName], 
		[C].[ParentGUID], 
		[C].[Note],
		Case when (dbo.FnGetLangauge(@@spid) = 1) and (Isnull([C].[LtnName],'') <> '') then [C].[LtnName] else [C].[Name] end as [Name],

		U.[usedCard]
	From
		[vbCost] [C]
		left join (
					Select Distinct
						C.Guid,
						Case 
							when [S].[Guid] is Not Null then 1 
							when [P].[Guid] is Not Null then 2
							when [G].[Guid] is Not Null then 3
						else
							0
						end as [usedCard]
					From
						Cost C
						left join [Shop] [S] on [S].[CostGuid] = [C].[Guid]
						left join [Apartment] [P] on [P].[CostGuid] = [C].[Guid]
						left join [Parking] [G] on [G].[CostGuid] = [C].[Guid]
					) U on U.Guid = C.Guid


GO

SET ANSI_NULLS, QUOTED_IDENTIFIER ON
GO

Create Procedure [PrcKillsessionUser]
(
	@Sp Varchar(256) = '55'
)
 
as
	Declare @S Varchar(256)
	Set @S = 'Kill '+@Sp
	exec(@S)
	
	Delete [CurrentUsers] where Spid = CAST(@Sp as int)

GO

SET ANSI_NULLS, QUOTED_IDENTIFIER ON
GO

Create Procedure [PrcNewLandContract]
(
	@Guid uniqueidentifier = 0x0
)
 
as
	Select
		(Select Isnull(Max([Number]),0) + 1 From [LandContract]) as [Number],
		[Guid],
		[ContractNo],
		[CustomerGuid],
		[LandGuid],
		[VillaGuid],
		Case 
			when [ContractFinish] = 0 then Dateadd(Day,1,[ToDate]) 
			when [ContractFinish] = 1 then Dateadd(Day,1,[ContractFinishDate]) 
		end as [FromDate],
		Dateadd(year,1,
						Case 
							when [ContractFinish] = 0 then [ToDate]
							when [ContractFinish] = 1 then [ContractFinishDate]
						end
				) as [ToDate],
		[Rent]+ISNULL(AddValue,0) as [Rent],
		[CurrencyGuid],
		[CurrencyVal],
		[PayType],
		[Note],
		[Note2],
		[Purpose],
		[ContractKind],
		[RevenueAccountGuid],
		[CustAccountGuid],
		[CommissionFromCustPercent],
		[CommissionFromCustValue],
		[AcCommissionFromCustGuid],
		[CommissionFromOwnerPercent],
		[CommissionFromOwnerValue],
		[AcCommissionFromOwnerGuid],
		[LandOwner],
		Cast( 0 as bit) as [ContractFinish],
		Cast( Null as DateTime)  as [ContractFinishDate],
		0 as [ResultingAmount],
		0 as [ResultingAmount2],
		[RoundKind],
		0 as [Fine],
		[FineAccount],
		Cast( 0 as bit) as [CreateResultingEntry],
	
		0 as [InsuranceValue],
		[InsuranceValue] + Isnull([InsuranceValueOld],0) as [InsuranceValueOld],
		[ContractPrice],
		[AccountContractPrice],
		[CertificatValue],
		[AccountCertificatValue],

		[RentDuration],
		[Rentype],
		[TermsOfPayment],
		[RentInfoGuid],
		[SalesManGuid],
		[whereabouts],
		[BranchGuid],
		[CostGuid],
		IsAutoRenewal
	From
		[vwLandContract]
	where
		[Guid] = @Guid Or @Guid = 0x0


GO

SET ANSI_NULLS, QUOTED_IDENTIFIER ON
GO

Create Procedure [PrcOfferApartment]
(
	@CustGuid [uniqueidentifier] = 0x0,
	@CityGuid [uniqueidentifier] = 0x0,
	@RegionGuid [uniqueidentifier] = 0x0,
	@Area1 Float = 0,
	@Area2 Float = 0,
	@Price1 Float = 0,
	@Price2 Float = 0,
	@CkSale Bit = 1,
	@CkNotSale Bit = 1,
	@CkLease Bit = 1,
	@CkNotLease Bit = 1,
	@Restrained Bit = 1,
	@NotRestrained Bit = 1,
	@Date1 DateTime = '1/1/2007',
	@Date2 DateTime = '1/1/2008',
	@Lang Int = 0
)
 
as
	Select
		*,
		Case when [OfferType] = 1 then 
			case when @Lang = 0 then ''
				 when @Lang = 1 then 'Sale' end
			when [OfferType] = 0 then 
			case when @Lang = 0 then ''
				 when @Lang = 1 then 'rent' end 
		end as [StrOfferType],

		Case when [OfferType] = 1 and [OfferState] = 0 then 
			case when @Lang = 0 then ''
				 when @Lang = 1 then 'Sale' end

			 when [OfferType] = 1 and [OfferState] = 1 then 
			case when @Lang = 0 then ' '
				 when @Lang = 1 then 'Not Sale' end

			 when [OfferType] = 0 and [OfferState] = 0 then 
			case when @Lang = 0 then ''
				 when @Lang = 1 then 'rent' end

			 when [OfferType] = 0 and [OfferState] = 1 then 
			case when @Lang = 0 then ' '
				 when @Lang = 1 then 'Not rent' end
		end as [StrOfferState]

	From
		vwOfferApartment
	where
		([CityGuid] = @CityGuid or @CityGuid = 0x0)
		and ([RegionGuid] = @RegionGuid or @RegionGuid = 0x0)
		and ([CustomerGuid] = @CustGuid or @CustGuid = 0x0)
		and ([Area] between @Area1 and @Area2 or @Area2 = 0)
		and (
				([Area] = @Area1 and @Area2 = 0)
				or (@Area1 = 0)
				or (@Area1 <> 0 and @Area2 <> 0)
			)
		and ([TotalPrice] between @Price1 and @Price2 or @Price2 = 0)
		and (
				([TotalPrice] = @Price1 and @Price2 = 0)
				or (@Price1 = 0)
				or (@Price1 <> 0 and @Price2 <> 0)
			)

		and (
				([OfferType] = 1 and [OfferState] = 0 and @CkSale = 1 )
				or ([OfferType] = 0)
				Or ([OfferState] = 1)
				or (@CkSale <> 0)
			)

		and (
				([OfferType] = 1 and [OfferState] = 1 and @CkNotSale = 1 )
				or ([OfferType] = 0)
				Or ([OfferState] = 0)
				or (@CkNotSale <> 0)
			)

		-- 
		and (
				([OfferType] = 0 and [OfferState] = 0 and @CkLease = 1 )
				or ([OfferType] = 1)
				Or ([OfferState] = 1)
				or (@CkLease <> 0)
			)

		and (
				([OfferType] = 0 and [OfferState] = 1 and @CkNotLease = 1 )
				or ([OfferType] = 1)
				Or ([OfferState] = 0)
				or (@CkNotLease <> 0)
			)
		and ([Restrained] = 1 or @NotRestrained = 1)
		and ([Restrained] = 0 or @Restrained = 1)



GO

SET ANSI_NULLS, QUOTED_IDENTIFIER ON
GO

	Create View [vbApartmentOffer]
	 
	as
		Select 
			[T].*
		From
			[ApartmentOffer] [T]
			inner join [CurrentUsers] [U] on ([u].[Seclvl] >= Isnull([T].[SecLvl],0)  or [u].[Admin] = 1) and [u].[spid] = @@Spid
GO

SET ANSI_NULLS, QUOTED_IDENTIFIER ON
GO
Create Procedure [PrcCalcPrvContractGuid]
(
	@Kind int = 0, -- 0 all 1 flat 2 land 3 parking
	@ContractGuid uniqueidentifier = 0x0
)
 
as
	
	if (@Kind = 0 or @Kind = 1)
	begin
		ALTER TABLE [LeaseApartment] Disable TRIGGER [TRG_TraceContract_LeaseApartment]
		
		Update [LeaseApartment] 
		Set 
			[PrvContractGuid] = (Select Top 1
									Guid 
								from 
									[LeaseApartment] P 
								where 
									p.CustomerGuid = l.CustomerGuid
									and P.ApartmentGuid = l.ApartmentGuid
									and P.Guid <> l.Guid
								Order by
									FromDate desc
								)
		From
			[LeaseApartment] L
		where
			L.Guid = @ContractGuid or @ContractGuid = 0x0
			
		ALTER TABLE [LeaseApartment] ENABLE TRIGGER [TRG_TraceContract_LeaseApartment]
	end

	if (@Kind = 0 or @Kind = 2)
	begin
		ALTER TABLE [LandContract] Disable TRIGGER [TRG_Trace_LandContract]
		Update [LandContract]  
		Set 
			[PrvContractGuid] = (Select Top 1
									Guid 
								from 
									[LandContract] P 
								where 
									p.CustomerGuid = l.CustomerGuid
									and P.LandGuid = l.LandGuid
									and P.Guid <> l.Guid
								Order by
									FromDate desc
								)
		From
			[LandContract] L
		where
			L.Guid = @ContractGuid or @ContractGuid = 0x0
			
		ALTER TABLE [LandContract] Enable TRIGGER [TRG_Trace_LandContract]
	end

	if (@Kind = 0 or @Kind = 3)
	begin	
		ALTER TABLE [ParkingContract] Disable TRIGGER [TRG_Trace_ParkingContract]
		Update [ParkingContract]   
		Set 
			[PrvContractGuid] = (Select Top 1
									Guid 
								from 
									[ParkingContract]  P 
								where 
									p.CustomerGuid = l.CustomerGuid
									and P.ParkingGuid = l.ParkingGuid
									and P.Guid <> l.Guid
								Order by
									FromDate desc
								)
		From
			[ParkingContract]  L
		where
			L.Guid = @ContractGuid or @ContractGuid = 0x0
			
		ALTER TABLE [ParkingContract] Enable TRIGGER [TRG_Trace_ParkingContract]
	end
		

GO

SET ANSI_NULLS, QUOTED_IDENTIFIER ON
GO

Create View [vwTreeCost]
 
as
	Select
		[A].[Number], [A].[Guid], [A].[Code], [A].[ParentGuid], [A].[Note], [A].[LtnName],
		Case when (dbo.FnGetLangauge(@@spid) = 1) and (Isnull([A].[LtnName],'') <> '') then [A].[LtnName] else [A].[Name] end as [Name], 
		case when [A].[ParentGuid] is Not Null then [A].[ParentGuid] else 0x0 end as [Parent],
		(Select Count(*) From [Cost] where [ParentGuid] = [A].[Guid]) as [NSons], 
		Isnull([F].[Guid],0x0) as [FlatGuid],
		Isnull([K].[Guid],0x0) as [ParkingGuid],
		Isnull([p].[Guid],0x0) as [ShopGuid]
	From 
		[Cost] [A]
		left join [Apartment] [F] On [F].[CostGuid] = [A].[Guid]
		left join [Shop] [P] On [P].[CostGuid] = [A].[Guid]
		left join [Parking] [K] On [K].[CostGuid] = [A].[Guid]


GO

SET ANSI_NULLS, QUOTED_IDENTIFIER ON
GO

	Create View [vbComplaint]
	 
	as
		Select 
			[T].*
		From
			[Complaint] [T]
			inner join [CurrentUsers] [U] on ([u].[Seclvl] >= Isnull([T].[SecLvl],0)  or [u].[Admin] = 1) and [u].[spid] = @@Spid
GO

SET ANSI_NULLS, QUOTED_IDENTIFIER ON
GO

Create Procedure [dbo].[PrcUpdateLandContractWithDefaultType]
(
	@Date1 DateTime = '3/1/2011',
	@Date2 DateTime = '3/1/2012',
	@ActiveDate bit = 0,
	@Datewith int = 0,
	@Num1 int = 1,
	@Num2 int = 100,
	@ActiveNum bit = 1
)
 
as
	Alter Table [LandContract] Disable Trigger All
	
	update [LandContract]
	Set
		RevenueAccountGuid = Case when T.RevenueAccountGuid is Not Null then T.RevenueAccountGuid else L.RevenueAccountGuid end
		,AcCommissionFromCustGuid = Case when T.AcCommissionFromCustGuid is Not Null then T.AcCommissionFromCustGuid else L.AcCommissionFromCustGuid end
		,AcCommissionFromOwnerGuid = Case when T.AcCommissionFromOwnerGuid is Not Null then T.AcCommissionFromOwnerGuid else L.AcCommissionFromOwnerGuid end
		,AccountContractPrice = Case when T.AccountContractPriceGuid is Not Null then T.AccountContractPriceGuid else L.AccountContractPrice end
		,AccountCertificatValue = Case when T.AccountCertificatValueGuid is Not Null then T.AccountCertificatValueGuid else L.AccountCertificatValue end
		,FineAccount = Case when T.FineAccountGuid is Not Null then T.FineAccountGuid else L.FineAccount end
		,DiscountAccountGuid = Case when T.DiscountAccountGuid is Not Null then T.DiscountAccountGuid else L.DiscountAccountGuid end
		,OtherFeeAccountGUID = Case when T.TaxAccount is Not Null then T.TaxAccount else L.OtherFeeAccountGUID end
		--,InsuranceAccountGUID = Case when T.InsuranceAccountGuid is Not Null then T.InsuranceAccountGuid else L.InsuranceAccountGUID end
		,AcIncomNextYearGuid = Case when T.AcIncomNextYearGuid is Not Null then T.AcIncomNextYearGuid else L.AcIncomNextYearGuid end
	From
		[LandContract] L
		inner join [ContractType] T on T.Guid = L.TypeGuid
		inner join [Resource] R on R.Guid = L.TypeGuid and R.Spid = @@SPID
	where
		((L.number between @num1 and @Num2) or @ActiveNum = 0)
		and (
			(
				([L].[FromDate] between @Date1 and @Date2 and @Datewith = 0)
			)
			or
			(
				([L].[ToDate] between @Date1 and @Date2 and @Datewith = 1)
			)

			or
			(
				([L].[ContractFinishDate] between @Date1 and @Date2 and @Datewith = 2)
				and ([L].[ContractFinish] = 1)
			)

			or
			(
				([L].[EditDate] between @Date1 and @Date2 and @Datewith = 3)
			)
			or
			(
				([L].[AcquittancePrintdate] between @Date1 and @Date2 and @Datewith = 4)
			)

			or
			(
				([L].LeaveDate between @Date1 and @Date2 and @Datewith = 5)
			)
			or @ActiveDate = 0
		) 
		
		Alter Table [LandContract] Enable Trigger All


GO

SET ANSI_NULLS, QUOTED_IDENTIFIER ON
GO

Create Procedure [PrcTestRentFlatFromAccumulateFlat]
(
	@ContractGuid uniqueidentifier = 'EFAF9774-48B8-4680-BE63-6B3D9112271A',
	@FlatGuid uniqueidentifier = '90DBB8C2-DFC0-4E6F-86FD-0D8ECEC5E607',
	@Date1 DateTime = '1/1/2010',
	@Date2 DateTime = '10/1/2010'
)
 
as
	Select
		[L].*,
		Case when [ContractFinish] = 0 then [ToDate] else [ContractFinishDate]  end as [EndDate]
	into #Contract
	From
		[LeaseApartment] [L]
		inner join [AccumulateFlat] [A] on [A].[ParentGuid] = [L].[ApartmentGuid]
	where 
		([A].[FlatGuid] = @FlatGuid)		
		and ([L].[Guid] <> @ContractGuid)

--	Select * from #Contract
		
	Select 
		[L].[Number],
		[T].[Name] as [ContractName],
		[L].[FromDate],
		[L].[ToDate],
		[L].[Leasekind],
		[L].[ApartmentGuid],
		[L].[Guid]
	From 
		#Contract [L] 
		inner join [ContractType] [T] On [T].[Guid] = [L].[TypeGuid]
		inner join [AccumulateFlat] [A] on [A].[ParentGuid] = [L].[ApartmentGuid]
	where 
		([A].[FlatGuid] = @FlatGuid)		
		and 
		(
				(
					[Leasekind] = 2
					and	(
							([FromDate] <= @Date1 )
						 or ([FromDate] <= @Date2 )
						)
				)
				or 
				(
					[Leasekind] = 0
					and	([ContractFinish] = 0 )
				)

			)
			

GO

SET ANSI_NULLS, QUOTED_IDENTIFIER ON
GO
Create View vwRealty_LogCard
 
as
	Select
		L.*,
		u.LoginName as [UserName]
	From
		[Realty_LogCard] [L]
		inner join Realty_Users [U] on [U].Guid = [L].UserGuid

GO

SET ANSI_NULLS, QUOTED_IDENTIFIER ON
GO
Create Procedure [PrcProjectCost]
(
	@BuildingGuid Uniqueidentifier = '89D15C92-08F7-40F8-95E3-EBA38F4A1E7D'
)
 
as
	Declare @BuilAc Uniqueidentifier 
	Select @BuilAc = [AccountGuid] From [Building]
	where [Guid] = @BuildingGuid

	Print @BuilAc

	Declare @Tbl Table 
	(
		[AccountGuid] [Uniqueidentifier]
		,[Value] [Float]
		,[Note] [varchar] (256) COLLATE Arabic_CI_AI
		,[Date] DateTime
		,[Guid] [Uniqueidentifier]
		,[Account] [varchar] (256) COLLATE Arabic_CI_AI
		,[Kind] Int
	)

	Insert into @Tbl	
	Select 
		[P].[AccountGuid]
		,[P].[Value]
		,[P].[Note]
		,[P].[Date]
		,[P].[Guid]
		,[Ac].[Code]+'-'+[Ac].[Name] as [Account]  
		,0
	from 
		[ProjectCostDetail] [P]
		inner join [vwAccount] [ac] on [Ac].[Guid] = [AccountGuid]
	where 
		[P].[ParentGuid] = @BuildingGuid
	Order By 
		[P].[Number]

	Insert into @Tbl	
	Select 
		[D].[AcGuid]
		,Case when [D].[Debit] <> 0 then [D].[Debit] else - [D].[Credit] end
		,[D].[Note]
		,[E].[Date]
		,[E].[Guid]
		,[Ac].[Code]+'-'+[Ac].[Name] as [Account]  
		,1
	from 
		[HEntry] [E]
		inner join [DEntry] [D] On [E].[Guid] = [D].[ParentGuid]
		inner join [vwAccount] [ac] on [Ac].[Guid] = [D].[AcGuid]
		left join [ProjectCostDetail] [P] on [P].[Guid] = [E].[Guid]
	where 
		[D].[AcGuid] = @BuilAc
		and [P].[Guid] is Null

	Select * From @Tbl 
	Order By 
		[Date]


GO

SET ANSI_NULLS, QUOTED_IDENTIFIER ON
GO

	Create View [vbBill]
	 
	as
		Select 
			[T].*
		From
			[Bill] [T]
			inner join [CurrentUsers] [U] on ([u].[Seclvl] >= Isnull([T].[SecLvl],0)  or [u].[Admin] = 1) and [u].[spid] = @@Spid
GO

SET ANSI_NULLS, QUOTED_IDENTIFIER ON
GO

Create Procedure [PrcSetLastContractFlatRentPrice]
(
	@DateKind int = 0
)
 
as
	-- 
	Select 
		[ApartmentGuid],
		MAX(
			Case when @DateKind = 0 then FromDate
				 when @DateKind = 1 then ToDate
				 when @DateKind = 2 then editDate
			end
			) as Date
	into #LastContract
	From	
		[LeaseApartment] L
		inner join [ContractType] T on T.Guid = l.TypeGuid
		inner join [Resource] R on r.Guid = L.BuildingGuid and R.Kind = 99 
	where
		T.ContractKind = 0
	Group By
		[ApartmentGuid]
		
	
	insert into [ChangeFlatRent]
	([Number],[ParentGuid],[Date],[Price],[CurrencyGuid])
	Select
		(Select isNull(MAX(Number),0) + 1 From [ChangeFlatRent] where ParentGuid = L.ApartmentGuid),
		L.ApartmentGuid,
		C.Date,
		L.Rent,
		L.CurrencyGuid
	From
		[LeaseApartment] L
		inner join #LastContract C on L.ApartmentGuid = C.ApartmentGuid	 and 
		Case when @DateKind = 0 then L.FromDate
				 when @DateKind = 1 then L.ToDate
				 when @DateKind = 2 then L.editDate
		end 
		= C.Date
		
		left join [ChangeFlatRent] R on R.ParentGuid = l.ApartmentGuid and 
										R.Price = L.Rent and 
										L.CurrencyGuid = R.CurrencyGuid and 
										R.Date = C.Date
		
	where
		R.ParentGuid is Null

	Select @@ROWCOUNT as RC
	
	exec PrcSetLastFlatRentPrice 0x0
	

GO

SET ANSI_NULLS, QUOTED_IDENTIFIER ON
GO
Create View [vwContractParkingCachPayment]
 
as
	Select
		[C].[ContractGuid],
		[H].[HNumber] as [Number],
		[H].[DNumber],
		[H].[HDate] as [Date],
		isNull([H].[DCredit],0) + isNull([H].[DDebit],0) as [Value],
		[h].AcGuid,
		[H].[CurrencyGuid],
		[H].[CurrencyName] as [Currency],
		[H].[CurrencyVal],
		[H].[HNote],
		[H].[DNote],
		1 as [Print],
		[H].[HGuid] as [Guid]
	from 
		[ContractParkingCachPayment] [C]
		inner join [vwDetailEntry] [H] on [H].[HGuid] = [C].[EntryGuid]
		inner join ParkingContract L on L.CustAccountGuid = H.AcGuid and L.Guid = C.contractGuid
	where
		((isNull([H].[DCredit],0) + isNull([H].[DDebit],0) <> 0) and L.PayType = 0)
		or ((isNull([H].[DCredit],0)  <> 0) and L.PayType <> 0)


GO

SET ANSI_NULLS, QUOTED_IDENTIFIER ON
GO

	Create View [vbAssetsArea]
	 
	as
		Select 
			[T].*
		From
			[AssetsArea] [T]
			inner join [CurrentUsers] [U] on ([u].[Seclvl] >= Isnull([T].[SecLvl],0)  or [u].[Admin] = 1) and [u].[spid] = @@Spid
GO

SET ANSI_NULLS, QUOTED_IDENTIFIER ON
GO

	Create View [vbAssetsOperation]
	 
	as
		Select 
			[T].*
		From
			[AssetsOperation] [T]
			inner join [CurrentUsers] [U] on ([u].[Seclvl] >= Isnull([T].[SecLvl],0)  or [u].[Admin] = 1) and [u].[spid] = @@Spid
GO

SET ANSI_NULLS, QUOTED_IDENTIFIER ON
GO

CREATE Procedure PrcAddDate
(
	@Kind varchar(2) = 'm', 
	@inc int = 0, 
	@Date Datetime = '2/10/2016'
)
--RETURNS datetime
 
AS
--BEGIN
	Declare @RDate Datetime

	Declare @Hijridate int
	Select 
		@Hijridate = Value
	From
		dmd_Const where vName = 'Hijridate'

	if @Hijridate = 1
	begin
		if LOWER(@Kind) = 'm'
		Set @RDate = dbo.fnIncMonthHijriDate(@Date, @inc)
		if LOWER(@Kind) = 'y'
		Set @RDate = dbo.fnIncYearHijriDate(@Date, @inc)
	end
	else
	begin
		if LOWER(@Kind) = 'm'
		Set @RDate = dateadd(m ,@inc, @Date)
		if LOWER(@Kind) = 'y'
		Set @RDate = dateadd(y ,@inc, @Date)
	end

	if LOWER(@Kind) = 'wk'
	begin
		Set @RDate = dateadd(wk ,@inc, @Date)
	end
		
	Select @RDate, LOWER(@Kind)

--END

GO

SET ANSI_NULLS, QUOTED_IDENTIFIER ON
GO

Create Procedure [PrcVillaOffer]
(
	@ComplexName Varchar(256) = '',
	@Emirate Varchar(256) = '',
	@Area Varchar(256) = '',
	@Street Varchar(256) = '',
	@Suburb Varchar(256) = '',
	@PieceNo Varchar(256) = '',
	@BasinNo Varchar(256) = '',
	@VillaNo Varchar(256) = '',
	@Customer Varchar(256) = '',
	@OfferKind int = 3,
	@OfferValue1 Float = 0,
	@OfferValue2 Float = 0,
	@Delegated VARCHAR(256) = '',
	@CustPhone VARCHAR(256) = '',
	@CustMobile VARCHAR(256) = ''
)
 
as
	Select 
		*,
		Case when OfferKind = 0 then ''
			 when OfferKind = 1 then ''
			 when OfferKind = 2 then ''
		end as OfferKindStr
	From 
		[VillaOffer]
	where
		([ComplexName] Like '%'+@ComplexName +'%')
		and ([Emirate] Like '%'+@Emirate +'%')
		and ([Area] Like '%'+@Area +'%')
		and ([Street] Like '%'+@Street +'%')
		and ([Suburb] Like '%'+@Suburb +'%')
		and ([PieceNo] Like '%'+@PieceNo +'%')
		and ([BasinNo] Like '%'+@BasinNo +'%')
		and ([VillaNo] Like '%'+@VillaNo +'%')
		and ([Customer] Like '%'+@Customer +'%')
		and ([OfferKind] = @OfferKind or @OfferKind = 3)
		and ([OfferValue] between @OfferValue1 and  @OfferValue2 or @OfferValue2 = 0)
		and ([Delegated] Like '%'+@Delegated +'%')
		and ([CustPhone] Like '%'+@CustPhone +'%')
		and ([CustMobile] Like '%'+@CustMobile +'%')


GO

SET ANSI_NULLS, QUOTED_IDENTIFIER ON
GO

Create Procedure [PrcAccountBalance]
(
	@Guid uniqueidentifier = 0x0
)
 
as
	Select 
		Sum([Debit]* [CurrencyVal] - [Credit]*[CurrencyVal]) as [Balance]
	From 
		[DEntry]
	where
		[ACGuid] = @Guid Or @Guid = 0x0

GO

SET ANSI_NULLS, QUOTED_IDENTIFIER ON
GO

Create Procedure [PrcChangeFlatCost]
(
	@BuildingGuid uniqueidentifier = 0x0
	,@NewUnitCost Float = 100
	,@RoundKind int  = 0
)
 
as
	update [Apartment] Set [CostPrice] = dbo.FnMyRound(([Area] * @NewUnitCost), @RoundKind)
	where 
		([BuildingGuid] = @BuildingGuid or @BuildingGuid = 0x0) 
		and [Area] <> 0

	Select @@RowCount as [RowCount]


GO

SET ANSI_NULLS, QUOTED_IDENTIFIER ON
GO

	Create View [vbLawsuit]
	 
	as
		Select 
			[T].*
		From
			[Lawsuit] [T]
			inner join [CurrentUsers] [U] on ([u].[Seclvl] >= Isnull([T].[SecLvl],0)  or [u].[Admin] = 1) and [u].[spid] = @@Spid
GO

SET ANSI_NULLS, QUOTED_IDENTIFIER ON
GO

Create Procedure [PrcChangeCostMovment]
(
	@CostGuid1 uniqueidentifier = 0x0,
	@CostGuid2 uniqueidentifier = 0x0,
	@Date1 DateTime = '1/1/2007',
	@Date2 DateTime = '1/1/2010'
)
 
as
	Declare @RC int

	--------
	Update [Dentry] 
	Set [CostGuid] = @CostGuid2
	From 
		[Dentry]  [D]
		inner join [HEntry] [H] On [D].[ParentGuid] = [H].[Guid]
	where
		[CostGuid] = @CostGuid1
		and ([H].[Date] Between @Date1 And @Date2)

	Select @RC = isnull(@@RowCount,0)

	--------
	Update [Secondary_EntryDetail] 
	Set [CostGuid] = @CostGuid2
	From
		[Secondary_EntryDetail] [D]
		inner join [Secondary_Entry] [H] On [D].[ParentGuid] = [H].[Guid]
	where
		[CostGuid] = @CostGuid1
		and ([H].[Date] Between @Date1 And @Date2)

	Select @RC = @RC + isnull(@@RowCount,0)


	Select @RC as [Count]

GO

SET ANSI_NULLS, QUOTED_IDENTIFIER ON
GO

Create Procedure [PrcPrintFlatParkingContract]
(
	@FlatContractGuid uniqueidentifier = 0x0
)
 
as
	Select 
		dbo.fnDate(GetDate()) as [NowDate],
		[A].[Number],
		[A].[ContractNo],
		[C].[ArName] as [CustArName],
		[C].[LtnName] as [CustLtnName],
		[C].[Address] as [CustomerAddress],
		[C].[Nationality] as [CustomerNationality],
		[C].[PassportNO] as [CustomerPassportNO], 
		[C].[Profession] as [CustomerProfession],
		[C].[Domicile] as [CustomerDomicile],
		[C].[Security] as [CustomerSecurity],
		[C].[MemoSecurity] as [CustomerMemoSecurity],
		[C].[BoxNo] as [CustomerBoxNo],
		[C].[PersonalityNo1] as [CustomerPersonalityNo1],
		[C].[PersonalityNo2] as [CustomerPersonalityNo2],
		[C].[Adjective]as [CustomerAdjective],
		[C].[Fax]	as [CustomerFax],
		[C].[Email]	as [CustomerEmail],
		[C].[PhoneJob]	as [CustomerPhoneJob],
		[C].[Mobile]	as [CustomerMobile],

		[C].[PassportNO] as [CustomerPassportNO],
		dbo.fnDate([C].[PassportExpireDate]) as [CustomerPassportExpireDate],	

		[B].[Name] as [BuildingarName],
		[B].[LtnName] as [BuildingLtnName],
		[P].[No],
		[B].[Emirate],
		[B].[Suburb],
		[B].[Area],
		[B].[Street],
		[B].[BuildingNo],
		[B].[BondType] as [BuildingBondType],
		[B].[BondNo] as [BuildingBondNo],
		dbo.fnDate([B].[BondDate]) as [BuildingBondDate],
		
		[B].[LtnEmirate],
		[B].[LtnArea],
		[B].[LtnSuburb],
		[B].[LtnStreet],

        [A].[RentDuration],
        [A].[Rentype],
        [A].[TermsOfPayment],
		[A].[Rent] as [Value],
		[My].[Code] as [Currency],
		dbo.fnDate([FromDate]) as [FromDate],
		dbo.fnDate([ToDate]) as [ToDate],
		[A].[Note],
		[A].[Note2],
		
		[A].[CarNo],
		[A].[CarType],
		[A].[CarColor],
		[A].[Emirate],

	    [R].[Name] as [Rent_Name],
	    [R].[LtnName] as [Rent_LtnName],
	    [R].[Adjective]  as [Rent_Adjective],
	    [R].[Nationality]  as [Rent_Nationality],
	    [R].[Work]  as [Rent_Work],
	    [R].[PersonalityNo]   as [Rent_PersonalityNo],
		[R].[WorkCardNo]   as [Rent_CardNo],
	    [R].[Address]  as [Rent_Address],
	    [R].[Phone]  as [Rent_Phone],
	    [R].[Mobile]  as [Rent_Mobile],
	    [R].[BoxNo]  as [Rent_BoxNo],
		[R].[Fax]  as [Rent_FaxNo],
	    [R].[EMail]  as [Rent_EMail],
		
		[R].[PassportNO] as [Rent_PassportNO],
		dbo.fnDate([R].[PassportExpireDate]) as [Rent_PassportExpireDate],	

		[A].[License1No],
		[A].[License2No],
		[A].[License3No],
		[A].[License1Date1],
		[A].[License2Date1],
		[A].[License3Date1],
		[A].[License1Date2],
		[A].[License2Date2],
		[A].[License3Date2],

		[A].[LtnRentDuration],
		[A].[LtnRentype],
		[A].[LtnTermsOfPayment],

		[A].[Guid]
	from 
		[ParkingContract] [A]
		inner join [LinkParkingContract] L on L.ParkingContractGuid = A.Guid and L.ParentGuid = @FlatContractGuid
		left join [vwBuilding] [B] On [A].[BuildingGuid] = [B].[Guid]
		left join [vwParking] [P] on [P].[Guid] = [A].[ParkingGuid]
		left join [vwCustomer] [C] on [C].[Guid] = [A].[CustomerGuid]
		left join [vwCurrency] [My] on [My].[Guid] = [A].[CurrencyGuid]
		left join [RentInfo] [R] on [R].[Guid] = [A].[RentInfoGuid]
	Order By
		[A].EditDate, A.Number


GO

SET ANSI_NULLS, QUOTED_IDENTIFIER ON
GO

Create Procedure [PrcPrintMainEntry]
(
	@Guid uniqueidentifier = 0x0,

	@TotalDebit Float = 50,
	@TotalCredit Float = 400,

	@OnlyTotalDebit Varchar(256) = '',
	@OnlyTotalCredit Varchar(256) = ''
)
 
as
	Select 
		[S].[Number],
		[S].[SecLvl],
		[S].[Date],
		CONVERT(nchar, [S].[Date], 131) as [HijriDate],
		[S].[Note],
		[my].[Code] as [Currency],
		[S].[CurrencyVal],

		@TotalDebit as [TotalDebit],
		@TotalCredit as [TotalCredit],

		@OnlyTotalDebit as [OnlyTotalDebit],
		@OnlyTotalCredit as [OnlyTotalCredit],

		(Select Top 1 [UserName] From vwRealty_LogCard where CardGuid = [S].Guid order by Date) as [CreateByUser],
		(Select Top 1 [Date] From vwRealty_LogCard where CardGuid = [S].Guid order by Date) as [CreateDate],
		(Select Top 1 [UserName] From vwRealty_LogCard where CardGuid = [S].Guid order by Date desc) as [LastUpdateByUser],
		(Select Top 1 [Date] From vwRealty_LogCard where CardGuid = [S].Guid order by Date desc) as [LastUpdateDate]

	From 
		[HEntry] [S]
		left join [vwCurrency] [My] On [My].[Guid] = [S].[CurrencyGuid]
	where
		[S].[Guid] = @Guid Or @Guid = 0x0

	Select
		[S].[Number],
		[S].[ParentGuid],
		[ac].[code]+'-'+[Ac].[Name] as [Account],
		[S].[Debit],
		[S].[Credit],
		[my].[Code] as [Currency],
		[S].[CurrencyVal],
		[ac2].[code]+'-'+[Ac2].[Name] as [ObverseAccount],
		[co].[code]+'-'+[co].[Name] as [Cost],
		[S].[Note]
	From	
		[DEntry] [S]
		left join [vwaccount] [ac] on [ac].[Guid] = [S].[AcGuid]
		left join [vwaccount] [ac2] on [ac2].[Guid] = [S].[ObverseAcGuid]
		left join [vwCurrency] [My] On [My].[Guid] = [S].[CurrencyGuid]
		left join [vwCost] [co] On [co].[Guid] = [S].[CostGuid]
	where
		[S].[ParentGuid] = @Guid Or @Guid = 0x0
	Order By
		[S].[Number]

GO

SET ANSI_NULLS, QUOTED_IDENTIFIER ON
GO

	Create View [vbIncomeSaved]
	 
	as
		Select 
			[T].*
		From
			[IncomeSaved] [T]
			inner join [CurrentUsers] [U] on ([u].[Seclvl] >= Isnull([T].[SecLvl],0)  or [u].[Admin] = 1) and [u].[spid] = @@Spid
GO

SET ANSI_NULLS, QUOTED_IDENTIFIER ON
GO
Create View [vwMaintenanceContractCachPayment]
 
as
	Select
		[C].[ContractGuid],
		[H].[HNumber] as [Number],
		S.Number as [RecieptVoucherNumber],
		[H].[DNumber],
		[H].[HDate] as [Date],
		[H].[DCredit] as [Value],
		[H].[CurrencyGuid],
		[H].[CurrencyName] as [Currency],
		[H].[CurrencyVal],
		[H].[HNote],
		[H].[DNote],
		[h].AcGuid,
		(Select Number from Secondary_Entry where Guid = [C].[EntryGuid] ) as SNumber,
		1 as [Print],
		[H].[HGuid] as [Guid]
	from 
		[MaintenanceContractCachPayment] [C]
		inner join [vwDetailEntry] [H] on [H].[HGuid] = [C].[EntryGuid] 
		left join Secondary_Entry S on S.Guid = H.[HGuid]
		inner join MaintenanceContract L on L.CustAccountGuid = H.AcGuid and L.Guid = C.contractGuid
	where
		[H].[DCredit] <> 0


GO

SET ANSI_NULLS, QUOTED_IDENTIFIER ON
GO

	Create View [vbOfferPrice]
	 
	as
		Select 
			[T].*
		From
			[OfferPrice] [T]
			inner join [CurrentUsers] [U] on ([u].[Seclvl] >= Isnull([T].[SecLvl],0)  or [u].[Admin] = 1) and [u].[spid] = @@Spid
GO

SET ANSI_NULLS, QUOTED_IDENTIFIER ON
GO
Create View vwMaintenanceOrder
 
as
	Select
		O.*,
		Case when OrderState = 0 then dbo.SC(' ')
			 when OrderState = 1 then dbo.SC(' ')
			 when OrderState = 2 then dbo.SC('  ')
		end as OrderStateStr,
		
		Case when repitition = 0 then dbo.SC(' ')
			 when repitition = 1 then dbo.SC('  ')
		end as repititionStr,
		w.Name as [MaintenanceWorker],
		w.ltnName as [MaintenanceWorkerLtnName],
		w.Mobile as [WorkerMobile],
		[C].[BuildingGuid],
		[C].[No] as [ComplaintNo],
		[C].[Date] as [ComplaintDate],
		[C].[Note] as [ComplaintNote],
		[C].[CustName],
		[C].[CustArName],
		[C].[CustLtnName],
		[C].[CustomerAddress],
		[C].[CustomerNationality],
		[C].[CustomerProfession],
		[C].[CustomerDomicile],
		[C].[CustomerSecurity],
		[C].[CustomerMemoSecurity],
		[C].[CustomerBoxNo],
		[C].[CustomerPersonalityNo1],
		[C].[CustomerPersonalityNo2],
		[C].[CustomerAdjective],
		[C].[CustomerFax],
		[C].[CustomerPhoneJob],
		[C].[CustomerMobile],
		[C].[CustomerEmail],
		[C].[CustomerPassportNO],
		[C].[CustomerPassportExpireDate],
		[C].[BuildingName],
		[C].[BuildingarName],
		[C].[BuildingLtnName],
		[C].[Emirate],
		[C].[Suburb],
		[C].[Area],
		[C].[Street],
		[C].[BuildingNo],
		[C].[BuildingBondType],
		[C].[BuildingBondNo],
		[C].[BuildingBondDate],
		[C].[LtnEmirate],
		[C].[LtnArea],
		[C].[LtnSuburb],
		[C].[LtnStreet],
		[C].[PieceNo],
		[C].[BasinNo],
		[C].[RealtyNo],
		BuildingName+'/'+RealtyNo as BuildingName_RealtyNo,
		[C].[FloorNo],
		[C].[CustGuid],
		[C].RealtyGuid,
		[C].[RealtyKind]
	From
		[MaintenanceOrder] O
		inner join [vwComplaint] C on C.Guid = O.ComplaintGuid
		left join [vwMaintenanceWorker] W on w.Guid = O.MaintenanceWorkerGuid
		
		

GO

SET ANSI_NULLS, QUOTED_IDENTIFIER ON
GO

Create Procedure [PrcMaintenanceOrder]
(
	@No Varchar(256) = '',
	@CustGuid uniqueidentifier = 0x0,
	@FlatGuid uniqueidentifier = 0x0,
	@OrderState int = 3,
	@MaintenanceWorkerGuid uniqueidentifier = 0x0,
	@delay1 int = 0,
	@delay2 int = 0,
	@repitition int = 2,
	@Datewith int = 2,
	@ActiveBuildingList Bit = 1,
	@ActiveDate Bit = 0,
	@Date1 DateTime = '1/1/2007',
	@Date2 DateTime = '1/1/2016',
	@RealtyKind int = 6
)
 
as
	Select 
		M.* 
	From 
		[vwMaintenanceOrder] M
		left join vwBuilding B on M.BuildingGuid = B.Guid
		left join [Resource] [R] on [R].[Guid] = M.BuildingGuid and [R].[Kind] = 94 and [R].[Spid] = @@Spid 
	where
		(M.No = @No or @No = '')
		and ([M].CustGuid = @CustGuid or @CustGuid = 0x0)
		and (M.RealtyGuid = @FlatGuid or @FlatGuid = 0x0)
		and (M.RealtyKind = @RealtyKind or @RealtyKind = 6)
		and ([M].OrderState = @OrderState or @OrderState = 3)
		and ([M].[MaintenanceWorkerGuid] = @MaintenanceWorkerGuid or @MaintenanceWorkerGuid = 0x0)
		and ([M].[Delay] between @delay1 and @delay2 or @delay2 = 0)
		and ([M].[Repitition] = @repitition or @repitition = 2)
		and (M.StartDate between @Date1 and @Date2 or @Datewith = 1  or @Datewith = 2 or @ActiveDate = 0)
		and (M.CloseDate between @Date1 and @Date2 or @Datewith = 0  or @Datewith = 2 or @ActiveDate = 0)
		and (M.EndExpectedDate between @Date1 and @Date2 or @Datewith = 0  or @Datewith = 1 or @ActiveDate = 0)
		and ([R].[Guid] Is Not Null or @ActiveBuildingList = 0 )

GO

SET ANSI_NULLS, QUOTED_IDENTIFIER ON
GO

CREATE FUNCTION [fnIncYearHijriDate] (@Date Datetime, @IncM int)
RETURNS Datetime  AS
BEGIN
	Declare @R Datetime

	Declare @S varchar(256)
	Declare @Hy int
	Declare @Hm int
	Declare @Hd int

	Set @S = Convert(Varchar(256), @date , 131)

	Set @Hy = SUBSTRING (@S, 7, 4)
	Set @Hm = SUBSTRING (@S, 4, 2)
	Set @Hd = SUBSTRING (@S, 1, 2)

	Set @hd = Replace(@hd,' ','0')
	Set @hm = dbo.FnFormatNumber(@hm, 2)
	Set @hd = dbo.FnFormatNumber(@hd, 2)

	Set @Hy = @Hy + @IncM
	
	RETURN dbo.fnDecodeHijriDatetoGergDate(@hy, @hm, @hd)

END

GO

SET ANSI_NULLS, QUOTED_IDENTIFIER ON
GO

Create Trigger [TRG_Trace_ChangeCurrencyRate]
on [ChangeCurrencyRate]
 
for update
As
	SET NOCOUNT ON;
	if Not exists(Select Value from DMD_const where vName = 'ActiveLogCardUpdate' and Value = '1' ) return
	
	Declare @UserGuid uniqueidentifier, @Guid uniqueidentifier
	Set @Guid = NEWID()
	
	Select Top 1 @UserGuid = userGuid From CurrentUsers where Spid = @@SPID
			
	insert into [Trace]
	([Guid],[ParentGuid],[Date],[userGuid],[HostName],ParentTbl )
	Select Top 1
		@Guid,
		N.Guid,
		GETDATE(),
		@UserGuid,
		Host_Name(),
		'ChangeCurrencyRate'
	From
		[inserted] n 
		
	insert into [TraceDetail]
	([ParentGuid],[Caption],[Old],[New],[Tbl])
	Select Top 1
		@Guid,
		' ' as [Caption],
		D.[SecLvl] as [old],
		N.[SecLvl] as [New],
		''
	From
		[deleted] d
		inner join [inserted] n on D.Guid = N.Guid
	where
		N.[SecLvl] <> D.[SecLvl]
		
	insert into [TraceDetail]
	([ParentGuid],[Caption],[Old],[New],[Tbl])
	Select Top 1
		@Guid,
		'' as [Caption],
		dbo.fnDate(D.[Date]) as [old],
		dbo.fnDate(N.[Date]) as [New],
		''
	From
		[deleted] d
		inner join [inserted] n on D.Guid = N.Guid
	where
		N.[Date] <> D.[Date]
		
	insert into [TraceDetail]
	([ParentGuid],[Caption],[Old],[New],[Tbl])
	Select Top 1
		@Guid,
		'' as [Caption],
		D.[CurrencyGUID] as [old],
		N.[CurrencyGUID] as [New],
		'[Currency]'
	From
		[deleted] d
		inner join [inserted] n on D.Guid = N.Guid
	where
		N.[CurrencyGUID] <> D.[CurrencyGUID]
		
	insert into [TraceDetail]
	([ParentGuid],[Caption],[Old],[New],[Tbl])
	Select Top 1
		@Guid,
		'' as [Caption],
		D.[Rate] as [old],
		N.[Rate] as [New],
		''
	From
		[deleted] d
		inner join [inserted] n on D.Guid = N.Guid
	where
		N.[Rate] <> D.[Rate]
		
	insert into [TraceDetail]
	([ParentGuid],[Caption],[Old],[New],[Tbl])
	Select Top 1
		@Guid,
		'' as [Caption],
		D.[Note] as [old],
		N.[Note] as [New],
		''
	From
		[deleted] d
		inner join [inserted] n on D.Guid = N.Guid
	where
		N.[Note] <> D.[Note]
		
	delete Trace From Trace t left join [TraceDetail] D on T.guid = D.ParentGuid
	where
		d.ParentGuid is Null and t.Guid = @Guid


GO

SET ANSI_NULLS, QUOTED_IDENTIFIER ON
GO

CREATE FUNCTION FnFormatDate (@Date Datetime)
RETURNS Varchar(256)
 
AS
BEGIN
	Declare @Format Varchar(256)
	Set @Format = (Select Value from DMD_const where VName = 'DateFormat')
	
	if @Format is Null Set @Format = 'dd/mm/yyyy'
	
	Declare @R Varchar(256)
			,@Y Varchar(256)
			,@m Varchar(256)
			,@d Varchar(256)


	Select Top 1 
		@D = (DATEPart(DAY, @Date)),
		@M = (DATEPart(Month, @Date)),
		@y = (DATEPart(YEAR, @Date))


	Set @m = dbo.FnFormatNumber(@m, 2)
	Set @d = dbo.FnFormatNumber(@d, 2)
	
	Set @R = @Format
	
	Set @R = REPLACE(@R, UPPER('dd'), Cast(@d as varchar(256)))
	Set @R = REPLACE(@R, UPPER('mm'), Cast(@m as varchar(256)))
	Set @R = REPLACE(@R, UPPER('m'), Cast(@m as varchar(256)))
	Set @R = REPLACE(@R, UPPER('yyyy'), Cast(@Y as varchar(256)))
	Set @R = REPLACE(@R, UPPER('yy'), Cast(@Y as varchar(256)))
	
	RETURN @r

END

GO

SET ANSI_NULLS, QUOTED_IDENTIFIER ON
GO

Create Procedure PrcCalcMaxGroupcode
(
	@Guid uniqueidentifier = '397500C4-638D-4169-8D40-2F017AB33582'
)
 as
	Declare @LenCode int
	Set @LenCode = (Select Len([Code]) From MatGroup where [Guid] = @Guid)

	Declare @Code Varchar(20)
	Set @Code = (Select [Code] From MatGroup where [Guid] = @Guid)
	

	Declare @LenNewCode int
	Set @LenNewCode = (
						Select 
							Len(Max([Code])) 
						From 
							[Mat] where GroupGuid =@Guid	
					) - @LenCode

	--Select @Code as Code, @LenCode as LenCode, @LenNewCode as LenNewCode
	
	if ISNULL(@LenNewCode, 0) = 0 Set @LenNewCode = 1

--	Select 
--			dbo.FnFormatNumber(Right(Cast(RIGHT(Max([Code]), Len(Max([Code])) - @LenCode)as int)+1 , @LenNewCode), @LenNewCode)
--	From [MatGroup] where ParentGuid =@Guid	
	 
	Declare @mxCode varchar(255)
	Set @mxCode = '' 
	select
		@mxCode = 
		Case when ISNUMERIC( RIGHT(Max([Code]), Len(Max([Code])) - @LenCode)) = 0
		then RIGHT(Max([Code]), Len(Max([Code])) - @LenCode)
		end
	From 
		Mat
	where 
		[GroupGuid]  = @Guid	
	
	Declare @Ms Varchar(256)
	Set @Ms = dbo.SC('      ') + '  ' + @mxCode

	if ISNULL(@mxCode,'') <> ''
	begin
		RAISERROR (@Ms, 16, 1)
		return
	end
	 
	Select 
		@Code + 
		ISNULL(
		Cast(
				dbo.FnFormatNumber(
									Right(Cast(RIGHT(Max([Code]), Len(Max([Code])) - @LenCode)as int)+1 , 
									@LenNewCode), @LenNewCode) as Varchar(256
								  )
			), '01') as [Code]
	From 
		[Mat] 
	where 
		[GroupGuid] = @Guid	

GO

SET ANSI_NULLS, QUOTED_IDENTIFIER ON
GO

Create Procedure [PrcSaveRepSMS]
(
	@ObjGuid uniqueidentifier = '40C85B71-F3C0-46AA-9303-8C3FA449073F',
	@UserGuid uniqueidentifier = '0F15DFA3-0F8C-4A56-A831-21BB87498F07',
	@IsCheck bit = 1,
	@RepId int = 3000
)
 
as
	Delete [RepSMS]
	where
		[ObjGuid] = @ObjGuid
		and [IdReport] = @RepId
		and [UserGuid] = @UserGuid

	if @IsCheck = 1
	begin
		insert into [RepSMS]
		(
			[ObjGuid],
			[UserGuid],
			[IdReport],
			[date]
		)
		Select
			@ObjGuid,
			@UserGuid,
			@RepId,
			GetDate()
	end


GO

SET ANSI_NULLS, QUOTED_IDENTIFIER ON
GO

Create Procedure [PrcSaveRepSMSCount]
(
	@ObjGuid uniqueidentifier = '40C85B71-F3C0-46AA-9303-8C3FA449073F',
	@UserGuid uniqueidentifier = '0F15DFA3-0F8C-4A56-A831-21BB87498F07',
	@IsCheck bit = 1,
	@RepId int = 3000
)
 
as
	if @IsCheck = 1
	begin
		insert into [RepSMSCount]
		(
			[ObjGuid],
			[UserGuid],
			[IdReport],
			[date]
		)
		Select
			@ObjGuid,
			@UserGuid,
			@RepId,
			GetDate()
	end


GO

SET ANSI_NULLS, QUOTED_IDENTIFIER ON
GO

	Create View [vbMaintenanceContractVisit]
	 
	as
		Select 
			[T].*
		From
			[MaintenanceContractVisit] [T]
			inner join [CurrentUsers] [U] on ([u].[Seclvl] >= Isnull([T].[SecLvl],0)  or [u].[Admin] = 1) and [u].[spid] = @@Spid
GO

SET ANSI_NULLS, QUOTED_IDENTIFIER ON
GO

CREATE FUNCTION [FnMonth] (@Date Datetime)
RETURNS int  
AS
BEGIN
	Declare @R Varchar(256)
			,@Y Varchar(256)
			,@m Varchar(256)
			,@d Varchar(256)

	Set @R = ''

	Declare @Hijridate int
	Select 
		@Hijridate = Value
	From
		dmd_Const where vName = 'Hijridate'

	if @Hijridate = 1
	begin
		Set @R = Convert(Varchar(256), @Date , 131)
	
		Set @Y = SUBSTRING (@R, 7, 4)
		Set @m = SUBSTRING (@R, 4, 2)
		Set @d = SUBSTRING (@R, 1, 2)
	end
	else
	begin
		Set @R = Convert(Varchar(256), @Date , 101)
	
		Set @Y = SUBSTRING (@R, 7, 4)
		Set @d = Replace(SUBSTRING (@R, 4, 2),' ','0')
		Set @m = SUBSTRING (@R, 1, 2)
	end

	Set @d = Replace(@d,' ','0')
	
	RETURN @m

END

GO

SET ANSI_NULLS, QUOTED_IDENTIFIER ON
GO

	Create View [vbOrderType]
	 
	as
		Select 
			[T].*
		From
			[OrderType] [T]
			inner join [CurrentUsers] [U] on ([u].[Seclvl] >= Isnull([T].[SecLvl],0)  or [u].[Admin] = 1) and [u].[spid] = @@Spid
GO

SET ANSI_NULLS, QUOTED_IDENTIFIER ON
GO

Create Procedure [PrcTreeIncAccount]
(
	@AcGuid uniqueidentifier = 0x0
)

as
	Declare @Level int
	Set @Level = Case when @AcGuid = 0x0 then 0 else 3 end

	Create Table #Res 
	(
		[Number] int, 
		[Guid] uniqueidentifier, 
		[Type] int, 
		[Code] Varchar(256), 
		[Name] Varchar(256), 
		[LtnName] Varchar(256), 
		[ParentGuid]uniqueidentifier,
		[Path]  Varchar(256)
	)

	insert into #Res
	Select
		[A].[Number], 
		[A].[Guid], 
		1 as [Type], 
		[A].[Code], 
		Case when (dbo.FnGetLangauge(@@spid) = 1) and (Isnull([A].[LtnName],'') <> '') then [A].[LtnName] else [A].[Name] end as [Name], 
		[A].[LtnName],
		case when [A].[ParentGuid] is Not Null then [A].[ParentGuid] else 0x0 end as [Parent],
		[F].[Path]
	From 
		[vbIncAccount] [A]
		inner join [dbo].[fnGetIncAccountList](@AcGuid) [F] on [F].[Guid] = [A].[Guid]


	CREATE INDEX IXS_Guid ON #Res ([Guid])
	-----------------------------------------------------------------------------------

	Select 
		*
		,Len([Path]) / 9 as [level]
	from 
		#Res

	ORDER BY [Path], [Type], [Code]

GO

SET ANSI_NULLS, QUOTED_IDENTIFIER ON
GO

Create Function dbo.fnGetCountDayofYear()
RETURNS Float
 AS
BEGIN

	Declare @Hijridate int, @R Float
	Select 
		@Hijridate = Value
	From
		dmd_Const where vName = 'Hijridate'
	
	
	Set @R = (Select case when isNull(@Hijridate,0) = 0 then 365.00 else 355.00 end)
	
	return @R
end

GO

SET ANSI_NULLS, QUOTED_IDENTIFIER ON
GO

Create Trigger [TRG_Trace_QtyGroup]
on [QtyGroup]
 
for update
As
	SET NOCOUNT ON;
	if Not exists(Select Value from DMD_const where vName = 'ActiveLogCardUpdate' and Value = '1' ) return
	
	Declare @UserGuid uniqueidentifier, @Guid uniqueidentifier
	Set @Guid = NEWID()
	
	Select Top 1 @UserGuid = userGuid From CurrentUsers where Spid = @@SPID
			
	insert into [Trace]
	([Guid],[ParentGuid],[Date],[userGuid],[HostName],[ParentTbl] )
	Select Top 1
		@Guid,
		N.Guid,
		GETDATE(),
		@UserGuid,
		Host_Name(),
		'QtyGroup'
	From
		[inserted] n 
		
	insert into [TraceDetail]
	([ParentGuid],[Caption],[Old],[New],[Tbl])
	Select Top 1
		@Guid,
		' ' as [Caption],
		D.[SecLvl] as [old],
		N.[SecLvl] as [New],
		''
	From
		[deleted] d
		inner join [inserted] n on D.Guid = N.Guid
	where
		N.[SecLvl] <> D.[SecLvl]
		
	insert into [TraceDetail]
	([ParentGuid],[Caption],[Old],[New],[Tbl])
	Select Top 1
		@Guid,
		'' as [Caption],
		D.[GroupGuid] as [old],
		N.[GroupGuid] as [New],
		'MatGroup'
	From
		[deleted] d
		inner join [inserted] n on D.Guid = N.Guid
	where
		N.[GroupGuid] <> D.[GroupGuid]
		
	insert into [TraceDetail]
	([ParentGuid],[Caption],[Old],[New],[Tbl])
	Select Top 1
		@Guid,
		' ' as [Caption],
		D.[CalcQtyGuid] as [old],
		N.[CalcQtyGuid] as [New],
		'CalcQty'
	From
		[deleted] d
		inner join [inserted] n on D.Guid = N.Guid
	where
		N.[CalcQtyGuid] <> D.[CalcQtyGuid]
		
	insert into [TraceDetail]
	([ParentGuid],[Caption],[Old],[New],[Tbl])
	Select Top 1
		@Guid,
		'' as [Caption],
		D.[Note] as [old],
		N.[Note] as [New],
		''
	From
		[deleted] d
		inner join [inserted] n on D.Guid = N.Guid
	where
		N.[Note] <> D.[Note]
		
	delete Trace From Trace t left join [TraceDetail] D on T.guid = D.ParentGuid
	where
		d.ParentGuid is Null and t.Guid = @Guid


GO

SET ANSI_NULLS, QUOTED_IDENTIFIER ON
GO

Create View [vwCurrency]
 
as
	SELECT 
		[Number], 
		[Guid], 
		[Seclvl],
		Case when (dbo.FnGetLangauge(@@spid) = 1) and (Isnull([LtnName],'') <> '') then [LtnName] else [Name] end as [Name] , 
		Case when (dbo.FnGetLangauge(@@spid) = 1) and (Isnull([LtnCode],'') <> '') then [LtnCode] else [Code] end as [Code] , 
		[Name] [ArName], 
		[LtnName], 
		[CurrencyVal], 
		[CurrencyRate], 
		[Note], 
		[LtnCode],
		Case when (dbo.FnGetLangauge(@@spid) = 1) and (Isnull([EnPartName],'') <> '') then [EnPartName] else [ArPartName] end as [PartName] , 
		[EnPartName],
		[ArPartName],
		[Part],
		
		Case when isNull([OnlyName], '') = '' then Name else [OnlyName] end as [OnlyName],
		Case when isNull([OnlyPluralName], '') = '' then Name else [OnlyPluralName] end as [OnlyPluralName],
		[OnlyByCountryName],
		Case when isNull(OnlyPartPlularName,'') = '' then [ArPartName] else [OnlyPartPlularName] end as [OnlyPartPlularName],
		Case when isNull([OnlyLtnName],'') = '' then LtnName else [OnlyLtnName] end as [OnlyLtnName],
		Case when isNull([OnlyPluralLtnName],'') = '' then LtnName else [OnlyPluralLtnName] end as [OnlyPluralLtnName],
		[OnlyByCountryLtnName],
		[OnlyPartPlularLtnName]
	FROM 
		[vbCurrency]

GO

SET ANSI_NULLS, QUOTED_IDENTIFIER ON
GO

Create Procedure [dbo].[PrcAddIncAccountDetail]
(
	@ParentGuid uniqueidentifier = 'D5189137-88E3-457F-9CF4-1579E1E7983D',
	@Guid uniqueidentifier = 'DF3F6DCD-17B0-46D9-9893-84CD2A0EFB18'
)
 
AS
	Set NoCount on
	Declare 
		@S Varchar(256),
		@P_IncName Varchar(256),
		@P_IncNumber int
		
	Set @P_IncName = Null
	
	Select
		@P_IncName = I.Name,
		@P_IncNumber = I.Number
	From
		dbo.[fnGetAccountList] (@Guid) Ac
		inner join [IncAccountDetailAc] D on Ac.Guid = D.AccountGuid
		inner join [IncAccount] I on I.Guid = D.ParentGuid
	where
		D.parentGuid <> @ParentGuid

	if @P_IncName is Not Null
	begin
		Set @S = dbo.sc('        ')+' : '+@P_IncName+'. '+dbo.sc(' ')+' '+Cast( @P_IncNumber as varchar(10))
		RAISERROR (@s, 16, 1)
		ROLLBACK TRANSACTION
		return
	end
		

	/*
	--  
	Set @P_IncName = Null
	
	Select
		@P_IncName = I.Name,
		@P_IncNumber = I.Number
	From
		dbo.[fnGetAccountParents] (@Guid) Ac
		inner join [IncAccountDetailAc] D on Ac.Guid = D.AccountGuid
		inner join [IncAccount] I on I.Guid = D.ParentGuid
	where
		D.parentGuid <> @ParentGuid

	if @P_IncName is Not Null
	begin
		Set @S = dbo.sc('      ')+' : '+@P_IncName+'. '+dbo.sc(' ')+' '+Cast( @P_IncNumber as varchar(10))
		RAISERROR (@s, 16, 1)
		ROLLBACK TRANSACTION
		return
	end
	*/

	insert into IncAccountDetailAc
	([Number],[ParentGuid] ,[AccountGuid])
	Select 
		(Select IsNull(Max(Number),0)+1 From IncAccountDetailAc where ParentGuid=@ParentGuid),
		@ParentGuid,
		Ac.Guid
	From
		Account Ac
		left join [IncAccountDetailAc] D on Ac.Guid = D.AccountGuid
	where
		D.parentGuid is Null
		and Ac.Guid = @Guid
		
	exec PrcGetIncAccountListDetail
	
	Select 
		*
	From 
		[vwIncAccountDetailAc]
	where
		ParentGuid = @ParentGuid
	Order by 
		AccountCode
		

GO

SET ANSI_NULLS, QUOTED_IDENTIFIER ON
GO

Create View [vwAllContractKind]
 
as
	Select
		L.Guid as [ContractGuid],
		0 as [Kind]
	From 
		[LeaseApartment] [L]
	union all
	Select 
		L.Guid as [ContractGuid],
		1 as [kind]
	From 
		[ParkingContract] [L]
	union all
	Select
		L.Guid as [ContractGuid],
		2 as [Kind]
	From 
		[LandContract] [L]
	union all
	Select
		L.Guid as [ContractGuid],
		3 as [Kind]
	From 
		[ElectricityBill] [L]
		
	union all
	Select
		L.Guid as [ContractGuid],
		4 as [Kind]
	From 
		[ServicesContract] [L]
	
	union all
	Select
		L.Guid as [ContractGuid],
		5 as [Kind]
	From 
		[MaintenanceContract] [L]
	


GO

SET ANSI_NULLS, QUOTED_IDENTIFIER ON
GO

Create Procedure [PrcTestFlatUsed]
(
	@FlatGuid uniqueidentifier = 'FAC0771A-ABC6-4D88-BC6B-DA13C5110A91',
	@Date DateTime = '10/1/2008'
)
 
as
	Select 
		[L].[Number],
		[T].[Name] as [ContractName],
		[L].[FromDate],
		[L].[ToDate],
		[L].[Leasekind],
		[L].[Guid]
	From 
		[LeaseApartment] [L] 
		inner join [ContractType] [T] On [T].[Guid] = [L].[TypeGuid]
	where 
		([ApartmentGuid] = @FlatGuid)
		and (
				(
					(
						([FromDate] <= @Date )
					)
				and ( [Leasekind] = 2 )
				)
				or 
				(
					(
					   (@Date between [FromDate] and [ToDate])
                     )
                	and ([Leasekind] = 0 or [Leasekind] = 1)
				)
			)
			

GO

SET ANSI_NULLS, QUOTED_IDENTIFIER ON
GO

Create FUNCTION [dbo].[fnGetStoreList]( @AccGUID [UNIQUEIDENTIFIER])  
	RETURNS @Result TABLE ( [GUID] [UNIQUEIDENTIFIER], 
							[Code] Varchar(256) COLLATE ARABIC_CI_AI, 
							[Name] Varchar(256) COLLATE ARABIC_CI_AI, 
							[Level] [INT] DEFAULT 0, 
							[Path] [VARCHAR](8000) COLLATE ARABIC_CI_AI
							)   
 
AS 
BEGIN  
		---- 
	Declare @AcType int
	Set @AcType = 1
	if isnull(@AcType,0) <> 2
	begin
		DECLARE @FatherBuf_S	TABLE
		(
			[GUID] [UNIQUEIDENTIFIER], 
			[Level] [INT], 
			[Path] [VARCHAR](8000) COLLATE ARABIC_CI_AI, 
			[ID] [INT] IDENTITY( 1, 1)
		)   
		DECLARE  @Continue_S [INT], @Level_S [INT]  
		SET @Level_S = 0   
		  
		SET @AccGUID = ISNULL(@AccGUID, 0x0)   
		IF @AccGUID = 0x0   
		BEGIN 
			INSERT INTO @FatherBuf_S ( [GUID], [Level], [Path]) SELECT [ac1].[Guid], @Level_S, ''  FROM [Store] [ac1] WHERE ( ISNULL( [ac1].[ParentGuid], 0x0) = 0x0 ) ORDER BY [ac1].[Code]
			INSERT INTO @fatherBuf_s ( [GUID], [Level], [Path]) SELECT [ac1].[Guid], @Level_S, ''  
			FROM  
				[Store] [ac1] 
				LEFT JOIN [Store] [ac2] ON [ac1].[ParentGuid] = [ac2].[Guid] 
				LEFT JOIN @fatherBuf_s [f] ON [ac1].[Guid] = [f].[Guid]  
			WHERE  
				ISNULL( [ac1].[ParentGuid], 0x0) != 0x0 
				AND [ac2].[Guid] IS NULL 
				AND [f].[Guid]IS NULL 
			ORDER BY  
				[Ac1].[Code]
		END 
		ELSE   
			INSERT INTO @FatherBuf_S ([GUID] , [Level], [Path]) SELECT [Guid], @Level_S, '' FROM [Store] WHERE [Guid] = @AccGUID ORDER BY [Code]
		  
		UPDATE @FatherBuf_S  SET [Path] = CAST( ( 0.0000001 * ID) AS [VARCHAR](40))   
	  
		SET @Continue_S = 1   
		IF (@AccGUID = 0x0) 
		BEGIN   
			WHILE @Continue_S <> 0   
			BEGIN   
				SET @Level_S = @Level_S + 1   
				INSERT INTO @FatherBuf_S([GUID],[Level],[Path])  
					SELECT  
						[ac].[Guid], @Level_S,[fb].[Path]  
					FROM  
						[Store] AS [ac] INNER JOIN @FatherBuf_S AS [fb]  
						ON [ac].[ParentGuid] = [fb].[GUID]   
					WHERE  
						[fb].[Level] = @Level_S - 1   
					ORDER BY  
						[ac].[Code]
				SET @Continue_S = @@ROWCOUNT   
				UPDATE @FatherBuf_S  SET [Path] = [Path] + CAST( ( 0.0000001 * [ID]) AS VARCHAR(40))  WHERE [Level] = @Level_S 
			END   
		END  
		ELSE  
		BEGIN   
			WHILE @Continue_S <> 0   
			BEGIN   
				SET @Level_S = @Level_S + 1   
				INSERT INTO @FatherBuf_S([GUID], [Level], [Path])  
					SELECT  
						[ac].[Guid],@Level_S,[fb].[Path]  
					FROM  
						[Store] AS [ac] INNER JOIN @FatherBuf_S AS [fb]  
						ON [ac].[ParentGuid] = [fb].[GUID]   
					WHERE  
						[fb].[Level] = @Level_S - 1  
					ORDER BY  
						[ac].[Code]
				SET @Continue_S = @@ROWCOUNT   
				UPDATE @FatherBuf_S  SET [Path] = [Path] + CAST( ( 0.0000001 * ID) AS [VARCHAR](40))  WHERE [Level] = @Level_S 
			END   
		END   
	end
	else
	begin
		insert into @FatherBuf_S
		(
			[GUID],
			[Level], 
			[Path]
		)   
		Select
			[StoreGuid],
			0,
			0
		From
			[StoreAccumulate] 
		where
			[ParentGuid] = @AccGuid
	end	


	INSERT INTO @Result 
	SELECT 
		[S].[GUID], [Code], [Name], [Level], [Path] 
	FROM 
		@FatherBuf_S [S]
		Inner join [vwStore] [Ac] on [Ac].[Guid] = [S].[Guid] 
	GROUP BY 
		[S].[GUID], [Level], [Path] ,[Code], [Name]
	ORDER BY [Path] 

	RETURN  
END 


GO

SET ANSI_NULLS, QUOTED_IDENTIFIER ON
GO

Create Function dbo.FnStrToAscii(@Str  Varchar(256))
returns bigint  begin
	Set @str = left(@Str, 6)
	
	Declare @R Varchar(256)
	Set @R = 0	
	Declare @I int

	Set @I = 0
	while @I < Len(@Str)
	begin
		Set @R = @R + Cast(
						(
							Ascii(SUBSTRING (@Str, @I+1, 1))
						)
						as Varchar(5))

		Set @I = @I + 1

	end
	
	return Cast(@R as bigint)
end

GO

SET ANSI_NULLS, QUOTED_IDENTIFIER ON
GO
Create View [vwBillType]
 
as
	Select
		[A].[Number],
		[A].[Guid],
		[A].[SecLvl],
		[A].[Code],
		[A].[Name] as [ArName],
		Case when (dbo.FnGetLangauge(@@spid) = 1) and (Isnull([A].[LtnName],'') <> '') then [A].[LtnName] else [A].[Name] end as [Name], 
		[A].[ltnName],
		[A].[Menu] as [arMenu],
		Case when (dbo.FnGetLangauge(@@spid) = 1) and (Isnull([A].[LtnMenu],'') <> '') then [A].[LtnMenu] else [A].[Menu] end as [Menu], 
		[A].[LtnMenu],
		[A].[ShortCut],
		[A].[DefPrintPath],
		[A].[Note],
		[A].[Color1],
		[A].[Color2],
		[A].[CurrencyGuid],
		[A].[PayType],
		[A].[BillKind],
		Case when [A].[BillKind] = 0 then 1
		     when [A].[BillKind] = 3 then 1
		     when [A].[BillKind] = 4 then 1
		     when [A].[BillKind] = 1 then -1
		     when [A].[BillKind] = 2 then -1
		     when [A].[BillKind] = 5 then -1
		end	as Direction,
		BillBarcode
	From
		[vbBillType] [A]

GO

SET ANSI_NULLS, QUOTED_IDENTIFIER ON
GO

Create Procedure [PrcPaperMonetaryOfContract]
(
	@ContractGuid UniqueIdentifier = 0x0
)
 
as
	Set NoCount On
	
	Select 
		dbo.SC([P].[TypeName]) as [PaperKind],
		[P].[No],
		[LL].[Value],
		[P].[BankName],
		[P].[CurrencyCode],
		[P].[DueDate],
		Case 		
			when  [C3].[CheckGuid] is not null then dbo.SC('')

			when  ([C1].[CheckGuid] is not null) or 
				  ([C4].[CheckGuid] is Not Null ) and ([C4].[Value] >= [P].[Value])	 then dbo.SC('') 

			when ([C4].[CheckGuid] is Not Null ) and ([C4].[Value] < [P].[Value]) then dbo.SC(' ')

			when  [C].[CheckGuid] is not null then dbo.SC('') 
			when  [C2].[CheckGuid] is not null then dbo.SC('') 
		end as [State],
		[P].[Note3],
		[P].[Note],
		1 as [Print],
		[P].[Guid]
	From
		[vwChecks] [P]
		inner join [LinkCheckContract] LL on LL.ParentGuid = P.Guid
		left join [vwAllContract] [L] on [L].[Guid] = [LL].[ContractGuid]
		left join [vwChecksCollection] [C] on [C].[CheckGuid] = [P].[Guid] and [C].[Kind] = 0
		left join [vwChecksCollection] [C1] on [C1].[CheckGuid] = [P].[Guid] and [C1].[Kind] = 1
		left join [vwChecksCollection] [C2] on [C2].[CheckGuid] = [P].[Guid] and [C2].[Kind] = 2
		left join [vwChecksCollection] [C3] on [C3].[CheckGuid] = [P].[Guid] and [C3].[Kind] = 3
		left join (
						Select 
							[CheckGuid],
							Sum([Value]) as [Value] 
						From
							[ChecksPartialCollection] 
						Group By
							[CheckGuid]
					) [C4] on [C4].[CheckGuid] = [P].[Guid]
 	where
 		(LL.[ContractGuid] = @ContractGuid or @ContractGuid = 0x0)
--		and [P].[Number] = 2905
 	Order By 
 		[P].[dueDate], [P].[No]

GO

SET ANSI_NULLS, QUOTED_IDENTIFIER ON
GO

Create View [vwMovingBranch]
 
as
	Select
		*
	From 
		[vwBranch]
	where 
		[Guid] Not In (Select ISNULL([ParentGuid],0x0) From [Branch])

GO

SET ANSI_NULLS, QUOTED_IDENTIFIER ON
GO

Create Procedure [dbo].[PrcUpdateServicesContractCreateEntryimmediate]
(
	@Date1 DateTime = '3/1/2011',
	@Date2 DateTime = '3/1/2012',
	@ActiveDate bit = 0,
	@Datewith int = 0,
	@Num1 int = 1,
	@Num2 int = 100,
	@ActiveNum bit = 0
)
 
as
	Alter Table [ServicesContract] Disable Trigger All
	
	update [ServicesContract]
	Set
		CreateContractEntry = Case when IsNull(IsRounded,0) = 0 and t.CreateEntry = 1 then 1 else 0 end
	From
		[ServicesContract] L
		inner join [ServicesContractType] T on T.Guid = L.TypeGuid
		inner join [Resource] R on R.Guid = L.TypeGuid and R.Spid = @@SPID
	where
		((L.number between @num1 and @Num2) or @ActiveNum = 0)
		and (
			(
				([L].[FromDate] between @Date1 and @Date2 and @Datewith = 0)
			)
			or
			(
				([L].[ToDate] between @Date1 and @Date2 and @Datewith = 1)
			)

			or
			(
				([L].[ContractFinishDate] between @Date1 and @Date2 and @Datewith = 2)
				and ([L].[ContractFinish] = 1)
			)

			or
			(
				([L].[EditDate] between @Date1 and @Date2 and @Datewith = 3)
			)
			or
			(
				([L].[AcquittancePrintdate] between @Date1 and @Date2 and @Datewith = 4)
			)

			or @ActiveDate = 0
		) 
		
		Alter Table [ServicesContract] Enable Trigger All


GO

SET ANSI_NULLS, QUOTED_IDENTIFIER ON
GO

Create FUNCTION [dbo].[fnIsSQL2005]()  
RETURNS [INT] 
 
AS 
BEGIN 
	
	DECLARE  
		
		@ver_str [VARCHAR](128), 
		
		@ver [FLOAT], 
		
		@ret_val [INT] 
      
	SET @ver_str = CAST( SERVERPROPERTY('ProductVersion') AS [VARCHAR](128)) 
      
	SET @ver = CAST( LEFT(@ver_str, 4) AS [FLOAT]) 
      
	SET @ret_val = 0 
      

	IF @ver >= 9  
            
	SET @ret_val = 1 
      
	RETURN @ret_val 

END 


GO

SET ANSI_NULLS, QUOTED_IDENTIFIER ON
GO
Create procedure [prcHEntryUpdate]
(
	@Guid uniqueidentifier = 'FC4889FE-422E-4089-8A69-7760F0FA441D'
)
 
as
	update [HEntry] Set 
		[Debit] = D.debit,
		[Credit] = d.Credit,
		[ItemCount] = D.[ItemCount]
	from
		[HEntry] H
		inner join (select
						parentguid,
						Sum(debit) as [Debit],
						Sum(d.Credit) as [Credit],
						COUNT(*) as [ItemCount]
					from
						dentry d 
					group by parentguid
					) D on d.ParentGuid = h.Guid
	where
		H.Guid = @Guid

GO

SET ANSI_NULLS, QUOTED_IDENTIFIER ON
GO

Create Procedure [PrcGetCurrencyVal]
(
	@Guid uniqueidentifier = '0ACC7FE7-CA3C-475A-9F4D-DA2F6ECB16E9',
	@Date DateTime = '7/28/2008'
)
 
as
	declare @Rate Float
	Set @Rate = 0

	Select  Top 1
		@Rate = [Rate] 
	From 
		[ChangeCurrencyRate]
	where
		([CurrencyGuid] = @Guid)
		and ([Date] <= @Date)
	Order By
		[Date] desc, [Number] desc 


	if @Rate = 0 
	Select  Top 1
		@Rate = [Rate] 
	From 
		[ChangeCurrencyRate]
	where
		([CurrencyGuid] = @Guid)
	Order By
		[Date] desc, [Number] desc 
	
	if @Rate = 0 
	Select
		@Rate = [CurrencyVal] 
	From 
		[Currency]
	where
		([Guid] = @Guid)

	Select 
		*,
		@Rate as [RealRate]
	From
		[vwCurrency]
	where 
		[Guid] = @Guid


GO

SET ANSI_NULLS, QUOTED_IDENTIFIER ON
GO
Create View [vwRealtyMaintenanceContract]
 
as
	Select
		a.*,
		R.Name as Realty,
		R.Kind,
		C.Code+'-'+C.Name as Cost
	From
		[RealtyMaintenanceContract] [a]
		inner join vwallRealty [R] on [R].Guid = [a].[RealtyGuid]
		inner join Cost [C] on [C].Guid = [a].[CostGuid]

GO

SET ANSI_NULLS, QUOTED_IDENTIFIER ON
GO
Create Procedure [dbo].[PrcAddBackupJob] 
	@JobName [varchar](256), 
	@JobType [int], 
	@JobTime [int], 
	@Jobday [int], 
	@JobStartDate [int], 
	@DBName [varchar](256), 
	@Dir [varchar](256), 
	@Dir2 [varchar](256), 
	@BkNum [INT], 
	@Occurance		[INT]= 1   , --1 Once Only, 2 Every  
	@HoursNumber [INT] = 1--Number of hours    
 
As 
	SET NOCOUNT ON 
	DECLARE @Command [VARCHAR]( 255) 
	
	SELECT @Command = 'Execute '+DB_NAME()+'.dbo.[PrcDoBackupJob] @JobType = '+  
						CAST(@JobType AS [Char](10))+  
							', @DBName = '''+  @DBName  
							+  ''', @DirName = ''' + @Dir  
							+  ''', @BkNum = ' +CAST(@BkNum AS [VarChar](10))  
	EXEC [dbo].[prcAddJob] 	@JobName, @JobType, @JobTime, @Jobday, @JobStartDate, @DBName, 
							@Command,@Occurance,@HoursNumber   

	if @Dir2 = '' return
							
	Set @JobName = @JobName +'_2'	
	SELECT @Command = 'Execute '+DB_NAME()+'.dbo.[PrcDoBackupJob] @JobType = '+  
						CAST(@JobType AS [Char](10))+  
							', @DBName = '''+  @DBName  
							+  ''', @DirName = ''' + @Dir2
							+  ''', @BkNum = ' +CAST(@BkNum AS [VarChar](10))  
	EXEC [dbo].[prcAddJob] 	@JobName, @JobType, @JobTime, @Jobday, @JobStartDate, @DBName, 
							@Command,@Occurance,@HoursNumber   
							

GO

SET ANSI_NULLS, QUOTED_IDENTIFIER ON
GO

Create Procedure [PrcCreateLandIdentityEntry]
(
	@Guid uniqueidentifier = '{6603B03F-6A3B-40C4-9309-D7C0C137741A}'
)
 
as
	Declare @IdentityEntryGuid uniqueidentifier
	Select 
		@IdentityEntryGuid = [IdentityEntryGuid] 
	From 
		[Earth]
	where
		Guid = @Guid
		
	if isNull(@IdentityEntryGuid,0x0) = 0x0
	Set @IdentityEntryGuid = NEWID()
	
	Declare @CeNumber Int
	Select
		@CeNumber = Number
	From
		HEntry
	where
		Guid = @IdentityEntryGuid
		
	if isNull(@CeNumber,0) = 0
	Set @CeNumber = (Select isNull(MAX(Number),0) + 1 From HEntry)
	
	Declare
		@CrearteEntryInvestment Bit,
		@LandOwner Int,
		@IdentityValue Float
	Select
		@CrearteEntryInvestment = [CrearteEntryInvestment],
		@LandOwner = [LandOwner],
		@IdentityValue  = [IdentityValue]
	From
		[Earth]
	where
		Guid = @Guid
	

	Delete
		HEntry
	where
		Guid = @IdentityEntryGuid
		

	if @CrearteEntryInvestment = 1 and @LandOwner = 3 and @IdentityValue <> 0
	begin
		update Earth Set [IdentityEntryGuid] = @IdentityEntryGuid
		where
			Guid = @Guid
			
		Insert Into [HEntry]
		([Guid],[SecLvl],[Number],[Date], [CurrencyGuid], [CurrencyVal], [Note], [ParentKind], [BranchGuid], [IsPosted])
		Select
			@IdentityEntryGuid,
			[SecLvl],
			@CeNumber,
			[IdentityBeginDate],
			[CurrencyIdentityGuid],
			[CurrencyValIdentity],
			[IdentityNote],
			170,
			Null,
			1
		From
			Earth
		where
			Guid = @Guid
			
			Declare @DetailNum Int
			Set @DetailNum = 0
		
			Insert into [DEntry]
		 	([ParentGuid],[Number],[AcGuid],[Debit],[Credit],[CurrencyGuid],[CurrencyVal],[CostGuid],[ObverseAcGuid],[Note])
			Select
				@IdentityEntryGuid,
				@DetailNum,
				[AccountGuid],
				[IdentityValue],
				0,
				CurrencyIdentityGUID,
				CurrencyValIdentity,
				Null,
				OwnerAccountGuid,
				[IdentityNote]
			From
				[Earth]
			where
				[Guid] = @Guid
				
			Set @DetailNum = @DetailNum + 1
			
			Insert into [DEntry]
		 	([ParentGuid],[Number],[AcGuid],[Debit],[Credit],[CurrencyGuid],[CurrencyVal],[CostGuid],[ObverseAcGuid],[Note])
			Select
				@IdentityEntryGuid,
				@DetailNum,
				OwnerAccountGuid,
				0,
				[IdentityValue],
				CurrencyIdentityGUID,
				CurrencyValIdentity,
				Null,
				[AccountGuid],
				[IdentityNote]
			From
				[Earth]
			where
				[Guid] = @Guid

			Select * from [HEntry] where Guid = @IdentityEntryGuid
			Select * from [DEntry] where parentGuid = @IdentityEntryGuid
			
	end
	
		

GO

SET ANSI_NULLS, QUOTED_IDENTIFIER ON
GO
Create Function dbo.[FnDEntry] (@CurrencyGuid uniqueidentifier, @CurrencyVal Float)
returns @Tbl Table (
						[Number] int,
						[ParentGuid]  [uniqueidentifier] ,
						[AcGuid] [uniqueidentifier] ,
						[Debit] [Float],
						[Credit] [Float],
						[CurrencyGuid] [uniqueidentifier]  ,
						[CurrencyVal] Float,
						[ObverseAcGuid]  [uniqueidentifier] ,
						[CostGuid] [uniqueidentifier] ,
						[Note] Varchar(256),
						[isvisible] Bit
					)
 
as
begin
	if @CurrencyVal = 0
	Set @CurrencyVal = 1
	Insert Into @Tbl
	Select
		[Number],
		[ParentGuid],
		[AcGuid],
		Case when [CurrencyGuid] = @CurrencyGuid then [Debit] else [Debit] * [CurrencyVal] / @CurrencyVal end As [Debit],
		Case when [CurrencyGuid] = @CurrencyGuid then [Credit] else [Credit] * [CurrencyVal] / @CurrencyVal end As [Credit],
		[CurrencyGuid],
		[CurrencyVal],
		[ObverseAcGuid],
		[CostGuid],
		[Note],
		[isvisible]
	From
		[DEntry]
	Return
end

GO

SET ANSI_NULLS, QUOTED_IDENTIFIER ON
GO

Create View [vwMaintenanceItem]
 
as
	Select
		[A].[Number], 
		[A].[Guid], 
		[A].[Note], 
		[A].[LtnName],
		[A].[Name] as [ArName],
		[DefValue],
		Case when (dbo.FnGetLangauge(@@spid) = 1) and (Isnull([A].[LtnName],'') <> '') then [A].[LtnName] else [A].[Name] end as [Name]
	from
		vbMaintenanceItem A


GO

SET ANSI_NULLS, QUOTED_IDENTIFIER ON
GO

create proc Gold_PrcUpDateToextendedproperty
  @PropertyName varchar (50) = 'Vestion',
  @PropertyValue varchar (50) = ''
 
as
	   EXEC  sp_updateextendedproperty @PropertyName,@PropertyValue


GO

SET ANSI_NULLS, QUOTED_IDENTIFIER ON
GO

Create View [vwReceiptOrderType]
 
as
	Select

		[A].[Number],
		[A].[Guid],
		[A].[SecLvl],
		[A].[Code],
		[A].[Name] as [ArName],
		Case when (dbo.FnGetLangauge(@@spid) = 1) and (Isnull([A].[LtnName],'') <> '') then [A].[LtnName] else [A].[Name] end as [Name], 
		[A].[ltnName],
		[A].[Menu] as [arMenu],
		Case when (dbo.FnGetLangauge(@@spid) = 1) and (Isnull([A].[LtnMenu],'') <> '') then [A].[LtnMenu] else [A].[Menu] end as [Menu], 
		[A].[LtnMenu],
		[A].[ShortCut], 		[A].[EntryTypeGuid],
		
		[B].[DefAccountGuid], 		[B].[DebitField], 		[B].[CreditField], 		[B].[DebitCaption], 		[B].[CreditCaption], 		[B].[LtnDebitCaption], 		[B].[LtnCreditCaption], 		[B].[CkCurrency], 		[B].[CkCost], 		[B].[CkNote], 		[B].[CreateEntry], 		[B].[AutoCreateEntry], 		[B].[AutoPostedEntry], 		[B].[OpMoveCostwithDefAccount], 		[B].[OpEntryForOneItem], 		[B].[OpObverseNoteItem], 		[B].[NeedCostItem], 		[B].[NeedNoteItem], 		[B].[AutoSMSAfterAdd], 		[B].[SMSMsg], 		[B].[SMSMsgEn], 		[B].[DefPrintPath]
		
	From 
		[vbReceiptOrderType] [A]
		inner join EntryType [b] on [b].Guid = [a].[EntryTypeGuid]


GO

SET ANSI_NULLS, QUOTED_IDENTIFIER ON
GO

Create Procedure [PrcNewContractParking]
(
	@Guid uniqueidentifier = 0x0
)
 
as
	Select
		(Select Isnull(Max([Number]),0) + 1 From [LeaseApartment]) as [Number],
		[Guid],
		[ContractNo],
		[CustomerGuid],
		[BuildingGuid],
		[ParkingGuid],
		[Period],
		Case 
			when [ContractFinish] = 0 then Dateadd(Day,1,[ToDate]) 
			when [ContractFinish] = 1 then Dateadd(Day,1,[ContractFinishDate]) 
		end as [FromDate],
		Dateadd(year,1,
						Case 
							when [ContractFinish] = 0 then [ToDate]
							when [ContractFinish] = 1 then [ContractFinishDate]
						end
				) as [ToDate],
		[Rent]+ISNULL(AddValue,0) as [Rent],
		[CurrencyGuid],
		[CurrencyVal],
		[PayType],
		[Note],
		[Note2],
		[ContractKind],
		[RevenueAccountGuid],
		[CustAccountGuid],
		case when SUBSTRING([OpNewContract], 4, 1) = '1' then [CommissionFromCustPercent] else 0 end [CommissionFromCustPercent],
		case when SUBSTRING([OpNewContract], 4, 1) = '1' then [CommissionFromCustValue] else 0 end as [CommissionFromCustValue],
		[AcCommissionFromCustGuid],
		case when SUBSTRING([OpNewContract], 5, 1) = '1' then [CommissionFromOwnerPercent] else 0 end [CommissionFromOwnerPercent],
		case when SUBSTRING([OpNewContract], 5, 1) = '1' then [CommissionFromOwnerValue] else 0 end [CommissionFromOwnerValue],
		[AcCommissionFromOwnerGuid],
		[FlatOwner],
		Cast( 0 as bit) as [ContractFinish],
		Cast( Null as DateTime)  as [ContractFinishDate],
		0 as [ResultingAmount],
		0 as [Fine],
		[FineAccount],
		Cast( 0 as bit) as [CreateResultingEntry],
	
		0 as [InsuranceValue],
		[InsuranceValue] + Isnull([InsuranceValueOld],0) as [InsuranceValueOld],
		case when SUBSTRING([OpNewContract], 1, 1) = '1' then [ContractPrice] else 0 end as [ContractPrice], 
		[AccountContractPrice],
		case when SUBSTRING([OpNewContract], 2, 1) = '1' then [CertificatValue] else 0 end [CertificatValue],

		[AccountCertificatValue],

		[RentDuration],
		[Rentype],
		[TermsOfPayment],
		[RentInfoGuid],
		[SalesManGuid],
		[BranchGuid],
		[CardNo],
		[CarNo],
		[CarColor],
		[CarType],
		[Emirate],
		[CostGuid],
		[FlatContractGuid] ,
		IsAutoRenewal
	From
		[vwParkingContract]
	where
		[Guid] = @Guid Or @Guid = 0x0


GO

SET ANSI_NULLS, QUOTED_IDENTIFIER ON
GO

Create Trigger [TRG_SetUser_Secondary_Entry]
on [Secondary_Entry]
 
For insert
As
	update [Secondary_Entry] Set [userGuid] = (Select Top  1 [UserGuid] From CurrentUsers where [spid] = @@spid)
	From
		[Secondary_Entry] [H],[inserted] [I]
	where [H].[Guid] = [I].[Guid]

GO

SET ANSI_NULLS, QUOTED_IDENTIFIER ON
GO

Create Proc [Prc_GetLogFile]
(
 @UserName varchar(250) = ''
 ,@ComputerName varchar(250) = ''
 ,@Date1 dateTime ='8/10/2005'
 ,@Date2 dateTime ='12/30/1899'
)
 
as

	select 
		* 
	from 
		[LogFile]
	where 
		([UserName]=@username or @UserName = '')
		and	(ComputerName = @ComputerName or @ComputerName = '')		
		and	(DBO.fnDateOnly(Odate) Between @date1 and @date2)
	Order by 
		[Odate] desc



GO

SET ANSI_NULLS, QUOTED_IDENTIFIER ON
GO

Create view [vwServicesContract]
 
as
	Select 
		[TypeGuid],
		[EditDate],
		[Mark],
		[ContractNo],
		[T].[Name] as [TypeName],

		[T].[Name] as [TypeNameAr],
		[T].[Name] as [TypeNameLtn],

		[T].[Name]+ ' / ' + Cast([A].[Number] as Varchar(10)) as [ArLeaseKind],
		[B].[Name] as [BuildingName],
		[B].[ArName] as [BuildingArName],
		[B].[LtnName] as [BuildingLtnName],

		[B].[BuildingCode],

		[T].[Name] + Cast([A].[Number] as Varchar(10))  as [Contract], 


		[A].[Rent] - isNull([A].[DiscountValue],0) as [Value],

		[Cu].[Name] as [CustName],
		[Cu].[ArName] as [CustArName],
		[Cu].[LtnName] as [CustLtnName],
		[Cu].[Phonejob] as [CustomerPhonejob],
		[Cu].[Mobile] as [CustomerMobile],
		[Cu].[Nationality] as [CustomerNationality],
		[A].[BuildingGuid],
		[A].[Guid],
		[A].[Number],
		[A].[CustomerGuid],
		[A].[FromDate],
		[A].[ToDate],
		[A].[Rent],
		[A].[PeriodType],
		[A].[MonthlyValue],
		[A].[CurrencyGuid],
		[A].[CurrencyVal],
		[A].[PayType],
		[A].[Note],
		[A].[Note2],
		[A].[Purpose],
		[A].[ExpenceAccountGuid],
		[A].[CustAccountGuid],

		[A].[ResultingAmount],
		[A].[ResultingAmount2],

		A.ContractFinish,
		[A].[ContractFinishDate],
		[A].[CreateResultingEntry],


		[A].[RentDuration],
		[A].[Rentype],
		[A].[TermsOfPayment],
		[A].[Seclvl],
		[A].[FineExpenceAccountGUID],

		[A].[CreateContractEntry],
		[A].[Whereabouts],		
		[A].[DiscountPercent],
		[A].[DiscountValue],
		[A].[Rent] - [A].[DiscountValue] as [RentAfterDiscount],	
		[A].[DiscountAccountGuid],
		[Cr].[Code] as [CurrencyName],
		[A].[BranchGuid],
		[A].[RoundKind],

		Case 
			when 
				Case when [ContractFinish] = 0 then [ToDate] else [ContractFinishDate] end 
				<= GetDate() then -- 
									Case when [ContractFinish] = 0 then dbo.SC('     ') 
									else
									dbo.SC('    ') end
			when 
				Case when [ContractFinish] = 0 then [ToDate] else [ContractFinishDate] end 
				> GetDate() then dbo.SC(' ') 
		end as [ContractState],

		[A].[Period],

		[B].[Emirate],
		[B].[Area] as [BuildingArea],
		[B].[Suburb],
		[B].[Street],
		[B].[BasinNo],
		[B].[PieceNo],
		[B].[BuildingNo],
		[B].[BondType],
		[B].[BondNo],

		[B].[BankName] as [BuildingBankName],
		[B].[BankAccCode] as [BuildingBankAccCode],

		Case when [ContractFinish] = 0 then [ToDate] else [ContractFinishDate]  end as [EndDate],
		[A].[ResultingNote],

		[A].[NewState],
		Case when [A].[NewState] = 0 then dbo.SC('') else dbo.SC('') End as [NewStateStr],

		[A].[OtherFee],
		[A].[OtherFeeAccountGUID],

		[A].[License1No],
		[A].[License2No],
		[A].[License3No],
		[A].[License1Date1],
		[A].[License2Date1],
		[A].[License3Date1],
		[A].[License1Date2],
		[A].[License2Date2],
		[A].[License3Date2],
		[A].[Ltnwhereabouts],
		[A].[LtnPurpose],
		[A].[LtnRentDuration],
		[A].[LtnRentype],
		[A].[LtnTermsOfPayment],
		[A].[Trademark],

		[A].[CostGuid],
		[A].[CustAccountGuid] as [CustAcGuid],

		A.[IsRounded],

		[CountOldContract],

		[A].[AcquittancePrinted],
		[A].[AcquittancePrintDate],
		
		[A].AcquittancePrintedByGuid
	from 
		[vbServicesContract] [A]
		inner join [vwServicesContractType] [T] on [T].[Guid] = [A].[TypeGuid]
		inner join [vwBuilding] [B] On [A].[BuildingGuid] = [B].[Guid]
		left join [vwcustomer] [Cu] On [Cu].[Guid] = [A].[CustomerGuid]
		left join [Currency] [Cr] On [Cr].[Guid] = [A].[CurrencyGuid]


GO

SET ANSI_NULLS, QUOTED_IDENTIFIER ON
GO

Create Trigger [TRG_LinkCheckEntryDelete]
on [LinkEntry_Checks]
 
For delete
As
	Delete [Hentry] From [HEntry] Inner join [Deleted] On [Deleted].[EntryGuid] = [HEntry].[Guid]


GO

SET ANSI_NULLS, QUOTED_IDENTIFIER ON
GO

Create Procedure [PrcFlatContractSMS]
(
	@SMSText varchar(256) = '[A]'
)
 
as
	Set NoCount on

	Select 
		T.FromDate,
		T.ToDate,
		T.[CustName],
		T.[CustomerMobile] as [CustMobile],
		[T].[CustArName],
		[T].[CustLtnName],
		[T].[BuildingArName],
		[T].[BuildingltnName],
		[T].[FlatNo],
		t.ContractNo,
		t.RentAfterDiscount as [Value],
		@SMSText as [SMSText]
	into #CheckSMS
	From
		vwLeaseApartment T 
		inner join [Resource] R on R.Guid = T.Guid and R.kind = 3700 and R.Spid = @@Spid
	
	update #CheckSMS Set [SMSText] = REPLACE([SMSText], '[A]', IsNull([CustArName],''))
	update #CheckSMS Set [SMSText] = REPLACE([SMSText], '[B]', IsNull([CustLtnName],''))
	update #CheckSMS Set [SMSText] = REPLACE([SMSText], '[T]', IsNull([BuildingArName],''))
	update #CheckSMS Set [SMSText] = REPLACE([SMSText], '[R]', IsNull([BuildingltnName],''))
	update #CheckSMS Set [SMSText] = REPLACE([SMSText], '[C]', IsNull([FlatNo],''))
	update #CheckSMS Set [SMSText] = REPLACE([SMSText], '[E]',IsNull( ContractNo,''))
	update #CheckSMS Set [SMSText] = REPLACE([SMSText], '[D]',IsNull( dbo.fndate(FromDate),''))
	update #CheckSMS Set [SMSText] = REPLACE([SMSText], '[F]',IsNull( dbo.fndate(ToDate),''))
	update #CheckSMS Set [SMSText] = REPLACE([SMSText], '[V]',IsNull( Cast ([Value] as varchar(20)),''))
	
	Select * from #CheckSMS
	order By
		Fromdate
	


GO

SET ANSI_NULLS, QUOTED_IDENTIFIER ON
GO

Create View [vwElectricityType]
 
as
	Select
		[A].[Number],
		[A].[Guid],
		[A].[SecLvl],
		[A].[Name] as [ArName],
		Case when (dbo.FnGetLangauge(@@spid) = 1) and (Isnull([A].[LtnName],'') <> '') then [A].[LtnName] else [A].[Name] end as [Name], 
		[A].[ltnName],
		[A].[Menu] as [arMenu],
		Case when (dbo.FnGetLangauge(@@spid) = 1) and (Isnull([A].[LtnMenu],'') <> '') then [A].[LtnMenu] else [A].[Menu] end as [Menu], 
		[A].[LtnMenu],
		[A].[DefPrintPath],
		[A].[ShortCut],

		[CreatedEntry],
		[AutoCreatedEntry],
		[BuildingGuid],
		[IncomeAccountGuid],
		[ExtraAccountGuid],
		[DiscountAccountGuid],

		[WaterAccountGuid],
		[DrainageAccountGuid],
		[WaterValue],
		[DrainageValue],
			
		[FineAccountGuid],
		[FeeAccountGuid],
		[FineValue],
		[FeeValue],

		[CurrencyGuid],
		[CurrencyVal],
		DefCheckTypeGuid,
		DefEntryTypeGuid
	From 
		[vbElectricityType] [A]


GO

SET ANSI_NULLS, QUOTED_IDENTIFIER ON
GO

Create View [vwAccount]
 
as
	Select
		[A].[Number], 
		[A].[Guid], 
		[A].[Code], 
		[A].[ParentGuid], 
		[A].[Note], 
		[A].[CDate], 
		[A].[CurrencyGUID], 
		[A].[CurrencyVal], 
		[A].[Type], 
		[A].[FinalGUID], 
		[A].[LtnName],
		[A].[Name] as [ArName],
		Case when (dbo.FnGetLangauge(@@spid) = 1) and (Isnull([A].[LtnName],'') <> '') then [A].[LtnName] else [A].[Name] end as [Name], 
		case when [A].[ParentGuid] is Not Null then [A].[ParentGuid] else 0x0 end as [Parent],
		ISNULL(a.SumDebit,0) - ISNULL(a.SumCredit,0) as Balance,
		Isnull([A].[NSons],0) as [NSons]
	from
		vbAccount A


GO

SET ANSI_NULLS, QUOTED_IDENTIFIER ON
GO

Create Trigger [TRG_Checks_Delete]
on [Checks]
 
For delete
As
	Delete [LinkEntry_Checks] From [LinkEntry_Checks] Inner join [Deleted] On [Deleted].[Guid] = [LinkEntry_Checks].[checkGuid]


GO

SET ANSI_NULLS, QUOTED_IDENTIFIER ON
GO

Create Procedure [PrcAlarmCheckSMS]
(
	@SMSText varchar(256) = '[A]'
)
 
as
	Set NoCount on

	Select 
		C.AccountName as [CustName],
		(Select Top 1 Mobile from Customer where AcGuid = C.Account) as [CustMobile],
		[T].[CustArName],
		[T].[CustLtnName],
		[T].[BuildingArName],
		[T].[BuildingltnName],
		[T].[FlatNo],
		[C].[NO],
		t.ContractNo,
		C.DueDate,
		C.date,
		C.Value,
		C.endDueDate,
		C.BankName,
		C.Guid,
		@SMSText as [SMSText]
	into #CheckSMS
	From
		[vwChecks] [C]
		left join vwAllContract T on T.Guid = C.ContractGuid
--		left join [ChecksCollection] L on L.CheckGuid = C.Guid and L.Kind = 1
--		left join [ChecksCollection] Rt on RT.CheckGuid = C.Guid and Rt.Kind = 3
		inner join [Resource] R on R.Guid = C.Guid and R.kind = 3700 and R.Spid = @@Spid
	
	update #CheckSMS Set [SMSText] = REPLACE([SMSText], '[A]', IsNull([CustArName],''))
	update #CheckSMS Set [SMSText] = REPLACE([SMSText], '[B]', IsNull([CustLtnName],''))
	update #CheckSMS Set [SMSText] = REPLACE([SMSText], '[T]', IsNull([BuildingArName],''))
	update #CheckSMS Set [SMSText] = REPLACE([SMSText], '[R]', IsNull([BuildingltnName],''))
	update #CheckSMS Set [SMSText] = REPLACE([SMSText], '[V]', IsNull([Value],''))
	update #CheckSMS Set [SMSText] = REPLACE([SMSText], '[C]', IsNull([FlatNo],''))
	update #CheckSMS Set [SMSText] = REPLACE([SMSText], '[D]', IsNull([NO],''))
	update #CheckSMS Set [SMSText] = REPLACE([SMSText], '[E]',IsNull( ContractNo,''))
	update #CheckSMS Set [SMSText] = REPLACE([SMSText], '[F]',IsNull( dbo.fndate(DueDate),''))
	update #CheckSMS Set [SMSText] = REPLACE([SMSText], '[G]',IsNull( dbo.fndate(Date),''))
	update #CheckSMS Set [SMSText] = REPLACE([SMSText], '[H]',IsNull( dbo.fndate(endDueDate),''))
	update #CheckSMS Set [SMSText] = REPLACE([SMSText], '[J]',IsNull( BankName,''))
	
	Select * from #CheckSMS
	order By
		duedate
	


GO

SET ANSI_NULLS, QUOTED_IDENTIFIER ON
GO

Create View [vwTreeAccount]
 
as
	Select
		[A].[Number], [A].[Guid], [A].[Code], [A].[ParentGuid], [A].[Note], [A].[CDate], [A].[CurrencyGUID],
		[A].[CurrencyVal], [A].[Type], [A].[FinalGUID], [A].[LtnName],
		Case when (dbo.FnGetLangauge(@@spid) = 1) and (Isnull([A].[LtnName],'') <> '') then [A].[LtnName] else [A].[Name] end as [Name], 
		case when [A].[ParentGuid] is Not Null then [A].[ParentGuid] else 0x0 end as [Parent],
		Isnull([S].[NSons],0) as [NSons],
		Isnull([Cu].[Guid],0x0) as [CustGuid],
		
		'('+[F].[Code] +'-'+ [F].[Name]+')' As [FinalAcount]
	From 
		[vbAccount] [A]
		left join (Select 
						Count([Number]) as [NSons], 
						[ParentGuid] as [SGuid]
					From 
						[Account]
					Group By
						[ParentGuid]
					) [S] On [S].[SGuid] = [A].[Guid]

		left join [Customer] [cu] On [Cu].[AcGuid] = [A].[Guid]
		Left join [vwaccount] [F] on [F].[Guid] = [A].[FinalGUID]

GO

SET ANSI_NULLS, QUOTED_IDENTIFIER ON
GO
Create Procedure PrcMaintenanceContractVisitAlert
(
	@DayCount int = 10
)
 
as
	Select
		Count(*) as [Count]
		--v.Date,
		--Case 
		--	when (execState = 1) then dbo.SC(' ')
		--	when (DATEADD(Day, -@DayCount, Date) > GetDate()) and (execState = 2) then dbo.SC('  ')
		--	when (DATEADD(Day, -@DayCount, Date) <= GetDate()) and (execState = 2) then dbo.SC('   ')
		--	when (execState = 0) then dbo.SC('  ')
		--	else dbo.SC(' ')
		--end
		--as [visitState],
		--Case 
		--	when (execState = 1) then 0
		--	when (DATEADD(Day, -@DayCount, Date) > GetDate()) and (execState = 2) then 1
		--	when (DATEADD(Day, -@DayCount, Date) <= GetDate()) and (execState = 2) then 2
		--	when (execState = 0) then 3
		--	else 4
		--end
		--as [visitStateId]
	From
		[vbMaintenanceContractVisit] [V]
	where
		Case 
			when (execState = 1) then 0
			when (DATEADD(Day, -@DayCount, Date) > GetDate()) and (execState = 2) then 1
			when (DATEADD(Day, -@DayCount, Date) <= GetDate()) and (execState = 2) then 2
			when (execState = 0) then 3
			else 4
		end	= 2
		

GO

SET ANSI_NULLS, QUOTED_IDENTIFIER ON
GO

Create Procedure [dbo].[PrcGetBillMatPrice]
(
	@BillTypeGuid uniqueidentifier = 'F6843C35-B425-4664-B2E6-677C9B205D4D',
	@MatGuid uniqueidentifier = '8208DC5F-D46A-4935-A4F3-C771225D12E7',
	@Unity int = 1,
	@CustGuid uniqueidentifier = 0x0,
	@CurrencyGuid  uniqueidentifier = '11111111-C748-4B13-8B91-1E9B299DF1C1',
	@CurrencyVal Float = 1,
	@forceLastCustPrice bit = 0
)
 
as
	Declare @OpPrice int,
			@SpecificPrice int
	Select
		@OpPrice = [OpPrice],
		@SpecificPrice = [SpecificPrice]
	From 
		[BillType] 
	where
		[Guid] = @BillTypeGuid
	
	if @forceLastCustPrice = 1 
	begin
		Set @OpPrice = 1
		Set @SpecificPrice = 0
	end
	
	Declare @Price Float
	
	if @OpPrice = 1
	begin
		Select Top 1
			@Price = Case 
						when @Unity = 1 then [Price]
						when @Unity = 2 then [Price] / Case when [Qty2] <> 0 then [Qty2] end * [Qty]
						when @Unity = 3 then [Price] / Case when [Qty3] <> 0 then [Qty3] end * [Qty]
					 End * 
					 Case when (b.CurrencyGuid = @CurrencyGuid) or (@CurrencyVal = 0) then 1
						   else CurrencyVal / @CurrencyVal end
		From
			Bill B
			inner join BillDetail D on d.ParentGuid = b.Guid 
		where
			(b.TypeGuid = @BillTypeGuid)
			and	(b.CustGuid = @CustGuid)
			and (d.MatGuid = @MatGuid)
		Order By
			Date desc, b.Number desc
	end
	
	if @OpPrice between 2 and 7
	begin
		Select Top 1
			@Price = 
					Case 
						when @OpPrice = 2 then AvgPrice 
						when @OpPrice = 3 then MaxPrice 
						when @OpPrice = 4 then LastPrice 
						when @OpPrice = 5 then SaleAvgPrice 
						when @OpPrice = 6 then SaleMaxPrice 
						when @OpPrice = 7 then SaleLastPrice 
					end / 
					Case 
						when @Unity = 1 then 1
						when @Unity = 2 then Case when IsNull(UnityFact2,0) <> 0 then UnityFact2 end
						when @Unity = 3 then Case when IsNull(UnityFact3,0) <> 0 then UnityFact3 end
					 End * 
					 Case when (mt.CurrencyGuid = @CurrencyGuid) or (@CurrencyVal = 0) then 1
						   else CurrencyVal / @CurrencyVal end
		From
			Mat mt
		where
			Guid = @MatGuid
	end

	if @OpPrice = 8 
	begin
		Select
			@Price =
			Case 
				when @Unity = 1 then Price1
				when @Unity = 2 then Price2
				when @Unity = 3 then Price3
			end
		From
			MatUnitsPrice 	
		where
			MatGuid = @MatGuid
			AND Number = @SpecificPrice +1
	end
		
	Select @Price as [Price]
	

GO

SET ANSI_NULLS, QUOTED_IDENTIFIER ON
GO

Create Procedure PrcCalcElectricity (@Str Varchar(8000), @X Float)
 
as
	Set NoCount On
	Set @Str = REPLACE(UPPER(@Str), '[X]', Cast(@x as Varchar(50)))
	
	Set @Str = 'Select '+  +@Str +'  as [Value]'
	Print(@str)
	Exec(@str)


GO

SET ANSI_NULLS, QUOTED_IDENTIFIER ON
GO
Create View [vwDetailEntry]
 
as
	Select 
		[H].[Number] as [HNumber],
		[H].[Date] as [HDate],
		[H].[Note] as [HNote],
		[D].[Number] as [DNumber],
		[Ac].[Code]+'-'+[Ac].[Name] as [Account],
		[D].[Debit] as [DDebit],
		[D].[Credit] as [DCredit],
		[My].[Name] as [CurrencyName],
		[D].[CurrencyGuid],
		[D].[CurrencyVal] as [CurrencyVal],
		[D].[Note] as [DNote],
		[D].[AcGuid],
		[H].[Guid] as [HGuid]
	from 
		[vbHentry] [H] 
		inner join [Dentry] [D] On [D].[ParentGuid] = [H].[Guid]
		inner join [vwCurrency] [My] On [My].[Guid] = [D].[CurrencyGuid]
		inner join [vwAccount] [Ac] On [Ac].[Guid] = [D].[AcGuid]


GO

SET ANSI_NULLS, QUOTED_IDENTIFIER ON
GO

Create Trigger [TRG_ServicesContract_Del]
on [ServicesContract]
 
For delete
As
	Delete [Hentry] From [HEntry] Inner join [Deleted] On [Deleted].[Guid] = [HEntry].[Guid]

	Delete [Checks] From [Checks] inner join [Deleted] On [Deleted].[Guid] = [Checks].[ContractGuid]

	Delete [Hentry] 
	From 
		[HEntry] [H]
		Inner join [LinkCe] [L] on [L].[CeGuid] = [H].[Guid]
		Inner join [Deleted] On [Deleted].[Guid] = [L].[Guid]
		
	Delete [Secondary_Entry] 
	From 
		[Secondary_Entry] [H]
		Inner join [Deleted] On [Deleted].[Guid] = [H].[ContractGuid]
		
	Delete [Trace] From [Trace] inner join [Deleted] On [Deleted].[Guid] = [Trace].[ParentGuid]
	
		

GO

SET ANSI_NULLS, QUOTED_IDENTIFIER ON
GO

Create Procedure [PrcTestParkingUsed2]
(
	@MotherParkingGuid uniqueidentifier = '773E9079-47D2-48E4-BF75-EB5EE596ACEC',
	@Date1 DateTime = '10/1/2007',
	@Date2 DateTime = '10/1/2009'
)
 
as
	Select
		[L].*,
		Case when [ContractFinish] = 0 then [ToDate] else [ContractFinishDate]  end as [EndDate]
	into #Contract
	From
		[ParkingContract] [L]
		inner join [AccumulateParking] [A] on [A].[ParkingGuid] = [L].[parkingGuid]
	where 
		([A].[ParentGuid] = @MotherParkingGuid)		

		
	Select 
		[L].[Number],
		[T].[Name] as [ContractName],
		[L].[FromDate],
		[L].[ToDate],
		[L].[ContractKind],
		[L].[parkingGuid],
		[L].[Guid]
	From 
		#Contract [L] 
		inner join [ContractType] [T] On [T].[Guid] = [L].[TypeGuid]
		inner join [AccumulateParking] [A] on [A].[ParkingGuid] = [L].[parkingGuid]
	where 
		([A].[ParentGuid] = @MotherParkingGuid)		
		and 
		(
				(
					L.[ContractKind] = 5
					and	(
							([FromDate] <= @Date1 )
						 or ([FromDate] <= @Date2 )
						)
				)
				or 
				(
					L.[ContractKind] = 4
					and	([ContractFinish] = 0 )
				)

			)
			

GO

SET ANSI_NULLS, QUOTED_IDENTIFIER ON
GO

Create Procedure [dbo].[PrcPrintElectricityBill]
(
	@Guid uniqueidentifier = 0x0
)
 
as
	if @Guid = 0x0
	Select Top 1 @Guid = Guid From ElectricityBill
	
	Select 
		* 
	From 
		[vwElectricityBill] B
	where
		B.Guid = @Guid

GO

SET ANSI_NULLS, QUOTED_IDENTIFIER ON
GO
Create Procedure [PrcDeleteEntryDateHEntry]
(
	@Guid uniqueidentifier = 0x0
)
 
as
	Delete Hentry
	From
		Hentry [H]
		inner join [EntryDateDetail] [D] on [D].[Guid] = [H].[Guid]
	where 
		[D].[ParentGuid] = @Guid


GO

SET ANSI_NULLS, QUOTED_IDENTIFIER ON
GO
Create View [vbBuilding]
 
as
		Select 
			[T].*
		From
			[Building] [T]
			inner join [CurrentUsers] [U] on 
				([u].[Seclvl] >= Isnull([T].[SecLvl],0)  or [u].[Admin] = 1) 
				and [u].[spid] = @@Spid
			left join [BuildingPrivilege] V on V.[BuildingGuid] = T.Guid and U.UserGuid = v.UserGuid
			left join (
						Select 
							ParentGuid,
							SubString(Permit,4, 1) as [prm]
						from 
							[Realty_Detail_users] where IdCard = 1 			
						) p on p.ParentGuid = u.UserGuid 
		where
			(v.userGuid is Not Null or [u].[Admin] = 1)
			or (isnull(p.prm,0) = 0)

GO

SET ANSI_NULLS, QUOTED_IDENTIFIER ON
GO
Create View vwMaintenanceContractVisitRealty
 
as
	Select
		a.*,
		R.Name as Realty
	From
		[MaintenanceContractVisitRealty] [a]
		inner join vwAllRealty [R] on [R].Guid = [a].RealtyGuid

GO

SET ANSI_NULLS, QUOTED_IDENTIFIER ON
GO

Create Proc [prcRun]
(
	@Note Varchar(256)
)
 
as
	Insert into PRun
	([Note])
	Select
		@Note

GO

SET ANSI_NULLS, QUOTED_IDENTIFIER ON
GO

Create Procedure [PrcPrintAcquittance]
(
	@Guid uniqueidentifier = '262B85D7-CD9A-42A2-ADAD-CACA83A1558F'
)
 
as
	Create Table #Res
	(
		[CustomerName] Varchar(256),
		[BuildingName] Varchar(256),
		[Emirate] Varchar(256),
		[BuildingArea] Varchar(256),
		[Suburb] Varchar(256),
		[Street] Varchar(256),
		[BuildingNo] Varchar(256),
		[PieceNo] Varchar(256),
		[BasinNo] Varchar(256),
		[FlatNo] Varchar(256),
		[WaterCounter]Varchar(256),
		[ElectricityCounter] Varchar(256),
		[ContractElectricityCounter] Varchar(256),
		[ContractNo] Varchar(256),
	)


	insert into #Res
	Select 
		[Cu].[Name] as [CustomerName],
		[F].[BuildingName],
		[F].[Emirate],
		[F].[BuildingArea],
		[F].[Suburb],
		[F].[Street],
		[F].[BuildingNo],
		[F].[PieceNo],
		[F].[BasinNo],
		[F].[No] as [FlatNo],
		[F].[WaterCounter],
		[F].[ElectricityCounter],
		[C].[ElectricityCounter],
		[C].[ContractNo]
	From 
		[LeaseApartment] [C]
		inner join [vwApartment] [F] on [F].[Guid] = [C].[ApartmentGuid]
		inner join [Customer] [Cu] on [Cu].[Guid] = [C].[CustomerGuid]
	where
		[C]	.[Guid] = @Guid

	insert into #Res
	Select 
		[Cu].[Name] as [CustomerName],
		[F].[BuildingName],
		[F].[Emirate],
		[F].[BuildingArea],
		[F].[Suburb],
		[F].[Street],
		[F].[BuildingNo],
		'' as [PieceNo],
		'' as [BasinNo],
		[F].[No] as [FlatNo],
		[F].[WaterCounter],
		[F].[ElectricityCounter],
		[C].[ElectricityCounter],
		[C].[ContractNo]
	From 
		[LeaseApartment] [C]
		inner join [vwShop] [F] on [F].[Guid] = [C].[ApartmentGuid]
		inner join [Customer] [Cu] on [Cu].[Guid] = [C].[CustomerGuid]
	where
		[C]	.[Guid] = @Guid

	Select * from #Res


GO

SET ANSI_NULLS, QUOTED_IDENTIFIER ON
GO
Create View [vwCost]
 
as
	Select
		[C].[Number], 
		[C].[Guid], 
		[C].[Code], 
		[C].[LtnName], 
		[C].[ParentGUID], 
		[C].[Note],
		Case when (dbo.FnGetLangauge(@@spid) = 1) and (Isnull([C].[LtnName],'') <> '') then [C].[LtnName] else [C].[Name] end as [Name]
	From
		[vbCost] [C]


GO

SET ANSI_NULLS, QUOTED_IDENTIFIER ON
GO

Create Procedure [PrcAccountFavorite]
(
	@UserGuid uniqueidentifier = Null
)
 as
	if @UserGuid is Null
	Set @UserGuid = (SELECT Top 1 UserGuid FROM [AccountFavoriteConfig])

	Declare @AccountGuid uniqueidentifier, @I int
	
	Declare @CurrencyGuid uniqueidentifier,
			@CurrencyVal Float
	Set @CurrencyVal = (Select Top 1 Value From DMD_const where VName = 'AccountFavoriteConfigCurrencyVal')
	Set @CurrencyGuid = (Select Top 1 Value From DMD_const where VName = 'AccountFavoriteConfigCurrency')
	
	Create Table #AccountFavoriteTmp
	(
		[Number] int,
		[Code] Varchar(256),
		[Name] Varchar(256),
		[Debit] Float,
		[Credit] Float,
		[Balance]  Float,
		[Currency] Varchar(256),
		[Guid] uniqueidentifier
	)
	
	Create Table #fnGetAccountList
	(
		[Guid] uniqueidentifier,
		[Code] varchar(255),
		[Name] varchar(255),
		[Level] int,
		[Path] varchar(255)
	)	
	
	DECLARE @cursor_Name CURSOR 
	Set @cursor_Name = CURSOR FAST_FORWARD FOR 

	SELECT AccountGuid
	FROM [AccountFavoriteConfig]
	where UserGuid = @UserGuid
	--and accountGuid = '1496D712-1409-448A-B9C8-D248E304F36D'
	Order By Number
	
	OPEN @cursor_Name
	FETCH NEXT FROM @cursor_Name INTO @AccountGuid
	
	Set @I = 0
	WHILE @@FETCH_STATUS = 0
	BEGIN
		Select
			@CurrencyVal = CurrencyVal,
			@CurrencyGuid = CurrencyGuid
		From
			Account
		where
			Guid = @AccountGuid
			
		--Set @CurrencyVal = (Select Top 1 Value From DMD_const where VName = 'AccountFavoriteConfigCurrencyVal')
		--Set @CurrencyGuid = (Select Top 1 Value From DMD_const where VName = 'AccountFavoriteConfigCurrency')
		
		Truncate Table #fnGetAccountList
		insert into #fnGetAccountList
		Select * from dbo.fnGetAccountList(@AccountGuid)

		Set @I = @I +1
		insert into #AccountFavoriteTmp
		Select 
			@I,
			(Select Code from Account where Guid = @AccountGuid ) as Code,
			(Select Name from vwAccount where Guid = @AccountGuid ) as Name,
			SUM(Isnull(case when [En].[Debit] <> 0 then [En].[Debit] * 
			Case when [En].[CurrencyGuid] = @CurrencyGuid then 1 
			else [En].[CurrencyVal] / @CurrencyVal end
			end,0)) as [Debit],
			SUM(Isnull(case when [En].[Credit] <> 0 then [En].[Credit] * 
			Case when [En].[CurrencyGuid] = @CurrencyGuid then 1 
			else [En].[CurrencyVal] / @CurrencyVal end
			end,0)) as [Credit],
			SUM(Isnull(case when [En].[Debit] <> 0 then [En].[Debit] * 
			Case when [En].[CurrencyGuid] = @CurrencyGuid then 1 
			else [En].[CurrencyVal] / @CurrencyVal end
			end,0)
			-
			Isnull(case when [En].[Credit] <> 0 then [En].[Credit] * 
			Case when [En].[CurrencyGuid] = @CurrencyGuid then 1 
			else [En].[CurrencyVal] / @CurrencyVal end
			end,0)) as [Balance],
			(Select Code from vwCurrency where Guid = @CurrencyGuid ) as Currency,
			@AccountGuid
		From 
			DEntry en 
			inner join #fnGetAccountList L on L.GUID = en.AcGuid 
		
		--Group By
		--	Ac.Guid,
		--	Ac.Code ,Ac.Name
		--Select * from #AccountFavoriteTmp
		
	  FETCH NEXT FROM @cursor_Name INTO @AccountGuid
	END
	
	CLOSE @cursor_Name
	DEALLOCATE @cursor_Name
			
	Select * from #AccountFavoriteTmp Order By Number

GO

SET ANSI_NULLS, QUOTED_IDENTIFIER ON
GO

Create Procedure [PrcRecodeCost]
(
	@CoGuid uniqueidentifier = '4125827A-BA45-49E7-81C0-EC3E342977A9'
)
 
as
	Set NoCount on
	Declare @CoCount int
	Select 
		@CoCount = Count(*)
	From 
		[Cost]
	where
		[ParentGuid] = @CoGuid

	Set @CoCount = Len(Cast(@CoCount as Varchar(25)))

	Declare @Code Varchar(256)
	Select 
		@Code = Code
	From 
		[Cost]
	where
		[Guid] = @CoGuid

	Create Table #R
	(
		[Id] int identity(1,1),
		[Guid] uniqueidentifier 
	)
	
	insert into #R
		([Guid])
	Select 
		[Guid]
	From
		[Cost]
	where
		[ParentGuid] = @CoGuid
	Order By
		[Number]
 
	--    
	Declare @C Int
	Select 
		@C = Count(*)
	from 
		[Cost] [Ac] 
		inner join #R R on @Code+ dbo.FnFormatNumber([R].[id], @CoCount) = [Ac].[Code] and [R].[Guid] <> [Ac].[Guid]
	where
		[Ac].[ParentGuid] <> @CoGuid

	if isnull(@C,0) > 0
	begin
		Declare @AcR Varchar(256)
		Declare @Msgerror Varchar(256)
	
		Select Top 1 
			@AcR = [Ac].[Code]+'-'+[Ac].[Name]
		from 
			[Cost] [Ac] 
			inner join #R R on @Code+ dbo.FnFormatNumber([R].[id], @CoCount) = [Ac].[Code] and [R].[Guid] <> [Ac].[Guid]
		where
			[Ac].[ParentGuid] <> @CoGuid

		--print @AcR
		
		Set @Msgerror = '           ' + @AcR
		RAISERROR (@Msgerror, 16, 1)
	end

	
	Alter Table [Cost] disable trigger all
	
	update 
		[Cost]
	Set 
		[Code] = @Code+ dbo.FnFormatNumber([id], @CoCount)
	From
		[Cost] [Ac]
		inner join [#R] On [#R].[Guid] = [Ac].[Guid]

	Alter Table [Cost] enable trigger all
	

GO

SET ANSI_NULLS, QUOTED_IDENTIFIER ON
GO

Create View [vwMatDescriptionPrice]
 
as
	Select 
		G.Number,
		[m].[matGuid] ,
		Case when (dbo.FnGetLangauge(@@spid) = 1) and (Isnull([G].[LtnName],'') <> '') then [G].[LtnName] else [G].[Name] end AS [PriceKind],
		[m].[price1], 
		[m].[price2], 
		[m].[price3]
	From 
		[MatDescriptionConfig] [g]
		left join [MatUnitsPrice] [m] on [m].[Number] = [g].[Number]
	where
		[Kind] = 1
	
		

GO

SET ANSI_NULLS, QUOTED_IDENTIFIER ON
GO
Create Procedure dbo.[PrcRepaireCashPayment]
 
as
	Declare @Guid uniqueidentifier, @ContractGuid uniqueidentifier
	
	DECLARE cursor_Name CURSOR FAST_FORWARD FOR 
	Select 
		S.Guid, S.ContractGuid
	from 
		Secondary_Entry S
		left join [ContractCachPayment] C on C.EntryGuid = S.Guid
		inner join [vwAllContract] A on A.Guid = S.contractGuid
	where 
		(C.EntryGuid is null)
		and S.ContractGuid is Not Null
		and A.Kind = 0
		
	
	
	OPEN cursor_Name
	FETCH NEXT FROM cursor_Name INTO @Guid, @ContractGuid
	
	WHILE @@FETCH_STATUS = 0
	BEGIN
	  exec [PrcCreateEntryFromEntryType] @Guid, @ContractGuid
	  
	  FETCH NEXT FROM cursor_Name INTO @Guid, @ContractGuid
	
	END
	
	CLOSE cursor_Name
	DEALLOCATE cursor_Name
	
	DECLARE cursor_Name CURSOR FAST_FORWARD FOR 
	Select 
		S.Guid, S.ContractGuid
	from 
		Secondary_Entry S
		left join [ContractParkingCachPayment] C on C.EntryGuid = S.Guid
		inner join [vwAllContract] A on A.Guid = S.contractGuid
	where 
		(C.EntryGuid is null)
		and S.ContractGuid is Not Null
		and A.Kind = 1
	
	
	OPEN cursor_Name
	FETCH NEXT FROM cursor_Name INTO @Guid, @ContractGuid
	
	WHILE @@FETCH_STATUS = 0
	BEGIN
	  exec [PrcCreateEntryFromEntryType] @Guid, @ContractGuid
	  
	  FETCH NEXT FROM cursor_Name INTO @Guid, @ContractGuid
	
	END
	
	CLOSE cursor_Name
	DEALLOCATE cursor_Name


	--------------
	DECLARE cursor_Name CURSOR FAST_FORWARD FOR 
	Select 
		S.Guid, S.ContractGuid
	from 
		Secondary_Entry S
		left join [LandContractCachPayment] C on C.EntryGuid = S.Guid
		inner join [vwAllContract] A on A.Guid = S.contractGuid
	where 
		(C.EntryGuid is null)
		and S.ContractGuid is Not Null
		and A.Kind = 2
	
	
	OPEN cursor_Name
	FETCH NEXT FROM cursor_Name INTO @Guid, @ContractGuid
	
	WHILE @@FETCH_STATUS = 0
	BEGIN
	  exec [PrcCreateEntryFromEntryType] @Guid, @ContractGuid
	  
	  FETCH NEXT FROM cursor_Name INTO @Guid, @ContractGuid
	
	END
	
	CLOSE cursor_Name
	DEALLOCATE cursor_Name

	--------------
	DECLARE cursor_Name CURSOR FAST_FORWARD FOR 
	Select 
		S.Guid, S.ContractGuid
	from 
		Secondary_Entry S
		left join [ElectricityCachPayment] C on C.EntryGuid = S.Guid
		inner join [vwAllContract] A on A.Guid = S.contractGuid
	where 
		(C.EntryGuid is null)
		and S.ContractGuid is Not Null
		and A.Kind = -1
	
	
	OPEN cursor_Name
	FETCH NEXT FROM cursor_Name INTO @Guid, @ContractGuid
	
	WHILE @@FETCH_STATUS = 0
	BEGIN
	  exec [PrcCreateEntryFromEntryType] @Guid, @ContractGuid
	  
	  FETCH NEXT FROM cursor_Name INTO @Guid, @ContractGuid
	
	END
	
	CLOSE cursor_Name
	DEALLOCATE cursor_Name
		

GO

SET ANSI_NULLS, QUOTED_IDENTIFIER ON
GO

	Create View [vbBranch]
	 
	as
		Select 
			[T].*
		From
			[Branch] [T]
			inner join [CurrentUsers] [U] on ([u].[Seclvl] >= Isnull([T].[SecLvl],0)  or [u].[Admin] = 1) and [u].[spid] = @@Spid
GO

SET ANSI_NULLS, QUOTED_IDENTIFIER ON
GO

Create Procedure [dbo].[PrcMarkCheckFromLandContract]
(
	@Guid uniqueidentifier = '4A098C65-3D29-42E6-91AF-5BE1BC75D64C',
	@Mark bit = 1
)
 
as
	update
		[Checks] 
	Set
		Mark = @Mark
	from
		[Checks] [C]
	where
		[C].[ContractGuid] = @Guid 

GO

SET ANSI_NULLS, QUOTED_IDENTIFIER ON
GO

Create Procedure [PrcTestRealtyRestrained]
(
	@BuildingGuid uniqueidentifier = '8874D8BB-D8C6-4CEE-A386-C6AC00B5896A',
	@Date DateTime = '9/1/2009',
	@RealtyType int = 0,
	@RealtyNo Varchar(256) = '0202'
)
 
as
	Select 
		* 
	From 
		[RealtyRestrained] [R]
	where
		([BuildingGuid] = @BuildingGuid)
		and (
				Case 
				when @RealtyType = 0 then (Select [No] From [vwApartment] where [Guid] = [R].[FlatGuid])
				when @RealtyType = 1 then (Select [No] From [vwShop] where [Guid] = [R].[Shop])
				when @RealtyType = 2 then (Select [No] From [vwParking] where [Guid] = [R].[ParkingNo])
				end = @RealtyNo
			)
 		and (@Date >= [Date])
 		and (@Date <= [EndDate] or [EndDateSpecific] = 0)
 		and ([RestrainedCanceld] = 0)

GO

SET ANSI_NULLS, QUOTED_IDENTIFIER ON
GO
Create View [vwLastFlatContract]
 
as

	Select 
		[C].[Guid],
		[C].[ApartmentGuid],
		[ContractState],
		[FlatState]
	From
		[vwLeaseApartment] [C]
		inner join (
						Select 
								ApartmentGuid,
								Max([FromDate]) [MaxDate]
						From
							[LeaseApartment]
						Group By
							[ApartmentGuid]
					) [C2] on [C2].[ApartmentGuid] = [C].[ApartmentGuid] 
							and [C].[FromDate] = [C2].[MaxDate] 

GO

SET ANSI_NULLS, QUOTED_IDENTIFIER ON
GO

	Create View [vbExternalTools]
	 
	as
		Select 
			[T].*
		From
			[ExternalTools] [T]
			inner join [CurrentUsers] [U] on ([u].[Seclvl] >= Isnull([T].[SecLvl],0)  or [u].[Admin] = 1) and [u].[spid] = @@Spid
GO

SET ANSI_NULLS, QUOTED_IDENTIFIER ON
GO

Create Procedure [PrcAutoRenewalContractParking]
(
	@MaxDate int = 42644
)
 
as
	Select 0 as [RowCount], 0 as FailCount
	return	
	

GO

SET ANSI_NULLS, QUOTED_IDENTIFIER ON
GO

Create Procedure [dbo].[PrcSetCurrentAssetsArea]
(
	@AssetsGuid uniqueidentifier = 'F8453488-FA93-4D8A-A581-5A63BB953A08'
)
 
as
	Declare @AssetsAreaGuid uniqueidentifier
	Select Top 1 
		@AssetsAreaGuid = [AreaGuid]
	From 
		[AssetsChangeArea]
	where
		[AssetsGuid] = @AssetsGuid
	Order By
		DATE desc, Number Desc
	
	if ISNULL(@AssetsAreaGuid, 0x0) = 0x0
	Set @AssetsAreaGuid = (Select [AssetsAreaGuid] from Assets where Guid = @AssetsGuid)
	
	Update Assets set [CurrentAssetsAreaGuid] = @AssetsAreaGuid where Guid = @AssetsGuid
	
	

GO

SET ANSI_NULLS, QUOTED_IDENTIFIER ON
GO

Create Procedure [PrcTestFlatUsedForRestrained]
(
	@FlatGuid uniqueidentifier = '0711A702-62FF-4913-B00F-8084D8E2DF6D',
	@FromDate DateTime = '2009-9-1',
	@ToDate DateTime = '2009-9-30'
)
 
as
	
	Select
		[FromDate],
		[ToDate],
		[ContractFinishDate],
		*
	from
		[LeaseApartment]
	where
		([ApartmentGuid] =@FlatGuid)
		and (
				(
					[ContractFinish] = 0
					and
					(
					   (@FromDate between [FromDate] and (Case when [ContractFinish] = 0 then [ToDate] else [ContractFinishDate] end))
					or(
					     @ToDate between [FromDate] and (Case when [ContractFinish] = 0 then [ToDate] else [ContractFinishDate] end)
					   )
					or(
					     @ToDate between [FromDate] and (Case when [ContractFinish] = 0 then [ToDate] else [ContractFinishDate] end)
					   )
					or(
					    [FromDate] between @FromDate and @ToDate
					   )
					or((Case when [ContractFinish] = 0 then [ToDate] else [ContractFinishDate] end) between @FromDate and @ToDate)
				   )
				)
			or
			(
					[ContractFinish] = 1
					and [ContractFinishDate] > @FromDate
			))

GO

SET ANSI_NULLS, QUOTED_IDENTIFIER ON
GO

Create Procedure [PrcTestParkingUsedForRestrained]
(
	@ParkingGuid uniqueidentifier = '0711A702-62FF-4913-B00F-8084D8E2DF6D',
	@FromDate DateTime = '2009-9-1',
	@ToDate DateTime = '2009-9-30'
)
 
as
	
	Select
		[FromDate],
		[ToDate],
		[ContractFinishDate],
		*
	from
		[ParkingContract]
	where
		([ParkingGuid] =@ParkingGuid)
		and (
				(
					[ContractFinish] = 0
					and
					(
					   (@FromDate between [FromDate] and (Case when [ContractFinish] = 0 then [ToDate] else [ContractFinishDate] end))
					or(
					     @ToDate between [FromDate] and (Case when [ContractFinish] = 0 then [ToDate] else [ContractFinishDate] end)
					   )
					or(
					     @ToDate between [FromDate] and (Case when [ContractFinish] = 0 then [ToDate] else [ContractFinishDate] end)
					   )
					or(
					    [FromDate] between @FromDate and @ToDate
					   )
					or((Case when [ContractFinish] = 0 then [ToDate] else [ContractFinishDate] end) between @FromDate and @ToDate)
				   )
				)
			or
			(
					[ContractFinish] = 1
					and [ContractFinishDate] > @FromDate
			))

GO

SET ANSI_NULLS, QUOTED_IDENTIFIER ON
GO

Create View [vwApartment]
 
as
	Select
		*
	From
		[vwApartmentAll] [A]
	where
		isNull(A.Ban,0) = 0 

GO

SET ANSI_NULLS, QUOTED_IDENTIFIER ON
GO

Create View [vwParking]
 
as

	Select
		*
	From
		[vwParkingAll] [A]
	where
		isNull(A.Ban,0) = 0 


GO

SET ANSI_NULLS, QUOTED_IDENTIFIER ON
GO

Create Procedure [PrcTreeMats]
(
	@AcGuid uniqueidentifier = 'FC3E0B64-1360-4359-8568-49126CA5F153'
)
 
as
	Declare @Level int
	Set @Level = Case when @AcGuid = 0x0 then 0 else 3 end

	Create Table #Res 
	(
		[Number] int, 
		[Guid] uniqueidentifier, 
		[Type] int, 
		[Code] Varchar(256) COLLATE database_default, 
		[Name] Varchar(256) COLLATE database_default, 
		[LtnName] Varchar(256) COLLATE database_default, 
		[ParentGuid]uniqueidentifier,
		[level] int,
		[Path]  Varchar(256) COLLATE database_default
	)

	insert into #Res
	Select
		[A].[Number], 
		[A].[Guid], 
		1 as [Type], 
		[A].[Code], 
		Case when (dbo.FnGetLangauge(@@spid) = 1) and (Isnull([A].[LtnName],'') <> '') then [A].[LtnName] else [A].[Name] end as [Name], 
		[A].[LtnName],
		case when [A].[ParentGuid] is Not Null then [A].[ParentGuid] else 0x0 end as [Parent],
		f.level,
		[F].[Path]
	From 
		[vbMatGroup] [A]
		inner join [dbo].[fnGetGroupList](@AcGuid) [F] on [F].[Guid] = [A].[Guid]
	--where
	--	[Level] <= 1

/*
	insert into #Res
	Select
		[A].[Number], 
		[A].[Guid], 
		2 as [Type], 
		[A].[Code], 
		Case when (dbo.FnGetLangauge(@@spid) = 1) and (Isnull([A].[LtnName],'') <> '') then [A].[LtnName] else [A].[Name] end as [Name], 
		[A].[LtnName],
		case when [A].[GroupGuid] is Not Null then [A].[GroupGuid] else 0x0 end as [Parent],
		[F].[Path]
	From 
		[vbMat] [A]
		inner join [dbo].[fnGetGroupList](@AcGuid) [F] on [F].[Guid] = [A].[GroupGuid]
*/

	--CREATE INDEX IXS_Guid ON #Res ([Guid])
	
	Delete #Res where Guid = @AcGuid
	-----------------------------------------------------------------------------------
	CREATE INDEX IXS_Res_Path ON #Res ([Path], [Type], [Code])
	Alter Table #Res add Id int identity(1,1)
	
	Select 
		*
		--,Len([Path]) / 9 as [level]
		,(select id from #Res rp where rp.guid = r.Parentguid) as [ParentId]
	from 
		#Res r
	ORDER BY 
		Id
	
	

GO

SET ANSI_NULLS, QUOTED_IDENTIFIER ON
GO

Create View [AllAccount]
 
as
	Select
		[Number], [Guid], [Code], [ParentGuid], [Note], 
		[CDate], [NSons], [CurrencyGUID], [CurrencyVal], 
		[Type], [FinalGUID], [LtnName],[Name]
		,case when [ParentGuid] is Not Null then [ParentGuid] else 0x0 end as [Parent]
		--,(Select Top 1 [ParentGuid] From [Dentry] [D] where [D].[AcGuid] = [Ac].[Guid]) as [ENGuid]
	From 
		[vwAccount] [Ac]
	where 
		([Type] = 0 or [Type] = 2)


GO

SET ANSI_NULLS, QUOTED_IDENTIFIER ON
GO

	Create View [vbCustomer]
	 
	as
		Select 
			[T].*
		From
			[Customer] [T]
			inner join [CurrentUsers] [U] on ([u].[Seclvl] >= Isnull([T].[SecLvl],0)  or [u].[Admin] = 1) and [u].[spid] = @@Spid
GO

SET ANSI_NULLS, QUOTED_IDENTIFIER ON
GO

Create Procedure [dbo].[PrcCreateAssetsEntry]
(
	@Guid uniqueidentifier = 'C5D0C5DC-964A-4596-AE42-761427E00350'
)
 
as
	Declare @CeNumber Int
	Select
		@CeNumber = Number
	From
		HEntry
	where
		Guid = @Guid
		
	if isNull(@CeNumber,0) = 0
	Set @CeNumber = (Select isNull(MAX(Number),0) + 1 From HEntry)

	Delete
		HEntry
	where
		Guid = @Guid
		
	if Not exists(Select Top 1 Guid from Assets where Guid = @Guid and CreateEntry = 1) return
	
	Declare @AccountGuid uniqueidentifier, 
			@ObverseAcGuid uniqueidentifier
			
	Select
		@AccountGuid = A.AsstesAccountGuid,
		@ObverseAcGuid = A.EnterAccountGuid
	From
		Assets A
	where
		A.[Guid] = @Guid
				

	Insert Into [HEntry]
	([Guid],[SecLvl],[Number],[Date], [CurrencyGuid], [CurrencyVal], [Note], [ParentKind], [BranchGuid], [IsPosted])
	Select
		@Guid,
		[SecLvl],
		@CeNumber,
		[EnterDate],
		[CurrencyGuid],
		[CurrencyVal],
		[EnterNote],
		150, 
		Null,
		1
	From
		[Assets]
	where
		Guid = @Guid

	Declare @DetailNum Int
	Set @DetailNum = 0

	Insert into [DEntry]
 	([ParentGuid],[Number],[AcGuid],[Debit],[Credit],[CurrencyGuid],[CurrencyVal],[CostGuid],[ObverseAcGuid],[Note])
	Select
		@Guid,
		@DetailNum,
		@AccountGuid,
		A.[EnterValue],
		0,
		A.CurrencyGUID,
		A.CurrencyVal,
		[EnterCostGuid],
		@ObverseAcGuid,
		A.[EnterNote]
	From
		[Assets] A
	where
		A.[Guid] = @Guid
				
	Set @DetailNum = @DetailNum + 1
	
	Insert into [DEntry]
 	([ParentGuid],[Number],[AcGuid],[Debit],[Credit],[CurrencyGuid],[CurrencyVal],[CostGuid],[ObverseAcGuid],[Note])
	Select
		@Guid,
		@DetailNum,
		@ObverseAcGuid,
		0,
		A.[EnterValue],
		A.CurrencyGUID,
		A.CurrencyVal,
		A.[EnterCreditCostGuid],
		@AccountGuid,
		A.[EnterNote]
	From
		[Assets] A
	where
		A.[Guid] = @Guid

	Select * from [HEntry] where Guid = @Guid
	Select * from [DEntry] where parentGuid = @Guid
			

GO

SET ANSI_NULLS, QUOTED_IDENTIFIER ON
GO

Create Procedure [dbo].[PrcCreateAssetsDepreciationEntry]
(
	@Guid uniqueidentifier = 'E032C97D-7824-4087-8698-D0E2748F555C'
)
 
as
	Declare @CeNumber Int
	Select
		@CeNumber = Number
	From
		HEntry
	where
		Guid = @Guid
		
	if isNull(@CeNumber,0) = 0
	Set @CeNumber = (Select isNull(MAX(Number),0) + 1 From HEntry)
	

	Delete
		HEntry
	where
		Guid = @Guid
		
	if Not exists(Select Top 1 Guid from [AssetsDepreciation] where Guid = @Guid and CreateEntry = 1 and IsRounded = 0) return
	
	Insert Into [HEntry]
	([Guid],[SecLvl],[Number],[Date], [CurrencyGuid], [CurrencyVal], [Note], [ParentKind], [BranchGuid], [IsPosted])
	Select
		@Guid,
		[SecLvl],
		@CeNumber,
		[Date],
		[CurrencyGuid],
		[CurrencyVal],
		[Note],
		158, 
		Null,
		1
	From
		[AssetsDepreciation]
	where
		Guid = @Guid
			

	Declare @DetailNum Int
	Set @DetailNum = 0

	Insert into [DEntry]
 	([ParentGuid],[Number],[AcGuid],[Debit],[Credit],[CurrencyGuid],[CurrencyVal],[CostGuid],[ObverseAcGuid],[Note])
	Select
		@Guid,
		D.Number,
		S.DepreciationAccountGuid,
		D.DepreciationValue,
		0,
		A.CurrencyGUID,
		A.CurrencyVal,
		A.DebitCostGUID,
		S.DepreciationTotalAccountGuid,
		A.[Note]
	From
		[Assets] S
		inner join [AssetsDepreciationDetail] D on D.AssetsGuid = S.Guid
		inner join [AssetsDepreciation] A on A.Guid = D.ParentGuid
	where
		D.[ParentGuid] = @Guid
				
	Insert into [DEntry]
 	([ParentGuid],[Number],[AcGuid],[Debit],[Credit],[CurrencyGuid],[CurrencyVal],[CostGuid],[ObverseAcGuid],[Note])
	Select
		@Guid,
		D.Number + 1,
		S.DepreciationTotalAccountGuid,
		0,
		D.DepreciationValue,
		A.CurrencyGUID,
		A.CurrencyVal,
		A.CreditCostGUID,
		S.DepreciationAccountGuid,
		A.[Note]
	From
		[Assets] S
		inner join [AssetsDepreciationDetail] D on D.AssetsGuid = S.Guid
		inner join [AssetsDepreciation] A on A.Guid = D.ParentGuid
	where
		D.[ParentGuid] = @Guid
		
	Select * from [HEntry] where Guid = @Guid
	Select * from [DEntry] where parentGuid = @Guid
			

GO

SET ANSI_NULLS, QUOTED_IDENTIFIER ON
GO

Create Procedure [PrcDailyContractDetail]
(
	@CurrencyGuid uniqueidentifier = '11111111-C748-4B13-8B91-1E9B299DF1C1',
	@CurrencyVal Float = 100,
	@State int = 2,
	@Date1 DateTime = '1/1/2007',
	@Date2 DateTime = '1/1/2010'
	,@ContractActiveNote Bit = 0
	,@ContractOpNote int = 0
	,@ContractNote  Varchar(256) = '' 

)
 
as
	if isnull(@CurrencyVal, 0) = 0
	Set @CurrencyVal = 1

	--  
	if @ContractOpNote = 0 --
	Set @ContractNote = '%'+@ContractNote+'%'

	--
	Select 
		dbo.fnDateOnly([EditDate]) as [EditDate],
		[TypeName],
		[Number],
		[ContractNo],
		[BuildingName],
		Case when [NewState] = 0 then dbo.SC('') 
			 when [NewState] = 1 then dbo.SC('') 
		end As [State],
		[C].[NewState],
		([Value] * [CurrencyVal]) / Case when [CurrencyGuid] = @CurrencyGuid then [CurrencyVal] else @CurrencyVal end as [Value],
		[P].[CachValue],
		[K].[CheckValue],
		[C].[Note2],
		0 as [Kind],
		[C].[Guid]
	into #Res1
	From 
		[vwAllContract] [C]
		inner join [Resource] [R] on [R].[Guid] = [C].[TypeGuid] and [spid] = @@Spid
		left join (
					Select
						[Cp].[ContractGuid],
						Sum(
							([Cp].[Value] * [Cp].[CurrencyVal]) / Case when [Cp].[CurrencyGuid] = @CurrencyGuid then [Cp].[CurrencyVal] else @CurrencyVal end 
						   )
						as [CachValue]
					From
						[vwContractCachPayment] [Cp]
					Group By
						[Cp].[ContractGuid]
					) [P] on [P].[ContractGuid] = [C].[Guid]
		left join (
					Select
						[Ck].[ContractGuid],
						Sum(
							([Ck].[Value] * [Ck].[CurrencyVal]) / Case when [Ck].[CurrencyGuid] = @CurrencyGuid then [Ck].[CurrencyVal] else @CurrencyVal end 
						   )
						as [CheckValue]
					From
						[vwChecks] [Ck]
					Group By
						[Ck].[ContractGuid]
				  ) [K] on [K].[ContractGuid] = [C].[Guid]
	where
		(dbo.fnDateOnly([EditDate]) between @Date1 And @Date2)


		and 
			(
				[C].[Note2] Like @ContractNote 
				or @ContractActiveNote = 0
			)

		and ([NewState] = @State or @State = 2) 	

	Order By
		[TypeName],[EditDate], [Number]

	Select 
		*, 
		isNull([CachValue],0) + isNull([CheckValue],0) as [TotalValue] ,
		-(([Value]) - IsNull(([CachValue]),0) - IsNull(([CheckValue]),0)) as [Rest]
	from 
		#Res1

	Select 
		[State],
		Count([Number]) as [Count],	
		Sum([Value]) as [Value],
		Sum([CachValue]) as [CachValue],
		Sum([CheckValue]) as [CheckValue],
		Sum([Value]) - IsNull(Sum([CachValue]),0) - IsNull(Sum([CheckValue]),0) as [Rest]
	From
		#Res1
	Group by
		[NewState], [State]
	Order By
		[NewState]
		

GO

SET ANSI_NULLS, QUOTED_IDENTIFIER ON
GO

Create Procedure [dbo].[PrcCreateEntryForContractFirstPay]
(
	@EntryTypeGuid uniqueidentifier = '28291D9D-4954-42FD-BCFA-25AF9187005D',
	@EntryGuid uniqueidentifier = 'F9A849C9-926E-470A-8317-A3A7B89826E2',
	@PayDateDate DateTime = '1/23/2016',
	@AccountFirstpay uniqueidentifier = 0x0,
	@AccountGuid uniqueidentifier = '52E2F7D3-0811-4D3A-A387-91BF54EC72E1',
	@CurrencyGuid uniqueidentifier = '11111111-C748-4B13-8B91-1E9B299DF1C1',
	@CurrencyVal Float = 1,
	@Note Varchar(256) = '',
	@BranchGuid uniqueidentifier = Null,
	@BuildingGuid uniqueidentifier = 0x0,
	@ContractGuid uniqueidentifier = '1EBCE41E-B1E8-410E-974A-3298FB403DCC',
	@FirstPayAmount Float = 500,
	@CostFirstpay  uniqueidentifier = 0x0
)
 
as
	Declare @Number int
	Select @Number = ISNULL(MAX(Number), 0) + 1 From [Secondary_Entry] where TypeGuid = @EntryTypeGuid
	if IsNull(@Number, 0) = 0
	Set @Number = 1
	
	select 
		@AccountFirstpay = B.[CashAccountGuid]
	from
		Building B 
	where
		B.Guid = @BuildingGuid
		
	if IsNull(@AccountFirstpay,0x0) = 0x0
	select 
		@AccountFirstpay = B.[CashAccountGuid]
	from
		Villa B 
	where
		B.Guid = @BuildingGuid
		
	
	if IsNull(@AccountFirstpay , 0x0) = 0x0
	Select
		@AccountFirstpay = [DefAccountGuid]
	From
		[EntryType]
	where
		Guid = @EntryTypeGuid
	
	if isNull(@AccountFirstpay,0x0) = 0x0
	begin
		Declare @Msg varchar(255)
		Set @Msg = dbo.SC('     ')
		RAISERROR (@Msg, 16, 1);
		return
	end			

	Declare @CheckCreateEntry bit
	Select 
			@CheckCreateEntry = [T].[CreateEntry]			
	From
		[EntryType] [t] 
	where
		Guid = @EntrytypeGuid
		
	insert into [Secondary_Entry]
	([Guid],[Number],[Seclvl],[Mark],[Date],[AccountGuid],[Kind],[CurrencyGuid],[CurrencyVal],[Note],[BranchGuid],[TypeGuid],[ContractGuid],[CheckCreateEntry],[SalesManGuid])
	Select
		@EntryGuid,
		@Number,
		0 as [Seclvl],
		0 as [Mark],
		@PayDateDate as [Date],
		@AccountFirstpay as [AccountGuid],
		0 as [Kind],
		@CurrencyGuid as [CurrencyGuid],
		@CurrencyVal as [CurrencyVal],
		@Note as [Note],
		@BranchGuid as [BranchGuid],
		@EntryTypeGuid as [TypeGuid],
		@ContractGuid as [ContractGuid],
		@CheckCreateEntry as [CheckCreateEntry],
		Null as [SalesManGuid]
		
	insert into [Secondary_EntryDetail]
	([ParentGuid],[Number],[AcGuid],[Debit],[Credit],[CurrencyGuid],[CurrencyVal],[Note],[ObverseAcGuid],[CostGuid])
	Select
		@EntryGuid,
		1 as [Number],
		@AccountGuid as [AcGuid],
		0 as [Debit],
		@FirstPayAmount as [Credit],
		@CurrencyGuid,
		@CurrencyVal,
		@Note,
		@AccountFirstpay as [ObverseAcGuid],
		Case when @CostFirstpay <> 0x0  then @CostFirstpay end [CostGuid]
		
	exec [PrcCreateEntryFromEntryType] @EntryGuid, @ContractGuid
		

GO

SET ANSI_NULLS, QUOTED_IDENTIFIER ON
GO

Create Procedure [PrcRenumberChecks]
 
as
	
	Create Table #T
	(
		[Id] int Identity(1,1),
		[Guid] Uniqueidentifier
	)
	
	Declare @TypeGuid Uniqueidentifier
	
	Alter Table [Checks] Disable Trigger All
	DECLARE cursor_Name CURSOR FAST_FORWARD FOR 
	SELECT Distinct [TypeGuid] 
	FROM Checks
	
	OPEN cursor_Name
	FETCH NEXT FROM cursor_Name INTO @TypeGuid
	
	WHILE @@FETCH_STATUS = 0
	BEGIN
		Truncate Table #T

		insert into #T
		([Guid])	
		Select 
			[Guid]
		From
			[Checks]
		where 
			[TypeGuid] = @TypeGuid
		Order By
			[Number]

		update 	[Checks]
		Set [Number] = [T].[Id]
		From
			[Checks] [C]
			inner join #T [T] On [T].[Guid] = [C].[Guid]


	  FETCH NEXT FROM cursor_Name INTO @TypeGuid
	
	END
	
	CLOSE cursor_Name
	DEALLOCATE cursor_Name

	Alter Table [Checks] Enable Trigger All



GO

SET ANSI_NULLS, QUOTED_IDENTIFIER ON
GO
Create Procedure [PrcTransfer_LeaseApartment]
(
	@RoKind int = 0,
	@ToDataBaseName Varchar(256) = 'Aq11',
	@UntilDate Datetime = '2016-12-31',
	@BeginDate Datetime = '2017-1-1',
	@RoundContractWithCheckNotCollection bit = 0
)
 
as
	Print '---PrcTransfer_LeaseApartment---'
	
	Set nocount on
	if (@RoKind = 1) Return --  
	
	Declare @V Varchar(8000)
	
	EXEC PrcDeleteTable 'ParkingContract',@ToDataBaseName
	EXEC PrcDeleteTable 'LeaseApartment',@ToDataBaseName
	
	Set @V = '
			where 
				[ContractFinish] = 0
				or ([Guid] in (Select ContractGuid from lawsuit where [IsEnded] = 0))'
	if (@RoKind = 2) --    
	Set @V = @v + '
	or EditDate >='+''''+CAST(@UntilDate as varchar(255))+''''
				
	if (@RoundContractWithCheckNotCollection = 1) --       
	Set @V = @v + '
	or ([Guid] in (Select ContractGuid from vwChecksCollectionState where [IsCollection] = 0))'

	EXEC PrcTransferTable  'LeaseApartment',@ToDataBaseName, @V
							
	Set @V = '
	Alter Table '+@ToDataBaseName+'..[LeaseApartment] Disable Trigger All'
	exec (@v)

	--        
	Set @V = '
	UpDate '+@ToDataBaseName+'..[LeaseApartment] Set [IsRounded] = 1 where EditDate <='+''''+CAST(@UntilDate as varchar(255))+''''
	exec(@V)

	--        
	Set @V = '
	UpDate '+@ToDataBaseName+'..[LeaseApartment] Set [IsRounded] = 1 
	From
		'+@ToDataBaseName+'..[LeaseApartment] L
		inner join HEntry H on L.Guid = H.Guid 
	where H.Date <'+''''+CAST(@UntilDate as varchar(255))+''''
	Print(@V)
	exec(@V)

 	Set @V = 'Update '+@ToDataBaseName+'..[LeaseApartment] Set EditDate = '''+CAST(@BeginDate as VARchar(20))+'''where [IsRounded] = 1 '
	exec(@V)

	Set @V = '
	Alter Table '+@ToDataBaseName+'..[LeaseApartment] Enable Trigger All'
	exec (@v)
	
	-- 
	Set @V = '
	inner join '+@ToDataBaseName+'..LeaseApartment L on L.Guid = [Tb].[ParentGuid]
	inner join '+@ToDataBaseName+'..Account Ac on Ac.Guid = [Tb].[AccountGuid]
	'
	EXEC PrcTransferTable  'FlatContractFee',@ToDataBaseName, @V

	Set @V = '
	exec '+@ToDataBaseName+'..[PrcReNumberCard]
		0, --@Entry
		0, --@FirstEntryNum
		0, --@EntryType
		0x0, --@EntryTypeGuid
		0, --@FirstEntryTypeNum
		1, --@ContractType
		0x0, --@ContractTypeGuid 
		0, --@FirstContractTypeNum
		0, --@CheckType
		0x0, --@CheckTypeGuid 
		0, --@FirstCheckTypeNum
		0, --@Flat
		0, --@Shop
		0, --@Parking
		0, --@Land
		0, --@Villa
		0, --@Account
		0x0, --@ElectricityBillType
		0x0, --@ElectricityBillTypeGuid
        0 --@Cust
		'
	PRINT @V
	exec(@V)
        
        	
	--  
	Set @V = '
	Delete '+@ToDataBaseName+'..[Resource]'
	exec (@v)
	
	Set @V = '
	insert into '+@ToDataBaseName+'..[Resource]
	([Guid], [Kind])
	Select Guid, 1 from '+@ToDataBaseName+'..ContractType'
	exec (@v)
	
	Set @V = '
	exec '+@ToDataBaseName+'..PrcReCreateContractFlatShopEntry 0, 0, 0, 0, 0,0,0,0'
	--Sql.Add('exec PrcReCreateContractFlatShopEntry :Date1, :Date2, :ActiveDate, :Datewith, :Num1, :Num2, :ActiveNum, :MaxDate');

	Print @v
	exec (@v)



GO

SET ANSI_NULLS, QUOTED_IDENTIFIER ON
GO

	Create View [vbLeaseApartment]
	 
	as
		Select 
			[T].*
		From
			[LeaseApartment] [T]
			inner join [CurrentUsers] [U] on ([u].[Seclvl] >= Isnull([T].[SecLvl],0)  or [u].[Admin] = 1) and [u].[spid] = @@Spid
GO

SET ANSI_NULLS, QUOTED_IDENTIFIER ON
GO
Create Procedure [PrcDeleteEntryContractFee]
(
	@Guid uniqueidentifier = 'A3D19ED0-88BB-47F6-857F-F1F30830FEAD'
)
 
as
	Delete Hentry
	From
		Hentry [H]
		inner join FlatContractFee [D] on [D].[Guid] = [H].[Guid]
	where 
		[D].[ParentGuid] = @Guid

	Delete Hentry
	From
		Hentry [H]
		inner join ParkingContractFee [D] on [D].[Guid] = [H].[Guid]
	where 
		[D].[ParentGuid] = @Guid

	Delete Hentry
	From
		Hentry [H]
		inner join LandContractFee [D] on [D].[Guid] = [H].[Guid]
	where 
		[D].[ParentGuid] = @Guid


GO

SET ANSI_NULLS, QUOTED_IDENTIFIER ON
GO
Create Procedure [PrcTransfer_Secondary_Entry]
(
	@RoKind int = 2,
	@ToDataBaseName Varchar(256) = 'Q17',
	@UntilDate Datetime = '2016-12-31',
	@BeginDate Datetime = '2017-1-1',
	@RdReNumberSEntry bit = 1
)
 
as
	Set NoCount on
	--        
	if (@RoKind <> 2) Return
	
	Declare @V Varchar(8000)
	
	--Set @V = '
	--where ContractGuid is Null and Date >='+''''+CAST(@UntilDate as varchar(255))+''''

	Set @V = '
	where	
		--ContractGuid in (Select Guid From '+@ToDataBaseName+'..vwAllContractGuid)
		--or 
		Guid Not in (Select Guid From [ChecksPartialCollection])
		and Guid Not in (Select [EntryGuid] From [LinkEntryType_Checks])
		and (Date >'+''''+CAST(@UntilDate as varchar(255))+''')'
	
	EXEC PrcTransferTable  'Secondary_Entry',@ToDataBaseName, @V

	Set @V = '
	inner join '+@ToDataBaseName+'..Secondary_Entry S on S.Guid = tb.ParentGuid'
	
	EXEC PrcTransferTable  'Secondary_EntryDetail',@ToDataBaseName, @V

	Set @V = '
	Alter Table '+@ToDataBaseName+'..[Secondary_Entry] Disable Trigger All'
	exec (@v)

	--        
	Set @V = '
	UpDate '+@ToDataBaseName+'..[Secondary_Entry] Set [IsRounded] = 1 where Date <'+''''+CAST(@UntilDate as varchar(255))+''''
	exec(@V)

	Set @V = '
	Alter Table '+@ToDataBaseName+'..[Secondary_Entry] Enable Trigger All'
	exec (@v)

	if @RdReNumberSEntry = 1
	begin
		Set @V = '
		exec '+@ToDataBaseName+'..[PrcReNumberCard]
			0, --@Entry
			0, --@FirstEntryNum
			1, --@EntryType
			0x0, --@EntryTypeGuid
			0, --@FirstEntryTypeNum
			1, --@ContractType
			0x0, --@ContractTypeGuid
			0, --@FirstContractTypeNum
			0, --@CheckType
			0x0, --@CheckTypeGuid 
			0, --@FirstCheckTypeNum
			0, --@Flat
			0, --@Shop
			0, --@Parking
			0, --@Land
			0, --@Villa
			0, --@Account
			0x0, --@ElectricityBillType
			0x0, --@ElectricityBillTypeGuid
			0 --@Cus
			'
		exec(@V)
	end
			
	--  
	Set @V = '
	Delete '+@ToDataBaseName+'..[Resource]'
	exec (@v)
	
	Set @V = '
	insert into '+@ToDataBaseName+'..[Resource]
	([Guid], [Kind])
	Select Guid, 1 from '+@ToDataBaseName+'..EntryType Order By [Number]'
	exec (@v)
	
	Set @V = '
	Update '+@ToDataBaseName+'..Secondary_Entry Set ContractGuid = Null 
	where 
		ContractGuid Not in (Select Guid From '+@ToDataBaseName+'..vwAllContract )'
	exec (@v)
		
	Set @V = '
	exec '+@ToDataBaseName+'..PrcReCreateEntryType 0, 0, 0, 0'
	exec (@v)

GO

SET ANSI_NULLS, QUOTED_IDENTIFIER ON
GO

Create View [vwCheckType]
 
as
	Select
		[A].[Number],
		[A].[Guid],
		[A].[SecLvl],
		[A].[checkkind],
		[A].[Code] as [Code],
		[A].[Name] as [ArName],
		Case when (dbo.FnGetLangauge(@@spid) = 1) and (Isnull([A].[LtnName],'') <> '') then [A].[LtnName] else [A].[Name] end as [Name], 
		[A].[ltnName],
		[A].[Menu] as [arMenu],
		Case when (dbo.FnGetLangauge(@@spid) = 1) and (Isnull([A].[LtnMenu],'') <> '') then [A].[LtnMenu] else [A].[Menu] end as [Menu], 
		[A].[LtnMenu],
		[A].[CreatedEntry],
		[A].[AutoCreatedEntry],
		[A].[DefAccountGuid],
		[A].[Posted],
		[A].[PosdetCreatedEntry],
		[A].[PosdetAutoCreatedEntry],
		[A].[PostedDefAccountGuid],
		[A].[collected],
		[A].[collectedCreatedEntry],
		[A].[collectedAutoCreatedEntry],
		[A].[collectedSanctionBankAccountBuilding],
		[A].[collectedDefAccountGuid],
		[A].[collectedDefAccountObverseGuid] ,
		[A].[Endorsement],
		[A].[EndorsementCreatedEntry],
		[A].[EndorsementAutoCreatedEntry],
		[A].[Returned],
		[A].[ReturnedCreatedEntry],
		[A].[ReturnedAutoCreatedEntry],
		[A].[ReturnedSanctionCustAccountDefAccount],
		[A].[ReturnedDefAccountGuid],
		[A].[delayDefAccountGuid],
		[A].[delayDefAccountObverseGuid],
		[A].[delaySanctionCustAccountDefAccount],
		[A].[defprintPath],
		[A].[ShortCut],
		[A].[EnableAtherOperationOnReturn]
	From
		[vbCheckType] [A]


GO

SET ANSI_NULLS, QUOTED_IDENTIFIER ON
GO
Create Procedure [PrcTransfer_Entry]
(
	@RoKind int = 2,
	@ToDataBaseName Varchar(256) = 'A222',
	@UntilDate Datetime = '2016-12-31',
	@BeginDate Datetime = '2017-1-1'
)
 
as
	--        
	if (@RoKind <> 2) Return
	
	Declare @V Varchar(8000)
	
	Set @V = '
	left join '+@ToDataBaseName+'..Hentry D on D.Guid = tb.Guid
	where 
		IsNull(tb.ParentKind,0) = 0 and tb.Date >'+''''+CAST(@UntilDate as varchar(255))+'''
		and D.Guid is Null	
	'
	
	EXEC PrcTransferTable  'Hentry',@ToDataBaseName, @V, 0

	
	Set @V = '
	inner join '+@ToDataBaseName+'..Hentry S on S.Guid = tb.ParentGuid
	left join '+@ToDataBaseName+'..DEntry D on D.ParentGuid = tb.ParentGuid
	where
		D.Guid is Null'
	
	EXEC PrcTransferTable  'DEntry',@ToDataBaseName, @V, 0

	

	Set @V = '
	exec '+@ToDataBaseName+'..[PrcReNumberCard]
		1, --@Entry
		0, --@FirstEntryNum
		0, --@EntryType
		0x0, --@EntryTypeGuid
		0, --@FirstEntryTypeNum
		1, --@ContractType
		0x0, --@ContractTypeGuid =
		0, --@FirstContractTypeNum
		0, --@CheckType
		0x0, --@CheckTypeGuid 
		0, --@FirstCheckTypeNum
		0, --@Flat
		0, --@Shop
		0, --@Parking
		0, --@Land
		0, --@Villa
		0, --@Account
		0x0, --@ElectricityBillType
		0x0, --@ElectricityBillTypeGuid
        0 --@Cus
		'
	--exec(@V) 
			

GO

SET ANSI_NULLS, QUOTED_IDENTIFIER ON
GO

Create view [vwVillaAll]
 
as
	Select 
		[Number], [Guid], [SecLvl], dbo.SC('')+' '+[VillaNo] as [Name] 
		,[WaterCounter], [ElectricityCounter], [ComplexName], [Emirate], [Area], 
		[Street], [Suburb], [PieceNo], [BasinNo], [VillaNo], [DocType], 
		[DocNo], [DocDate], [VillaAccountGuid], [CostGuid], [AccountBankVillaGuid], [RentInfoGuid], [BranchGuid], 
		[FloorCount], [BalconyCount], [RoomCount], [OtherRoomCount], [ServiceRoomCount], [BathroomCount], [StairsInternal], 
		[RoomState], [LandArea], [LandAreaBuilding], [FinishingState], [SecurityType], [SecuritySystem], [wall], [wallState], 
		[lightingCount], [ParkingCount], [ParkingArea], [ParkingShaded], [PoolCount], [PoolState], [PoolSystem], [PlaygroundCount], 
		[PlaygroundArea], [GardenCount], [GardenArea], [GardenState], [OfferType], [OfferState], [Restrained], [RestrainedUserGuid], 
		[CustomerName], [CustomerPhone], [Details],[CuOwnerGuid],[LtnArea],[LtnEmirate],[LtnSuburb],[LtnStreet],
		[LtnDocType],[CashAccountGuid],[InsuranceAccountGuid],
		[AccountCommIncomeGuid],
		[VillaOwner],
		isNull(A.Ban,0) as Ban
	From
		[vbVilla] [A]
		


GO

SET ANSI_NULLS, QUOTED_IDENTIFIER ON
GO

	Create View [vbEntryType]
	 
	as
		Select 
			[T].*
		From
			[EntryType] [T]
			inner join [CurrentUsers] [U] on ([u].[Seclvl] >= Isnull([T].[SecLvl],0)  or [u].[Admin] = 1) and [u].[spid] = @@Spid
GO

SET ANSI_NULLS, QUOTED_IDENTIFIER ON
GO
Create View [vwParkingPrint]
 
as
	Select
		[P].[Number] as [Number], 		[P].[Guid] as [Guid], 		[P].[SecLvl] as [SecLvl], 		[P].[NO] as [NO], 		[P].[Judicial] as [Judicial], 		[P].[Ban] as [Ban], 		[B].[Name] as [Building], 		[P].[FloorNo] as [FloorNo], 		[P].[Area] as [Area], 		[P].[unity] as [unity], 		[P].[Note] as [Note], 		[P].[ParkingKind] as [ParkingKind], 		[P].[Description] as [Description], 		[P].[Overlooking] as [Overlooking], 		[P].[CostPrice] as [CostPrice], 		[P].[CostCurrencyGUID] as [CostCurrencyGUID], 		[P].[Rent] as [Rent], 		[P].[RentCurrencyGUID] as [RentCurrencyGUID], 		[P].[Sale] as [Sale], 		[P].[SaleCurrencyGUID] as [SaleCurrencyGUID], 		[Co].[Name] as [Cost], 		[P].[FlatOwner] as [FlatOwner], 		[Cu].[Name] as [Cust], 		[P].[Details] as [Details], 		[P].[OfferState] as [OfferState], 		[P].[OfferType] as [OfferType], 		[P].[CustomerName] as [CustomerName], 		[P].[CustomerPhone] as [CustomerPhone], 		[P].[Restrained] as [Restrained], 		[P].[PurchaseDate] as [PurchaseDate], 		[P].[PayValue] as [PayValue], 		[P].[RestrainedUserGuid] as [RestrainedUserGuid]
	From
		[Parking] [P]
		inner join vwBuilding [b] on [b].Guid = [P].[BuildingGuid]
		Left join vwCost [Co] on [Co].Guid = [P].[CostGuid]
		Left join vwCustomer [Cu] on [Cu].Guid = [P].[CustGuid]

GO

SET ANSI_NULLS, QUOTED_IDENTIFIER ON
GO

Create Procedure [PrcRenumberContract]
 
as
	
	Create Table #T
	(
		[Id] int Identity(1,1),
		[Guid] Uniqueidentifier
	)
	
	Declare @TypeGuid Uniqueidentifier

	Alter Table [LeaseApartment] disable Trigger All

	DECLARE cursor_Name CURSOR FAST_FORWARD FOR 
	SELECT Distinct [TypeGuid] 
	FROM LeaseApartment
	
	OPEN cursor_Name
	FETCH NEXT FROM cursor_Name INTO @TypeGuid
	
	WHILE @@FETCH_STATUS = 0
	BEGIN
		Truncate Table #T

		insert into #T
		([Guid])	
		Select 
			[Guid]
		From
			[LeaseApartment]
		where 
			[TypeGuid] = @TypeGuid
		Order By
			[Number], FromDate

		update 	[LeaseApartment]
		Set [Number] = [T].[Id]
		From
			[LeaseApartment] [C]
			inner join #T [T] On [T].[Guid] = [C].[Guid]


	  FETCH NEXT FROM cursor_Name INTO @TypeGuid
	
	END
	
	CLOSE cursor_Name
	DEALLOCATE cursor_Name
	Alter Table [LeaseApartment] Enable Trigger All



	Alter Table [ParkingContract] disable Trigger All

	DECLARE cursor_Name CURSOR FAST_FORWARD FOR 
	SELECT Distinct [TypeGuid] 
	FROM ParkingContract
	
	OPEN cursor_Name
	FETCH NEXT FROM cursor_Name INTO @TypeGuid
	
	WHILE @@FETCH_STATUS = 0
	BEGIN
		Truncate Table #T

		insert into #T
		([Guid])	
		Select 
			[Guid]
		From
			[ParkingContract]
		where 
			[TypeGuid] = @TypeGuid
		Order By
			[Number]

		update 	[ParkingContract]
		Set [Number] = [T].[Id]
		From
			[ParkingContract] [C]
			inner join #T [T] On [T].[Guid] = [C].[Guid]

	  FETCH NEXT FROM cursor_Name INTO @TypeGuid
	
	END
	
	CLOSE cursor_Name
	DEALLOCATE cursor_Name
	Alter Table [ParkingContract] Enable Trigger All


	
	Alter Table [LandContract] disable Trigger All
	
	DECLARE cursor_Name CURSOR FAST_FORWARD FOR 
	SELECT Distinct [TypeGuid] 
	FROM [LandContract]
	
	OPEN cursor_Name
	FETCH NEXT FROM cursor_Name INTO @TypeGuid
	
	WHILE @@FETCH_STATUS = 0
	BEGIN
		Truncate Table #T

		insert into #T
		([Guid])	
		Select 
			[Guid]
		From
			[LandContract]
		where 
			[TypeGuid] = @TypeGuid
		Order By
			[Number]

		
		update 	[LandContract]
		Set [Number] = [T].[Id]
		From
			[LandContract] [C]
			inner join #T [T] On [T].[Guid] = [C].[Guid]

	  FETCH NEXT FROM cursor_Name INTO @TypeGuid
	
	END
	
	CLOSE cursor_Name
	DEALLOCATE cursor_Name
	
	Alter Table [LandContract] Enable Trigger All



GO

SET ANSI_NULLS, QUOTED_IDENTIFIER ON
GO

Create Procedure [PrcCheckFinishedReturn]
(
	@ForTest Bit = 1
)
 
as
	exec [PrcInsertSC] '  '


	Create Table #R
	(
		[CheckNo] Varchar(256),
		[State] Varchar(256),
		[Guid] uniqueidentifier
	)


	Declare @CheckGuid uniqueidentifier,
			@No Varchar(256)
	

	DECLARE cursor_Name CURSOR FAST_FORWARD FOR 
	Select [Guid] From [Resource]
	where [Kind] = 8
--		and [Spid] = @@Spid
	
	OPEN cursor_Name
	FETCH NEXT FROM cursor_Name INTO @CheckGuid

	Declare @Returned int 

	WHILE @@FETCH_STATUS = 0
	BEGIN
		Set @Returned = 0
		--   

		Select
			@No = [C].[No],
			@Returned = IsReturned
		from
			[vwChecksCollectionState] [L]
			inner join [Checks] [C] On [C].[Guid] = [L].[CheckGuid]
		where
			[CheckGuid] = @CheckGuid


		Select @Returned 	= isnull(@Returned,0)

		-- 
		if (@Returned <= 0)
		begin
			insert into #R
			Select @No, dbo.SC('  ') , @CheckGuid
			
			FETCH NEXT FROM cursor_Name INTO @CheckGuid
			CONTINUE 				
		end


		-- 
		if @ForTest = 0
		begin
			update [ChecksCollection] Set [Finished] = 1
			where
				[CheckGuid] = @CheckGuid
				and [Kind] = 3
		
				insert into #R
				Select @No, dbo.SC('  ') , @CheckGuid
		end
		if @ForTest = 1
			insert into #R
			Select @No, dbo.SC('  ') , @CheckGuid
	
	 	FETCH NEXT FROM cursor_Name INTO @CheckGuid
	
	END
	
	CLOSE cursor_Name
	DEALLOCATE cursor_Name

	Select * from #R	
	Order By [CheckNo]
		


GO

SET ANSI_NULLS, QUOTED_IDENTIFIER ON
GO

CREATE VIEW vwChecksCollection
 
AS
	SELECT 
		Case
			when [Kind] = 0 then dbo.SC('')
			when [Kind] = 1 then dbo.SC('')
			when [Kind] = 2 then dbo.SC('')
			when [Kind] = 3 then dbo.SC('')
		end as [TypeName],
		[Seclvl],
		[Mark],
		[Date],
		[CheckGuid],
		[DebitAccountGuid],
		[DebitCostGuid],
		[CreditAccountGuid],
		[CreditCostGuid],
		[Value],
		[Commission],
		[LossComm],
		[CommAccountGuid],
		[CommAccountCreditGuid],
		[CurrencyGUID],
		[CurrencyVal],
		[Note],
		[Kind],
		[Delay],
		[DelayAccountDebitGuid],
		[DelayAccountCreditGuid],
		[DelayCostGuid],
		[Finished],
		[Finishdate],
		[ReturnCause],
		[DelayNote],
		[CommCostGuid],
		[CommNote],
		FixReturn,
		FixReturnNote,
		IsRounded,

		[OperationCreateEntry],
		[ReturnCreateEntry],
		[CommCreateEntry]

	FROM 
		[ChecksCollection] [C]


GO

SET ANSI_NULLS, QUOTED_IDENTIFIER ON
GO
Create Procedure [PrcBalance]

as
	Select
		(Select Count(*) From Account) as Ac,
		(Select Count(*) From HEntry) as H,
		(Select Count(*) From Secondary_Entry) as SE,
		(Select Count(*) From Bill) as B,
		(Select Count(*) From LeaseApartment) as L
GO

SET ANSI_NULLS, QUOTED_IDENTIFIER ON
GO

Create Procedure [PrcCheckFinishedReturnCancel]
(
	@ForTest Bit = 1
)
 
as
	exec [PrcInsertSC] '  '


	Create Table #R
	(
		[CheckNo] Varchar(256),
		[State] Varchar(256),
		[Guid] uniqueidentifier
	)


	Declare @CheckGuid uniqueidentifier,
			@No Varchar(256)
	

	DECLARE cursor_Name CURSOR FAST_FORWARD FOR 
	Select [Guid] From [Resource]
	where [Kind] = 8
		and [Spid] = @@Spid
	
	OPEN cursor_Name
	FETCH NEXT FROM cursor_Name INTO @CheckGuid

	Declare @Returned int 

	WHILE @@FETCH_STATUS = 0
	BEGIN
		Set @Returned = 0
		--   

		Select
			@No = [C].[No],
			@Returned = Case when [L].[Kind] = 3 then 1 else 0 end 
		from
			ChecksCollection [L]
			inner join [Checks] [C] On [C].[Guid] = [L].[CheckGuid]
		where
			[CheckGuid] = @CheckGuid


		Select @Returned 	= isnull(@Returned,0)

		-- 
		if (@Returned <= 0)
		begin
			insert into #R
			Select @No, dbo.SC('  ') , @CheckGuid
			
			FETCH NEXT FROM cursor_Name INTO @CheckGuid
			CONTINUE 				
		end


		-- 
		if @ForTest = 0
		begin
			update [ChecksCollection] Set [Finished] = 0
			where
				[CheckGuid] = @CheckGuid
				and [Kind] = 3
		
				insert into #R
				Select @No, dbo.SC('  ') , @CheckGuid
		end
		if @ForTest = 1
			insert into #R
			Select @No, dbo.SC('  ') , @CheckGuid
	
	 	FETCH NEXT FROM cursor_Name INTO @CheckGuid
	
	END
	
	CLOSE cursor_Name
	DEALLOCATE cursor_Name

	Select * from #R	
	Order By [CheckNo]
		


GO

SET ANSI_NULLS, QUOTED_IDENTIFIER ON
GO

	Create View [vbElectricityBill]
	 
	as
		Select 
			[T].*
		From
			[ElectricityBill] [T]
			inner join [CurrentUsers] [U] on ([u].[Seclvl] >= Isnull([T].[SecLvl],0)  or [u].[Admin] = 1) and [u].[spid] = @@Spid
GO

SET ANSI_NULLS, QUOTED_IDENTIFIER ON
GO

Create Procedure [RepChangeFlatRentPrice]
(
	@ApartmentType Varchar(256) = ''
	,@Area Float = 0
	,@Date1 DateTime = '1/1/2007'
	,@Date2 DateTime = '12/30/2007'
)
 
as

	Select Distinct
		[B].[Name] as [BuildingName],
		[B].[Emirate],
		[B].[Area],
		[A].[No],
		[A].[FloorNo],
		[A].[ApartmentType],
		[A].[Area] as [Survey],
		[A].[Unity],
		[P].[Date],
		[P].[Price],
		[C].[Code] as [Currency], 
		[A].[Guid]
	from 
		[vwBuilding] [B]
		Inner join [vbApartment] [A] On [A].[BuildingGuid] = [B].[Guid]
		left join [ChangeFlatRent] [P] on [P].[ParentGuid] = [A].[Guid]
		left join [vwCurrency] [C] on [C].[Guid] = [P].[CurrencyGuid]
		Inner join [Resource] [R] on [R].[Guid] = [B].[Guid]
	where
		([P].[Date] between @Date1 and @Date2)
		and ([A].[ApartmentType] = @ApartmentType or @ApartmentType = '')
		and ([A].[Area] = @Area or @Area = 0)

	Order By
		[BuildingName],[A].[ApartmentType],[No],[Survey],[P].[Date]
		


GO

SET ANSI_NULLS, QUOTED_IDENTIFIER ON
GO

Create Procedure [dbo].[PrcSetFlatLastContract]
(
	@FlatGuid uniqueidentifier = 0x0
)
 
as
	update Apartment
	Set
		[LastContractGuid] = S.Guid
	from
		Apartment P
		inner join (
  						Select
							[C].[Guid],
  							[C].[ApartmentGuid]
  						From
  							[LeaseApartment]  [C]
  						where
  							[FromDate] = 
 							(
 								Select 
 									Max([FromDate]) 
 								From 
 									[LeaseApartment] [C2] 
 								where 
 									[C].[ApartmentGuid] = [C2].[ApartmentGuid]
 							)
					) S on S.[ApartmentGuid] = p.Guid
	where
		P.Guid = @FlatGuid or @FlatGuid = 0x0
			

GO

SET ANSI_NULLS, QUOTED_IDENTIFIER ON
GO

CREATE TRIGGER [Trg_HEntryIsPosdet]
ON [HEntry]
 
FOR UPDATE 
AS 
	set nocount on
	Declare @D Varchar(256)
	Set @D = dbo.SC('    ,    ')
	
	Declare @EntryNumber int
	
	Declare @SDebit Float, @SCredit Float, @Guid uniqueidentifier
	
	IF UPDATE([IsPosted])
	BEGIN
		Select
			@Guid = i.Guid,
			@EntryNumber = I.Number,
			@SDebit =  Sum([D].[Debit]*[D].[CurrencyVal]),
			@SCredit = Sum([D].[Credit]*[D].[CurrencyVal])
		From
			[DEntry] [D]
			inner join [inserted] [I] on [I].[Guid] = [D].[ParentGuid]
		where
			D.AcGuid is Not Null
		Group By
			I.Guid,
			I.Number

		if Abs(isNull(@SDebit, 0) - isNull(@SCredit, 0)) > 0.001
		begin
			RAISERROR (@D, 16, 1)
			ROLLBACK TRANSACTION
		end
		
		Declare @AcName varchar(255)
		Select Top 1 @AcName = Ac.Name
		From
			[inserted] I
			inner join [DEntry] D on D.ParentGuid = I.Guid
			inner join Account ac on ac.Guid = D.AcGuid
		where
			ac.NSons > 0
		
		if IsNull(@AcName,'') <> ''
		begin
			Set @D = dbo.SC('         ')+
					CHAR(13)+dbo.SC('  : ')+ CAST(@EntryNumber as varchar(10))+
					CHAR(13)+dbo.SC(' : ')+ +IsNull(@AcName,'')
			RAISERROR (@D, 16, 1)
			ROLLBACK TRANSACTION
		end
			
		Delete [DEntry]
		From
			[inserted] I
			inner join [DEntry] D on D.ParentGuid = I.Guid
		where
			(D.debit + D.Credit) = 0
			
		Delete HEntry where Guid = @Guid and (isNull(@SDebit, 0) = 0 or isNull(@SCredit, 0) = 0)
	END

GO

SET ANSI_NULLS, QUOTED_IDENTIFIER ON
GO

Create View [vwSalesman]
 
as
	Select
		[A].[Number],[A].[Guid],[A].[SecLvl],[A].[Name] as [ArName],[A].[LtnName],
		[A].[WorkCardNo],[A].[Nationality],[A].[PersonalityNo],[A].[passportNo],[A].[Address],
		[A].[Phone],[A].[Mobile],[A].[Fax],[A].[BoxNo],[A].[EMail],[A].[Commissionlimit],
		Case when (dbo.FnGetLangauge(@@spid) = 1) and (Isnull([A].[LtnName],'') <> '') then [A].[LtnName] else [A].[Name] end as [Name]
	From 
		[Salesman] [A]


GO

SET ANSI_NULLS, QUOTED_IDENTIFIER ON
GO

	Create View [vbShopOffer]
	 
	as
		Select 
			[T].*
		From
			[ShopOffer] [T]
			inner join [CurrentUsers] [U] on ([u].[Seclvl] >= Isnull([T].[SecLvl],0)  or [u].[Admin] = 1) and [u].[spid] = @@Spid
GO

SET ANSI_NULLS, QUOTED_IDENTIFIER ON
GO

Create Procedure [dbo].[PrcUpdateFlatContractCreateEntryimmediate]
(
	@Date1 DateTime = '3/1/2011',
	@Date2 DateTime = '3/1/2012',
	@ActiveDate bit = 0,
	@Datewith int = 0,
	@Num1 int = 1,
	@Num2 int = 100,
	@ActiveNum bit = 1
)
 
as
	Alter Table [LeaseApartment] Disable Trigger All
	
	update [LeaseApartment]
	Set
		CreateContractEntry = Case when IsRounded = 0 and t.CreateEntry = 1 then 1 else 0 end
	From
		[LeaseApartment] L
		inner join [ContractType] T on T.Guid = L.TypeGuid
		inner join [Resource] R on R.Guid = L.TypeGuid and R.Spid = @@SPID
	where
		((L.number between @num1 and @Num2) or @ActiveNum = 0)
		and (
			(
				([L].[FromDate] between @Date1 and @Date2 and @Datewith = 0)
			)
			or
			(
				([L].[ToDate] between @Date1 and @Date2 and @Datewith = 1)
			)

			or
			(
				([L].[ContractFinishDate] between @Date1 and @Date2 and @Datewith = 2)
				and ([L].[ContractFinish] = 1)
			)

			or
			(
				([L].[EditDate] between @Date1 and @Date2 and @Datewith = 3)
			)
			or
			(
				([L].[AcquittancePrintdate] between @Date1 and @Date2 and @Datewith = 4)
			)

			or
			(
				([L].LeaveDate between @Date1 and @Date2 and @Datewith = 5)
			)
			or @ActiveDate = 0
		) 
		
		Alter Table [LeaseApartment] Enable Trigger All


GO

SET ANSI_NULLS, QUOTED_IDENTIFIER ON
GO
Create View [vwLawsuit]
 
as
	Select 
		L.*
	From
		[Lawsuit] L

GO

SET ANSI_NULLS, QUOTED_IDENTIFIER ON
GO
Create view [vwCheckReturn]
 
as
	Select 
		[P].[Number],
		[P].[TypeName],
		[Cu].[Name] as [CustName],
		[Cu].[ArName] as [CustArName],
		[Cu].[LtnName] as [CustLtnName]
		,[P].[No]
		,[P].[Value]
		,[P].[Date]
		,[P].[DueDate]
		,[P].[BankName]
		,[P].[Note]
		,[P].[Note3]
		,DateDiff(Day,  [C3].[Date], GetDate()) as [DayDiff]
		,[L].[BuildingName]
		,[L].[BuildingArName]
		,[L].[BuildingltnName]
		,[L].[FlatNo]
		,[L].[FloorNo]
		,[L].[ContractNo]
		,[C3].[Date] as [ReturnDate]
		,[P].[Guid]

		,[P].[AccountCode]
		,[P].[AccountName]

		,[L].[Emirate]
		,[L].[BuildingArea]
		,[L].[Suburb]
		,[L].[Street]
		,[L].[BasinNo]
		,[L].[PieceNo]
		,[L].[BuildingNo]
		,[L].[BondType]
		,[L].[BondNo]
		,[L].[FlatKind]
		,[L].[ApartmentType]
		,[L].[Class]
		,[L].[FlatArea]
		,[L].[FlatAreaunity]
		,[Cu].[Mobile] as [CustomerMobile]
		,[L].[BuildingGuid]
		,[P].[CurrencyGuid] as [CheckCurrencyGuid]
		,[P].[TypeGuid]
	From
		[vwChecks] [P]
		left join [vwCustomer] [Cu] on [Cu].[AcGuid] = [P].[Account] or Cu.InsuranceAccountGuid = P.Account
		left join [vwLeaseApartment] [L] on [L].[Guid] = [P].[ContractGuid]
		inner join [vwChecksCollection] [C3] on [C3].[CheckGuid] = [P].[Guid] and [C3].[Kind] = 3

--		left join [RepSMS] [SMS2] on [SMS2].[ObjGuid] = [P].[Guid] and [SMS2].[IdReport] = 1200

GO

SET ANSI_NULLS, QUOTED_IDENTIFIER ON
GO
Create view [vwCheckCollection]
 
as
	Select 
		[P].[Number],
		[P].[TypeName],
		[Cu].[Name] as [CustName],
		[Cu].[ArName] as [CustArName],
		[Cu].[LtnName] as [CustLtnName]
		,[P].[No]
		,[P].[Value]
		,[P].[Date]
		,[P].[DueDate]
		,[P].[BankName]
		,[P].[Note]
		,[P].[Note3]
		,DateDiff(Day,  [C3].[Date], GetDate()) as [DayDiff]
		,[L].[BuildingName]
		,[L].[BuildingArName]
		,[L].[BuildingltnName]
		,[L].[FlatNo]
		,[L].[FloorNo]
		,[L].[ContractNo]
		,[C3].[Date] as [CollectionDate]
		,[P].[Guid]

		,[P].[AccountCode]
		,[P].[AccountName]

		,[L].[Emirate]
		,[L].[BuildingArea]
		,[L].[Suburb]
		,[L].[Street]
		,[L].[BasinNo]
		,[L].[PieceNo]
		,[L].[BuildingNo]
		,[L].[BondType]
		,[L].[BondNo]
		,[L].[FlatKind]
		,[L].[ApartmentType]
		,[L].[Class]
		,[L].[FlatArea]
		,[L].[FlatAreaunity]
		,[Cu].[Mobile] as [CustomerMobile]
		,[L].[BuildingGuid]
		,[P].[CurrencyGuid] as [CheckCurrencyGuid]
		,[P].[TypeGuid]
		,C3.FixReturn
		,C3.FixReturnNote
	From
		[vwChecks] [P]
		left join [vwCustomer] [Cu] on [Cu].[AcGuid] = [P].[Account] or [Cu].[InsuranceAccountGuid] = [P].[Account]
		left join [vwLeaseApartment] [L] on [L].[Guid] = [P].[ContractGuid]
		inner join [ChecksCollection] [C3] on [C3].[CheckGuid] = [P].[Guid] and [C3].[Kind] = 1

--		left join [RepSMS] [SMS2] on [SMS2].[ObjGuid] = [P].[Guid] and [SMS2].[IdReport] = 1200

GO

SET ANSI_NULLS, QUOTED_IDENTIFIER ON
GO

	Create View [vbMaintenanceOrder]
	 
	as
		Select 
			[T].*
		From
			[MaintenanceOrder] [T]
			inner join [CurrentUsers] [U] on ([u].[Seclvl] >= Isnull([T].[SecLvl],0)  or [u].[Admin] = 1) and [u].[spid] = @@Spid
GO

SET ANSI_NULLS, QUOTED_IDENTIFIER ON
GO

Create Procedure [RepChangeFlatPrice]
(
	@ApartmentType Varchar(256) = ''
	,@Area Float = 0
	,@Date1 DateTime = '1/1/2007'
	,@Date2 DateTime = '12/30/2007'
	,@SalesKind int = 0
)
 
as

	Select Distinct
		[B].[Name] as [BuildingName],
		[B].[Emirate],
		[B].[Area],
		[A].[No],
		[A].[FloorNo],
		[A].[ApartmentType],
		[A].[Area] as [Survey],
		[A].[Unity],
		[P].[Date],
		[P].[Price],
		[C].[Code] as [Currency], 
		[A].[Guid]
	from 
		[vwBuilding] [B]
		Inner join [vwApartment] [A] On [A].[BuildingGuid] = [B].[Guid]
		left join [ChangeFlatPrice] [P] on [P].[ParentGuid] = [A].[Guid]
		left join [vwCurrency] [C] on [C].[Guid] = [P].[CurrencyGuid]
		Inner join [Resource] [R] on [R].[Guid] = [B].[Guid]
	where
		([P].[Date] between @Date1 and @Date2)
		and ([A].[ApartmentType] = @ApartmentType or @ApartmentType = '')
		and ([A].[Area] = @Area or @Area = 0)
		and ([P].[Kind] = @SalesKind)
	Order By
		[BuildingName],[A].[ApartmentType],[No],[Survey],[P].[Date]
		


GO

SET ANSI_NULLS, QUOTED_IDENTIFIER ON
GO

	Create View [vbOwner]
	 
	as
		Select 
			[T].*
		From
			[Owner] [T]
			inner join [CurrentUsers] [U] on ([u].[Seclvl] >= Isnull([T].[SecLvl],0)  or [u].[Admin] = 1) and [u].[spid] = @@Spid
GO

SET ANSI_NULLS, QUOTED_IDENTIFIER ON
GO

Create Procedure [dbo].[PrcCreateLawsuitEntry2]
(
	@Guid uniqueidentifier = '3E88C993-969F-43A3-9FFA-ECA7390A6FBF'
)
 
as
	Set nocount on
	Declare @EntryGuid2 uniqueidentifier
	
	Select
		@EntryGuid2 = [EntryGuid2]
	From
		[Lawsuit]
	where
		Guid = @Guid
			
	if @EntryGuid2 is Null
	begin
		Set @EntryGuid2 = NEWID()
		update [Lawsuit] Set [EntryGuid2] = @EntryGuid2 where Guid = @Guid
	end
	
	Declare @CeNumber Int
	Select
		@CeNumber = [Number]
	From
		HEntry
	where
		Guid = @EntryGuid2
		
	if isNull(@CeNumber,0) = 0
	Set @CeNumber = (Select isNull(MAX(Number),0) + 1 From HEntry)

	Delete
		HEntry
	where
		Guid = @EntryGuid2
		
	if Not exists(
		Select Top 1 Guid 
		from 
			[Lawsuit] 
		where 
			Guid = @Guid 
			and maintenanceEntry = 1 
			and MaintenanceRent <> 0
				) 
	return				

	Declare @CostGuid uniqueidentifier
	Select
		@CostGuid = [UnitCostGuid]
	from
		[vwAllContract] C
		inner join Lawsuit L on L.ContractGuid = C.Guid
	where
		L.Guid = @Guid

	Insert Into [HEntry]
	([Guid],[SecLvl],[Number],[Date], [CurrencyGuid], [CurrencyVal], [Note], [ParentKind], [BranchGuid], [IsPosted])
	Select
		@EntryGuid2,
		[SecLvl],
		@CeNumber,
		[MaintenanceRentDate],
		[CurrencyGuid],
		[CurrencyVal],
		[Note],
		157,
		Null,
		1
	From
		[Lawsuit]
	where
		Guid = @Guid

	Declare @DetailNum Int
	Set @DetailNum = 0


	Set @DetailNum = @DetailNum + 1
	Insert into [DEntry]
 	([ParentGuid],[Number],[AcGuid],[Debit],[Credit],[CurrencyGuid],[CurrencyVal],[CostGuid],[ObverseAcGuid],[Note])
	Select
		@EntryGuid2,
		@DetailNum,
		[MaintenanceDebitAccountGuid],
		A.MaintenanceRent,
		0,
		A.CurrencyGUID,
		A.CurrencyVal,
		@CostGuid as [debitCostGuid],
		[MaintenanceCreditAccountGuid],
		A.maintenanceNote
	From
		[Lawsuit] A
	where
		A.[Guid] = @Guid
		and MaintenanceEntry = 1
		and MaintenanceRent <> 0
				
	Set @DetailNum = @DetailNum + 1
	Insert into [DEntry]
 	([ParentGuid],[Number],[AcGuid],[Debit],[Credit],[CurrencyGuid],[CurrencyVal],[CostGuid],[ObverseAcGuid],[Note])
	Select
		@EntryGuid2,
		@DetailNum,
		[MaintenanceCreditAccountGuid],
		0,
		A.MaintenanceRent,
		A.CurrencyGUID,
		A.CurrencyVal,
		@CostGuid as [debitCostGuid],
		[MaintenanceDebitAccountGuid],
		A.maintenanceNote
	From
		[Lawsuit] A
	where
		A.[Guid] = @Guid
		and MaintenanceEntry = 1
		and MaintenanceRent <> 0

	update [HEntry] Set isPosted = 1 where Guid = @Guid

	Select * from [HEntry] where Guid = @Guid
	Select * from [DEntry] where parentGuid = @Guid
			

GO

SET ANSI_NULLS, QUOTED_IDENTIFIER ON
GO

	Create View [vbMatGroup]
	 
	as
		Select 
			[T].*
		From
			[MatGroup] [T]
			inner join [CurrentUsers] [U] on ([u].[Seclvl] >= Isnull([T].[SecLvl],0)  or [u].[Admin] = 1) and [u].[spid] = @@Spid
GO

SET ANSI_NULLS, QUOTED_IDENTIFIER ON
GO

Create Procedure [dbo].[PrcCreateLawsuitEntry3]
(
	@Guid uniqueidentifier = 'C5D0C5DC-964A-4596-AE42-761427E00350'
)
 
as
	Set nocount on
	Declare @EntryGuid3 uniqueidentifier
	
	Select
		@EntryGuid3 = [EntryGuid3]
	From
		[Lawsuit]
	where
		Guid = @Guid
			
	if @EntryGuid3 is Null
	begin
		Set @EntryGuid3 = NEWID()
		update [Lawsuit] Set [EntryGuid3] = @EntryGuid3 where Guid = @Guid
	end
	
	Declare @CeNumber Int
	Select
		@CeNumber = [Number]
	From
		HEntry
	where
		Guid = @EntryGuid3
		
	if isNull(@CeNumber,0) = 0
	Set @CeNumber = (Select isNull(MAX(Number),0) + 1 From HEntry)

	Delete
		HEntry
	where
		Guid = @EntryGuid3
		
	if Not exists(
		Select Top 1 Guid 
		from 
			[Lawsuit] 
		where 
			Guid = @Guid
			and FurnitureEntry = 1 
			and Furniture <> 0
			)
	return				

	Declare @CostGuid uniqueidentifier
	Select
		@CostGuid = [UnitCostGuid]
	from
		[vwAllContract] C
		inner join Lawsuit L on L.ContractGuid = C.Guid
	where
		L.Guid = @Guid
	

	Insert Into [HEntry]
	([Guid],[SecLvl],[Number],[Date], [CurrencyGuid], [CurrencyVal], [Note], [ParentKind], [BranchGuid], [IsPosted])
	Select
		@EntryGuid3,
		[SecLvl],
		@CeNumber,
		[FurnitureDate],
		[CurrencyGuid],
		[CurrencyVal],
		[Note],
		157,
		Null,
		1
	From
		[Lawsuit]
	where
		Guid = @Guid

	Declare @DetailNum Int
	Set @DetailNum = 0


	Set @DetailNum = @DetailNum + 1
	Insert into [DEntry]
 	([ParentGuid],[Number],[AcGuid],[Debit],[Credit],[CurrencyGuid],[CurrencyVal],[CostGuid],[ObverseAcGuid],[Note])
	Select
		@EntryGuid3,
		@DetailNum,
		[FurnitureDebitAccountGuid],
		A.Furniture,
		0,
		A.CurrencyGUID,
		A.CurrencyVal,
		@CostGuid as [debitCostGuid],
		[FurnitureCreditAccountGuid],
		A.FurnitureNote
	From
		[Lawsuit] A
	where
		A.[Guid] = @Guid
		and FurnitureEntry = 1
		and Furniture <> 0
				
	Set @DetailNum = @DetailNum + 1
	Insert into [DEntry]
 	([ParentGuid],[Number],[AcGuid],[Debit],[Credit],[CurrencyGuid],[CurrencyVal],[CostGuid],[ObverseAcGuid],[Note])
	Select
		@EntryGuid3,
		@DetailNum,
		[FurnitureCreditAccountGuid],
		0,
		A.Furniture,
		A.CurrencyGUID,
		A.CurrencyVal,
		@CostGuid as [debitCostGuid],
		[FurnitureDebitAccountGuid],
		A.FurnitureNote
	From
		[Lawsuit] A
	where
		A.[Guid] = @Guid
		and FurnitureEntry = 1
		and Furniture <> 0

	update [HEntry] Set isPosted = 1 where Guid = @Guid

	Select * from [HEntry] where Guid = @Guid
	Select * from [DEntry] where parentGuid = @Guid
			

GO

SET ANSI_NULLS, QUOTED_IDENTIFIER ON
GO

Create Procedure [PrcTestRentShopFromAccumulateShop]
(
	@ContractGuid uniqueidentifier = 'EFAF9774-48B8-4680-BE63-6B3D9112271A',
	@ShopGuid uniqueidentifier = '90DBB8C2-DFC0-4E6F-86FD-0D8ECEC5E607',
	@Date1 DateTime = '1/1/2010',
	@Date2 DateTime = '10/1/2010'
)
 
as
	Select
		[L].*,
		Case when [ContractFinish] = 0 then [ToDate] else [ContractFinishDate]  end as [EndDate]
	into #Contract
	From
		[LeaseApartment] [L]
		inner join [AccumulateShop] [A] on [A].[ParentGuid] = [L].[ApartmentGuid]
	where 
		([A].[ShopGuid] = @ShopGuid)		
		and ([L].[Guid] <> @ContractGuid)

--	Select * from #Contract
		
	Select 
		[L].[Number],
		[T].[Name] as [ContractName],
		[L].[FromDate],
		[L].[ToDate],
		[L].[Leasekind],
		[L].[ApartmentGuid],
		[L].[Guid]
	From 
		#Contract [L] 
		inner join [ContractType] [T] On [T].[Guid] = [L].[TypeGuid]
		inner join [AccumulateShop] [A] on [A].[ParentGuid] = [L].[ApartmentGuid]
	where 
		([A].[ShopGuid] = @ShopGuid)		
		and 
		(
				(
					[Leasekind] = 3
					and	(
							([FromDate] <= @Date1 )
						 or ([FromDate] <= @Date2 )
						)
				)
				or 
				(
					[Leasekind] = 1
					and	([ContractFinish] = 0)
				)

			)
			

GO

SET ANSI_NULLS, QUOTED_IDENTIFIER ON
GO

	Create View [vbMat]
	 
	as
		Select 
			[T].*
		From
			[Mat] [T]
			inner join [CurrentUsers] [U] on ([u].[Seclvl] >= Isnull([T].[SecLvl],0)  or [u].[Admin] = 1) and [u].[spid] = @@Spid
GO

SET ANSI_NULLS, QUOTED_IDENTIFIER ON
GO
Create Trigger [TRG_LinkCe_Del]
on [LinkCe]
 
For delete
As
	Delete [HEntry] From [HEntry] inner join Deleted On Deleted.[CeGuid] = [HEntry].[Guid]
	
	Delete [Secondary_Entry] From [Secondary_Entry] inner join Deleted On Deleted.[CeGuid] = [Secondary_Entry].[Guid]

GO

SET ANSI_NULLS, QUOTED_IDENTIFIER ON
GO

	Create View [vbBillType]
	 
	as
		Select 
			[T].*
		From
			[BillType] [T]
			inner join [CurrentUsers] [U] on ([u].[Seclvl] >= Isnull([T].[SecLvl],0)  or [u].[Admin] = 1) and [u].[spid] = @@Spid
GO

SET ANSI_NULLS, QUOTED_IDENTIFIER ON
GO

Create Procedure [PrcTreeAssets]
(
	@AcGuid uniqueidentifier = 0x0
)
 
as
	Declare @Level int
	Set @Level = Case when @AcGuid = 0x0 then 0 else 3 end

	Create Table #Res 
	(
		[Number] int, 
		[Guid] uniqueidentifier, 
		[Type] int, 
		[Code] Varchar(256), 
		[Name] Varchar(256), 
		[LtnName] Varchar(256), 
		[ParentGuid]uniqueidentifier,
		[Path]  Varchar(256)
	)

	insert into #Res
	Select
		[A].[Number], 
		[A].[Guid], 
		1 as [Type], 
		[A].[Code], 
		Case when (dbo.FnGetLangauge(@@spid) = 1) and (Isnull([A].[LtnName],'') <> '') then [A].[LtnName] else [A].[Name] end as [Name], 
		[A].[LtnName],
		case when [A].[ParentGuid] is Not Null then [A].[ParentGuid] else 0x0 end as [Parent],
		[F].[Path]
	From 
		[vbAssetsGroup] [A]
		inner join [dbo].[fnGetAssetsGroupList](@AcGuid) [F] on [F].[Guid] = [A].[Guid]


	insert into #Res
	Select
		[A].[Number], 
		[A].[Guid], 
		2 as [Type], 
		[A].[Code], 
		Case when (dbo.FnGetLangauge(@@spid) = 1) and (Isnull([A].[LtnName],'') <> '') then [A].[LtnName] else [A].[Name] end as [Name], 
		[A].[LtnName],
		case when [A].[AssetsGroupGuid] is Not Null then [A].[AssetsGroupGuid] else 0x0 end as [Parent],
		[F].[Path]
	From 
		[vbAssets] [A]
		inner join [dbo].[fnGetAssetsGroupList](@AcGuid) [F] on [F].[Guid] = [A].[AssetsGroupGuid] 


	CREATE INDEX IXS_Guid ON #Res ([Guid])
	-----------------------------------------------------------------------------------

	Select 
		*
		,Len([Path]) / 9 as [level]
	from 
		#Res

	ORDER BY [Path], [Type], [Code]

GO

SET ANSI_NULLS, QUOTED_IDENTIFIER ON
GO

Create Procedure [PrcPaperMonetaryOfLawsuit]
(
	@LawsuitGuid UniqueIdentifier = 0x0
)
 
as
	Set NoCount On
	
	Select 
		dbo.SC([P].[TypeName]) as [PaperKind],
		[P].[No],
		[LL].[Value],
		[P].[BankName],
		[P].[CurrencyCode],
		[P].[DueDate],
		Case 		
			when  [C3].[CheckGuid] is not null then dbo.SC('')

			when  ([C1].[CheckGuid] is not null) or 
				  ([C4].[CheckGuid] is Not Null ) and ([C4].[Value] >= [P].[Value])	 then dbo.SC('') 

			when ([C4].[CheckGuid] is Not Null ) and ([C4].[Value] < [P].[Value]) then dbo.SC(' ')

			when  [C].[CheckGuid] is not null then dbo.SC('') 
			when  [C2].[CheckGuid] is not null then dbo.SC('') 
		end as [State],
		[P].[Note3],
		1 as [Print],
		[P].[Guid]
	From
		[vwChecks] [P]
		inner join [LinkCheckContract] LL on LL.ParentGuid = P.Guid
		left join [vwAllContract] [L] on [L].[Guid] = [LL].[ContractGuid]
		left join [vwChecksCollection] [C] on [C].[CheckGuid] = [P].[Guid] and [C].[Kind] = 0
		left join [vwChecksCollection] [C1] on [C1].[CheckGuid] = [P].[Guid] and [C1].[Kind] = 1
		left join [vwChecksCollection] [C2] on [C2].[CheckGuid] = [P].[Guid] and [C2].[Kind] = 2
		left join [vwChecksCollection] [C3] on [C3].[CheckGuid] = [P].[Guid] and [C3].[Kind] = 3
		left join (
						Select 
							[CheckGuid],
							Sum([Value]) as [Value] 
						From
							[ChecksPartialCollection] 
						Group By
							[CheckGuid]
					) [C4] on [C4].[CheckGuid] = [P].[Guid]
 	where
 		(LL.[ContractGuid] = @LawsuitGuid or @LawsuitGuid = 0x0)
--		and [P].[Number] = 2905
 	Order By 
 		[P].[dueDate], [P].[No]

GO

SET ANSI_NULLS, QUOTED_IDENTIFIER ON
GO

Create Procedure [PrcBuildingOffer]
(
    @Name VARCHAR(256) = '',
    @LtnName VARCHAR(256) = '',
    @Emirate Varchar(256) = '',
    @Area Varchar(256) = '',
    @Suburb Varchar(256) = '',
    @Street Varchar(256) = '',
    @BasinNO Varchar(256) = '',
    @PieceNO Varchar(256) = '',
    @BondType VARCHAR(256) = '',
    @BondNo VARCHAR(256) = '',
    @OfferKind Int = 3,
    @OfferValue1 Float = 0,
    @OfferValue2 Float = 0,
    @Delegated VARCHAR(256) = '',
    @LandArea1 Float = 0,
    @LandArea2 Float = 0,
    @CustName Varchar(256) = '',
    @CustPhone Varchar(256) = '',
    @CustMobile Varchar(256) = ''
)
 
as
	Select 
		*,
		Case when OfferKind = 0 then ''
			 when OfferKind = 0 then ''
			 when OfferKind = 0 then ''
		end OfferKindStr
	From 
		BuildingOffer
	where
		([Name] Like '%'+@Name+'%')
		and ([LtnName] Like '%'+@LtnName+'%')
		and ([Emirate] Like '%'+@Emirate+'%')
		and ([Area] Like '%'+@Area+'%')
		and ([Suburb] Like '%'+@Suburb+'%')
		and ([Street] Like '%'+@Street+'%')
		and ([BasinNO] Like '%'+@BasinNO+'%')
		and ([PieceNO] Like '%'+@PieceNO+'%')
		and ([BondType] Like '%'+@BondType+'%')
		and ([BondNo] Like '%'+@BondNo+'%')
		and ([OfferKind] = @OfferKind Or @OfferKind = 3)
		and  (
			([OfferValue] Between @OfferValue1 and @OfferValue2)
			Or @OfferValue2 = 0
		)
		and ([Delegated] Like '%'+@Delegated+'%')
		and (
				([LandArea] Between @LandArea1 and @LandArea2)
				Or @LandArea2 = 0
			)
		and ([CustName] Like '%'+@CustName+'%')
		and ([CustPhone] Like '%'+@CustPhone+'%')
		and ([CustMobile] Like '%'+@CustMobile+'%')
	

GO

SET ANSI_NULLS, QUOTED_IDENTIFIER ON
GO

Create View [vwApartmentOffer]
 
as

	Select
		[A].*
	From
		[vbApartmentOffer] [A]


GO

SET ANSI_NULLS, QUOTED_IDENTIFIER ON
GO

Create Procedure [PrcBuildingPayType]
(
	@BuildingGuid uniqueidentifier = 0x0
)
 
as
	Create Table #Res1
	(
		[Guid] uniqueidentifier,
		[BuildingName] Varchar(256),
		[BuildingGuid] uniqueidentifier,
		[Date] DateTime,
		[Percentage] Float,
		[CostProject] Float,
		[Currency] Varchar(256),
		[SumFlatSaleCost] Float,
		[DueValue] Float,
		[PayValue] Float,
		[Note] Varchar(256),
		[CkBuildingPayTypelow] Bit
	)
	Insert into #res1
	Select 
		[P].[Guid],
		[B].[Name] as [BuildingName],
		[B].[Guid] as [BuildingGuid],
		[P].[Date],
		[P].[Percentage]+0.0 as [Percentage],
		[B].[AmountPurchase]+0.0 as [CostProject],
		[my].[Code] as [Currency],
		0.0 as [SumFlatSaleCost],
		0.0 as [DueValue],
		[p].[PayValue]+0.0 as [PayValue],
		[P].[Note],
		[B].[CkBuildingPayTypelow]
	From 
		[BuildingPayType] [P]
		inner join [Building] [b] on [b].[Guid] = [p].[BuildingGuid]
		inner join [Currency] [my] on [my].[Guid] = [B].[CurrencyPurchase]
	where
		([P].[BuildingGuid] = @BuildingGuid or @BuildingGuid = 0x0)


	Declare @CkBuildingPayTypelow bit
	Select 
		@CkBuildingPayTypelow = [B].[CkBuildingPayTypelow]
	From 
		[BuildingPayType] [P]
		inner join [Building] [b] on [b].[Guid] = [p].[BuildingGuid]
	where
		([P].[BuildingGuid] = @BuildingGuid or @BuildingGuid = 0x0)
		
	Declare @RGuid uniqueidentifier,
			@RBuildingGuid uniqueidentifier,
			@RDate DateTime,
			@RDate1 DateTime,
			@FlatCostPrice Float

	DECLARE cursor_Name CURSOR FOR 
	SELECT 
		[Guid],
		[BuildingGuid],
		[Date]
	FROM 
		#Res1
	Order By
		[BuildingGuid],
		[Date]
	
	OPEN cursor_Name
	FETCH NEXT FROM cursor_Name INTO @RGuid, @RBuildingGuid, @RDate
	
	WHILE @@FETCH_STATUS = 0
	BEGIN
		Set @RDate1 = ( Select Top 1
							[Date]
						From
							#Res1
						where
							[Date] < @RDate
							and [BuildingGuid] = @RBuildingGuid
						Order By
							[Date]
						)

		Set @RDate1 = (isnull(@RDate1,0))

		Set @FlatCostPrice = (
								Select
									Sum([A].[CostPrice])
								from
									[LeaseApartment] [L]
									Inner join [Apartment] [A] on [L].[ApartmentGuid] = [A].[Guid] 
								where
									[LeaseKind] = 2
									and ([L].[FromDate] < @RDate)
									and [A].[BuildingGuid] = @RBuildingGuid
								)
		update #Res1 Set [SumFlatSaleCost] = @FlatCostPrice
		where [Guid] = @RGuid

		FETCH NEXT FROM cursor_Name INTO @RGuid, @RBuildingGuid	, @Rdate
	END
	
	CLOSE cursor_Name
	DEALLOCATE cursor_Name

	Select 
		[BuildingName],
		[Date],
		[CostProject],
		[SumFlatSaleCost],
		[Percentage],
		(([CostProject] - Case when @CkBuildingPayTypelow = 1 then isnull([SumFlatSaleCost],0) else 0 end) * [Percentage] / 100) as [DueValue],
		[PayValue],
		(([CostProject] - Case when @CkBuildingPayTypelow = 1 then isnull([SumFlatSaleCost],0) else 0 end) * [Percentage] / 100) - [PayValue] as [RestValue],
		[Currency],
		[Note]
	From
		#Res1
	Order By
		[BuildingGuid],
		[Date]


GO

SET ANSI_NULLS, QUOTED_IDENTIFIER ON
GO

Create Procedure [PrcApartmentOffer]
(
	@NO VARCHAR(256) = '',
	@Building VARCHAR(256) = '',
	@Customer VARCHAR(256) = '',
	@FloorNo Varchar(256) = '',
	@Area1 Float = 0,
	@Area2 Float = 0,
	@ApartmentType VARCHAR(256) = '',
	@FlatKind VARCHAR(256) = '',
	@Class VARCHAR(256) = '',
	@Overlooking VARCHAR(256) = '',
	@OfferKind Int = 0,
	@OfferValue1 Float = 0,
	@OfferValue2 Float = 0,
	@Delegated VARCHAR(256) = '',
	@CustPhone VARCHAR(256) = '',
	@CustMobile VARCHAR(256) = ''
)
 
as
	Select 
		*,
		Case when OfferKind = 0 then ''
			 when OfferKind = 1 then ''
			 when OfferKind = 2 then ''
		end as OfferKindStr
	From 
		ApartmentOffer
	where
		([NO] Like '%'+@NO+'%')
		and ([Building] Like '%'+@Building+'%')
		and ([Customer] Like '%'+@Customer+'%')
		and ([FloorNo] Like '%'+@FloorNo+'%')
		and ([Area] Between @Area1 and @Area2 Or @Area2 = 0)
		and ([ApartmentType] Like '%'+@ApartmentType+'%')
		and ([FlatKind] Like '%'+@FlatKind+'%')
		and ([Class] Like '%'+@Class+'%')
		and ([Overlooking] Like '%'+@Overlooking+'%')
		and ([OfferKind] = @OfferKind or @OfferKind = 3)
		and (OfferValue Between @OfferValue1 and @OfferValue2 or @OfferValue2 = 0)
		and ([Delegated] Like '%'+@Delegated+'%')
		and ([CustPhone] Like '%'+@CustPhone+'%')
		and ([CustMobile] Like '%'+@CustMobile+'%')
		

GO

SET ANSI_NULLS, QUOTED_IDENTIFIER ON
GO

Create Trigger [TRG_Trace_Cost]
on [Cost]
 
for update
As
	SET NOCOUNT ON;
	if Not exists(Select Value from DMD_const where vName = 'ActiveLogCardUpdate' and Value = '1' ) return
	
	Declare @UserGuid uniqueidentifier, @Guid uniqueidentifier
	Set @Guid = NEWID()
	
	Select Top 1 @UserGuid = userGuid From CurrentUsers where Spid = @@SPID
			
	insert into [Trace]
	([Guid],[ParentGuid],[Date],[userGuid],[HostName],parenttbl)
	Select Top 1
		@Guid,
		N.Guid,
		GETDATE(),
		@UserGuid,
		Host_Name(),
		'Cost'
	From
		[inserted] n 
		
	insert into [TraceDetail]
	([ParentGuid],[Caption],[Old],[New],[Tbl])
	Select Top 1
		@Guid,
		' ' as [Caption],
		D.[SecLvl] as [old],
		N.[SecLvl] as [New],
		''
	From
		[deleted] d
		inner join [inserted] n on D.Guid = N.Guid
	where
		N.[SecLvl] <> D.[SecLvl]
		
	insert into [TraceDetail]
	([ParentGuid],[Caption],[Old],[New],[Tbl])
	Select Top 1
		@Guid,
		'' as [Caption],
		D.[Code] as [old],
		N.[Code] as [New],
		''
	From
		[deleted] d
		inner join [inserted] n on D.Guid = N.Guid
	where
		N.[Code] <> D.[Code]
		
	insert into [TraceDetail]
	([ParentGuid],[Caption],[Old],[New],[Tbl])
	Select Top 1
		@Guid,
		'' as [Caption],
		D.[Name] as [old],
		N.[Name] as [New],
		''
	From
		[deleted] d
		inner join [inserted] n on D.Guid = N.Guid
	where
		N.[Name] <> D.[Name]
		
	insert into [TraceDetail]
	([ParentGuid],[Caption],[Old],[New],[Tbl])
	Select Top 1
		@Guid,
		' ' as [Caption],
		D.[LtnName] as [old],
		N.[LtnName] as [New],
		''
	From
		[deleted] d
		inner join [inserted] n on D.Guid = N.Guid
	where
		N.[LtnName] <> D.[LtnName]
		
	insert into [TraceDetail]
	([ParentGuid],[Caption],[Old],[New],[Tbl])
	Select Top 1
		@Guid,
		' ' as [Caption],
		D.[ParentGUID] as [old],
		N.[ParentGUID] as [New],
		''
	From
		[deleted] d
		inner join [inserted] n on D.Guid = N.Guid
	where
		N.[ParentGUID] <> D.[ParentGUID]
		
	insert into [TraceDetail]
	([ParentGuid],[Caption],[Old],[New],[Tbl])
	Select Top 1
		@Guid,
		'' as [Caption],
		D.[Note] as [old],
		N.[Note] as [New],
		''
	From
		[deleted] d
		inner join [inserted] n on D.Guid = N.Guid
	where
		N.[Note] <> D.[Note]
		
	delete Trace From Trace t left join [TraceDetail] D on T.guid = D.ParentGuid
	where
		d.ParentGuid is Null and t.Guid = @Guid


GO

SET ANSI_NULLS, QUOTED_IDENTIFIER ON
GO

Create Function dbo.fnWorkHijridate()
RETURNS int
 AS
BEGIN

	Declare @Hijridate int, @R Float
	Select 
		@Hijridate = Value
	From
		dmd_Const where vName = 'Hijridate'
	
	
	Set @R = @Hijridate
	
	return @R
end

GO

SET ANSI_NULLS, QUOTED_IDENTIFIER ON
GO

Create Procedure [PrcShopOffer]
(
	@NO VARCHAR(256) = '',
	@Building  VARCHAR(256) = '',
	@Customer  VARCHAR(256) = '',
	@Area1 Float = 0,
	@Area2 Float = 0,
	@ShopKind VARCHAR(256) = '',
	@Description VARCHAR(256) = '',
	@Overlooking VARCHAR(256) = '',
	@OfferKind Int = 3,
	@OfferValue1 Float = 0,
	@OfferValue2 Float = 0,
	@Delegated VARCHAR(256) = '',
	@CustPhone VARCHAR(256) = '',
	@CustMobile VARCHAR(256) = ''
)
 
as
	Select 
		*,
		Case when OfferKind = 0 then ''
			 when OfferKind = 1 then ''
			 when OfferKind = 2 then ''
		end as OfferKindStr
	From 
		[ShopOffer]
	where
		([NO] = @NO  or @NO = '')
		and ([Building] Like '%'+@Building+'%')
		and ([Customer] Like '%'+@Customer+'%')
		and ([Area] > @Area1 or @Area1 = 0)
		and ([Area] < @Area2 or @Area2 = 0)
		and ([ShopKind] Like '%'+@ShopKind+'%')
		and ([Description] Like '%'+@Description +'%')
		and ([Overlooking] Like '%'+@Overlooking +'%')
		and ([OfferKind] = @OfferKind or @OfferKind = 3)
		and ([OfferValue] between @OfferValue1 and @OfferValue2 or @OfferValue2 = 0)
		and ([Delegated] Like '%'+@Delegated +'%')
		and ([CustPhone] Like '%'+@CustPhone +'%')
		and ([CustMobile] Like '%'+@CustMobile +'%')
		

GO

SET ANSI_NULLS, QUOTED_IDENTIFIER ON
GO
Create View [vwLandContractCachPayment]
 
as
	Select
		[C].[ContractGuid],
		[H].[HNumber] as [Number],
		[H].[DNumber],
		[H].[HDate] as [Date],
		isNull([H].[DCredit],0) + isNull([H].[DDebit],0) as [Value],
		[h].AcGuid,
		[H].[CurrencyGuid],
		[H].[CurrencyName] as [Currency],
		[H].[CurrencyVal],
		[H].[HNote],
		[H].[DNote],
		1 as [Print],
		[H].[HGuid] as [Guid]
	from 
		[LandContractCachPayment] [C]
		inner join [vwDetailEntry] [H] on [H].[HGuid] = [C].[EntryGuid]
		inner join LandContract L on L.CustAccountGuid = H.AcGuid and L.Guid = C.contractGuid
	where
		((isNull([H].[DCredit],0) + isNull([H].[DDebit],0) <> 0) and L.PayType = 0)
		or ((isNull([H].[DCredit],0)  <> 0) and L.PayType <> 0)


GO

SET ANSI_NULLS, QUOTED_IDENTIFIER ON
GO

	Create View [vbAssets]
	 
	as
		Select 
			[T].*
		From
			[Assets] [T]
			inner join [CurrentUsers] [U] on ([u].[Seclvl] >= Isnull([T].[SecLvl],0)  or [u].[Admin] = 1) and [u].[spid] = @@Spid
GO

SET ANSI_NULLS, QUOTED_IDENTIFIER ON
GO
Create View [vwAccountConformity]
 
as
	Select
		us.LoginName as [UserName],
		Co.Name as Cost,
		a.*,
		a.Debit - a.Credit as Balance
	From
		[AccountConformity] [a]
		inner join Realty_Users [us] on [us].Guid = [a].[UserGuid]
		left join Cost [Co] on [Co].Guid = [a].[CostGuid]

GO

SET ANSI_NULLS, QUOTED_IDENTIFIER ON
GO

Create Trigger [TRG_Trace_AssetsArea]
on [AssetsArea]
 
for update
As
	SET NOCOUNT ON;
	if Not exists(Select Value from DMD_const where vName = 'ActiveLogCardUpdate' and Value = '1' ) return
	
	Declare @UserGuid uniqueidentifier, @Guid uniqueidentifier
	Set @Guid = NEWID()
	
	Select Top 1 @UserGuid = userGuid From CurrentUsers where Spid = @@SPID
			
	insert into [Trace]
	([Guid],[ParentGuid],[Date],[userGuid],[HostName],ParentTbl )
	Select Top 1
		@Guid,
		N.Guid,
		GETDATE(),
		@UserGuid,
		Host_Name(),
		'AssetsArea'
	From
		[inserted] n 
		
	insert into [TraceDetail]
	([ParentGuid],[Caption],[Old],[New],[Tbl])
	Select Top 1
		@Guid,
		' ' as [Caption],
		D.[SecLvl] as [old],
		N.[SecLvl] as [New],
		''
	From
		[deleted] d
		inner join [inserted] n on D.Guid = N.Guid
	where
		N.[SecLvl] <> D.[SecLvl]
		
	insert into [TraceDetail]
	([ParentGuid],[Caption],[Old],[New],[Tbl])
	Select Top 1
		@Guid,
		'' as [Caption],
		D.[Code] as [old],
		N.[Code] as [New],
		''
	From
		[deleted] d
		inner join [inserted] n on D.Guid = N.Guid
	where
		N.[Code] <> D.[Code]
		
	insert into [TraceDetail]
	([ParentGuid],[Caption],[Old],[New],[Tbl])
	Select Top 1
		@Guid,
		'' as [Caption],
		D.[Name] as [old],
		N.[Name] as [New],
		''
	From
		[deleted] d
		inner join [inserted] n on D.Guid = N.Guid
	where
		N.[Name] <> D.[Name]
		
	insert into [TraceDetail]
	([ParentGuid],[Caption],[Old],[New],[Tbl])
	Select Top 1
		@Guid,
		' ' as [Caption],
		D.[LtnName] as [old],
		N.[LtnName] as [New],
		''
	From
		[deleted] d
		inner join [inserted] n on D.Guid = N.Guid
	where
		N.[LtnName] <> D.[LtnName]
		
	insert into [TraceDetail]
	([ParentGuid],[Caption],[Old],[New],[Tbl])
	Select Top 1
		@Guid,
		'' as [Caption],
		D.[Note] as [old],
		N.[Note] as [New],
		''
	From
		[deleted] d
		inner join [inserted] n on D.Guid = N.Guid
	where
		N.[Note] <> D.[Note]
		
	insert into [TraceDetail]
	([ParentGuid],[Caption],[Old],[New],[Tbl])
	Select Top 1
		@Guid,
		' ' as [Caption],
		D.[ParentGuid] as [old],
		N.[ParentGuid] as [New],
		'[AssetsArea]'
	From
		[deleted] d
		inner join [inserted] n on D.Guid = N.Guid
	where
		N.[ParentGuid] <> D.[ParentGuid]
		
	delete Trace From Trace t left join [TraceDetail] D on T.guid = D.ParentGuid
	where
		d.ParentGuid is Null and t.Guid = @Guid


GO

SET ANSI_NULLS, QUOTED_IDENTIFIER ON
GO

CREATE FUNCTION [fnGetLastHijriCurrentMonth] ()
RETURNS Datetime
 
AS
BEGIN
	Declare @R Datetime
			,@Y Varchar(256)
			,@m Varchar(256)
			,@d Varchar(256)


	Set @Y = dbo.FnGregToHijriDate (getDate(), 'yyyy')
	Set @M = dbo.FnGregToHijriDate (getDate(), 'mm')
	Set @D = isNull((Select DAY From HjrConfig where hjrMonth = @m and hjrYear = @y),29)

	Set @R = dbo.fnDecodeHijriDatetoGergDate(@Y, @m, @d)
	RETURN @R

END

GO

SET ANSI_NULLS, QUOTED_IDENTIFIER ON
GO

Create Trigger [TRG_Trace_AssetsChangeArea]
on [AssetsChangeArea]
 
for update
As
	SET NOCOUNT ON;
	if Not exists(Select Value from DMD_const where vName = 'ActiveLogCardUpdate' and Value = '1' ) return
	
	Declare @UserGuid uniqueidentifier, @Guid uniqueidentifier
	Set @Guid = NEWID()
	
	Select Top 1 @UserGuid = userGuid From CurrentUsers where Spid = @@SPID
			
	insert into [Trace]
	([Guid],[ParentGuid],[Date],[userGuid],[HostName],ParentTbl)
	Select Top 1
		@Guid,
		N.Guid,
		GETDATE(),
		@UserGuid,
		Host_Name(),
		'AssetsChangeArea'
	From
		[inserted] n 
		
	insert into [TraceDetail]
	([ParentGuid],[Caption],[Old],[New],[Tbl])
	Select Top 1
		@Guid,
		' ' as [Caption],
		D.[SecLvl] as [old],
		N.[SecLvl] as [New],
		''
	From
		[deleted] d
		inner join [inserted] n on D.Guid = N.Guid
	where
		N.[SecLvl] <> D.[SecLvl]
		
	insert into [TraceDetail]
	([ParentGuid],[Caption],[Old],[New],[Tbl])
	Select Top 1
		@Guid,
		'' as [Caption],
		D.[AssetsGuid] as [old],
		N.[AssetsGuid] as [New],
		'[Assets]'
	From
		[deleted] d
		inner join [inserted] n on D.Guid = N.Guid
	where
		N.[AssetsGuid] <> D.[AssetsGuid]
		
	insert into [TraceDetail]
	([ParentGuid],[Caption],[Old],[New],[Tbl])
	Select Top 1
		@Guid,
		'' as [Caption],
		dbo.fnDate(D.[Date]) as [old],
		dbo.fnDate(N.[Date]) as [New],
		''
	From
		[deleted] d
		inner join [inserted] n on D.Guid = N.Guid
	where
		N.[Date] <> D.[Date]
		
	insert into [TraceDetail]
	([ParentGuid],[Caption],[Old],[New],[Tbl])
	Select Top 1
		@Guid,
		' ' as [Caption],
		D.[CurrentAreaGuid] as [old],
		N.[CurrentAreaGuid] as [New],
		'[AssetsArea]'
	From
		[deleted] d
		inner join [inserted] n on D.Guid = N.Guid
	where
		N.[CurrentAreaGuid] <> D.[CurrentAreaGuid]
		
	insert into [TraceDetail]
	([ParentGuid],[Caption],[Old],[New],[Tbl])
	Select Top 1
		@Guid,
		' ' as [Caption],
		D.[AreaGuid] as [old],
		N.[AreaGuid] as [New],
		'[AssetsArea]'
	From
		[deleted] d
		inner join [inserted] n on D.Guid = N.Guid
	where
		N.[AreaGuid] <> D.[AreaGuid]
		
	insert into [TraceDetail]
	([ParentGuid],[Caption],[Old],[New],[Tbl])
	Select Top 1
		@Guid,
		'' as [Caption],
		D.[Note] as [old],
		N.[Note] as [New],
		''
	From
		[deleted] d
		inner join [inserted] n on D.Guid = N.Guid
	where
		N.[Note] <> D.[Note]
		
	delete Trace From Trace t left join [TraceDetail] D on T.guid = D.ParentGuid
	where
		d.ParentGuid is Null and t.Guid = @Guid


GO

SET ANSI_NULLS, QUOTED_IDENTIFIER ON
GO

Create Procedure [PrcReCreateEntryType]
(
	@UpdateSEntrywithdefaultType bit = 0,
	@Date1 DateTime = '1/1/2015',
	@Date2 DateTime = '1/5/2015',
	@ActiveDate bit = 1
)
 
as
	Set noCount on 
	
	--ForWaitProgress	
	exec PrcSetProgrss '', 100, 0
	Declare @AllCount int	
	Select
		@AllCount = COUNT(*)
	From 
		[Secondary_Entry] S
		inner join [EntryType] T on T.Guid = S.TypeGuid
		inner join [Resource] R on R.Guid = S.TypeGuid and R.Spid = @@SPID
	where
		(S.Date between @Date1 and @Date2 or @ActiveDate = 0)
		and IsNull(IsRounded,0) = 0
		
	Declare @Msg varchar(255),
			@MsgConst varchar(255)
	Set @MsgConst = dbo.SC('     ')
			
	Set @Msg = @MsgConst +' '+'0 / '+Cast(@AllCount as Varchar(25))
	exec PrcSetProgrss @Msg, @AllCount, 0
	Declare @Counter int
	Set @Counter = 0
	--ForWaitProgress	End

	if @UpdateSEntrywithdefaultType = 1
	update Secondary_EntryDetail Set [CostGuid] = Ctr.[UnitCostGuid]
	From 
		[Secondary_EntryDetail] D
		inner join [Secondary_Entry] S on s.Guid = D.ParentGuid
		inner join [EntryType] T on T.Guid = S.TypeGuid
		inner join [Resource] R on R.Guid = S.TypeGuid and R.Spid = @@SPID
		inner join [vwAllContract] ctr on ctr.Guid = S.ContractGuid
	where
		(S.Date between @Date1 and @Date2 or @ActiveDate = 0)
		and IsNull(IsRounded,0) = 0

	Declare @Guid uniqueidentifier,
			@ContractGuid uniqueidentifier
	Declare @RowCount int
	
	DECLARE cursor_Name CURSOR FAST_FORWARD FOR 
	Select 
		S.[Guid],
		S.ContractGuid
	From 
		[Secondary_Entry] S
		inner join [EntryType] T on T.Guid = S.TypeGuid
		inner join [Resource] R on R.Guid = S.TypeGuid and R.Spid = @@SPID
	where
		(S.Date between @Date1 and @Date2 or @ActiveDate = 0)
		and IsNull(IsRounded,0) = 0
		
	Set @RowCount = 0
	

	OPEN cursor_Name
	FETCH NEXT FROM cursor_Name INTO @Guid, @ContractGuid
	
	WHILE @@FETCH_STATUS = 0
	BEGIN
		
		--ForWaitProgress	
		Set @Counter = @Counter + 1
		Set @Msg = @MsgConst +' '+Cast(@Counter as Varchar(25)) +' / '+Cast(@AllCount as Varchar(25))
		exec PrcSetProgrss @Msg, @AllCount, @Counter

		--Print @Guid
		--Print @ContractGuid
		
		exec [PrcCreateEntryFromEntryType] @Guid, @ContractGuid
		Set @RowCount = @RowCount + 1
		FETCH NEXT FROM cursor_Name INTO @Guid, @ContractGuid
	
	END
	
	CLOSE cursor_Name
	DEALLOCATE cursor_Name

	--ForWaitProgress	
	Set @Msg = dbo.SC('')
	exec PrcSetProgrss @Msg, 0, 0

	if dbo.fnInRoundProcess() = 0
	Select @RowCount as [RowCount]
		

GO

SET ANSI_NULLS, QUOTED_IDENTIFIER ON
GO

	Create View [vbReceiptOrder]
	 
	as
		Select 
			[T].*
		From
			[ReceiptOrder] [T]
			inner join [CurrentUsers] [U] on ([u].[Seclvl] >= Isnull([T].[SecLvl],0)  or [u].[Admin] = 1) and [u].[spid] = @@Spid
GO

SET ANSI_NULLS, QUOTED_IDENTIFIER ON
GO

Create Procedure [dbo].[PrcCreateOwnerUnionFee]
(
	@Guid uniqueidentifier = '9E69DFC9-6079-4EE1-AB9E-2EC0757EB325'
)
 
AS
	Set NoCount on 
	Declare 
			@EnNum int

	--  
	Select 
		@EnNum = isnull([Number],0)
	From
		[Hentry]
	where
		[Guid] = @Guid
	
	--Select @EnNum
	if isnull(@EnNum,0) = 0
	begin	
		Select @EnNum = IsNull(Max([Number]),0) + 1 from [HEntry]
	END

	--return
	--   
	Delete 
		HEntry 
	where
		[Guid] = @Guid

	Insert Into [HEntry]
	([Guid],[SecLvl],[Mark],[Number],[Date], [CurrencyGuid], [CurrencyVal], [Note], [ParentKind], [BranchGuid], [IsPosted])
	Select
		Guid,
		[SecLvl],
		0 as Mark,
		@EnNum,
		[Date],
		CurrencyGuid,
		CurrencyVal,
		Note,
		160,
		Null,
		1 as AutoPostedEntry
	from
		[OwnerUnionFee] 
	where
		Guid = @Guid
		
	Declare @DetailNum Int
	Set @DetailNum = 0

	Insert into [DEntry]
	([ParentGuid],[Number],[AcGuid],[Debit],[Credit],[CurrencyGuid],[CurrencyVal],[CostGuid],[ObverseAcGuid],[Note])
	Select
		D.[ParentGuid],
		D.[Number],
		D.[AccountGuid],
		D.[Fee],
		0 as [Credit],
		P.[CurrencyGuid],P.[CurrencyVal],
		Case when CkMoveDebitCost = 1 then D.[CostGuid] end,
		P.[AccountGuid] ,
		D.[Note]
	From
		[OwnerUnionFee] P
		inner join [OwnerUnionFeeDetail] D on D.parentGuid = p.Guid
	where
		P.Guid = @Guid
		and (D.[AccountGuid] is Not Null)
		and (D.[Fee] <> 0)

	Insert into [DEntry]
	([ParentGuid],[Number],[AcGuid],[Debit],[Credit],[CurrencyGuid],[CurrencyVal],[CostGuid],[ObverseAcGuid],[Note])
	Select
		D.[ParentGuid],
		D.[Number],
		P.[AccountGuid],
		0 as Debit,
		D.[Fee] as [Credit],
		P.[CurrencyGuid],P.[CurrencyVal],
		Case when CkMoveCreditCost = 1 then D.[CostGuid] end,
		D.[AccountGuid] ,
		D.[Note]
	From
		[OwnerUnionFee] P
		inner join [OwnerUnionFeeDetail] D on D.parentGuid = p.Guid
	where
		P.Guid = @Guid
		and (D.[AccountGuid] is Not Null)
		and (D.[Fee] <> 0)

	exec PrcDoDistributiveEntry @Guid
		
		
	--Select * from Dentry where ParentGuid = @EnGuid
	Update [Hentry] Set IsPosted = 1 where Guid = @Guid


GO

SET ANSI_NULLS, QUOTED_IDENTIFIER ON
GO
Create Procedure PrcSetHijriConfig
(
	@HYear int = 1436
)
 
as
	if exists(Select * from HjrConfig where hjryear = @HYear) return
	--return
	
	
	
	Declare @Date Datetime
	Set @Date = dbo.fnHijriStrtoGergDate(Cast(@HYear as Varchar(4))+'/1/1','yyyy/mm/dd')
	Declare @S Varchar(256)

	Declare @Hy int
	Declare @Hm int
	Declare @Hd int

	Set @S = Convert(Varchar(256), @Date , 131)

	Set @Hy = SUBSTRING (@S, 7, 4)
		
	Declare @iM int, @iD int, @MXD int
	Set @Im = 1
	while @iM <= 12
	begin
		Set @iD = 1
		Set @MXD = 1
		while @iD <= 30
		begin
			Set @S = Convert(Varchar(256), dbo.fnDecodeHijriDatetoGergDate(@HY, @iM, @iD) , 131)
		
			Set @Hy = SUBSTRING (@S, 7, 4)
			Set @Hm = SUBSTRING (@S, 4, 2)
			Set @Hd = SUBSTRING (@S, 1, 2)

			Set @hd = Replace(@hd,' ','0')
			Set @hm = dbo.FnFormatNumber(@hm, 2)
			Set @hd = dbo.FnFormatNumber(@hd, 2)
			
			if @MXD < @hd
			Set @MXD = @hd			
			--Select @Im, @Id, @Hy, @Hm, @Hd

			Set @iD = @iD + 1
		end
		
		insert into HjrConfig
		Select
			@HYear, @iM, dbo.fnDecodeHijriDatetoGergDate(@HY, @iM, 1), @MXD
			
		Set @iM = @iM + 1
	end

	
	Select * from HjrConfig where hjryear = @HYear

GO

SET ANSI_NULLS, QUOTED_IDENTIFIER ON
GO

Create Trigger [TRG_Trace_AssetsGroup]
on [AssetsGroup]
 
for update
As
	SET NOCOUNT ON;
	if Not exists(Select Value from DMD_const where vName = 'ActiveLogCardUpdate' and Value = '1' ) return
	
	Declare @UserGuid uniqueidentifier, @Guid uniqueidentifier
	Set @Guid = NEWID()
	
	Select Top 1 @UserGuid = userGuid From CurrentUsers where Spid = @@SPID
			
	insert into [Trace]
	([Guid],[ParentGuid],[Date],[userGuid],[HostName],ParentTbl )
	Select Top 1
		@Guid,
		N.Guid,
		GETDATE(),
		@UserGuid,
		Host_Name(),
		'AssetsGroup'
	From
		[inserted] n 
		
	insert into [TraceDetail]
	([ParentGuid],[Caption],[Old],[New],[Tbl])
	Select Top 1
		@Guid,
		' ' as [Caption],
		D.[SecLvl] as [old],
		N.[SecLvl] as [New],
		''
	From
		[deleted] d
		inner join [inserted] n on D.Guid = N.Guid
	where
		N.[SecLvl] <> D.[SecLvl]
		
	insert into [TraceDetail]
	([ParentGuid],[Caption],[Old],[New],[Tbl])
	Select Top 1
		@Guid,
		'' as [Caption],
		D.[Code] as [old],
		N.[Code] as [New],
		''
	From
		[deleted] d
		inner join [inserted] n on D.Guid = N.Guid
	where
		N.[Code] <> D.[Code]
		
	insert into [TraceDetail]
	([ParentGuid],[Caption],[Old],[New],[Tbl])
	Select Top 1
		@Guid,
		'' as [Caption],
		D.[Name] as [old],
		N.[Name] as [New],
		''
	From
		[deleted] d
		inner join [inserted] n on D.Guid = N.Guid
	where
		N.[Name] <> D.[Name]
		
	insert into [TraceDetail]
	([ParentGuid],[Caption],[Old],[New],[Tbl])
	Select Top 1
		@Guid,
		' ' as [Caption],
		D.[LtnName] as [old],
		N.[LtnName] as [New],
		''
	From
		[deleted] d
		inner join [inserted] n on D.Guid = N.Guid
	where
		N.[LtnName] <> D.[LtnName]
		
	insert into [TraceDetail]
	([ParentGuid],[Caption],[Old],[New],[Tbl])
	Select Top 1
		@Guid,
		'' as [Caption],
		D.[Note] as [old],
		N.[Note] as [New],
		''
	From
		[deleted] d
		inner join [inserted] n on D.Guid = N.Guid
	where
		N.[Note] <> D.[Note]
		
	insert into [TraceDetail]
	([ParentGuid],[Caption],[Old],[New],[Tbl])
	Select Top 1
		@Guid,
		' ' as [Caption],
		D.[ParentGuid] as [old],
		N.[ParentGuid] as [New],
		'AssetsGroup'
	From
		[deleted] d
		inner join [inserted] n on D.Guid = N.Guid
	where
		N.[ParentGuid] <> D.[ParentGuid]
		
	delete Trace From Trace t left join [TraceDetail] D on T.guid = D.ParentGuid
	where
		d.ParentGuid is Null and t.Guid = @Guid


GO

SET ANSI_NULLS, QUOTED_IDENTIFIER ON
GO

Create Procedure [PrcTransferEntryCardType]
(
	@TypeGuid1 uniqueidentifier = 0x0,
	@TypeGuid2 uniqueidentifier = 0x0,
	@Date1 DateTime = '1/1/2007',
	@Date2 DateTime = '1/1/2012',
	@Num1 int = 0,
	@Num2 int = 0
)
 
as
	Declare @RC int

	Alter Table [Secondary_Entry] Drop [Secondary_Entry_Unique_Number] 
	
	Update [Secondary_Entry] Set TypeGuid = @TypeGuid2, Number  = Null
	where
		TypeGuid = @TypeGuid1
		and ([date] between @Date1 and @Date2 or (@Date1 = 0 and @Date2 = 0))
		and ([Number] between @Num1 and @Num2 or @Num1 = 0)
		
	Set @RC = @@ROWCOUNT	

	Delete [Secondary_Entry] 
	where
		TypeGuid = @TypeGuid1
		and ([date] between @Date1 and @Date2)
		and ([Number] between @Num1 and @Num2 or @Num1 = 0)
			
	Create Table #Tbl
	(
		[id] Int identity(1,1),
		Guid uniqueidentifier
	)

	Insert Into #Tbl
	([Guid])
	Select
		Guid
	From
		Secondary_Entry
	where 
		IsNull(Number,-1) = -1
	Order By
		[Date]


	Declare @MaxNum int
	Set @MaxNum = (Select isNull(Max(Number),0) + 1 From Secondary_Entry where TypeGuid = @TypeGuid2)
	
	Update Secondary_Entry Set Number = @MaxNum + [id]
	From
		Secondary_Entry gr
		inner join #Tbl t On t.Guid = gr.Guid	
		

	Alter Table [Secondary_Entry] Add
	CONSTRAINT [Secondary_Entry_Unique_Number] UNIQUE  NONCLUSTERED (Number,TypeGuid)	

	Select @RC As [RC]
		

GO

SET ANSI_NULLS, QUOTED_IDENTIFIER ON
GO

	Create View [vbOwnerUnionFee]
	 
	as
		Select 
			[T].*
		From
			[OwnerUnionFee] [T]
			inner join [CurrentUsers] [U] on ([u].[Seclvl] >= Isnull([T].[SecLvl],0)  or [u].[Admin] = 1) and [u].[spid] = @@Spid
GO

SET ANSI_NULLS, QUOTED_IDENTIFIER ON
GO
Create Function dbo.fnEncodeDate(@Year int, @Month int, @Day int)
returns DateTime
 
as
begin
	if @Year = 0 
	Set @Year = DATEPART(YEAR, GETDATE())
	
	if @Month = 0 
	Set @Month = DATEPART(Month, GETDATE())

	if @Day = 0 
	Set @Day = DATEPART(Day, GETDATE())

	return Cast(Cast(@year as Varchar(10)) +'/'+ Cast(@Month as Varchar(10))+'/'+ Cast(@Day as Varchar(10)) as Datetime)
end


GO

SET ANSI_NULLS, QUOTED_IDENTIFIER ON
GO

Create Procedure [dbo].[PrcSMSEntry]
(
	@Guid uniqueidentifier = 0x0
)
 
as
	Select 
		S.[date],
		S.[Number],
		(Select SUM(Debit) From Secondary_EntryDetail where ParentGuid = @Guid) as [Debit],
		(Select SUM(Credit) From Secondary_EntryDetail where ParentGuid = @Guid) as [Credit],
		S.[Note],
		D.Note  as [ItemNote],
		Ac.Name as Account,
		Aci.Name as AccountItem,
		Cu.Mobile as CustMobile
	From 
		Secondary_Entry S
		inner join Account Ac on Ac.Guid = S.AccountGuid
		inner join (
					Select	Top 1
						*
					From
						Secondary_EntryDetail
					where
						ParentGuid = @Guid	
					) D on D.ParentGuid = S.Guid
		inner join Account Aci on Aci.Guid = D.AcGuid
		inner join Customer Cu on Cu.AcGuid = Aci.Guid
	where
		S.Guid = @Guid

GO

SET ANSI_NULLS, QUOTED_IDENTIFIER ON
GO

Create Trigger [TRG_Trace_Currency]
on [Currency]
 
for update
As
	SET NOCOUNT ON;
	if Not exists(Select Value from DMD_const where vName = 'ActiveLogCardUpdate' and Value = '1' ) return
	
	Declare @UserGuid uniqueidentifier, @Guid uniqueidentifier
	Set @Guid = NEWID()
	
	Select Top 1 @UserGuid = userGuid From CurrentUsers where Spid = @@SPID
			
	insert into [Trace]
	([Guid],[ParentGuid],[Date],[userGuid],[HostName],ParentTbl )
	Select Top 1
		@Guid,
		N.Guid,
		GETDATE(),
		@UserGuid,
		Host_Name(),
		'Currency'
	From
		[inserted] n 
		
	insert into [TraceDetail]
	([ParentGuid],[Caption],[Old],[New],[Tbl])
	Select Top 1
		@Guid,
		' ' as [Caption],
		D.[SecLvl] as [old],
		N.[SecLvl] as [New],
		''
	From
		[deleted] d
		inner join [inserted] n on D.Guid = N.Guid
	where
		N.[SecLvl] <> D.[SecLvl]
		
	insert into [TraceDetail]
	([ParentGuid],[Caption],[Old],[New],[Tbl])
	Select Top 1
		@Guid,
		'' as [Caption],
		D.[Code] as [old],
		N.[Code] as [New],
		''
	From
		[deleted] d
		inner join [inserted] n on D.Guid = N.Guid
	where
		N.[Code] <> D.[Code]
		
	insert into [TraceDetail]
	([ParentGuid],[Caption],[Old],[New],[Tbl])
	Select Top 1
		@Guid,
		' ' as [Caption],
		D.[LtnCode] as [old],
		N.[LtnCode] as [New],
		''
	From
		[deleted] d
		inner join [inserted] n on D.Guid = N.Guid
	where
		N.[LtnCode] <> D.[LtnCode]
		
	insert into [TraceDetail]
	([ParentGuid],[Caption],[Old],[New],[Tbl])
	Select Top 1
		@Guid,
		'' as [Caption],
		D.[Name] as [old],
		N.[Name] as [New],
		''
	From
		[deleted] d
		inner join [inserted] n on D.Guid = N.Guid
	where
		N.[Name] <> D.[Name]
		
	insert into [TraceDetail]
	([ParentGuid],[Caption],[Old],[New],[Tbl])
	Select Top 1
		@Guid,
		' ' as [Caption],
		D.[LtnName] as [old],
		N.[LtnName] as [New],
		''
	From
		[deleted] d
		inner join [inserted] n on D.Guid = N.Guid
	where
		N.[LtnName] <> D.[LtnName]
		
	insert into [TraceDetail]
	([ParentGuid],[Caption],[Old],[New],[Tbl])
	Select Top 1
		@Guid,
		'' as [Caption],
		D.[CurrencyVal] as [old],
		N.[CurrencyVal] as [New],
		''
	From
		[deleted] d
		inner join [inserted] n on D.Guid = N.Guid
	where
		N.[CurrencyVal] <> D.[CurrencyVal]
		
	insert into [TraceDetail]
	([ParentGuid],[Caption],[Old],[New],[Tbl])
	Select Top 1
		@Guid,
		'  ' as [Caption],
		D.[EnPartName] as [old],
		N.[EnPartName] as [New],
		''
	From
		[deleted] d
		inner join [inserted] n on D.Guid = N.Guid
	where
		N.[EnPartName] <> D.[EnPartName]
		
	insert into [TraceDetail]
	([ParentGuid],[Caption],[Old],[New],[Tbl])
	Select Top 1
		@Guid,
		' ' as [Caption],
		D.[ArPartName] as [old],
		N.[ArPartName] as [New],
		''
	From
		[deleted] d
		inner join [inserted] n on D.Guid = N.Guid
	where
		N.[ArPartName] <> D.[ArPartName]
		
	insert into [TraceDetail]
	([ParentGuid],[Caption],[Old],[New],[Tbl])
	Select Top 1
		@Guid,
		'' as [Caption],
		D.[Part] as [old],
		N.[Part] as [New],
		''
	From
		[deleted] d
		inner join [inserted] n on D.Guid = N.Guid
	where
		N.[Part] <> D.[Part]
		
	insert into [TraceDetail]
	([ParentGuid],[Caption],[Old],[New],[Tbl])
	Select Top 1
		@Guid,
		'' as [Caption],
		D.[Note] as [old],
		N.[Note] as [New],
		''
	From
		[deleted] d
		inner join [inserted] n on D.Guid = N.Guid
	where
		N.[Note] <> D.[Note]
		
	delete Trace From Trace t left join [TraceDetail] D on T.guid = D.ParentGuid
	where
		d.ParentGuid is Null and t.Guid = @Guid


GO

SET ANSI_NULLS, QUOTED_IDENTIFIER ON
GO

Create FUNCTION [dbo].[fnGetGroupList]( @ParentGroupGUID [UNIQUEIDENTIFIER])  
	RETURNS @Result TABLE (
							[GUID] [UNIQUEIDENTIFIER], 
							[Code] Varchar(256) COLLATE ARABIC_CI_AI, 
							[Name] Varchar(256) COLLATE ARABIC_CI_AI, 
							[Level] [INT] DEFAULT 0, 
							[Path] [VARCHAR](8000) COLLATE ARABIC_CI_AI
						)   
 
AS 
BEGIN  
		---- 
	Declare @AcType int
	Set @AcType = 1
	if isnull(@AcType,0) <> 2
	begin
		DECLARE @FatherBuf_S	TABLE
		(
			[GUID] [UNIQUEIDENTIFIER], 
			[Level] [INT], 
			[Path] [VARCHAR](8000) COLLATE ARABIC_CI_AI, 
			[ID] [INT] IDENTITY( 1, 1)
		)   
		DECLARE  @Continue_S [INT], @Level_S [INT]  
		SET @Level_S = 0   
		  
		SET @ParentGroupGUID = ISNULL(@ParentGroupGUID, 0x0)   
		IF @ParentGroupGUID = 0x0   
		BEGIN 
			INSERT INTO @FatherBuf_S ( [GUID], [Level], [Path]) 
			SELECT 
				[ac1].[Guid], @Level_S, ''  
			FROM 
				[MatGroup] [ac1] 
			WHERE 
				( ISNULL( [ac1].[ParentGuid], 0x0) = 0x0 ) 
			ORDER BY 
				[ac1].[Code]
				
			INSERT INTO @fatherBuf_s ( [GUID], [Level], [Path]) 
			SELECT [ac1].[Guid], @Level_S, ''  
			FROM  
				[MatGroup] [ac1] 
				LEFT JOIN [MatGroup] [ac2] ON [ac1].[ParentGuid] = [ac2].[Guid] 
				LEFT JOIN @fatherBuf_s [f] ON [ac1].[Guid] = [f].[Guid]  
			WHERE  
				ISNULL( [ac1].[ParentGuid], 0x0) != 0x0 
				AND [ac2].[Guid] IS NULL 
				AND [f].[Guid]IS NULL 
			ORDER BY  
				[Ac1].[Code]
		END 
		ELSE   
			INSERT INTO @FatherBuf_S ([GUID] , [Level], [Path]) SELECT [Guid], @Level_S, '' FROM [MatGroup] WHERE [Guid] = @ParentGroupGUID ORDER BY [Code]
		  
		UPDATE @FatherBuf_S  SET [Path] = CAST( ( 0.0000001 * ID) AS [VARCHAR](40))   
	  
		SET @Continue_S = 1   
		IF (@ParentGroupGUID = 0x0) 
		BEGIN   
			WHILE @Continue_S <> 0   
			BEGIN   
				SET @Level_S = @Level_S + 1   
				INSERT INTO @FatherBuf_S([GUID],[Level],[Path])  
					SELECT  
						[ac].[Guid], @Level_S,[fb].[Path]  
					FROM  
						[MatGroup] AS [ac] INNER JOIN @FatherBuf_S AS [fb]  
						ON [ac].[ParentGuid] = [fb].[GUID]   
					WHERE  
						[fb].[Level] = @Level_S - 1   
					ORDER BY  
						[ac].[Code]
				SET @Continue_S = @@ROWCOUNT   
				UPDATE @FatherBuf_S  SET [Path] = [Path] + CAST( ( 0.0000001 * [ID]) AS VARCHAR(40))  WHERE [Level] = @Level_S 
			END   
		END  
		ELSE  
		BEGIN   
			WHILE @Continue_S <> 0   
			BEGIN   
				SET @Level_S = @Level_S + 1   
				INSERT INTO @FatherBuf_S([GUID], [Level], [Path])  
					SELECT  
						[ac].[Guid],@Level_S,[fb].[Path]  
					FROM  
						[MatGroup] AS [ac] INNER JOIN @FatherBuf_S AS [fb]  
						ON [ac].[ParentGuid] = [fb].[GUID]   
					WHERE  
						[fb].[Level] = @Level_S - 1  
					ORDER BY  
						[ac].[Code]
				SET @Continue_S = @@ROWCOUNT   
				UPDATE @FatherBuf_S  SET [Path] = [Path] + CAST( ( 0.0000001 * ID) AS [VARCHAR](40))  WHERE [Level] = @Level_S 
			END   
		END   
	end
	else
	begin
		insert into @FatherBuf_S
		(
			[GUID],
			[Level], 
			[Path]
		)   
		Select
			[MatGroupGuid],
			0,
			0
		From
			[MatGroupAccumulate] 
		where
			[ParentGuid] = @ParentGroupGUID
	end	


	INSERT INTO @Result 
	SELECT 
		[S].[GUID], [Code], [Name], [Level], [Path] 
	FROM 
		@FatherBuf_S [S]
		Inner join [vwMatGroup] [Ac] on [Ac].[Guid] = [S].[Guid] 
	GROUP BY 
		[S].[GUID], [Level], [Path] ,[Code], [Name]
	ORDER BY [Path] 

	RETURN  
END 


GO

SET ANSI_NULLS, QUOTED_IDENTIFIER ON
GO
Create View [vwMat]
 
as
	Select
		mt.*,
		Case 
			when isNull([DefUnity],1) = 1 then [Unity1]
			when [DefUnity] = 2 then [Unity2]
			when [DefUnity] = 3 then [Unity3]
		end as [DefUnityName],

		Case 
			when isNull([DefUnity],1) = 1 then 1
			when [DefUnity] = 2 then [UnityFact2]
			when [DefUnity] = 3 then [UnityFact3]
		end as [DefUnityFact],

		Case 
			when isNull([DefUnity],1) = 1 then [Barcode1]
			when [DefUnity] = 2 then [Barcode2]
			when [DefUnity] = 3 then [Barcode3]
		end as [Barcode],

		[P].[Code]+'-'+[P].[Name] as [GroupName]
	From
		[vbMat] [mt]
		inner join [vbMatGroup] [P] on [P].[Guid] = [mt].[GroupGuid]


GO

SET ANSI_NULLS, QUOTED_IDENTIFIER ON
GO

Create View [vwEntryType]
 
as
	Select
		[A].[Number],
		[A].[Guid],
		[A].[SecLvl],
		[A].[Code],
		[A].[Name] as [ArName],
		Case when (dbo.FnGetLangauge(@@spid) = 1) and (Isnull([A].[LtnName],'') <> '') then [A].[LtnName] else [A].[Name] end as [Name], 
		[A].[ltnName],
		[A].[Menu] as [arMenu],
		Case when (dbo.FnGetLangauge(@@spid) = 1) and (Isnull([A].[LtnMenu],'') <> '') then [A].[LtnMenu] else [A].[Menu] end as [Menu], 
		[A].[LtnMenu],
		[A].[DefAccountGuid],
		[c].[code]+'-'+[c].[Name] as [DefAccount],
		[A].[DebitField],
		[A].[CreditField],
		Case when (dbo.FnGetLangauge(@@spid) = 1) and (Isnull([A].[LtnDebitCaption],'') <> '') then [A].[LtnDebitCaption] else [A].[DebitCaption] end as [DebitCaption], 
		Case when (dbo.FnGetLangauge(@@spid) = 1) and (Isnull([A].[LtnCreditCaption],'') <> '') then [A].[LtnCreditCaption] else [A].[CreditCaption] end as [CreditCaption], 
		[A].[CkCurrency],
		[A].[CkCurrencyRate],
		[A].[CkCost],
		[A].[CkNote],
		[A].[Color1],
		[A].[Color2],
		[A].[DefPrintPath],
		[A].[ShortCut],
		[A].[ShowContractField],
		[A].[NeedCostItem],
		[A].[NeedNoteItem]
	From 
		[vbEntryType] [A]
		left join [vwAccount] [c] on [c].[Guid] = [A].[DefAccountGuid]		


GO

SET ANSI_NULLS, QUOTED_IDENTIFIER ON
GO

Create Procedure [PrcGetMatDescription]
(
	@MatGuid uniqueidentifier = 0x0
)
 
as
	Select 
		Case when (dbo.FnGetLangauge(@@spid) = 1) and (Isnull([G].[LtnName],'') <> '') then [G].[LtnName] else [G].[Name] end as [Name],
		[m].[Value], 
		[m].[Note] 
	From 
		[MatDescriptionConfig] [g]
		left join [MatDescription] [m] on [m].[Number] = [g].[Number] and [m].[matGuid] = @MatGuid
	where
		[Kind] = 0
	Order By
		[G].[Number]
	

GO

SET ANSI_NULLS, QUOTED_IDENTIFIER ON
GO

Create View [vwEntryDateType]

as
	Select
		[A].[Number],
		[A].[Guid],
		[A].[SecLvl],
		[A].[Code],
		[A].[Name] as [ArName],
		Case when (dbo.FnGetLangauge(@@spid) = 1) and (Isnull([A].[LtnName],'') <> '') then [A].[LtnName] else [A].[Name] end as [Name], 
		[A].[ltnName],
		[A].[Menu] as [arMenu],
		Case when (dbo.FnGetLangauge(@@spid) = 1) and (Isnull([A].[LtnMenu],'') <> '') then [A].[LtnMenu] else [A].[Menu] end as [Menu], 
		[A].[LtnMenu],
		[A].[DefAccountGuid],
		[c].[code]+'-'+[c].[Name] as [DefAccount],
		[A].[DebitField],
		[A].[CreditField],
		Case when (dbo.FnGetLangauge(@@spid) = 1) and (Isnull([A].[LtnDebitCaption],'') <> '') then [A].[LtnDebitCaption] else [A].[DebitCaption] end as [DebitCaption], 
		Case when (dbo.FnGetLangauge(@@spid) = 1) and (Isnull([A].[LtnCreditCaption],'') <> '') then [A].[LtnCreditCaption] else [A].[CreditCaption] end as [CreditCaption], 
		[A].[CkCurrency],
		[A].[CkCost],
		[A].[CkNote],
		[A].[Color1],
		[A].[Color2],
		[A].[DefPrintPath],
		[A].[ShortCut],

		[A].[NeedCostItem],
		[A].[NeedNoteItem],
		[A].[AutoPostedEntry],
		[A].[OpMoveCostwithDefAccount]
	From 
		[vbEntryDateType] [A]
		left join [vwAccount] [c] on [c].[Guid] = [A].[DefAccountGuid]		


GO

SET ANSI_NULLS, QUOTED_IDENTIFIER ON
GO

Create Procedure [PrcGetMatDescriptionPrice]
(
	@MatGuid uniqueidentifier = 0x0,
	@CustGuid uniqueidentifier = 0x0
)
 
as
	
	
	Select 
		Case when (dbo.FnGetLangauge(@@spid) = 1) and (Isnull([G].[LtnName],'') <> '') then [G].[LtnName] else [G].[Name] end AS [PriceKind],
		[m].[price1], 
		[m].[price2], 
		[m].[price3]
	From 
		[MatDescriptionConfig] [g]
		left join [MatUnitsPrice] [m] on [m].[Number] = [g].[Number] and [m].[matGuid] = @MatGuid
	where
		[Kind] = 1
		
	union all
	Select 
		dbo.SC(' ') AS [PriceKind],
		avgPrice as [price1], 
		avgPrice * unityFact2 as [pric2], 
		avgPrice * unityFact3 as [price3]
	From 
		[Mat] M
	where
		[m].[Guid] = @MatGuid

	union all
	Select 
		dbo.SC('  ') AS [PriceKind],
		LastPrice as [price1], 
		LastPrice * unityFact2 as [pric2], 
		LastPrice * unityFact3 as [price3]
	From 
		[Mat] M
	where
		[m].[Guid] = @MatGuid

	union all
	Select 
		dbo.SC(' ') AS [PriceKind],
		MaxPrice as [price1], 
		MaxPrice * unityFact2 as [pric2], 
		MaxPrice * unityFact3 as [price3]
	From 
		[Mat] M
	where
		[m].[Guid] = @MatGuid
		
	union all
	Select 
		dbo.SC(' ') AS [PriceKind],
		SaleavgPrice as [price1], 
		SaleavgPrice * unityFact2 as [pric2], 
		SaleavgPrice * unityFact3 as [price3]
	From 
		[Mat] M
	where
		[m].[Guid] = @MatGuid

	union all
	Select 
		dbo.SC('  ') AS [PriceKind],
		SaleLastPrice as [price1], 
		SaleLastPrice * unityFact2 as [pric2], 
		SaleLastPrice * unityFact3 as [price3]
	From 
		[Mat] M
	where
		[m].[Guid] = @MatGuid

	union all
	Select 
		dbo.SC('  ') AS [PriceKind],
		SaleMaxPrice as [price1], 
		SaleMaxPrice * unityFact2 as [pric2], 
		SaleMaxPrice * unityFact3 as [price3]
	From 
		[Mat] M
	where
		[m].[Guid] = @MatGuid
		
	

GO

SET ANSI_NULLS, QUOTED_IDENTIFIER ON
GO

Create Trigger [TRG_Trace_Reminder]
on [Reminder]
 
for update
As
	SET NOCOUNT ON;
	if Not exists(Select Value from DMD_const where vName = 'ActiveLogCardUpdate' and Value = '1' ) return
	
	Declare @UserGuid uniqueidentifier, @Guid uniqueidentifier
	Set @Guid = NEWID()
	
	Select Top 1 @UserGuid = userGuid From CurrentUsers where Spid = @@SPID
			
	insert into [Trace]
	([Guid],[ParentGuid],[Date],[userGuid],[HostName],[ParentTbl])
	Select Top 1
		@Guid,
		N.Guid,
		GETDATE(),
		@UserGuid,
		Host_Name(),
		'Reminder'
	From
		[inserted] n 
		
	insert into [TraceDetail]
	([ParentGuid],[Caption],[Old],[New],[Tbl])
	Select Top 1
		@Guid,
		' ' as [Caption],
		D.[SecLvl] as [old],
		N.[SecLvl] as [New],
		''
	From
		[deleted] d
		inner join [inserted] n on D.Guid = N.Guid
	where
		N.[SecLvl] <> D.[SecLvl]
		
	insert into [TraceDetail]
	([ParentGuid],[Caption],[Old],[New],[Tbl])
	Select Top 1
		@Guid,
		'' as [Caption],
		D.[Subject] as [old],
		N.[Subject] as [New],
		''
	From
		[deleted] d
		inner join [inserted] n on D.Guid = N.Guid
	where
		N.[Subject] <> D.[Subject]
		
	insert into [TraceDetail]
	([ParentGuid],[Caption],[Old],[New],[Tbl])
	Select Top 1
		@Guid,
		'' as [Caption],
		dbo.fnDate(D.[Date]) as [old],
		dbo.fnDate(N.[Date]) as [New],
		''
	From
		[deleted] d
		inner join [inserted] n on D.Guid = N.Guid
	where
		N.[Date] <> D.[Date]
		
	insert into [TraceDetail]
	([ParentGuid],[Caption],[Old],[New],[Tbl])
	Select Top 1
		@Guid,
		' ' as [Caption],
		dbo.fnDate(D.[RemindDate]) as [old],
		dbo.fnDate(N.[RemindDate]) as [New],
		''
	From
		[deleted] d
		inner join [inserted] n on D.Guid = N.Guid
	where
		N.[RemindDate] <> D.[RemindDate]
		
	insert into [TraceDetail]
	([ParentGuid],[Caption],[Old],[New],[Tbl])
	Select Top 1
		@Guid,
		'' as [Caption],
		D.[Finished] as [old],
		N.[Finished] as [New],
		''
	From
		[deleted] d
		inner join [inserted] n on D.Guid = N.Guid
	where
		N.[Finished] <> D.[Finished]
		
	insert into [TraceDetail]
	([ParentGuid],[Caption],[Old],[New],[Tbl])
	Select Top 1
		@Guid,
		' ' as [Caption],
		D.[Mobile] as [old],
		N.[Mobile] as [New],
		''
	From
		[deleted] d
		inner join [inserted] n on D.Guid = N.Guid
	where
		N.[Mobile] <> D.[Mobile]
		
	insert into [TraceDetail]
	([ParentGuid],[Caption],[Old],[New],[Tbl])
	Select Top 1
		@Guid,
		'' as [Caption],
		D.[Note] as [old],
		N.[Note] as [New],
		''
	From
		[deleted] d
		inner join [inserted] n on D.Guid = N.Guid
	where
		N.[Note] <> D.[Note]
		
	insert into [TraceDetail]
	([ParentGuid],[Caption],[Old],[New],[Tbl])
	Select Top 1
		@Guid,
		'   ' as [Caption],
		D.[ForAllUser] as [old],
		N.[ForAllUser] as [New],
		''
	From
		[deleted] d
		inner join [inserted] n on D.Guid = N.Guid
	where
		N.[ForAllUser] <> D.[ForAllUser]
		
	insert into [TraceDetail]
	([ParentGuid],[Caption],[Old],[New],[Tbl])
	Select Top 1
		@Guid,
		'' as [Caption],
		D.[UserGuid] as [old],
		N.[UserGuid] as [New],
		'[strikt_Users]'
	From
		[deleted] d
		inner join [inserted] n on D.Guid = N.Guid
	where
		N.[UserGuid] <> D.[UserGuid]
		
	delete Trace From Trace t left join [TraceDetail] D on T.guid = D.ParentGuid
	where
		d.ParentGuid is Null and t.Guid = @Guid


GO

SET ANSI_NULLS, QUOTED_IDENTIFIER ON
GO

Create Trigger [TRG_Trace_Store]
on [Store]
 
for update
As
	SET NOCOUNT ON;
	if Not exists(Select Value from DMD_const where vName = 'ActiveLogCardUpdate' and Value = '1' ) return
	
	Declare @UserGuid uniqueidentifier, @Guid uniqueidentifier
	Set @Guid = NEWID()
	
	Select Top 1 @UserGuid = userGuid From CurrentUsers where Spid = @@SPID
			
	insert into [Trace]
	([Guid],[ParentGuid],[Date],[userGuid],[HostName],[ParentTbl])
	Select Top 1
		@Guid,
		N.Guid,
		GETDATE(),
		@UserGuid,
		Host_Name(),
		'Store'
	From
		[inserted] n 
		
	insert into [TraceDetail]
	([ParentGuid],[Caption],[Old],[New],[Tbl])
	Select Top 1
		@Guid,
		' ' as [Caption],
		D.[SecLvl] as [old],
		N.[SecLvl] as [New],
		''
	From
		[deleted] d
		inner join [inserted] n on D.Guid = N.Guid
	where
		N.[SecLvl] <> D.[SecLvl]
		
	insert into [TraceDetail]
	([ParentGuid],[Caption],[Old],[New],[Tbl])
	Select Top 1
		@Guid,
		'' as [Caption],
		D.[Code] as [old],
		N.[Code] as [New],
		''
	From
		[deleted] d
		inner join [inserted] n on D.Guid = N.Guid
	where
		N.[Code] <> D.[Code]
		
	insert into [TraceDetail]
	([ParentGuid],[Caption],[Old],[New],[Tbl])
	Select Top 1
		@Guid,
		'' as [Caption],
		D.[Name] as [old],
		N.[Name] as [New],
		''
	From
		[deleted] d
		inner join [inserted] n on D.Guid = N.Guid
	where
		N.[Name] <> D.[Name]
		
	insert into [TraceDetail]
	([ParentGuid],[Caption],[Old],[New],[Tbl])
	Select Top 1
		@Guid,
		' ' as [Caption],
		D.[LtnName] as [old],
		N.[LtnName] as [New],
		''
	From
		[deleted] d
		inner join [inserted] n on D.Guid = N.Guid
	where
		N.[LtnName] <> D.[LtnName]
		
	insert into [TraceDetail]
	([ParentGuid],[Caption],[Old],[New],[Tbl])
	Select Top 1
		@Guid,
		'Address' as [Caption],
		D.[Address] as [old],
		N.[Address] as [New],
		''
	From
		[deleted] d
		inner join [inserted] n on D.Guid = N.Guid
	where
		N.[Address] <> D.[Address]
		
	insert into [TraceDetail]
	([ParentGuid],[Caption],[Old],[New],[Tbl])
	Select Top 1
		@Guid,
		'warehouseman' as [Caption],
		D.[warehouseman] as [old],
		N.[warehouseman] as [New],
		''
	From
		[deleted] d
		inner join [inserted] n on D.Guid = N.Guid
	where
		N.[warehouseman] <> D.[warehouseman]
		
	insert into [TraceDetail]
	([ParentGuid],[Caption],[Old],[New],[Tbl])
	Select Top 1
		@Guid,
		'' as [Caption],
		D.[Note] as [old],
		N.[Note] as [New],
		''
	From
		[deleted] d
		inner join [inserted] n on D.Guid = N.Guid
	where
		N.[Note] <> D.[Note]
		
	insert into [TraceDetail]
	([ParentGuid],[Caption],[Old],[New],[Tbl])
	Select Top 1
		@Guid,
		'ParentGuid' as [Caption],
		D.[ParentGuid] as [old],
		N.[ParentGuid] as [New],
		''
	From
		[deleted] d
		inner join [inserted] n on D.Guid = N.Guid
	where
		N.[ParentGuid] <> D.[ParentGuid]
		
	insert into [TraceDetail]
	([ParentGuid],[Caption],[Old],[New],[Tbl])
	Select Top 1
		@Guid,
		'AcFinalGUID' as [Caption],
		D.[AcFinalGUID] as [old],
		N.[AcFinalGUID] as [New],
		''
	From
		[deleted] d
		inner join [inserted] n on D.Guid = N.Guid
	where
		N.[AcFinalGUID] <> D.[AcFinalGUID]
		
	delete Trace From Trace t left join [TraceDetail] D on T.guid = D.ParentGuid
	where
		d.ParentGuid is Null and t.Guid = @Guid


GO

SET ANSI_NULLS, QUOTED_IDENTIFIER ON
GO

Create Procedure [PrcTreeMat]
(
	@AcGuid uniqueidentifier = 0x0
)
 
as
	Declare @Level int
	Set @Level = Case when @AcGuid = 0x0 then 0 else 3 end

	Create Table #Res 
	(
		[Number] int, 
		[Guid] uniqueidentifier, 
		[Type] int, 
		[Code] Varchar(256) COLLATE database_default, 
		[Name] Varchar(256) COLLATE database_default, 
		[LtnName] Varchar(256) COLLATE database_default, 
		[ParentGuid]uniqueidentifier,
		[Path]  Varchar(256) COLLATE database_default
	)

	insert into #Res
	Select
		[A].[Number], 
		[A].[Guid], 
		1 as [Type], 
		[A].[Code], 
		Case when (dbo.FnGetLangauge(@@spid) = 1) and (Isnull([A].[LtnName],'') <> '') then [A].[LtnName] else [A].[Name] end as [Name], 
		[A].[LtnName],
		case when [A].[ParentGuid] is Not Null then [A].[ParentGuid] else 0x0 end as [Parent],
		[F].[Path]
	From 
		[vbMatGroup] [A]
		inner join [dbo].[fnGetGroupList](@AcGuid) [F] on [F].[Guid] = [A].[Guid]

/*
	insert into #Res
	Select
		[A].[Number], 
		[A].[Guid], 
		2 as [Type], 
		[A].[Code], 
		Case when (dbo.FnGetLangauge(@@spid) = 1) and (Isnull([A].[LtnName],'') <> '') then [A].[LtnName] else [A].[Name] end as [Name], 
		[A].[LtnName],
		case when [A].[GroupGuid] is Not Null then [A].[GroupGuid] else 0x0 end as [Parent],
		[F].[Path]
	From 
		[vbMat] [A]
		inner join [dbo].[fnGetGroupList](@AcGuid) [F] on [F].[Guid] = [A].[GroupGuid]
*/

	--CREATE INDEX IXS_Guid ON #Res ([Guid])
	-----------------------------------------------------------------------------------
	CREATE INDEX IXS_Res_Path ON #Res ([Path], [Type], [Code])
	Alter Table #Res add Id int identity(1,1)
	
	Select 
		*
		,Len([Path]) / 9 as [level]
		,(select id from #Res rp where rp.guid = r.Parentguid) as [ParentId]
	from 
		#Res r
	ORDER BY 
		Id
	
	

GO

SET ANSI_NULLS, QUOTED_IDENTIFIER ON
GO
Create View [vwUnits]
 
as
	Select
		mt.[Guid],
		mt.[Code],
		mt.[Name],
		[Unity1] as [UnitName],
		1+0.00000000000 as [UnityFact],
		1 as [unitIndex]
	From
		[vbMat] [mt]

	union All

	Select
		mt.[Guid],
		mt.[Code],
		mt.[Name],
		[Unity2] as [Unit],
		[UnityFact2] as [UnityFact],
		2 as [unitIndex]
	From
		[vbMat] [mt]
	where
		[Unity2] <> ''
		and unityfix2 = 1

	union All

	Select
		mt.[Guid],
		mt.[Code],
		mt.[Name],
		[Unity3] as [Unit],
		[UnityFact3] as [UnityFact],
		3 as [unitIndex]
	From
		[vbMat] [mt]
	where
		[Unity3] <> ''
		and unityfix3 = 1

GO

SET ANSI_NULLS, QUOTED_IDENTIFIER ON
GO

Create Procedure [PrcTestFlatUsed2]
(
	@MotherFlatGuid uniqueidentifier = '773E9079-47D2-48E4-BF75-EB5EE596ACEC',
	@Date1 DateTime = '10/1/2007',
	@Date2 DateTime = '10/1/2009'
)
 
as
	Select
		[L].*,
		Case when [ContractFinish] = 0 then [ToDate] else [ContractFinishDate]  end as [EndDate]
	into #Contract
	From
		[LeaseApartment] [L]
		inner join [AccumulateFlat] [A] on [A].[FlatGuid] = [L].[ApartmentGuid]
	where 
		([A].[ParentGuid] = @MotherFlatGuid)		

		
	Select 
		[L].[Number],
		[T].[Name] as [ContractName],
		[L].[FromDate],
		[L].[ToDate],
		[L].[Leasekind],
		[L].[ApartmentGuid],
		[L].[Guid]
	From 
		#Contract [L] 
		inner join [ContractType] [T] On [T].[Guid] = [L].[TypeGuid]
		inner join [AccumulateFlat] [A] on [A].[FlatGuid] = [L].[ApartmentGuid]
	where 
		([A].[ParentGuid] = @MotherFlatGuid)		
		and 
		(
				(
					[Leasekind] = 2
					and	(
							([FromDate] <= @Date1 )
						 or ([FromDate] <= @Date2 )
						)
				)
				or 
				(
					[Leasekind] = 0
					and	([ContractFinish] = 0 )
				)

			)
			

GO

SET ANSI_NULLS, QUOTED_IDENTIFIER ON
GO
Create View [vwGetBillDetail]
 
as
	Select
		[d].[Number], 
		[d].[Guid], 
		[d].[ParentGuid], 
		[m].[Code]+'-'+[m].[Name] as [Mat],

		Case when [d].[ItemUnit] = 1 then [d].[Qty]
			 when [d].[ItemUnit] = 2 then [d].[Qty] / m.[UnityFact2]
			 when [d].[ItemUnit] = 3 then [d].[Qty] / m.[UnityFact3]
		end as [Qty],

		Case when [d].[ItemUnit] = 1 then [d].[Qty]
			 when [d].[ItemUnit] = 2 then [d].[Qty] / m.[UnityFact2]
			 when [d].[ItemUnit] = 3 then [d].[Qty] / m.[UnityFact3]
		end as [RQty],

		Case when [d].[ItemUnit] = 1 then [Unity1]
			 when [d].[ItemUnit] = 2 then [Unity2]
			 when [d].[ItemUnit] = 3 then [Unity3]
		end as [Unit],
		
		[d].[Qty2], 
		[d].[Qty2] as [RQty2], 
		m.[Unity2] as [Unit2],
		[d].[Qty3],
		[d].[Qty3] as [RQty3],
		m. [Unity3] as [Unit3],

		Case when [d].[ItemUnit] = 1 then [d].[Price]
			 when [d].[ItemUnit] = 2 then [d].[Price] * m.[UnityFact2]
			 when [d].[ItemUnit] = 3 then [d].[Price] * m.[UnityFact3]
		end as [Price],
		
		Case when [d].[ItemUnit] = 1 then [d].[Price]
			 when [d].[ItemUnit] = 2 then [d].[Price] * m.[UnityFact2]
			 when [d].[ItemUnit] = 3 then [d].[Price] * m.[UnityFact3]
		end as [RPrice],
				
		[d].[TotalPrice], 
		[d].[Bonus], 
		[d].[StoreGuid], 
		[s].[Code]+'-'+[s].[Name] as [Store], 
		[d].[DiscountPercent], 
		[d].[Discount], 
		[d].[ExtraPercent], 
		[d].[Extra], 
		[d].[Note], 
		[d].[ProductDate], 
		[d].[ExpireDate], 
		[o].[Code]+'-'+[o].[Name] as [Cost], 
		[d].[CostGuid], 
		[d].[Class], 
		[d].[Length], 
		[d].[width], 
		[d].[height], 
		[d].[Count], 
		[d].[ItemUnit],
		Case when [d].[ItemUnit] = 1 then 1
			 when [d].[ItemUnit] = 2 then [m].[UnityFact2]
			 when [d].[ItemUnit] = 3 then [m].[UnityFact3]
		end [DefUnityFact],
		[m].[UnityFact2],
		[m].[UnityFact3],
		[m].[unityfix2],		[m].[unityfix3],
		[d].[TotalPrice] as [RTotalPrice],
		[d].[DiscountPercent] as [RDiscountPercent],
		[d].[Discount] as [RDiscount],
		[d].[ExtraPercent] as [RExtraPercent],
		[d].[Extra] as [RExtra],
		[MatGuid]
	From
		[BillDetail] [d]
		inner join [vwMat] [m] on [d].[MatGuid] = [m].[Guid]
		inner join [Store] [s] on [d].[StoreGuid] = [s].[Guid]
		left join [Cost] [o] on [d].[CostGuid] = [o].[Guid]


GO

SET ANSI_NULLS, QUOTED_IDENTIFIER ON
GO
Create View [vwBillDiscount]
 
as

	Select
		[d].[Number], 
		[d].[Guid], 
		[d].[ParentGuid], 
		[d].[AccountGuid], 
		[a].[Code]+'-'+[a].[Name] as [Account], 
		[d].[Discount], 
		[d].[Extra], 
		[my].[Code] as [Currency], 
		[d].[CurrencyGuid], 
		[d].[CurrencyVal], 
		[Co].[Code]+'-'+[Co].[Name] as [Cost], 
		[d].[CostGuid], 
		[d].[obverseAccountGuid], 
		[o].[Code]+'-'+[o].[Name] as [obverseAccount], 
		[d].[Note]
	From
		[BillDiscount] [d]
		inner join [vwAccount] [a] on [a].[Guid] = [d].[AccountGuid]
		left join [vwAccount] [o] on [o].[Guid] = [d].[obverseAccountGuid]
		left join [vwCost] [Co] on [Co].[Guid] = [d].[CostGuid]
		left join [vwCurrency] [My] on [My].[Guid] = [d].[CurrencyGuid]


GO

SET ANSI_NULLS, QUOTED_IDENTIFIER ON
GO

Create Procedure [PrcPaperMonetaryOfServicesContract]
(
	@ContractGuid UniqueIdentifier = 0x0
)
 
as
	Set NoCount On
	
	Select 
		dbo.SC([P].[TypeName]) as [PaperKind],
		[P].[No],
		[LL].[Value],
		[P].[BankName],
		[P].[CurrencyCode],
		[P].[DueDate],
		Case 		
			when  [C3].[CheckGuid] is not null then dbo.SC('')

			when  ([C1].[CheckGuid] is not null) or 
				  ([C4].[CheckGuid] is Not Null ) and ([C4].[Value] >= [P].[Value])	 then dbo.SC('') 

			when ([C4].[CheckGuid] is Not Null ) and ([C4].[Value] < [P].[Value]) then dbo.SC(' ')

			when  [C].[CheckGuid] is not null then dbo.SC('') 
			when  [C2].[CheckGuid] is not null then dbo.SC('') 
		end as [State],
		[P].[Note3],
		[P].[Note],
		1 as [Print],
		[P].[Guid]
	From
		[vwChecks] [P]
		inner join [LinkCheckContract] LL on LL.ParentGuid = P.Guid
		left join vwServicesContract [L] on [L].[Guid] = [LL].[ContractGuid]
		left join [vwChecksCollection] [C] on [C].[CheckGuid] = [P].[Guid] and [C].[Kind] = 0
		left join [vwChecksCollection] [C1] on [C1].[CheckGuid] = [P].[Guid] and [C1].[Kind] = 1
		left join [vwChecksCollection] [C2] on [C2].[CheckGuid] = [P].[Guid] and [C2].[Kind] = 2
		left join [vwChecksCollection] [C3] on [C3].[CheckGuid] = [P].[Guid] and [C3].[Kind] = 3
		left join (
						Select 
							[CheckGuid],
							Sum([Value]) as [Value] 
						From
							[ChecksPartialCollection] 
						Group By
							[CheckGuid]
					) [C4] on [C4].[CheckGuid] = [P].[Guid]
 	where
 		(LL.[ContractGuid] = @ContractGuid or @ContractGuid = 0x0)
--		and [P].[Number] = 2905
 	Order By 
 		[P].[dueDate], [P].[No]

GO

SET ANSI_NULLS, QUOTED_IDENTIFIER ON
GO

Create Procedure [PrcGetFlatWallet]
(
	@Guid uniqueidentifier = '369CF34D-31AA-4381-BBCA-78E27197A9AA'
)
 
as
	Select 
		[B].[Name] as [Building],
		[F].[No]+'-'+[ApartmentType] as [Flat],
		[W].[MainCost],
		[Expense],
		[W].[BeginDate],
		[C].[SaleDate],
		DATEDIFF(Day,[W].[BeginDate], [C].[SaleDate]) as [DayCount],
		[C].[SaleValue] * Case when [Wl].[CurrencyGuid] <> [C].[CurrencyGuid] then [C].[CurrencyVal] / [Wl].[CurrencyVal] else 1 end as [SaleValue],
		[C].[SaleValue] * Case when [Wl].[CurrencyGuid] <> [C].[CurrencyGuid] then [C].[CurrencyVal] / [Wl].[CurrencyVal] else 1 end
		-
		( isnull([w].[Expense],0) + [W].[MainCost] )
		as  [Profit],
		[W].[BuildingGuid],
		[W].[FlatGuid]
	From 
		[wallet] [Wl]
		inner join [Flatwallet] [W] on [W].[ParentGuid] = [Wl].[Guid]
		inner join [vwBuilding] [B] on [B].[Guid] = [W].[BuildingGuid]
		inner join [vwApartment] [F] on [F].[Guid] = [w].[FlatGuid]
		left join (
					Select 
						[ApartmentGuid],
						[FromDate] as [SaleDate],
						([Rent]-[Discountvalue]) as [SaleValue],
						[CurrencyGuid],
						[CurrencyVal]
					From
						[vwLeaseApartment] 
					where 
						[LeaseKind] = 2
					) [C] on [C].[ApartmentGuid] = [W].[FlatGuid]
	where
		[W].[ParentGuid] = @Guid
	Order By
		[W].[Number]

GO

SET ANSI_NULLS, QUOTED_IDENTIFIER ON
GO

CREATE FUNCTION [dbo].[fnGetBranchParents](@StartGUID [UNIQUEIDENTIFIER]) 
	RETURNS @Result TABLE([GUID] [UNIQUEIDENTIFIER]) 
 
AS 
BEGIN 

	DECLARE @ParentGUID [UNIQUEIDENTIFIER] 
	SELECT @ParentGUID = [ParentGUID] FROM [Branch] WHERE [GUID] = @StartGUID 
	WHILE @@ROWCOUNT <> 0 
	BEGIN 
		IF EXISTS(SELECT * FROM @Result WHERE [GUID] = @ParentGUID) 
			BREAK 
		INSERT INTO @Result VALUES(@ParentGUID) 
		SELECT @ParentGUID = [ParentGUID] FROM [Account] WHERE [GUID] = @ParentGUID 
	END 
	RETURN 
END 

GO

SET ANSI_NULLS, QUOTED_IDENTIFIER ON
GO

Create Procedure [PrcPrintBill]
(
	@TypeGuid uniqueidentifier = '3110620A-998A-416C-B0E4-B667418BB433',
	@CustAccountGuid uniqueidentifier = 0x0,
	@NumToNum Bit = 1,
	@Number1 int = 1,
	@Number2 int = 10,
	@Date1 Datetime = '2014-01-1',
	@Date2 Datetime = '2014-10-12'
)
 
as
	Select
		Bu.Guid
	into #BuGuid
	From
		Bill Bu	
	where
 		([Bu].[TypeGuid] = @TypeGuid or @TypeGuid = 0x0)
 		and ([Bu].[CustAccGuid] = @CustAccountGuid or @CustAccountGuid = 0x0)
 		and ([Bu].[Date] Between @Date1 And @Date2)
 		and (([Bu].[Number] Between @Number1 and @Number2) or (@NumToNum = 0))
 		and (([Bu].[Number] Not In (Select [Number] From [BillNumber] where [Kind] = 0) ) or (@NumToNum = 0))
 		and (([Bu].[Number] In (Select [Number] From [BillNumber] where [Kind] = 1)) or ( @NumToNum = 1))
 		 	
	Select
		Bu.*, 
		D.*
	From
		vwBill Bu	
		inner join [vwGetBillDetail] D on D.ParentGuid = BuGuid
		inner join #BuGuid G on G.Guid = BuGuid
	Order By
		BtName, BuNumber, d.Number

	Select
		G.Guid ,
		D.*
	From
		[vwBillDiscount] D
		inner join #BuGuid G on G.Guid = d.parentGuid
	Order By
		d.Number
 		

GO

SET ANSI_NULLS, QUOTED_IDENTIFIER ON
GO

Create Procedure [PrcGetPartnerwallet]
(
	@Guid uniqueidentifier = '1C0AEB31-CBA2-4034-A35A-69D28552492D'
)
 
as
	Select 
		[C].[Name] as [Cust],
		[P].[Value],
		[P].[BeginDate],
		[P].[EndDate],
		[P].[CustGuid]
	From 
		[Partnerwallet] [P]
		inner join [vwCustomer] [C] on [C].[Guid] = [P].[CustGuid]
	where
		[P].[ParentGuid] = @Guid
	Order By
		[P].[Number]



GO

SET ANSI_NULLS, QUOTED_IDENTIFIER ON
GO

Create Function dbo.[FnGetCurrencyVal]
(
	@Guid uniqueidentifier = '0ACC7FE7-CA3C-475A-9F4D-DA2F6ECB16E9',
	@Date DateTime = '7/28/2008'
)
returns Float
 
begin
	
	Set @Date = ISNULL(@Date, GETDATE())
	
	declare @Rate Float
	Set @Rate = 0

	Select  Top 1
		@Rate = [Rate] 
	From 
		[ChangeCurrencyRate]
	where
		([CurrencyGuid] = @Guid)
		and ([Date] <= @Date)
	Order By
		[Date] desc, [Number] desc 

	if @Rate = 0 
	Select  Top 1
		@Rate = [Rate] 
	From 
		[ChangeCurrencyRate]
	where
		([CurrencyGuid] = @Guid)
	Order By
		[Date] , [Number] 
	

	if @Rate = 0 
	Select
		@Rate = [CurrencyVal] 
	From 
		[Currency]
	where
		([Guid] = @Guid)


	if @Rate = 0 
	Set @Rate = 1 
	return (@Rate)
end


GO

SET ANSI_NULLS, QUOTED_IDENTIFIER ON
GO
Create View [vwAllRealty]
 
as
	Select
		dbo.SC('') as [Kind],
		a.Name,
		co.Name as CostName,
		a.Guid,
		a.Guid as BuildingGuid,
		CostGuid
	From
		[vwBuilding] [a]
		inner join Cost co on co.Guid = a.costGuid
	union all
	Select
		dbo.SC('') as [Kind],
		BuildingName +'-'+ a.No + '-' +a.FlatKind,
		co.Name as CostName,
		a.Guid,
		a.BuildingGuid as BuildingGuid,
		CostGuid
	From
		[vwApartment] [a]
		inner join Cost co on co.Guid = a.costGuid

	union all
	Select
		dbo.SC('') as [Kind],
		BuildingName +'-'+ a.No + '-' +a.[Description],
		co.Name as CostName,
		a.Guid,
		a.BuildingGuid as BuildingGuid,
		CostGuid
	From
		[vwShop] [a]
		inner join Cost co on co.Guid = a.costGuid

	union all
	Select
		dbo.SC('') as [Kind],
		BuildingName +'-'+ a.No + '-' +a.[Description],
		co.Name as CostName,
		a.Guid,
		a.BuildingGuid as BuildingGuid,
		CostGuid
	From
		[vwParking] [a]
		inner join Cost co on co.Guid = a.costGuid

	union all
	Select
		dbo.SC('') as [Kind],
		a.EarthNo + '-' +a.[Name],
		co.Name as CostName,
		a.Guid,
		0x0 as BuildingGuid,
		CostGuid
	From
		[vwEarth] [a]
		inner join Cost co on co.Guid = a.costGuid

	union all
	Select
		dbo.SC('') as [Kind],
		a.[Name],
		co.Name as CostName,
		a.Guid,
		0x0 as BuildingGuid,
		CostGuid
	From
		[vwVilla] [a]
		inner join Cost co on co.Guid = a.costGuid

GO

SET ANSI_NULLS, QUOTED_IDENTIFIER ON
GO

Create Procedure [PrcDifferenceCurrencyRate]
(
	@AccountGuid uniqueidentifier = 'F84CEF6C-2C08-4F8C-8209-978F2FE032DB',
	@Date1 DateTime = '1/1/2008',
	@Date2 DateTime = '12/30/2008'
)
 
as
	Select * Into #fnGetAccountList From [dbo].[fnGetAccountList](@AccountGuid)
	
	Select
		[Ac].[Code]+'-'+[Ac].[Name] as [Account],
		[Ac].[Guid] as [AccountGuid],
		[Ac2].[CurrencyGuid] as [AccountCurrencyGuid],
		Sum([En].[Debit]*[En].[CurrencyVal]) as [Debit],
		Sum([En].[Credit]*[En].[CurrencyVal]) as [Credit],

		Sum(Isnull([En].[Debit]*[En].[CurrencyVal],0)) - Sum(Isnull([En].[Credit]*[En].[CurrencyVal],0)) as [Balance],

		--     
		Sum(case when ([En].[CurrencyGuid] = [Ac2].[CurrencyGuid] or isvisible = 1) then Isnull([En].[Debit],0) end)
--														/ (case when dbo.[FnGetCurrencyVal] ([ac2].[CurrencyGuid], [M].[Date]) = 1 then Null
--															  else dbo.[FnGetCurrencyVal] ([ac2].[CurrencyGuid], [M].[Date]) end 
--														)
			
		as [LDebit]
		,
		 Sum(case when ([En].[CurrencyGuid] = [Ac2].[CurrencyGuid] or isvisible = 1) then Isnull([En].[Credit],0) end)
--													/ (case when dbo.[FnGetCurrencyVal] ([ac2].[CurrencyGuid], [M].[Date]) = 1 then Null
--															  else dbo.[FnGetCurrencyVal] ([ac2].[CurrencyGuid], [M].[Date]) end 
--														)
		as [LCredit]
		
		,dbo.[FnGetCurrencyVal] ([My].[Guid], @Date2) as [CloseRate]
		into #Res
	From 
		[DEntry] [En]
		inner Join [vwEntry] [m] on [M].[Guid] = [En].[ParentGuid]
		inner Join [dbo].[#fnGetAccountList] [Ac] on [Ac].[Guid] = [En].[AcGuid]
		inner join [account] [ac2] on [ac2].[guid] = [ac].[Guid]
		inner join [vwCurrency] [my] on [My].[Guid] = [Ac2].[CurrencyGuid]
	where 
		([M].[Date] Between @Date1 and @Date2)
		
	Group By
		[Ac].[Code]+'-'+[Ac].[Name],
		[Ac].[Guid],
		[Ac2].[CurrencyGuid],
		dbo.[FnGetCurrencyVal] ([My].[Guid], @Date2)

	Select 
		*,
		([LDebit] - [LCredit]) as [LBalance],
		([LDebit] - [LCredit]) * [CloseRate] as [CloseBalance],
		[Balance] - (([LDebit] - [LCredit]) * [CloseRate]) as [DiffCurrency]
	from 
		#res

GO

SET ANSI_NULLS, QUOTED_IDENTIFIER ON
GO
Create Procedure [dbo].[PrcDoBackupJob] 
	@JobType [int] = 4, 
	@DBName [varchar](256) = 'mydata', 
	@DirName [varchar](1000) = 'D:\AQBackup', 
	@BkNum [INT] = 2
 
As 
	SET NOCOUNT ON 
	
	DECLARE @DateStr [varchar](20) 
	DECLARE @DayStr [varchar](8) 
	DECLARE @MonthStr [varchar](8) 
	DECLARE @FileName [varchar](1000) 
	if(Month( GetDate()) > 9) 
		SELECT @MonthStr = CAST( Month( GetDate()) AS [VARCHAR](5))  
	ELSE 
		SELECT @MonthStr = '0' + CAST( Month( GetDate()) AS [VARCHAR](5))  
	if(DAY( GetDate()) > 9) 
		SELECT @DayStr = CAST( DAY( GetDate()) AS [VARCHAR](5))  
	ELSE 
		SELECT @DayStr = '0' + CAST( DAY( GetDate()) AS [VARCHAR](5))  
	SELECT @DateStr =  CAST( YEAR( GetDate()) AS [VARCHAR](10)) + 
						  @MonthStr + @DayStr + 
						Cast(DatePart(hh, GetDate()) AS varchar(2)) + '' +
						Cast(DatePart(mi, GetDate()) AS varchar(2)) +
						Cast(DatePart(SS, GetDate()) AS varchar(2)) +
						'.bak'						  
	SELECT @FileName = 
		case @JobType 
			when 16 then @DirName + '\AqrBk_' + @DBName + '_' +  @DateStr 
			when 8  then @DirName + '\AqrBk_' + @DBName + '_' +  @DateStr 
			when 4  then @DirName + '\AqrBk_' + @DBName + '_' +  @DateStr 
		end 
		
				
	--if( EXISTS( SELECT * FROM 
	--	[msdb].[dbo].[BackupMediaFamily] as [bmf] 
	--	INNER JOIN 
	--	[msdb].[dbo].[BackupSet] as [bs] 
	--	on 
	--	[bs].[Media_Set_id] = [bmf].[Media_Set_id] 
	--	WHERE [bs].[database_name] = @DbName 
	--	AND [bmf].[physical_Device_name] = @FileName)) 
	--		RETURN 0 
	--		--Backup DataBase @DBName To Disk = @FileName 
	--			--with DIFFERENTIAL 
	--else 
		Backup DataBase @DBName To Disk = @FileName  WITH DESCRIPTION = '' ,COMPRESSION,init
		
		
	--EXEC [repDeleteExtraJobBackup] @JobType, @BkNum, @DBName 
	exec [PrcDeleteBackupFilesOver] @DbName , @DirName

GO

SET ANSI_NULLS, QUOTED_IDENTIFIER ON
GO
Create View [vwOfferPrice]
 
as
	Select
		* ,
		Case when OfferKind = 0 then dbo.SC('') 
		when OfferKind = 1 then dbo.SC('') 
		when OfferKind = 2 then dbo.SC('') 
		when OfferKind = 3 then dbo.SC('') 
		when OfferKind = 4 then dbo.SC('') 
		end as [OfferKindStr],
		
		(Select Name From vwBuilding where Guid = [BuildingGuid]) as [BuildingName],

		Case when OfferKind = 0 then (Select No From [vwApartment] where Guid = [RealtyGuid])
		when OfferKind = 1 then (Select No From vwshop where Guid = [RealtyGuid])
		when OfferKind = 2 then (Select No From vwParking where Guid = [RealtyGuid])
		when OfferKind = 3 then (Select Name From vwVilla where Guid = [RealtyGuid])
		when OfferKind = 4 then (Select Name From vwEarth where Guid = [RealtyGuid])
		end as [RealtyNo],
		(Select SUM(Value) from offerpricefee where ParentGuid = O.Guid) as [SumFee]
		
	From 
		[offerPrice] [O]


GO

SET ANSI_NULLS, QUOTED_IDENTIFIER ON
GO

Create Proc [PrcGetMatEqQty]
(
	@MatGuid uniqueidentifier = '313F5609-562C-4452-92FA-2FC37654BC08'
)
 
as
	Set NoCount on

	Declare @MtGroup uniqueidentifier
	Set @MtGroup = (Select GroupGuid From vwmat where [Guid]=@MatGuid)

	Declare @CalcQtyGuid uniqueidentifier
	Set @CalcQtyGuid = 0x0
	
	Select 
		@CalcQtyGuid = [A].[CalcQtyGuid] 
	from 
		[QtyGroup] [A]
		inner join (select Guid From [fnGetGroupParents] (@MtGroup) 
		union all
		Select @MtGroup
		) [G] On [A].[GroupGuid] = [G].[Guid]

	Select 
		[Guid] as [CalcQtyGuid],
		*
	From
		[CalcQty]
	where
		Guid = @CalcQtyGuid

GO

SET ANSI_NULLS, QUOTED_IDENTIFIER ON
GO
Create View [vwServicesContractCachPayment]
 
as
	Select
		[C].[ContractGuid],
		[H].[HNumber] as [Number],
		S.Number as [RecieptVoucherNumber],
		[H].[DNumber],
		[H].[HDate] as [Date],
		[H].[DCredit] as [Value],
		[H].[CurrencyGuid],
		[H].[CurrencyName] as [Currency],
		[H].[CurrencyVal],
		[H].[HNote],
		[H].[DNote],
		[h].AcGuid,
		(Select Number from Secondary_Entry where Guid = [C].[EntryGuid] ) as SNumber,
		1 as [Print],
		[H].[HGuid] as [Guid]
	from 
		[ServicesContractCachPayment] [C]
		inner join [vwDetailEntry] [H] on [H].[HGuid] = [C].[EntryGuid] 
		left join Secondary_Entry S on S.Guid = H.[HGuid]
		inner join ServicesContract L on L.CustAccountGuid = H.AcGuid and L.Guid = C.contractGuid
	where
		[H].[DCredit] <> 0


GO

SET ANSI_NULLS, QUOTED_IDENTIFIER ON
GO
Create View [vwGetTransDetail]
 
as
	Select
		[d].[Number], 
		[d].[Guid], 
		[d].[ParentGuid], 
		[m].[Code]+'-'+[m].[Name] as [Mat],

		Case when [d].[ItemUnit] = 1 then [d].[Qty]
			 when [d].[ItemUnit] = 2 then [d].[Qty] * m.[UnityFact2]
			 when [d].[ItemUnit] = 3 then [d].[Qty] * m.[UnityFact3]
		end as [Qty],

		Case when [d].[ItemUnit] = 1 then [d].[Qty]
			 when [d].[ItemUnit] = 2 then [d].[Qty] * m.[UnityFact2]
			 when [d].[ItemUnit] = 3 then [d].[Qty] * m.[UnityFact3]
		end as [RQty],

		Case when [d].[ItemUnit] = 1 then [Unity1]
			 when [d].[ItemUnit] = 2 then [Unity2]
			 when [d].[ItemUnit] = 3 then [Unity3]
		end as [Unit],
		
		[d].[Qty2], 
		[d].[Qty2] as [RQty2], 
		m.[Unity2] as [Unit2],
		[d].[Qty3],
		[d].[Qty3] as [RQty3],
		m. [Unity3] as [Unit3],

		Case when [d].[ItemUnit] = 1 then [d].[Price]
			 when [d].[ItemUnit] = 2 then [d].[Price] / m.[UnityFact2]
			 when [d].[ItemUnit] = 3 then [d].[Price] / m.[UnityFact3]
		end as [Price],
		Case when [d].[ItemUnit] = 1 then [d].[Price]
			 when [d].[ItemUnit] = 2 then [d].[Price] / m.[UnityFact2]
			 when [d].[ItemUnit] = 3 then [d].[Price] / m.[UnityFact3]
		end as [RPrice],
				
		[d].[TotalPrice], 
		[d].[Bonus], 

		[d].[DiscountPercent], 
		[d].[Discount], 
		[d].[ExtraPercent], 
		[d].[Extra], 
		[d].[Note], 
		[d].[ProductDate], 
		[d].[ExpireDate], 
		[o].[Code]+'-'+[o].[Name] as [Cost], 
		[d].[CostGuid], 
		[d].[Class], 
		[d].[Length], 
		[d].[width], 
		[d].[height], 
		[d].[Count], 
		[d].[ItemUnit],
		Case when [d].[ItemUnit] = 1 then 1
			 when [d].[ItemUnit] = 2 then [m].[UnityFact2]
			 when [d].[ItemUnit] = 3 then [m].[UnityFact3]
		end [DefUnityFact],
		[m].[UnityFact2],
		[m].[UnityFact3],
		[m].[unityfix2],		[m].[unityfix3],
		[d].[TotalPrice] as [RTotalPrice],
		[d].[DiscountPercent] as [RDiscountPercent],
		[d].[Discount] as [RDiscount],
		[d].[ExtraPercent] as [RExtraPercent],
		[d].[Extra] as [RExtra],
		[MatGuid]
	From
		[TransDetail] [d]
		inner join [vwMat] [m] on [d].[MatGuid] = [m].[Guid]
		left join [Cost] [o] on [d].[CostGuid] = [o].[Guid]


GO

SET ANSI_NULLS, QUOTED_IDENTIFIER ON
GO
Create View [vwEntry]
 
as
	Select 
			[Guid]
			,[Number]
			,[Date]
			,Case when (dbo.FnGetLangauge(@@spid) = 1) then 'Entry' else ' ' end as [Name]
			,1 as [Kind] 
			,[ParentKind]
			,[CurrencyGuid]
			,[CurrencyVal]
			,[Note]
			,0x0 as [AccountGuid]
			,[BranchGuid]
			,[IsPosted]
	From 
			[vbHEntry]


GO

SET ANSI_NULLS, QUOTED_IDENTIFIER ON
GO

Create Trigger [TRG_ChecksPartialCollection_Del]
on [ChecksPartialCollection]
 
For delete
As
	Delete [Hentry] From [HEntry] Inner join [Deleted] On [Deleted].[Guid] = [HEntry].[Guid]
	Delete [Secondary_Entry] From [Secondary_Entry] Inner join [Deleted] On [Deleted].[SecEntryGuid] = [Secondary_Entry].[Guid]
		

GO

SET ANSI_NULLS, QUOTED_IDENTIFIER ON
GO
Create View vwPricing
 
as
	Select
		A.*,
		b.Name as CustName
	From
		[vbPricing] [a]
		inner join vwCustomer [b] on [b].Guid = [a].[CustGuid]

GO

SET ANSI_NULLS, QUOTED_IDENTIFIER ON
GO

Create Procedure [PrcTestLandUsed]
(
	@LandGuid uniqueidentifier = 'FAC0771A-ABC6-4D88-BC6B-DA13C5110A91',
	@Date DateTime = '10/1/2008'
)
 
as
	Select 
		[L].[Number],
		[T].[Name] as [ContractName],
		[L].[FromDate],
		[L].[ToDate],
		[T].[ContractKind],
		[L].[Guid]
	From 
		[LandContract] [L] 
		inner join [ContractType] [T] On [T].[Guid] = [L].[TypeGuid]
	where 
		([LandGuid] = @LandGuid)
		and (
				(
					(
						([FromDate] <= @Date )
					)
				and ( [ContractKind] = 8 )
				)
				or 
				(
					(
					   (@Date between [FromDate] and [ToDate])
                     )
                	and ([ContractKind] = 6)
				)
			)
			

GO

SET ANSI_NULLS, QUOTED_IDENTIFIER ON
GO

Create Procedure [PrcTestRentLandFromAccumulateLand]
(
	@ContractGuid uniqueidentifier = 'EFAF9774-48B8-4680-BE63-6B3D9112271A',
	@LandGuid uniqueidentifier = '90DBB8C2-DFC0-4E6F-86FD-0D8ECEC5E607',
	@Date1 DateTime = '1/1/2010',
	@Date2 DateTime = '10/1/2010'
)
 
as
	Select
		[L].*,
		Case when [ContractFinish] = 0 then [ToDate] else [ContractFinishDate]  end as [EndDate]
	into #Contract
	From
		[LandContract] [L]
		inner join [AccumulateLand] [A] on [A].[ParentGuid] = [L].[LandGuid] 
	where 
		([A].[LandGuid] = @LandGuid)		
		and ([L].[Guid] <> @ContractGuid)

--	Select * from #Contract
		
	Select 
		[L].[Number],
		[T].[Name] as [ContractName],
		[L].[FromDate],
		[L].[ToDate],
		[T].[ContractKind],
		[L].[LandGuid],
		[L].[Guid]
	From 
		#Contract [L] 
		inner join [ContractType] [T] On [T].[Guid] = [L].[TypeGuid]
		inner join [AccumulateLand] [A] on [A].[ParentGuid] = [L].[LandGuid]
	where 
		([A].[LandGuid] = @LandGuid)		
		and 
		(
				(
					[ContractKind] = 8
					and	(
							([FromDate] <= @Date1 )
						 or ([FromDate] <= @Date2 )
						)
				)
				or 
				(
					[ContractKind] = 1
					and	(
							(
								  (@Date1 between [FromDate] and [EndDate])
								or(@Date2 between [FromDate] and [EndDate])
								or([FromDate] between @Date1 and @Date2)
								or([EndDate] between @Date1 and @Date2)
							)
						)
				)

			)
			

GO

SET ANSI_NULLS, QUOTED_IDENTIFIER ON
GO

Create Procedure [PrcChangeAccountMovment]
(
	@AcGuid1 uniqueidentifier = 0x0,
	@AcGuid2 uniqueidentifier = 0x0,
	@Date1 DateTime = '1/1/2007',
	@Date2 DateTime = '1/1/2010'
)
 
as
	Declare @RC int

	--------
	Update [Dentry] 
	Set [AcGuid] = @AcGuid2
	From 
		[Dentry]  [D]
		inner join [HEntry] [H] On [D].[ParentGuid] = [H].[Guid]
	where
		[AcGuid] = @AcGuid1
		and ([H].[Date] Between @Date1 And @Date2)

	Select @RC = isnull(@@RowCount,0)

	Update [Dentry] 
	Set [ObverseAcGuid] = @AcGuid2
	From 
		[Dentry]  [D]
		inner join [HEntry] [H] On [D].[ParentGuid] = [H].[Guid]
	where
		[ObverseAcGuid] = @AcGuid1
		and ([H].[Date] Between @Date1 And @Date2)

	--------
	Update [Secondary_Entry] Set [AccountGuid] = @AcGuid2
	where
		[AccountGuid] = @AcGuid1
		and ([Date] Between @Date1 And @Date2)

	Select @RC = @RC + isnull(@@RowCount,0)

	--------
	Update [Secondary_EntryDetail] 
	Set [AcGuid] = @AcGuid2
	From
		[Secondary_EntryDetail] [D]
		inner join [Secondary_Entry] [H] On [D].[ParentGuid] = [H].[Guid]
	where
		[AcGuid] = @AcGuid1
		and ([H].[Date] Between @Date1 And @Date2)

	Select @RC = @RC + isnull(@@RowCount,0)

	--------
	Update [Secondary_EntryDetail] 
	Set [ObverseAcGuid] = @AcGuid2
	From
		[Secondary_EntryDetail] [D]
		inner join [Secondary_Entry] [H] On [D].[ParentGuid] = [H].[Guid]
	where
		[ObverseAcGuid] = @AcGuid1
		and ([H].[Date] Between @Date1 And @Date2)

	Select @RC = @RC + isnull(@@RowCount,0)


	Select @RC as [Count]

GO

SET ANSI_NULLS, QUOTED_IDENTIFIER ON
GO

Create Trigger [TRG_LinkCheckEntryTypeDelete]
on [LinkEntrytype_Checks]
 
For delete
As
	Delete [Secondary_Entry] From [Secondary_Entry] Inner join [Deleted] On [Deleted].[EntryGuid] = [Secondary_Entry].[Guid]


GO

SET ANSI_NULLS, QUOTED_IDENTIFIER ON
GO

Create Procedure [dbo].[PrcInventoryDetailStore]
(
	@GroupGuid uniqueidentifier = 0x0,
	@MatGuid uniqueidentifier = 0x0,
	@StoreGuid uniqueidentifier = 0x0,
	@CostGuid uniqueidentifier = 0x0,
	@Class Varchar(256) = '',
	@ClassGrouping Bit = 0,
	@Unit int = 0,
	@BillPost int = 2,
	@CkDate Bit = 1,
	
	@PriceMode int = 0,
	@SpecificPrice int = 0,
	
	@ShowEmpltyMat Bit= 1,
	@ShowDetailStore Bit= 1,
	@ShowMatTypeStore Bit= 1,
	@ShowMatTypeService Bit= 1,
	
	@Date1 DateTime = '1/1/2007',
	@Date2 DateTime = '1/1/2015'
)
 
as
	Declare @DefCurrency uniqueidentifier
	Set @DefCurrency = (Select Value From DMD_Const where VName = 'DefCurrency')
	
	CREATE TABLE #MatInvDetailStore
	(
		[MatCode] [varchar](256),
		[MatName] [varchar](256),
		[MatltnName] [varchar](256),
		[GroupName] [varchar](513),
		[StCode] [varchar](256),
		[StName] [varchar](256),
		[Qty] [float],
		[Unit] [varchar](256),
		[Qty2] [float],
		[Unity2] [varchar](256),
		[Qty3] [float],
		[Unity3] [varchar](256),
		[Price] [float],
		[TotalPrice] [float],
		[Class] [varchar](256),
		[MatGuid] [uniqueidentifier],
		[StoreGuid] [uniqueidentifier],
		[Kind] int
	)

	Insert into #MatInvDetailStore
	Exec [dbo].[PrcMatInventory] 								 @GroupGuid, @MatGuid , @StoreGuid, @CostGuid, @Class, @ClassGrouping, 								 @Unit, @BillPost, @CkDate, @PriceMode, @SpecificPrice, @DefCurrency, 1,				 								 @ShowEmpltyMat, @ShowDetailStore, @ShowMatTypeStore, @ShowMatTypeService, 								 @Date1, @Date2, 3--	return	if exists(Select * from SysObjects where name = 'ResTblValue' and Xtype = 'U')
	Drop Table dbo.ResTblValue
	
	Create Table dbo.ResTblValue	(		[ ] varchar(256),		[] varchar(256)	)		EXECUTE CrossTabToTable 'Select [MatCode]+''-''+[MatName] as [],[unit] as [],[Price] as [],Sum([TotalPrice]) as [ ],''{''+Cast(MatGuid as Varchar(256))+''}'' as MatGuid from #MatInvDetailStore Group By [MatCode]+''-''+[MatName] ,[unit],[Price],''{''+Cast(MatGuid as Varchar(256))+''}''', 'Sum([Qty])', '[StName]' , '[#MatInvDetailStore]', ' ',''','''','''','''',''0x0'
		Declare @T Float	Set @T = (Select Sum([ ]) From ResTblValue)		Update ResTblValue Set [ ] = @T where [] = ''
	
	Select * from ResTblValue	

GO

SET ANSI_NULLS, QUOTED_IDENTIFIER ON
GO

Create View [vwMovingAccount] 
 
as
	Select
		[Ac].*
	From 
		[vwAccount] [Ac]
	where
		NSons = 0
		and ([Ac].[Type] = 0 or [Ac].[Type] = 3)
		--inner join [MovingAccount] [Ac2] on [Ac2].[AccountGuid]  = [Ac].[Guid]

GO

SET ANSI_NULLS, QUOTED_IDENTIFIER ON
GO

Create Trigger [TRG_MaintenanceContract_Del]
on [MaintenanceContract]
 
For delete
As
	Delete [Hentry] From [HEntry] Inner join [Deleted] On [Deleted].[Guid] = [HEntry].[Guid]

	Delete [Checks] From [Checks] inner join [Deleted] On [Deleted].[Guid] = [Checks].[ContractGuid]

	Delete [Hentry] 
	From 
		[HEntry] [H]
		Inner join [LinkCe] [L] on [L].[CeGuid] = [H].[Guid]
		Inner join [Deleted] On [Deleted].[Guid] = [L].[Guid]
		
	Delete [Secondary_Entry] 
	From 
		[Secondary_Entry] [H]
		Inner join [Deleted] On [Deleted].[Guid] = [H].[ContractGuid]
		
	Delete [Trace] From [Trace] inner join [Deleted] On [Deleted].[Guid] = [Trace].[ParentGuid]
	
		

GO

SET ANSI_NULLS, QUOTED_IDENTIFIER ON
GO

Create Procedure [PrcTestRentedParking]
(
	@CardGuid uniqueidentifier = '2AC942CE-CCAF-4871-B2AB-A044564D8EF9',
	@ParkingGuid uniqueidentifier = '3AFE1F3B-44F3-49F1-9850-7A2A6A7CBF93',
	@FromDate DateTime = '2011-06-01 00:00:00',
	@ToDate DateTime = '2012-02-15 00:00:00'
)
 
as
	Select
		FromDate, ToDate, [ContractFinishDate],
		*
	from
		[ParkingContract]
	where
		([ParkingGuid] =@ParkingGuid)
		and (
				(
					--[ContractFinish] = 0
					--and
					(
						   (@FromDate between [FromDate] and (Case when [ContractFinish] = 0 then [ToDate] else [ContractFinishDate] end))
						or(
							[FromDate] between @FromDate and @ToDate
						   )
						or(
							 @ToDate between [FromDate] and (Case when [ContractFinish] = 0 then [ToDate] else [ContractFinishDate] end)
						   )
						or(
							 @ToDate between [FromDate] and (Case when [ContractFinish] = 0 then [ToDate] else [ContractFinishDate] end)
						   )
						--or(
						--	(@FromDate < [ContractFinishDate] and [ContractFinish] = 1)
						--   )
						or((Case when [ContractFinish] = 0 then [ToDate] else [ContractFinishDate] end) between @FromDate and @ToDate)
				   )
				)
		   )
		and ([ContractKind] = 4)
	   and [Guid] <> @CardGuid


GO

SET ANSI_NULLS, QUOTED_IDENTIFIER ON
GO
Create Procedure dbo.[PrcGetOldBalanceSecEntry]
(
	@Date Datetime = '2012-07-09 00:00:00' ,
	@Guid uniqueidentifier = 0x0,
	@AccountGuid uniqueidentifier = 0x0
)
 
as
	--	Set @AccountGuid = (Select Guid From Account where Code  = '131001')
	Select
		Isnull(Sum([en].[Credit]*[en].[CurrencyVal]) ,0)
	   - Isnull(Sum([en].[Debit]*[en].[CurrencyVal]) ,0) as [Balance]
	from
		[DEntry] [en]
		inner Join 	[HEntry] as [M] on [M].[Guid] = [En].[ParentGuid]
	where
		[M].[Date] <=@Date
		and [M].[Guid] <>@Guid
		and [en].[AcGuid] = @AccountGuid


GO

SET ANSI_NULLS, QUOTED_IDENTIFIER ON
GO

Create Procedure [PrcReCreateContractFlatShopEntry]
(
	@Date1 DateTime = 0,
	@Date2 DateTime = 0,
	@ActiveDate bit = 0,
	@Datewith int = 0,
	@Num1 int = 0,
	@Num2 int = 0,
	@ActiveNum bit = 0,
	@MaxDate int = 0
)
 
as
	Set noCount on

	--Update [Resource] set spid = @@spid
	 
	exec PrcSetProgrss '', 100, 0
	
	Declare @Guid uniqueidentifier,
			@CreateEntry Bit
	Declare @RowCount int

	Declare @AllCount int	
	Select 
		L.[Guid],
		Case when T.[CreateEntry]  = 1 and L.CreateContractEntry = 1 then 1 else 0 end as [CreateEntry]
		into #TmpContract
	From 
		[LeaseApartment] L
		inner join [ContractType] T on T.Guid = L.TypeGuid
		inner join [Resource] R on R.Guid = L.TypeGuid and R.Spid = @@SPID
	where
		(ISNULL(IsRounded, 0) = 0)
		and ((L.number between @num1 and @Num2) or @ActiveNum = 0)
		and (
			(
				([L].[FromDate] between @Date1 and @Date2 and @Datewith = 0)
			)
			or
			(
				([L].[ToDate] between @Date1 and @Date2 and @Datewith = 1)
			)

			or
			(
				([L].[ContractFinishDate] between @Date1 and @Date2 and @Datewith = 2)
				and ([L].[ContractFinish] = 1)
			)

			or
			(
				([L].[EditDate] between @Date1 and @Date2 and @Datewith = 3)
			)
			or
			(
				([L].[AcquittancePrintdate] between @Date1 and @Date2 and @Datewith = 4)
			)

			or
			(
				([L].LeaveDate between @Date1 and @Date2 and @Datewith = 5)
			)
			or @ActiveDate = 0
		) 
		
	Set @AllCount = @@ROWCOUNT 
	
	Declare @Msg varchar(255)
	Set @Msg = dbo.SC('    ') +' '+'0 / '+Cast(@AllCount as Varchar(25))
	exec PrcSetProgrss @Msg, @AllCount, 0
	--Select * from #TmpContract
	
	Declare @Counter int
	Set @Counter = 0
	DECLARE cursor_Name CURSOR FAST_FORWARD FOR 
	Select * from #TmpContract
	Set @RowCount = 0
	
	OPEN cursor_Name
	FETCH NEXT FROM cursor_Name INTO @Guid, @CreateEntry
	
	WHILE @@FETCH_STATUS = 0
	BEGIN
		Set @Counter = @Counter + 1
		Set @Msg = dbo.SC('    ') +' '+Cast(@Counter as Varchar(25)) +' / '+Cast(@AllCount as Varchar(25))
		exec PrcSetProgrss @Msg, @AllCount, @Counter

		if @CreateEntry = 1
		begin
			
			exec [PrcCreateContractFlatShopEntry] @Guid, @MaxDate
			Set @RowCount = @RowCount + 1			
		end
		else
		begin
			Delete HEntry where Guid = @Guid 
			Set @RowCount = @RowCount + 1
		end
		
	  FETCH NEXT FROM cursor_Name INTO @Guid, @CreateEntry
	
	END
	
	CLOSE cursor_Name
	DEALLOCATE cursor_Name

	Set @Msg = dbo.SC('')
	exec PrcSetProgrss @Msg, 0, 0
		
	if dbo.fnInRoundProcess() = 0
	Select @RowCount as [RowCount]
		

GO

SET ANSI_NULLS, QUOTED_IDENTIFIER ON
GO

Create Procedure [dbo].[PrcSMSEntryDate]
(
	@Guid uniqueidentifier = 0x0
)
 
as
	Select 
		S.[date],
		S.[Number],
		(Select SUM(Debit) From EntryDateDetail where ParentGuid = @Guid) as [Debit],
		(Select SUM(Credit) From EntryDateDetail where ParentGuid = @Guid) as [Credit],
		S.[Note],
		D.Note  as [ItemNote],
		Ac.Name as Account,
		Aci.Name as AccountItem,
		Cu.Mobile as CustMobile
	From 
		EntryDate S
		inner join Account Ac on Ac.Guid = S.AccountGuid
		inner join (
					Select	Top 1
						*
					From
						EntryDateDetail
					where
						ParentGuid = @Guid	
					) D on D.ParentGuid = S.Guid
		inner join Account Aci on Aci.Guid = D.AcGuid
		inner join Customer Cu on Cu.AcGuid = Aci.Guid
	where
		S.Guid = @Guid

GO

SET ANSI_NULLS, QUOTED_IDENTIFIER ON
GO

Create Procedure [PrcReCreateContractLandVillaEntry]
(
	@Date1 DateTime = '3/1/2011',
	@Date2 DateTime = '3/1/2012',
	@ActiveDate bit = 0,
	@Datewith int = 0,
	@Num1 int = 4600,
	@Num2 int = 4614,
	@ActiveNum bit = 1,
	@MaxDate int = 42644
)
 
as
	Set noCount on 
	Declare @Guid uniqueidentifier,
			@CreateEntry Bit
	Declare @RowCount int
	
	Select 
		L.[Guid],
		Case when T.[CreateEntry]  = 1 and L.CreateContractEntry = 1 then 1 else 0 end as [CreateEntry]
		into #TmpContract
	From 
		[LandContract] L
		inner join [ContractType] T on T.Guid = L.TypeGuid
		inner join [Resource] R on R.Guid = L.TypeGuid and R.Spid = @@SPID
	where
		(ISNull(IsRounded,0) = 0)
		and ((L.number between @num1 and @Num2) or @ActiveNum = 0)
		and (
			(
				([L].[FromDate] between @Date1 and @Date2 and @Datewith = 0)
			)
			or
			(
				([L].[ToDate] between @Date1 and @Date2 and @Datewith = 1)
			)

			or
			(
				([L].[ContractFinishDate] between @Date1 and @Date2 and @Datewith = 2)
				and ([L].[ContractFinish] = 1)
			)

			or
			(
				([L].[EditDate] between @Date1 and @Date2 and @Datewith = 3)
			)
			or
			(
				([L].[AcquittancePrintdate] between @Date1 and @Date2 and @Datewith = 4)
			)

			or
			(
				([L].LeaveDate between @Date1 and @Date2 and @Datewith = 5)
			)
			or @ActiveDate = 0
		) 
		
	--Select * from #TmpContract
	
	DECLARE cursor_Name CURSOR FAST_FORWARD FOR 
	Select * from #TmpContract
	Set @RowCount = 0
	
	OPEN cursor_Name
	FETCH NEXT FROM cursor_Name INTO @Guid, @CreateEntry
	
	WHILE @@FETCH_STATUS = 0
	BEGIN
		if @CreateEntry = 1
		begin
			exec [PrcCreateContractLandVillEntry] @Guid, @MaxDate
			Set @RowCount = @RowCount + 1			
		end
		else
		begin
			Delete HEntry where Guid = @Guid 
			Set @RowCount = @RowCount + 1
		end
		
	  FETCH NEXT FROM cursor_Name INTO @Guid, @CreateEntry
	
	END
	
	CLOSE cursor_Name
	DEALLOCATE cursor_Name

	if dbo.fnInRoundProcess() = 0
	Select @RowCount as [RowCount]
		

GO

SET ANSI_NULLS, QUOTED_IDENTIFIER ON
GO

Create View dbo.[vwAssets]
 
as

	Select
		[A].[Name] as [ArName],
		Case when (dbo.FnGetLangauge(@@spid) = 1) and (Isnull([A].[LtnName],'') <> '') then [A].[LtnName] else [A].[Name] end as [Name], 
		A.[Number],A.[Guid],A.[SecLvl],A.[AssetsGroupGuid],
		A.[Code],A.[LtnName],A.[Barcode],A.[IsActive],A.[Note],
		A.[CurrencyGUID],A.[CurrencyVal],A.[AssetsAreaGuid],A.[State],
		A.[Importer],A.[EnterAccountGuid],
		A.[EnterValue],A.[EnterDate],
		A.[Origin],A.[Company],A.[EnterNote],
		A.[AsstesAccountGuid],A.[ExpenseAccountGuid],
		A.[DepreciationAccountGuid],A.[DepreciationTotalAccountGuid],
		A.[ProfitAccountGuid],A.[lossesAccountGuid],
		A.[EvaluationAccountGuid],A.[Shipping],
		A.[ShippingNo],[ShippingDate],A.[ArriveDate],
		A.[ArrivePlace],A.[ImportPermit],A.[CustomsNote],
		A.[CustomsDate],A.[CustomsExpense],A.[ShippingNote],
		A.[MaintenanceContract],A.[MaintenanceBeginDate],A.[MaintenanceEndDate],
		A.[Guaranty],A.[GuarantyBeginDate],A.[GuarantyEndDate],A.[DepreciationMode],
		A.IsDepreciationMonthly,
		Case when A.IsDepreciationMonthly = 0 then dbo.SC('')	else dbo.SC('') end as [DepreciationKind],
		A.[DepreciationBeginDate],A.[Age],A.[DepreciationAvg],
		A.[ScrapValue],A.[OldYearExtra],A.[OldYearDecrease],A.[OldYearDepreciation],
		A.[OldYearMaintenance],A.[IsSale],A.[SaleDate],A.[SaleCustomer],
		A.[SalesAccountGuid],A.[SaleValue],A.[CurrencySaleGUID],A.[CurrencySaleVal],
		A.[SaleNote],A.[CurrentAssetsAreaGuid],
		R.Name as CurrentArea,
		G.Name as [AssetsGroup]
	From
		[Assets] A
		inner join [vwAssetsArea] R on R.Guid = A.CurrentAssetsAreaGuid
		inner join [vwAssetsGroup] G on G.Guid = A.AssetsGroupGuid

GO

SET ANSI_NULLS, QUOTED_IDENTIFIER ON
GO
Create Procedure [PrcCreateViewvb]
(
	@TableName Varchar(256) = 'Realty_Users'
)
 
as
	Declare @S varchar(800)
	Set @S = 'vb'+@TableName
	exec DropObject @S

	Set @S = 'exec PrcCreateIndex '''+@TableName+''' , ''Seclvl'', 0'
	Print @S
	Exec (@S)


	Set @S = '
	Create View [vb'+@TableName+']
	 
	as
		Select 
			[T].*
		From
			['+@TableName+'] [T]
			inner join [CurrentUsers] [U] on ([u].[Seclvl] >= Isnull([T].[SecLvl],0)  or [u].[Admin] = 1) and [u].[spid] = @@Spid
'
	Print @S
	
	Exec (@S)
	

GO

SET ANSI_NULLS, QUOTED_IDENTIFIER ON
GO

Create Procedure [dbo].[PrcMarkCashFromLandContract]
(
	@Guid uniqueidentifier = 0x0,
	@Mark bit = 1
)
 
as
	update
		Secondary_Entry 
	Set
		Mark = @Mark
	from
		Secondary_Entry S
		left join [LandContractCachPayment] C on C.EntryGuid = S.Guid
	where
		[S].[ContractGuid] = @Guid 
		
	update
		HEntry
	Set
		Mark = @Mark
	from
		HEntry H
		inner join Secondary_Entry S on H.Guid = S.Guid
		left join [LandContractCachPayment] C on C.EntryGuid = S.Guid
	where
		[S].[ContractGuid] = @Guid 
	
		

GO

SET ANSI_NULLS, QUOTED_IDENTIFIER ON
GO

Create Procedure [dbo].[PrcGetOldAssetsArea]
(
	@AssetsGuid uniqueidentifier = 0x0,
	@Date DateTime = '1/1/2013'
)
 
as
	Declare @CurrentArea uniqueidentifier
	Select Top 1
		@CurrentArea = [AreaGuid]
	From 
		[AssetsChangeArea]
	where
		([AssetsGuid] = @AssetsGuid)
		and DATE <= @Date
	Order By
		Date Desc, Number desc
		
	if ISNULL(@CurrentArea, 0x0) = 0x0
	Set @CurrentArea = (Select AssetsAreaGuid From Assets)
	
	Select @CurrentArea as [CurrentArea]

GO

SET ANSI_NULLS, QUOTED_IDENTIFIER ON
GO

Create Procedure [PrcRealtyRestrained]
(
	@RealtyKind int = 5,
	@CustomerGuid uniqueidentifier = 0x0,
	@RealtyNo Varchar(256) = '',
	@CbRestrained Int = 0,
	@CkDate Bit = 1,
	@Date1 DateTime = '1/1/2007',
	@Date2 DateTime = '1/1/2020',
	@Days int = 0
)
 
as
	Select 
		Case when [RealtyType] = 0 or [RealtyType] = 1 or [RealtyType] = 2 then [B].[Name] 
			 when [RealtyType] = 3 then dbo.SC('')
			 when [RealtyType] = 4 then dbo.SC('')
		end as [BuildingName],
		Case 
			when [RealtyType] = 0 then dbo.sc('')
			when [RealtyType] = 1 then dbo.sc('')
			when [RealtyType] = 2 then dbo.sc('')	
			when [RealtyType] = 3 then dbo.SC('')
			when [RealtyType] = 4 then dbo.SC('')
		end as [StREaltyType],
		Case 
			when [RealtyType] = 0 then (Select [No] From [Apartment] where [Guid] = [R].[FlatGuid])
			when [RealtyType] = 1 then (Select [No] From [Shop] where [Guid] = [R].[Shop])
			when [RealtyType] = 2 then (Select [No] From [Parking] where [Guid] = [R].[ParkingNo])
			when [RealtyType] = 3 then (Select [VillaNo] From [Villa] where [Guid] = [R].[VillaGuid])
			when [RealtyType] = 4 then (Select [EarthNo] From [Earth] where [Guid] = [R].[LandGuid])
		end as [Realty],	
		[Cu].[Name] as [CustomerName], 
		[Cu].[Nationality], 
		[Cu].[PhoneJob], 
		[Cu].[Mobile], 
		[Date],
		Case when [EndDateSpecific] = 1 then [EndDate] end As [EndDate],
		[EndDateSpecific],
		[RestrainedCanceld],
		[R].[Note],
	    [R].[Pay],
    	[R].[PayValue],
	    Case 
			when [R].[PayType] = 0 then dbo.sc('')
			when [R].[PayType] = 1 then dbo.sc('')
		end as [PayType],

		Case when [RestrainedCanceld] = 0 and [EndDateSpecific] = 1	then  DateDiff(Day, GetDate(), [EndDate]) end as [Days],
		[R].[Guid] 
	From 
		[RealtyRestrained] [R]
		left join [vwBuilding] [B] On [B].[Guid] = [R].[BuildingGuid]
		inner join [vwCustomer] [Cu] on [Cu].[Guid] = [R].[CustomerGuid]
		left join [Resource] [S] On [S].[Guid] = [B].[Guid] and [S].[spid] = @@Spid and [Kind] = 4002
  	where
  		([R].[CustomerGuid] = @CustomerGuid or @CustomerGuid = 0x0)
  		and ([R].[RealtyType] =  @RealtyKind or @RealtyKind = 5)
  		and (
  				Case 
  				when [RealtyType] = 0 then (Select [No] From [Apartment] where [Guid] = [R].[FlatGuid])
  				when [RealtyType] = 1 then (Select [No] From [Shop] where [Guid] = [R].[Shop])
  				when [RealtyType] = 2 then (Select [No] From [Parking] where [Guid] = [R].[ParkingNo])
  				when [RealtyType] = 3 then (Select [VillaNo] From [Villa] where [Guid] = [R].[VillaGuid])
  				when [RealtyType] = 4 then (Select [EarthNo] From [Earth] where [Guid] = [R].[LandGuid])
  
  				end = @RealtyNo
  				or @RealtyNo = ''
  			)
  		and ( 
  				([RestrainedCanceld] = 0 and @CbRestrained = 1)
  				or ([RestrainedCanceld] = 1 and @CbRestrained = 2)
  				or @CbRestrained = 0
  			)
 		and ([R].[Date] Between @Date1 And @Date2 or @CkDate = 0)
 		and ([S].[Guid] is Not Null or @RealtyKind = 3 or @RealtyKind = 4 or @RealtyKind = 5)	
		and (
				[RestrainedCanceld] = 0 
				and [EndDateSpecific] = 1
				and ( DateDiff(Day, GetDate(), [EndDate]) < @Days)
				or @Days = 0
			)
		

GO

SET ANSI_NULLS, QUOTED_IDENTIFIER ON
GO

	Create View [vbTblShortCut]
	 
	as
		Select 
			[T].*
		From
			[TblShortCut] [T]
			inner join [CurrentUsers] [U] on ([u].[Seclvl] >= Isnull([T].[SecLvl],0)  or [u].[Admin] = 1) and [u].[spid] = @@Spid
GO

SET ANSI_NULLS, QUOTED_IDENTIFIER ON
GO

Create Procedure [dbo].[PrcExportRepFlatRentcsv]
 
as
	Delete [Resource] where [Spid]=@@spid
	
	Insert Into [Resource]
	([Guid])
	Select 
		Guid 
	from 
		Building
	where
		Number in (1, 2)
	
	Exec [RepFlatRent]
	@CustGuid  = 0x0
	,@Nationality  = ''
	,@FlatNo  = ''
	,@Emirate  = ''
	,@Suburb  = ''
	,@Area  = ''
	,@Street = ''
	,@FlatKind  = ''
	,@Class  = ''
	,@ApartmentType  = ''
	,@FlatArea1  = 0
	,@FlatArea2 = 0
	,@Unity  = ''
	,@RentState = 2
	,@ContractState = 2
	,@Datewith = 0
	,@Date1 = '2009-7-1'
	,@Date2 = '2022-1-2'
	,@RentInfoGuid = 0x0
	,@SalesManGuid = 0x0
	,@ShowFlat  = 1
	,@ShowShop = 1
	,@ShowIsCheck = 1
	,@ShowIsNotCheck = 1
	,@ShowAccumulate = 1
	,@ShowAccumulateEndContract = 1
	,@Rent1  = 0
	,@Rent2 = 0
	,@CheckDate = 0

	,@ActiveNote  = 0
	,@OperationNote = 0
	,@RealtyNote   = '' 
	,@ContractActiveNote = 0
	,@ContractOpNote = 0
	,@ContractNote  = '' 
	,@Judicial = 2
	,@ExportCSV = 1	
	,@BanRealty = 2

	exec [PrcExportTableCSV] 'RepFlatRentcsv', 'D:\RepFlatRentcsv.csv'	

GO

SET ANSI_NULLS, QUOTED_IDENTIFIER ON
GO

Create Procedure [dbo].[PrcGetAssetsSummeryOperation]
(
	@AssetsGuid uniqueidentifier = 'F8453488-FA93-4D8A-A581-5A63BB953A08'
)
 
as
	Select 
		S.Guid,
		SUM(
			Case when A.Flag = 1 then 
				A.Value *
				Case when [A].[CurrencyGuid] = S.CurrencyGuid then 1 
				else [A].[CurrencyVal] / S.CurrencyVal end
			end
			) As Addition,
		SUM(
			Case when A.Flag = 2 then 
				A.Value *
				Case when [A].[CurrencyGuid] = S.CurrencyGuid then 1 
				else [A].[CurrencyVal] / S.CurrencyVal end
			end
			) as Decrease,
		SUM(
			Case when A.Flag = 3 then 
				A.Value *
				Case when [A].[CurrencyGuid] = S.CurrencyGuid then 1 
				else [A].[CurrencyVal] / S.CurrencyVal end
			end
			) as [Maintenance]
	From 
		[AssetsOperation] A
		inner join [vwAssets] S on S.Guid = A.AssetsGuid
	where
		(S.Guid = @AssetsGuid or @AssetsGuid = 0x0)
	Group By
		S.Guid
	

GO

SET ANSI_NULLS, QUOTED_IDENTIFIER ON
GO

Create Procedure [PrcTestParkingRestrained]
(
	@ParkingGuid uniqueidentifier = '0711A702-62FF-4913-B00F-8084D8E2DF6D',
	@FromDate DateTime = '2009-9-1',
	@ToDate DateTime = '2009-9-30',
	@CardGuid uniqueidentifier = 0x0
)
 
as
	
	Select
		*
	from
		[RealtyRestrained]
	where
		
		([ParkingNo] =@ParkingGuid)
		and ([RealtyType] = 2)
		and ([RestrainedCanceld] = 0)
		and (
			   (@FromDate between [Date] and [EndDate])
			or
				(@ToDate between [Date] and [EndDate])
			or
				(@ToDate between [Date] and [EndDate] )
			or
				([Date] between @FromDate and @ToDate)
			or
				([EndDate] between @FromDate and @ToDate)
			)
		and [Guid] <> @CardGuid

GO

SET ANSI_NULLS, QUOTED_IDENTIFIER ON
GO

	Create View [vbCurrency]
	 
	as
		Select 
			[T].*
		From
			[Currency] [T]
			inner join [CurrentUsers] [U] on ([u].[Seclvl] >= Isnull([T].[SecLvl],0)  or [u].[Admin] = 1) and [u].[spid] = @@Spid
GO

SET ANSI_NULLS, QUOTED_IDENTIFIER ON
GO
Create View vwCustBuilding
 
as
	Select Distinct
		Cu.Barcode,
		Cu.Name,
		Cu.Mobile,
		Cu.Nationality,
		Cu.Guid,
		[L].BuildingGuid
	From
		Customer Cu
		inner join [LeaseApartment] [L] on [Cu].Guid = [L].CustomerGuid
		inner join Building [b] on [b].Guid = [L].BuildingGuid

GO

SET ANSI_NULLS, QUOTED_IDENTIFIER ON
GO

Create Procedure [dbo].[PrcAssetsChangeArea]
(
	@AssetsGruopGuid uniqueidentifier = 0x0,
	@AssetsGuid uniqueidentifier = 0x0,
	@CurrentAreaGuid uniqueidentifier = 0x0,
	@FromAreaGuid uniqueidentifier = 0x0,
	@ToAreaGuid uniqueidentifier = 0x0,
	@Date1 DateTime = '1/1/2007',
	@Date2 DateTime = '1/1/2014'
)  as

	Select 
		A.Date,
		A.Number,
		S.Code,
		S.name,
		s.ltnName,
		S.[AssetsGroup],
		S.CurrentArea,
		F.Name as FromArea,
		T.Name as ToArea,
		A.Note,
		A.Guid,
		S.Guid as AssetsGuid
	From 
		[AssetsChangeArea] A
		inner join [vwAssets] S on S.Guid = A.AssetsGuid
		inner join [AssetsArea] F on F.Guid = A.[CurrentAreaGuid]
		inner join [AssetsArea] T on T.Guid = A.[AreaGuid]
	where
		 (S.[AssetsGroupGuid] = @AssetsGruopGuid or @AssetsGruopGuid = 0x0)
		and (A.Guid = @AssetsGuid or @AssetsGuid = 0x0)
		and (S.CurrentAssetsAreaGuid = @CurrentAreaGuid or @CurrentAreaGuid = 0x0)
		and (A.Date between @Date1 and @Date2)
	

GO

SET ANSI_NULLS, QUOTED_IDENTIFIER ON
GO

Create Procedure [PrcTestFlatRestrained]
(
	@FlatGuid uniqueidentifier = '0711A702-62FF-4913-B00F-8084D8E2DF6D',
	@FromDate DateTime = '2009-9-1',
	@ToDate DateTime = '2009-9-30',
	@CardGuid uniqueidentifier = 0x0,
	@RealtyType int = 0
)
 
as
	
	Select
		*
	from
		[RealtyRestrained]
	where
		
		([FlatGuid] =@FlatGuid or @RealtyType = 1)
		and ([Shop] =@FlatGuid or @RealtyType = 0)
		and ([RealtyType] = @RealtyType)
		and ([RestrainedCanceld] = 0)
		and (
			   (@FromDate between [Date] and [EndDate])
			or
				(@ToDate between [Date] and [EndDate])
			or
				(@ToDate between [Date] and [EndDate] )
			or
				([Date] between @FromDate and @ToDate)
			or
				([EndDate] between @FromDate and @ToDate)
			)
		and [Guid] <> @CardGuid

GO

SET ANSI_NULLS, QUOTED_IDENTIFIER ON
GO

Create Procedure [dbo].[PrcGetMatMinMaxInfo]
(
	@MatGuid uniqueidentifier = 0x0
)
 
as
	Select 
		S.code +'-'+ s.Name as [Store],
		m.* 
	From
		[MatMinMax] M
		inner join [Store] s on S.Guid = m.StoreGuid
	where
		M.ParentGuid = @MatGuid
	Order By
		M.Number

GO

SET ANSI_NULLS, QUOTED_IDENTIFIER ON
GO
Create Procedure [PrcTransfer_LandContract]
(
	@RoKind int = 2,
	@ToDataBaseName Varchar(256) = 'AlAqaree2017',
	@UntilDate Datetime = '2016-12-31',
	@BeginDate Datetime = '2017-1-1',
	@RoundContractWithCheckNotCollection bit = 0
)
 
as
	if (@RoKind = 1) Return --  
	
	Declare @V Varchar(8000)
	
	EXEC PrcDeleteTable  'LandContract',@ToDataBaseName

	Set @V = '
			where 
				[ContractFinish] = 0
				or ([Guid] in (Select ContractGuid from lawsuit where [IsEnded] = 0))'
	if (@RoKind = 2) --    
	Set @V = @v + '
	or EditDate >'+''''+CAST(@UntilDate as varchar(255))+''''
				
	if (@RoundContractWithCheckNotCollection = 1) --       
	Set @V = @v + '
	or ([Guid] in (Select ContractGuid from vwChecksCollectionState where [IsCollection] = 0))'

	EXEC PrcTransferTable  'LandContract',@ToDataBaseName, @V
	
	
	Set @V = '
	Alter Table '+@ToDataBaseName+'..[LandContract] Disable Trigger All'
	exec (@v)

	--        
	Set @V = '
	UpDate '+@ToDataBaseName+'..[LandContract] Set [IsRounded] = 1 where EditDate <='+''''+CAST(@UntilDate as varchar(255))+''''
	exec(@V)

	--        
	Set @V = '
	UpDate '+@ToDataBaseName+'..[LandContract] Set [IsRounded] = 1 
	From
		'+@ToDataBaseName+'..[LandContract] L
		inner join HEntry H on L.Guid = H.Guid 
	where H.Date <'+''''+CAST(@UntilDate as varchar(255))+''''
	Print(@V)
	exec(@V)

 	Set @V = 'Update '+@ToDataBaseName+'..[LandContract] Set EditDate = '''+CAST(@BeginDate as VARchar(20))+''''
	exec(@V)

	Set @V = '
	Alter Table '+@ToDataBaseName+'..[LandContract] Enable Trigger All'
	exec (@v)

	--
	Set @V = '
	inner join '+@ToDataBaseName+'..LandContract L on L.Guid = [Tb].[ParentGuid]
	inner join '+@ToDataBaseName+'..Account Ac on Ac.Guid = [Tb].[AccountGuid]
	'
	EXEC PrcTransferTable  'LandContractFee',@ToDataBaseName, @V
	

	Set @V = '
	exec '+@ToDataBaseName+'..[PrcReNumberCard]
		0, --@Entry
		0, --@FirstEntryNum
		0, --@EntryType
		0x0, --@EntryTypeGuid
		0, --@FirstEntryTypeNum
		1, --@ContractType
		0x0, --@ContractTypeGuid =
		0, --@FirstContractTypeNum
		0, --@CheckType
		0x0, --@CheckTypeGuid 
		0, --@FirstCheckTypeNum
		0, --@Flat
		0, --@Shop
		0, --@Parking
		0, --@Land
		0, --@Villa
		0, --@Account
		0x0, --@ElectricityBillType
		0x0, --@ElectricityBillTypeGuid =
        0 --@Cus
		'
	exec(@V)

	--  
	Set @V = '
	Delete '+@ToDataBaseName+'..[Resource]'
	exec (@v)
	
	Set @V = '
	insert into '+@ToDataBaseName+'..[Resource]
	([Guid], [Kind])
	Select Guid, 1 from '+@ToDataBaseName+'..ContractType'
	exec (@v)
	
	Set @V = '
	exec '+@ToDataBaseName+'..PrcReCreateContractLandVillaEntry 0, 0, 0, 0, 0,0,0,0'
	--Sql.Add('exec PrcReCreateContractFlatShopEntry :Date1, :Date2, :ActiveDate, :Datewith, :Num1, :Num2, :ActiveNum, :MaxDate');

	exec (@v)



GO

SET ANSI_NULLS, QUOTED_IDENTIFIER ON
GO

Create Procedure [dbo].[PrcBill_TestMatQtyMinMax]
(
	@BillGuid uniqueidentifier = '2BA95684-5E0E-485E-A3CC-946A07737697'
)
 
as
	
	Create Table #TestMatQtyMinMax
	(
		[MatName] varchar(8000),
		[StName] varchar(256),
		[Qty] Float,
		[Minimum] Float,
		[Maximum] Float,
		[Unity] varchar(256),
		[MatGuid] uniqueidentifier,
		[StoreGuid] uniqueidentifier
	)

	Declare @IsPost Bit 
	Select @IsPost = [IsPosted] From [Bill] where Guid = @BillGuid
	
	if @IsPost = 0 
	begin
		Select * from #TestMatQtyMinMax
		return
	end

	
	Declare @Dir int
	
	Select Top 1
		@Dir =
		Case when [b].[BillKind] = 0 then 1
		     when [b].[BillKind] = 3 then 1
		     when [b].[BillKind] = 4 then 1
		     when [b].[BillKind] = 1 then -1
		     when [b].[BillKind] = 2 then -1
		     when [b].[BillKind] = 5 then -1
		end
	from 
		[BillDetail_tmp] B 
	where
		(B.ParentGuid = @BillGuid or @BillGuid = 0x0)

	
	--Select @dir, @IsPost
	

	insert into #TestMatQtyMinMax
	Select distinct
		mt.code+'-'+mt.Name as MatName,
		st.Name as [StName],
		case 
			when [Mt].[defUnity] = 1 then M.[Qty]
			when [Mt].[defUnity] = 2 then M.[Qty2]
			when [Mt].[defUnity] = 3 then M.[Qty3]
		end as[Qty],
		[X].[Minimum],
		[X].[Maximum],
		case 
			when [Mt].[defUnity] = 1 then Mt.[Unity1]
			when [Mt].[defUnity] = 2 then Mt.[Unity2]
			when [Mt].[defUnity] = 3 then Mt.[Unity3]
		end as[Unity],
		b.matGuid,
		B.StoreGuid
	from 
		[BillDetail_tmp] B --Select * from [BillDetail_tmp]
		inner join [Matbalance] M on B.matGuid = M.ParentGuid
		inner join Store St on M.storeGuid = St.Guid and B.StoreGuid = St.Guid 
		left join [MatMinMax] x on x.ParentGuid = B.matGuid and x.storeGuid = B.StoreGuid
		inner join [vwmat] mt on mt.Guid = M.[ParentGuid]
	where
		(B.ParentGuid = @BillGuid or @BillGuid = 0x0)

	--Select * from #TestMatQtyMinMax
	
	
	Select distinct
		b.Kind,
		B.MatGuid,
		B.StoreGuid,
		Sum(case 
			when [Mt].[defUnity] = 1 then B.[Qty]
			when [Mt].[defUnity] = 2 then B.[Qty2]
			when [Mt].[defUnity] = 3 then B.[Qty3]
		     end + [b].[Bonus]
		    )as[Qty],
		Case 	when [b].[BillKind] = 0 then 1
			when [b].[BillKind] = 3 then 1
			when [b].[BillKind] = 4 then 1
			when [b].[BillKind] = 1 then -1
			when [b].[BillKind] = 2 then -1
			when [b].[BillKind] = 5 then -1
		end [Direction]
	Into #CurrentBill
	from 
		[BillDetail_tmp] B 
		inner join [mat] mt on mt.Guid = B.[MatGuid]
	where
		(B.ParentGuid = @BillGuid or @BillGuid = 0x0)
	Group By	
		B.Kind,
		B.MatGuid,
		B.StoreGuid,
		[b].[BillKind]
	
	

	Select 
		Cast(B.matName as varchar(256))COLLATE database_default as matName,
		B.StName COLLATE database_default as StName ,
		B.Qty - Case when Kind = 1 then IsNull((C.Qty  * C.[Direction]),0) else 0 end as [CurrentQty],
		IsNull((C.Qty  * C.[Direction]),0) as BillQty,
		B.Qty - Case when Kind = 1 then IsNull((C.Qty  * C.[Direction]),0) else 0 end --as [CurrentQty]
		+ IsNull((C.Qty  * C.[Direction]),0) as
		[NewQty],
		B.minimum,
		B.Maximum
	into #TestMatQtyMinMax_R2
	From
		#TestMatQtyMinMax B
		left join #CurrentBill C on B.matGuid = C.matGuid and B.storeGuid = C.storeGuid

	Select
		*
	From
		#TestMatQtyMinMax_R2
	where
		(NewQty >= Maximum)
	

	Select
		*
	From
		#TestMatQtyMinMax_R2
	where
		(NewQty <= Minimum)
	

	Select
		*
	From
		#TestMatQtyMinMax_R2
	where
		(NewQty < 0) and (@Dir = -1)

	--Select * from #CurrentBill
	
	--Select * from #TestMatQtyMinMax

	

GO

SET ANSI_NULLS, QUOTED_IDENTIFIER ON
GO
Create Procedure [PrcBill_UpdateMatBalanceBeforePost]
(
	@BillGuid uniqueidentifier = 'C8A40236-C298-4904-A5C1-9D90BC2D082C'
)
 
as

	Declare @IsPost Bit 
	Select @IsPost = [IsPosted] From [Bill] where Guid = @BillGuid
	
	if @IsPost = 0 return

	Declare @MatGuid uniqueidentifier,
			@StoreGuid uniqueidentifier,
			@mtQnt Float, 
			@Direction int, 
			@biQty Float, 
			@biQty2 Float, 
			@biQty3 Float, 
			@biBonusQnt Float
	
	DECLARE @cursor_Name CURSOR 
	Set @cursor_Name = CURSOR FAST_FORWARD FOR 

	SELECT 
		D.MatGuid,
		[D].[StoreGuid],
		Case when [t].[BillKind] = 0 then 1			 when [t].[BillKind] = 3 then 1			 when [t].[BillKind] = 4 then 1			 when [t].[BillKind] = 1 then -1			 when [t].[BillKind] = 2 then -1			 when [t].[BillKind] = 5 then -1		end [Direction],		[d].[Qty], 
		[d].[Qty2], 
		[d].[Qty3],
		[d].[Bonus]	From
		Bill B
		inner join BillType [t] on [t].Guid = [b].TypeGuid
		inner join [BillDetail] D on D.parentGuid = B.Guid
	where
		B.Guid = @BillGuid
	
	OPEN @cursor_Name
	FETCH NEXT FROM @cursor_Name INTO @MatGuid ,@StoreGuid ,@Direction ,@biQty,@biQty2,@biQty3,@biBonusQnt
	
	WHILE @@FETCH_STATUS = 0
	BEGIN
		SET @mtQnt = @Direction * (@biQty + @biBonusQnt)  
		Set @BiQty2 = @Direction * @BiQty2
		Set @BiQty3 = @Direction * @BiQty3
		
		UPDATE MatBalance 
		SET 
			[Qty] = [Qty] - @mtQnt ,
			[Qty2] = [Qty2] - @BiQty2 ,
			[Qty3] = [Qty3] - @BiQty3 
		WHERE 
			[StoreGUID] = @StoreGuid
			AND [ParentGUID] = @MatGuid

		IF @@ROWCOUNT = 0 
		INSERT INTO [MatBalance]
		([ParentGuid], [StoreGUID],[Qty],[Qty2],[Qty3]) VALUES 
		(@MatGuid, @StoreGuid, @mtQnt, @BiQty2, @BiQty3)

	FETCH NEXT FROM @cursor_Name INTO @MatGuid ,@StoreGuid ,@Direction ,@biQty,@biQty2,@biQty3,@biBonusQnt
	
	END
	
	CLOSE @cursor_Name
	DEALLOCATE @cursor_Name
	
	Select * from MatBalance

GO

SET ANSI_NULLS, QUOTED_IDENTIFIER ON
GO

Create view [vwVilla]
 
as
	Select 
		*
	From
		[vwVillaall] [A]
	where
		isNull(A.Ban,0) = 0 


GO

SET ANSI_NULLS, QUOTED_IDENTIFIER ON
GO

Create Trigger [TRG_FlatContractFee_Del]
on [FlatContractFee]
 
For delete
As
	Update [Hentry] Set isPosted = 0
	From [HEntry] Inner join [Deleted] On [Deleted].[Guid] = [HEntry].[Guid]

	Delete [Hentry] From [HEntry] Inner join [Deleted] On [Deleted].[Guid] = [HEntry].[Guid]
		

GO

SET ANSI_NULLS, QUOTED_IDENTIFIER ON
GO

	Create View [vbCheckType]
	 
	as
		Select 
			[T].*
		From
			[CheckType] [T]
			inner join [CurrentUsers] [U] on ([u].[Seclvl] >= Isnull([T].[SecLvl],0)  or [u].[Admin] = 1) and [u].[spid] = @@Spid
GO

SET ANSI_NULLS, QUOTED_IDENTIFIER ON
GO
Create View [vwVillaPrint]
 
as
	Select
		[V].[Number] as [Number], 		[V].[Guid] as [Guid], 		[V].[SecLvl] as [SecLvl], 		[V].[Ban] as [Ban], 		[V].[WaterCounter] as [WaterCounter], 		[V].[ElectricityCounter] as [ElectricityCounter], 		[V].[ComplexName] as [ComplexName], 		[V].[Emirate] as [Emirate], 		[V].[Area] as [Area], 		[V].[unity] as [unity], 		[V].[Street] as [Street], 		[V].[Suburb] as [Suburb], 		[V].[PieceNo] as [PieceNo], 		[V].[BasinNo] as [BasinNo], 		[V].[VillaNo] as [VillaNo], 		[V].[DocType] as [DocType], 		[V].[DocNo] as [DocNo], 		[V].[DocDate] as [DocDate], 		[ac].[Name] as [VillaAccount], 		[Cu].[Name] as [CuOwner], 		[Co].[Name] as [Cost], 		[Ac2].[Name] as [AccountBankVilla], 		[R].[Name] as [RentInfo], 		[V].[BranchGuid] as [BranchGuid], 		[V].[FloorCount] as [FloorCount], 		[V].[BalconyCount] as [BalconyCount], 		[V].[RoomCount] as [RoomCount], 		[V].[OtherRoomCount] as [OtherRoomCount], 		[V].[ServiceRoomCount] as [ServiceRoomCount], 		[V].[BathroomCount] as [BathroomCount], 		[V].[StairsInternal] as [StairsInternal], 		[V].[RoomState] as [RoomState], 		[V].[LandArea] as [LandArea], 		[V].[LandAreaBuilding] as [LandAreaBuilding], 		[V].[FinishingState] as [FinishingState], 		[V].[SecurityType] as [SecurityType], 		[V].[SecuritySystem] as [SecuritySystem], 		[V].[wall] as [wall], 		[V].[wallState] as [wallState], 		[V].[lightingCount] as [lightingCount], 		[V].[ParkingCount] as [ParkingCount], 		[V].[ParkingArea] as [ParkingArea], 		[V].[ParkingShaded] as [ParkingShaded], 		[V].[PoolCount] as [PoolCount], 		[V].[PoolState] as [PoolState], 		[V].[PoolSystem] as [PoolSystem], 		[V].[PlaygroundCount] as [PlaygroundCount], 		[V].[PlaygroundArea] as [PlaygroundArea], 		[V].[GardenCount] as [GardenCount], 		[V].[GardenArea] as [GardenArea], 		[V].[GardenState] as [GardenState], 		[V].[OfferType] as [OfferType], 		[V].[OfferState] as [OfferState], 		[V].[Restrained] as [Restrained], 		[V].[RestrainedUserGuid] as [RestrainedUserGuid], 		[V].[CustomerName] as [CustomerName], 		[V].[CustomerPhone] as [CustomerPhone], 		[V].[Details] as [Details], 		[V].[LtnArea] as [LtnArea], 		[V].[LtnEmirate] as [LtnEmirate], 		[V].[LtnSuburb] as [LtnSuburb], 		[V].[LtnStreet] as [LtnStreet], 		[V].[LtnDocType] as [LtnDocType], 		[V].[VillaOwner] as [VillaOwner]
	From
		[Villa] [v]
		left join vwAccount [Ac] on [ac].Guid = [v].[VillaAccountGuid]
		left join vwCustomer [Cu] on [cu].Guid = [v].[CuOwnerGuid]
		left join vwCost [Co] on [Co].Guid = [v].[CostGuid]
		left join vwAccount [Ac2] on [Ac2].Guid = [v].[AccountBankVillaGuid]
		left join RentInfo [R] on [R].Guid = [v].[RentInfoGuid]

GO

SET ANSI_NULLS, QUOTED_IDENTIFIER ON
GO

Create Procedure [PrcSetMovingAccount]
 
as
	Truncate Table [MovingAccount]

	insert into [MovingAccount]
	Select
		[Ac].Guid
	From 
		[Account] [Ac]
		left join [Account] [Ac2] on [Ac2].[ParentGuid]  = [Ac].[Guid]
	where 
		([Ac2].[Guid] is Null)
		and ([Ac].[Type] = 0 or [Ac].[Type] = 3)

GO

SET ANSI_NULLS, QUOTED_IDENTIFIER ON
GO

Create view [vwEarth]
 
as
	Select 
		*
	From
		[vwEarthAll] [A]
	where
		isNull(A.Ban,0) = 0 

GO

SET ANSI_NULLS, QUOTED_IDENTIFIER ON
GO

Create Trigger [TRG_LandContractFee_Del]
on [LandContractFee]
 
For delete
As
	
	Update [Hentry] Set isPosted = 0
	From [HEntry] Inner join [Deleted] On [Deleted].[Guid] = [HEntry].[Guid]

	Delete [Hentry] From [HEntry] Inner join [Deleted] On [Deleted].[Guid] = [HEntry].[Guid]
		

GO

SET ANSI_NULLS, QUOTED_IDENTIFIER ON
GO

	Create View [vbContractType]
	 
	as
		Select 
			[T].*
		From
			[ContractType] [T]
			inner join [CurrentUsers] [U] on ([u].[Seclvl] >= Isnull([T].[SecLvl],0)  or [u].[Admin] = 1) and [u].[spid] = @@Spid
GO

SET ANSI_NULLS, QUOTED_IDENTIFIER ON
GO
Create Procedure PrcUpDateCountCurrentContract
 
as

	Alter Table [LeaseApartment] Disable Trigger all

	Select 
		CustomerGuid,
		ApartmentGuid,
		IsNull(COUNT(*),0) as [Count]
	into #CountCurrentContract
	From 
		[LeaseApartment]
	Group By
		CustomerGuid,
		ApartmentGuid
	
	update [LeaseApartment] Set CountCurrentContract = [Count]
	From
		[LeaseApartment] C
		inner join #CountCurrentContract L on l.CustomerGuid = C.CustomerGuid
												and L.ApartmentGuid = C.ApartmentGuid
												
	Alter Table [LeaseApartment] enable Trigger all


GO

SET ANSI_NULLS, QUOTED_IDENTIFIER ON
GO
Create View [vwLandPrint]
 
as
	Select
		[L].[Number] as [Number], 		[L].[Guid] as [Guid], 		[L].[SecLvl] as [SecLvl], 		[L].[No] as [No], 		[L].[Ban] as [Ban], 		[L].[EarthNo] as [EarthNo], 		[L].[Name] as [Name], 		[L].[ltnName] as [ltnName], 		[Cu].[Name] as [Customer], 		[L].[Date] as [Date], 		[L].[City] as [City], 		[L].[Region] as [Region], 		[L].[Space] as [Space], 		[L].[Area] as [Area], 		[L].[Unity] as [Unity], 		[L].[Price] as [Price], 		[L].[licenseNo] as [licenseNo], 		[L].[license] as [license], 		[L].[licenseDate] as [licenseDate], 		[L].[Details] as [Details], 		[L].[LandType] as [LandType], 		[L].[Side] as [Side], 		[L].[StreetName] as [StreetName], 		[L].[StreetCount] as [StreetCount], 		[L].[Buildble] as [Buildble], 		[L].[LandOwner] as [LandOwner], 		[L].[BeginLandValue] as [BeginLandValue], 		[L].[CurrencyBeginLandGuid] as [CurrencyBeginLandGuid], 		[L].[CurrencyValBeginLand] as [CurrencyValBeginLand], 		[L].[CurrencyPurchaseGuid] as [CurrencyPurchaseGuid], 		[L].[CurrencyValPurchase] as [CurrencyValPurchase], 		[L].[PurchaseNote] as [PurchaseNote], 		[Ac].[Name] as [Account], 		[Cu2].[Name] as [CuOwner], 		[Co2].[Name] as [Cost], 		[ac2].[Name] as [BankAccount], 		[L].[CommissionPercent] as [CommissionPercent], 		[ac3].[Name] as [AccountCommIncome], 		[L].[UsedEndDate] as [UsedEndDate], 		[cu3].[Name] as [CustomerOwner], 		[ac4].[Name] as [OwnerAccount], 		[L].[IdentityValue] as [IdentityValue], 		[L].[CurrencyIdentityGUID] as [CurrencyIdentityGUID], 		[L].[CurrencyValIdentity] as [CurrencyValIdentity], 		[L].[IdentityBeginDate] as [IdentityBeginDate], 		[L].[IdentityEndDate] as [IdentityEndDate], 		[L].[CrearteEntryInvestment] as [CrearteEntryInvestment], 		[L].[IdentityEntryGuid] as [IdentityEntryGuid], 		[L].[IdentityNote] as [IdentityNote], 		[L].[LtnLandType] as [LtnLandType], 		[L].[LtnCity] as [LtnCity], 		[L].[LtnRegion] as [LtnRegion], 		[L].[LtnSpace] as [LtnSpace], 		[L].[Ltnlicense] as [Ltnlicense], 		[L].[Ltnside] as [Ltnside]
	From
		[earth] [L]
		Left join vwCustomer [Cu] on [Cu].Guid = [L].[CustomerGuid]
		Left join Account [ac] on [ac].Guid = [L].[AccountGuid]
		Left join vwCustomer [Cu2] on [Cu2].Guid = [L].[CuOwnerGuid]
		Left join vwCost [Co2] on [Co2].Guid = [L].[CostGuid]
		Left join vwAccount [ac2] on [ac2].Guid = [L].[BankAccountGuid]
		Left join vwAccount [ac3] on [ac3].Guid = [L].[AccountCommIncomeGuid]
		Left join vwCustomer [cu3] on [cu3].Guid = [L].[CustomerOwnerGuid]
		Left join vwAccount [ac4] on [ac4].Guid = [L].[OwnerAccountGuid]

GO

SET ANSI_NULLS, QUOTED_IDENTIFIER ON
GO

Create Procedure [PrcOfferSundries]
(
	@SundriesType Varchar(256) = '',
	@CustGuid [uniqueidentifier] = 0x0,
	@CityGuid [uniqueidentifier] = 0x0,
	@RegionGuid [uniqueidentifier] = 0x0,
	@Area1 Float = 0,
	@Area2 Float = 0,
	@Price1 Float = 0,
	@Price2 Float = 0,
	@CkSale Bit = 1,
	@CkNotSale Bit = 1,
	@CkLease Bit = 1,
	@CkNotLease Bit = 1,
	@Restrained Bit = 1,
	@NotRestrained Bit = 1,
	@Date1 DateTime = '1/1/2007',
	@Date2 DateTime = '1/1/2008',
	@Lang Int = 0
)
 
as
	Select
		*,
		Case when [OfferType] = 1 then 
			case when @Lang = 0 then ''
				 when @Lang = 1 then 'Sale' end
			when [OfferType] = 0 then 
			case when @Lang = 0 then ''
				 when @Lang = 1 then 'rent' end 
		end as [StrOfferType],

		Case when [OfferType] = 1 and [OfferState] = 0 then 
			case when @Lang = 0 then ''
				 when @Lang = 1 then 'Sale' end

			 when [OfferType] = 1 and [OfferState] = 1 then 
			case when @Lang = 0 then ' '
				 when @Lang = 1 then 'Not Sale' end

			 when [OfferType] = 0 and [OfferState] = 0 then 
			case when @Lang = 0 then ''
				 when @Lang = 1 then 'rent' end

			 when [OfferType] = 0 and [OfferState] = 1 then 
			case when @Lang = 0 then ' '
				 when @Lang = 1 then 'Not rent' end
		end as [StrOfferState]

	From
		vwOfferSundries
	where
		([CityGuid] = @CityGuid or @CityGuid = 0x0)
		and ([SundriesType] = @SundriesType or @SundriesType = '')
		and ([RegionGuid] = @RegionGuid or @RegionGuid = 0x0)
		and ([CustomerGuid] = @CustGuid or @CustGuid = 0x0)
		and ([Area] between @Area1 and @Area2 or @Area2 = 0)
		and (
				([Area] = @Area1 and @Area2 = 0)
				or (@Area1 = 0)
				or (@Area1 <> 0 and @Area2 <> 0)
			)
		and ([Price] between @Price1 and @Price2 or @Price2 = 0)
		and (
				([Price] = @Price1 and @Price2 = 0)
				or (@Price1 = 0)
				or (@Price1 <> 0 and @Price2 <> 0)
			)

		and (
				([OfferType] = 1 and [OfferState] = 0 and @CkSale = 1 )
				or ([OfferType] = 0)
				Or ([OfferState] = 1)
				or (@CkSale <> 0)
			)

		and (
				([OfferType] = 1 and [OfferState] = 1 and @CkNotSale = 1 )
				or ([OfferType] = 0)
				Or ([OfferState] = 0)
				or (@CkNotSale <> 0)
			)

		-- 
		and (
				([OfferType] = 0 and [OfferState] = 0 and @CkLease = 1 )
				or ([OfferType] = 1)
				Or ([OfferState] = 1)
				or (@CkLease <> 0)
			)

		and (
				([OfferType] = 0 and [OfferState] = 1 and @CkNotLease = 1 )
				or ([OfferType] = 1)
				Or ([OfferState] = 0)
				or (@CkNotLease <> 0)
			)
		and ([Restrained] = 1 or @NotRestrained = 1)
		and ([Restrained] = 0 or @Restrained = 1)

GO

SET ANSI_NULLS, QUOTED_IDENTIFIER ON
GO

Create Procedure [PrcReCreateContractParkingEntry]
(
	@Date1 DateTime = '3/1/2011',
	@Date2 DateTime = '3/1/2012',
	@ActiveDate bit = 0,
	@Datewith int = 0,
	@Num1 int = 1,
	@Num2 int = 200,
	@ActiveNum bit = 1,
	@MaxDate int = 42644
)
 
as
	Set noCount on 
	
	--Update [Resource] set spid = @@spid
	
	exec PrcSetProgrss '', 100, 0

	Declare @Guid uniqueidentifier,
			@CreateEntry Bit
	Declare @RowCount int
	Declare @AllCount int	
	
	Select 
		L.[Guid],
		Case when T.[CreateEntry]  = 1 and L.CreateContractEntry = 1 then 1 else 0 end as [CreateEntry]
		into #TmpContract
	From 
		[ParkingContract] L
		inner join [ContractType] T on T.Guid = L.TypeGuid
		inner join [Resource] R on R.Guid = L.TypeGuid and R.Spid = @@SPID
	where
		(ISNULL(IsRounded, 0) = 0)
		and ((L.number between @num1 and @Num2) or @ActiveNum = 0)
		and (
			(
				([L].[FromDate] between @Date1 and @Date2 and @Datewith = 0)
			)
			or
			(
				([L].[ToDate] between @Date1 and @Date2 and @Datewith = 1)
			)

			or
			(
				([L].[ContractFinishDate] between @Date1 and @Date2 and @Datewith = 2)
				and ([L].[ContractFinish] = 1)
			)

			or
			(
				([L].[EditDate] between @Date1 and @Date2 and @Datewith = 3)
			)
			/*
			or
			(
				([L].[AcquittancePrintdate] between @Date1 and @Date2 and @Datewith = 4)
			)

			or
			(
				([L].LeaveDate between @Date1 and @Date2 and @Datewith = 5)
			)
			*/
			or @ActiveDate = 0
		) 
		
	--Select * from #TmpContract
	
	Set @AllCount = @@ROWCOUNT 
	Declare @Msg varchar(255)
	Set @Msg = dbo.SC('    ') +' '+'0 / '+Cast(@AllCount as Varchar(25))
	exec PrcSetProgrss @Msg, @AllCount, 0
	--Select * from #TmpContract
	
	Declare @Counter int
	Set @Counter = 0

	DECLARE cursor_Name CURSOR FAST_FORWARD FOR 
	Select * from #TmpContract
	Set @RowCount = 0
	
	OPEN cursor_Name
	FETCH NEXT FROM cursor_Name INTO @Guid, @CreateEntry
	
	WHILE @@FETCH_STATUS = 0
	BEGIN
		Set @Counter = @Counter + 1
		Set @Msg = dbo.SC('    ') +' '+Cast(@Counter as Varchar(25)) +' / '+Cast(@AllCount as Varchar(25))
		exec PrcSetProgrss @Msg, @AllCount, @Counter

		if @CreateEntry = 1
		begin
			--print @Guid
			exec [PrcCreateContractParkingEntry] @Guid, @MaxDate, 0
			Set @RowCount = @RowCount + 1			
		end
		else
		begin
			Delete HEntry where Guid = @Guid 
			Set @RowCount = @RowCount + 1
		end
		
	  FETCH NEXT FROM cursor_Name INTO @Guid, @CreateEntry
	
	END
	
	CLOSE cursor_Name
	DEALLOCATE cursor_Name

	Set @Msg = dbo.SC('')
	exec PrcSetProgrss @Msg, 0, 0

	if dbo.fnInRoundProcess() = 0
	Select @RowCount as [RowCount]
		

GO

SET ANSI_NULLS, QUOTED_IDENTIFIER ON
GO

Create Procedure [PrcPrintRestrained_Receipt]
(
	@Guid uniqueidentifier = 'F1CF2A33-E203-4368-8C79-AC72E8A90159',
	@Only Varchar(256) = '',
	@LtnOnly Varchar(256) = ''
)
 
as
	Select 
		[cu].[ArName] [CustArName],
		[cu].[LtnName] [CustLtnName],
    	Case when [RealtyType] = 0 then dbo.SC('')
    		 when [RealtyType] = 1 then dbo.SC('')
    		 when [RealtyType] = 2 then dbo.SC('')
    		 when [RealtyType] = 3 then dbo.SC('')
    		 when [RealtyType] = 4 then dbo.SC('')
		end	[RealtyType],
		[B].[ArName] as [BuildingArName],
		[B].[LtnName] as [BuildingLtnName],
    	Case when [RealtyType] = 0 then [A].[No]
    		 when [RealtyType] = 1 then [S].[No]
    		 when [RealtyType] = 2 then [P].[No]
    		 when [RealtyType] = 3 then [V].[VillaNo]
    		 when [RealtyType] = 4 then [E].[Name]
		end	[RealtyNo],
    	Case when [RealtyType] = 0 then [A].[FloorNo]
    		 when [RealtyType] = 1 then ''
    		 when [RealtyType] = 2 then ''
    		 when [RealtyType] = 3 then ''
    		 when [RealtyType] = 4 then ''
		end	[FloorNo],
		R.Number as RestrainedCardNumber,
		[R].[EditDate] as [RestrainedEditDate],
		[R].[Date] as [RestrainedDate],
		[R].[EndDate] as [RestrainedEndDate],
		[R].[Note],
		[R].[PayValue],
		[My].[Code] as [CurrencyCode],
		[My].[Name] as [CurrencyName],
		@Only  as [Only],
		@LtnOnly as [LtnOnly]
	From 
		[RealtyRestrained] [R]
		inner join [vwCustomer] [Cu] On [Cu].[Guid] = [R].[CustomerGuid]	
		left join [vwBuilding] [B] on [B].[Guid] = [R].[BuildingGuid]
		left join [Apartment] [A] on [A].[Guid] = [R].[FlatGuid] 
		left join [Shop] [S] on [S].[Guid] = [R].[Shop]
		left join [Parking] [P] on [P].[Guid] = [R].[ParkingNo]
		left join [Villa] [V] on [V].[Guid] = [R].[VillaGuid]
		left join [vwEarth] [E] on [E].[Guid] = [R].[LandGuid]
		left join [vwCurrency] [My] on [My].[Guid] = [R].[CurrencyGuid] 
	where
		[R].[Guid] = @Guid

GO

SET ANSI_NULLS, QUOTED_IDENTIFIER ON
GO

Create View [vwMovingCost]
 
as
	Select
		C.*
	From 
		[vwCost] C
		left join [Cost] C2 on C2.ParentGUID = C.Guid 
	where 
		C2.[Guid] is Null


GO

SET ANSI_NULLS, QUOTED_IDENTIFIER ON
GO

	Create View [vbLandOffer]
	 
	as
		Select 
			[T].*
		From
			[LandOffer] [T]
			inner join [CurrentUsers] [U] on ([u].[Seclvl] >= Isnull([T].[SecLvl],0)  or [u].[Admin] = 1) and [u].[spid] = @@Spid
GO

SET ANSI_NULLS, QUOTED_IDENTIFIER ON
GO

Create Procedure [dbo].[PrcUpdateParkingContractCreateEntryimmediate]
(
	@Date1 DateTime = '3/1/2011',
	@Date2 DateTime = '3/1/2012',
	@ActiveDate bit = 0,
	@Datewith int = 0,
	@Num1 int = 1,
	@Num2 int = 100,
	@ActiveNum bit = 1
)
 
as
	Alter Table [ParkingContract] Disable Trigger All
	
	update [ParkingContract]
	Set
		CreateContractEntry = Case when IsRounded = 0 and t.CreateEntry = 1 then 1 else 0 end
	From
		[ParkingContract] L
		inner join [ContractType] T on T.Guid = L.TypeGuid
		inner join [Resource] R on R.Guid = L.TypeGuid and R.Spid = @@SPID
	where
		((L.number between @num1 and @Num2) or @ActiveNum = 0)
		and (
			(
				([L].[FromDate] between @Date1 and @Date2 and @Datewith = 0)
			)
			or
			(
				([L].[ToDate] between @Date1 and @Date2 and @Datewith = 1)
			)

			or
			(
				([L].[ContractFinishDate] between @Date1 and @Date2 and @Datewith = 2)
				and ([L].[ContractFinish] = 1)
			)

			or
			(
				([L].[EditDate] between @Date1 and @Date2 and @Datewith = 3)
			)
			
			
			or @ActiveDate = 0
		) 
		
		Alter Table [ParkingContract] Enable Trigger All


GO

SET ANSI_NULLS, QUOTED_IDENTIFIER ON
GO

Create view [vwLawsuitState]
 
as
	Select 
		L.*,
		U.LoginName as [UserName]
	from
		[vbLawsuitState] L
		inner join [realty_Users] U on U.Guid = l.UserGuid

GO

SET ANSI_NULLS, QUOTED_IDENTIFIER ON
GO

Create Procedure [PrcPrintEntryDate]
(
	@Guid uniqueidentifier = 0x0,

	@TotalDebit Float = 50,
	@TotalCredit Float = 400,

	@OnlyTotalDebit Varchar(256) = '',
	@OnlyTotalCredit Varchar(256) = ''
)
 
as
	Select 
		[S].[Number],
		[S].[SecLvl],
		[S].[Date],
		[S].[Note],
		[my].[Code] as [Currency],
		[Ac].[Code]+'-'+[ac].[Name] as [Account],
		[S].[CurrencyVal],

		@TotalDebit as [TotalDebit],
		@TotalCredit as [TotalCredit],

		@OnlyTotalDebit as [OnlyTotalDebit],
		@OnlyTotalCredit as [OnlyTotalCredit]

	From 
		[EntryDate] [S]
		left join [vwCurrency] [My] On [My].[Guid] = [S].[CurrencyGuid]
		left join [vwaccount] [ac] on [ac].[Guid] = [S].[AccountGuid]
	where
		[S].[Guid] = @Guid Or @Guid = 0x0

	Select
		[S].[Number],
		[S].[Date],
		[S].[ParentGuid],
		[ac].[code]+'-'+[Ac].[Name] as [Account],
		[S].[Debit],
		[S].[Credit],
		[my].[Code] as [Currency],
		[S].[CurrencyVal],
		[co].[code]+'-'+[co].[Name] as [Cost],
		[S].[Note]
	From	
		[EntryDateDetail] [S]
		left join [vwaccount] [ac] on [ac].[Guid] = [S].[AcGuid]
		left join [vwCurrency] [My] On [My].[Guid] = [S].[CurrencyGuid]
		left join [vwCost] [co] On [co].[Guid] = [S].[CostGuid]
	where
		[S].[ParentGuid] = @Guid Or @Guid = 0x0
	Order By
		[S].[Number]

GO

SET ANSI_NULLS, QUOTED_IDENTIFIER ON
GO

	Create View [vbMaintenanceWorker]
	 
	as
		Select 
			[T].*
		From
			[MaintenanceWorker] [T]
			inner join [CurrentUsers] [U] on ([u].[Seclvl] >= Isnull([T].[SecLvl],0)  or [u].[Admin] = 1) and [u].[spid] = @@Spid
GO

SET ANSI_NULLS, QUOTED_IDENTIFIER ON
GO

Create Procedure [dbo].[PrcUpdateLandContractCreateEntryimmediate]
(
	@Date1 DateTime = '3/1/2011',
	@Date2 DateTime = '3/1/2012',
	@ActiveDate bit = 0,
	@Datewith int = 0,
	@Num1 int = 1,
	@Num2 int = 100,
	@ActiveNum bit = 1
)
 
as
	Alter Table [LandContract] Disable Trigger All
	
	update [LandContract]
	Set
		CreateContractEntry = Case when IsRounded = 0 and t.CreateEntry = 1 then 1 else 0 end
	From
		[LandContract] L
		inner join [ContractType] T on T.Guid = L.TypeGuid
		inner join [Resource] R on R.Guid = L.TypeGuid and R.Spid = @@SPID
	where
		((L.number between @num1 and @Num2) or @ActiveNum = 0)
		and (
			(
				([L].[FromDate] between @Date1 and @Date2 and @Datewith = 0)
			)
			or
			(
				([L].[ToDate] between @Date1 and @Date2 and @Datewith = 1)
			)

			or
			(
				([L].[ContractFinishDate] between @Date1 and @Date2 and @Datewith = 2)
				and ([L].[ContractFinish] = 1)
			)

			or
			(
				([L].[EditDate] between @Date1 and @Date2 and @Datewith = 3)
			)
			or
			(
				([L].[AcquittancePrintdate] between @Date1 and @Date2 and @Datewith = 4)
			)

			or
			(
				([L].LeaveDate between @Date1 and @Date2 and @Datewith = 5)
			)
			or @ActiveDate = 0
		) 
		
		Alter Table [LandContract] Enable Trigger All


GO

SET ANSI_NULLS, QUOTED_IDENTIFIER ON
GO
Create View [vwLawsuitSearch]
 
as
	Select 
		Case when L.No <> '' then L.No else L.ExeNo end as [No],
		L.ExeNo,
		Cu.Name as CustName,
		C.ContractKind,
		
		Case 
			when (C.ContractKind = 0) or (C.ContractKind = 2) then (Select No From Apartment where Guid = C.RealtyGuid)
			when (C.ContractKind = 1) or (C.ContractKind = 3) then (Select No From Shop where Guid = C.RealtyGuid)
			when (C.ContractKind = 4) or (C.ContractKind = 5) then (Select No From Parking where Guid = C.RealtyGuid)
			when (C.ContractKind = 6) or (C.ContractKind = 7) then (Select No From Earth where Guid = C.RealtyGuid)
			when (C.ContractKind = 8) or (C.ContractKind = 9) then (Select VillaNo From villa where Guid = C.RealtyGuid)
		End 
		as [RealtyNo],
		C.BuildingGuid,
		L.Guid
	From
		[Lawsuit] L
		inner join vwAllContractGuid C on C.Guid = L.ContractGuid
		inner join vwCustomer Cu on Cu.Guid = C.[CustomerGuid]

GO

SET ANSI_NULLS, QUOTED_IDENTIFIER ON
GO

Create Procedure [dbo].[PrcCreateLawsuitExpenseEntry]
(
	@Guid uniqueidentifier = '{F3F52B9E-7312-49DB-B0F0-4EEA9EFDF8BF}',
	@MoveCostWithDebit bit = 1, 
	@MoveCostWithCredit bit = 1
)
 
as
	set nocount on
	Declare @CeNumber Int
	Select
		@CeNumber = Number
	From
		HEntry
	where
		Guid = @Guid
		
	if isNull(@CeNumber,0) = 0
	Set @CeNumber = (Select isNull(MAX(Number),0) + 1 From HEntry)

	Delete
		HEntry
	where
		Guid = @Guid
		
	if Not exists(Select Top 1 Guid from [LawsuitExpense] where Guid = @Guid and CreateEntry = 1) return				

	Insert Into [HEntry]
	([Guid],[SecLvl],[Number],[Date], [CurrencyGuid], [CurrencyVal], [Note], [ParentKind], [BranchGuid], [IsPosted])
	Select
		@Guid,
		[SecLvl],
		@CeNumber,
		[EntryDate],
		[CurrencyGuid],
		[CurrencyVal],
		[Note],
		154,
		Null,
		1
	From
		[LawsuitExpense]
	where
		Guid = @Guid

	Declare @DetailNum Int
	Set @DetailNum = 0

	Insert into [DEntry]
 	([ParentGuid],[Number],[AcGuid],[Debit],[Credit],[CurrencyGuid],[CurrencyVal],[CostGuid],[ObverseAcGuid],[Note])
	Select
		@Guid,
		@DetailNum,
		[DebitAccountGuid],
		A.[ReceiptValue],
		0,
		A.CurrencyGUID,
		A.CurrencyVal,
		Case when 	@MoveCostWithDebit = 1 then [debitCostGuid] end,
		[CreditAccountGuid],
		A.[DebitNote]
	From
		[LawsuitExpense] A
	where
		A.[Guid] = @Guid
				
	Set @DetailNum = @DetailNum + 1
	
	Insert into [DEntry]
 	([ParentGuid],[Number],[AcGuid],[Debit],[Credit],[CurrencyGuid],[CurrencyVal],[CostGuid],[ObverseAcGuid],[Note])
	Select
		@Guid,
		@DetailNum,
		[CreditAccountGuid],
		0,
		A.[ReceiptValue],
		A.CurrencyGUID,
		A.CurrencyVal,
		Case when @MoveCostWithCredit = 1 then [CreditCostGuid] end,
		[DebitAccountGuid],
		A.[CreditNote]
	From
		[LawsuitExpense] A
	where
		A.[Guid] = @Guid

--	Select * from [HEntry] where Guid = @Guid
--	Select * from [DEntry] where parentGuid = @Guid
			

GO

SET ANSI_NULLS, QUOTED_IDENTIFIER ON
GO

Create FUNCTION [dbo].[fnGetAssetsGroupList]( @AccGUID [UNIQUEIDENTIFIER])  
	RETURNS @Result TABLE ([GUID] [UNIQUEIDENTIFIER], [Code] Varchar(256) COLLATE ARABIC_CI_AI, [Name] Varchar(256) COLLATE ARABIC_CI_AI, [Level] [INT] DEFAULT 0, [Path] [VARCHAR](8000) COLLATE ARABIC_CI_AI)   
 
AS 
BEGIN  
		---- 
		DECLARE @FatherBuf_S	TABLE
		(
			[GUID] [UNIQUEIDENTIFIER], 
			[Level] [INT], 
			[Path] [VARCHAR](8000) COLLATE ARABIC_CI_AI, 
			[ID] [INT] IDENTITY( 1, 1)
		)   
		DECLARE  @Continue_S [INT], @Level_S [INT]  
		SET @Level_S = 0   
		  
		SET @AccGUID = ISNULL(@AccGUID, 0x0)   
		IF @AccGUID = 0x0   
		BEGIN 
			INSERT INTO @FatherBuf_S ( [GUID], [Level], [Path]) SELECT [ac1].[Guid], @Level_S, ''  FROM [AssetsGroup] [ac1] WHERE ( ISNULL( [ac1].[ParentGuid], 0x0) = 0x0 ) ORDER BY [ac1].[Code]
			INSERT INTO @fatherBuf_s ( [GUID], [Level], [Path]) SELECT [ac1].[Guid], @Level_S, ''  
			FROM  
				[AssetsGroup] [ac1] 
				LEFT JOIN [AssetsGroup] [ac2] ON [ac1].[ParentGuid] = [ac2].[Guid] 
				LEFT JOIN @fatherBuf_s [f] ON [ac1].[Guid] = [f].[Guid]  
			WHERE  
				ISNULL( [ac1].[ParentGuid], 0x0) != 0x0 
				AND [ac2].[Guid] IS NULL 
				AND [f].[Guid]IS NULL 
			ORDER BY  
				[Ac1].[Code]
		END 
		ELSE   
			INSERT INTO @FatherBuf_S ([GUID] , [Level], [Path]) SELECT [Guid], @Level_S, '' FROM [AssetsGroup] WHERE [Guid] = @AccGUID ORDER BY [Code]
		  
		UPDATE @FatherBuf_S  SET [Path] = CAST( ( 0.0000001 * ID) AS [VARCHAR](40))   
	  
		SET @Continue_S = 1   
		IF (@AccGUID = 0x0) 
		BEGIN   
			WHILE @Continue_S <> 0   
			BEGIN   
				SET @Level_S = @Level_S + 1   
				INSERT INTO @FatherBuf_S([GUID],[Level],[Path])  
					SELECT  
						[ac].[Guid], @Level_S,[fb].[Path]  
					FROM  
						[AssetsGroup] AS [ac] 
						INNER JOIN @FatherBuf_S AS [fb] ON [ac].[ParentGuid] = [fb].[GUID]   
					WHERE  
						[fb].[Level] = @Level_S - 1   
					ORDER BY  
						[ac].[Code]
				SET @Continue_S = @@ROWCOUNT   
				UPDATE @FatherBuf_S  SET [Path] = [Path] + CAST( ( 0.0000001 * [ID]) AS VARCHAR(40))  WHERE [Level] = @Level_S 
			END   
		END  
		ELSE  
		BEGIN   
			WHILE @Continue_S <> 0   
			BEGIN   
				SET @Level_S = @Level_S + 1   
				INSERT INTO @FatherBuf_S([GUID], [Level], [Path])  
					SELECT  
						[ac].[Guid],@Level_S,[fb].[Path]  
					FROM  
						[AssetsGroup] AS [ac] INNER JOIN @FatherBuf_S AS [fb]  
						ON [ac].[ParentGuid] = [fb].[GUID]   
					WHERE  
						[fb].[Level] = @Level_S - 1  
					ORDER BY  
						[ac].[Code]
				SET @Continue_S = @@ROWCOUNT   
				UPDATE @FatherBuf_S  SET [Path] = [Path] + CAST( ( 0.0000001 * ID) AS [VARCHAR](40))  WHERE [Level] = @Level_S 
			END   
		END   

	INSERT INTO @Result 
	SELECT 
		[S].[GUID], [Code], [Name], [Level], [Path] 
	FROM 
		@FatherBuf_S [S]
		Inner join [vwAssetsGroup] [Ac] on [Ac].[Guid] = [S].[Guid] 
	GROUP BY 
		[S].[GUID], [Level], [Path] ,[Code], [Name]
	ORDER BY [Path] 

	RETURN  
END 


GO

SET ANSI_NULLS, QUOTED_IDENTIFIER ON
GO

Create Procedure [dbo].[PrcSetElectricityBillIsCollect]
(
	@ElectricityBillGuid uniqueidentifier = 'AE70120A-C611-4083-8150-BFECAAF7B6A7'
)

as
	Declare @ContractGuid uniqueidentifier
	 
	Select @ContractGuid = ContractGuid  From [ElectricityBill] 
	where
		Guid = @ElectricityBillGuid  
	
	Create Table #ElectricityBill
	(
		[Id] int identity(1,1),
		[Guid] uniqueidentifier,
		[TotalValue] Float,
		[Balance] Float
	)
	
	insert into #ElectricityBill
	([Guid], [TotalValue])
	Select [Guid],[TotalValue] - ISNULL(Overdue,0)  From [ElectricityBill]
	where
		ContractGuid = @ContractGuid
	order by
		Date, Number
		
	--Select * from #ElectricityBill
		
	Create Table #ElectricityPay1
	(
		Number int, 
		[Date] datetime,
		[Value] Float
	)
	
	-- 
	insert into #ElectricityPay1
	([Number], [Date], [Value])
	Select 
		S.Number, S.Date, [D].[Credit] - [D].[Debit] as [Value]
	from 
		Secondary_Entry S
		inner join Secondary_EntryDetail D on D.ParentGuid = S.Guid
		inner join [ElectricityBill] E on S.ContractGuid = E.Guid
	where 
		E.ContractGuid = @ContractGuid
		

	--
	insert into #ElectricityPay1
	([Number], [Date], [Value])
	Select 
		S.Number, S.Date, LL.[Value]
	from 
		Checks S
		inner join [LinkCheckContract] LL on LL.ParentGuid = S.Guid
		inner join [ElectricityBill] E on LL.ContractGuid = E.Guid
	where 
		E.ContractGuid = @ContractGuid
		
	--Select * from #ElectricityPay1
	
	Create Table #ElectricityPay
	(
		[Id] int identity(1,1),
		[Value] Float,
		[Balance] Float
	)
	
	insert into #ElectricityPay
	([Value])
	Select Value from #ElectricityPay1
	Order By
		DATE, Number

	
	update #ElectricityBill Set Balance = [RunTotal]
	From
		#ElectricityBill E
		inner join (
					Select 
						E.Id,
						(SELECT SUM(TotalValue) FROM #ElectricityBill D WHERE D.id <= E.id) AS [RunTotal]
					from 
						#ElectricityBill E
		) R on R.Id = E.Id

	update #ElectricityPay Set Balance = [RunTotal]
	From
		#ElectricityPay E
		inner join (
					Select 
						E.Id,
						(SELECT SUM(Value) FROM #ElectricityPay D WHERE D.id <= E.id) AS [RunTotal]
					from 
						#ElectricityPay E
		) R on R.Id = E.Id
		

	--Select * from #ElectricityBill
	
	Update ElectricityBill Set IsCollect = 0
	from
		ElectricityBill B
		inner join #ElectricityBill E on E.Guid = B.Guid
		

	--SELECT 
	--	Id, Balance
	--FROM #ElectricityPay order by id
	
	

	Declare @Id int,
			@Balance Float
	DECLARE @cursor_Name CURSOR 
	Set @cursor_Name = CURSOR FAST_FORWARD FOR 

	SELECT 
		Id, Balance
	FROM #ElectricityPay order by id
	
	OPEN @cursor_Name
	FETCH NEXT FROM @cursor_Name INTO @id, @Balance
	
	WHILE @@FETCH_STATUS = 0
	BEGIN
		
		--Select @Balance as bbb, IsCollect , * 
		--from
		--	ElectricityBill B
		--	inner join #ElectricityBill E on E.Guid = B.Guid
		--where
		--	E.Balance <= @Balance

		Update ElectricityBill Set IsCollect = 1
		from
			ElectricityBill B
			inner join #ElectricityBill E on E.Guid = B.Guid
		where
			E.Balance <= @Balance
	  
	  FETCH NEXT FROM @cursor_Name INTO @id, @Balance
	END
	
	CLOSE @cursor_Name
	DEALLOCATE @cursor_Name
	
	
	Select 
		IsCollect, B.TotalValue, B.Number, E.Balance 
	from 
		#ElectricityBill E
		inner join 	ElectricityBill B on B.Guid = E.Guid
	
	Select * from #ElectricityPay
	

	

GO

SET ANSI_NULLS, QUOTED_IDENTIFIER ON
GO

	Create View [vbLawsuitExpense]
	 
	as
		Select 
			[T].*
		From
			[LawsuitExpense] [T]
			inner join [CurrentUsers] [U] on ([u].[Seclvl] >= Isnull([T].[SecLvl],0)  or [u].[Admin] = 1) and [u].[spid] = @@Spid
GO

SET ANSI_NULLS, QUOTED_IDENTIFIER ON
GO

Create view [vwMaintenanceContract]
 
as
	Select 
		[TypeGuid],
		[EditDate],
		[Mark],
		Case when IsNull([ContractNo],'') <> '' then [ContractNo] else CAST(A.Number as varchar(255)) end as [ContractNo],
		[T].[Name] as [TypeName],

		[T].[Name] as [TypeNameAr],
		[T].[Name] as [TypeNameLtn],

		[T].[Name]+ ' / ' + Cast([A].[Number] as Varchar(10)) as [ArLeaseKind],

		[T].[Name] + Cast([A].[Number] as Varchar(10))  as [Contract], 


		[A].[Rent] - isNull([A].[DiscountValue],0) as [Value],

		[Cu].[Name] as [CustName],
		[Cu].[ArName] as [CustArName],
		[Cu].[LtnName] as [CustLtnName],
		[Cu].[Phonejob] as [CustomerPhonejob],
		[Cu].[Mobile] as [CustomerMobile],
		[Cu].[Nationality] as [CustomerNationality],
		[A].[BuildingGuid],
		[A].[Guid],
		[A].[Number],
		[A].[CustomerGuid],
		[A].[FromDate],
		[A].[ToDate],
		[A].[Rent],
		[A].[PeriodType],
		[A].[MonthlyValue],
		[A].[CurrencyGuid],
		[A].[CurrencyVal],
		[A].[PayType],
		[A].[Note],
		[A].[Note2],
		[A].[Purpose],
		[A].[IncomeAccountGuid],
		[A].[CustAccountGuid],

		[A].[ResultingAmount],
		[A].[ResultingAmount2],

		A.ContractFinish,
		[A].[ContractFinishDate],
		[A].[CreateResultingEntry],


		[A].[RentDuration],
		[A].[Rentype],
		[A].[TermsOfPayment],
		[A].[Seclvl],
		[A].[FineExpenceAccountGUID],

		[A].[CreateContractEntry],
		[A].[Whereabouts],		
		[A].[DiscountPercent],
		[A].[DiscountValue],
		[A].[Rent] - [A].[DiscountValue] as [RentAfterDiscount],	
		[A].[DiscountAccountGuid],
		[Cr].[Code] as [CurrencyName],
		[A].[BranchGuid],
		[A].[RoundKind],

		Case 
			when 
				Case when [ContractFinish] = 0 then [ToDate] else [ContractFinishDate] end 
				<= GetDate() then -- 
									Case when [ContractFinish] = 0 then dbo.SC('     ') 
									else
									dbo.SC('    ') end
			when 
				Case when [ContractFinish] = 0 then [ToDate] else [ContractFinishDate] end 
				> GetDate() then dbo.SC(' ') 
		end as [ContractState],

		[A].[Period],


		Case when [ContractFinish] = 0 then [ToDate] else [ContractFinishDate]  end as [EndDate],
		[A].[ResultingNote],

		[A].[NewState],
		Case when [A].[NewState] = 0 then dbo.SC('') else dbo.SC('') End as [NewStateStr],

		[A].[OtherFee],
		[A].[OtherFeeAccountGUID],

		[A].[License1No],
		[A].[License2No],
		[A].[License3No],
		[A].[License1Date1],
		[A].[License2Date1],
		[A].[License3Date1],
		[A].[License1Date2],
		[A].[License2Date2],
		[A].[License3Date2],
		[A].[Ltnwhereabouts],
		[A].[LtnPurpose],
		[A].[LtnRentDuration],
		[A].[LtnRentype],
		[A].[LtnTermsOfPayment],
		[A].[Trademark],

		[A].[CostGuid],
		[A].[CustAccountGuid] as [CustAcGuid],

		A.[IsRounded],

		[CountOldContract],

		[A].[AcquittancePrinted],
		[A].[AcquittancePrintDate],
		
		[A].AcquittancePrintedByGuid
	from 
		[vbMaintenanceContract] [A]
		inner join [vwMaintenanceContractType] [T] on [T].[Guid] = [A].[TypeGuid]
		--inner join [vwBuilding] [B] On [A].[BuildingGuid] = [B].[Guid]
		left join [vwcustomer] [Cu] On [Cu].[Guid] = [A].[CustomerGuid]
		left join [Currency] [Cr] On [Cr].[Guid] = [A].[CurrencyGuid]


GO

SET ANSI_NULLS, QUOTED_IDENTIFIER ON
GO

CREATE FUNCTION [fnGetLastHijriCurrentYear] ()
RETURNS Datetime
 
AS
BEGIN
	Declare @R Datetime
			,@Y Varchar(256)
			,@m Varchar(256)
			,@d Varchar(256)


	Set @Y = dbo.FnGregToHijriDate (getDate(), 'yyyy')
	Set @M = '12'
	Set @D = IsNull((Select DAY From HjrConfig where hjrMonth = 12 and hjrYear = @y),30)
	

	Set @R = dbo.fnDecodeHijriDatetoGergDate(@Y, @M, @d)
	RETURN @R
END

GO

SET ANSI_NULLS, QUOTED_IDENTIFIER ON
GO

Create Trigger [TRG_Trace_AssetsDepreciation]
on [AssetsDepreciation]
 
for update
As
	SET NOCOUNT ON;
	if Not exists(Select Value from DMD_const where vName = 'ActiveLogCardUpdate' and Value = '1' ) return
	
	Declare @UserGuid uniqueidentifier, @Guid uniqueidentifier
	Set @Guid = NEWID()
	
	Select Top 1 @UserGuid = userGuid From CurrentUsers where Spid = @@SPID
			
	insert into [Trace]
	([Guid],[ParentGuid],[Date],[userGuid],[HostName],ParentTbl )
	Select Top 1
		@Guid,
		N.Guid,
		GETDATE(),
		@UserGuid,
		Host_Name(),
		'AssetsDepreciation'
	From
		[inserted] n 
		
	insert into [TraceDetail]
	([ParentGuid],[Caption],[Old],[New],[Tbl])
	Select Top 1
		@Guid,
		' ' as [Caption],
		D.[SecLvl] as [old],
		N.[SecLvl] as [New],
		''
	From
		[deleted] d
		inner join [inserted] n on D.Guid = N.Guid
	where
		N.[SecLvl] <> D.[SecLvl]
		
	insert into [TraceDetail]
	([ParentGuid],[Caption],[Old],[New],[Tbl])
	Select Top 1
		@Guid,
		'' as [Caption],
		dbo.fnDate(D.[Date]) as [old],
		dbo.fnDate(N.[Date]) as [New],
		''
	From
		[deleted] d
		inner join [inserted] n on D.Guid = N.Guid
	where
		N.[Date] <> D.[Date]
		
	insert into [TraceDetail]
	([ParentGuid],[Caption],[Old],[New],[Tbl])
	Select Top 1
		@Guid,
		'' as [Caption],
		D.[CurrencyGUID] as [old],
		N.[CurrencyGUID] as [New],
		'[Currency]'
	From
		[deleted] d
		inner join [inserted] n on D.Guid = N.Guid
	where
		N.[CurrencyGUID] <> D.[CurrencyGUID]
		
	insert into [TraceDetail]
	([ParentGuid],[Caption],[Old],[New],[Tbl])
	Select Top 1
		@Guid,
		' ' as [Caption],
		D.[CurrencyVal] as [old],
		N.[CurrencyVal] as [New],
		''
	From
		[deleted] d
		inner join [inserted] n on D.Guid = N.Guid
	where
		N.[CurrencyVal] <> D.[CurrencyVal]
		
	insert into [TraceDetail]
	([ParentGuid],[Caption],[Old],[New],[Tbl])
	Select Top 1
		@Guid,
		' ' as [Caption],
		D.[CreateEntry] as [old],
		N.[CreateEntry] as [New],
		''
	From
		[deleted] d
		inner join [inserted] n on D.Guid = N.Guid
	where
		N.[CreateEntry] <> D.[CreateEntry]
		
	insert into [TraceDetail]
	([ParentGuid],[Caption],[Old],[New],[Tbl])
	Select Top 1
		@Guid,
		'' as [Caption],
		D.[Note] as [old],
		N.[Note] as [New],
		''
	From
		[deleted] d
		inner join [inserted] n on D.Guid = N.Guid
	where
		N.[Note] <> D.[Note]
		
	delete Trace From Trace t left join [TraceDetail] D on T.guid = D.ParentGuid
	where
		d.ParentGuid is Null and t.Guid = @Guid


GO

SET ANSI_NULLS, QUOTED_IDENTIFIER ON
GO
Create Procedure [PrcCrossTrailContractMonthCheck]
 
as
	Set Nocount on
		
	exec DropObject '##CheckMonthly'
	
	Create Table ##CheckMonthly
	(
		[Month] Varchar(255)
		,[Sort] int
		,[Value] Float
		,[ContractGuid] uniqueidentifier
		)

	--  
	insert into ##CheckMonthly
	Select --Top 50
		dbo.FnFloatTostr(DATEPART(Month, dueDate)) +' / '+dbo.FnFormatNumber( dbo.FnFloatTostr(DATEPART(Year, dueDate)),2),
		dbo.FnFloatTostr(DATEPART(Year, dueDate)) + dbo.FnFormatNumber( dbo.FnFloatTostr(DATEPART(Month, dueDate)),2),
		L.[Value],
		l.ContractGuid
	from 
		[checks] C
		inner join LinkCheckContract L on L.ParentGuid = C.Guid
		inner join [Resource] R on R.Guid = L.ContractGuid and R.[SPID] = @@SPID and R.Kind = 50

--	Select * from ##CheckMonthly	return
	
	IF  EXISTS (SELECT * FROM tempdb.dbo.sysobjects WHERE Name = '##Pvt_Contract')
	Drop Table ##Pvt_Contract
	
	IF  EXISTS (SELECT * FROM tempdb.dbo.sysobjects WHERE Name = '##TmpSql_Contract_check')
	Drop Table ##TmpSql_Contract_check
	
	
	Create Table ##TmpSql_Contract_check
	(
		[id] int identity,
		[Sqltext] varchar(8000)
	)
	
	DECLARE @sql varchar(8000)
	SET NOCOUNT ON
	SET ANSI_WARNINGS OFF
	
	Create Table ##Pvt_Contract
	(
		id int identity(1,1),
		[Sort] varchar(255)
	)
	
	insert into ##Pvt_Contract ([Sort])
	Select DISTINCT [Sort] from ##CheckMonthly order by [Sort]
	
	-----Debit
	insert into ##TmpSql_Contract_check (Sqltext)
	Select
	'Select
		[ContractGuid],
	'

	Declare @Month Varchar(255),@Sort Varchar(255), @id int
	
	DECLARE @cursor_Debit CURSOR 
	Set @cursor_Debit = CURSOR FAST_FORWARD FOR 

	SELECT id, [Sort]
	FROM ##Pvt_Contract
	order By
		id
	
	OPEN @cursor_Debit
	FETCH NEXT FROM @cursor_Debit INTO @id, @Sort
	
	WHILE @@FETCH_STATUS = 0
	BEGIN
	  Select @Month = [MONTH] from ##CheckMonthly where [Sort] = @Sort

	insert into ##TmpSql_Contract_check (Sqltext)
	Select
		'
		'''+@Month+''' = Sum( CASE [Sort] WHEN '+''''+@Sort+''' THEN [Value] END),'

	  FETCH NEXT FROM @cursor_Debit INTO @id, @Sort
	
	END
	
	CLOSE @cursor_Debit
	DEALLOCATE @cursor_Debit
	
	
	
	insert into ##TmpSql_Contract_check (Sqltext)
	Select
		'
		(Select Sum([value]) From [##CheckMonthly] where ContractGuid = E.ContractGuid) as '''+dbo.SC('')+'''
	into ##TblAssem_Check_Contract
	from 
		[##CheckMonthly] [E]
	Group By 
		[ContractGuid]'



	
	exec DropObject '##TblAssem_Check_Contract'


	--Select * from ##TmpSql_Contract_check order By id
	--return --  
	
	
	IF  EXISTS (SELECT * FROM tempdb.dbo.sysobjects WHERE Name = '##TblAssem_Check_Contract')
	Drop Table ##TblAssem_Check_Contract
	Declare @R int, @MaxR int
	Set @MaxR = (Select MAX(id) from ##TmpSql_Contract_check)
	Set @sql = ''
	
	Set @R = 0
	while @R < @MaxR+1
	begin
		--Select @R
		Set @sql = @sql + IsNull((Select sqltext from ##TmpSql_Contract_check where id = @R) ,'')
		Set @R = @R + 1
	end
	--Print @sql
	exec(@sql)
	
	--Select * from ##TblAssem_Check_Contract 
	
	
	SET ANSI_WARNINGS ON

GO

SET ANSI_NULLS, QUOTED_IDENTIFIER ON
GO

Create Trigger [TRG_Trace_CalcQty]
on [CalcQty]
 
for update
As
	SET NOCOUNT ON;
	if Not exists(Select Value from DMD_const where vName = 'ActiveLogCardUpdate' and Value = '1' ) return
	
	Declare @UserGuid uniqueidentifier, @Guid uniqueidentifier
	Set @Guid = NEWID()
	
	Select Top 1 @UserGuid = userGuid From CurrentUsers where Spid = @@SPID
			
	insert into [Trace]
	([Guid],[ParentGuid],[Date],[userGuid],[HostName],ParentTbl )
	Select Top 1
		@Guid,
		N.Guid,
		GETDATE(),
		@UserGuid,
		Host_Name(),
		'CalcQty'
	From
		[inserted] n 
		
	insert into [TraceDetail]
	([ParentGuid],[Caption],[Old],[New],[Tbl])
	Select Top 1
		@Guid,
		' ' as [Caption],
		D.[SecLvl] as [old],
		N.[SecLvl] as [New],
		''
	From
		[deleted] d
		inner join [inserted] n on D.Guid = N.Guid
	where
		N.[SecLvl] <> D.[SecLvl]
		
	insert into [TraceDetail]
	([ParentGuid],[Caption],[Old],[New],[Tbl])
	Select Top 1
		@Guid,
		'' as [Caption],
		D.[Name] as [old],
		N.[Name] as [New],
		''
	From
		[deleted] d
		inner join [inserted] n on D.Guid = N.Guid
	where
		N.[Name] <> D.[Name]
		
	insert into [TraceDetail]
	([ParentGuid],[Caption],[Old],[New],[Tbl])
	Select Top 1
		@Guid,
		'' as [Caption],
		D.[Equality] as [old],
		N.[Equality] as [New],
		''
	From
		[deleted] d
		inner join [inserted] n on D.Guid = N.Guid
	where
		N.[Equality] <> D.[Equality]
		
	insert into [TraceDetail]
	([ParentGuid],[Caption],[Old],[New],[Tbl])
	Select Top 1
		@Guid,
		'' as [Caption],
		D.[Note] as [old],
		N.[Note] as [New],
		''
	From
		[deleted] d
		inner join [inserted] n on D.Guid = N.Guid
	where
		N.[Note] <> D.[Note]
		
	delete Trace From Trace t left join [TraceDetail] D on T.guid = D.ParentGuid
	where
		d.ParentGuid is Null and t.Guid = @Guid


GO

SET ANSI_NULLS, QUOTED_IDENTIFIER ON
GO
Create Procedure [PrcSetLastFlatRentPrice]
(
	@ParentGuid uniqueidentifier = 0x0
)
 
as
	Select 
		[C].[ParentGuid],
		[Price] as [Rent],
		[CurrencyGuid] as [RentCurrencyGuid]
	into #ChangeFlatRent
	From
		[ChangeFlatRent] [C]
		inner join (
						Select 
								[ParentGuid],
								Max(Date) as [MaxDate],
								Max([Number]) as [MaxNumber]
						From
							[ChangeFlatRent]
						where
							ParentGuid = @ParentGuid or @ParentGuid = 0x0
						Group By
							[ParentGuid]
					) [C2] on [C2].[ParentGuid] = [C].[ParentGuid] 
							and [C].[Date] = [C2].[MaxDate] 
							and (Case when [C].[Date] = [C2].[MaxDate] then [MaxNumber] else [C].[Number] end = [C].[Number])
	where
		C.ParentGuid = @ParentGuid or @ParentGuid = 0x0
		
	update Apartment 
	Set 
		Rent = C.Rent,
		RentCurrencyGuid = C.RentCurrencyGuid
	From
		 Apartment a
		 inner join #ChangeFlatRent C on C.ParentGuid = a.Guid

GO

SET ANSI_NULLS, QUOTED_IDENTIFIER ON
GO

	Create View [vbContractLog]
	 
	as
		Select 
			[T].*
		From
			[ContractLog] [T]
			inner join [CurrentUsers] [U] on ([u].[Seclvl] >= Isnull([T].[SecLvl],0)  or [u].[Admin] = 1) and [u].[spid] = @@Spid
GO

SET ANSI_NULLS, QUOTED_IDENTIFIER ON
GO

Create Procedure [PrcAlarmCheckReturn]
 
as
	Select
		COUNT(*) as [Count]
	From
		Checks C
		inner join ChecksCollection L on [L].[CheckGuid] = C.Guid 
	where
		[L].[kind] = 3
		and isNull([L].[Finished],0) = 0

GO

SET ANSI_NULLS, QUOTED_IDENTIFIER ON
GO

CREATE FUNCTION [FnStrToTable] (@Number Varchar(8000))
RETURNS @Res Table ([Str] Varchar(256))  AS
BEGIN
	Declare @Str Varchar(256)
	Set @Str = ''

	Declare @I int 
	Set @I = 0

	while (@i <= len(@Number) )
	begin
		if SubString(@Number, @I , 1) = ','
		begin
			insert into @Res
			Select @Str

			Set @Str = ''
		end
		else
		begin
			Set @Str = @Str + SubString(@Number, @I , 1)
		end

		Set @I = @I + 1
	end

	if @Str <> ''
	insert into @Res
	Select @Str
	
	RETURN
END

GO

SET ANSI_NULLS, QUOTED_IDENTIFIER ON
GO
Create View [vwMatGroup]
 
as
	Select
		[G].*,
		[P].[Code]+'-'+[P].[Name] as [ParentGroup]
	From
		[vbMatGroup] [G]
		left join [vbMatGroup] [P] on [P].[Guid] = [G].[ParentGuid]

GO

SET ANSI_NULLS, QUOTED_IDENTIFIER ON
GO

	Create View [vbMaintenanceContractType]
	 
	as
		Select 
			[T].*
		From
			[MaintenanceContractType] [T]
			inner join [CurrentUsers] [U] on ([u].[Seclvl] >= Isnull([T].[SecLvl],0)  or [u].[Admin] = 1) and [u].[spid] = @@Spid
GO

SET ANSI_NULLS, QUOTED_IDENTIFIER ON
GO

CREATE FUNCTION dbo.[fnDaysBetween] (@StartDate Datetime, @endDate Datetime)
RETURNS Varchar(256)
 AS
BEGIN
	return Datediff(day, @StartDate, @endDate )+1
END

GO

SET ANSI_NULLS, QUOTED_IDENTIFIER ON
GO

	Create View [vbMaintenanceItem]
	 
	as
		Select 
			[T].*
		From
			[MaintenanceItem] [T]
			inner join [CurrentUsers] [U] on ([u].[Seclvl] >= Isnull([T].[SecLvl],0)  or [u].[Admin] = 1) and [u].[spid] = @@Spid
GO

SET ANSI_NULLS, QUOTED_IDENTIFIER ON
GO

Create FUNCTION [dbo].[fnGetIncAccountList]( @AccGUID [UNIQUEIDENTIFIER])  
	RETURNS @Result TABLE ([GUID] [UNIQUEIDENTIFIER], [Code] Varchar(256) COLLATE ARABIC_CI_AI, [Name] Varchar(256) COLLATE ARABIC_CI_AI, [Level] [INT] DEFAULT 0, [Path] [VARCHAR](8000) COLLATE ARABIC_CI_AI,[Band] int,[Band2] int)   
 
AS 
BEGIN  
		---- 
		DECLARE @FatherBuf_S	TABLE
		(
			[GUID] [UNIQUEIDENTIFIER], 
			[Level] [INT], 
			[Path] [VARCHAR](8000) COLLATE ARABIC_CI_AI, 
			[Band] int,
			[Band2] int,
			[ID] [INT] IDENTITY( 1, 1)
		)   
		DECLARE  @Continue_S [INT], @Level_S [INT]  
		SET @Level_S = 0   
		  
		SET @AccGUID = ISNULL(@AccGUID, 0x0)   
		IF @AccGUID = 0x0   
		BEGIN 
			INSERT INTO @FatherBuf_S ( [GUID], [Level], [Path],[Band],[Band2]) SELECT [ac1].[Guid], @Level_S, '',[Band],[Band2]  FROM [IncAccount] [ac1] WHERE ( ISNULL( [ac1].[ParentGuid], 0x0) = 0x0 ) ORDER BY [ac1].[Code]
			INSERT INTO @fatherBuf_s ( [GUID], [Level], [Path],[Band],[Band2]) SELECT [ac1].[Guid], @Level_S, '',[ac1].[Band],[ac1].[Band2]  
			FROM  
				[IncAccount] [ac1] 
				LEFT JOIN [IncAccount] [ac2] ON [ac1].[ParentGuid] = [ac2].[Guid] 
				LEFT JOIN @fatherBuf_s [f] ON [ac1].[Guid] = [f].[Guid]  
			WHERE  
				ISNULL( [ac1].[ParentGuid], 0x0) != 0x0 
				AND [ac2].[Guid] IS NULL 
				AND [f].[Guid]IS NULL 
			ORDER BY  
				[Ac1].[Code]
		END 
		ELSE   
			INSERT INTO @FatherBuf_S ([GUID] , [Level], [Path],[Band],[Band2]) SELECT [Guid], @Level_S, '',[Band],[Band2] FROM [IncAccount] WHERE [Guid] = @AccGUID ORDER BY [Code]
		  
		UPDATE @FatherBuf_S  SET [Path] = CAST( ( 0.0000001 * ID) AS [VARCHAR](40))   
	  
		SET @Continue_S = 1   
		IF (@AccGUID = 0x0) 
		BEGIN   
			WHILE @Continue_S <> 0   
			BEGIN   
				SET @Level_S = @Level_S + 1   
				INSERT INTO @FatherBuf_S([GUID],[Level],[Path],[Band],[Band2])  
					SELECT  
						[ac].[Guid], @Level_S,[fb].[Path],ac.[Band],ac.[Band2]  
					FROM  
						[IncAccount] AS [ac] 
						INNER JOIN @FatherBuf_S AS [fb] ON [ac].[ParentGuid] = [fb].[GUID]   
					WHERE  
						[fb].[Level] = @Level_S - 1   
					ORDER BY  
						[ac].[Code]
				SET @Continue_S = @@ROWCOUNT   
				UPDATE @FatherBuf_S  SET [Path] = [Path] + CAST( ( 0.0000001 * [ID]) AS VARCHAR(40))  WHERE [Level] = @Level_S 
			END   
		END  
		ELSE  
		BEGIN   
			WHILE @Continue_S <> 0   
			BEGIN   
				SET @Level_S = @Level_S + 1   
				INSERT INTO @FatherBuf_S([GUID], [Level], [Path],[Band],[Band2])  
					SELECT  
						[ac].[Guid],@Level_S,[fb].[Path],ac.[Band],ac.[Band2]  
					FROM  
						[IncAccount] AS [ac] INNER JOIN @FatherBuf_S AS [fb]  
						ON [ac].[ParentGuid] = [fb].[GUID]   
					WHERE  
						[fb].[Level] = @Level_S - 1  
					ORDER BY  
						[ac].[Code]
				SET @Continue_S = @@ROWCOUNT   
				UPDATE @FatherBuf_S  SET [Path] = [Path] + CAST( ( 0.0000001 * ID) AS [VARCHAR](40))  WHERE [Level] = @Level_S 
			END   
		END   


	INSERT INTO @Result 
	SELECT 
		[S].[GUID], [Code], [Name], [Level], [Path] ,S.[Band],s.[Band2]
	FROM 
		@FatherBuf_S [S]
		Inner join [vwIncAccount] [Ac] on [Ac].[Guid] = [S].[Guid] 
	GROUP BY 
		[S].[GUID], [Level], [Path] ,[Code], [Name],[Band],[Band2]
	ORDER BY [Path] 

	RETURN  
END 


GO

SET ANSI_NULLS, QUOTED_IDENTIFIER ON
GO
Create View [vwStore]
 
as
	Select
		[G].*,
		[P].[Code]+'-'+[P].[Name] as [ParentGroup]
	From
		[vbStore] [G]
		left join [vbStore] [P] on [P].[Guid] = [G].[ParentGuid]

GO

SET ANSI_NULLS, QUOTED_IDENTIFIER ON
GO

Create View [vwChecksCollectionState]
 
as
	Select
		[P].[Guid] as [CheckGuid],
		Case when [C].[CheckGuid] is Null then 0 else 1 end as [IsPosted],
		Case 
			when ([C1].[CheckGuid] is null) and ([C4].[CheckGuid] is null) then 0 
			when [C1].[CheckGuid] is Not null then 1
			when [P].[Value] = [C4].[Value] then 1
			else 0
		end
		as [IsCollection],
		Case when [C4].[CheckGuid] is Null then 0 else 1 end as [IsPartialCollection],
		Case when [C2].[CheckGuid] is null then 0 else 1 end as [IsEndorsement],
		Case when [C3].[CheckGuid] is null then 0 else 1 end as [IsReturned],
		[C3].[Finished],
		P.ContractGuid
	From
		[Checks] [P]
		left join [vwChecksCollection] [C] on [C].[CheckGuid] = [P].[Guid] and [C].[Kind] = 0
		left join [vwChecksCollection] [C1] on [C1].[CheckGuid] = [P].[Guid] and [C1].[Kind] = 1
		left join [vwChecksCollection] [C2] on [C2].[CheckGuid] = [P].[Guid] and [C2].[Kind] = 2
		left join [vwChecksCollection] [C3] on [C3].[CheckGuid] = [P].[Guid] and [C3].[Kind] = 3
		left join (
						Select 
							[CheckGuid],
							Sum([Value]) as [Value] 
						From
							[ChecksPartialCollection] 
						Group By
							[CheckGuid]
					) [C4] on [C4].[CheckGuid] = [P].[Guid]


GO

SET ANSI_NULLS, QUOTED_IDENTIFIER ON
GO

Create Procedure [PrcTestShopUsed2]
(
	@MotherShopGuid uniqueidentifier = '773E9079-47D2-48E4-BF75-EB5EE596ACEC',
	@Date1 DateTime = '10/1/2007',
	@Date2 DateTime = '10/1/2009'
)
 
as

	Select
		[L].*,
		Case when [ContractFinish] = 0 then [ToDate] else [ContractFinishDate]  end as [EndDate]
	into #Contract
	From
		[LeaseApartment] [L]
		inner join [AccumulateShop] [A] on [A].[ShopGuid] = [L].[ApartmentGuid]
	where 
		([A].[ParentGuid] = @MotherShopGuid)		

	Select 
		[L].[Number],
		[T].[Name] as [ContractName],
		[L].[FromDate],
		[L].[ToDate],
		[L].[Leasekind],
		[L].[ApartmentGuid],
		[L].[Guid]
	From 
		[#Contract] [L] 
		inner join [ContractType] [T] On [T].[Guid] = [L].[TypeGuid]
		inner join [AccumulateShop] [A] on [L].[ApartmentGuid] = [A].[ShopGuid]
	where 
		([A].[ParentGuid] = @MotherShopGuid)		
		and 
		(
				(
					[Leasekind] = 3
					and	(
							([FromDate] <= @Date1 )
						 or ([FromDate] <= @Date2 )
						)
				)
				or 
				(
					[Leasekind] = 1
					and	([ContractFinish] = 0 )
				)

			)
			

GO

SET ANSI_NULLS, QUOTED_IDENTIFIER ON
GO

Create Procedure PrcCalcMaxAccountcode
(
	@Guid uniqueidentifier = '9A88A0D4-1A00-42F6-90F5-649308B14269'
)
 as

	Declare @LenCode int
	Set @LenCode = (Select Len([Code]) From [Account] where [Guid] = @Guid)
	Declare @mxCode varchar(255)
	
	select Top 1
		@mxCode = 
		Case when ISNUMERIC( RIGHT([Code], Len([Code]) - @LenCode)) = 1
		then 
			[Code]
		end
	From 
		Account
	where 
		[ParentGuid] = @Guid	
	order by
		len(Code) desc , Code desc

	if @mxCode = ''	Set @mxCode = Null

	Declare @Ms Varchar(256)
	Set @Ms = dbo.SC('      ') --+ '  ' + @mxCode

	Declare @ChildCount int
	Select @ChildCount = COUNT(*) From Account where ParentGUID = @Guid
	
	if (ISNULL(@mxCode,'') = '') and (ISNULL(@ChildCount,0) <> 0)

	if ISNULL(@mxCode,'') = ''
	begin
		RAISERROR (@Ms, 16, 1)
		return
	end
	--return

	Declare @Code Varchar(20)
	Set @Code = (Select [Code] From [Account] where [Guid] = @Guid)
	
	Declare @LenNewCode int
	Set @LenNewCode = Len(@mxCode)  - @LenCode

	if ISNULL(@LenNewCode, 0) = 0 Set @LenNewCode = 1
		
	Select 
		@Code + 
		ISNULL(
		Cast(
				dbo.FnFormatNumber(
									Right(Cast(RIGHT(@mxCode, Len(@mxCode) - @LenCode)as int)+1 , 
									@LenNewCode), @LenNewCode) as Varchar(256
								  )
			), '001') as [Code]
			

GO

SET ANSI_NULLS, QUOTED_IDENTIFIER ON
GO

Create Procedure [dbo].[arv_prcPhotoForDownload]

as
	Select 
		p.Guid,
		P.ParentGuid,
		P.[Date],
		P.[Path],
		p.[Desc],
		p.Note,
		U.LoginName as [UserName] ,
		p.TableGUID,
		1 as [Download]
	from 
		Photos P
		inner join Realty_Users U on U.Guid = p.userGuid
		inner join arv_files d on D.parentGuid = p.Guid
	

GO

SET ANSI_NULLS, QUOTED_IDENTIFIER ON
GO

Create Procedure PrcCalcMaxCostcode
(
	@Guid uniqueidentifier = '9A88A0D4-1A00-42F6-90F5-649308B14269'
)
 as

	Declare @LenCode int
	Set @LenCode = (Select Len([Code]) From [Cost] where [Guid] = @Guid)
	Declare @mxCode varchar(255)
	
	select Top 1
		@mxCode = 
		Case when ISNUMERIC( RIGHT([Code], Len([Code]) - @LenCode)) = 1
		then 
			[Code]
		end
	From 
		Cost
	where 
		[ParentGuid] = @Guid	
	order by
		len(Code) desc , Code desc

	if @mxCode = ''	Set @mxCode = Null

	Declare @Ms Varchar(256)
	Set @Ms = dbo.SC('      ') --+ '  ' + @mxCode

	Declare @ChildCount int
	Select @ChildCount = COUNT(*) From Cost where ParentGUID = @Guid
	
	if (ISNULL(@mxCode,'') = '') and (ISNULL(@ChildCount,0) <> 0)

	if ISNULL(@mxCode,'') = ''
	begin
		RAISERROR (@Ms, 16, 1)
		return
	end
	--return

	Declare @Code Varchar(20)
	Set @Code = (Select [Code] From [Cost] where [Guid] = @Guid)
	
	Declare @LenNewCode int
	Set @LenNewCode = Len(@mxCode)  - @LenCode

	if ISNULL(@LenNewCode, 0) = 0 Set @LenNewCode = 1
		
	Select 
		@Code + 
		ISNULL(
		Cast(
				dbo.FnFormatNumber(
									Right(Cast(RIGHT(@mxCode, Len(@mxCode) - @LenCode)as int)+1 , 
									@LenNewCode), @LenNewCode) as Varchar(256
								  )
			), '001') as [Code]
			

GO

SET ANSI_NULLS, QUOTED_IDENTIFIER ON
GO

Create Procedure [PrcReCreateServicesContract]
(
	@Date1 DateTime = 0,
	@Date2 DateTime = 0,
	@ActiveDate bit = 0,
	@Datewith int = 0,
	@Num1 int = 0,
	@Num2 int = 0,
	@ActiveNum bit = 0
)
 
as
	Set noCount on

	--Update [Resource] set spid = @@spid
	 
	exec PrcSetProgrss '', 100, 0
	
	Declare @Guid uniqueidentifier,
			@CreateEntry Bit
	Declare @RowCount int

	Declare @AllCount int	
	Select 
		L.[Guid],
		Case when T.[CreateEntry]  = 1 and L.CreateContractEntry = 1 then 1 else 0 end as [CreateEntry]
		into #TmpContract
	From 
		[ServicesContract] L
		inner join [ServicesContractType] T on T.Guid = L.TypeGuid
		inner join [Resource] R on R.Guid = L.TypeGuid and R.Spid = @@SPID
	where
		(ISNULL(IsRounded, 0) = 0)
		and ((L.number between @num1 and @Num2) or @ActiveNum = 0)
		and (
			(
				([L].[FromDate] between @Date1 and @Date2 and @Datewith = 0)
			)
			or
			(
				([L].[ToDate] between @Date1 and @Date2 and @Datewith = 1)
			)

			or
			(
				([L].[ContractFinishDate] between @Date1 and @Date2 and @Datewith = 2)
				and ([L].[ContractFinish] = 1)
			)

			or
			(
				([L].[EditDate] between @Date1 and @Date2 and @Datewith = 3)
			)
			or
			(
				([L].[AcquittancePrintdate] between @Date1 and @Date2 and @Datewith = 4)
			)

			or @ActiveDate = 0
		) 
		
	Set @AllCount = @@ROWCOUNT 
	
	Declare @Msg varchar(255)
	Set @Msg = dbo.SC('    ') +' '+'0 / '+Cast(@AllCount as Varchar(25))
	exec PrcSetProgrss @Msg, @AllCount, 0
	--Select * from #TmpContract
	
	Declare @Counter int
	Set @Counter = 0
	DECLARE cursor_Name CURSOR FAST_FORWARD FOR 
	Select * from #TmpContract
	Set @RowCount = 0
	
	OPEN cursor_Name
	FETCH NEXT FROM cursor_Name INTO @Guid, @CreateEntry
	
	WHILE @@FETCH_STATUS = 0
	BEGIN
		Set @Counter = @Counter + 1
		Set @Msg = dbo.SC('    ') +' '+Cast(@Counter as Varchar(25)) +' / '+Cast(@AllCount as Varchar(25))
		exec PrcSetProgrss @Msg, @AllCount, @Counter

		if @CreateEntry = 1
		begin
			
			exec PrcCreateServicesContractEntry @Guid
			Set @RowCount = @RowCount + 1			
		end
		else
		begin
			Delete HEntry where Guid = @Guid 
			Set @RowCount = @RowCount + 1
		end
		
	  FETCH NEXT FROM cursor_Name INTO @Guid, @CreateEntry
	
	END
	
	CLOSE cursor_Name
	DEALLOCATE cursor_Name

	Set @Msg = dbo.SC('')
	exec PrcSetProgrss @Msg, 0, 0
		
	if dbo.fnInRoundProcess() = 0
	Select @RowCount as [RowCount]
		

GO

SET ANSI_NULLS, QUOTED_IDENTIFIER ON
GO

Create Procedure [PrcPaperMonetaryOfElectricityBill]
(
	@ContractGuid UniqueIdentifier = 0x0
)
 
as
	Set NoCount On
	
	Select 
		dbo.SC([P].[TypeName]) as [PaperKind],
		[P].[No],
		[LL].[Value],
		[P].[BankName],
		[P].[CurrencyCode],
		[P].[DueDate],
		Case 		
			when  [C3].[CheckGuid] is not null then dbo.SC('')

			when  ([C1].[CheckGuid] is not null) or 
				  ([C4].[CheckGuid] is Not Null ) and ([C4].[Value] >= [P].[Value])	 then dbo.SC('') 

			when ([C4].[CheckGuid] is Not Null ) and ([C4].[Value] < [P].[Value]) then dbo.SC(' ')

			when  [C].[CheckGuid] is not null then dbo.SC('') 
			when  [C2].[CheckGuid] is not null then dbo.SC('') 
		end as [State],
		[P].[Note3],
		[P].[Note],
		1 as [Print],
		[P].[Guid]
	From
		[vwChecks] [P]
		inner join [LinkCheckContract] LL on LL.ParentGuid = P.Guid
		left join vwElectricityBill [L] on [L].[Guid] = [LL].[ContractGuid]
		left join [vwChecksCollection] [C] on [C].[CheckGuid] = [P].[Guid] and [C].[Kind] = 0
		left join [vwChecksCollection] [C1] on [C1].[CheckGuid] = [P].[Guid] and [C1].[Kind] = 1
		left join [vwChecksCollection] [C2] on [C2].[CheckGuid] = [P].[Guid] and [C2].[Kind] = 2
		left join [vwChecksCollection] [C3] on [C3].[CheckGuid] = [P].[Guid] and [C3].[Kind] = 3
		left join (
						Select 
							[CheckGuid],
							Sum([Value]) as [Value] 
						From
							[ChecksPartialCollection] 
						Group By
							[CheckGuid]
					) [C4] on [C4].[CheckGuid] = [P].[Guid]
 	where
 		(LL.[ContractGuid] = @ContractGuid or @ContractGuid = 0x0)
--		and [P].[Number] = 2905
 	Order By 
 		[P].[dueDate], [P].[No]

GO

SET ANSI_NULLS, QUOTED_IDENTIFIER ON
GO

Create View [vwTreeBranch]
 
as
	Select
		[A].[Number], [A].[Guid], [A].[Code], [A].[ParentGuid], [A].[Note], [A].[Address], [A].[Phone], [A].[LtnName],
		Case when (dbo.FnGetLangauge(@@spid) = 1) and (Isnull([A].[LtnName],'') <> '') then [A].[LtnName] else [A].[Name] end as [Name], 
		case when [A].[ParentGuid] is Not Null then [A].[ParentGuid] else 0x0 end as [Parent],
		Isnull([S].[NSons],0) as [NSons]
	From 
		[vbBranch] [A]
		left join (Select 
						Count([Number]) as [NSons], 
						[ParentGuid] as [SGuid]
					From 
						[Branch]
					Group By
						[ParentGuid]
					) [S] On [S].[SGuid] = [A].[Guid]

GO

SET ANSI_NULLS, QUOTED_IDENTIFIER ON
GO

Create Procedure [dbo].[PrcUpDateIncAccountDetailAcForOneAccount]
(
	@AccountGuid uniqueidentifier = '375AAD94-0B6B-456A-BFA1-6DAC550C96A2',
	@IncAccountGuid uniqueidentifier = '87D2C3B2-4B45-4D7A-8311-1F00608104DC'
)
 
AS

	if 1 = 2
	Select 
			ac.Code,
			ac.Name,
			dc.*
	From
		fnGetAccountParents(@AccountGuid) A
		inner join Account ac on ac.Guid = a.Guid
		left join [IncAccountDetailAc] dc on dc.[AccountGuid] = a.Guid
	where
		dc.Number is Not Null
					
	Declare @Rf int
	
	Delete [IncAccountDetailAc]
	where
		AccountGuid = @AccountGuid	
		
	Set @RF = @@Rowcount
		
	if Not exists(
	Select 
		* 
	From 
		[IncAccountDetailAc] d
		inner join dbo.fnGetAccountParents(@AccountGuid) ac on ac.Guid = d.AccountGuid
	where
		d.parentGuid = @IncAccountGuid)
	
	insert into [IncAccountDetailAc]
	([Number],[ParentGuid],[AccountGuid])
	Select
		(Select isNull(Max(Number) ,0) + 1 from [IncAccountDetailAc] where ParentGuid = @IncAccountGuid),
		@IncAccountGuid,
		@AccountGuid
	
	Set @RF = isNull(@RF,0) + @@Rowcount	
	
	if (isNull(@Rf,0) <> 0)
	exec [PrcGetIncAccountListDetail]
	

GO

SET ANSI_NULLS, QUOTED_IDENTIFIER ON
GO

create  PROCEDURE Gold_prcBackup
	@DbName varchar(128) = 'Order22',
	@Path varchar(4000) = 'C:\',
	@Path2 varchar(4000) = ''

 
AS

	IF RIGHT(@Path, 1) <> '\' 
	SET @Path = @Path + '\'	

	SET @Path = @Path + @DbName

	Declare @Disk varchar(4000),
			@SQL varchar(4000)
	SET @Disk = ''''+ @Path +'_'+ 
				Cast(DatePart(dd, GetDate()) AS varchar(2)) + '_' +
				Cast(DatePart(mm, GetDate()) AS varchar(2)) + '_' +
				Cast(DatePart(yyyy, GetDate()) AS varchar(4)) + '_'+

				Cast(DatePart(hh, GetDate()) AS varchar(2)) + '_' +
				Cast(DatePart(mi, GetDate()) AS varchar(2)) +'.bak' + ''''

	--Print(@Disk)
	SET @SQL = 'BACKUP DATABASE' +' '+ @DbName + ' TO DISK = '+ @Disk
        print (@SQL)
	Exec(@SQL)

	---- Backup2
	IF (@path2 <> '')
	BEGIN
		IF (RIGHT(@Path2, 1) <> '\' )
		SET @Path2 = @Path2 + '\'	
	
		SET @Path2 = @Path2 + @DbName
	
		SET @Disk = ''''+ @Path2 +'_'+ 
					Cast(DatePart(dd, GetDate()) AS varchar(2)) + '_' +
					Cast(DatePart(mm, GetDate()) AS varchar(2)) + '_' +
					Cast(DatePart(yyyy, GetDate()) AS varchar(4)) + '_'+
	
					Cast(DatePart(hh, GetDate()) AS varchar(2)) + '_' +
					Cast(DatePart(mi, GetDate()) AS varchar(2)) +'.bak' + ''''
	
		--Print(@Disk)
		SET @SQL = 'BACKUP DATABASE' +' '+ @DbName + ' TO DISK = '+ @Disk +'WITH DESCRIPTION ='''' ,COMPRESSION,init'
	        print (@SQL)
		Exec(@SQL)
	END


GO

SET ANSI_NULLS, QUOTED_IDENTIFIER ON
GO

Create Procedure [dbo].[PrcPrintOfferPrice]
(
	@Guid uniqueidentifier = '2BE4EC1F-DF73-4B91-A4A7-91C8C07A9B6F'
)
 
as
	Select
		*
	From
		[vwOfferPrice]
	where
		[Guid] = @Guid

	Select 
		* 
	From 
		[offerPricefee]
	where
		[ParentGuid] = @Guid

	Select 
		* 
	From 
		[offerPriceins]
	where
		[ParentGuid] = @Guid
		

GO

SET ANSI_NULLS, QUOTED_IDENTIFIER ON
GO

Create Procedure [dbo].[PrcMatProfitt]
(
	@MatGuid uniqueidentifier = 0x0,
	@GroupGuid uniqueidentifier = 0x0,
	@StoreGuid uniqueidentifier = 0x0,
	@CostGuid uniqueidentifier = 0x0,
	@Class varchar(255) = '',
	@Unit int = 2,
	@BillPost int = 2,

	@CurrencyGuid uniqueidentifier = 0x0,
	@CurrencyVal Float = 1,
	@PriceMode int = 0,
	@SpecificPrice int = 0,
	@TotalOnly bit = 0,
	@ActiveDate bit = 0,
	@Date1 DateTime = '1/1/2007',
	@Date2 DateTime = '1/1/2016'
)
 
as
	exec [dbo].[PrcMatBillsDetail] @GroupGuid ,@MatGuid ,@StoreGuid,@CostGuid,@Class,@Unit,@BillPost,@CurrencyGuid, @Currencyval, @ActiveDate,@Date1,@Date2	
	
	Create Table #MatPrice
	(
		[MatGuid] uniqueidentifier,
		[Price] Float
	)
	
	insert into #MatPrice
	Select F.[MatGuid], Price 
	from 
		dbo.[FnMatPrice] (@CurrencyGuid, @Currencyval, @unit,@PriceMode, @SpecificPrice) F

	--Select * from #MatPrice

	Select 
		BuNumber,
		Bu.BuDate,
		bu.BuPayTypeStr,
		Bu.BtName COLLATE database_default as [BtName],
		bu.GroupName COLLATE database_default as [GroupName],
		MatCode COLLATE database_default as [MatCode],
		Bu.MatName COLLATE database_default as [MatName],
		Bu.Qty * -[BtInOut] as Qty,
		bu.Unit COLLATE database_default as [Unit],
		pr.Price * -[BtInOut] as CostPrice,
		Bu.Qty * pr.Price * -[BtInOut] as TotalCostPrice,
		Bu.Price * -[BtInOut] as Price,
		Bu.Qty * Bu.Price * -[BtInOut] as TotalPrice,
		(isNull(Bu.Price,0) - isNull(pr.Price,0)) * -[BtInOut]  as [Profitt],
		(isNull(Bu.Price,0) - isNull(pr.Price,0)) * Bu.Qty * -[BtInOut] as [TotalProfitt],
		MyName COLLATE database_default as [MyName],
		BuCurrencyVal,
		bu.BuNote COLLATE database_default as [BuNote],
		bu.Note COLLATE database_default as [Note],
		bu.BillPost,
		bu.cuName COLLATE database_default as [cuName],
		StCode COLLATE database_default as [StCode],
		bu.StName COLLATE database_default as [StName],
		BuClass COLLATE database_default as [BuClass],
		AcCode COLLATE database_default as [AcCode],
		AcName COLLATE database_default as [AcName],
		CoCode COLLATE database_default as [CoCode],
		CoName COLLATE database_default as [CoName],
		Bu.Class COLLATE database_default as [Class],
		bu.MatGuid,
		Bu.BuGuid,
		Bu.Kind,
		MatCode COLLATE database_default as SortMatCode,
		[BtInOut],
		0 as [SortTag]
	into #MatProfitt
	from 
		[MatBillsDetail] bu
		inner join [Resource] [R] on R.Guid = Bu.TypeGuid and R.Spid = @@Spid 
		left join  #MatPrice pr on pr.MatGuid = bu.MatGuid
	
	insert into #MatProfitt
	([GroupName],[MatName] ,[Qty],CostPrice, TotalCostPrice,Price,[TotalPrice],[TotalProfitt], [SortTag], [Profitt],MatGuid,SortMatCode)
	Select
		dbo.sc('') as [GroupName],
		[MatName],
		SUM(Qty),
		Sum((TotalCostPrice))/ Case when SUM(Qty) <> 0 then SUM(Qty) end as CostPrice,
		Sum(TotalCostPrice ),
		Sum(TotalPrice) / Case when SUM(Qty) <> 0 then SUM(Qty) end as Price,
		Sum([TotalPrice]),
		SUM([TotalProfitt]),
		1,
		Sum([TotalProfitt]) / Case when SUM(Qty) <> 0 then SUM(Qty) end as [Profitt],
		MatGuid,
		SortMatCode
	from
		#MatProfitt
	Group By
		[MatName],MatGuid, SortMatCode
		
	
	insert into #MatProfitt
	([GroupName],[MatName] ,TotalCostPrice,[TotalPrice],[TotalProfitt], [SortTag], [Profitt])
	Select
		dbo.sc('') as [GroupName],
		'',
		Sum(TotalCostPrice) ,
		Sum([TotalPrice]),
		SUM([TotalProfitt]),
		2,
		Sum([TotalProfitt]) / Case when SUM(Qty) <> 0 then SUM(Qty) end as [Profitt]
	from
		#MatProfitt
	where
		[SortTag] = 0
		
	Select
		*
	from
		#MatProfitt
	where
		[SortTag] <> 0 and @TotalOnly = 1 or @TotalOnly = 0
	order by
		Case when SortMatCode is Null then 1 else 0 end ,SortMatCode ,[SortTag], BuDate, BuNumber 
		
		

GO

SET ANSI_NULLS, QUOTED_IDENTIFIER ON
GO

Create Trigger [TRG_SetUser_LeaseApartment]
on [LeaseApartment]
 
For insert
As
	update [LeaseApartment] Set [userGuid] = (Select Top  1 [UserGuid] From CurrentUsers where [spid] = @@spid)
	From
		[LeaseApartment] [H],[inserted] [I]
	where [H].[Guid] = [I].[Guid]

GO

SET ANSI_NULLS, QUOTED_IDENTIFIER ON
GO
Create Function dbo.[FnMatPrice] 
(
	@CurrencyGuid uniqueidentifier, 
	@CurrencyVal Float,
	@Unit int = 0,
	@PriceMode int = 2,
	@SpecificPrice int = 0
)
returns @Tbl Table (
						
						[MatGuid]  [uniqueidentifier] ,
						[Price] [Float]
					)
 
as
begin
	if @CurrencyVal = 0
	Set @CurrencyVal = 1
	

	if @PriceMode = 0 or @PriceMode = 1 or @PriceMode = 2
	begin
		Insert Into @Tbl
		Select
			Mt.Guid,
			Case 
				when @PriceMode = 0 then Mt.[MaxPrice]
				when @PriceMode = 1 then Mt.AvgPrice
				when @PriceMode = 2 then Mt.LastPrice
			end 
			*
			Case -- 
				when Mt.[CurrencyGuid] = @CurrencyGuid then 1
				else
				Mt.Currencyval / @Currencyval 
			end
			*
			Case when @Unit = 1 then 1
				 when @Unit = 2 then mt.unityFact2
				 when @Unit = 3 then mt.unityFact3
				 when @Unit = 0 then 
									Case when mt.[DefUnity] = 1 then 1
										 when mt.[DefUnity] = 2 then mt.unityFact2
										 when mt.[DefUnity] = 3 then mt.unityFact3
									end
			end
			as [Price]
		From
			mat as Mt
			--inner join #MatDis Mt on Mt.MatGuid = D.Guid
	end
	
	if @PriceMode = 3
	begin
		Insert Into @Tbl
		Select
			mt.Guid,
			Case 
				when @PriceMode = 3 then 
											Case when @Unit = 1 then p.Price1
												 when @Unit = 2 then p.Price2
												 when @Unit = 3 then p.Price3
												 when @Unit = 0 then 
																	Case when mt.[DefUnity] = 1 then p.Price1
																		 when mt.[DefUnity] = 2 then p.Price2
																		 when mt.[DefUnity] = 3 then p.Price3
																	end
											end
			end 
			*
			Case 
				when Mt.[CurrencyGuid] = @CurrencyGuid then 1
				else
				Mt.Currencyval / @Currencyval 
			end
			as [Price]
		From
			Mat Mt 
			left join [MatUnitsPrice] P on p.matGuid = mt.Guid and p.Number = @SpecificPrice + 1
	end

	Return
end

GO

SET ANSI_NULLS, QUOTED_IDENTIFIER ON
GO
Create View vwTrans
 
as
	Select
		[b].[Number] as [BuNumber], 		[b].[Guid] as [BuGuid], 		[b].[SecLvl] as [BuSecLvl], 		[b].[TypeGuid] as [BuTypeGuid], 		[b].[Date] as [BuDate], 		[b].[CurrencyGuid] as [BuCurrencyGuid], 		[b].[CurrencyVal] as [BuCurrencyVal], 		[b].[PayType] as [BuPayType],		Case when [b].[PayType] = 0 then '' 			 when [b].[PayType] = 1 then '' 		end as [BuPayTypeStr],		[b].[StoreInGuid] as [BuStoreInGuid], 		[b].[StoreOutGuid] as [BuStoreOutGuid], 		[b].[CostInGuid] as [BuCostInGuid], 		[b].[CostOutGuid] as [BuCostOutGuid], 		[b].[BranchGuid] as [BuBranchGuid], 		[b].[Class] as [BuClass], 		[b].[Note] as [BuNote], 		[b].[isPosted] as [BuisPosted],
		Case when b.isPosted = 0 then dbo.SC(' ')
			 when b.isPosted = 1 then dbo.SC('')
		end as [TransPost],
		
		[t].[Number] as [BtNumber], 		[t].[Guid] as [BtGuid], 		[t].[SecLvl] as [BtSecLvl], 		[t].[Code] as [BtCode], 		[t].[Name] as [BtName], 		[t].[LtnName] as [BtLtnName], 		[t].[Menu] as [BtMenu], 		[t].[LtnMenu] as [BtLtnMenu], 		[t].[ShortCut] as [BtShortCut], 		[t].[DefPrintPath] as [BtDefPrintPath], 		[t].[Note] as [BtNote], 		[t].[Color1] as [BtColor1], 		[t].[Color2] as [BtColor2], 		[t].[PostToStores] as [BtPostToStores], 		[t].[PostToStoresAuto] as [BtPostToStoresAuto], 
		
		[m].[Code] as [MyCode], 		[m].[LtnCode] as [MyLtnCode], 		[m].[Name] as [MyName], 		[m].[LtnName] as [MyLtnName], 		[m].[CurrencyVal] as [MyCurrencyVal], 		
		[StIn].[Code] as [StCodeIn], 		[StIn].[Name] as [StNameIn], 		[StIn].[LtnName] as [StLtnNameIn], 		
		[StOut].[Code] as [StCodeOut], 		[StOut].[Name] as [StNameOut], 		[StOut].[LtnName] as [StLtnNameOut], 		[CoIn].[Code] as [CoCodeIn], 		[CoIn].[Name] as [CoNameIn], 		[CoIn].[LtnName] as [CoLtnNameIn],		
		[CoOut].[Code] as [CoCodeOut], 		[CoOut].[Name] as [CoNameOut], 		[CoOut].[LtnName] as [CoLtnNameOut]	From
		[vbTrans] [B]
		inner join TransType [t] on [t].Guid = [b].TypeGuid
		inner join Currency [m] on [m].Guid = [b].CurrencyGuid
		inner join vwStore [stIn] on [stIn].Guid = [b].StoreInGuid
		inner join vwStore [stOut] on [stOut].Guid = [b].StoreOutGuid
		left join vwCost [CoIn] on [b].Guid = [b].CostInGuid
		left join vwCost [CoOut] on [b].Guid = [b].CostOutGuid
		left join Branch [br] on [br].Guid = [b].BranchGuid

GO

SET ANSI_NULLS, QUOTED_IDENTIFIER ON
GO
Create Procedure [CreateChildCost]
(
	@ChildCostGuid uniqueidentifier = 0x0,
	@ParentGuid uniqueidentifier = '{4548FDB3-7054-4D3D-93C6-D6E17641D677}',
	@Name Varchar(256) = ' 1',
	@LtnName Varchar(256) = ''
)
 as
	Set NoCount On
	EXEC PrcInsertSC '  '
	Declare @Ms Varchar(256)
	Set @Ms = dbo.SC('  ')

	if exists(Select Top 1 * from Cost
	where [Name] = @Name and [ParentGuid] = @ParentGuid)
	begin
		RAISERROR (@Ms, 16, 1)
	end

	DECLARE @NewCode  Varchar(256)
			

	if @ChildCostGuid = 0x0
	Set @ChildCostGuid = Newid()
	
	Create Table #CostCode
	(Code varchar(255))
	Delete #CostCode
	insert into #CostCode
	exec PrcCalcMaxCostcode @ParentGuid 

	Set @NewCode = (Select Code from #CostCode)
	------
	insert into [Cost]
	([Number],SecLvl,[Guid],[Name],[LtnName],[Code],[Note],[ParentGUID])
	Select
	(Select isnull(Max([Number]),0)+ 1 from [Cost]) as [Number]
	,0
	,@ChildCostGuid as [Guid]
	,@Name as [Name]
	,@LtnName as [LtnName]
	,@NewCode-- + dbo.FnFormatNumber (@Count, 4) as [Code]
	,''
	,@ParentGuid as [ParentGUID]
  
	
	Select * from [Cost] where [Guid] = @ChildCostGuid	

GO

SET ANSI_NULLS, QUOTED_IDENTIFIER ON
GO
Create View vwMaintenanceContractVisitFull
 
as
		
	Select
		Case when isNull(WithOutContract,0) = 1 then dbo.SC(' ') else C.TypeName end as TypeName,
		C.ContractNo,
		Cu.Name as CustName,
		'['+C.TypeName+' '+C.ContractNo +'] '+ V.No as VisitNo,
		V.CustGuid as CustomerGuid,
		isNull(C.TypeGuid,0x0) as TypeGuid,
		v.*,
		Case 
			when execState = 0 then dbo.SC('  ')
			when execState = 1 then dbo.SC(' ')
			else dbo.SC(' ')
		end as execStateStr
	From
		[vwMaintenanceContractVisit] [V]
		left join [vwCustomer] Cu on Cu.Guid = V.CustGuid
		left join [vwMaintenanceContract] C on C.Guid = V.contractGuid
		

GO

SET ANSI_NULLS, QUOTED_IDENTIFIER ON
GO

Create Procedure [PrcTestRentparkingFromAccumulateparking]
(
	@ContractGuid uniqueidentifier = 'EFAF9774-48B8-4680-BE63-6B3D9112271A',
	@parkingGuid uniqueidentifier = '90DBB8C2-DFC0-4E6F-86FD-0D8ECEC5E607',
	@Date1 DateTime = '1/1/2010',
	@Date2 DateTime = '10/1/2010'
)
 
as
	Select
		[L].*,
		Case when [ContractFinish] = 0 then [ToDate] else [ContractFinishDate]  end as [EndDate]
	into #Contract
	From
		[ParkingContract] [L]
		inner join [Accumulateparking] [A] on [A].[ParentGuid] = [L].[ParkingGuid]
	where 
		([A].[parkingGuid] = @parkingGuid)		
		and ([L].[Guid] <> @ContractGuid)

--	Select * from #Contract
		
	Select 
		[L].[Number],
		[T].[Name] as [ContractName],
		[L].[FromDate],
		[L].[ToDate],
		[L].[Contractkind],
		[L].[ParkingGuid],
		[L].[Guid]
	From 
		#Contract [L] 
		inner join [ContractType] [T] On [T].[Guid] = [L].[TypeGuid]
		inner join [Accumulateparking] [A] on [A].[ParentGuid] = [L].[ParkingGuid]
	where 
		([A].[parkingGuid] = @parkingGuid)		
		and 
		(
				(
					L.[Contractkind] = 5
					and	(
							([FromDate] <= @Date1 )
						 or ([FromDate] <= @Date2 )
						)
				)
				or 
				(
					L.[Contractkind] = 4
					and	([ContractFinish] = 0 )
				)

			)
			

GO

SET ANSI_NULLS, QUOTED_IDENTIFIER ON
GO
Create View [vwElectricityCachPayment]
 
as
	Select
		[C].[ContractGuid],
		[H].[HNumber] as [Number],
		[H].[DNumber],
		[H].[HDate] as [Date],
		[H].[DCredit] as [Value],
		[H].[CurrencyGuid],
		[H].[CurrencyName] as [Currency],
		[H].[CurrencyVal],
		[H].[HNote],
		[H].[DNote],
		[h].AcGuid,
		1 as [Print],
		[H].[HGuid] as [Guid]
	from 
		[ElectricityCachPayment] [C]
		inner join [vwDetailEntry] [H] on [H].[HGuid] = [C].[EntryGuid] 
	where
		[H].[DCredit] <> 0


GO

SET ANSI_NULLS, QUOTED_IDENTIFIER ON
GO
Create Procedure [PrcReNumberHEntry]
(
	@FirstEntryNum int = 0
)
 
as
	Create Table #R
	(
		[Id] int identity(1,1),
		[Guid] uniqueidentifier
	)
	
	Insert into #R
	([Guid])
	Select
		[Guid]
	From
		Hentry
	where 
		Number > 1
	Order By
		[Date], [Number]

	Update Hentry
	Set [Number] = [R].[Id] + IsNull(@FirstEntryNum,0) +1 
	From
		[Hentry] [H]
		inner join [#R] [R] on [R].[Guid] = [H].[Guid]


GO

SET ANSI_NULLS, QUOTED_IDENTIFIER ON
GO

Create view [vwBuilding]
 
as
	SELECT 
		[Number], 
		[Guid], 
		[Name] as [ArName],
		Case when (dbo.FnGetLangauge(@@spid) = 1) and (Isnull([LtnName],'') <> '') then [LtnName] else [Name] end as [Name],
		[Emirate], 
		[Area], 
		[Suburb], 
		[Street], 
		[FloorCount], 
		[ApartmentCount], 
		[ApartmentCountOfFloor], 
		[ShopCount], 
		[Note], 
		[LtnName],
		[OpOwner],
		[OwnerName],
		[CommissionPercent],
		[BuildingNo],
		[BondType],
		[BondNo],
		[BondDate],
		[PieceNo],
		[BasinNo],
		[BuildingCode],
		[LtnEmirate],
		[LtnArea],
		[LtnSuburb],
		[LtnStreet],
		[OwnerGuid],
		[BankName],
		[BankAccCode],
		[ShowInContract],
		[ShowInReport],
		[AccountCommIncomeGuid],
		[AcCommissionFromOwnerGuid],
		[CashAccountGuid],
		[RentInfoGuid],
		CostGuid
	FROM 
		[vbBuilding]

GO

SET ANSI_NULLS, QUOTED_IDENTIFIER ON
GO
Create View vwMaintenanceContractVisitWorker
 
as
	Select
		C.*,
		W.Name
	From
		[MaintenanceContractVisitWorker] [C]
		inner join MaintenanceWorker [W] on [W].Guid = [C].WorkerGuid

GO

SET ANSI_NULLS, QUOTED_IDENTIFIER ON
GO

Create Procedure [dbo].[PrcMaintenanceContractVisitCreateEntry]
(
	@Guid uniqueidentifier = '05F5C8A8-4349-48D6-9F91-28C397C518C9'
)
 
as
	Set nocount on 
	Declare @CeNumber Int
	Select
		@CeNumber = Number
	From
		HEntry
	where
		Guid = @Guid
		
	if isNull(@CeNumber,0) = 0
	Set @CeNumber = (Select isNull(MAX(Number),0) + 1 From HEntry)

	Delete
		HEntry
	where
		Guid = @Guid
		
	if Not exists(Select Top 1 Guid from MaintenanceContractVisit where Guid = @Guid and CreateEntry = 1) return
	
	Declare @AccountGuid uniqueidentifier, 
			@ObverseAcGuid uniqueidentifier
			
		

	Insert Into [HEntry]
	([Guid],[SecLvl],[Number],[Date], [CurrencyGuid], [CurrencyVal], [Note], [ParentKind], [BranchGuid], [IsPosted])
	Select
		@Guid,
		[SecLvl],
		@CeNumber,
		[Date],
		[CurrencyGuid],
		[CurrencyVal],
		[EntryNote],
		161, 
		Null,
		1
	From
		MaintenanceContractVisit
	where
		Guid = @Guid

	Declare @DetailNum Int
	Set @DetailNum = 0

	Insert into [DEntry]
 	([ParentGuid],[Number],[AcGuid],[Debit],[Credit],[CurrencyGuid],[CurrencyVal],[CostGuid],[ObverseAcGuid],[Note])
	Select
		@Guid,
		@DetailNum,
		FeeAccountGuid,
		(Select Sum(Fee *  HourCount) From MaintenanceContractVisitWorker where ParentGuid =@Guid),
		0,
		A.CurrencyGUID,
		A.CurrencyVal,
		EntryDebitCostGuid,
		Null,
		A.[EntryNote]
	From
		MaintenanceContractVisit A
	where
		A.[Guid] = @Guid
				
	Set @DetailNum = @DetailNum + 1
	
	Insert into [DEntry]
 	([ParentGuid],[Number],[AcGuid],[Debit],[Credit],[CurrencyGuid],[CurrencyVal],[CostGuid],[ObverseAcGuid],[Note])
	Select
		@Guid,
		@DetailNum,
		MW.accountGuid,
		0,
		W.Fee * W.HourCount,
		A.CurrencyGUID,
		A.CurrencyVal,
		A.[EntryCreditCostGuid],
		FeeAccountGuid,
		A.[EntryNote]
	From
		MaintenanceContractVisit A
		inner join MaintenanceContractVisitWorker W on W.ParentGuid = A.Guid
		inner join MaintenanceWorker MW on MW.Guid = W.WorkerGuid
	where
		A.[Guid] = @Guid

	Delete [DEntry] where ParentGuid = @Guid and (ISNULL(Debit, 0) + ISNULL(Credit, 0) = 0)
	Delete [DEntry] where ParentGuid = @Guid and AcGuid Is Null

	update HEntry set IsPosted = 1 where Guid = @Guid
	--Select * from [MaintenanceContractVisit] where Guid = @Guid
	--Select * from [DEntry] where parentGuid = @Guid
			

GO

SET ANSI_NULLS, QUOTED_IDENTIFIER ON
GO
Create Function dbo.fnDateOnly(@Date DateTime)
returns DateTime
 
as
begin
	return Cast(Cast(DatePart(Year, @Date) as Varchar(10)) +'/'+ Cast(DatePart(Month, @Date) as Varchar(10))+'/'+ Cast(DatePart(Day, @Date) as Varchar(10)) as Datetime)
end


GO

SET ANSI_NULLS, QUOTED_IDENTIFIER ON
GO

Create Procedure dbo.[PrcPrintApproachLeaveContract]
 
as
	Declare @Check Bit,
			@NotCheck Bit
	Set @Check = 1
	Set @NotCheck = 0

	Select 
		[ContractNo],
		[B].[Name] as [BuildingName],
		[B].[ltnName] as [BuildingltnName],
		[B].[ArName] as [BuildingArName],
		Case when Isnull([A].[No], '') <> '' then [A].[No] else [S].[No] end as [No],
		Case when Isnull([A].[No], '') <> '' then dbo.SC('') else dbo.SC('') end as [FlatKind],
		Case when Isnull([A].[No], '') <> '' then [A].[FloorNo] else Null end as [Floor],
		[cu].[Name] as [CustomerName],
		[cu].[ltnName] as [CustomerltnName],
		[cu].[arName] as [CustomerArName],
		[FromDate],
		[ToDate],
		[LeaveDate],
		DateDiff(Day, GetDate(), [LeaveDate]) as [Datediff],
		[LeaseKind],
		[L].[Note2],
		Null as [AlertPrint],
		[L].[Guid]
	From
		[vbLeaseApartment] [L]
		inner join [vwBuilding] [B] On [L].[BuildingGuid] = [B].[Guid]
		inner join [vwCustomer] [cu] on [cu].[Guid] = [L].[CustomerGuid]
		left join [vwApartment] [A] On [A].[Guid] = [L].[ApartmentGuid]
		left join [vwShop] [S] On [S].[Guid] = [L].[ApartmentGuid]
		inner join [Resource] [R] on [R].[Guid] = [L].[Guid] and [Spid] = @@Spid and [R].[Kind] = 2
	Order By 
		[B].[Name],
		DateDiff(Day, GetDate(), [LeaveDate]),
		[ContractNo],
		[Leave]

GO

SET ANSI_NULLS, QUOTED_IDENTIFIER ON
GO

Create Procedure [PrcGetParkingWallet]
(
	@Guid uniqueidentifier = '369CF34D-31AA-4381-BBCA-78E27197A9AA'
)
 
as
	Select 
		[B].[Name] as [Building],
		[F].[No] as [Parking],
		[W].[MainCost],
		[Expense],
		[W].[BeginDate],
		[C].[SaleDate],
		DATEDIFF(Day,[W].[BeginDate], [C].[SaleDate]) as [DayCount],
		[C].[SaleValue] * Case when [Wl].[CurrencyGuid] <> [C].[CurrencyGuid] then [C].[CurrencyVal] / [Wl].[CurrencyVal] else 1 end as [SaleValue],
		[C].[SaleValue] * Case when [Wl].[CurrencyGuid] <> [C].[CurrencyGuid] then [C].[CurrencyVal] / [Wl].[CurrencyVal] else 1 end
		-
		( isnull([w].[Expense],0) + [W].[MainCost] )
		as  [Profit],
		[W].[BuildingGuid],
		[W].[ParkingGuid]
	From 
		[wallet] [Wl]
		inner join [Parkingwallet] [W] on [W].[ParentGuid] = [Wl].[Guid]
		inner join [vwBuilding] [B] on [B].[Guid] = [W].[BuildingGuid]
		inner join [vwParking] [F] on [F].[Guid] = [w].[ParkingGuid]
		left join (
					Select 
						[ParkingGuid],
						[FromDate] as [SaleDate],
						[Rent] as [SaleValue],
						[CurrencyGuid],
						[CurrencyVal]
					From
						[vwParkingContract] 
					where 
						[ContractKind] = 5
					) [C] on [C].[ParkingGuid] = [W].[ParkingGuid]
	where
		[W].[ParentGuid] = @Guid
	Order By
		[W].[Number]

GO

SET ANSI_NULLS, QUOTED_IDENTIFIER ON
GO

Create view [vwShowSupplier]
 
as
	SELECT 
		[Number], 
		[Guid], 
		[Name] as [ArName],
		[LtnName], 
		Case when (dbo.FnGetLangauge(@@spid) = 1) and (Isnull([LtnName],'') <> '') then [LtnName] else [Name] end as [Name],  
		[Nationality], 
		[Profession], 
		[PassportNO], 
		[Domicile], 
		[Security], 
		[PhoneJob], 
		[Mobile], 
		[Note], 
		[AcGuid],
		[InsuranceAccountGuid]
	FROM 
		[Customer]
	where
		[CkHideInSearch] = 0
		and CardKind = 1

GO

SET ANSI_NULLS, QUOTED_IDENTIFIER ON
GO
Create Procedure [PrcTransfer_MaintenanceContract]
(
	@RoKind int = 2,
	@ToDataBaseName Varchar(256) = 'AR1',
	@UntilDate Datetime = '2015-12-31',
	@BeginDate Datetime = '2016-1-1',
	@RoundContractWithCheckNotCollection bit = 0
)
 
as
	if (@RoKind = 1) Return --  
	
	Declare @V Varchar(8000)
	
	EXEC PrcDeleteTable 'MaintenanceContract',@ToDataBaseName
	EXEC PrcDeleteTable 'MaintenanceItem',@ToDataBaseName
	EXEC PrcTransferTable  'MaintenanceItem',@ToDataBaseName
	
	Set @V = '
			where 
				[ContractFinish] = 0'
				
	if (@RoKind = 2) --    
	Set @V = @v + '
	or EditDate >='+''''+CAST(@UntilDate as varchar(255))+''''
				
	if (@RoundContractWithCheckNotCollection = 1) --       
	Set @V = @v + '
	or ([Guid] in (Select ContractGuid from vwChecksCollectionState where [IsCollection] = 0))'

	EXEC PrcTransferTable  'MaintenanceContract',@ToDataBaseName, @V
							
	
	Set @V = '
	Alter Table '+@ToDataBaseName+'..[MaintenanceContract] Disable Trigger All'
	exec (@v)

	--        
	Set @V = '
	UpDate '+@ToDataBaseName+'..[MaintenanceContract] Set [IsRounded] = 1 where EditDate <'+''''+CAST(@UntilDate as varchar(255))+''''
	exec(@V)


	--        
	Set @V = '
	UpDate '+@ToDataBaseName+'..[MaintenanceContract] Set [IsRounded] = 1 
	From
		'+@ToDataBaseName+'..[MaintenanceContract] L
		inner join HEntry H on L.Guid = H.Guid 
	where H.Date <'+''''+CAST(@UntilDate as varchar(255))+''''
	Print(@V)
	exec(@V)

 	Set @V = 'Update '+@ToDataBaseName+'..[MaintenanceContract] Set EditDate = '''+CAST(@BeginDate as VARchar(20))+'''where [IsRounded] = 1 '
	exec(@V)

	Set @V = '
	Alter Table '+@ToDataBaseName+'..[MaintenanceContract] Enable Trigger All'
	exec (@v)

	 
	--
	Set @V = '
	inner join '+@ToDataBaseName+'..MaintenanceContract L on L.Guid = [Tb].[ParentGuid]
	inner join '+@ToDataBaseName+'..Cost Ac on Ac.Guid = [Tb].[CostGuid]
	inner join '+@ToDataBaseName+'..vwAllRealty RL on RL.Guid = [Tb].RealtyGuid
	'
	EXEC PrcTransferTable  'RealtyMaintenanceContract',@ToDataBaseName, @V


	-- 
	Set @V = '
	inner join '+@ToDataBaseName+'..MaintenanceContract L on L.Guid = [Tb].[ContractGuid]'
	EXEC PrcTransferTable  'MaintenanceContractMaintenanceItem',@ToDataBaseName, @V
	
	
	
	Set @V = '
	exec '+@ToDataBaseName+'..ReNumberTableType
		''MaintenanceContract'',
		''[TypeGuid]'',
		''Number, FromDate'',
		''uniqueidentifier'',
		''''			
	'
	exec(@V)
	
        	
	--  
	Set @V = '
	Delete '+@ToDataBaseName+'..[Resource]'
	exec (@v)
	
	Set @V = '
	insert into '+@ToDataBaseName+'..[Resource]
	([Guid], [Kind])
	Select Guid, 1 from '+@ToDataBaseName+'..MaintenanceContractType'
	exec (@v)
	
	Set @V = '
	exec '+@ToDataBaseName+'..[PrcReCreateMaintenanceContract] 0,0,0,0,0,0,0 '
	--Sql.Add('exec PrcReCreateContractFlatShopEntry :Date1, :Date2, :ActiveDate, :Datewith, :Num1, :Num2, :ActiveNum, :MaxDate');

	Print @v
	exec (@v)



GO

SET ANSI_NULLS, QUOTED_IDENTIFIER ON
GO

Create Procedure [PrcAddUser]
(
	@UserName Varchar(256) =''
)  as
	if IsNull(@UserName,'') = ''
	Select Top 1 @UserName = LoginName From Realty_Users where bAdmin = 1
	
	Delete [CurrentUsers]
	where	
		[spid] = @@Spid

	insert into [CurrentUsers]
	(
		[UserGuid],
		[Spid],
		[SecLvl],
		[Admin]
	)
	Select
		[Guid],
		@@Spid,
		[UserSecLvl],
		[BAdmin]
	from
		[Realty_Users]
	where
		[LoginName] = @UserName

GO

SET ANSI_NULLS, QUOTED_IDENTIFIER ON
GO
Create Procedure [PrcTestvwOldYearEntryFound]

as
	
	IF  not EXISTS (SELECT * FROM sys.views WHERE object_id = OBJECT_ID(N'[dbo].[vwOldYearEntryFound]'))
	begin
		--Delete OldYearConfig
		
		exec DropObject 'vwOldYearEntry'
		
		exec [dbo].[PrcCreateoldYearView]
	end
	

GO

SET ANSI_NULLS, QUOTED_IDENTIFIER ON
GO

Create Procedure dbo.PrcCalcMaxAssetsGroupcode
(
	@Guid uniqueidentifier = 'AB744D68-FFE3-4EA0-B7E5-D13668BC95D4'
)  as
	Declare @LenCode int
	Set @LenCode = (Select Len([Code]) From AssetsGroup where [Guid] = @Guid)

	Declare @Code Varchar(20)
	Set @Code = (Select [Code] From AssetsGroup where [Guid] = @Guid)

	Declare @LenNewCode int
	Set @LenNewCode = (
						Select 
							Len(Max([Code])) 
						From 
							[AssetsGroup] where ParentGuid =@Guid	
					) - @LenCode

--	Select @Code as Code, @LenCode as LenCode, @LenNewCode as LenNewCode

--	Select 
--			dbo.FnFormatNumber(Right(Cast(RIGHT(Max([Code]), Len(Max([Code])) - @LenCode)as int)+1 , @LenNewCode), @LenNewCode)
--	From [AssetsGroup] where ParentGuid =@Guid	
	 
	 declare @c varchar(256)
	 
	Select 
		@c = 
		Cast(
				dbo.FnFormatNumber(Right(Cast(RIGHT(Max([Code]), Len(Max([Code])) - @LenCode)as int)+1 , @LenNewCode), @LenNewCode) as Varchar(256)
			)
	From [AssetsGroup] where ParentGuid = @Guid	
	
	Select @Code + ISNULL(@C, '01') AS Code

GO

SET ANSI_NULLS, QUOTED_IDENTIFIER ON
GO
Create View [vwAssetsDepreciation]
 
as
	Select
		A.*,
		
		C.Name as CurrencyName,
		Co1.Code as  CreditCostCode,
		Co1.Name as  CreditCostName,
		Co2.Code as  DebitCostCode,
		Co2.Name as  DebitCostName,
		
		G.Name as AssetsGroupName,
		ast.Name as AssetsName,
		ar.Name as AssetsAreaName
	From
		[AssetsDepreciation] [a]
		inner join vwCurrency [C] on [C].Guid = [a].[CurrencyGUID]
		left join vwCost [Co1] on [Co1].Guid = [a].[CreditCostGUID]
		left join vwCost [Co2] on [Co2].Guid = [a].[DebitCostGUID]

		Left join vwAssetsGroup [G] on [G].Guid = [a].[AssetsGroupGuid]
		Left join vwAssets [ast] on [ast].Guid = [a].[AssetsGuid]
		Left join vwAssetsArea [ar] on [ar].Guid = [a].[AssetsAreaGuid]

GO

SET ANSI_NULLS, QUOTED_IDENTIFIER ON
GO

Create Procedure [PrcReminderReport]
(
	@UserGuid uniqueidentifier = 0x0,
	@Subject Varchar(256) = '',
	@Note Varchar(256) = '',
	@Finished int = 2,
	@Date1 DateTime = '1/1/2007',
	@Date2 DateTime = '1/1/2012'
)
 
as
	Select 
		[R].*
		,[U].[LoginName] as [UserName]
	From 
		[Reminder] [R]
		inner join [Realty_Users] [U] on [U].[Guid] = [R].[UserGuid]
	where
		([Subject] Like '%'+@Subject+'%')
		and ([Note] Like '%'+@Note+'%')
		and (dbo.fndateonly([RemindDate]) between @Date1 and @Date2)
		and ([U].[Guid] = @UserGuid or @UserGuid = 0x0)
		and (R.[Finished] = @Finished or @Finished = 2)

GO

SET ANSI_NULLS, QUOTED_IDENTIFIER ON
GO
Create View [vwServicesContractDetail]
 
as
	Select
		[Number],
		[ParentGuid],
		[TypeName],
		[Count],
		[Model],
		[WithChangePiece],
		[visitCount],
		Case when [VisitKind] = 0 then dbo.SC('') else dbo.SC('') end as [StrVisitKind],
		[VisitKind],
		[Note]
	From
		[ServicesContractDetail] [a]

GO

SET ANSI_NULLS, QUOTED_IDENTIFIER ON
GO

Create Function FnGetLangauge ( @Spid int = 57)
Returns int
 
as
begin
	Declare @Lang Int
	Select
		@Lang = isnull([Lang],0)
	From
		[TblLangauge]
	where
		[Spid] = @@Spid

	
	Return (isnull(@Lang, 0))	
	
end

GO

SET ANSI_NULLS, QUOTED_IDENTIFIER ON
GO

Create Procedure [dbo].[PrcMarkCashFromParkingContract]
(
	@Guid uniqueidentifier = 0x0,
	@Mark bit = 1
)
 
as
	update
		Secondary_Entry 
	Set
		Mark = @Mark
	from
		Secondary_Entry S
		left join [ContractParkingCachPayment] C on C.EntryGuid = S.Guid
	where
		[S].[ContractGuid] = @Guid 
		
	update
		HEntry
	Set
		Mark = @Mark
	from
		HEntry H
		inner join Secondary_Entry S on H.Guid = S.Guid
		left join [ContractParkingCachPayment] C on C.EntryGuid = S.Guid
	where
		[S].[ContractGuid] = @Guid 
	
		

GO

SET ANSI_NULLS, QUOTED_IDENTIFIER ON
GO

	Create View [vbRealty_Users]
	 
	as
		Select 
			[T].*
		From
			[Realty_Users] [T]
			inner join [CurrentUsers] [U] on ([u].[Seclvl] >= Isnull([T].[SecLvl],0)  or [u].[Admin] = 1) and [u].[spid] = @@Spid
GO

SET ANSI_NULLS, QUOTED_IDENTIFIER ON
GO

Create Procedure dbo.PrcCalcMaxAssetsCode
(
	@Guid uniqueidentifier = '9391B469-5E43-477E-AB04-7F7750DC8D7A'
)
 
as
	Declare @Code Varchar(20)
	Set @Code = (Select [Code] From AssetsGroup where [Guid] = @Guid)

	
	Declare @LenCode int
	Set @LenCode = (Select Len(Max([Code])) From Assets where [AssetsGroupGuid] = @Guid)

	
	Declare @LenNewCode int
	Set @LenNewCode = (
						Select 
							Len(Max([Code])) 
						From 
							[AssetsGroup] where Guid =@Guid	
					) 

	--Select @LenCode as LenCode, @LenNewCode as LenNewCode
	--return

--	Select 
--			dbo.FnFormatNumber(Right(Cast(RIGHT(Max([Code]), Len(Max([Code])) - @LenCode)as int)+1 , @LenNewCode), @LenNewCode)
--	From [AssetsGroup] where ParentGuid =@Guid	
	 
	declare @c varchar(256)
	 
	Select 
		@c = 
		Cast(
				dbo.FnFormatNumber(
										Right(
												Cast(
														RIGHT(Max([Code]), @LenCode - @LenNewCode) as int)+1 , 
														@LenNewCode
											  ), @LenCode - @LenNewCode
								  ) as Varchar(256)
			)
	From [Assets] where AssetsGroupGuid = @Guid	
	
	Select @Code + ISNULL(@C, '01') AS Code

GO

SET ANSI_NULLS, QUOTED_IDENTIFIER ON
GO

	Create View [vbHEntry]
	 
	as
		Select 
			[T].*
		From
			[HEntry] [T]
			inner join [CurrentUsers] [U] on ([u].[Seclvl] >= Isnull([T].[SecLvl],0)  or [u].[Admin] = 1) and [u].[spid] = @@Spid
GO

SET ANSI_NULLS, QUOTED_IDENTIFIER ON
GO

Create Procedure [dbo].[PrcGetAssetsScrapValue]
(
	@AssetsGuid uniqueidentifier = 0x0
)
 
as
	Declare @ScrapValue Float
	
	Select Top 1
		@ScrapValue = [ScrapValue]
	From 
		[AssetsOperation]  
	where
		AssetsGuid = @AssetsGuid
	Order By
		Date Desc, Number Desc
		
	if ISNULL(@ScrapValue, 0) = 0
	Select 
		@ScrapValue = [ScrapValue]
	From 
		[Assets]
	where
		Guid = @AssetsGuid

	Select @ScrapValue As [ScrapValue]	

GO

SET ANSI_NULLS, QUOTED_IDENTIFIER ON
GO

Create Procedure [PrcSaveRepCheckCount]
(
	@ObjGuid uniqueidentifier = '40C85B71-F3C0-46AA-9303-8C3FA449073F',
	@UserGuid uniqueidentifier = '0F15DFA3-0F8C-4A56-A831-21BB87498F07',
	@IsCheck bit = 1,
	@RepId int = 3000
)
 
as
	if @IsCheck = 1
	begin
		insert into [RepCheckCount]
		(
			[ObjGuid],
			[UserGuid],
			[IdReport],
			[date]
		)
		Select
			@ObjGuid,
			@UserGuid,
			@RepId,
			GetDate()
	end


GO

SET ANSI_NULLS, QUOTED_IDENTIFIER ON
GO

Create Trigger [TRG_Apartment_Del]
on [Apartment]
 
For delete
As
	Declare @ContractNo Varchar(256), @Msg Varchar(256)
	
	Select @ContractNo =  T.Name +' : '+ CAST(A.Number as Varchar(256))
	from 
		[LeaseApartment] [A]
		inner join [vwContractType] [T] on [T].[Guid] = [A].[TypeGuid]
		inner join [Deleted] [D] On [D].[Guid] = [A].[ApartmentGuid]
	
	Set @Msg = dbo.SC('      ')+char(13)+  @ContractNo
			   
	if @ContractNo is Not Null
	BEGIN
		RAISERROR (@Msg, 16, 1)
		ROLLBACK TRANSACTION
	END

GO

SET ANSI_NULLS, QUOTED_IDENTIFIER ON
GO
Create Procedure [PrcTransferTable]
(
	@TblName Varchar(256) = '',
	@ToDataBaseName Varchar(256) = '',
	@Condition Varchar(8000) = '',
	@WithDel bit = 1
)
 
as

	Declare @Msg Varchar(255)
	Set @Msg = @TblName
	exec PrcSetProgrss @Msg
	
	--Print '------------'+'Transfer Table '+@TblName+'-------------'
	
	if @TblName = '' Return 
	Declare @sql_txt Varchar(8000)

	if @WithDel = 1
	begin
	Set @sql_txt = 'Alter Table '+@ToDataBaseName+'.dbo.['+@TblName+'] Disable Trigger All'
	--Print @sql_txt
	exec(@sql_txt)

	if UPPER('Hentry') <> UPPER(@TblName)
	begin
		Set @sql_txt = 'Delete From '+@ToDataBaseName+'.dbo.'+@TblName
		exec(@sql_txt)
	end
	
	Set @sql_txt = 'Alter Table '+@ToDataBaseName+'.dbo.['+@TblName+'] Enable Trigger All'
	--Print @sql_txt
	exec(@sql_txt)
	end

	--insert 
	Declare @S varchar(8000), @ColType int
	Declare @ColName Varchar(200)
			,@Columns Varchar(3000)
			,@ColumnsValue Varchar(4000)

	set @Columns = ''
	set @ColumnsValue = ''

	DECLARE cursor_Name CURSOR FOR 
	SELECT 
		[c].[Name]
	FROM 
		SysColumns [C]
		inner join [sysobjects] [O] on [O].[id] = [C].[ID]
	where
		[O].[Name] = @TblName and [C].[Type] <> 56
	Order By [C].ColId
	
	OPEN cursor_Name
	FETCH NEXT FROM cursor_Name INTO @ColName
	
	WHILE @@FETCH_STATUS = 0
	BEGIN
	  
		Set @Columns = @Columns + '['+@ColName+'], '
		Set @ColumnsValue = @ColumnsValue + '[Tb].['+@ColName+'], '
	  FETCH NEXT FROM cursor_Name INTO @ColName
	
	END
	
	CLOSE cursor_Name
	DEALLOCATE cursor_Name


	Set @Columns = left(@Columns,len(@Columns)-1)
	Set @ColumnsValue = left(@ColumnsValue,len(@ColumnsValue)-1)


	--Print 'Disable Index'
	exec PrcCheckIndex @ToDataBaseName, @TblName, 0 --Disable Index
	
	--print 'Begin Insert -------'
	
	Set @sql_txt = '
	insert into '+@ToDataBaseName+'.dbo.['+@TblName+'] 
	('+@Columns+')
	Select	
		'+@ColumnsValue+'
	From 	
		'+@TblName +' [Tb]
	'+IsNull(@Condition, '')

	--exec PrcAddTextTofile @sql_txt
	--Print @sql_txt
	exec(@sql_txt)
	--Print @@ROWCOUNT
	
	
	--Print 'Enable Index'
	exec PrcCheckIndex @ToDataBaseName, @TblName, 1 --Enable Index

GO

SET ANSI_NULLS, QUOTED_IDENTIFIER ON
GO

Create Procedure [PrcRepAutoSMS]
 
as

	Set NoCount on

	Declare @Day int,
			@AutoSend Bit

	Select 
		@AutoSend  = [AutoSend],
		@Day  = [Day]
	from 
		[SMSSetup]
	where
		[Tag] = 1

	--   
	Select 
		[ContractNo],
		[B].[Name] as [BuildingName],
		[B].[ltnName] as [BuildingltnName],
		[B].[ArName] as [BuildingArName],
		Case when Isnull([A].[No], '') <> '' then [A].[No] else [S].[No] end as [No],
		Case when Isnull([A].[No], '') <> '' then dbo.SC('') else dbo.SC('') end as [FlatKind],
		Case when Isnull([A].[No], '') <> '' then [A].[FloorNo] else Null end as [Floor],
		[cu].[Name] as [CustomerName],
		[cu].[ltnName] as [CustomerltnName],
		[cu].[arName] as [CustomerArName],
		[cu].[Mobile] as [CustomerMobile],
		[FromDate],
		[ToDate],
		DateDiff(Day, GetDate(), [ToDate]) as [Datediff],
		[L].[Rent] - [L].[DiscountValue] as [RentAfterDiscount],
		[SMS3].[Count] as [SMSCount],
		[L].[Guid]
		,1 as [Operation]
	From
		[vbLeaseApartment] [L]
		inner join [vwBuilding] [B] On [L].[BuildingGuid] = [B].[Guid]
		inner join [vwCustomer] [cu] on [cu].[Guid] = [L].[CustomerGuid]  or Cu.InsuranceAccountGuid = L.CustAccountGuid
		left join [vwApartment] [A] On [A].[Guid] = [L].[ApartmentGuid]
		left join [vwShop] [S] On [S].[Guid] = [L].[ApartmentGuid]
		left join [RepSMS] [SMS2] on [SMS2].[ObjGuid] = [L].[Guid] and [SMS2].[IdReport] = 7000
		left join (Select 
						[ObjGuid],
						[IdReport],
						Count(*) as [Count]
					From
						[RepSMSCount] 
					where
						[IdReport] = 7000
					Group By
						[ObjGuid],
						[IdReport]
					)[SMS3] on [SMS3].[ObjGuid] = [L].[Guid]
	where
		(DateDiff(Day, GetDate(), [ToDate]) <= @Day)
		and (DateDiff(Day, GetDate(), [ToDate]) > 0)
		and ([LeaseKind] = 0 or [LeaseKind] = 1)
		and ([Contractfinish] = 0)

		and ([SMS2].[ObjGuid] is Null )

		and (@AutoSend = 1)
	Order By 
		[B].[Name],
		DateDiff(Day, GetDate(), [ToDate]),
		[ContractNo],
		[ToDate]

	Declare @R1 int
	Set @R1 = @@RowCount

	Select 
		@AutoSend  = [AutoSend],
		@Day  = [Day]
	from 
		[SMSSetup]
	where
		[Tag] = 2

	--  
	Select 
		[ContractNo],
		[B].[Name] as [BuildingName],
		[B].[ltnName] as [BuildingltnName],
		[B].[ArName] as [BuildingArName],
		[cu].[Name] as [CustomerName],
		[cu].[ltnName] as [CustomerltnName],
		[cu].[arName] as [CustomerArName],
		[cu].[PhoneJob], 
		[cu].[Mobile], 
		Case when Isnull([A].[No], '') <> '' then [A].[No] else [S].[No] end as [No],
		Case when Isnull([A].[No], '') <> '' then dbo.SC('') else dbo.SC('') end as [FlatKind],
		Case when Isnull([A].[No], '') <> '' then [A].[FloorNo] else Null end as [Floor],
		[FromDate],
		[ToDate],
		case when DateDiff(Day,  [ToDate], GetDate()) > 0 then DateDiff(Day,  [ToDate], GetDate()) end as [Datediff],
		[L].[Rent] - [L].[DiscountValue] as [RentAfterDiscount],


		[L].[Guid]
		,[A].[Note] as [FlatNote]
		,[L].[Note2] as [ContractNote]
		,[B].[Emirate] as [Bulding_Emirate]
		,[B].[Area] as [Bulding_Area]
		,[B].[Street] as [Bulding_Street]
		,[B].[BuildingNo] as [Bulding_BuildingNo]
		,[B].[PieceNo] as [Bulding_PieceNo]
		,[B].[BasinNo] as [Bulding_BasinNo]
		,[B].[BondType] as [Bulding_BondType]
		,[B].[BondNo] as [Bulding_BondNo]
		,[B].[BondDate] as [Bulding_BondDate]
		,[SMS3].[Count] as [SMSCount]
		,1 as [Operation]
	From
		[vbLeaseApartment] [L]
		inner join [vwBuilding] [B] On [L].[BuildingGuid] = [B].[Guid]
		inner join [vwCustomer] [cu] on [cu].[Guid] = [L].[CustomerGuid]  or Cu.InsuranceAccountGuid = L.CustAccountGuid
		left join [vwApartment] [A] On [A].[Guid] = [L].[ApartmentGuid]
		left join [vwShop] [S] On [S].[Guid] = [L].[ApartmentGuid]

		left join [RepSMS] [SMS2] on [SMS2].[ObjGuid] = [L].[Guid] and [SMS2].[IdReport] = 9000
		left join (Select 
						[ObjGuid],
						[IdReport],
						Count(*) as [Count]
					From
						[RepSMSCount] 
					where
						[IdReport] = 9000
					Group By
						[ObjGuid],
						[IdReport]
					)[SMS3] on [SMS3].[ObjGuid] = [L].[Guid]
 	where
  		(
  				(DateDiff(Day,  [ToDate], GetDate()) >= @Day)
  		)
		and ([SMS2].[ObjGuid] is Null )
		and (@AutoSend = 1)
		and (l.ContractFinish = 0)
	Order By
		[B].[Name],
		DateDiff(Day,  [ToDate], GetDate())

	Declare @R2 int
	Set @R2 = @@RowCount


	--  
	Select 
		P.*
		,Case when (dbo.FnGetLangauge(@@spid) = 1) and (Isnull([T].[SMSCheckReturnMsgEn],'') <> '') then [T].[SMSCheckReturnMsgEn] else [T].[SMSCheckReturnMsg] end as [SMS]
		,[SMS3].[Count] as [SMSCount]
		,1 as [Operation]
	From
		[vwCheckReturn] [P]
		inner join CheckType T on T.Guid = p.TypeGuid
		left join [RepSMS] [SMS2] on [SMS2].[ObjGuid] = [P].[Guid] and [SMS2].[IdReport] = 1200
		left join (Select 
						[ObjGuid],
						[IdReport],
						Count(*) as [Count]
					From
						[RepSMSCount] 
					where
						[IdReport] = 1200
					Group By
						[ObjGuid],
						[IdReport]
					)[SMS3] on [SMS3].[ObjGuid] = [P].[Guid]
 	where
		DateDiff(Day,  [P].[ReturnDate], GetDate()) >= T.[SMSCheckReturnDay]
		and ([SMS2].[ObjGuid] is Null )
		and ([SMSCheckReturnAutoSend] = 1)
 	Order By 
 		[P].[dueDate], [P].[No]

	Declare @R3 int
	Set @R3 = @@RowCount


	--  
	Select 
		P.*
		,Case when (dbo.FnGetLangauge(@@spid) = 1) and (Isnull([T].[SMSChecksCollectionMsgEn],'') <> '') then [T].[SMSChecksCollectionMsgEn] else [T].[SMSChecksCollectionMsg] end as [SMS]
		,[SMS3].[Count] as [SMSCount]
		,1 as [Operation]
	From
		[vwCheckCollection] [P]
		inner join CheckType T on T.Guid = p.TypeGuid
		left join [RepSMS] [SMS2] on [SMS2].[ObjGuid] = [P].[Guid] and [SMS2].[IdReport] = 1300
		left join (Select 
						[ObjGuid],
						[IdReport],
						Count(*) as [Count]
					From
						[RepSMSCount] 
					where
						[IdReport] = 1300
					Group By
						[ObjGuid],
						[IdReport]
					)[SMS3] on [SMS3].[ObjGuid] = [P].[Guid]
  	where
 		DateDiff(Day,  [P].[CollectionDate], GetDate()) >= [SMSChecksCollectionDay]
		and ([SMS2].[ObjGuid] is Null )
		and ([SMSChecksCollectionAutoSend] = 1)
 	Order By 
 		[P].[dueDate], [P].[No]

	Declare @R4 int
	Set @R4 = @@RowCount


	--   
	Select
		[v].[Guid], 
		[v].[TypeName],
		[Cu].[Name] as [CustName],
		[Cu].[ArName] as [CustArName],
		[Cu].[LtnName] as [CustLtnName]
		,[Cu].[Mobile] as [CustomerMobile],
		[v].[No],
		[v].[Value],
		[v].[CurrencyCode],
		[v].[CurrencyVal],
		[v].[Date],
		[v].[dueDate],
		[v].[BankName]	

		,[L].[ContractNo]
		,[L].[BuildingName]
		,[L].[FlatNo]
		,[L].[FloorNo]
		,[L].[BuildingArName],
		[L].[BuildingLtnName]
		,Case when (dbo.FnGetLangauge(@@spid) = 1) and (Isnull([T].[SMSChecksDueMsgEn],'') <> '') then [T].[SMSChecksDueMsgEn] else [T].[SMSChecksDueMsg] end as [SMS]
		,[SMS3].[Count] as [SMSCount]
		,1 as [Operation]
	From
		[vwChecks] [v]
		inner join CheckType T on T.Guid = V.TypeGuid
		left join [vwChecksCollection] [C] on [C].[CheckGuid] = [V].[Guid] --and [C].[Kind] = 1
		left join (
						Select 
							[CheckGuid],
							Sum([Value]) as [Value] 
						From
							[ChecksPartialCollection] 
						Group By
							[CheckGuid]
					) [C4] on [C4].[CheckGuid] = [V].[Guid]

		left join [vwLeaseApartment] [L] on [L].[Guid] = [V].[ContractGuid]
		Inner Join [vwAccount] [Ac] On [V].[Account] = [Ac].[Guid]

		left join [vwCustomer] [Cu] on [Cu].[AcGuid] = [V].[Account] or Cu.InsuranceAccountGuid = V.Account

		left join [RepSMS] [SMS2] on [SMS2].[ObjGuid] = [V].[Guid] and [SMS2].[IdReport] = 1400
		left join (Select 
						[ObjGuid],
						[IdReport],
						Count(*) as [Count]
					From
						[RepSMSCount] 
					where
						[IdReport] = 1400
					Group By
						[ObjGuid],
						[IdReport]
					)[SMS3] on [SMS3].[ObjGuid] = [V].[Guid]
	where
		(
			[v].[DueDate] <= DateAdd(d, [SMSChecksDueDay], GetDate())
		)
		and (([C].[CheckGuid] Is null) and ([C4].[CheckGuid] is Null or [C4].[Value] < [V].[Value] ))
		and (
				(IsNull([V].[NoneDueDate],1) = 0)
				or [v].[DueDate] = 0
			)

		and ([SMS2].[ObjGuid] is Null )
		and ([SMSChecksDue] = 1)
	Order By 
		[v].[DueDate] 

	Declare @R5 int
	Set @R5 = @@RowCount


	Select @R1 as [R1], @R2 as [R2], @R3 as [R3], @R4 as [R4], @R5 as [R5]



GO

SET ANSI_NULLS, QUOTED_IDENTIFIER ON
GO

Create Procedure [dbo].[PrcMatInventory]
(
	@GroupGuid uniqueidentifier = 0x0,
	@MatGuid uniqueidentifier = 0x0,
	@StoreGuid uniqueidentifier = 0x0,
	@CostGuid uniqueidentifier = 0x0,
	@Class Varchar(256) = '',
	@ClassGrouping Bit = 0,
	@Unit int = 0,
	@BillPost int = 2,
	@CkDate Bit = 0,
	
	@PriceMode int = 1,
	@SpecificPrice int = 0,
	
	@CurrencyGuid [uniqueidentifier] = '11111111-C748-4B13-8B91-1E9B299DF1C1',
	@CurrencyVal Float = 1,

	@ShowEmpltyMat Bit= 0,
	@ShowDetailStore Bit= 0,
	@ShowMatTypeStore Bit= 1,
	@ShowMatTypeService Bit= 0,
	
	@Date1 DateTime = '1/1/2007',
	@Date2 DateTime = '1/1/2016',
	
	@RepKind int = 0 --0 Normal		1 Total - 3 OnTable -- 4 LastInventoryVal
)
 
as
	Set nocount on
	exec [dbo].[PrcMatBillsDetail] @GroupGuid ,@MatGuid ,@StoreGuid,@CostGuid,@Class,@Unit,@BillPost,@CurrencyGuid, @CurrencyVal,@CkDate,@Date1,@Date2
	
	Declare @InvValue Float	--Select * from MatBillsDetail

	CREATE TABLE #MatInv
	(
		[MatCode] [varchar](256),
		[MatName] [varchar](256),
		[MatltnName] [varchar](256),
		[GroupName] [varchar](513),
		[StCode] [varchar](256),
		[StName] [varchar](256),
		[Qty] [float],
		[Unit] [varchar](256),
		[Qty2] [float],
		[Unity2] [varchar](256),
		[Qty3] [float],
		[Unity3] [varchar](256),
		[Price] [float],
		[BtInOut] [int],
		[Class] [varchar](256),
		[MatGuid] [uniqueidentifier],
		[StoreGuid] [uniqueidentifier]
	)

	insert into #MatInv
	Select 
		[MatCode],		[MatName],		[MatltnName],		[GroupName],		[StCode],		[StName],		[Qty],
		[Unit],
		[Qty2],		[Unity2],		[Qty3],		[Unity3],		[Price]	*
			Case when [CurrencyGuid] = @CurrencyGuid then 1 
			else [CurrencyVal] / @CurrencyVal end
		as [Price],
		BtInOut,
		[Class],		[MatGuid],		StoreGuid	From 
		MatBillsDetail
	where
		(
				((MatType = 0 or MatType = -1) and @ShowMatTypeStore = 1)
				or (MatType = 1  and @ShowMatTypeService = 1)
		)
		
	
	
	--
	Select	Distinct
		v.MatGuid,
		mt.[DefUnity]
	into #MatDis
	From	
		#MatInv v
		inner join Mat mt on v.matGuid = mt.Guid
		
	Create Table #MatPrice
	(
		[MatGuid] uniqueidentifier,
		[Price] Float
	)
	
	if @PriceMode = 0 or @PriceMode = 1 or @PriceMode = 2
	begin
		Insert into #MatPrice
		Select
			D.Guid,
			Case 
				when @PriceMode = 0 then D.[MaxPrice]
				when @PriceMode = 1 then D.AvgPrice
				when @PriceMode = 2 then D.LastPrice
			end as [Price]
		From
			mat as D
			inner join #MatDis Mt on Mt.MatGuid = D.Guid
	end
	
	if @PriceMode = 3
	begin
		Insert into #MatPrice
		Select
			mt.MatGuid,
			Case 
				when @PriceMode = 3 then 
											Case when @Unit = 1 then p.Price1
												 when @Unit = 2 then p.Price2
												 when @Unit = 3 then p.Price3
												 when @Unit = 0 then 
																	Case when mt.[DefUnity] = 1 then p.Price1
																		 when mt.[DefUnity] = 2 then p.Price2
																		 when mt.[DefUnity] = 3 then p.Price3
																	end
											end
			end as [Price]
		From
			#MatDis Mt 
			left join [MatUnitsPrice] P on p.matGuid = mt.MatGuid and p.Number = @SpecificPrice + 1
	end
	
	Select 
		[MatCode],		[MatName],		[MatltnName],		[GroupName],		case when @ShowDetailStore = 0 then '' else [StCode] end as [StCode],		case when @ShowDetailStore = 0 then '' else [StName] end as [StName],		Sum([Qty] * [BtInOut]) as [Qty],
		[Unit],
		Sum([Qty2] * BtInOut) as [Qty2],		[Unity2],		Sum([Qty3] * BtInOut) as [Qty3],		[Unity3],		(Select Price From #MatPrice where MatGuid = mt.matGuid) as [Price],		Sum([Qty] * BtInOut) * (Select Top 1 Price From #MatPrice where MatGuid = mt.matGuid) as [TotalPrice],		Case when @ClassGrouping = 0 then '' else [Class] end as [Class],		[MatGuid],		case when @ShowDetailStore = 0 then 0x0 else [StoreGuid] end as [StoreGuid],		0 as Kind	into #Tmp_Inv	from 
		#MatInv Mt
	Group By
		MatCode,		[MatName],		[MatltnName],		[GroupName],		case when @ShowDetailStore = 0 then '' else [StCode] end,		case when @ShowDetailStore = 0 then '' else [StName] end,		case when @ShowDetailStore = 0 then 0x0 else [StoreGuid] end,		[Unit],
		[Unity2],		[Unity3],		Case when @ClassGrouping = 0 then '' else [Class] end,		[MatGuid]	having 
		(Sum([Qty] * BtInOut) <> 0 or @ShowEmpltyMat = 1)


	if @RepKind = 3
	begin
			Select
				*
			From
				#Tmp_Inv
			Order By
				MatCode, StCode	end

	if @RepKind = 4
	begin
		Select
			Sum(TotalPrice) as [Value]
		From
			#Tmp_Inv	end

		
	if @RepKind = 0
	begin
		
		Select 
			[MatCode],			[MatName],			[MatltnName],			[GroupName],			case when @ShowDetailStore = 0 then '' else [StCode] end as [StCode],			case when @ShowDetailStore = 0 then '' else [StName] end as [StName],			Sum([Qty] * [BtInOut]) as [Qty],
			[Unit],
			Sum([Qty2] * BtInOut) as [Qty2],			[Unity2],			Sum([Qty3] * BtInOut) as [Qty3],			[Unity3],			(Select Price From #MatPrice where MatGuid = mt.matGuid) as [Price],			0 as BtInOut,			Case when @ClassGrouping = 0 then '' else [Class] end as [Class],			[MatGuid],			case when @ShowDetailStore = 0 then 0x0 else [StoreGuid] end as [StoreGuid],			Sum([Qty] * BtInOut) * (Select Top 1 Price From #MatPrice where MatGuid = mt.matGuid) as [TotalPrice],			case when @ShowDetailStore = 0 then '' else [StCode] end as [SortCode],			0 as Kind		into #Tmp_Inv0
		from 
			#MatInv Mt
		Group By
			MatCode,			[MatName],			[MatltnName],			[GroupName],			case when @ShowDetailStore = 0 then '' else [StCode] end,			case when @ShowDetailStore = 0 then '' else [StName] end,			case when @ShowDetailStore = 0 then 0x0 else [StoreGuid] end,			[Unit],
			[Unity2],			[Unity3],			Case when @ClassGrouping = 0 then '' else [Class] end,			[MatGuid]		having 
			(Sum([Qty] * BtInOut) <> 0 or @ShowEmpltyMat = 1)
	
		insert into #Tmp_Inv0
		Select 
			dbo.SC('') as [MatCode],			dbo.SC('') as [MatName],			'' as [MatltnName],			'' as [GroupName],			case when @ShowDetailStore = 0 then '' else [StCode] end as [StCode],			case when @ShowDetailStore = 0 then '' else [StName] end as [StName],			Sum([Qty] ) as [Qty],
			'' as [Unit],
			Sum([Qty2]) as [Qty2],			'' as [Unity2],			Sum([Qty3]) as [Qty3],			'' as [Unity3],			Null as [Price],			0 as BtInOut,			'' as [Class],			0x0 [MatGuid],			case when @ShowDetailStore = 0 then 0x0 else [StoreGuid] end as [StoreGuid],			Sum([TotalPrice]) as [TotalPrice],			case when @ShowDetailStore = 0 then '' else [StCode] end as [SortCode],			1 as Kind		from 
			#Tmp_Inv0 Mt
		Group By
			case when @ShowDetailStore = 0 then '' else [StCode] end,			case when @ShowDetailStore = 0 then '' else [StName] end,			case when @ShowDetailStore = 0 then 0x0 else [StoreGuid] end		insert into #Tmp_Inv0
		Select 
			dbo.SC(' ') as [MatCode],			dbo.SC(' ') as [MatName],			'' as [MatltnName],			'' as [GroupName],			'' as [StCode],			'' as [StName],			Sum([Qty] ) as [Qty],
			'' as [Unit],
			Sum([Qty2]) as [Qty2],			'' as [Unity2],			Sum([Qty3]) as [Qty3],			'' as [Unity3],			Null as [Price],			0 as BtInOut,			'' as [Class],			0x0 [MatGuid],			0x0 as [StoreGuid],			Sum([TotalPrice]) as [TotalPrice],			'' as [SortCode],			2 as Kind		from 
			#Tmp_Inv0 Mt
		where
			Kind = 0
		Select	* From	#Tmp_Inv0 		Order By				Case when Kind = 2 then 1 else 0 end,			SortCode , Kind ,MatCode
	
	end			
	---    	
	Select
		@InvValue = Sum(TotalPrice)
	From
		#Tmp_Inv	
	if @RepKind = 1 and (IsNull(@InvValue,0) <> 0)	begin		
		Delete HEntry where Guid = '{19191919-8282-7373-6464-656565656566}'		
		Declare @InvGuid uniqueidentifier		
		Set @InvGuid = '{19191919-8282-7373-6464-656565656566}'		
		Declare @AcLastInvenrotyGuid uniqueidentifier, 
				@AcLastInvenrotyGuid2 uniqueidentifier				
			Set @AcLastInvenrotyGuid = 
			(Select Top 1 Value From DMD_Const where VName = 'AcLastInvenrotyGuid')		
			Declare @Ms Varchar(255)
			Set @Ms = dbo.SC('       ')
			if IsNull(@AcLastInvenrotyGuid,0x0) = 0x0
			begin
				RAISERROR (@Ms, 16, 1)
				return
			end
			Set @AcLastInvenrotyGuid2 = (Select Top 1 Value From DMD_Const where VName = 'AcLastInvenrotyGuid2')			Set @Ms = dbo.SC('       ')
			if IsNull(@AcLastInvenrotyGuid2,0x0) = 0x0
			begin
				RAISERROR (@Ms, 16, 1)
				return
			end
				if (isNull(@AcLastInvenrotyGuid,0x0) <> 0x0 ) and (isNull(@InvValue,0) <> 0)		begin			Insert into HEntry			([Guid] ,[Number],[SecLvl],[Date],[CurrencyGuid],[CurrencyVal],[Note],[ParentKind],[UserGuid],[BranchGuid],[IsPosted])			Select				@InvGuid as [Guid] 				,Null				,5				,GetDate()-1 [Date]				,@CurrencyGuid as [CurrencyGuid]				,@CurrencyVal as [CurrencyVal]				,dbo.SC('  ') as [Note]				,0 as [ParentKind]				,Null as [UserGuid]				,Null as [BranchGuid]				,1 as [IsPosted]							insert into Dentry			([Number],[ParentGuid],[AcGuid],[Debit],[Credit],[CurrencyGuid],[CurrencyVal],[ObverseAcGuid],[CostGuid],[Note],[IsVisible])
			Select
				1 as [Number],
				@InvGuid as [ParentGuid]
				,@AcLastInvenrotyGuid as [AcGuid]
				,Case when @InvValue < 0 then -@InvValue else 0 end [Debit]
				,Case when @InvValue > 0 then @InvValue else 0 end [Credit]
				,@CurrencyGuid as [CurrencyGuid]
				,@CurrencyVal as [CurrencyVal]
				,Null as [ObverseAcGuid]
				,Null as [CostGuid]
				,'' as [Note]
				,1 as [IsVisible]
				
			-- 
			insert into Dentry			([Number],[ParentGuid],[AcGuid],[Debit],[Credit],[CurrencyGuid],[CurrencyVal],[ObverseAcGuid],[CostGuid],[Note],[IsVisible])
			Select
				2 as [Number],
				@InvGuid as [ParentGuid]
				,@AcLastInvenrotyGuid2 as [AcGuid]
				,Case when @InvValue > 0 then @InvValue else 0 end [Debit]
				,Case when @InvValue < 0 then -@InvValue else 0 end [Credit]
				,@CurrencyGuid as [CurrencyGuid]
				,@CurrencyVal as [CurrencyVal]
				,Null as [ObverseAcGuid]
				,Null as [CostGuid]
				,'' as [Note]
				,1 as [IsVisible]
		end		--Select * from DEntry where ParentGuid = @InvGuid
	end		

GO

SET ANSI_NULLS, QUOTED_IDENTIFIER ON
GO

Create Procedure [PrcAllChecksCollection]
(
	@Kind int = 1,
	@SecLvlKind Bit = 1,
    @SecLvl int = 0,
	@Date DateTime = '1/1/2010',
	@DueDate bit = 1,
	@FixDate DateTime = '1/1/2010',
	@LossComm Bit = 1,

	@DefAccounts Bit = 1,
	@AcDebit uniqueidentifier = 0x0,
	@CoDebit uniqueidentifier = 0x0,
	@AcCredit uniqueidentifier = 0x0,
	@CoCredit uniqueidentifier =0x0,

	@CommissionPercent float = 10,
	@CommAccountGuid uniqueidentifier = 0x0,
	@CommAccountCreditGuid uniqueidentifier = 0x0,
	@Note Varchar(256) = '',
	@Delay Float = 0,
	@DelayAccountDebitGuid uniqueidentifier = 0x0,
	@DelayAccountCreditGuid uniqueidentifier = 0x0,
	@Finished Bit = 1,	
	@ForTest Bit = 0	
)
 
as

	Create Table #R
	(
		[CheckNo] Varchar(256),
		[State] Varchar(256),
		[Guid] uniqueidentifier
	)


	Declare @CheckGuid uniqueidentifier

	Declare @Continue Bit,
			@Post Bit,
			@collecte bit,
			@Endor bit,
			@Return Bit,
			@Posted int,
			@collected int,
			@Endorsement int,
			@Returned int,
			@No Varchar(256),
			@CheckSecLvl int,
			@Value Float,
			@OperationDate Datetime,
			@CurrencyGUID uniqueidentifier,
			@CurrencyVal Float,
			@TypeGuid uniqueidentifier,
			@CheckKind int,
			@collectedSanctionBankAccountBuilding Bit,
			@ReturnedSanctionCustAccountDefAccount Bit,
			@AccountBankBuildingGuid  uniqueidentifier,
			@AcChecks uniqueidentifier,
			@DefOwnerBuildingPosted Bit,
			@AcTmp uniqueidentifier,
			@DefCustPosted Bit,
			@CommOwnerBuilding Bit,
			@DefBuildingComm Bit,
			@TmpFloat Float,
			@ReturnedSanctionBankBuilding Bit,
			@ReturnedSanctionBankBuildingCaseCollOnly Bit,
			@collectedSanctionCustObverse Bit,
			@DefBuildingIncomComm Bit,
			@EnableAtherOperationOnReturn Bit,
			@DefMoveCostDebit bit,
			@DefMoveCostCredit bit


	DECLARE cursor_Name CURSOR FAST_FORWARD FOR 
	Select [Guid] From [Resource]
	where [Kind] = 8
		and [Spid] = @@Spid
	
	OPEN cursor_Name
	FETCH NEXT FROM cursor_Name INTO @CheckGuid

	WHILE @@FETCH_STATUS = 0
	BEGIN

		--   
		Select
			@Posted = Sum(Case when Kind = 0 then 1 else 0 end ),
			@collected = Sum(Case when Kind = 1 then 1 else 0 end ),
			@Endorsement = Sum(Case when Kind = 2 then 1 else 0 end ),
			@Returned = Sum(Case when Kind = 3 then 1 else 0 end )
		from
			ChecksCollection
		where
			[CheckGuid] = @CheckGuid

		Select @Posted 		= isnull(@Posted,0)
		Select @collected 	= isnull(@collected,0)
		Select @Endorsement = isnull(@Endorsement,0)
		Select @Returned 	= isnull(@Returned,0)

		-- 
		Select 
			@No = [C].[No],
			@OperationDate = Case when @DueDate = 1 then
					(Select [DueDate] From [Checks] where [Guid] = @CheckGuid)
			else @Date end
		From 
			[Checks] [C] 
		where 
			[C].[Guid] = @CheckGuid
			
		if @OperationDate < @FixDate 
		begin
			insert into #R
			Select @No, dbo.SC('     '), @CheckGuid
			
			FETCH NEXT FROM cursor_Name INTO @CheckGuid
			CONTINUE 				
		end 


		--  
		if (@Kind = 0) 
		begin
			--   
			-- 
			Select 
				@No = [C].[No],
				@CheckSecLvl = [C].SecLvl,
				@CheckKind = [CheckKind],
				@Post = [Posted],
				@AcDebit = Case when @DefAccounts = 0 then @AcDebit else [PostedDefAccountGuid] end,
				@AcCredit = Case when @DefAccounts = 0 then @AcCredit else [PostedDefCreditAccountGuid] end,
				@Value =[Value],
				@CurrencyGUID = [CurrencyGUID],
				@CurrencyVal = [CurrencyVal],
				@TypeGuid = [T].[Guid],
				@DefOwnerBuildingPosted = [T].[DefOwnerBuildingPosted],
				@DefCustPosted = [T].[DefCustPosted],
				@EnableAtherOperationOnReturn = [T].[EnableAtherOperationOnReturn],
				@DefMoveCostDebit = PostMoveCostDebit,
				@DefMoveCostCredit = PostMoveCostCredit
			From 
				[CheckType] [T]
				inner join [Checks] [C] On [C].[TypeGuid] = [T].[Guid]
			where 
				[C].[Guid] = @CheckGuid

			if @Post = 0
			begin
				insert into #R
				Select @No, dbo.SC('  '), @CheckGuid
				
				FETCH NEXT FROM cursor_Name INTO @CheckGuid
				CONTINUE 				
			end 

			--      
			if (@DefOwnerBuildingPosted = 1) and (@DefAccounts = 1)
			begin
				Select
					@AcTmp = [Cu].[AcGuid]
				from
					[Checks] [C]
					inner join [LeaseApartment] [L] On [L].[Guid] = [C].[ContractGuid]
					inner join [Building] [B] On [B].[Guid] = [L].[BuildingGuid]
				    inner join [Customer] [Cu] on [Cu].[Guid] =[B].[OwnerName]
				where 
					[C].[Guid] = @CheckGuid
				

				if @AcTmp is Not Null
				begin
					
					if @CheckKind = 0
					Set @AcCredit =@AcTmp

					if @CheckKind = 1
					Set @AcDebit = @AcTmp
				end
			end

			--      
			if (@DefCustPosted = 1) and (@DefAccounts = 1)
			begin
				Select
					@AcTmp = [C].[Account]
				from
					[Checks] [C]
				where [C].[Guid] = @CheckGuid
				
				if @AcTmp is Not Null
				begin
					if @CheckKind = 0
					Set @AcDebit = @AcTmp

					if @CheckKind = 1
					Set @AcCredit =@AcTmp
				end
			end

			-- 
			if (@Posted > 0) or (@collected > 0) or (@Endorsement > 0) or ( @Returned > 0 and @EnableAtherOperationOnReturn = 0)
			begin
				insert into #R
				Select @No, dbo.SC('  ') +' '+Case 
															when (@Posted > 0) then dbo.SC('    ')
															when (@collected > 0) then dbo.SC('   ')
															when (@Endorsement > 0) then dbo.SC('   ')
															when (@Returned > 0) then dbo.SC('   ')
															else '' end
				, @CheckGuid
				
				FETCH NEXT FROM cursor_Name INTO @CheckGuid
				CONTINUE 				
			end


			if (isnull(@AcDebit, 0x0) = 0x0) or (isnull(@AcCredit,0x0) =0x0 )
			begin
				insert into #R
				Select @No, dbo.SC('  ') +' '+dbo.SC('   ')	, @CheckGuid
				
				FETCH NEXT FROM cursor_Name INTO @CheckGuid
				CONTINUE 				
			end
	
		end		
		
		--  
		if (@Kind = 1) 
		begin
			--   
			-- 
			Select 
				@No = [C].[No],
				@CheckSecLvl = [C].SecLvl,
				@collecte = [collected],
				@AcDebit = Case when @DefAccounts = 0 then @AcDebit else [collectedDefAccountGuid] end,
				@AcCredit = Case when @DefAccounts = 0 then @AcCredit else [collectedDefAccountObverseGuid] end,
				@Value =[Value],
				@CurrencyGUID = [CurrencyGUID],
				@CurrencyVal = [CurrencyVal],
				@TypeGuid = [T].[Guid],
				@CheckKind = [T].[CheckKind],
				@collectedSanctionBankAccountBuilding = [T].[collectedSanctionBankAccountBuilding],
				@CommOwnerBuilding = [T].[CommOwnerBuilding],
				@DefBuildingComm = [T].[DefBuildingComm],
				@CommAccountGuid = Case when @DefAccounts = 0 then @CommAccountGuid else [CommAccountDebitGuid] end,
				@CommAccountCreditGuid = Case when @DefAccounts = 0 then @CommAccountCreditGuid else [CommAccountCreditGuid] end,
				@collectedSanctionCustObverse = [T].[collectedSanctionCustObverse],
				@DefBuildingIncomComm = [T].[DefBuildingIncomComm],
				@EnableAtherOperationOnReturn = [T].[EnableAtherOperationOnReturn],
				@DefMoveCostDebit = collectedMoveCostDebit,
				@DefMoveCostCredit = collectedMoveCostCredit
			From 
				[CheckType] [T]
				inner join [Checks] [C] On [C].[TypeGuid] = [T].[Guid]
			where 
				[C].[Guid] = @CheckGuid

			if @collecte = 0
			begin
				insert into #R
				Select @No, dbo.SC('  '), @CheckGuid
				
				FETCH NEXT FROM cursor_Name INTO @CheckGuid
				CONTINUE 				
			end 

			--      	
			if (@collectedSanctionBankAccountBuilding = 1) and (@DefAccounts = 1)
			begin
				Select
					@AccountBankBuildingGuid = [B].[AccountBankBuildingGuid]
				from
					[Checks] [C]
					inner join [LeaseApartment] [L] On [L].[Guid] = [C].[ContractGuid]
					inner join [Building] [B] On [B].[Guid] = [L].[BuildingGuid]
				where [C].[Guid] = @CheckGuid
				
				if @AccountBankBuildingGuid is Not Null
				begin
					if @CheckKind = 0
					Set @AcDebit = @AccountBankBuildingGuid

					if @CheckKind = 1
					Set @AcCredit = @AccountBankBuildingGuid
				end
			end

			--       
			if (@CommOwnerBuilding = 1) and (@DefAccounts = 1)
			begin
				print '       '
				Select
					@AcTmp = [Cu].[AcGuid]
				from
					[Checks] [C]
					inner join [LeaseApartment] [L] On [L].[Guid] = [C].[ContractGuid]
					inner join [Building] [B] On [B].[Guid] = [L].[BuildingGuid]
				    inner join [Customer] [Cu] on [Cu].[Guid] =[B].[OwnerName]
				where 
					[C].[Guid] = @CheckGuid
				
				if @AcTmp is Not Null
				begin
					if @CheckKind = 0
					Set @CommAccountGuid = @AcTmp

					if @CheckKind = 1
					Set @CommAccountCreditGuid = @AcTmp
				end
			end

			--        
			if (@DefBuildingIncomComm = 1) and (@DefAccounts = 1)
			begin
				Select
				   @AcTmp = [B].[AccountCommIncomeGuid]
				from
					[Checks] [C]
					inner join [LeaseApartment] [L] On [L].[Guid] = [C].[ContractGuid]
					inner join [Building] [B] On [B].[Guid] = [L].[BuildingGuid]
				where 
					[C].[Guid] = @CheckGuid
				
				if @AcTmp is Not Null
				begin
					if @CheckKind = 0
					Set @CommAccountCreditGuid = @AcTmp

					if @CheckKind = 1
					Set @CommAccountGuid = @AcTmp
				end
			end

			--     
			if (@DefBuildingComm = 1) and (@DefAccounts = 1)
			begin
				Select
				   @TmpFloat = [B].[CommissionPercent]
				from
					[Checks] [C]
					inner join [LeaseApartment] [L] On [L].[Guid] = [C].[ContractGuid]
					inner join [Building] [B] On [B].[Guid] = [L].[BuildingGuid]
				where 
					[C].[Guid] = @CheckGuid
				
				if @TmpFloat is Not Null
				begin
					Set @CommissionPercent = @TmpFloat
					Set @LossComm = 1
				end
				print '  : '
				print @CommissionPercent
			end


			--      
			if (@collectedSanctionCustObverse = 1) and (@DefAccounts = 1)
			begin
				Select
					@AcTmp = [C].[Account]
				from
					[Checks] [C]
				where [C].[Guid] = @CheckGuid
				
				if @AcTmp is Not Null
				begin
					if @CheckKind = 0
					Set @AcCredit = @AcTmp

					if @CheckKind = 1
					Set @AcDebit = @AcTmp
				end
			end

			-- 
			if (@collected > 0) or (@Endorsement > 0) or ( @Returned > 0 and @EnableAtherOperationOnReturn = 0)
			begin
				insert into #R
				Select @No, dbo.SC('  ') +' '+Case 
															when (@collected > 0) then dbo.SC('    ')
															when (@Endorsement > 0) then dbo.SC('   ')
															when (@Returned > 0) then dbo.SC('   ')
															else '' end
				, @CheckGuid
				
				FETCH NEXT FROM cursor_Name INTO @CheckGuid
				CONTINUE 				
			end

			
			if (isnull(@AcDebit, 0x0) = 0x0) or (isnull(@AcCredit,0x0) =0x0 ) 
				or (isnull(@CommAccountCreditGuid,0x0) = 0x0 and isnull(@CommissionPercent,0) <> 0)
			begin
				insert into #R
				Select @No, dbo.SC('  ') +' '+dbo.SC('   ')	, @CheckGuid
				
				FETCH NEXT FROM cursor_Name INTO @CheckGuid
				CONTINUE 				
			end
	
		end		
		
		--  
		if (@Kind = 2) 
		begin
			--   
			-- 
			Select 
				@No = [C].[No],
				@CheckSecLvl = [C].SecLvl,
				@Endor = [Endorsement],
				@AcDebit = Case when @DefAccounts = 0 then @AcDebit else [EndorsementDefAccountDebitGuid] end,
				@AcCredit = Case when @DefAccounts = 0 then @AcCredit else [EndorsementDefAccountCreateGuid] end,
				@Value =[Value],
				@CurrencyGUID = [CurrencyGUID],
				@CurrencyVal = [CurrencyVal],
				@TypeGuid = [T].[Guid],
				@CheckKind = [T].[CheckKind],
				@EnableAtherOperationOnReturn = [T].[EnableAtherOperationOnReturn],
				@DefMoveCostDebit = EndorsementMoveCostDebit,
				@DefMoveCostCredit = EndorsementMoveCostCredit
			From 
				[CheckType] [T]
				inner join [Checks] [C] On [C].[TypeGuid] = [T].[Guid]
			where 
				[C].[Guid] = @CheckGuid

			if @Endor = 0
			begin
				insert into #R
				Select @No, dbo.SC('  '), @CheckGuid
				
				FETCH NEXT FROM cursor_Name INTO @CheckGuid
				CONTINUE 				
			end 


			-- 
			if (@Posted > 0) or (@collected > 0) or (@Endorsement > 0) or ( @Returned > 0 and @EnableAtherOperationOnReturn = 0)
			begin
				insert into #R
				Select @No, dbo.SC('  ') +' '+Case 
															when (@Posted > 0) then dbo.SC('   ')
															when (@collected > 0) then dbo.SC('   ')
															when (@Endorsement > 0) then dbo.SC('   ')
															when (@Returned > 0) then dbo.SC('   ')
															else '' end
				, @CheckGuid
				
				FETCH NEXT FROM cursor_Name INTO @CheckGuid
				CONTINUE 				
			end

			if (isnull(@AcDebit, 0x0) = 0x0) or (isnull(@AcCredit,0x0) =0x0 )
			begin
				insert into #R
				Select @No, dbo.SC('  ') +' '+dbo.SC('   ')	, @CheckGuid
				
				FETCH NEXT FROM cursor_Name INTO @CheckGuid
				CONTINUE 				
			end
	
		end

		--  
		if (@Kind = 3) 
		begin
			--   
			-- 
			Select 
				@No = [C].[No],
				@CheckSecLvl = [C].SecLvl,
				@Return = [Returned],
				@AcDebit = Case when @DefAccounts = 0 then @AcDebit else [ReturnedDefAccountGuid] end,
				@AcCredit = Case when @DefAccounts = 0 then @AcCredit else [ReturnedDefAccountCreditGuid] end,
				@Value =[Value],
				@CurrencyGUID = [CurrencyGUID],
				@CurrencyVal = [CurrencyVal],
				@TypeGuid = [T].[Guid],
				@CheckKind = [T].[CheckKind],
				@ReturnedSanctionCustAccountDefAccount = [ReturnedSanctionCustAccountDefAccount],
				@ReturnedSanctionBankBuilding = [ReturnedSanctionBankBuilding],
				@ReturnedSanctionBankBuildingCaseCollOnly = T.[ReturnedSanctionBankBuildingCaseCollOnly],
				@DefMoveCostDebit = ReturnMoveCostDebit,
				@DefMoveCostCredit = ReturnMoveCostCredit
			From 
				[CheckType] [T]
				inner join [Checks] [C] On [C].[TypeGuid] = [T].[Guid]
			where 
				[C].[Guid] = @CheckGuid

			--   /    
			if (@ReturnedSanctionCustAccountDefAccount = 1)  and (@DefAccounts = 1)
			begin
				Select
					@AcChecks = [C].[Account]
				from
					[Checks] [C]
				where [C].[Guid] = @CheckGuid
				
				if @AcChecks is Not Null
				begin
					if @CheckKind = 0
					Set @AcDebit = @AcChecks

					if @CheckKind = 1
					Set @AcCredit = @AcChecks
				end
			end

			--       
			if (@ReturnedSanctionBankBuilding = 1)  and (@DefAccounts = 1)
			begin
				Select
					@AcTmp = [B].[AccountBankBuildingGuid]
				from
					[Checks] [C]
					inner join [LeaseApartment] [L] On [C].[ContractGuid] = [L].[Guid]
					inner join [Building] [B] on [B].[Guid] = [L].[BuildingGuid]
				where 
					[C].[Guid] = @CheckGuid
				
				if @AcTmp is Not Null
				begin
					if @CheckKind = 0
					Set @AcCredit = @AcTmp

					if @CheckKind = 1
					Set @AcDebit = @AcTmp
				end
			end

			--          
			if (@ReturnedSanctionBankBuildingCaseCollOnly = 1)
			begin
				Declare @IsColl bit
					Set @IsColl = (Select dbo.FnTestCheckCollection(@CheckGuid))
					
				Select
					@AcTmp = [B].[AccountBankBuildingGuid]
				from
					[Checks] [C]
					inner join [LeaseApartment] [L] On [C].[ContractGuid] = [L].[Guid]
					inner join [Building] [B] on [B].[Guid] = [L].[BuildingGuid]
				where 
					[C].[Guid] = @CheckGuid
				
				if (@AcTmp is Not Null) and (@IsColl = 1)
				begin
					if @CheckKind = 0
					Set @AcCredit = @AcTmp

					if @CheckKind = 1
					Set @AcDebit = @AcTmp
				end
			end

			if @Return = 0
			begin
				insert into #R
				Select @No, dbo.SC('  '), @CheckGuid
				
				FETCH NEXT FROM cursor_Name INTO @CheckGuid
				CONTINUE 				
			end 


			-- 
			if (@Returned > 0)
			begin
				insert into #R
				Select @No, dbo.SC('  ') +' '+Case when (@Returned > 0) then dbo.SC(' ')
															else '' end
				, @CheckGuid
				
				FETCH NEXT FROM cursor_Name INTO @CheckGuid
				CONTINUE 				
			end

			if (isnull(@AcDebit, 0x0) = 0x0) or (isnull(@AcCredit,0x0) =0x0 )
			begin
				insert into #R
				Select @No, dbo.SC('  ') +' '+dbo.SC('   ')	, @CheckGuid
				
				FETCH NEXT FROM cursor_Name INTO @CheckGuid
				CONTINUE 				
			end
	
		end

		-- 
		Declare @NewNote Varchar(256)
		Set @NewNote = 
		(
			Select 
				Case 
					when @Kind = 0 then 
					Case when dbo.FnGetLangauge(@@spid) = 0 then Notecollected
					else LtnNotePosted
					end
					when @Kind = 1 then 
					Case when dbo.FnGetLangauge(@@spid) = 0 then Notecollected
					else LtnNotecollected
					end
					when @Kind = 2 then 
					Case when dbo.FnGetLangauge(@@spid) = 0 then NoteEndorsement
					else LtnNoteEndorsement
					end
					when @Kind = 3 then 
					Case when dbo.FnGetLangauge(@@spid) = 0 then NoteReturn
					else LtnNoteReturn
					end
				end
			From	
				[CheckType] [T]
				inner join [Checks] [C] On [C].[TypeGuid] = [T].[Guid]
			where 
				[C].[Guid] = @CheckGuid
		)
		
		-- 
		Declare @ACName_Note Varchar(256),
				@obverseAccountName_Note Varchar(256),
				@Value_Note Varchar(256),
				@BankName_Note Varchar(256),
				@No_Note Varchar(256),
				@DueDate_Note Varchar(256),
				@CheckDate Varchar(256)
				
		Select
			@ACName_Note = AccountName,
			@obverseAccountName_Note = ObverseAccountName,
			@Value_Note = Cast(Value as Varchar(256)) +' '+CurrencyName,
			@BankName_Note = BankName,
			@No_Note = [No],
			@DueDate_Note = Cast(DueDate as Varchar(256)),
			@CheckDate = dbo.FnFormatDate([Date])
		From	
			vwChecks
		where
			[Guid] = @CheckGuid
			
		-- 
		Declare @FlatNo_Note Varchar(256),
				@BuildingName_Note Varchar(256)
		
		Select
			@FlatNo_Note = [FlatNo],
			@BuildingName_Note = [BuildingName]
		From
			vwAllContract C
			inner join Checks S on C.Guid = S.ContractGuid
		where
			S.Guid = @CheckGuid
			
		Set @NewNote = REPLACE(@NewNote, '[A]', isNull(@ACName_Note,''))
		Set @NewNote = REPLACE(@NewNote, '[B]', isNull(@obverseAccountName_Note,''))
		Set @NewNote = REPLACE(@NewNote, '[C]', isNull(@Value_Note,''))
		Set @NewNote = REPLACE(@NewNote, '[D]', isNull(@BankName_Note,''))
		Set @NewNote = REPLACE(@NewNote, '[E]', isNull(@No_Note,''))
		Set @NewNote = REPLACE(@NewNote, '[F]', isNull(@DueDate_Note,''))
		Set @NewNote = REPLACE(@NewNote, '[J]', isNull(@FlatNo_Note,''))
		Set @NewNote = REPLACE(@NewNote, '[H]', isNull(@BuildingName_Note,''))
		Set @NewNote = REPLACE(@NewNote, '[T]', isNull(@CheckDate,''))
		Set @NewNote = REPLACE(@NewNote, '[O]', isNull(dbo.FnFormatDate(@OperationDate),''))
			

		if @DefAccounts = 1
		begin
			Declare @UnitCostGuid uniqueidentifier
			Declare @DebitUnitCostGuid uniqueidentifier
			Declare @CreditUnitCostGuid uniqueidentifier
			
			Select
				@UnitCostGuid = [L].[UnitCostGuid]
			from
        		[Checks] [C]
        		inner join [vwAllContract] [L] On [L].[Guid] = [C].[ContractGuid]
			where [C].[Guid] = @CheckGuid
			
			if @DefMoveCostDebit = 1 Set @CoDebit = @UnitCostGuid
			if @DefMoveCostCredit = 1 Set @CoCredit = @UnitCostGuid

		end
		
		-- 
		if @ForTest = 0
		begin
			begin Tran Tr_ChecksCollection
			
			insert into [ChecksCollection]
		  	([SecLvl],[Date], [CheckGuid], [DebitAccountGuid], [DebitCostGuid], [CreditAccountGuid], [CreditCostGuid], [Value],[Commission],[LossComm],[CommAccountGuid],[CommAccountCreditGuid],[CurrencyGUID],[CurrencyVal],[Note],[Kind],[Delay],[DelayAccountDebitGuid],[DelayAccountCreditGuid], [Finished])
			Select
				Case when @SecLvlKind = 1 then @CheckSecLvl else @SecLvl end,
				Case when @DueDate = 1 then
						(Select [DueDate] From [Checks] where [Guid] = @CheckGuid)
				else @Date end as [Date]
				,@CheckGuid as [CheckGuid]
				,@AcDebit as [DebitAccountGuid]
				,Case when @CoDebit <> 0x0 then @CoDebit end as [DebitCostGuid]
				,@AcCredit [CreditAccountGuid]
				,Case when @CoCredit <> 0x0 then @CoCredit end as [CreditCostGuid]
				,@Value as [Value]
				,case when @LossComm <> 0 then @Value * (@CommissionPercent / 100) end as [Commission]
				,@LossComm
				,Case when @CommAccountGuid <> 0x0 then @CommAccountGuid end as [CommAccountGuid]
				,Case when @CommAccountCreditGuid <> 0x0 then @CommAccountCreditGuid end as [CommAccountCreditGuid]
				,@CurrencyGUID as [CurrencyGUID]
				,@CurrencyVal as [CurrencyVal]
				,@NewNote as [Note]
				,@Kind as [Kind]
				,@Delay as [Delay]
				,Case when @DelayAccountDebitGuid <> 0x0 then @DelayAccountDebitGuid end  as [DelayAccountDebitGuid]
				,Case when @DelayAccountCreditGuid <> 0x0 then @DelayAccountCreditGuid end as [DelayAccountCreditGuid]
				,Case when (@Kind = 3) then @Finished else 0 end
		
				--  
		    	Exec [PrcCreateEntryChecksCollection] @CheckGuid ,@Kind 
		
				commit Tran Tr_ChecksCollection
				insert into #R
				Select @No, dbo.SC('  ') , @CheckGuid
		end
		if @ForTest = 1
			insert into #R
			Select @No, dbo.SC('  ') , @CheckGuid
	
	 	FETCH NEXT FROM cursor_Name INTO @CheckGuid
	
	END
	
	CLOSE cursor_Name
	DEALLOCATE cursor_Name


	Select * from #R	
	Order By [CheckNo]
		


GO

SET ANSI_NULLS, QUOTED_IDENTIFIER ON
GO

Create Procedure [dbo].[PrcLawsuit]
(
	@LawsuitGuid uniqueidentifier = 0x0,
	@RealtyNo varchar(256) = '',
	@CustGuid uniqueidentifier = '8DCCC94B-9909-4650-9563-E6CABF1F6372',
	@LawsuitState int = 2,
	@Datewith int = 0,
	@ActiveContractList bit = 1,
	@ActiveBuildingList bit = 1,
	@ActiveDate bit = 0,
	@Date1 DateTime = '1/1/2007',
	@Date2 DateTime = '1/1/2008'
)
 
as
	Create Table #LawsuitRes1
	(
		[ContractGuid] uniqueidentifier,
		[ContractNo] varchar(256),
		[RealtyNo] varchar(256),
		BuildingName varchar(256),
		[BuildingGuid] uniqueidentifier,
		CustName varchar(256),
		FromDate Datetime,
		Todate Datetime,
		StopPayDate Datetime,
		[State] varchar(256),

		[LastState] varchar(256),
		LastStateDate Datetime,
		LastStateNote varchar(256),
		LastStateUserGuid uniqueidentifier,
		LastStateUserName varchar(256),

		No varchar(256),
		StartDate Datetime,
		QuittanceDate Datetime,
		QuittanceElectricityDate Datetime,
		EndDate Datetime,
		ExeNo varchar(256),
		Rent Float,
		[DueRent] Float,
		[Expense] Float,
		MaintenanceRent Float,
		LawyerRent Float,
		Furniture Float,
		[PayChecks] Float,
		[CachPayment] Float,
		Kind int,
		LawsuitGuid uniqueidentifier,
	)
	

	insert into #LawsuitRes1
	Select 
		C.[Guid] as [ContractGuid],
		C.[ContractNo],
		C.[FlatNo] as [RealtyNo],
		C.BuildingName,
		C.[BuildingGuid],
		C.CustName,
		C.FromDate,
		C.Todate,
		L.StopPayDate,
		Case when IsEnded = 1 then dbo.SC('')
		else dbo.SC('')
		end as [State],
		(Select Top 1 [State] From LawsuitState where ParentGuid = L.Guid order by Date Desc, Number Desc ) as LastState,
		(Select Top 1 [Date] From LawsuitState where ParentGuid = L.Guid order by Date Desc, Number Desc ) as LastStateDate,
		(Select Top 1 [Note] From LawsuitState where ParentGuid = L.Guid order by Date Desc, Number Desc ) as LastStateNote,
		(Select Top 1 UserGuid From LawsuitState where ParentGuid = L.Guid order by Date Desc, Number Desc ) as LastStateUserGuid,
		'' as LastStateUserName,
		L.No,
		l.StartDate,
		L.QuittanceDate,
		L.QuittanceElectricityDate,
		L.EndDate,
		L.ExeNo,
		L.Rent,
		Case when dbo.fnDateIsNull(QuittanceElectricityDate) = 1 then (L.Rent / 356) * (Datediff(DAY, L.QuittanceElectricityDate , L.StopPayDate) + 1) end AS [DueRent],
		(
			Select
				SUM(ReceiptValue)
			From
				LawsuitExpense
			where
				ParentGuid = L.Guid
		) as [Expense],
		L.MaintenanceRent,
		L.LawyerRent,
		L.Furniture,
		(
			Select 
				SUM(value)
			from
				[Checks] C
			where
				ContractGuid = L.Guid
		) as [PayChecks],

		(
			Select 
				SUM(value)
			from
				[vwLawsuitCachPayment]	C
			where
				LawsuitGuid = L.Guid
		) as [CachPayment],
		0 as Kind,
		L.Guid as LawsuitGuid
	From 
		[Lawsuit] L
		inner join vwAllContract C on C.Guid = L.ContractGuid 
	where
		(L.Guid = @LawsuitGuid or @LawsuitGuid = 0x0)
		and (C.[FlatNo] = @RealtyNo or @RealtyNo = '')
		and (c.CustGuid = @CustGuid or @CustGuid = 0x0)
		and (
				(L.IsEnded = 1 and @LawsuitState = 0)
				or (L.IsEnded = 0 and @LawsuitState = 1)
				or @LawsuitState = 2
			)
		and (
				(L.StartDate between @Date1 and @Date2 and @Datewith = 0)
				or (L.StartDate between @Date1 and @Date2 and @Datewith = 1)
				or (L.EndDate between @Date1 and @Date2 and @Datewith = 2)
				or @ActiveDate = 0
			)

	Update
		#LawsuitRes1
	Set
		LastStateUserName = LogInName 
	From
		#LawsuitRes1 R
		inner join Realty_Users U on U.Guid = R.LastStateUserGuid

	--  
	if @ActiveContractList = 1
	begin
		Select 
			[R].[LawsuitGuid] 
		into #CheckContract	
		From
			#LawsuitRes1 [R]
			inner join [vwAllContract] [C] On [C].[Guid] = [R].[ContractGuid]
			inner join [Resource] [RS] on [RS].[Guid] = [C].[TypeGuid] and [RS].[Spid] = @@Spid and [RS].[Kind] = 102
	
		--Select * from #CheckContract
	
		Delete #LawsuitRes1
		From
			#LawsuitRes1 [R]
			left join #CheckContract [C] On [C].[LawsuitGuid] = [R].[LawsuitGuid]
		where
			[C].[LawsuitGuid] is Null
	end
	
	
	-- 
	if @ActiveBuildingList = 1
	begin
		Delete #LawsuitRes1
		From
			#LawsuitRes1 [L]
			left join [Resource] [R] on [R].[Guid] = [L].[BuildingGuid] and [R].[Kind] = 99 and [R].[Spid] = @@Spid 
		where
			[R].[Guid] Is Null
			and L.BuildingGuid <> 0x0
	end
	
	Select
		*,
		IsNull([DueRent],0) + IsNull([Expense],0) + IsNull(MaintenanceRent,0) + IsNull(LawyerRent,0)  as [DueValue],
		IsNull([DueRent],0) + IsNull([Expense],0) + IsNull(MaintenanceRent,0) + IsNull(LawyerRent,0)
		- IsNull([PayChecks],0) - IsNull([CachPayment],0) + IsNull([Furniture],0) as [CleanDue]
	into #LawsuitRes2
	From
		#LawsuitRes1
		
	insert into #LawsuitRes2
	(	[Rent],
		[DueRent],
		[Expense],
		[MaintenanceRent],
		[LawyerRent],
		[Furniture],
		[DueValue],
		[PayChecks],
		[CachPayment],
		[CleanDue],
		LawsuitGuid,
		[Kind]
	)
	Select
		isNull(Sum([Rent]),0),
		isNull(Sum([DueRent]),0),
		isNull(Sum([Expense]),0),
		isNull(Sum([MaintenanceRent]),0),
		isNull(Sum([LawyerRent]),0),
		isNull(Sum([Furniture]),0),
		isNull(Sum([DueValue]),0),
		isNull(Sum([PayChecks]),0),
		isNull(Sum([CachPayment]),0),
		isNull(Sum([CleanDue]),0),
		0x0 as LawsuitGuid,
		1 as [Kind]
	from
		#LawsuitRes2
		
	Select 
		*
	from
		#LawsuitRes2
	Order By
		Kind, StartDate
		
	Select 
		*
	from
		#LawsuitRes2
	where
		Kind = 1
		

GO

SET ANSI_NULLS, QUOTED_IDENTIFIER ON
GO

Create Procedure [RepLandRent]
(
	@CustGuid uniqueidentifier = 0x0
	,@Nationality Varchar(256) = ''
	,@LandGuid uniqueidentifier = 0x0
	,@LtnLandName Varchar(256) = ''
	,@LandType Varchar(256) = ''
	,@City Varchar(256) = ''
	,@Region Varchar(256) = ''
	,@Space Varchar(256) = ''
	,@EarthNo Varchar(256) = ''
	,@license Varchar(256) = ''
	,@Side Varchar(256) = ''
	,@FlatArea1 Float = 0
	,@FlatArea2 Float = 0
	,@Unity Varchar(256) = ''
	,@RentState int = 2
	,@ContractState int = 2
	,@Datewith int = 0
	,@Date1 DateTime = '2009-7-1'
	,@Date2 DateTime = '2022-1-2'
	,@RentInfoGuid uniqueidentifier = 0x0
	,@SalesManGuid uniqueidentifier = 0x0
	,@ShowIsCheck Bit = 1
	,@ShowIsNotCheck Bit = 1
	,@Rent1 Float = 0
	,@Rent2 Float = 0
	,@CheckDate Bit = 0

	,@ActiveNote Bit = 0
	,@OperationNote int = 0
	,@RealtyNote  Varchar(256) = '' 
	,@ContractActiveNote Bit = 0
	,@ContractOpNote int = 0
	,@ContractNote  Varchar(256) = '' 
)
 
as
	Set NoCount On 
	--  
	if @OperationNote <> 2 --
	Set @RealtyNote = '%'+@RealtyNote+'%'
	
	--  
	if @ContractOpNote <> 2 --
	Set @ContractNote = '%'+@ContractNote+'%'

	--    
	Select
		[LandGuid],
		Max([FromDate]) as [FromDate]
	Into #LastContract	
	From
		[vwLandContract]
	Group By
		[LandGuid]

	Select 
		Case 
			when [ContractFinish] = 0 and [ToDate] >= GetDate() then [ToDate]
			when [ContractFinish] = 0 and [ToDate] < GetDate() then GetDate()
			when [ContractFinish] = 1  then [ContractFinishDate]
		end as [EndContractDate],
		[C].*
	Into #vwLandContract
	From
		[vwLandContract] [C]
		inner join #LastContract [L] on [L].[LandGuid] = [C].[LandGuid] and [L].[FromDate] = [C].[FromDate]

--	where [ContractFinish] = 0     

	Declare @Tbl Table
	(
		[LandName] Varchar(256)
		,[LtnLandName] Varchar(256)
		,[LandType] Varchar(256)
		,[City] Varchar(256)
		,[Region] Varchar(256)
		,[Space] Varchar(256)
		,[EarthNo] Varchar(256)
		,[license] Varchar(256)
		,[Side] Varchar(256)
		,[Area] Float
		,[Unity] Varchar(256)
		,[State]  Varchar(256)
		,[ContractState] Varchar(256)
		,[CustName] Varchar(256)
		,[CustPhone] Varchar(256)
		,[CustNationality] Varchar(256)
		,[ContractDateBegin] Datetime
		,[ContractDateEnd] Datetime
		,[ContractGuid] uniqueidentifier
		,[Rent] Float
		,[RentAfterDiscount] Float
		,[InsuranceValueOld] Float
		,[InsuranceValue] Float
		,[FlatGuid]uniqueidentifier
		,[EarthNote] Varchar(1000)
		,[ContractNote] Varchar(1000)
		,[ElectricityCounter] Float
	)
	
	Insert into @Tbl 
	Select 
		[A].[Name] as [LandName]
		,[A].[LtnName] as [LtnLandName]
		,[A].[LandType]
		,[A].[City]
		,[A].[Region]
		,[A].[Space]
		,[A].[EarthNo]
		,[A].[license]
		,[A].[Side]
		,[A].[Area] 
		,[A].[Unity]
		,Case when [L].[ContractFinish] = 0 then  dbo.sc('') 
			  else dbo.SC(' ') 
		end as [State]
		
		,Case when [L].[ContractFinish] = 0 then
			 Case when (([L].[ToDate] <= GetDate()) or ([L].[ContractFinish] = 1)) or (@Date2 > [L].[ToDate]) then dbo.sc(' ')  
				  when ([L].[ToDate] > GetDate()) and ([L].[ContractFinish] = 0) then dbo.sc('  ')  end 
		 end as [ContractState]

		,[Cu].[Name] as [CustName]
		,[Cu].[Mobile] as [CustPhone]
		,[Cu].[Nationality]
		,Case when [L].[ContractFinish] = 0 then [L].[FromDate] end as [ContractDateBegin]
		,Case when [L].[ContractFinish] = 0 then [L].[ToDate] end as [ContractDateEnd]
		,Case when [L].[ContractFinish] = 0 then [L].[Guid] end as [ContractGuid]
		,Case when [L].[ContractFinish] = 0 then [L].[Rent] end 
		,Case when [L].[ContractFinish] = 0 then [L].[Rent] - [L].[DiscountValue] end
		,L.[InsuranceValueOld]
		,L.[InsuranceValue]
		,[A].[Guid]
		,[A].[Details] as [Note]
		,[L].[Note2]
		,[ElectricityCounter]
	from 
		[Vwearth] [A]
		left join [#vwLandContract] [L] On [A].[Guid] = [L].[LandGuid] 
										and [L].[Contractkind]  = 7

		left join [vwCustomer] [Cu] on [Cu].[Guid] = [L].[CustomerGuid] 
		left join (
					Select
						Max(Number) as [Number],
						[LandGuid]
					From
						[vwLandContract]
					where 
						[Contractkind]  = 7
					Group By 
						[LandGuid]
					) [LastLease] On [LastLease].[Number] = [L].[Number] and [LastLease].[LandGuid] = [L].[LandGuid]
		left join (
					Select
						Max(Number) as [Number],
						[LandGuid]
					From
						[vwLandContract]
					where 
						[Contractkind]  = 6
					Group By 
						[LandGuid]
					) [Sales] On [Sales].[LandGuid] = [A].[Guid]
 	where
		([Cu].[Guid] = @CustGuid or @CustGuid = 0x0)
		and (Cu.Nationality = @Nationality or @Nationality = '')
		and ([A].[Guid] = @LandGuid or @LandGuid = 0x0)
		and ([A].[LtnName] Like '%'+@LtnLandName+'%')		
		and ([A].[City] Like '%'+@City+'%')
		and ([A].[Region] Like '%'+@Region+'%')
		and ([A].[Space] Like '%'+@Space+'%')
		and ([A].[license] Like '%'+@license+'%')
		and ([A].[Side] Like '%'+@Side+'%')

   		and ([A].[Area] between @FlatArea1 and @FlatArea2 or @FlatArea2 = 0) 
   		and ([Unity] = @Unity or @Unity = '')
   		and (
   				([L].[ContractFinish] = 0 and @RentState = 0)
   				or ( ([L].[Guid] is null or [L].[ContractFinish] = 1) and @RentState = 1)
   				or @RentState = 2
   			)
   		and 
   			(
   				(
   					(([L].[ToDate] <= GetDate()) or ([L].[ContractFinish] = 1) ) and @ContractState = 0
  				)
   			  	or ( 
   					(
   						(([L].[ToDate] > GetDate()) and ([L].[ContractFinish] = 0) ) and @ContractState = 1
   					)
   					)
   				or @ContractState = 2
   			)
   
 
   		and ([L].[RentInfoGuid] = @RentInfoGuid or @RentInfoGuid = 0x0)
   		and ([L].[SalesManGuid] = @SalesManGuid or @SalesManGuid = 0x0)
   		and ([Sales].[LandGuid] is null)
   		and ([L].[Rent] Between @Rent1 and @Rent2 or @Rent2 = 0)
   		and 
   			(
   				
   				Case  when (@OperationNote = 0) and ([A].[Details] Like @RealtyNote) then 1
    					  when (@OperationNote = 1) and ([A].[Details] Not Like @RealtyNote) then 1
   					  when (@OperationNote = 2) and ([A].[Details] = @RealtyNote) then 1
   				else 
   					0 end = 1
   					
   				or @ActiveNote = 0
   			)
   
   		and 
   			(
   				Case  when (@ContractOpNote = 0) and ([L].[Note2] Like @ContractNote) then 1
    					  when (@ContractOpNote = 1) and ([L].[Note2] Not Like @ContractNote) then 1
   					  when (@ContractOpNote = 2) and ([L].[Note2] = @ContractNote) then 1
   				else 
   					0 end = 1
   
   				or @ContractActiveNote = 0
  			)
 

	Select 
		*,
		Case when [R].[ObjGuid] is null then 0 
			 when [R].[ObjGuid] is not null  then 1 end as [Check]
	into #EndRes
	From
		@Tbl [L]
		left join [RepCheck] [R] on [R].[ObjGuid] = [L].[FlatGuid] and [R].[IdReport] = 5001
	where
		([R].[ObjGuid] is not null and @ShowIsCheck = 1)
		or
		([R].[ObjGuid] is null and @ShowIsNotCheck = 1)
	Order By 
		[EarthNo]

	Select 
		* 
	from 
		#EndRes
	Order By 
		[EarthNo]

	Select 
		(Select Count(*) From @Tbl where [State] = dbo.sc('')) as [StateRent],
		(Select Count(*) From @Tbl where [State] = dbo.sc(' ')) as [StateNotRent],
		(Select Sum([Rent]) From @Tbl ) as [Rent],
		(Select Sum([RentAfterDiscount]) From @Tbl ) as [RentAfterDiscount],
		(Select Sum([Area]) From @Tbl where [State] = dbo.sc('')) as [RentArea],
		(Select Sum([Area]) From @Tbl where [State] = dbo.sc(' ')) as [NotRentArea]




GO

SET ANSI_NULLS, QUOTED_IDENTIFIER ON
GO

Create Trigger [TRG_Trace_checks]
on [checks]
 
for update
As
	SET NOCOUNT ON;
	if Not exists(Select Value from DMD_const where vName = 'ActiveLogCardUpdate' and Value = '1' ) return
	
	Declare @UserGuid uniqueidentifier, @Guid uniqueidentifier
	Set @Guid = NEWID()
	
	Select Top 1 @UserGuid = userGuid From CurrentUsers where Spid = @@SPID
			
	insert into [Trace]
	([Guid],[ParentGuid],[Date],[userGuid],[HostName],[ParentTbl])
	Select Top 1
		@Guid,
		N.Guid,
		GETDATE(),
		@UserGuid,
		Host_Name(),
		'checks'
	From
		[inserted] n 
		
	insert into [TraceDetail]
	([ParentGuid],[Caption],[Old],[New])
	Select Top 1
		@Guid,
		' ' as [Caption],
		D.[SecLvl] as [old],
		N.[SecLvl] as [New]
	From
		[deleted] d
		inner join [inserted] n on D.Guid = N.Guid
	where
		N.[SecLvl] <> D.[SecLvl]

	insert into [TraceDetail]
	([ParentGuid],[Caption],[Old],[New])
	Select Top 1
		@Guid,
		'' as [Caption],
		D.[Mark] as [old],
		N.[Mark] as [New]
	From
		[deleted] d
		inner join [inserted] n on D.Guid = N.Guid
	where
		N.[Mark] <> D.[Mark]

	insert into [TraceDetail]
	([ParentGuid],[Caption],[Old],[New])
	Select Top 1
		@Guid,
		' ' as [Caption],
		D.Lawsuit as [old],
		N.Lawsuit as [New]
	From
		[deleted] d
		inner join [inserted] n on D.Guid = N.Guid
	where
		N.Lawsuit <> D.Lawsuit

	insert into [TraceDetail]
	([ParentGuid],[Caption],[Old],[New])
	Select Top 1
		@Guid,
		'' as [Caption],
		D.[NO] as [old],
		N.[NO] as [New]
	From
		[deleted] d
		inner join [inserted] n on D.Guid = N.Guid
	where
		N.[NO] <> D.[NO]

	insert into [TraceDetail]
	([ParentGuid],[Caption],[Old],[New])
	Select Top 1
		@Guid,
		' ' as [Caption],
		D.[InternalNO] as [old],
		N.[InternalNO] as [New]
	From
		[deleted] d
		inner join [inserted] n on D.Guid = N.Guid
	where
		N.[InternalNO] <> D.[InternalNO]

	insert into [TraceDetail]
	([ParentGuid],[Caption],[Old],[New])
	Select Top 1
		@Guid,
		' ' as [Caption],
		D.[ReceiptNo] as [old],
		N.[ReceiptNo] as [New]
	From
		[deleted] d
		inner join [inserted] n on D.Guid = N.Guid
	where
		N.[ReceiptNo] <> D.[ReceiptNo]

	insert into [TraceDetail]
	([ParentGuid],[Caption],[Old],[New])
	Select Top 1
		@Guid,
		'' as [Caption],
		D.[Value] as [old],
		N.[Value] as [New]
	From
		[deleted] d
		inner join [inserted] n on D.Guid = N.Guid
	where
		N.[Value] <> D.[Value]

	insert into [TraceDetail]
	([ParentGuid],[Caption],[Old],[New])
	Select Top 1
		@Guid,
		'' as [Caption],
		D.[CurrencyGUID] as [old],
		N.[CurrencyGUID] as [New]
	From
		[deleted] d
		inner join [inserted] n on D.Guid = N.Guid
	where
		N.[CurrencyGUID] <> D.[CurrencyGUID]

	insert into [TraceDetail]
	([ParentGuid],[Caption],[Old],[New])
	Select Top 1
		@Guid,
		'' as [Caption],
		D.[CurrencyVal] as [old],
		N.[CurrencyVal] as [New]
	From
		[deleted] d
		inner join [inserted] n on D.Guid = N.Guid
	where
		N.[CurrencyVal] <> D.[CurrencyVal]

	insert into [TraceDetail]
	([ParentGuid],[Caption],[Old],[New])
	Select Top 1
		@Guid,
		'' as [Caption],
		dbo.fnDate(D.[Date]) as [old],
		dbo.fnDate(N.[Date]) as [New]
	From
		[deleted] d
		inner join [inserted] n on D.Guid = N.Guid
	where
		N.[Date] <> D.[Date]

	insert into [TraceDetail]
	([ParentGuid],[Caption],[Old],[New])
	Select Top 1
		@Guid,
		' ' as [Caption],
		dbo.fnDate(D.[DueDate]) as [old],
		dbo.fnDate(N.[DueDate]) as [New]
	From
		[deleted] d
		inner join [inserted] n on D.Guid = N.Guid
	where
		N.[DueDate] <> D.[DueDate]

	insert into [TraceDetail]
	([ParentGuid],[Caption],[Old],[New])
	Select Top 1
		@Guid,
		'  ' as [Caption],
		D.[NoneDueDate] as [old],
		N.[NoneDueDate] as [New]
	From
		[deleted] d
		inner join [inserted] n on D.Guid = N.Guid
	where
		N.[NoneDueDate] <> D.[NoneDueDate]

	insert into [TraceDetail]
	([ParentGuid],[Caption],[Old],[New])
	Select Top 1
		@Guid,
		' ' as [Caption],
		D.[BankName] as [old],
		N.[BankName] as [New]
	From
		[deleted] d
		inner join [inserted] n on D.Guid = N.Guid
	where
		N.[BankName] <> D.[BankName]

	insert into [TraceDetail]
	([ParentGuid],[Caption],[Old],[New])
	Select Top 1
		@Guid,
		'' as [Caption],
		D.[Account] as [old],
		N.[Account] as [New]
	From
		[deleted] d
		inner join [inserted] n on D.Guid = N.Guid
	where
		N.[Account] <> D.[Account]

	insert into [TraceDetail]
	([ParentGuid],[Caption],[Old],[New])
	Select Top 1
		@Guid,
		' ' as [Caption],
		D.[CostGuid] as [old],
		N.[CostGuid] as [New]
	From
		[deleted] d
		inner join [inserted] n on D.Guid = N.Guid
	where
		N.[CostGuid] <> D.[CostGuid]

	insert into [TraceDetail]
	([ParentGuid],[Caption],[Old],[New])
	Select Top 1
		@Guid,
		' ' as [Caption],
		D.[ObverseAccount] as [old],
		N.[ObverseAccount] as [New]
	From
		[deleted] d
		inner join [inserted] n on D.Guid = N.Guid
	where
		N.[ObverseAccount] <> D.[ObverseAccount]

	insert into [TraceDetail]
	([ParentGuid],[Caption],[Old],[New])
	Select Top 1
		@Guid,
		'  ' as [Caption],
		D.[CostObverseGuid] as [old],
		N.[CostObverseGuid] as [New]
	From
		[deleted] d
		inner join [inserted] n on D.Guid = N.Guid
	where
		N.[CostObverseGuid] <> D.[CostObverseGuid]

	insert into [TraceDetail]
	([ParentGuid],[Caption],[Old],[New])
	Select Top 1
		@Guid,
		' ' as [Caption],
		D.[Beneficiary] as [old],
		N.[Beneficiary] as [New]
	From
		[deleted] d
		inner join [inserted] n on D.Guid = N.Guid
	where
		N.[Beneficiary] <> D.[Beneficiary]

	insert into [TraceDetail]
	([ParentGuid],[Caption],[Old],[New])
	Select Top 1
		@Guid,
		'' as [Caption],
		LEFT(D.[Note], 255) as [old],
		LEFT(N.[Note], 255) as [New]
	From
		[deleted] d
		inner join [inserted] n on D.Guid = N.Guid
	where
		N.[Note] <> D.[Note]

	insert into [TraceDetail]
	([ParentGuid],[Caption],[Old],[New])
	Select Top 1
		@Guid,
		' ' as [Caption],
		LEFT(D.[Note2], 255) as [old],
		LEFT(N.[Note2], 255) as [New]
	From
		[deleted] d
		inner join [inserted] n on D.Guid = N.Guid
	where
		N.[Note2] <> D.[Note2]

	insert into [TraceDetail]
	([ParentGuid],[Caption],[Old],[New])
	Select Top 1
		@Guid,
		'' as [Caption],
		D.[Note3] as [old],
		N.[Note3] as [New]
	From
		[deleted] d
		inner join [inserted] n on D.Guid = N.Guid
	where
		N.[Note3] <> D.[Note3]

	insert into [TraceDetail]
	([ParentGuid],[Caption],[Old],[New])
	Select Top 1
		@Guid,
		' 2' as [Caption],
		D.[Note4] as [old],
		N.[Note4] as [New]
	From
		[deleted] d
		inner join [inserted] n on D.Guid = N.Guid
	where
		N.[Note4] <> D.[Note4]

	insert into [TraceDetail]
	([ParentGuid],[Caption],[Old],[New])
	Select Top 1
		@Guid,
		'' as [Caption],
		D.[ContractGuid] as [old],
		N.[ContractGuid] as [New]
	From
		[deleted] d
		inner join [inserted] n on D.Guid = N.Guid
	where
		N.[ContractGuid] <> D.[ContractGuid]

	insert into [TraceDetail]
	([ParentGuid],[Caption],[Old],[New])
	Select Top 1
		@Guid,
		'' as [Caption],
		D.[UserGuid] as [old],
		N.[UserGuid] as [New]
	From
		[deleted] d
		inner join [inserted] n on D.Guid = N.Guid
	where
		N.[UserGuid] <> D.[UserGuid]

	insert into [TraceDetail]
	([ParentGuid],[Caption],[Old],[New])
	Select Top 1
		@Guid,
		'' as [Caption],
		D.[BranchGuid] as [old],
		N.[BranchGuid] as [New]
	From
		[deleted] d
		inner join [inserted] n on D.Guid = N.Guid
	where
		N.[BranchGuid] <> D.[BranchGuid]

	insert into [TraceDetail]
	([ParentGuid],[Caption],[Old],[New])
	Select Top 1
		@Guid,
		' ' as [Caption],
		D.[SalesManGuid] as [old],
		N.[SalesManGuid] as [New]
	From
		[deleted] d
		inner join [inserted] n on D.Guid = N.Guid
	where
		N.[SalesManGuid] <> D.[SalesManGuid]

	insert into [TraceDetail]
	([ParentGuid],[Caption],[Old],[New])
	Select Top 1
		@Guid,
		' ' as [Caption],
		dbo.fnDate(D.[FolderDate]) as [old],
		dbo.fnDate(N.[FolderDate]) as [New]
	From
		[deleted] d
		inner join [inserted] n on D.Guid = N.Guid
	where
		N.[FolderDate] <> D.[FolderDate]

	insert into [TraceDetail]
	([ParentGuid],[Caption],[Old],[New])
	Select Top 1
		@Guid,
		' ' as [Caption],
		D.[FolderInternalNo] as [old],
		N.[FolderInternalNo] as [New]
	From
		[deleted] d
		inner join [inserted] n on D.Guid = N.Guid
	where
		N.[FolderInternalNo] <> D.[FolderInternalNo]

	insert into [TraceDetail]
	([ParentGuid],[Caption],[Old],[New])
	Select Top 1
		@Guid,
		'  ' as [Caption],
		D.[FolderExternalNo] as [old],
		N.[FolderExternalNo] as [New]
	From
		[deleted] d
		inner join [inserted] n on D.Guid = N.Guid
	where
		N.[FolderExternalNo] <> D.[FolderExternalNo]

	insert into [TraceDetail]
	([ParentGuid],[Caption],[Old],[New])
	Select Top 1
		@Guid,
		' ' as [Caption],
		D.[CheckCreateEntry] as [old],
		N.[CheckCreateEntry] as [New]
	From
		[deleted] d
		inner join [inserted] n on D.Guid = N.Guid
	where
		N.[CheckCreateEntry] <> D.[CheckCreateEntry]

	insert into [TraceDetail]
	([ParentGuid],[Caption],[Old],[New])
	Select Top 1
		@Guid,
		'' as [Caption],
		D.[IsRounded] as [old],
		N.[IsRounded] as [New]
	From
		[deleted] d
		inner join [inserted] n on D.Guid = N.Guid
	where
		N.[IsRounded] <> D.[IsRounded]

	insert into [TraceDetail]
	([ParentGuid],[Caption],[Old],[New])
	Select Top 1
		@Guid,
		' ' as [Caption],
		D.[Deposition] as [old],
		N.[Deposition] as [New]
	From
		[deleted] d
		inner join [inserted] n on D.Guid = N.Guid
	where
		N.[Deposition] <> D.[Deposition]

		
	delete Trace From Trace t left join [TraceDetail] D on T.guid = D.ParentGuid
	where
		d.ParentGuid is Null and t.Guid = @Guid


GO

SET ANSI_NULLS, QUOTED_IDENTIFIER ON
GO

Create Procedure [RepLandSales]
(
    @CustGuid uniqueidentifier = 0x0,
    @LandName Varchar(256) = '',
    @LtnLandName Varchar(256) = '',
    @LandType Varchar(256) = '',
    @City Varchar(256) = '',
    @Region Varchar(256) = '',
    @Space Varchar(256) = '',
    @EarthNo Varchar(256) = '',
    @license Varchar(256) = '',
    @Side Varchar(256) = '',
    @FlatArea1 Float = 0,
    @FlatArea2 Float = 0,
	@unity Varchar(256) = '',
    @Date1 Datetime = '1/1/2010',
    @Date2 Datetime = '1/1/2011',
    @SalesManGuid uniqueidentifier = 0x0,
    @ShowIsCheck Bit = 1,
    @ShowIsNotCheck Bit = 1,
    @CheckDate Bit = 1,
    @ActiveNote Bit = 1,
    @OperationNote Varchar(256) = '',
    @RealtyNote Varchar(256) = '',
    @ContractActiveNote bit = 0,
    @ContractOpNote Varchar(256) = '',
    @ContractNote Varchar(256) = '',
    @SalesState int = 0
)
 
as
	
	Set NoCount On 
	--  
	if @OperationNote <> 2 --
	Set @RealtyNote = '%'+@RealtyNote+'%'
	
	--  
	if @ContractOpNote <> 2 --
	Set @ContractNote = '%'+@ContractNote+'%'

	Declare @Tbl Table
	(
		[LandName] Varchar(256)
		,[LtnLandName] Varchar(256)
		,[LandType] Varchar(256)
		,[City] Varchar(256)
		,[Region] Varchar(256)
		,[Space] Varchar(256)
		,[EarthNo] Varchar(256)
		,[license] Varchar(256)
		,[Area]  Float
		,[Side]  Varchar(256)
		,[State]  Varchar(256)
		,[CustName] Varchar(256)
		,[CustPhone] Varchar(256)
		,[ContractDateBegin] Datetime
		,[ContractValue] Float
		,[LandNote] Varchar(1000)
		,[ContractNote] Varchar(1000)
		,[ContractGuid] uniqueidentifier
		,[LandGuid] uniqueidentifier
	)
	
	insert Into @Tbl
	Select 
		[A].[Name] as [LandName]
		,[A].[LtnName] as [LtnLandName]
		,[A].[LandType]
		,[A].[City]
		,[A].[Region]
		,[A].[Space]
		,[A].[EarthNo]
		,[A].[license]
		,[A].[Area]
		,[A].[Side]
		,Case when [L].[Guid] is null then dbo.sc(' ') else dbo.sc('') end as [State]
		,[Cu].[Name] as [CustName]
		,[Cu].[Mobile] as [CustPhone]
		,[L].[FromDate] as [ContractDateBegin]
		,([L].[Rent] - [L].[DiscountValue]) * [L].[CurrencyVal] as [ContractValue]
		,[A].[Details] as [Note]
		,[L].[Note2]
		,[L].[Guid] as [ContractGuid]
		,[A].[Guid]
	from 
		[vwEarth] [A]
		left join [vwLandContract] [L] On [A].[Guid] = [L].[LandGuid] and [ContractKind]  = 6
		left join [vwCustomer] [Cu] on [Cu].[Guid] = [L].[CustomerGuid] 
 	where
 		([Cu].[Guid] = @CustGuid or @CustGuid = 0x0)
		and (
				([L].[Guid] is not null and @SalesState = 0)
				or ([L].[Guid] is null and @SalesState = 1)
				or @SalesState = 2
			)
		and 
			(
				([L].[FromDate] between @Date1 and @Date2)
				or @SalesState <> 0
			)

		and ([L].[SalesManGuid] = @SalesManGuid or @SalesManGuid = 0x0)

		and ([A].[Name] Like '%'+@LandName+'%')
		and ([A].[LtnName] Like '%'+@LtnLandName+'%')		
		and ([A].[City] Like '%'+@City+'%')
		and ([A].[Region] Like '%'+@Region+'%')
		and ([A].[Space] Like '%'+@Space+'%')
		and ([A].[license] Like '%'+@license+'%')
		and ([A].[Side] Like '%'+@Side+'%')

   		and ([A].[Area] between @FlatArea1 and @FlatArea2 or @FlatArea2 = 0) 
   		and ([Unity] = @Unity or @Unity = '')
   		and 
   			(
   				
   				Case  when (@OperationNote = 0) and ([A].[Details] Like @RealtyNote) then 1
    					  when (@OperationNote = 1) and ([A].[Details] Not Like @RealtyNote) then 1
   					  when (@OperationNote = 2) and ([A].[Details] = @RealtyNote) then 1
   				else 
   					0 end = 1
   					
   				or @ActiveNote = 0
   			)
   
   		and 
   			(
   				Case  when (@ContractOpNote = 0) and ([L].[Note2] Like @ContractNote) then 1
    					  when (@ContractOpNote = 1) and ([L].[Note2] Not Like @ContractNote) then 1
   					  when (@ContractOpNote = 2) and ([L].[Note2] = @ContractNote) then 1
   				else 
   					0 end = 1
   
   				or @ContractActiveNote = 0
  			)


	-- 
	Select
		[P].[ContractGuid],
		Sum(IsNull([C1].[Value] * [C1].[CurrencyVal],0)) as [Collection]
--		+  IsNull([pc].[Value] * [pc].[CurrencyVal],0)) 
	Into #Collection
	From
		[vwChecks] [P]
		left join [vwChecksCollection] [C1] on [C1].[CheckGuid] = [P].[Guid] and [C1].[Kind] = 1
--		left join [ChecksPartialCollection] [pc] on [pc].[CheckGuid] = [P].[Guid]
		inner join @Tbl [t] on [t].[ContractGuid] = [P].[ContractGuid]
	Group By
		[P].[ContractGuid]

	-- 
	Select
		[P].[ContractGuid],
		Sum(IsNull([P].[Value] * [P].[CurrencyVal],0)) as [Cash]
	Into #Cash
	From
		[vwContractCachPayment] [P]
		inner join @Tbl [t] on [t].[ContractGuid] = [P].[ContractGuid]
	Group By
		[P].[ContractGuid]

	Select 
		[T].*,
		[C].[Collection],
		[h].[Cash],
		IsNull([C].[Collection],0) + IsNull([h].[Cash],0) as [TotalPays],
		[ContractValue] - IsNull([C].[Collection],0) - IsNull([h].[Cash],0) as [ContractRest]
	Into #EndTbl
	From
		@Tbl [t] 
		left join #Collection [C] on [t].[ContractGuid] = [C].[ContractGuid]
		left join #Cash [h] on [t].[ContractGuid] = [h].[ContractGuid]
	Order By 
		[LandName]


	Select 
		*,
		Case when [R].[ObjGuid] is null then 0 
			 when [R].[ObjGuid] is not null  then 1 end as [Check]
	into #EndRes
	From
		#EndTbl [L]
		left join [RepCheck] [R] on [R].[ObjGuid] = [L].LandGuid and [R].[IdReport] = 5003
	where
		([R].[ObjGuid] is not null and @ShowIsCheck = 1)
		or
		([R].[ObjGuid] is null and @ShowIsNotCheck = 1)
	Order By 
		[LandName]


	Select 
		* 
	from 
		#EndRes
	Order By 
		[LandName]


GO

SET ANSI_NULLS, QUOTED_IDENTIFIER ON
GO

Create Trigger [TRG_Trace_Apartment]
on [Apartment]
 for update
As
	SET NOCOUNT ON;
	if Not exists(Select Value from DMD_const where vName = 'ActiveLogCardUpdate' and Value = '1' ) return
	
	Declare @UserGuid uniqueidentifier, @Guid uniqueidentifier
	Set @Guid = NEWID()
	
	Select Top 1 @UserGuid = userGuid From CurrentUsers where Spid = @@SPID
			
	insert into [Trace]
	([Guid],[ParentGuid],[Date],[userGuid],[HostName])
	Select Top 1
		@Guid,
		N.Guid,
		GETDATE(),
		@UserGuid,
		Host_Name()
	From
		[inserted] n 
		
	insert into [TraceDetail]
	([ParentGuid],[Caption],[Old],[New],[Tbl])
	Select Top 1
		@Guid,
		' ' as [Caption],
		D.[SecLvl] as [old],
		N.[SecLvl] as [New],
		''
	From
		[deleted] d
		inner join [inserted] n on D.Guid = N.Guid
	where
		N.[SecLvl] <> D.[SecLvl]
		
	insert into [TraceDetail]
	([ParentGuid],[Caption],[Old],[New],[Tbl])
	Select Top 1
		@Guid,
		'' as [Caption],
		D.[Ban] as [old],
		N.[Ban] as [New],
		''
	From
		[deleted] d
		inner join [inserted] n on D.Guid = N.Guid
	where
		N.[Ban] <> D.[Ban]

	insert into [TraceDetail]
	([ParentGuid],[Caption],[Old],[New],[Tbl])
	Select Top 1
		@Guid,
		' ' as [Caption],
		D.[CardKind] as [old],
		N.[CardKind] as [New],
		''
	From
		[deleted] d
		inner join [inserted] n on D.Guid = N.Guid
	where
		N.[CardKind] <> D.[CardKind]
		
	insert into [TraceDetail]
	([ParentGuid],[Caption],[Old],[New],[Tbl])
	Select Top 1
		@Guid,
		'  ' as [Caption],
		D.[Judicial] as [old],
		N.[Judicial] as [New],
		''
	From
		[deleted] d
		inner join [inserted] n on D.Guid = N.Guid
	where
		N.[Judicial] <> D.[Judicial]
		
	insert into [TraceDetail]
	([ParentGuid],[Caption],[Old],[New],[Tbl])
	Select Top 1
		@Guid,
		'' as [Caption],
		D.[NO] as [old],
		N.[NO] as [New],
		''
	From
		[deleted] d
		inner join [inserted] n on D.Guid = N.Guid
	where
		N.[NO] <> D.[NO]
		
	insert into [TraceDetail]
	([ParentGuid],[Caption],[Old],[New],[Tbl])
	Select Top 1
		@Guid,
		'' as [Caption],
		D.[BuildingGuid] as [old],
		N.[BuildingGuid] as [New],
		'[Building]'
	From
		[deleted] d
		inner join [inserted] n on D.Guid = N.Guid
	where
		N.[BuildingGuid] <> D.[BuildingGuid]
		
	insert into [TraceDetail]
	([ParentGuid],[Caption],[Old],[New],[Tbl])
	Select Top 1
		@Guid,
		'' as [Caption],
		D.[FloorNo] as [old],
		N.[FloorNo] as [New],
		''
	From
		[deleted] d
		inner join [inserted] n on D.Guid = N.Guid
	where
		N.[FloorNo] <> D.[FloorNo]
		
	insert into [TraceDetail]
	([ParentGuid],[Caption],[Old],[New],[Tbl])
	Select Top 1
		@Guid,
		'' as [Caption],
		D.[Area] as [old],
		N.[Area] as [New],
		''
	From
		[deleted] d
		inner join [inserted] n on D.Guid = N.Guid
	where
		N.[Area] <> D.[Area]
		
	insert into [TraceDetail]
	([ParentGuid],[Caption],[Old],[New],[Tbl])
	Select Top 1
		@Guid,
		'' as [Caption],
		D.[unity] as [old],
		N.[unity] as [New],
		''
	From
		[deleted] d
		inner join [inserted] n on D.Guid = N.Guid
	where
		N.[unity] <> D.[unity]
		
	insert into [TraceDetail]
	([ParentGuid],[Caption],[Old],[New],[Tbl])
	Select Top 1
		@Guid,
		'' as [Caption],
		D.[ApartmentType] as [old],
		N.[ApartmentType] as [New],
		''
	From
		[deleted] d
		inner join [inserted] n on D.Guid = N.Guid
	where
		N.[ApartmentType] <> D.[ApartmentType]
		
	insert into [TraceDetail]
	([ParentGuid],[Caption],[Old],[New],[Tbl])
	Select Top 1
		@Guid,
		' ' as [Caption],
		D.[FlatKind] as [old],
		N.[FlatKind] as [New],
		''
	From
		[deleted] d
		inner join [inserted] n on D.Guid = N.Guid
	where
		N.[FlatKind] <> D.[FlatKind]
		
	insert into [TraceDetail]
	([ParentGuid],[Caption],[Old],[New],[Tbl])
	Select Top 1
		@Guid,
		'' as [Caption],
		D.[Class] as [old],
		N.[Class] as [New],
		''
	From
		[deleted] d
		inner join [inserted] n on D.Guid = N.Guid
	where
		N.[Class] <> D.[Class]
		
	insert into [TraceDetail]
	([ParentGuid],[Caption],[Old],[New],[Tbl])
	Select Top 1
		@Guid,
		'' as [Caption],
		D.[Overlooking] as [old],
		N.[Overlooking] as [New],
		''
	From
		[deleted] d
		inner join [inserted] n on D.Guid = N.Guid
	where
		N.[Overlooking] <> D.[Overlooking]
		
	insert into [TraceDetail]
	([ParentGuid],[Caption],[Old],[New],[Tbl])
	Select Top 1
		@Guid,
		' ' as [Caption],
		D.[CostPrice] as [old],
		N.[CostPrice] as [New],
		''
	From
		[deleted] d
		inner join [inserted] n on D.Guid = N.Guid
	where
		N.[CostPrice] <> D.[CostPrice]
		
	insert into [TraceDetail]
	([ParentGuid],[Caption],[Old],[New],[Tbl])
	Select Top 1
		@Guid,
		'' as [Caption],
		D.[CostCurrencyGUID] as [old],
		N.[CostCurrencyGUID] as [New],
		'Currency'
	From
		[deleted] d
		inner join [inserted] n on D.Guid = N.Guid
	where
		N.[CostCurrencyGUID] <> D.[CostCurrencyGUID]
		
	insert into [TraceDetail]
	([ParentGuid],[Caption],[Old],[New],[Tbl])
	Select Top 1
		@Guid,
		'' as [Caption],
		D.[Note] as [old],
		N.[Note] as [New],
		''
	From
		[deleted] d
		inner join [inserted] n on D.Guid = N.Guid
	where
		N.[Note] <> D.[Note]
		
	insert into [TraceDetail]
	([ParentGuid],[Caption],[Old],[New],[Tbl])
	Select Top 1
		@Guid,
		' ' as [Caption],
		D.[CostGuid] as [old],
		N.[CostGuid] as [New],
		'[Cost]'
	From
		[deleted] d
		inner join [inserted] n on D.Guid = N.Guid
	where
		N.[CostGuid] <> D.[CostGuid]
		
	insert into [TraceDetail]
	([ParentGuid],[Caption],[Old],[New],[Tbl])
	Select Top 1
		@Guid,
		'' as [Caption],
		D.[FlatOwner] as [old],
		N.[FlatOwner] as [New],
		''
	From
		[deleted] d
		inner join [inserted] n on D.Guid = N.Guid
	where
		N.[FlatOwner] <> D.[FlatOwner]
		
	insert into [TraceDetail]
	([ParentGuid],[Caption],[Old],[New],[Tbl])
	Select Top 1
		@Guid,
		'' as [Caption],
		D.[Details] as [old],
		N.[Details] as [New],
		''
	From
		[deleted] d
		inner join [inserted] n on D.Guid = N.Guid
	where
		N.[Details] <> D.[Details]
		
	insert into [TraceDetail]
	([ParentGuid],[Caption],[Old],[New],[Tbl])
	Select Top 1
		@Guid,
		' ' as [Caption],
		D.[OfferState] as [old],
		N.[OfferState] as [New],
		''
	From
		[deleted] d
		inner join [inserted] n on D.Guid = N.Guid
	where
		N.[OfferState] <> D.[OfferState]
		
	insert into [TraceDetail]
	([ParentGuid],[Caption],[Old],[New],[Tbl])
	Select Top 1
		@Guid,
		' ' as [Caption],
		D.[OfferType] as [old],
		N.[OfferType] as [New],
		''
	From
		[deleted] d
		inner join [inserted] n on D.Guid = N.Guid
	where
		N.[OfferType] <> D.[OfferType]
		
	insert into [TraceDetail]
	([ParentGuid],[Caption],[Old],[New],[Tbl])
	Select Top 1
		@Guid,
		'' as [Caption],
		D.[CustomerName] as [old],
		N.[CustomerName] as [New],
		''
	From
		[deleted] d
		inner join [inserted] n on D.Guid = N.Guid
	where
		N.[CustomerName] <> D.[CustomerName]
		
	insert into [TraceDetail]
	([ParentGuid],[Caption],[Old],[New],[Tbl])
	Select Top 1
		@Guid,
		' ' as [Caption],
		D.[CustomerPhone] as [old],
		N.[CustomerPhone] as [New],
		''
	From
		[deleted] d
		inner join [inserted] n on D.Guid = N.Guid
	where
		N.[CustomerPhone] <> D.[CustomerPhone]
		
	insert into [TraceDetail]
	([ParentGuid],[Caption],[Old],[New],[Tbl])
	Select Top 1
		@Guid,
		'' as [Caption],
		D.[Restrained] as [old],
		N.[Restrained] as [New],
		''
	From
		[deleted] d
		inner join [inserted] n on D.Guid = N.Guid
	where
		N.[Restrained] <> D.[Restrained]
		
	insert into [TraceDetail]
	([ParentGuid],[Caption],[Old],[New],[Tbl])
	Select Top 1
		@Guid,
		' ' as [Caption],
		D.[PayValue] as [old],
		N.[PayValue] as [New],
		''
	From
		[deleted] d
		inner join [inserted] n on D.Guid = N.Guid
	where
		N.[PayValue] <> D.[PayValue]
		
	insert into [TraceDetail]
	([ParentGuid],[Caption],[Old],[New],[Tbl])
	Select Top 1
		@Guid,
		' ' as [Caption],
		D.[BathroomCount] as [old],
		N.[BathroomCount] as [New],
		''
	From
		[deleted] d
		inner join [inserted] n on D.Guid = N.Guid
	where
		N.[BathroomCount] <> D.[BathroomCount]
		
	insert into [TraceDetail]
	([ParentGuid],[Caption],[Old],[New],[Tbl])
	Select Top 1
		@Guid,
		' ' as [Caption],
		D.[BalconyCount] as [old],
		N.[BalconyCount] as [New],
		''
	From
		[deleted] d
		inner join [inserted] n on D.Guid = N.Guid
	where
		N.[BalconyCount] <> D.[BalconyCount]
		
	insert into [TraceDetail]
	([ParentGuid],[Caption],[Old],[New],[Tbl])
	Select Top 1
		@Guid,
		'  ' as [Caption],
		D.[WaterCounter] as [old],
		N.[WaterCounter] as [New],
		''
	From
		[deleted] d
		inner join [inserted] n on D.Guid = N.Guid
	where
		N.[WaterCounter] <> D.[WaterCounter]
		
	insert into [TraceDetail]
	([ParentGuid],[Caption],[Old],[New],[Tbl])
	Select Top 1
		@Guid,
		'  ' as [Caption],
		D.[ElectricityCounter] as [old],
		N.[ElectricityCounter] as [New],
		''
	From
		[deleted] d
		inner join [inserted] n on D.Guid = N.Guid
	where
		N.[ElectricityCounter] <> D.[ElectricityCounter]
		
	insert into [TraceDetail]
	([ParentGuid],[Caption],[Old],[New],[Tbl])
	Select Top 1
		@Guid,
		' ' as [Caption],
		D.[RestrainedUserGuid] as [old],
		N.[RestrainedUserGuid] as [New],
		''
	From
		[deleted] d
		inner join [inserted] n on D.Guid = N.Guid
	where
		N.[RestrainedUserGuid] <> D.[RestrainedUserGuid]
		
		
	insert into [TraceDetail]
	([ParentGuid],[Caption],[Old],[New],[Tbl])
	Select Top 1
		@Guid,
		'' as [Caption],
		D.[CustGuid] as [old],
		N.[CustGuid] as [New],
		'Customer'
	From
		[deleted] d
		inner join [inserted] n on D.Guid = N.Guid
	where
		N.[CustGuid] <> D.[CustGuid]
		
		
	insert into [TraceDetail]
	([ParentGuid],[Caption],[Old],[New],[Tbl])
	Select Top 1
		@Guid,
		' ' as [Caption],
		D.[LtnFlatKind] as [old],
		N.[LtnFlatKind] as [New],
		''
	From
		[deleted] d
		inner join [inserted] n on D.Guid = N.Guid
	where
		N.[LtnFlatKind] <> D.[LtnFlatKind]
		
	insert into [TraceDetail]
	([ParentGuid],[Caption],[Old],[New],[Tbl])
	Select Top 1
		@Guid,
		'' as [Caption],
		D.[LtnApartmentType] as [old],
		N.[LtnApartmentType] as [New],
		''
	From
		[deleted] d
		inner join [inserted] n on D.Guid = N.Guid
	where
		N.[LtnApartmentType] <> D.[LtnApartmentType]
		
	insert into [TraceDetail]
	([ParentGuid],[Caption],[Old],[New],[Tbl])
	Select Top 1
		@Guid,
		'' as [Caption],
		D.[LtnClass] as [old],
		N.[LtnClass] as [New],
		''
	From
		[deleted] d
		inner join [inserted] n on D.Guid = N.Guid
	where
		N.[LtnClass] <> D.[LtnClass]
		
	insert into [TraceDetail]
	([ParentGuid],[Caption],[Old],[New],[Tbl])
	Select Top 1
		@Guid,
		'' as [Caption],
		D.[LtnOverlooking] as [old],
		N.[LtnOverlooking] as [New],
		''
	From
		[deleted] d
		inner join [inserted] n on D.Guid = N.Guid
	where
		N.[LtnOverlooking] <> D.[LtnOverlooking]
		
	delete Trace From Trace t left join [TraceDetail] D on T.guid = D.ParentGuid
	where
		d.ParentGuid is Null and t.Guid = @Guid


GO

SET ANSI_NULLS, QUOTED_IDENTIFIER ON
GO

Create Procedure [PrcIncomeSure]
(
	@CurrencyVal Float = 1
	,@Date1 DateTime = '1/1/2015'
	,@Date2 DateTime = '12/31/2016'
	,@RoundKind int  = 0
	,@ShowIsCheck Bit = 1
	,@ShowIsNotCheck Bit = 1
	,@EndState int = 2
	,@DateWith int = 0
	,@IncomDate1 DateTime = '1/1/2015'
	,@IncomDate2 DateTime = '12/31/2016'
)
 
as
	
	Declare @Tbl Table
	(
		[RealtyNo] Varchar(256)
		,[ContractNo] Varchar(256)
		,[ContractNumber] int
		,[ContractTypeName] Varchar(256)
		,[BuildingName] Varchar(256)
		,[StrKind] Varchar(256)
		,[FlatName] Varchar(256)
		,[RentPrice] Float
		,[FromDate] DateTime
		,[ToDate] DateTime
		,[EndDate] DateTime
		,[Days] Int
		,[DayPrice] Float
		,[DayPeriod] Int
		,[Income] Float
		,[Check] Bit
		,[ContractFinish] Bit
		,[ContractGuid] uniqueidentifier
		,[FlatGuid] uniqueidentifier
		,[AccountGuid] uniqueidentifier
		,[CostGuid] uniqueidentifier
		,[Kind] Int
		,[Sort] int
	)

	Declare @PCheck Bit 
	Set @PCheck = 1	
	Declare @PNotCheck Bit 
	Set @PNotCheck = 0

	Insert Into @Tbl
	Select 
		[F].[NO]
		,[ContractNo]
		,c.[Number] as [ContractNumber]
		,c.TypeName as [ContractTypeName]
		,[F].[BuildingName]
		,dbo.SC('') as [StrKind]
		,[F].[No]+' '+[F].[ApartmentType] as [FlatName]
		,[C].[RentAfterDiscount] * [C].[CurrencyVal] / @CurrencyVal as [RentPrice]
		,[FromDate]
		,[ToDate]
		,[ContractFinishDate]
		,DateDiff(Day, [FromDate], [ToDate])  +1  as [Days]
		,0 as [DayPrice]
		,dbo.FnDayDiff([FromDate], [Enddate], @IncomDate1, @IncomDate2) +1 as [DayPeriod]
		,0 as [Income]
		,Case when [Rc].[ObjGuid] is null then @PNotCheck
			 when [Rc].[ObjGuid] is not null  then @PCheck end as [Check]
		,C.[ContractFinish]
		,[C].[Guid] as [ContractGuid]
		,[F].[Guid]
		,C.[CustAccountGuid]
		,C.[CostGuid]
		,0
		,0
	From 
		[vwLeaseApartment] [C]
		inner join [vwApartment] [F] on [F].[Guid] = [C].[ApartmentGuid]
		inner join [Resource] [R] on [R].[Guid] = [C].[BuildingGuid]  and [R].[Spid] = @@Spid
		inner join [Resource] [R2] on [R2].[Guid] = [C].[TypeGuid]  and [R2].[Spid] = @@Spid
		left join [RepCheck] [Rc] on [Rc].[ObjGuid] = [C].[Guid] and [Rc].[IdReport] = 10
	where
		([LeaseKind] = 0)
		and dbo.FnDayDiff([FromDate], [EndDate], @IncomDate1, @IncomDate2) >= 0
		and
		(
			([Rc].[ObjGuid] is not null and @ShowIsCheck = 1)
			or
			([Rc].[ObjGuid] is null and @ShowIsNotCheck = 1)
		)
		and ([C].[ContractFinish] = @EndState or @EndState = 2)
		and (
				([EditDate] Between @date1 and @Date2 And @DateWith = 3) or
				([FromDate] Between @date1 and @Date2 And @DateWith = 0) or
				([ToDate] Between @date1 and @Date2 And @DateWith = 1) or
				([EndDate] Between @date1 and @Date2 And @DateWith = 2)
			)
	--Select * from @Tbl return
		
	Insert Into @Tbl
	Select 
		[F].[No]
		,[ContractNo]
		,c.[Number] as [ContractNumber]
		,c.TypeName as [ContractTypeName]
		,[F].[BuildingName]
		,dbo.SC('')
		,[F].[No]+' ' as [FlatName]
		,[C].[RentAfterDiscount] * [C].[CurrencyVal] / @CurrencyVal as [RentPrice]
		,[FromDate]
		,[ToDate]
		,[ContractFinishDate]
		,DateDiff(Day, [FromDate], [ToDate]) +1  as [Days]
		,0 as [DayPrice]
		,dbo.FnDayDiff([FromDate], [Enddate], @IncomDate1, @IncomDate2)  +1 as [DayPeriod]
		,0 as [Income]
		,Case when [Rc].[ObjGuid] is null then @PNotCheck
			 when [Rc].[ObjGuid] is not null  then @PCheck end as [Check]
		,C.[ContractFinish]
		,[C].[Guid] as [ContractGuid]
		,[F].[Guid]
		,C.[CustAccountGuid]
		,C.[CostGuid]
		,1
		,0 
	From 
		[vwLeaseApartment] [C]
		inner join [vwShop] [F] on [F].[Guid] = [C].[ShopGuid]
		inner join [Resource] [R] on [R].[Guid] = [C].[BuildingGuid]  and [R].[Spid] = @@Spid
		inner join [Resource] [R2] on [R2].[Guid] = [C].[TypeGuid]  and [R2].[Spid] = @@Spid
		left join [RepCheck] [Rc] on [Rc].[ObjGuid] = [C].[Guid] and [Rc].[IdReport] = 10
	where
		([LeaseKind] = 1)
		and dbo.FnDayDiff([FromDate], [EndDate], @IncomDate1, @IncomDate2) >= 0
		and
		(
			([Rc].[ObjGuid] is not null and @ShowIsCheck = 1)
			or
			([Rc].[ObjGuid] is null and @ShowIsNotCheck = 1)
		)
		and ([C].[ContractFinish] = @EndState or @EndState = 2)
		and (
				([EditDate] Between @date1 and @Date2 And @DateWith = 3) or
				([FromDate] Between @date1 and @Date2 And @DateWith = 0) or
				([ToDate] Between @date1 and @Date2 And @DateWith = 1) or
				([EndDate] Between @date1 and @Date2 And @DateWith = 2)
			)


	
	Insert Into @Tbl
	Select 
		[F].[No]
		,[ContractNo]
		,c.[Number] as [ContractNumber]
		,c.TypeName as [ContractTypeName]
		,[F].[BuildingName]
		,dbo.SC('')
		,[F].[No]+' ' as [FlatName]
		,[C].[Rent] * [C].[CurrencyVal] / @CurrencyVal as [RentPrice]
		,[FromDate]
		,[ToDate]
		,[ContractFinishDate]
		,DateDiff(Day, [FromDate], [ToDate]) +1  as [Days]
		,0 as [DayPrice]
		,dbo.FnDayDiff([FromDate], [Enddate], @IncomDate1, @IncomDate2)  +1 as [DayPeriod]
		,0 as [Income]
		,Case when [Rc].[ObjGuid] is null then @PNotCheck
			 when [Rc].[ObjGuid] is not null  then @PCheck end as [Check]
		,C.[ContractFinish]
		,[C].[Guid] as [ContractGuid]
		,[F].[Guid]
		,C.[CustAccountGuid]
		,C.[CostGuid]
		,1
		,0 
	From 
		[vwParkingContract] [C]
		inner join [vwParking] [F] on [F].[Guid] = [C].[ParkingGuid]
		inner join [Resource] [R] on [R].[Guid] = [C].[BuildingGuid]  and [R].[Spid] = @@Spid
		inner join [Resource] [R2] on [R2].[Guid] = [C].[TypeGuid]  and [R2].[Spid] = @@Spid
		left join [RepCheck] [Rc] on [Rc].[ObjGuid] = [C].[Guid] and [Rc].[IdReport] = 10
	where
		([ContractKind] = 4)
		and dbo.FnDayDiff([FromDate], [EndDate], @IncomDate1, @IncomDate2) >= 0
		and
		(
			([Rc].[ObjGuid] is not null and @ShowIsCheck = 1)
			or
			([Rc].[ObjGuid] is null and @ShowIsNotCheck = 1)
		)
		and ([C].[ContractFinish] = @EndState or @EndState = 2)
		and (
				([EditDate] Between @date1 and @Date2 And @DateWith = 3) or
				([FromDate] Between @date1 and @Date2 And @DateWith = 0) or
				([ToDate] Between @date1 and @Date2 And @DateWith = 1) or
				([EndDate] Between @date1 and @Date2 And @DateWith = 2)
			)

	
	Insert Into @Tbl
	Select 
		[F].[Name]
		,[ContractNo]
		,c.[Number] as [ContractNumber]
		,c.TypeName as [ContractTypeName]
		,''
		,dbo.SC('')
		,[F].[Name]+' ' as [FlatName]
		,[C].[Rent] * [C].[CurrencyVal] / @CurrencyVal as [RentPrice]
		,[FromDate]
		,[ToDate]
		,[ContractFinishDate]
		,DateDiff(Day, [FromDate], [ToDate]) +1  as [Days]
		,0 as [DayPrice]
		,dbo.FnDayDiff([FromDate], [Enddate], @IncomDate1, @IncomDate2)  +1 as [DayPeriod]
		,0 as [Income]
		,Case when [Rc].[ObjGuid] is null then @PNotCheck
			 when [Rc].[ObjGuid] is not null  then @PCheck end as [Check]
		,C.[ContractFinish]
		,[C].[Guid] as [ContractGuid]
		,[F].[Guid]
		,C.[CustAccountGuid]
		,C.[CostGuid]
		,1
		,0 
	From 
		[vwLandContract] [C]
		inner join [vwEarth] [F] on [F].[Guid] = [C].[landGuid]
		inner join [Resource] [R2] on [R2].[Guid] = [C].[TypeGuid]  and [R2].[Spid] = @@Spid
		left join [RepCheck] [Rc] on [Rc].[ObjGuid] = [C].[Guid] and [Rc].[IdReport] = 10
	where
		([ContractKind] = 7)
		and dbo.FnDayDiff([FromDate], [EndDate], @IncomDate1, @IncomDate2) >= 0
		and
		(
			([Rc].[ObjGuid] is not null and @ShowIsCheck = 1)
			or
			([Rc].[ObjGuid] is null and @ShowIsNotCheck = 1)
		)
		and ([C].[ContractFinish] = @EndState or @EndState = 2)
		and (
				([EditDate] Between @date1 and @Date2 And @DateWith = 3) or
				([FromDate] Between @date1 and @Date2 And @DateWith = 0) or
				([ToDate] Between @date1 and @Date2 And @DateWith = 1) or
				([EndDate] Between @date1 and @Date2 And @DateWith = 2)
			)


	Insert Into @Tbl
	Select 
		[F].[Name]
		,[ContractNo]
		,c.[Number] as [ContractNumber]
		,c.TypeName as [ContractTypeName]
		,''
		,dbo.SC('')
		,[F].[Name]+' ' as [FlatName]
		,[C].[Rent] * [C].[CurrencyVal] / @CurrencyVal as [RentPrice]
		,[FromDate]
		,[ToDate]
		,[ContractFinishDate]
		,DateDiff(Day, [FromDate], [ToDate]) +1  as [Days]
		,0 as [DayPrice]
		,dbo.FnDayDiff([FromDate], [Enddate], @IncomDate1, @IncomDate2)  +1 as [DayPeriod]
		,0 as [Income]
		,Case when [Rc].[ObjGuid] is null then @PNotCheck
			 when [Rc].[ObjGuid] is not null  then @PCheck end as [Check]
		,C.[ContractFinish]
		,[C].[Guid] as [ContractGuid]
		,[F].[Guid]
		,C.[CustAccountGuid]
		,C.[CostGuid]
		,1
		,0 
	From
		[vwLandContract] [C]
		inner join [vwVilla] [F] on [F].[Guid] = [C].[VillaGuid]
		inner join [Resource] [R2] on [R2].[Guid] = [C].[TypeGuid]  and [R2].[Spid] = @@Spid
		left join [RepCheck] [Rc] on [Rc].[ObjGuid] = [C].[Guid] and [Rc].[IdReport] = 10
	where
		([ContractKind] = 9)
		and dbo.FnDayDiff([FromDate], [EndDate], @IncomDate1, @IncomDate2) >= 0
		and
		(
			([Rc].[ObjGuid] is not null and @ShowIsCheck = 1)
			or
			([Rc].[ObjGuid] is null and @ShowIsNotCheck = 1)
		)
		and ([C].[ContractFinish] = @EndState or @EndState = 2)
		and (
				([EditDate] Between @date1 and @Date2 And @DateWith = 3) or
				([FromDate] Between @date1 and @Date2 And @DateWith = 0) or
				([ToDate] Between @date1 and @Date2 And @DateWith = 1) or
				([EndDate] Between @date1 and @Date2 And @DateWith = 2)
			)

	update @Tbl Set [DayPeriod] = Case when [DayPeriod] = 1 then 0 else [DayPeriod] end
	update @Tbl Set [DayPrice] = [RentPrice] / [Days]
	update @Tbl Set [Income] = dbo.FnMyRound([DayPrice] * [DayPeriod], @RoundKind)

	-------------------------
	-- 
	Select
		C1.date,
		[P].[ContractGuid],
		Sum(IsNull([P].[Value] * [P].[CurrencyVal],0)) as [Total],
		Sum(IsNull([C1].[Value] * [C1].[CurrencyVal],0)) as [Collection]
	Into #CollectionAll
	From
		[vwChecks] [P]
		left join [vwChecksCollection] [C1] on [C1].[CheckGuid] = [P].[Guid] and [C1].[Kind] = 1
		left join [vwChecksCollection] [C3] on [C3].[CheckGuid] = [P].[Guid] and [C3].[Kind] = 3
		inner join @Tbl [t] on [t].[ContractGuid] = [P].[ContractGuid]
		inner join CheckType CT on CT.Guid = p.TypeGuid
	WHERE
		CT.CollectedEntryTypeGuid Is Null
		and [C3].checkGuid is Null
	Group By
		[C1].[date],
		[P].[ContractGuid] 
		
	-- 
	Select
		[ContractGuid],
		Sum(IsNull([Total],0)) as [Total],
		Sum(IsNull([Collection],0)) as [Collection]
	Into #Collection
	From
		#CollectionAll
	Group By
		[ContractGuid] 
		
		
	Select
		[ContractGuid],
		Sum(IsNull([Total],0)) as [Total],
		Sum(IsNull([Collection],0)) as [Collection]
	Into #CollectionIncom
	From
		#CollectionAll
	where
		Date Between @IncomDate1 and @IncomDate2
	Group By
		[ContractGuid] 

	--Select * from #Collection where ContractGuid = 'B7867C14-4D4C-4CBC-BA65-DCB22E950C29'

	-- 
	Create Table [#CashAll]
	(
		[Date] Datetime,
		[ContractGuid] uniqueidentifier,
		[Cash] Float
	)
	
	insert into [#CashAll]
	Select
		p.Date,
		[P].[ContractGuid],
		Sum(IsNull([P].[Value] * [P].[CurrencyVal],0)) as [Cash]
	From
		[vwContractCachPayment] [P]
		inner join @Tbl [t] on [t].[ContractGuid] = [P].[ContractGuid] and P.AcGuid = t.AccountGuid
	Group By
		p.Date,
		[P].[ContractGuid]

	insert into [#CashAll]
	Select
		p.Date,
		[P].[ContractGuid],
		Sum(IsNull([P].[Value] * [P].[CurrencyVal],0)) as [Cash]
	From
		[vwContractParkingCachPayment] [P]
		inner join @Tbl [t] on [t].[ContractGuid] = [P].[ContractGuid] and P.AcGuid = t.AccountGuid
	Group By
		p.Date,
		[P].[ContractGuid]

	insert into [#CashAll]
	Select
		p.Date,
		[P].[ContractGuid],
		Sum(IsNull([P].[Value] * [P].[CurrencyVal],0)) as [Cash]
	From
		vwLandContractCachPayment [P]
		inner join @Tbl [t] on [t].[ContractGuid] = [P].[ContractGuid] and P.AcGuid = t.AccountGuid
	Group By
		p.Date,
		[P].[ContractGuid]

	Select 
		ContractGuid,
		SUM([Cash]) as [Cash]
	into #Cash
	From
		#CashAll
	Group By
		ContractGuid
		
	Select 
		ContractGuid,
		SUM([Cash]) as [Cash]
	into #CashIncom
	From
		#CashAll
	where
		Date between @IncomDate1 and @IncomDate2
	Group By
		ContractGuid
	
	-----------------
	Create Table #EndRes
	(
		[RealtyNo] Varchar(256)
		,[ContractNo] Varchar(256)
		,[ContractNumber] int
		,[ContractTypeName] Varchar(256)
		,[BuildingName] Varchar(256)
		,[StrKind] Varchar(256)
		,[FlatName] Varchar(256)
		,[RentPrice] Float
		,[FromDate] DateTime
		,[ToDate] DateTime
		,[EndDate] DateTime
		,[Days] Int
		,[DayPrice] Float
		,[DayPeriod] Int
		,[Income] Float
		,[Check] Bit
		,[ContractFinish] Bit
		,[ContractGuid] uniqueidentifier
		,[FlatGuid] uniqueidentifier
		,[AccountGuid] uniqueidentifier
		,[CostGuid] uniqueidentifier
		,[Kind] Int
		,[Sort] int
		,[Collection] Float
		,[CollectionIncom] Float
		,[CheckNotCollection] Float
		,[Cash] Float
		,[CashIncom] Float
		,[TotalPays] Float
		,[ContractRest] Float
		,[CustBalance] Float
		,[GLCustBalance] Float
	)
		
	insert into #EndRes
	Select 
		t.*,
		isNull([C].[Collection],0) as [Collection],
		isNull([CCI].[Collection],0) as [CollectionIncom],
		isNull([C].[Total],0) - isNull([C].[Collection],0) as [CheckNotCollection],
		isNull([h].[Cash],0) as [Cash],
		isNull([CI].[Cash],0) as [CashIncom],
		IsNull([C].[Collection],0) + IsNull([h].[Cash],0) as [TotalPays],
		isNull(T.[RentPrice],0) - IsNull([C].[Collection],0) - IsNull([h].[Cash],0) as [ContractRest],
		isNull(t.[RentPrice],0) - IsNull([h].[Cash],0) - isNull([C].[Total],0) as [CustBalance],
		0
	From
		@Tbl [t] 
		left join #Collection [C] on [t].[ContractGuid] = [C].[ContractGuid]
		left join #CollectionIncom [CCI] on [t].[ContractGuid] = [CCI].[ContractGuid]
		left join #Cash [h] on [t].[ContractGuid] = [h].[ContractGuid]
		left join #CashIncom [CI] on [t].[ContractGuid] = [CI].[ContractGuid]
		left join [RepCheck] [R] on [R].[ObjGuid] = [t].[FlatGuid] and [R].[IdReport] = 5000
	
	Update #EndRes Set [GLCustBalance] = isNull(Ac.SumDebit,0) - isNull(Ac.SumCredit,0)
	From
		#EndRes E
		inner join account ac on ac.Guid = E.AccountGuid
	--Select [Total], [Collection],[CheckNotCollection], * from #EndRes where ContractGuid = 'B7867C14-4D4C-4CBC-BA65-DCB22E950C29'
-------------------------

	Insert into #EndRes
	Select
		''
		,'' as [ContractNo]
		,0
		,''
		,'' as [BuildingName]
		,'' as [StrKind]
		,'' as [FlatName]
		,dbo.FnMyRound(Sum([RentPrice]), @RoundKind)
		,0 as [FromDate]
		,0 as [ToDate]
		,0 as [EndDate]
		,Sum([Days])
		,0 as [DayPrice]
		,Sum([DayPeriod])
		,Sum([Income]) --dbo.FnMyRound(Sum([Income]), @RoundKind)
		,0 as [Check]
		,0 as [ContractFinish]
		,0x0 as [ContractGuid]
		,0x0 as [FlatGuid]
		,0x0 as [CustAccountGuid]
		,0x0 as [CostGuid]
		,-1 as [Kind]
		,1 as [Sort]
		,Sum([Collection])
		,Sum([CollectionIncom])
		,Sum([CheckNotCollection])
		,Sum([Cash])
		,Sum([Cashincom])
		,Sum([TotalPays])
		,Sum([ContractRest])
		,Sum([CustBalance])
		,Sum([GLCustBalance])
	From
		#EndRes
		
	Select 
		[E].*
	from 
		#EndRes  [E]
	Order By Sort
	
	Select
		dbo.FnMyRound(Sum([RentPrice]), @RoundKind) as [RentPrice]
		,Sum([Days]) as [Days]
		,Sum([DayPeriod]) as [DayPeriod]
		,Sum([Income]) as  [Income]
		,Sum([Collection]) as [Collection]
		,Sum([CollectionIncom]) as [CollectionIncom]
		,Sum([CheckNotCollection]) as [CheckNotCollection]
		,Sum([Cash]) as [Cash]
		,Sum([CashIncom]) as [CashIncom]
		,Sum([TotalPays]) as [TotalPays]
		,Sum([ContractRest]) as [ContractRest]
		--,Sum([CustBalance]) as [CustBalance]
	From
		#EndRes
	where
		[Sort] = 0
	

GO

SET ANSI_NULLS, QUOTED_IDENTIFIER ON
GO

Create Trigger [TRG_Trace_OfferPrice]
on [OfferPrice]
 
for update
As
	SET NOCOUNT ON;
	if Not exists(Select Value from DMD_const where vName = 'ActiveLogCardUpdate' and Value = '1' ) return
	
	Declare @UserGuid uniqueidentifier, @Guid uniqueidentifier
	Set @Guid = NEWID()
	
	Select Top 1 @UserGuid = userGuid From CurrentUsers where Spid = @@SPID
			
	insert into [Trace]
	([Guid],[ParentGuid],[Date],[userGuid],[HostName])
	Select Top 1
		@Guid,
		N.Guid,
		GETDATE(),
		@UserGuid,
		Host_Name()
	From
		[inserted] n 
		
	insert into [TraceDetail]
	([ParentGuid],[Caption],[Old],[New],[Tbl])
	Select Top 1
		@Guid,
		' ' as [Caption],
		D.[SecLvl] as [old],
		N.[SecLvl] as [New],
		''
	From
		[deleted] d
		inner join [inserted] n on D.Guid = N.Guid
	where
		N.[SecLvl] <> D.[SecLvl]
		
	insert into [TraceDetail]
	([ParentGuid],[Caption],[Old],[New],[Tbl])
	Select Top 1
		@Guid,
		'' as [Caption],
		dbo.fnDate(D.[Date]) as [old],
		dbo.fnDate(N.[Date]) as [New],
		''
	From
		[deleted] d
		inner join [inserted] n on D.Guid = N.Guid
	where
		N.[Date] <> D.[Date]
		
	insert into [TraceDetail]
	([ParentGuid],[Caption],[Old],[New],[Tbl])
	Select Top 1
		@Guid,
		'' as [Caption],
		D.[CustomerName] as [old],
		N.[CustomerName] as [New],
		''
	From
		[deleted] d
		inner join [inserted] n on D.Guid = N.Guid
	where
		N.[CustomerName] <> D.[CustomerName]
		
	insert into [TraceDetail]
	([ParentGuid],[Caption],[Old],[New],[Tbl])
	Select Top 1
		@Guid,
		' ' as [Caption],
		D.[CustomerPhone] as [old],
		N.[CustomerPhone] as [New],
		''
	From
		[deleted] d
		inner join [inserted] n on D.Guid = N.Guid
	where
		N.[CustomerPhone] <> D.[CustomerPhone]
		
	insert into [TraceDetail]
	([ParentGuid],[Caption],[Old],[New],[Tbl])
	Select Top 1
		@Guid,
		' ' as [Caption],
		D.[OfferKind] as [old],
		N.[OfferKind] as [New],
		''
	From
		[deleted] d
		inner join [inserted] n on D.Guid = N.Guid
	where
		N.[OfferKind] <> D.[OfferKind]
		
	insert into [TraceDetail]
	([ParentGuid],[Caption],[Old],[New],[Tbl])
	Select Top 1
		@Guid,
		'' as [Caption],
		D.[BuildingGuid] as [old],
		N.[BuildingGuid] as [New],
		'[Building]'
	From
		[deleted] d
		inner join [inserted] n on D.Guid = N.Guid
	where
		N.[BuildingGuid] <> D.[BuildingGuid]
		
	insert into [TraceDetail]
	([ParentGuid],[Caption],[Old],[New],[Tbl])
	Select Top 1
		@Guid,
		'' as [Caption],
		D.[RealtyGuid] as [old],
		N.[RealtyGuid] as [New],
		''
	From
		[deleted] d
		inner join [inserted] n on D.Guid = N.Guid
	where
		N.[RealtyGuid] <> D.[RealtyGuid]
		
	insert into [TraceDetail]
	([ParentGuid],[Caption],[Old],[New],[Tbl])
	Select Top 1
		@Guid,
		'' as [Caption],
		D.[Price] as [old],
		N.[Price] as [New],
		''
	From
		[deleted] d
		inner join [inserted] n on D.Guid = N.Guid
	where
		N.[Price] <> D.[Price]
		
	insert into [TraceDetail]
	([ParentGuid],[Caption],[Old],[New],[Tbl])
	Select Top 1
		@Guid,
		' ' as [Caption],
		D.[DiscountPercent] as [old],
		N.[DiscountPercent] as [New],
		''
	From
		[deleted] d
		inner join [inserted] n on D.Guid = N.Guid
	where
		N.[DiscountPercent] <> D.[DiscountPercent]
		
	insert into [TraceDetail]
	([ParentGuid],[Caption],[Old],[New],[Tbl])
	Select Top 1
		@Guid,
		' ' as [Caption],
		D.[DiscountValue] as [old],
		N.[DiscountValue] as [New],
		''
	From
		[deleted] d
		inner join [inserted] n on D.Guid = N.Guid
	where
		N.[DiscountValue] <> D.[DiscountValue]
		
	insert into [TraceDetail]
	([ParentGuid],[Caption],[Old],[New],[Tbl])
	Select Top 1
		@Guid,
		'  ' as [Caption],
		D.[PriceAfterDiscount] as [old],
		N.[PriceAfterDiscount] as [New],
		''
	From
		[deleted] d
		inner join [inserted] n on D.Guid = N.Guid
	where
		N.[PriceAfterDiscount] <> D.[PriceAfterDiscount]
		
	insert into [TraceDetail]
	([ParentGuid],[Caption],[Old],[New],[Tbl])
	Select Top 1
		@Guid,
		' ' as [Caption],
		D.[FirstPay] as [old],
		N.[FirstPay] as [New],
		''
	From
		[deleted] d
		inner join [inserted] n on D.Guid = N.Guid
	where
		N.[FirstPay] <> D.[FirstPay]
		
	insert into [TraceDetail]
	([ParentGuid],[Caption],[Old],[New],[Tbl])
	Select Top 1
		@Guid,
		'  ' as [Caption],
		dbo.fnDate(D.[FirstPayDate]) as [old],
		dbo.fnDate(N.[FirstPayDate]) as [New],
		''
	From
		[deleted] d
		inner join [inserted] n on D.Guid = N.Guid
	where
		N.[FirstPayDate] <> D.[FirstPayDate]
		
	insert into [TraceDetail]
	([ParentGuid],[Caption],[Old],[New],[Tbl])
	Select Top 1
		@Guid,
		' ' as [Caption],
		D.[InstCount] as [old],
		N.[InstCount] as [New],
		''
	From
		[deleted] d
		inner join [inserted] n on D.Guid = N.Guid
	where
		N.[InstCount] <> D.[InstCount]
		
	insert into [TraceDetail]
	([ParentGuid],[Caption],[Old],[New],[Tbl])
	Select Top 1
		@Guid,
		' ' as [Caption],
		D.[More] as [old],
		N.[More] as [New],
		''
	From
		[deleted] d
		inner join [inserted] n on D.Guid = N.Guid
	where
		N.[More] <> D.[More]
		
	insert into [TraceDetail]
	([ParentGuid],[Caption],[Old],[New],[Tbl])
	Select Top 1
		@Guid,
		' ' as [Caption],
		D.[InstType] as [old],
		N.[InstType] as [New],
		''
	From
		[deleted] d
		inner join [inserted] n on D.Guid = N.Guid
	where
		N.[InstType] <> D.[InstType]
		
	insert into [TraceDetail]
	([ParentGuid],[Caption],[Old],[New],[Tbl])
	Select Top 1
		@Guid,
		'  ' as [Caption],
		dbo.fnDate(D.[FirstinsDate]) as [old],
		dbo.fnDate(N.[FirstinsDate]) as [New],
		''
	From
		[deleted] d
		inner join [inserted] n on D.Guid = N.Guid
	where
		N.[FirstinsDate] <> D.[FirstinsDate]
		
	insert into [TraceDetail]
	([ParentGuid],[Caption],[Old],[New],[Tbl])
	Select Top 1
		@Guid,
		' ' as [Caption],
		D.[OneInstallment] as [old],
		N.[OneInstallment] as [New],
		''
	From
		[deleted] d
		inner join [inserted] n on D.Guid = N.Guid
	where
		N.[OneInstallment] <> D.[OneInstallment]
		
	insert into [TraceDetail]
	([ParentGuid],[Caption],[Old],[New],[Tbl])
	Select Top 1
		@Guid,
		' ' as [Caption],
		D.[LastPay] as [old],
		N.[LastPay] as [New],
		''
	From
		[deleted] d
		inner join [inserted] n on D.Guid = N.Guid
	where
		N.[LastPay] <> D.[LastPay]
		
	insert into [TraceDetail]
	([ParentGuid],[Caption],[Old],[New],[Tbl])
	Select Top 1
		@Guid,
		'' as [Caption],
		D.[Details] as [old],
		N.[Details] as [New],
		''
	From
		[deleted] d
		inner join [inserted] n on D.Guid = N.Guid
	where
		N.[Details] <> D.[Details]
		
	insert into [TraceDetail]
	([ParentGuid],[Caption],[Old],[New],[Tbl])
	Select Top 1
		@Guid,
		'' as [Caption],
		D.[Note] as [old],
		N.[Note] as [New],
		''
	From
		[deleted] d
		inner join [inserted] n on D.Guid = N.Guid
	where
		N.[Note] <> D.[Note]
		
	insert into [TraceDetail]
	([ParentGuid],[Caption],[Old],[New],[Tbl])
	Select Top 1
		@Guid,
		'' as [Caption],
		D.[No] as [old],
		N.[No] as [New],
		''
	From
		[deleted] d
		inner join [inserted] n on D.Guid = N.Guid
	where
		N.[No] <> D.[No]
		
	insert into [TraceDetail]
	([ParentGuid],[Caption],[Old],[New],[Tbl])
	Select Top 1
		@Guid,
		'' as [Caption],
		D.[CurrencyGUID] as [old],
		N.[CurrencyGUID] as [New],
		'Currency'
	From
		[deleted] d
		inner join [inserted] n on D.Guid = N.Guid
	where
		N.[CurrencyGUID] <> D.[CurrencyGUID]
		
	insert into [TraceDetail]
	([ParentGuid],[Caption],[Old],[New],[Tbl])
	Select Top 1
		@Guid,
		'' as [Caption],
		D.[CurrencyVal] as [old],
		N.[CurrencyVal] as [New],
		''
	From
		[deleted] d
		inner join [inserted] n on D.Guid = N.Guid
	where
		N.[CurrencyVal] <> D.[CurrencyVal]

	delete Trace From Trace t left join [TraceDetail] D on T.guid = D.ParentGuid
	where
		d.ParentGuid is Null and t.Guid = @Guid


GO

SET ANSI_NULLS, QUOTED_IDENTIFIER ON
GO

Create Procedure [PrcPrintEntry]
(
	@Guid uniqueidentifier = 'C3045A11-744B-4CD1-A4E2-31AEF4D741C9',

	@TotalDebit Float = 50,
	@TotalCredit Float = 400,
	@EndDebit Float = 400,
	@EndCredit Float = 440,

	@OnlyTotalDebit Varchar(256) = '',
	@OnlyTotalDebitAr Varchar(256) = '',
	@OnlyTotalDebitLtn Varchar(256) = '',
	@OnlyTotalCredit Varchar(256) = '',
	@OnlyTotalCreditAr Varchar(256) = '',
	@OnlyTotalCreditLtn Varchar(256) = '',
	@OnlyEndDebit Varchar(256) = '',
	@OnlyEndCredit Varchar(256) = ''
)
 
as
	
	Declare @ObverseAc uniqueidentifier
	Select Top 1 
		@ObverseAc = [AcGuid]
	From
		[Secondary_EntryDetail]
	where
		[ParentGuid] = @Guid


		-- 
	Declare @FlatNo Varchar(256),
			@BuildingName Varchar(256),
			@BuildingArName Varchar(256),
			@BuildingLtnName Varchar(256),
			@FromDate DateTime,
			@ToDate DateTime,
			@Emirate Varchar(256),
			@BuildingArea Varchar(256),
			@Suburb Varchar(256),
			@Street Varchar(256),
			@BasinNo Varchar(256),
			@PieceNo Varchar(256),
			@BuildingNo VARCHAR(256),
			@BondType VARCHAR(256),
			@BondNo VARCHAR(256),
			@FlatKind VARCHAR(256),
			@ApartmentType VARCHAR(256),
			@Class VARCHAR(256),
			@Area Float,
			@unity VARCHAR(256),
			--
			@ContractNo VARCHAR(256),
			@ContractValue Float,
			@ContractValueWithDiscount Float,
			@ContractDiscountValue Float
			
	Select
			@FlatNo = [FlatNo],
			@BuildingName = [BuildingName],
			@BuildingArName = [BuildingArName],
			@BuildingLtnName = [BuildingLtnName],
			@FromDate = [FromDate],
			@ToDate = [ToDate],
			@Emirate = [Emirate],
			@BuildingArea = [L].[BuildingArea],
			@Suburb = [Suburb],
			@Street = [Street],
			@BasinNo = [BasinNo],
			@PieceNo = [PieceNo],
			@BuildingNo = [BuildingNo],
			@BondType = [BondType],
			@BondNo = [BondNo],
			@FlatKind = [L].[FlatKind],
			@ApartmentType = [L].[ApartmentType],
			@Class = [Class],
			@Area = [FlatArea],
			@unity = [FlatAreaunity],
			
			@ContractNo = l.ContractNo,
			@ContractValue = L.Rent,
			@ContractValueWithDiscount = L.RentAfterDiscount,
			@ContractDiscountValue = L.DiscountValue
			
	From
		[ContractCachPayment] [C]
		inner join [vwLeaseApartment] [L] on [L].[Guid] = [C].[ContractGuid]
--		inner join [Building] [B] on [B].[Guid] = [L].[BuildingGuid]
--		inner join [Apartment] [F] on [F].[Guid] = [L].[ApartmentGuid]
	where 
		[EntryGuid] = @Guid

	
	Select 
		[S].[Number],
		[S].[SecLvl],
		[S].[Kind],
		[Ac].[Code] as [AccountCode],
		[Ac].[Name] as [Account],
		[Ac].[ArName] as [AccountArName],
		[Ac].[LtnName] as [AccountLtnName],
		Ac.Balance as AccountBalance,
		[S].[Date],
		dbo.FnFormatDate(S.Date) as [Date_Gr],
		[S].[Note],
		[my].[Code] as [Currency],
		[S].[CurrencyVal],
		[S].[ReceiptNo],

		(Select [Code] From [vwAccount] where [Guid] = @ObverseAc) as [ObverseAccountCode],
		(Select [Name] From [vwAccount] where [Guid] = @ObverseAc) as [ObverseAccountName],
		(Select [ArName] From [vwAccount] where [Guid] = @ObverseAc) as [ObverseAccountArName],
		(Select [LtnName] From [vwAccount] where [Guid] = @ObverseAc) as [ObverseAccountLtnName],

		@TotalDebit as [TotalDebit],
		@TotalCredit as [TotalCredit],
		@EndDebit as [EndDebit],
		@EndCredit as [EndCredit],

		@OnlyTotalDebit as [OnlyTotalDebit],
		@OnlyTotalDebitAr as [OnlyTotalDebitAr],
		@OnlyTotalDebitLtn as [OnlyTotalDebitLtn],
		@OnlyTotalCredit as [OnlyTotalCredit],
		@OnlyTotalCreditAr as [OnlyTotalCreditAr],
		@OnlyTotalCreditLtn as [OnlyTotalCreditLtn],
		@OnlyEndDebit as [OnlyEndDebit],
		@OnlyEndCredit as [OnlyEndCredit],
	
		@FlatNo As [FlatNo],
		@BuildingName As [BuildingName],
		@BuildingArName As [BuildingArName],
		@BuildingLtnName As [BuildingLtnName],
		@FromDate as [FromDate],
		dbo.FnFormatDate(@FromDate) as [FromDate_Gr],
		@ToDate as [ToDate],
		dbo.FnFormatDate(@ToDate) as [ToDate_Gr],
		@Emirate As [Emirate],
		@BuildingArea As [BuildingArea],
		@Suburb As [Suburb],
		@Street As [Street],
		@BasinNo As [BasinNo],
		@PieceNo As [PieceNo],
		@BuildingNo As [BuildingNo],
		@BondType As [BondType],
		@BondNo As [BondNo],
		@FlatKind As [FlatKind],
		@ApartmentType As [ApartmentType],
		@Class As [Class],
		@Area As [FlatArea],
		@unity as [FlatAreaunity],

		@ContractNo as [ContractNo],
		@ContractValue as [ContractValue],
		@ContractValueWithDiscount as [ContractValueWithDiscount],
		@ContractDiscountValue as [ContractDiscountValue],

		[Sl].[Name] as [SalesMan],
		[T].[Code] as [TypeCode],
		[T].[Name] as [TypeName],
		[T].[LtnName] as [TypeLtnName],
		[T].[Code]+CAST(S.Number as Varchar(256)) as [TypeCode_Number],

		(Select Top 1 [UserName] From vwRealty_LogCard where CardGuid = S.Guid order by Date) as [CreateByUser],
		(Select Top 1 [Date] From vwRealty_LogCard where CardGuid = S.Guid order by Date) as [CreateDate],
		(Select Top 1 [UserName] From vwRealty_LogCard where CardGuid = S.Guid order by Date desc) as [LastUpdateByUser],
		(Select Top 1 [Date] From vwRealty_LogCard where CardGuid = S.Guid order by Date desc) as [LastUpdateDate]
		
	From 
		[Secondary_Entry] [S]
		left join [vwAccount] [Ac] on [Ac].[Guid] = [S].[AccountGuid]
		left join [vwCurrency] [My] On [My].[Guid] = [S].[CurrencyGuid]
		left join [vwSalesMan] [Sl] on [Sl].[Guid] = [S].[SalesManGuid]
		inner join [EntryType] T on T.Guid = S.TypeGuid
	where
		[S].[Guid] = @Guid Or @Guid = 0x0

	Select
		[S].[Number],
		[S].[ParentGuid],

		[Ac].[Code] as [AccountCode],
		[Ac].[Name] as [Account],
		[Ac].[ArName] as [AccountArName],
		[Ac].[LtnName] as [AccountLtnName],

		Ac.Balance as AccountBalance,
		[S].[Debit],
		[S].[Credit],
		[my].[Code] as [Currency],
		[S].[CurrencyVal],
		[ac2].[code]+'-'+[Ac2].[Name] as [ObverseAccount],
		[co].[code]+'-'+[co].[Name] as [Cost],
		[S].[Note],
		[Cu].[BankName] as [CustBankName],
		[Cu].[BankAccCode] as [CustBankAccCode]
	From	
		[Secondary_EntryDetail] [S]
		left join [vwaccount] [ac] on [ac].[Guid] = [S].[AcGuid]
		left join [vwaccount] [ac2] on [ac2].[Guid] = [S].[ObverseAcGuid]
		left join [vwCurrency] [My] On [My].[Guid] = [S].[CurrencyGuid]
		left join [vwCost] [co] On [co].[Guid] = [S].[CostGuid]
		left join [vwCustomer] Cu on Cu.AcGuid = S.AcGuid
	where
		[S].[ParentGuid] = @Guid Or @Guid = 0x0
	Order By
		[S].[Number]

GO

SET ANSI_NULLS, QUOTED_IDENTIFIER ON
GO

Create Trigger [TRG_Trace_Bill]
on [Bill]
 
for update
As
	SET NOCOUNT ON;
	if Not exists(Select Value from DMD_const where vName = 'ActiveLogCardUpdate' and Value = '1' ) return
	
	Declare @UserGuid uniqueidentifier, @Guid uniqueidentifier
	Set @Guid = NEWID()
	
	Select Top 1 @UserGuid = userGuid From CurrentUsers where Spid = @@SPID
			
	insert into [Trace]
	([Guid],[ParentGuid],[Date],[userGuid],[HostName],ParentTbl)
	Select Top 1
		@Guid,
		N.Guid,
		GETDATE(),
		@UserGuid,
		Host_Name(),
		'Bill'
	From
		[inserted] n 
		
	insert into [TraceDetail]
	([ParentGuid],[Caption],[Old],[New],[Tbl])
	Select Top 1
		@Guid,
		' ' as [Caption],
		D.[SecLvl] as [old],
		N.[SecLvl] as [New],
		''
	From
		[deleted] d
		inner join [inserted] n on D.Guid = N.Guid
	where
		N.[SecLvl] <> D.[SecLvl]
				
	insert into [TraceDetail]
	([ParentGuid],[Caption],[Old],[New],[Tbl])
	Select Top 1
		@Guid,
		'' as [Caption],
		dbo.fnDate(D.[Date]) as [old],
		dbo.fnDate(N.[Date]) as [New],
		''
	From
		[deleted] d
		inner join [inserted] n on D.Guid = N.Guid
	where
		N.[Date] <> D.[Date]
		
	insert into [TraceDetail]
	([ParentGuid],[Caption],[Old],[New],[Tbl])
	Select Top 1
		@Guid,
		'' as [Caption],
		D.[CustGuid] as [old],
		N.[CustGuid] as [New],
		'Customer'
	From
		[deleted] d
		inner join [inserted] n on D.Guid = N.Guid
	where
		N.[CustGuid] <> D.[CustGuid]
		
	insert into [TraceDetail]
	([ParentGuid],[Caption],[Old],[New],[Tbl])
	Select Top 1
		@Guid,
		'' as [Caption],
		D.[CurrencyGuid] as [old],
		N.[CurrencyGuid] as [New],
		'Currency'
	From
		[deleted] d
		inner join [inserted] n on D.Guid = N.Guid
	where
		N.[CurrencyGuid] <> D.[CurrencyGuid]
		
	insert into [TraceDetail]
	([ParentGuid],[Caption],[Old],[New],[Tbl])
	Select Top 1
		@Guid,
		'' as [Caption],
		D.[CurrencyVal] as [old],
		N.[CurrencyVal] as [New],
		''
	From
		[deleted] d
		inner join [inserted] n on D.Guid = N.Guid
	where
		N.[CurrencyVal] <> D.[CurrencyVal]
		
	insert into [TraceDetail]
	([ParentGuid],[Caption],[Old],[New],[Tbl])
	Select Top 1
		@Guid,
		' ' as [Caption],
		D.[PayType] as [old],
		N.[PayType] as [New],
		''
	From
		[deleted] d
		inner join [inserted] n on D.Guid = N.Guid
	where
		N.[PayType] <> D.[PayType]
		
	insert into [TraceDetail]
	([ParentGuid],[Caption],[Old],[New],[Tbl])
	Select Top 1
		@Guid,
		'' as [Caption],
		D.[StoreGuid] as [old],
		N.[StoreGuid] as [New],
		'Store'
	From
		[deleted] d
		inner join [inserted] n on D.Guid = N.Guid
	where
		N.[StoreGuid] <> D.[StoreGuid]
		
	insert into [TraceDetail]
	([ParentGuid],[Caption],[Old],[New],[Tbl])
	Select Top 1
		@Guid,
		' ' as [Caption],
		D.[CustAccGuid] as [old],
		N.[CustAccGuid] as [New],
		'[Account]'
	From
		[deleted] d
		inner join [inserted] n on D.Guid = N.Guid
	where
		N.[CustAccGuid] <> D.[CustAccGuid]
		
	insert into [TraceDetail]
	([ParentGuid],[Caption],[Old],[New],[Tbl])
	Select Top 1
		@Guid,
		' ' as [Caption],
		D.[CostGuid] as [old],
		N.[CostGuid] as [New],
		'[Cost]'
	From
		[deleted] d
		inner join [inserted] n on D.Guid = N.Guid
	where
		N.[CostGuid] <> D.[CostGuid]
		
	insert into [TraceDetail]
	([ParentGuid],[Caption],[Old],[New],[Tbl])
	Select Top 1
		@Guid,
		'' as [Caption],
		D.[BranchGuid] as [old],
		N.[BranchGuid] as [New],
		'Branch'
	From
		[deleted] d
		inner join [inserted] n on D.Guid = N.Guid
	where
		N.[BranchGuid] <> D.[BranchGuid]
		
	insert into [TraceDetail]
	([ParentGuid],[Caption],[Old],[New],[Tbl])
	Select Top 1
		@Guid,
		'' as [Caption],
		D.[Class] as [old],
		N.[Class] as [New],
		''
	From
		[deleted] d
		inner join [inserted] n on D.Guid = N.Guid
	where
		N.[Class] <> D.[Class]
		
	insert into [TraceDetail]
	([ParentGuid],[Caption],[Old],[New],[Tbl])
	Select Top 1
		@Guid,
		'' as [Caption],
		D.[Note] as [old],
		N.[Note] as [New],
		''
	From
		[deleted] d
		inner join [inserted] n on D.Guid = N.Guid
	where
		N.[Note] <> D.[Note]
		
		
	insert into [TraceDetail]
	([ParentGuid],[Caption],[Old],[New],[Tbl])
	Select Top 1
		@Guid,
		' ' as [Caption],
		D.[CheckCreateEntry] as [old],
		N.[CheckCreateEntry] as [New],
		''
	From
		[deleted] d
		inner join [inserted] n on D.Guid = N.Guid
	where
		N.[CheckCreateEntry] <> D.[CheckCreateEntry]
		
	insert into [TraceDetail]
	([ParentGuid],[Caption],[Old],[New],[Tbl])
	Select Top 1
		@Guid,
		' ' as [Caption],
		D.[ItemsTotal] as [old],
		N.[ItemsTotal] as [New],
		''
	From
		[deleted] d
		inner join [inserted] n on D.Guid = N.Guid
	where
		N.[ItemsTotal] <> D.[ItemsTotal]
		
	insert into [TraceDetail]
	([ParentGuid],[Caption],[Old],[New],[Tbl])
	Select Top 1
		@Guid,
		' ' as [Caption],
		D.[ItemsDiscount] as [old],
		N.[ItemsDiscount] as [New],
		''
	From
		[deleted] d
		inner join [inserted] n on D.Guid = N.Guid
	where
		N.[ItemsDiscount] <> D.[ItemsDiscount]
		
	insert into [TraceDetail]
	([ParentGuid],[Caption],[Old],[New],[Tbl])
	Select Top 1
		@Guid,
		' ' as [Caption],
		D.[ItemsExtra] as [old],
		N.[ItemsExtra] as [New],
		''
	From
		[deleted] d
		inner join [inserted] n on D.Guid = N.Guid
	where
		N.[ItemsExtra] <> D.[ItemsExtra]
		
	insert into [TraceDetail]
	([ParentGuid],[Caption],[Old],[New],[Tbl])
	Select Top 1
		@Guid,
		'' as [Caption],
		D.[BuExtra] as [old],
		N.[BuExtra] as [New],
		''
	From
		[deleted] d
		inner join [inserted] n on D.Guid = N.Guid
	where
		N.[BuExtra] <> D.[BuExtra]
		
	insert into [TraceDetail]
	([ParentGuid],[Caption],[Old],[New],[Tbl])
	Select Top 1
		@Guid,
		'' as [Caption],
		D.[BuDiscount] as [old],
		N.[BuDiscount] as [New],
		''
	From
		[deleted] d
		inner join [inserted] n on D.Guid = N.Guid
	where
		N.[BuDiscount] <> D.[BuDiscount]
		
	insert into [TraceDetail]
	([ParentGuid],[Caption],[Old],[New],[Tbl])
	Select Top 1
		@Guid,
		'' as [Caption],
		D.[BuOnly] as [old],
		N.[BuOnly] as [New],
		''
	From
		[deleted] d
		inner join [inserted] n on D.Guid = N.Guid
	where
		N.[BuOnly] <> D.[BuOnly]
		
	insert into [TraceDetail]
	([ParentGuid],[Caption],[Old],[New],[Tbl])
	Select Top 1
		@Guid,
		'' as [Caption],
		D.[IsPosted] as [old],
		N.[IsPosted] as [New],
		''
	From
		[deleted] d
		inner join [inserted] n on D.Guid = N.Guid
	where
		N.[IsPosted] <> D.[IsPosted]
		
	delete Trace From Trace t left join [TraceDetail] D on T.guid = D.ParentGuid
	where
		d.ParentGuid is Null and t.Guid = @Guid


GO

SET ANSI_NULLS, QUOTED_IDENTIFIER ON
GO

Create Procedure [PrcPrintCheck]
(
	@Guid uniqueidentifier = 0x0,
	@OnlyValue Varchar(256) = '',
	@OnlyValueAr Varchar(256) = '',
	@OnlyValueEn Varchar(256) = ''
)
 
as
	Select 
		[S].[Number],
		[S].[SecLvl],
		[S].[TypeName],
		[S].[NO],
		[S].[Value],
		[my].[Code] as [Currency],
		[S].[CurrencyVal],
		[S].[Date],
		dbo.FnFormatDate([S].[Date]) as [Date_Gr],
		[S].[DueDate],
		dbo.FnFormatDate([S].[DueDate]) as [DueDate_Gr],
		[S].[EndDueDate],
		dbo.FnFormatDate([S].[EndDueDate]) as [EndDueDate_Gr],
		[S].[BankName],
		[ac].[code] as [AccountCode],
		[Ac].[Name] as [AccountName],
		[Ac].[ArName] as [AccountArName],
		[Ac].[LtnName] as [AccountLtnName],
		[ac2].[code] as [ObverseAccountCode],
		[Ac2].[Name] as [ObverseAccountName],
		[Ac2].[ArName] as [ObverseAccountArName],
		[Ac2].[LtnName] as [ObverseAccountLtnName],
		[S].[Beneficiary],
		[S].[Note],
		[S].[Note2],
		[S].[Note3],
		[S].[Note4],
		[S].[InternalNO],
		[S].[FolderDate],
		dbo.FnFormatDate([S].[FolderDate]) as [FolderDate_Gr],
		[S].[FolderInternalNo],
		[S].[FolderExternalNo],
		[S].[ReceiptNo] ,

		Cast('' as varchar(255)) as [FlatNo],
		Cast('' as varchar(255)) as [BuildingName],
		Cast('' as varchar(255)) as [BuildingArName],
		Cast('' as varchar(255)) as [BuildingLtnName],
		Cast(Null as Datetime) as [FromDate],
		Cast('' as varchar(255)) as [FromDate_Gr],
		Cast(Null as Datetime) as [ToDate],
		Cast('' as varchar(255)) as [ToDate_Gr],
		Cast('' as varchar(255)) as [ContractNo],
		@OnlyValue as [OnlyValue],
		@OnlyValueAr as [OnlyValueAr],
		@OnlyValueEn as [OnlyValueEn],

		Cast(Null as Float) as [ContractValue],
		Cast(Null as Float) as [ContractValueAfterDiscount],
		Cast('' as varchar(255)) as [Emirate],
		Cast('' as varchar(255)) as [BuildingArea],
		Cast('' as varchar(255)) as [Suburb],
		Cast('' as varchar(255)) as [Street],
		Cast('' as varchar(255)) as [BasinNo],
		Cast('' as varchar(255)) as [PieceNo],
		Cast('' as varchar(255)) as [BuildingNo],
		Cast('' as varchar(255)) as [BondType],
		Cast('' as varchar(255)) as [BondNo],
		Cast('' as varchar(255)) as [FlatKind],
		Cast('' as varchar(255)) as [ApartmentType],
		Cast('' as varchar(255)) as [Class],
		Cast('' as varchar(255)) as [FlatArea],
		Cast('' as varchar(255)) as [FlatAreaunity],

		Cast('' as varchar(255)) as [BuildingBankName],
		Cast('' as varchar(255)) as [BuildingBankAccCode],

		[Sl].[Name] as [SalesMan],
		[S].[TypeCode],
		[S].[TypeCode]+CAST(S.Number as Varchar(256)) as [TypeCode_Number],
		[Cu].[BankName] as [CustBankName],
		[Cu].[BankAccCode] as [CustBankAccCode],
		[Cu].[Mobile] as [CustMobile],
		[Cu].[PhoneJob] as [CustPhoneJob],
		[Cu].[AccountBalance] as [CustAccountBalance],
		[Cu].[Barcode] as [CustBarcode],
		[Cu].[BoxNo] as [CustBoxNo],
		[Cu].[EMail] as [CustEMail],
		Cast(0 as varchar(255)) as [ContractDiscountValue],
		Cast(0 as int) as [EntryNumber],
		[S].[Guid] as [checkGuid],
		[S].[ContractGuid]
	into #Check
	From 
		[vwChecks] [S]
		inner join [vwAccount] [Ac] on [Ac].[Guid] = [S].[Account]
		left join [vwCurrency] [My] On [My].[Guid] = [S].[CurrencyGuid]
		inner join [vwaccount] [ac2] on [ac2].[Guid] = [S].[ObverseAccount]
		--left join [vwLeaseApartment] [C] on [C].[Guid] = [S].[ContractGuid]
		left join [vwSalesMan] [Sl] on [Sl].[Guid] = [S].[SalesManGuid]
		left join [vwCustomer] Cu on Cu.AcGuid = S.Account
	where
		[S].[Guid] = @Guid or @Guid = 0x0
		
	
	update 
		#Check
	Set
		[FlatNo] = C.[FlatNo],
		[BuildingName] = C.[BuildingName],
		[BuildingArName] = C.[BuildingArName],
		[BuildingLtnName] = C.[BuildingLtnName],
		[FromDate] = C.[FromDate],
		[FromDate_Gr] = dbo.FnFormatDate([C].[FromDate]),
		[ToDate] = [C].[ToDate],
		[ToDate_Gr] = dbo.FnFormatDate([C].[ToDate]),
		[ContractNo] = C.[ContractNo],

		[ContractValue] = C.[Rent],
		[ContractValueAfterDiscount] = [C].RentAfterDiscount,
		[Emirate] = [C].[Emirate],
		[BuildingArea] = [C].[BuildingArea],
		[Suburb] = [C].[Suburb],
		[Street] = [C].[Street],
		[BasinNo] = [C].[BasinNo],
		[PieceNo] = [C].[PieceNo],
		[BuildingNo] = [C].[BuildingNo],
		[BondType] = [C].[BondType],
		[BondNo] = [C].[BondNo],
		
		[FlatKind] = [C].[FlatKind],
		[ApartmentType] = [C].[ApartmentType],
		[Class] = [C].[Class],
		[FlatArea] = [C].[FlatArea],
		[FlatAreaunity] = [C].[FlatAreaunity],

		[BuildingBankName] = [C].[BuildingBankName],
		[BuildingBankAccCode] = [C].[BuildingBankAccCode],

		[ContractDiscountValue] = C.DiscountValue 
	From
		#Check S
		inner join [vwLeaseApartment] [C] on [C].[Guid] = [S].[ContractGuid]
		
	update 
		#Check
	Set
		[FlatNo] = C.parkingNo ,
		[BuildingName] = C.[BuildingName],
		[BuildingArName] = C.[BuildingArName],
		[BuildingLtnName] = C.[BuildingLtnName],
		[FromDate] = C.[FromDate],
		[FromDate_Gr] = dbo.FnFormatDate([C].[FromDate]),
		[ToDate] = [C].[ToDate],
		[ToDate_Gr] = dbo.FnFormatDate([C].[ToDate]),
		[ContractNo] = C.[ContractNo],

		[ContractValue] = C.[Rent],
		[ContractValueAfterDiscount] = [C].RentAfterDiscount,
		[Emirate] = [C].[Emirate],
		--[BuildingArea] = [C].[BuildingArea],
		--[Suburb] = [C].[Suburb],
		--[Street] = [C].[Street],
		--[BasinNo] = [C].[BasinNo],
		--[PieceNo] = [C].[PieceNo],
		--[BuildingNo] = [C].[BuildingNo],
		--[BondType] = [C].[BondType],
		--[BondNo] = [C].[BondNo],
		--[FlatKind] = [C].[FlatKind],
		--[ApartmentType] = [C].[ApartmentType],
		--[Class] = [C].[Class],
		--[FlatArea] = [C].[FlatArea],
		--[FlatAreaunity] = [C].[FlatAreaunity],

		--[BuildingBankName] = [C].[BuildingBankName],
		--[BuildingBankAccCode] = [C].[BuildingBankAccCode],

		[ContractDiscountValue] = C.DiscountValue 
	From
		#Check S
		inner join [vwParkingContract] [C] on [C].[Guid] = [S].[ContractGuid]

	
	-- 
	Update #Check Set [EntryNumber] = Ce.Number
	From
		#Check C
		inner join [LinkEntry_Checks] L on L.CheckGuid = C.[checkGuid]
		inner join [HEntry] Ce on L.EntryGuid = Ce.Guid
	where
		L.Kind = 1600

	Select * from #Check

GO

SET ANSI_NULLS, QUOTED_IDENTIFIER ON
GO

Create Trigger [TRG_Trace_BillType]
on [BillType]
 
for update
As
	SET NOCOUNT ON;
	if Not exists(Select Value from DMD_const where vName = 'ActiveLogCardUpdate' and Value = '1' ) return
	
	Declare @UserGuid uniqueidentifier, @Guid uniqueidentifier
	Set @Guid = NEWID()
	
	Select Top 1 @UserGuid = userGuid From CurrentUsers where Spid = @@SPID
			
	insert into [Trace]
	([Guid],[ParentGuid],[Date],[userGuid],[HostName],ParentTbl)
	Select Top 1
		@Guid,
		N.Guid,
		GETDATE(),
		@UserGuid,
		Host_Name(),
		'BillType'
	From
		[inserted] n 
		
	insert into [TraceDetail]
	([ParentGuid],[Caption],[Old],[New],[Tbl])
	Select Top 1
		@Guid,
		' ' as [Caption],
		D.[SecLvl] as [old],
		N.[SecLvl] as [New],
		''
	From
		[deleted] d
		inner join [inserted] n on D.Guid = N.Guid
	where
		N.[SecLvl] <> D.[SecLvl]
		
	insert into [TraceDetail]
	([ParentGuid],[Caption],[Old],[New],[Tbl])
	Select Top 1
		@Guid,
		'' as [Caption],
		D.[Code] as [old],
		N.[Code] as [New],
		''
	From
		[deleted] d
		inner join [inserted] n on D.Guid = N.Guid
	where
		N.[Code] <> D.[Code]
		
	insert into [TraceDetail]
	([ParentGuid],[Caption],[Old],[New],[Tbl])
	Select Top 1
		@Guid,
		'' as [Caption],
		D.[Name] as [old],
		N.[Name] as [New],
		''
	From
		[deleted] d
		inner join [inserted] n on D.Guid = N.Guid
	where
		N.[Name] <> D.[Name]
		
	insert into [TraceDetail]
	([ParentGuid],[Caption],[Old],[New],[Tbl])
	Select Top 1
		@Guid,
		' ' as [Caption],
		D.[LtnName] as [old],
		N.[LtnName] as [New],
		''
	From
		[deleted] d
		inner join [inserted] n on D.Guid = N.Guid
	where
		N.[LtnName] <> D.[LtnName]
		
	insert into [TraceDetail]
	([ParentGuid],[Caption],[Old],[New],[Tbl])
	Select Top 1
		@Guid,
		' ' as [Caption],
		D.[BillKind] as [old],
		N.[BillKind] as [New],
		''
	From
		[deleted] d
		inner join [inserted] n on D.Guid = N.Guid
	where
		N.[BillKind] <> D.[BillKind]
		
	insert into [TraceDetail]
	([ParentGuid],[Caption],[Old],[New],[Tbl])
	Select Top 1
		@Guid,
		' ' as [Caption],
		D.[Menu] as [old],
		N.[Menu] as [New],
		''
	From
		[deleted] d
		inner join [inserted] n on D.Guid = N.Guid
	where
		N.[Menu] <> D.[Menu]
		
	insert into [TraceDetail]
	([ParentGuid],[Caption],[Old],[New],[Tbl])
	Select Top 1
		@Guid,
		'  ' as [Caption],
		D.[LtnMenu] as [old],
		N.[LtnMenu] as [New],
		''
	From
		[deleted] d
		inner join [inserted] n on D.Guid = N.Guid
	where
		N.[LtnMenu] <> D.[LtnMenu]
		
	insert into [TraceDetail]
	([ParentGuid],[Caption],[Old],[New],[Tbl])
	Select Top 1
		@Guid,
		' ' as [Caption],
		D.[ShortCut] as [old],
		N.[ShortCut] as [New],
		''
	From
		[deleted] d
		inner join [inserted] n on D.Guid = N.Guid
	where
		N.[ShortCut] <> D.[ShortCut]
		
	insert into [TraceDetail]
	([ParentGuid],[Caption],[Old],[New],[Tbl])
	Select Top 1
		@Guid,
		'  ' as [Caption],
		D.[DefPrintPath] as [old],
		N.[DefPrintPath] as [New],
		''
	From
		[deleted] d
		inner join [inserted] n on D.Guid = N.Guid
	where
		N.[DefPrintPath] <> D.[DefPrintPath]
		
	insert into [TraceDetail]
	([ParentGuid],[Caption],[Old],[New],[Tbl])
	Select Top 1
		@Guid,
		'' as [Caption],
		D.[Note] as [old],
		N.[Note] as [New],
		''
	From
		[deleted] d
		inner join [inserted] n on D.Guid = N.Guid
	where
		N.[Note] <> D.[Note]
		
	insert into [TraceDetail]
	([ParentGuid],[Caption],[Old],[New],[Tbl])
	Select Top 1
		@Guid,
		' ' as [Caption],
		D.[Color1] as [old],
		N.[Color1] as [New],
		''
	From
		[deleted] d
		inner join [inserted] n on D.Guid = N.Guid
	where
		N.[Color1] <> D.[Color1]
		
	insert into [TraceDetail]
	([ParentGuid],[Caption],[Old],[New],[Tbl])
	Select Top 1
		@Guid,
		' ' as [Caption],
		D.[Color2] as [old],
		N.[Color2] as [New],
		''
	From
		[deleted] d
		inner join [inserted] n on D.Guid = N.Guid
	where
		N.[Color2] <> D.[Color2]
		
	insert into [TraceDetail]
	([ParentGuid],[Caption],[Old],[New],[Tbl])
	Select Top 1
		@Guid,
		' ' as [Caption],
		D.[DefMatAccountGuid] as [old],
		N.[DefMatAccountGuid] as [New],
		'[Account]'
	From
		[deleted] d
		inner join [inserted] n on D.Guid = N.Guid
	where
		N.[DefMatAccountGuid] <> D.[DefMatAccountGuid]
		
	insert into [TraceDetail]
	([ParentGuid],[Caption],[Old],[New],[Tbl])
	Select Top 1
		@Guid,
		' ' as [Caption],
		D.[DefCashAccountGuid] as [old],
		N.[DefCashAccountGuid] as [New],
		'[Account]'
	From
		[deleted] d
		inner join [inserted] n on D.Guid = N.Guid
	where
		N.[DefCashAccountGuid] <> D.[DefCashAccountGuid]
		
	insert into [TraceDetail]
	([ParentGuid],[Caption],[Old],[New],[Tbl])
	Select Top 1
		@Guid,
		' ' as [Caption],
		D.[DefCostGuid] as [old],
		N.[DefCostGuid] as [New],
		'[Cost]'
	From
		[deleted] d
		inner join [inserted] n on D.Guid = N.Guid
	where
		N.[DefCostGuid] <> D.[DefCostGuid]
		
	insert into [TraceDetail]
	([ParentGuid],[Caption],[Old],[New],[Tbl])
	Select Top 1
		@Guid,
		' ' as [Caption],
		D.[DefStoreGuid] as [old],
		N.[DefStoreGuid] as [New],
		''
	From
		[deleted] d
		inner join [inserted] n on D.Guid = N.Guid
	where
		N.[DefStoreGuid] <> D.[DefStoreGuid]
		
	insert into [TraceDetail]
	([ParentGuid],[Caption],[Old],[New],[Tbl])
	Select Top 1
		@Guid,
		' ' as [Caption],
		D.[DefDiscountAccountGuid] as [old],
		N.[DefDiscountAccountGuid] as [New],
		'[Account]'
	From
		[deleted] d
		inner join [inserted] n on D.Guid = N.Guid
	where
		N.[DefDiscountAccountGuid] <> D.[DefDiscountAccountGuid]
		
	insert into [TraceDetail]
	([ParentGuid],[Caption],[Old],[New],[Tbl])
	Select Top 1
		@Guid,
		' ' as [Caption],
		D.[DefExtraAccountGuid] as [old],
		N.[DefExtraAccountGuid] as [New],
		'[Account]'
	From
		[deleted] d
		inner join [inserted] n on D.Guid = N.Guid
	where
		N.[DefExtraAccountGuid] <> D.[DefExtraAccountGuid]
		
	insert into [TraceDetail]
	([ParentGuid],[Caption],[Old],[New],[Tbl])
	Select Top 1
		@Guid,
		'' as [Caption],
		D.[CurrencyGuid] as [old],
		N.[CurrencyGuid] as [New],
		''
	From
		[deleted] d
		inner join [inserted] n on D.Guid = N.Guid
	where
		N.[CurrencyGuid] <> D.[CurrencyGuid]
		
	insert into [TraceDetail]
	([ParentGuid],[Caption],[Old],[New],[Tbl])
	Select Top 1
		@Guid,
		'  ' as [Caption],
		D.[PostToStores] as [old],
		N.[PostToStores] as [New],
		''
	From
		[deleted] d
		inner join [inserted] n on D.Guid = N.Guid
	where
		N.[PostToStores] <> D.[PostToStores]
		
	insert into [TraceDetail]
	([ParentGuid],[Caption],[Old],[New],[Tbl])
	Select Top 1
		@Guid,
		'   ' as [Caption],
		D.[PostToStoresAuto] as [old],
		N.[PostToStoresAuto] as [New],
		''
	From
		[deleted] d
		inner join [inserted] n on D.Guid = N.Guid
	where
		N.[PostToStoresAuto] <> D.[PostToStoresAuto]
		
	insert into [TraceDetail]
	([ParentGuid],[Caption],[Old],[New],[Tbl])
	Select Top 1
		@Guid,
		' ' as [Caption],
		D.[EntryCreated] as [old],
		N.[EntryCreated] as [New],
		''
	From
		[deleted] d
		inner join [inserted] n on D.Guid = N.Guid
	where
		N.[EntryCreated] <> D.[EntryCreated]
		
	insert into [TraceDetail]
	([ParentGuid],[Caption],[Old],[New],[Tbl])
	Select Top 1
		@Guid,
		'  ' as [Caption],
		D.[EntryCreatedAuto] as [old],
		N.[EntryCreatedAuto] as [New],
		''
	From
		[deleted] d
		inner join [inserted] n on D.Guid = N.Guid
	where
		N.[EntryCreatedAuto] <> D.[EntryCreatedAuto]
		
	insert into [TraceDetail]
	([ParentGuid],[Caption],[Old],[New],[Tbl])
	Select Top 1
		@Guid,
		'   ' as [Caption],
		D.[AutoPostedEntry] as [old],
		N.[AutoPostedEntry] as [New],
		''
	From
		[deleted] d
		inner join [inserted] n on D.Guid = N.Guid
	where
		N.[AutoPostedEntry] <> D.[AutoPostedEntry]
		
		
	insert into [TraceDetail]
	([ParentGuid],[Caption],[Old],[New],[Tbl])
	Select Top 1
		@Guid,
		'' as [Caption],
		D.[SpecificPrice] as [old],
		N.[SpecificPrice] as [New],
		''
	From
		[deleted] d
		inner join [inserted] n on D.Guid = N.Guid
	where
		N.[SpecificPrice] <> D.[SpecificPrice]
		
	insert into [TraceDetail]
	([ParentGuid],[Caption],[Old],[New],[Tbl])
	Select Top 1
		@Guid,
		'   ' as [Caption],
		D.[PriceEffected] as [old],
		N.[PriceEffected] as [New],
		''
	From
		[deleted] d
		inner join [inserted] n on D.Guid = N.Guid
	where
		N.[PriceEffected] <> D.[PriceEffected]
		
	insert into [TraceDetail]
	([ParentGuid],[Caption],[Old],[New],[Tbl])
	Select Top 1
		@Guid,
		' ' as [Caption],
		D.[PayType] as [old],
		N.[PayType] as [New],
		''
	From
		[deleted] d
		inner join [inserted] n on D.Guid = N.Guid
	where
		N.[PayType] <> D.[PayType]
		
	delete Trace From Trace t left join [TraceDetail] D on T.guid = D.ParentGuid
	where
		d.ParentGuid is Null and t.Guid = @Guid


GO

SET ANSI_NULLS, QUOTED_IDENTIFIER ON
GO

Create Procedure [PrcPrintParkingContract]
(
	@Guid uniqueidentifier = 0x0
	,@OnlyValue Varchar(256) = ''
)
 
as
	Select 
		GetDate() as [NowDate],
		dbo.FnFormatDate(GetDate()) as [NowDate_Gr],
		[A].[Number],
		[A].[ContractNo],
		[C].[ArName] as [CustArName],
		[C].[LtnName] as [CustLtnName],
		[C].[Address] as [CustomerAddress],
		[C].[Nationality] as [CustomerNationality],
		[C].[PassportNO] as [CustomerPassportNO], 
		[C].[Profession] as [CustomerProfession],
		[C].[Domicile] as [CustomerDomicile],
		[C].[Security] as [CustomerSecurity],
		[C].[MemoSecurity] as [CustomerMemoSecurity],
		[C].[BoxNo] as [CustomerBoxNo],
		[C].[PersonalityNo1] as [CustomerPersonalityNo1],
		[C].[PersonalityNo2] as [CustomerPersonalityNo2],
		[C].[Adjective]as [CustomerAdjective],
		[C].[Fax]	as [CustomerFax],
		[C].[Email]	as [CustomerEmail],
		[C].[PhoneJob]	as [CustomerPhoneJob],
		[C].[Mobile]	as [CustomerMobile],

		[C].[PassportNO] as [CustomerPassportNO],
		[C].[PassportExpireDate] as [CustomerPassportExpireDate],	
		dbo.FnFormatDate([C].[PassportExpireDate]) as [CustomerPassportExpireDate_Gr],

		[B].[Name] as [BuildingarName],
		[B].[LtnName] as [BuildingLtnName],
		[P].[No],
		[B].[Emirate],
		[B].[Suburb],
		[B].[Area],
		[B].[Street],
		[B].[BuildingNo],
		[B].[BondType] as [BuildingBondType],
		[B].[BondNo] as [BuildingBondNo],
		[B].[BondDate] as [BuildingBondDate],
		dbo.FnFormatDate([B].[BondDate]) as [BuildingBondDate_Gr],
		
		[B].[LtnEmirate],
		[B].[LtnArea],
		[B].[LtnSuburb],
		[B].[LtnStreet],

		[B].[BankName] as [BuildingBankName],
		[B].[BankAccCode] as [BuildingBankAccCode],

        [A].[RentDuration],
        [A].[Rentype],
        [A].[TermsOfPayment],
		[A].[Rent] as [Value],
		@OnlyValue as [OnlyValue],
		[My].[Code] as [Currency],
		[FromDate],
		dbo.FnFormatDate([FromDate]) AS [FromDate_Gr],
		[ToDate] as [ToDate],
		dbo.FnFormatDate([ToDate]) as [ToDate_Gr],

		DATEDIFF(DAY, ToDate, FromDate) as ContractDays,
		Case when ContractFinish = 1 then 
		DATEDIFF(DAY, ToDate, ContractFinishDate) 
		end as ContractDaysDifference,

		[A].[Note],
		[A].[Note2],
		
		[A].[CardNo],
		[A].[CarNo],
		[A].[CarType],
		[A].[CarColor],
		[A].[Emirate] as [ParkingEmirate],

	    [R].[Name] as [Rent_Name],
	    [R].[LtnName] as [Rent_LtnName],
	    [R].[Adjective]  as [Rent_Adjective],
	    [R].[Nationality]  as [Rent_Nationality],
	    [R].[Work]  as [Rent_Work],
	    [R].[PersonalityNo]   as [Rent_PersonalityNo],
		[R].[WorkCardNo]   as [Rent_CardNo],
	    [R].[Address]  as [Rent_Address],
	    [R].[Phone]  as [Rent_Phone],
	    [R].[Mobile]  as [Rent_Mobile],
	    [R].[BoxNo]  as [Rent_BoxNo],
		[R].[Fax]  as [Rent_FaxNo],
	    [R].[EMail]  as [Rent_EMail],
		
		[R].[PassportNO] as [Rent_PassportNO],
		[R].[PassportExpireDate] as [Rent_PassportExpireDate],	
		dbo.FnFormatDate([R].[PassportExpireDate]) as [Rent_PassportExpireDate_Gr],

		[A].[License1No],
		[A].[License2No],
		[A].[License3No],
		[A].[License1Date1],
		dbo.FnFormatDate([A].[License1Date1]) as [License1Date1_Gr],
		[A].[License2Date1],
		dbo.FnFormatDate([A].[License2Date1]) as [License2Date1_Gr],
		[A].[License3Date1],
		dbo.FnFormatDate([A].[License3Date1]) as [License3Date1_Gr],
		[A].[License1Date2],
		dbo.FnFormatDate([A].[License1Date2]) as [License1Date2_Gr],
		[A].[License2Date2],
		dbo.FnFormatDate([A].[License2Date2]) as [License2Date2_Gr],
		[A].[License3Date2],
		dbo.FnFormatDate([A].[License3Date2]) as [License3Date2_Gr],

		[A].[LtnRentDuration],
		[A].[LtnRentype],
		[A].[LtnTermsOfPayment],

	    [OW].[Name] as [Owner_Name],
	    [OW].[LtnName] as [Owner_LtnName],
	    [OW].[Nationality]  as [Owner_Nationality],
	    [OW].[PersonalityNo]   as [Owner_PersonalityNo],
	    [OW].[Address]  as [Owner_Address],
	    [OW].[Phone]  as [Owner_Phone],
	    [OW].[Mobile]  as [Owner_Mobile],
	    [OW].[BoxNo]  as [Owner_BoxNo],
		[OW].[Fax]  as [Owner_FaxNo],
	    [OW].[EMail]  as [Owner_EMail],
		[Sl].[Name] as [SalesMan],
		[T].[Code] as [TypeCode],
		[T].[Code]+CAST(A.Number as Varchar(256)) as [TypeCode_Number],
		[C].[BankName] as [CustBankName],
		[C].[BankAccCode] as [CustBankAccCode],
		[Ac].[code] AS [AccountCode],
		[Ac].[Balance] AS [AccountBalance],

		(Select Sum(value) from ParkingContractFee Where ParentGuid = A.Guid) AS [SumFee],

		[A].[InsuranceValueOld],
		[A].[InsuranceValue],
		[A].[ContractPrice],
		[A].[CertificatValue],
		
		[A].[CommissionFromCustValue],
		[A].[CommissionFromCustPercent],

		[A].[CommissionFromOwnerValue] ,
		[A].[CommissionFromOwnerPercent],
		(Select 
			pp.NO as FlatNo
		 From 
			LeaseApartment ll
			inner join [Apartment] [pp] on [pp].[Guid] = [ll].[ApartmentGuid]
		 where 
			ll.Guid = A.FlatContractGuid
			) as FlatNo,
		[A].[Guid],

		(Select Top 1 [UserName] From vwRealty_LogCard where CardGuid = A.Guid order by Date) as [CreateByUser],
		(Select Top 1 [Date] From vwRealty_LogCard where CardGuid = A.Guid order by Date) as [CreateDate],
		(Select Top 1 [UserName] From vwRealty_LogCard where CardGuid = A.Guid order by Date desc) as [LastUpdateByUser],
		(Select Top 1 [Date] From vwRealty_LogCard where CardGuid = A.Guid order by Date desc) as [LastUpdateDate]
		
	from 
		[ParkingContract] [A]
		left join [vwBuilding] [B] On [A].[BuildingGuid] = [B].[Guid]
		left join [vwParking] [P] on [P].[Guid] = [A].[ParkingGuid]
		left join [vwCustomer] [C] on [C].[Guid] = [A].[CustomerGuid]
		left join [vwAccount] [AC] on [C].[AcGuid] = [AC].[Guid]
		left join [vwCurrency] [My] on [My].[Guid] = [A].[CurrencyGuid]
		left join [RentInfo] [R] on [R].[Guid] = [A].[RentInfoGuid]
		left join [vwOwner] [OW] on [OW].[Guid] = [B].[ownerGuid]
		left join [vwSalesMan] [Sl] on [Sl].[Guid] = [A].[SalesManGuid]
		inner join [ContractType] T on T.Guid = A.TypeGuid
	where
		[A].[Guid] = @Guid or @Guid = 0x0


GO

SET ANSI_NULLS, QUOTED_IDENTIFIER ON
GO

Create Trigger [TRG_Trace_Assets]
on [Assets]
 
for update
As
	SET NOCOUNT ON;
	if Not exists(Select Value from DMD_const where vName = 'ActiveLogCardUpdate' and Value = '1' ) return
	
	Declare @UserGuid uniqueidentifier, @Guid uniqueidentifier
	Set @Guid = NEWID()
	
	Select Top 1 @UserGuid = userGuid From CurrentUsers where Spid = @@SPID
			
	insert into [Trace]
	([Guid],[ParentGuid],[Date],[userGuid],[HostName],ParentTbl )
	Select Top 1
		@Guid,
		N.Guid,
		GETDATE(),
		@UserGuid,
		Host_Name(),
		'Assets'
	From
		[inserted] n 
		
	insert into [TraceDetail]
	([ParentGuid],[Caption],[Old],[New],[Tbl])
	Select Top 1
		@Guid,
		' ' as [Caption],
		D.[SecLvl] as [old],
		N.[SecLvl] as [New],
		''
	From
		[deleted] d
		inner join [inserted] n on D.Guid = N.Guid
	where
		N.[SecLvl] <> D.[SecLvl]
		
	insert into [TraceDetail]
	([ParentGuid],[Caption],[Old],[New],[Tbl])
	Select Top 1
		@Guid,
		'' as [Caption],
		D.[AssetsGroupGuid] as [old],
		N.[AssetsGroupGuid] as [New],
		'[AssetsGroup]'
	From
		[deleted] d
		inner join [inserted] n on D.Guid = N.Guid
	where
		N.[AssetsGroupGuid] <> D.[AssetsGroupGuid]
		
	insert into [TraceDetail]
	([ParentGuid],[Caption],[Old],[New],[Tbl])
	Select Top 1
		@Guid,
		'' as [Caption],
		D.[Code] as [old],
		N.[Code] as [New],
		''
	From
		[deleted] d
		inner join [inserted] n on D.Guid = N.Guid
	where
		N.[Code] <> D.[Code]
		
	insert into [TraceDetail]
	([ParentGuid],[Caption],[Old],[New],[Tbl])
	Select Top 1
		@Guid,
		'' as [Caption],
		D.[Name] as [old],
		N.[Name] as [New],
		''
	From
		[deleted] d
		inner join [inserted] n on D.Guid = N.Guid
	where
		N.[Name] <> D.[Name]
		
	insert into [TraceDetail]
	([ParentGuid],[Caption],[Old],[New],[Tbl])
	Select Top 1
		@Guid,
		' ' as [Caption],
		D.[LtnName] as [old],
		N.[LtnName] as [New],
		''
	From
		[deleted] d
		inner join [inserted] n on D.Guid = N.Guid
	where
		N.[LtnName] <> D.[LtnName]
		
	insert into [TraceDetail]
	([ParentGuid],[Caption],[Old],[New],[Tbl])
	Select Top 1
		@Guid,
		'' as [Caption],
		D.[Barcode] as [old],
		N.[Barcode] as [New],
		''
	From
		[deleted] d
		inner join [inserted] n on D.Guid = N.Guid
	where
		N.[Barcode] <> D.[Barcode]
		
	insert into [TraceDetail]
	([ParentGuid],[Caption],[Old],[New],[Tbl])
	Select Top 1
		@Guid,
		' ' as [Caption],
		D.[IsActive] as [old],
		N.[IsActive] as [New],
		''
	From
		[deleted] d
		inner join [inserted] n on D.Guid = N.Guid
	where
		N.[IsActive] <> D.[IsActive]
		
	insert into [TraceDetail]
	([ParentGuid],[Caption],[Old],[New],[Tbl])
	Select Top 1
		@Guid,
		'' as [Caption],
		D.[Note] as [old],
		N.[Note] as [New],
		''
	From
		[deleted] d
		inner join [inserted] n on D.Guid = N.Guid
	where
		N.[Note] <> D.[Note]
		
	insert into [TraceDetail]
	([ParentGuid],[Caption],[Old],[New],[Tbl])
	Select Top 1
		@Guid,
		'' as [Caption],
		D.[CurrencyGUID] as [old],
		N.[CurrencyGUID] as [New],
		'[Currency]'
	From
		[deleted] d
		inner join [inserted] n on D.Guid = N.Guid
	where
		N.[CurrencyGUID] <> D.[CurrencyGUID]
		
	insert into [TraceDetail]
	([ParentGuid],[Caption],[Old],[New],[Tbl])
	Select Top 1
		@Guid,
		' ' as [Caption],
		D.[CurrencyVal] as [old],
		N.[CurrencyVal] as [New],
		''
	From
		[deleted] d
		inner join [inserted] n on D.Guid = N.Guid
	where
		N.[CurrencyVal] <> D.[CurrencyVal]
		
	insert into [TraceDetail]
	([ParentGuid],[Caption],[Old],[New],[Tbl])
	Select Top 1
		@Guid,
		' ' as [Caption],
		D.[AssetsAreaGuid] as [old],
		N.[AssetsAreaGuid] as [New],
		'[AssetsArea]'
	From
		[deleted] d
		inner join [inserted] n on D.Guid = N.Guid
	where
		N.[AssetsAreaGuid] <> D.[AssetsAreaGuid]
		
	insert into [TraceDetail]
	([ParentGuid],[Caption],[Old],[New],[Tbl])
	Select Top 1
		@Guid,
		' ' as [Caption],
		D.[CurrentAssetsAreaGuid] as [old],
		N.[CurrentAssetsAreaGuid] as [New],
		'[AssetsArea]'
	From
		[deleted] d
		inner join [inserted] n on D.Guid = N.Guid
	where
		N.[CurrentAssetsAreaGuid] <> D.[CurrentAssetsAreaGuid]
		
	insert into [TraceDetail]
	([ParentGuid],[Caption],[Old],[New],[Tbl])
	Select Top 1
		@Guid,
		'' as [Caption],
		D.[State] as [old],
		N.[State] as [New],
		''
	From
		[deleted] d
		inner join [inserted] n on D.Guid = N.Guid
	where
		N.[State] <> D.[State]
		
	insert into [TraceDetail]
	([ParentGuid],[Caption],[Old],[New],[Tbl])
	Select Top 1
		@Guid,
		'' as [Caption],
		D.[Importer] as [old],
		N.[Importer] as [New],
		''
	From
		[deleted] d
		inner join [inserted] n on D.Guid = N.Guid
	where
		N.[Importer] <> D.[Importer]
		
	insert into [TraceDetail]
	([ParentGuid],[Caption],[Old],[New],[Tbl])
	Select Top 1
		@Guid,
		' ' as [Caption],
		D.[EnterAccountGuid] as [old],
		N.[EnterAccountGuid] as [New],
		'[Account]'
	From
		[deleted] d
		inner join [inserted] n on D.Guid = N.Guid
	where
		N.[EnterAccountGuid] <> D.[EnterAccountGuid]
		
	insert into [TraceDetail]
	([ParentGuid],[Caption],[Old],[New],[Tbl])
	Select Top 1
		@Guid,
		'  ' as [Caption],
		D.[EnterCostGuid] as [old],
		N.[EnterCostGuid] as [New],
		'[Cost]'
	From
		[deleted] d
		inner join [inserted] n on D.Guid = N.Guid
	where
		N.[EnterCostGuid] <> D.[EnterCostGuid]
		
	insert into [TraceDetail]
	([ParentGuid],[Caption],[Old],[New],[Tbl])
	Select Top 1
		@Guid,
		'  ' as [Caption],
		D.[EnterCreditCostGuid] as [old],
		N.[EnterCreditCostGuid] as [New],
		'[Cost]'
	From
		[deleted] d
		inner join [inserted] n on D.Guid = N.Guid
	where
		N.[EnterCreditCostGuid] <> D.[EnterCreditCostGuid]
		
	insert into [TraceDetail]
	([ParentGuid],[Caption],[Old],[New],[Tbl])
	Select Top 1
		@Guid,
		' ' as [Caption],
		D.[EnterValue] as [old],
		N.[EnterValue] as [New],
		''
	From
		[deleted] d
		inner join [inserted] n on D.Guid = N.Guid
	where
		N.[EnterValue] <> D.[EnterValue]
		
	insert into [TraceDetail]
	([ParentGuid],[Caption],[Old],[New],[Tbl])
	Select Top 1
		@Guid,
		' ' as [Caption],
		dbo.fnDate(D.[EnterDate]) as [old],
		dbo.fnDate(N.[EnterDate]) as [New],
		''
	From
		[deleted] d
		inner join [inserted] n on D.Guid = N.Guid
	where
		N.[EnterDate] <> D.[EnterDate]
		
	insert into [TraceDetail]
	([ParentGuid],[Caption],[Old],[New],[Tbl])
	Select Top 1
		@Guid,
		'' as [Caption],
		D.[Origin] as [old],
		N.[Origin] as [New],
		''
	From
		[deleted] d
		inner join [inserted] n on D.Guid = N.Guid
	where
		N.[Origin] <> D.[Origin]
		
	insert into [TraceDetail]
	([ParentGuid],[Caption],[Old],[New],[Tbl])
	Select Top 1
		@Guid,
		'' as [Caption],
		D.[Company] as [old],
		N.[Company] as [New],
		''
	From
		[deleted] d
		inner join [inserted] n on D.Guid = N.Guid
	where
		N.[Company] <> D.[Company]
		
	insert into [TraceDetail]
	([ParentGuid],[Caption],[Old],[New],[Tbl])
	Select Top 1
		@Guid,
		'' as [Caption],
		D.[EnterNote] as [old],
		N.[EnterNote] as [New],
		''
	From
		[deleted] d
		inner join [inserted] n on D.Guid = N.Guid
	where
		N.[EnterNote] <> D.[EnterNote]
		
	insert into [TraceDetail]
	([ParentGuid],[Caption],[Old],[New],[Tbl])
	Select Top 1
		@Guid,
		' ' as [Caption],
		D.[CreateEntry] as [old],
		N.[CreateEntry] as [New],
		''
	From
		[deleted] d
		inner join [inserted] n on D.Guid = N.Guid
	where
		N.[CreateEntry] <> D.[CreateEntry]
		
	insert into [TraceDetail]
	([ParentGuid],[Caption],[Old],[New],[Tbl])
	Select Top 1
		@Guid,
		' ' as [Caption],
		D.[AsstesAccountGuid] as [old],
		N.[AsstesAccountGuid] as [New],
		'[Account]'
	From
		[deleted] d
		inner join [inserted] n on D.Guid = N.Guid
	where
		N.[AsstesAccountGuid] <> D.[AsstesAccountGuid]
		
	insert into [TraceDetail]
	([ParentGuid],[Caption],[Old],[New],[Tbl])
	Select Top 1
		@Guid,
		' ' as [Caption],
		D.[ExpenseAccountGuid] as [old],
		N.[ExpenseAccountGuid] as [New],
		'[Account]'
	From
		[deleted] d
		inner join [inserted] n on D.Guid = N.Guid
	where
		N.[ExpenseAccountGuid] <> D.[ExpenseAccountGuid]
		
	insert into [TraceDetail]
	([ParentGuid],[Caption],[Old],[New],[Tbl])
	Select Top 1
		@Guid,
		' ' as [Caption],
		D.[DepreciationAccountGuid] as [old],
		N.[DepreciationAccountGuid] as [New],
		'[Account]'
	From
		[deleted] d
		inner join [inserted] n on D.Guid = N.Guid
	where
		N.[DepreciationAccountGuid] <> D.[DepreciationAccountGuid]
		
	insert into [TraceDetail]
	([ParentGuid],[Caption],[Old],[New],[Tbl])
	Select Top 1
		@Guid,
		'  ' as [Caption],
		D.[DepreciationTotalAccountGuid] as [old],
		N.[DepreciationTotalAccountGuid] as [New],
		'[Account]'
	From
		[deleted] d
		inner join [inserted] n on D.Guid = N.Guid
	where
		N.[DepreciationTotalAccountGuid] <> D.[DepreciationTotalAccountGuid]
		
	insert into [TraceDetail]
	([ParentGuid],[Caption],[Old],[New],[Tbl])
	Select Top 1
		@Guid,
		'  ' as [Caption],
		D.[ProfitAccountGuid] as [old],
		N.[ProfitAccountGuid] as [New],
		'[Account]'
	From
		[deleted] d
		inner join [inserted] n on D.Guid = N.Guid
	where
		N.[ProfitAccountGuid] <> D.[ProfitAccountGuid]
		
	insert into [TraceDetail]
	([ParentGuid],[Caption],[Old],[New],[Tbl])
	Select Top 1
		@Guid,
		'  ' as [Caption],
		D.[lossesAccountGuid] as [old],
		N.[lossesAccountGuid] as [New],
		'[Account]'
	From
		[deleted] d
		inner join [inserted] n on D.Guid = N.Guid
	where
		N.[lossesAccountGuid] <> D.[lossesAccountGuid]
		
	insert into [TraceDetail]
	([ParentGuid],[Caption],[Old],[New],[Tbl])
	Select Top 1
		@Guid,
		'  ' as [Caption],
		D.[EvaluationAccountGuid] as [old],
		N.[EvaluationAccountGuid] as [New],
		'[Account]'
	From
		[deleted] d
		inner join [inserted] n on D.Guid = N.Guid
	where
		N.[EvaluationAccountGuid] <> D.[EvaluationAccountGuid]
		
	insert into [TraceDetail]
	([ParentGuid],[Caption],[Old],[New],[Tbl])
	Select Top 1
		@Guid,
		' ' as [Caption],
		D.[Shipping] as [old],
		N.[Shipping] as [New],
		''
	From
		[deleted] d
		inner join [inserted] n on D.Guid = N.Guid
	where
		N.[Shipping] <> D.[Shipping]
		
	insert into [TraceDetail]
	([ParentGuid],[Caption],[Old],[New],[Tbl])
	Select Top 1
		@Guid,
		' ' as [Caption],
		D.[ShippingNo] as [old],
		N.[ShippingNo] as [New],
		''
	From
		[deleted] d
		inner join [inserted] n on D.Guid = N.Guid
	where
		N.[ShippingNo] <> D.[ShippingNo]
		
	insert into [TraceDetail]
	([ParentGuid],[Caption],[Old],[New],[Tbl])
	Select Top 1
		@Guid,
		' ' as [Caption],
		dbo.fnDate(D.[ShippingDate]) as [old],
		dbo.fnDate(N.[ShippingDate]) as [New],
		''
	From
		[deleted] d
		inner join [inserted] n on D.Guid = N.Guid
	where
		N.[ShippingDate] <> D.[ShippingDate]
		
	insert into [TraceDetail]
	([ParentGuid],[Caption],[Old],[New],[Tbl])
	Select Top 1
		@Guid,
		' ' as [Caption],
		dbo.fnDate(D.[ArriveDate]) as [old],
		dbo.fnDate(N.[ArriveDate]) as [New],
		''
	From
		[deleted] d
		inner join [inserted] n on D.Guid = N.Guid
	where
		N.[ArriveDate] <> D.[ArriveDate]
		
	insert into [TraceDetail]
	([ParentGuid],[Caption],[Old],[New],[Tbl])
	Select Top 1
		@Guid,
		' ' as [Caption],
		D.[ArrivePlace] as [old],
		N.[ArrivePlace] as [New],
		''
	From
		[deleted] d
		inner join [inserted] n on D.Guid = N.Guid
	where
		N.[ArrivePlace] <> D.[ArrivePlace]
		
	insert into [TraceDetail]
	([ParentGuid],[Caption],[Old],[New],[Tbl])
	Select Top 1
		@Guid,
		' ' as [Caption],
		D.[ImportPermit] as [old],
		N.[ImportPermit] as [New],
		''
	From
		[deleted] d
		inner join [inserted] n on D.Guid = N.Guid
	where
		N.[ImportPermit] <> D.[ImportPermit]
		
	insert into [TraceDetail]
	([ParentGuid],[Caption],[Old],[New],[Tbl])
	Select Top 1
		@Guid,
		' ' as [Caption],
		D.[CustomsNote] as [old],
		N.[CustomsNote] as [New],
		''
	From
		[deleted] d
		inner join [inserted] n on D.Guid = N.Guid
	where
		N.[CustomsNote] <> D.[CustomsNote]
		
	insert into [TraceDetail]
	([ParentGuid],[Caption],[Old],[New],[Tbl])
	Select Top 1
		@Guid,
		'  ' as [Caption],
		dbo.fnDate(D.[CustomsDate]) as [old],
		dbo.fnDate(N.[CustomsDate]) as [New],
		''
	From
		[deleted] d
		inner join [inserted] n on D.Guid = N.Guid
	where
		N.[CustomsDate] <> D.[CustomsDate]
		
	insert into [TraceDetail]
	([ParentGuid],[Caption],[Old],[New],[Tbl])
	Select Top 1
		@Guid,
		' ' as [Caption],
		D.[CustomsExpense] as [old],
		N.[CustomsExpense] as [New],
		''
	From
		[deleted] d
		inner join [inserted] n on D.Guid = N.Guid
	where
		N.[CustomsExpense] <> D.[CustomsExpense]
		
	insert into [TraceDetail]
	([ParentGuid],[Caption],[Old],[New],[Tbl])
	Select Top 1
		@Guid,
		'' as [Caption],
		D.[ShippingNote] as [old],
		N.[ShippingNote] as [New],
		''
	From
		[deleted] d
		inner join [inserted] n on D.Guid = N.Guid
	where
		N.[ShippingNote] <> D.[ShippingNote]
		
	insert into [TraceDetail]
	([ParentGuid],[Caption],[Old],[New],[Tbl])
	Select Top 1
		@Guid,
		' ' as [Caption],
		D.[MaintenanceContract] as [old],
		N.[MaintenanceContract] as [New],
		''
	From
		[deleted] d
		inner join [inserted] n on D.Guid = N.Guid
	where
		N.[MaintenanceContract] <> D.[MaintenanceContract]
		
	insert into [TraceDetail]
	([ParentGuid],[Caption],[Old],[New],[Tbl])
	Select Top 1
		@Guid,
		'  ' as [Caption],
		dbo.fnDate(D.[MaintenanceBeginDate]) as [old],
		dbo.fnDate(N.[MaintenanceBeginDate]) as [New],
		''
	From
		[deleted] d
		inner join [inserted] n on D.Guid = N.Guid
	where
		N.[MaintenanceBeginDate] <> D.[MaintenanceBeginDate]
		
	insert into [TraceDetail]
	([ParentGuid],[Caption],[Old],[New],[Tbl])
	Select Top 1
		@Guid,
		'   ' as [Caption],
		dbo.fnDate(D.[MaintenanceEndDate]) as [old],
		dbo.fnDate(N.[MaintenanceEndDate]) as [New],
		''
	From
		[deleted] d
		inner join [inserted] n on D.Guid = N.Guid
	where
		N.[MaintenanceEndDate] <> D.[MaintenanceEndDate]
		
	insert into [TraceDetail]
	([ParentGuid],[Caption],[Old],[New],[Tbl])
	Select Top 1
		@Guid,
		'' as [Caption],
		D.[Guaranty] as [old],
		N.[Guaranty] as [New],
		''
	From
		[deleted] d
		inner join [inserted] n on D.Guid = N.Guid
	where
		N.[Guaranty] <> D.[Guaranty]
		
	insert into [TraceDetail]
	([ParentGuid],[Caption],[Old],[New],[Tbl])
	Select Top 1
		@Guid,
		'  ' as [Caption],
		dbo.fnDate(D.[GuarantyBeginDate]) as [old],
		dbo.fnDate(N.[GuarantyBeginDate]) as [New],
		''
	From
		[deleted] d
		inner join [inserted] n on D.Guid = N.Guid
	where
		N.[GuarantyBeginDate] <> D.[GuarantyBeginDate]
		
	insert into [TraceDetail]
	([ParentGuid],[Caption],[Old],[New],[Tbl])
	Select Top 1
		@Guid,
		'  ' as [Caption],
		dbo.fnDate(D.[GuarantyEndDate]) as [old],
		dbo.fnDate(N.[GuarantyEndDate]) as [New],
		''
	From
		[deleted] d
		inner join [inserted] n on D.Guid = N.Guid
	where
		N.[GuarantyEndDate] <> D.[GuarantyEndDate]
		
	insert into [TraceDetail]
	([ParentGuid],[Caption],[Old],[New],[Tbl])
	Select Top 1
		@Guid,
		' ' as [Caption],
		D.[DepreciationMode] as [old],
		N.[DepreciationMode] as [New],
		''
	From
		[deleted] d
		inner join [inserted] n on D.Guid = N.Guid
	where
		N.[DepreciationMode] <> D.[DepreciationMode]
		
	insert into [TraceDetail]
	([ParentGuid],[Caption],[Old],[New],[Tbl])
	Select Top 1
		@Guid,
		'  ' as [Caption],
		dbo.fnDate(D.[DepreciationBeginDate]) as [old],
		dbo.fnDate(N.[DepreciationBeginDate]) as [New],
		''
	From
		[deleted] d
		inner join [inserted] n on D.Guid = N.Guid
	where
		N.[DepreciationBeginDate] <> D.[DepreciationBeginDate]
		
	insert into [TraceDetail]
	([ParentGuid],[Caption],[Old],[New],[Tbl])
	Select Top 1
		@Guid,
		' ' as [Caption],
		D.[Age] as [old],
		N.[Age] as [New],
		''
	From
		[deleted] d
		inner join [inserted] n on D.Guid = N.Guid
	where
		N.[Age] <> D.[Age]
		
	insert into [TraceDetail]
	([ParentGuid],[Caption],[Old],[New],[Tbl])
	Select Top 1
		@Guid,
		' ' as [Caption],
		D.[DepreciationAvg] as [old],
		N.[DepreciationAvg] as [New],
		''
	From
		[deleted] d
		inner join [inserted] n on D.Guid = N.Guid
	where
		N.[DepreciationAvg] <> D.[DepreciationAvg]
		
	insert into [TraceDetail]
	([ParentGuid],[Caption],[Old],[New],[Tbl])
	Select Top 1
		@Guid,
		'  ' as [Caption],
		D.[ScrapValue] as [old],
		N.[ScrapValue] as [New],
		''
	From
		[deleted] d
		inner join [inserted] n on D.Guid = N.Guid
	where
		N.[ScrapValue] <> D.[ScrapValue]
		
	insert into [TraceDetail]
	([ParentGuid],[Caption],[Old],[New],[Tbl])
	Select Top 1
		@Guid,
		'  ' as [Caption],
		D.[OldYearExtra] as [old],
		N.[OldYearExtra] as [New],
		''
	From
		[deleted] d
		inner join [inserted] n on D.Guid = N.Guid
	where
		N.[OldYearExtra] <> D.[OldYearExtra]
		
	insert into [TraceDetail]
	([ParentGuid],[Caption],[Old],[New],[Tbl])
	Select Top 1
		@Guid,
		'  ' as [Caption],
		D.[OldYearDecrease] as [old],
		N.[OldYearDecrease] as [New],
		''
	From
		[deleted] d
		inner join [inserted] n on D.Guid = N.Guid
	where
		N.[OldYearDecrease] <> D.[OldYearDecrease]
		
	insert into [TraceDetail]
	([ParentGuid],[Caption],[Old],[New],[Tbl])
	Select Top 1
		@Guid,
		'  ' as [Caption],
		D.[OldYearDepreciation] as [old],
		N.[OldYearDepreciation] as [New],
		''
	From
		[deleted] d
		inner join [inserted] n on D.Guid = N.Guid
	where
		N.[OldYearDepreciation] <> D.[OldYearDepreciation]
		
	insert into [TraceDetail]
	([ParentGuid],[Caption],[Old],[New],[Tbl])
	Select Top 1
		@Guid,
		'  ' as [Caption],
		D.[OldYearMaintenance] as [old],
		N.[OldYearMaintenance] as [New],
		''
	From
		[deleted] d
		inner join [inserted] n on D.Guid = N.Guid
	where
		N.[OldYearMaintenance] <> D.[OldYearMaintenance]
		
	insert into [TraceDetail]
	([ParentGuid],[Caption],[Old],[New],[Tbl])
	Select Top 1
		@Guid,
		' ' as [Caption],
		D.[IsSale] as [old],
		N.[IsSale] as [New],
		''
	From
		[deleted] d
		inner join [inserted] n on D.Guid = N.Guid
	where
		N.[IsSale] <> D.[IsSale]
		
	insert into [TraceDetail]
	([ParentGuid],[Caption],[Old],[New],[Tbl])
	Select Top 1
		@Guid,
		' ' as [Caption],
		dbo.fnDate(D.[SaleDate]) as [old],
		dbo.fnDate(N.[SaleDate]) as [New],
		''
	From
		[deleted] d
		inner join [inserted] n on D.Guid = N.Guid
	where
		N.[SaleDate] <> D.[SaleDate]
		
	insert into [TraceDetail]
	([ParentGuid],[Caption],[Old],[New],[Tbl])
	Select Top 1
		@Guid,
		'' as [Caption],
		D.[SaleCustomer] as [old],
		N.[SaleCustomer] as [New],
		''
	From
		[deleted] d
		inner join [inserted] n on D.Guid = N.Guid
	where
		N.[SaleCustomer] <> D.[SaleCustomer]
		
	insert into [TraceDetail]
	([ParentGuid],[Caption],[Old],[New],[Tbl])
	Select Top 1
		@Guid,
		' ' as [Caption],
		D.[SalesAccountGuid] as [old],
		N.[SalesAccountGuid] as [New],
		'[Account]'
	From
		[deleted] d
		inner join [inserted] n on D.Guid = N.Guid
	where
		N.[SalesAccountGuid] <> D.[SalesAccountGuid]
		
	insert into [TraceDetail]
	([ParentGuid],[Caption],[Old],[New],[Tbl])
	Select Top 1
		@Guid,
		' ' as [Caption],
		D.[SaleValue] as [old],
		N.[SaleValue] as [New],
		''
	From
		[deleted] d
		inner join [inserted] n on D.Guid = N.Guid
	where
		N.[SaleValue] <> D.[SaleValue]
		
	insert into [TraceDetail]
	([ParentGuid],[Caption],[Old],[New],[Tbl])
	Select Top 1
		@Guid,
		' ' as [Caption],
		D.[CurrencySaleGUID] as [old],
		N.[CurrencySaleGUID] as [New],
		'[Currency]'
	From
		[deleted] d
		inner join [inserted] n on D.Guid = N.Guid
	where
		N.[CurrencySaleGUID] <> D.[CurrencySaleGUID]
		
	insert into [TraceDetail]
	([ParentGuid],[Caption],[Old],[New],[Tbl])
	Select Top 1
		@Guid,
		'' as [Caption],
		D.[CurrencySaleVal] as [old],
		N.[CurrencySaleVal] as [New],
		''
	From
		[deleted] d
		inner join [inserted] n on D.Guid = N.Guid
	where
		N.[CurrencySaleVal] <> D.[CurrencySaleVal]
		
	insert into [TraceDetail]
	([ParentGuid],[Caption],[Old],[New],[Tbl])
	Select Top 1
		@Guid,
		' ' as [Caption],
		D.[SaleNote] as [old],
		N.[SaleNote] as [New],
		''
	From
		[deleted] d
		inner join [inserted] n on D.Guid = N.Guid
	where
		N.[SaleNote] <> D.[SaleNote]
		
	delete Trace From Trace t left join [TraceDetail] D on T.guid = D.ParentGuid
	where
		d.ParentGuid is Null and t.Guid = @Guid


GO

SET ANSI_NULLS, QUOTED_IDENTIFIER ON
GO

Create Procedure [RepFlatRent]
(
	@CustGuid uniqueidentifier = 0x0
	,@Nationality Varchar(256) = ''
	,@FlatNo  Varchar(256) = ''
	,@Emirate Varchar(256) = ''
	,@Suburb Varchar(256) = ''
	,@Area Varchar(256) = ''
	,@Street Varchar(256) = ''
	,@FlatKind Varchar(256) = ''
	,@Class Varchar(256) = ''
	,@ApartmentType Varchar(256) = ''
	,@FlatArea1 Float = 0
	,@FlatArea2 Float = 0
	,@Unity Varchar(256) = ''
	,@RentState int = 2
	,@ContractState int = 2
	,@Datewith int = 0
	,@Date1 DateTime = '2009-7-1'
	,@Date2 DateTime = '2022-1-2'
	,@RentInfoGuid uniqueidentifier = 0x0
	,@SalesManGuid uniqueidentifier = 0x0
	,@ShowFlat Bit = 1
	,@ShowShop Bit = 1
	,@ShowSaleRealty bit = 1
	,@ShowIsCheck Bit = 1
	,@ShowIsNotCheck Bit = 1
	,@ShowAccumulate Bit = 1
	,@ShowAccumulateEndContract Bit = 1
	,@ShowAssemplyRealtyRent Bit = 1
	,@Rent1 Float = 0
	,@Rent2 Float = 0
	,@CheckDate Bit = 0

	,@ActiveNote Bit = 0
	,@OperationNote int = 0
	,@RealtyNote  Varchar(256) = '' 
	,@ContractActiveNote Bit = 0
	,@ContractOpNote int = 0
	,@ContractNote  Varchar(256) = '' 
	,@Judicial int = 2
	,@JudicialContract int = 2
	,@ExportCSV Bit = 0
	,@BanRealty int = 2
	,@whereabouts varchar(255) = ''
	,@IncomeActiveDate bit = 0
	,@IncomeDate1 datetime = '1/1/2016'
	,@IncomeDate2 datetime = '1/1/2017'
)
 
as
	Set NoCount On 
	--  
	if @OperationNote <> 2 --
	Set @RealtyNote = '%'+@RealtyNote+'%'
	
	--  
	if @ContractOpNote <> 2 --
	Set @ContractNote = '%'+@ContractNote+'%'

	--    
	Select
		[ApartmentGuid],
		Max([FromDate]) as [FromDate]
	Into #LastContract	
	From
		[LeaseApartment]
	Group By
		[ApartmentGuid]

	Select
		*
	into #Building
	From
		vwBuilding B
	where
  		([B].[Emirate] = @Emirate or @Emirate = '')
  		and ([B].[Suburb] = @Suburb or @Suburb = '')
  		and ([B].[Area] = @Area or @Area = '')
  		and ([B].[Street] = @Street or @Street = '')
  		
  	Select
  		*
  	into #Customer
  	From
  		vwCustomer Cu
  	where
 		([Cu].[Guid] = @CustGuid or @CustGuid = 0x0)
		and (Cu.Nationality = @Nationality or @Nationality = '')

	Select 
		Case 
			when [ContractFinish] = 0 and [ToDate] >= GetDate() then [ToDate]
			when [ContractFinish] = 0 and [ToDate] < GetDate() then GetDate()
			when [ContractFinish] = 1  then [ContractFinishDate]
		end as [EndContractDate],
		[InsuranceValueOld] + [InsuranceValue] as [TotalInsurance],
		[C].*
		,[Cu].[Name] as [CustName]
		,[Cu].[Mobile] as [CustMobile]
		,[Cu].[Nationality] as [CustNationality]
		,[Cu].[EMail] as [CustEMail]
		,Cu.AcGuid as Cu_AcountGuid
	Into #LeaseApartment
	From
		[LeaseApartment] [C]
		inner join #LastContract [L] on [L].[ApartmentGuid] = [C].[ApartmentGuid] 
										and [L].[FromDate] = [C].[FromDate]
		inner join [#Customer] [Cu] on [Cu].[Guid] = [C].[CustomerGuid] 

	--	where [ContractFinish] = 0     
		
	--Select * from #LeaseApartment
	--return
	
	Select
		Max(Number) as [Number],
		[LeaseKind],
		[ApartmentGuid]
	into #LeaseApartment_Max_Number
	From
		[LeaseApartment]
	Group By 
		[ApartmentGuid]	, [LeaseKind]

	Declare @Tbl Table
	(
		[FlatNo] Varchar(256)
		,[BuildingName] Varchar(256)
		,[FlatKind] Varchar(256)
		,[FlatType] Varchar(256)
		,[Class] Varchar(256)
		,[FlatArea] Float
		,[State]  Varchar(256)
		,[RentState] int
		,[ContractState] Varchar(256)
		,[Emirate] Varchar(256)
		,[Suburb] Varchar(256)
		,[Area] Varchar(256)
		,[Street] Varchar(256)
		,[FloorNo] Varchar(256)
		,[WaterCounter]  Varchar(256)
		,[ElectricityCounter]  Varchar(256)
		
		,[BathroomCount] Int
		,[BalconyCount] int

		,RentPrice Float
		,SalePrice1 Float
		,SalePrice2 Float
		,SalePrice3 Float
		
		,[CustName] Varchar(256)
		,[CustMobile] Varchar(256)
		,[CustNationality] Varchar(256)
		,[CustEMail] varchar(255)
		,[ContractDateBegin] Datetime
		,[ContractDateEnd] Datetime
		,[ContractFinish] Bit
		,[ContractFinishDate] Datetime
		,[ContractGuid] uniqueidentifier
		,[Rent] Float
		,[PayType] int
		,[RentAfterDiscount] Float
		,[TotalInsurance] Float
		,[FlatGuid] uniqueidentifier
		,[FlatNote] Varchar(1000)
		,[ContractNote] Varchar(1000)
		,[RentalName] Varchar(256)
		,[Judicial] Varchar(256)
		,[JudicialContract] Varchar(256)
		,AcGuid  uniqueidentifier
	)
	
	
	if @ShowFlat = 1
	Insert into @Tbl 
	Select 
		[A].[No] as [FlatNo]
		,[B].[Name] as [BuildingName]
		,[A].[FlatKind] as [FlatKind]
		,[A].[ApartmentType] as [FlatType]
		,[A].[Class] as [Class]
		,[A].[Area] as [FlatArea]

		,Case when [L].[ContractFinish] = 0 then  dbo.sc('') 
			  else dbo.SC(' ') 
		end as [State],
		Case when [L].[ContractFinish] = 0 then 0 else 1 end as [RentState]
		
		,Case when [L].[ContractFinish] = 0 then
			 Case when (([L].[ToDate] <= GetDate()) or ([L].[ContractFinish] = 1)) 
				--or (@Date2 > [L].[ToDate]) 
				then dbo.sc(' ')  
				  when ([L].[ToDate] > GetDate()) and ([L].[ContractFinish] = 0) then dbo.sc('  ')  end 
		 end as [ContractState]

		,[B].[Emirate] as [Emirate]
		,[B].[Suburb] as [Suburb]
		,[B].[Area] as [Area]
		,[B].[Street] as [Street]
		,[A].[FloorNo]
		
		,[A].[WaterCounter]
		,[A].[ElectricityCounter]
		
		,A.[BathroomCount]
		,A.[BalconyCount]

		
		,A.Rent as RentPrice
		,0 as SalePrice1
		,0 as SalePrice2
		,0 as SalePrice3
		
		,[L].[CustName]
		,[L].[Custmobile]
		,[L].[CustNationality] as [Nationality]
		,[L].[CustEMail] as [CustEMail]
		,Case when [L].[ContractFinish] = 0 then [L].[FromDate] end as [ContractDateBegin]
		,Case when [L].[ContractFinish] = 0 then [L].[ToDate] end as [ContractDateEnd]
		,[L].[ContractFinish]
		,Case when [L].[ContractFinish] = 1 then [L].[ContractFinishDate] End as [ContractFinishDate]
		,[L].[Guid] as [ContractGuid]
		,Case when [L].[ContractFinish] = 0 then [L].[Rent] end 
		,L.[PayType]
		,Case when IsNull([L].[ContractFinish],0) = 0 then IsNull([L].[Rent],0) - IsNull([L].[DiscountValue],0) end as [rentafterdiscount]--,/*Case when [L].[ContractFinish] = 0 then */ [L].[Rent] - [L].[DiscountValue] /*end*/ as [rentafterdiscount]
		,L.[TotalInsurance]
		,[A].[Guid]
		,Left([A].[Note],256)
		,Left([L].[Note2],256)
		,[Rn].Name as RentalName
		,Case when IsNull(A.[Judicial],0) = 0 then dbo.SC('') else dbo.SC('') end
		,Case when IsNull(L.[Judicial],0) = 0 then dbo.SC('') else dbo.SC('') end
		,L.Cu_AcountGuid as CustAccountGuid
	from 
		[#Building] [B]
		inner join [Apartment] [A] On [A].[BuildingGuid] = [B].[Guid]
		Inner join [Resource] [R] on [R].[Guid] = [B].[Guid] and [spid] = @@Spid

		left join [#LeaseApartment] [L] On [A].[Guid] = [L].[ApartmentGuid] and [L].[LeaseKind]  = 0 --and ([L].[ContractFinish] = 0) --      

		left join #LeaseApartment_Max_Number [LastLease] On [LastLease].[Number] = [L].[Number] and [LastLease].[ApartmentGuid] = [L].[ApartmentGuid]
									and [LastLease].[LeaseKind] = 0
		left join #LeaseApartment_Max_Number [Sales] On [Sales].[ApartmentGuid] = [A].[Guid]
														and [Sales].[LeaseKind] = 1
														
		left join [Rentinfo] Rn on Rn.Guid = l.RentInfoGuid
		
  	where
  		([A].[No] = @FlatNo or @FlatNo = '')
  		and ([A].[FlatKind] = @FlatKind or @FlatKind = '')
  		and ([A].[Class] = @Class or @Class = '')
  		and ([A].[ApartmentType] = @ApartmentType or @ApartmentType = '')
  		and ([A].[Area] between @FlatArea1 and @FlatArea2 or @FlatArea2 = 0) 
  		and ([Unity] = @Unity or @Unity = '')
  		--and (
  		--		(Case when [L].[ContractFinish] = 0 then 0 else 1 end = @RentState)
  		--		or @RentState = 2
  		--	)
  		and 
  			(
  				(
  					(([L].[ToDate] <= GetDate()) or ([L].[ContractFinish] = 1) ) and @ContractState = 0
 				)
  			  	or ( 
  					(
  						(([L].[ToDate] > GetDate()) and ([L].[ContractFinish] = 0) ) and @ContractState = 1
  					)
  					)
  				or @ContractState = 2
  			)
  

		and (L.whereabouts = @whereabouts or @whereabouts = '')
  		and ([L].[RentInfoGuid] = @RentInfoGuid or @RentInfoGuid = 0x0)
  		and ([L].[SalesManGuid] = @SalesManGuid or @SalesManGuid = 0x0)
  		and ([Sales].[ApartmentGuid] is null)
  		and ([L].[Rent] Between @Rent1 and @Rent2 or @Rent2 = 0)
  		and 
  			(
  				
  				Case  when (@OperationNote = 0) and ([A].[Note] Like @RealtyNote) then 1
   					  when (@OperationNote = 1) and ([A].[Note] Not Like @RealtyNote) then 1
  					  when (@OperationNote = 2) and ([A].[Note] = @RealtyNote) then 1
  				else 
  					0 end = 1
  					
  				or @ActiveNote = 0
  			)
  
  		and 
  			(
  				Case  when (@ContractOpNote = 0) and ([L].[Note2] Like @ContractNote) then 1
   					  when (@ContractOpNote = 1) and ([L].[Note2] Not Like @ContractNote) then 1
  					  when (@ContractOpNote = 2) and ([L].[Note2] = @ContractNote) then 1
  				else 
  					0 end = 1
  
  				or @ContractActiveNote = 0
 			)
  		and (IsNull([A].[Judicial],0) = @Judicial or @Judicial = 2)
  		and (IsNull([L].[Judicial],0) = @JudicialContract or @JudicialContract = 2)
  		and (A.Ban = @banRealty or @banRealty = 2)
  		--and L.Number = 114

	--Select [rentafterdiscount], * from @Tbl L --where ContractNumber = 114

	

	if @ShowAccumulate = 0
	Delete @Tbl From @Tbl [T] inner join [AccumulateFlat] [F] on [F].[FlatGuid] = [T].[FlatGuid] 

	
	if @ShowAccumulateEndContract = 0
	begin
	Delete @Tbl 
	From 
		@Tbl [T] 
		inner join [AccumulateFlat] [F] on [F].[ParentGuid] = [T].[FlatGuid] and isnull([t].[ContractFinish],1) = 1
		inner join [AccumulateFlat] [F2] on [F2].FlatGuid = [F].[FlatGuid] and isnull([T].[ContractFinish],0) = 0
	end

	
	
	if (@ShowAssemplyRealtyRent = 1) and (@ShowFlat = 1)
	Update @Tbl
	Set
		[State] = Au.[State],
		[RentState] = au.[RentState],
		[ContractState] = Au.[ContractState],
		[CustName] = Au.[CustName],
		[CustMobile] = Au.[CustMobile],
		[CustNationality] = Au.[CustNationality],
		[CustEMail] = Au.[CustEMail],
		ContractDateBegin = Au.ContractDateBegin,
		ContractDateEnd = Au.ContractDateEnd,
		ContractFinish = Au.ContractFinish,
		ContractFinishDate = Au.ContractFinishDate,
		--Rent = Au.Rent,
		PayType = Au.PayType,
		--RentAfterDiscount = Au.RentAfterDiscount,
		--TotalInsurance = Au.TotalInsurance,
		ContractNote = Au.ContractNote,
		RentalName = Au.RentalName,
		ContractGuid = Au.ContractGuid
	From
		@Tbl T
		inner join (
					Select 
						pT.*,
						pA.FlatGuid as P_FlatGuid
					From
						@Tbl pT
						inner join [AccumulateFlat] pA on pA.ParentGuid  = pT.FlatGuid
					) Au on Au.P_FlatGuid = t.FlatGuid
	
	
	
	
	if @ShowShop = 1 
	Insert into @Tbl 
	Select 
		[A].[No] as [FlatNo]
		,[B].[Name] as [BuildingName]
		,dbo.sc('') as [FlatKind]
		,[A].[Description] as [FlatType]
		,A.[Class]
		,[A].[Area] as [FlatArea]

		,Case when [L].[ContractFinish] = 0 then  dbo.sc('') 
			  else dbo.SC(' ') 
		end as [State],
		
		Case when [L].[ContractFinish] = 0 then 0 else 1 end as [RentState]

		
		,Case when [L].[ContractFinish] = 0 then
			 Case when (([L].[ToDate] <= GetDate()) or ([L].[ContractFinish] = 1)) 
						--or (@Date2 > [L].[ToDate]) 
						then dbo.sc(' ')  
				  when ([L].[ToDate] > GetDate()) and ([L].[ContractFinish] = 0) then dbo.sc('  ')  end 
		 end as [ContractState]

		,[B].[Emirate] as [Emirate]
		,[B].[Suburb] as [Suburb]
		,[B].[Area] as [Area]
		,[B].[Street] as [Street]
		,[A].[No]
		,[A].[WaterCounter]
		,[A].[ElectricityCounter]

		,0 as [BathroomCount]
		,0 as [BalconyCount]

		,[A].[Rent] as RentPrice
		,[A].[Sale] as SalePrice1
		,0 as SalePrice2
		,0 as SalePrice3

		,[L].[CustName]
		,[L].[CustMobile]
		,[L].[CustNationality]
		,[L].[CustEMail] as [CustEMail]
		,Case when [L].[ContractFinish] = 0 then [L].[FromDate] end as [ContractDateBegin]
		,Case when [L].[ContractFinish] = 0 then [L].[ToDate] end as [ContractDateEnd]
		,[L].[ContractFinish]
		,Case when [L].[ContractFinish] = 1 then [L].[ContractFinishDate] End as [ContractFinishDate]
		,[L].[Guid] as [ContractGuid]
		,Case when [L].[ContractFinish] = 0 then [L].[Rent] end 
		,L.[PayType]
		,Case when [L].[ContractFinish] = 0 then [L].[Rent] - [L].[DiscountValue] end
		,L.[TotalInsurance]
		,[A].[Guid]
		,Left([A].[Note],255)
		,Left([L].[Note2],255)
		,[Rn].Name as RentalName
		,Case when IsNull(A.[Judicial],0) = 0 then dbo.SC('') else dbo.SC('') end
		,Case when IsNull(L.[Judicial],0) = 0 then dbo.SC('') else dbo.SC('') end
		,L.Cu_AcountGuid as CustAccountGuid
	from 
		[#Building] [B]
		Inner join [vwShopAll] [A] On [A].[BuildingGuid] = [B].[Guid]
		Inner join [Resource] [R] on [R].[Guid] = [B].[Guid] and [spid] = @@Spid
		
		left join [#LeaseApartment] [L] On [A].[Guid] = [L].[ApartmentGuid] and [L].[LeaseKind]  = 1 --and ([L].[ContractFinish] = 0) /*19/8/2014*/
		
		left join #LeaseApartment_Max_Number [LastLease] On [LastLease].[Number] = [L].[Number] and [LastLease].[ApartmentGuid] = [L].[ApartmentGuid]
									and [LastLease].[LeaseKind]  = 1
		left join #LeaseApartment_Max_Number [Sales] On [Sales].[ApartmentGuid] = [A].[Guid] and [Sales].[LeaseKind]  = 3
		left join [Rentinfo] Rn on Rn.Guid = l.RentInfoGuid
	where
 		([A].[No] = @FlatNo or @FlatNo = '')
 		and ([A].[Class] = @Class or @Class = '')
 		and ([A].[Description] = @ApartmentType or @ApartmentType = '')
		and ([A].[Area] between @FlatArea1 and @FlatArea2 or @FlatArea2 = 0) 
		and ([Unity] = @Unity or @Unity = '')

		and (
			(
				
				Case  when (@OperationNote = 0) and ([A].[Note] Like @RealtyNote) then 1
 					  when (@OperationNote = 1) and ([A].[Note] Not Like @RealtyNote) then 1
					  when (@OperationNote = 2) and ([A].[Note] = @RealtyNote) then 1
				else 
					0 end = 1
					
				or @ActiveNote = 0
			)

		--and 
		--	(
  		--		(Case when [L].[ContractFinish] = 0 then 0 else 1 end = @RentState)
  		--		or @RentState = 2
		--	)
		and 
			(
				([L].[ToDate] <= GetDate() and @ContractState = 0)
			  	or ([L].[ToDate] > GetDate() and @ContractState = 1)
				or @ContractState = 2
			)

		and ([L].[RentInfoGuid] = @RentInfoGuid or @RentInfoGuid = 0x0)
		and ([L].[SalesManGuid] = @SalesManGuid or @SalesManGuid = 0x0)

		and ([Sales].[ApartmentGuid] is null)
		and ([L].[Rent] Between @Rent1 and @Rent2 or @Rent2 = 0)
		and (L.whereabouts = @whereabouts or @whereabouts = '')
		and 
			(
				Case  when (@OperationNote = 0) and ([A].[Note] Like @RealtyNote) then 1
 					  when (@OperationNote = 1) and ([A].[Note] Not Like @RealtyNote) then 1
					  when (@OperationNote = 2) and ([A].[Note] = @RealtyNote) then 1
				else 
					0 end = 1
					
				or @ActiveNote = 0
			)

		and 
			(
				Case  when (@ContractOpNote = 0) and ([L].[Note2] Like @ContractNote) then 1
 					  when (@ContractOpNote = 1) and ([L].[Note2] Not Like @ContractNote) then 1
					  when (@ContractOpNote = 2) and ([L].[Note2] = @ContractNote) then 1
				else 
					0 end = 1

				or @ContractActiveNote = 0
			)

			)
		and (IsNull([A].[Judicial],0) = @Judicial or @Judicial = 2)
  		and (IsNull([L].[Judicial],0) = @JudicialContract or @JudicialContract = 2)
		and (A.Ban = @banRealty or @banRealty = 2)
	
	
	

	

	if @ShowAccumulate = 0
	Delete @Tbl From @Tbl [T] inner join [AccumulateShop] [F] on [F].[ShopGuid] = [T].[FlatGuid] 


	if @ShowAccumulateEndContract = 0
	Delete @Tbl From @Tbl [T] inner join [AccumulateShop] [F] on [F].[ShopGuid] = [T].[FlatGuid] 
																and [t].[ContractFinish] = 1

	if (@ShowAssemplyRealtyRent = 1) and (@ShowShop = 1)
	Update @Tbl
	Set
		[State] = Au.[State],
		[RentState] = Au.[RentState],
		[ContractState] = Au.[ContractState],
		[CustName] = Au.[CustName],
		[CustMobile] = Au.[CustMobile],
		[CustNationality] = Au.[CustNationality],
		[CustEMail] = Au.[CustEMail],
		ContractDateBegin = Au.ContractDateBegin,
		ContractDateEnd = Au.ContractDateEnd,
		ContractFinish = Au.ContractFinish,
		ContractFinishDate = Au.ContractFinishDate,
		--Rent = Au.Rent,
		PayType = Au.PayType,
		--RentAfterDiscount = Au.RentAfterDiscount,
		--TotalInsurance = Au.TotalInsurance,
		ContractNote = Au.ContractNote,
		RentalName = Au.RentalName,
		ContractGuid = Au.ContractGuid
	From
		@Tbl T
		inner join (
					Select 
						pT.*,
						pA.ShopGuid as P_ShopGuid
					From
						@Tbl pT
						inner join [AccumulateShop] pA on pA.ParentGuid  = pT.FlatGuid
					) Au on Au.P_ShopGuid = t.FlatGuid


	--  
	if @RentState <> 2
	Delete @Tbl where RentState <> @RentState

	-- 
	Select Distinct [ContractGuid] into #TblContractGuid From @Tbl
	
	Select
		[P].[ContractGuid],
		Sum(IsNull([P].[Value] * [P].[CurrencyVal],0)) as [Total],
		Sum(IsNull([C1].[Value] * [C1].[CurrencyVal],0)) as [Collection]
	Into #Collection
	From
		[vwChecks] [P]
		left join [vwChecksCollection] [C1] 
			on [C1].[CheckGuid] = [P].[Guid] and [C1].[Kind] = 1
			and ( (C1.date between @IncomeDate1 and @IncomeDate2) 
					or isNull(@IncomeActiveDate,0) = 0
				)
		inner join #TblContractGuid [t] on [t].[ContractGuid] = [P].[ContractGuid]
		inner join CheckType CT on CT.Guid = p.TypeGuid
		left join [vwChecksCollection] [C3] 
			on [C3].[CheckGuid] = [P].[Guid] and [C3].[Kind] = 3
	WHERE
		C3.CheckGuid is Null
	--	(CT.CollectedEntryTypeGuid Is Null) --
	Group By
		[P].[ContractGuid]

	Select
		[P].[ContractGuid],
		Sum(IsNull([P].[Value] * [P].[CurrencyVal],0)) as [Total]
	Into #CheckTotal
	From
		[vwChecks] [P]
		left join [vwChecksCollection] [C1] 
			on [C1].[CheckGuid] = [P].[Guid] and [C1].[Kind] = 1
			and ( (C1.date between @IncomeDate1 and @IncomeDate2) 
					or isNull(@IncomeActiveDate,0) = 0
				)
		inner join #TblContractGuid [t] on [t].[ContractGuid] = [P].[ContractGuid]
		inner join CheckType CT on CT.Guid = p.TypeGuid
	--	(CT.CollectedEntryTypeGuid Is Null) --
	Group By
		[P].[ContractGuid]

	--Select * from #Collection
	
	--  
	Select
		[P].[ContractGuid],
		--Sum(IsNull([P].[Value] * [P].[CurrencyVal],0)) as [Total],
		Sum(IsNull([C1].[Value] * [C1].[CurrencyVal],0)) as [ReturnValue]
	Into #CollectionReturn
	From
		[vwChecks] [P]
		left join [vwChecksCollection] [C1] on [C1].[CheckGuid] = [P].[Guid] and [C1].[Kind] = 3
		and ( (C1.date between @IncomeDate1 and @IncomeDate2) or @IncomeActiveDate = 0)
		inner join #TblContractGuid [t] on [t].[ContractGuid] = [P].[ContractGuid]
	Group By
		[P].[ContractGuid]

	-- 
	Select
		[P].[ContractGuid],
		Sum(IsNull([P].[Value] * [P].[CurrencyVal],0)) as [Cash]
	Into #Cash
	From
		[vwContractCachPayment] [P]
		inner join @Tbl [t] on [t].[ContractGuid] = [P].[ContractGuid] and P.AcGuid = t.AcGuid
	where
		( ([P].date between @IncomeDate1 and @IncomeDate2) or IsNull(@IncomeActiveDate,0) = 0)
	Group By
		[P].[ContractGuid]

	/*	
	Select
		En.AcGuid,
		SUM(En.debit - en.Credit) as [Balance]
	into #CustBalance
	From
		(Select distinct AcGuid from @Tbl ) T
		inner join DEntry En on En.AcGuid = T.AcGuid
	Group By
		En.AcGuid
	*/		
	
	Select
		Ac.Guid as AcGuid,
		IsNull(Ac.Sumdebit,0) - isNull(Ac.SumCredit,0) as [Balance]
	into #CustBalance
	From
		(Select distinct AcGuid from @Tbl ) T
		inner join Account Ac on Ac.Guid = T.AcGuid
	
	--Select * from #CollectionReturn
	--Select * from #Collection

	Select 
		t.*,
		isNull([C].[Collection],0) as [Collection],
		isNull([Ct].[Total],0) - isNull([C].[Collection],0) - IsNull([RC].[ReturnValue],0) as [CheckNotCollection],
		isNull([h].[Cash],0) as [Cash],
		Case when [PayType] = 0 then t.[RentAfterDiscount] else IsNull([C].[Collection],0) + IsNull([h].[Cash],0) end as [TotalPays],
		Case when [PayType] = 0 then 0 else isNull(t.[RentAfterDiscount],0) - IsNull([C].[Collection],0) - IsNull([h].[Cash],0) end as [ContractRest],
		IsNull([RC].[ReturnValue],0) as [ReturnValue],
		
		Cast(0 as Float) as custBalance, --isNull(t.Rent,0) - IsNull([h].[Cash],0) - isNull([C].[Total],0) + IsNull([RC].[ReturnValue],0) as [CustBalance],
		
		Case when [R].[ObjGuid] is null then 0 
			 when [R].[ObjGuid] is not null  then 1 
		end as [Check],
			 		
		1 as Kind
	into #EndRes
	From
		@Tbl [t] 
		left join #Collection [C] on [t].[ContractGuid] = [C].[ContractGuid]
		left join #CheckTotal [Ct] on [t].[ContractGuid] = [Ct].[ContractGuid]
		left join #CollectionReturn [RC] on [t].[ContractGuid] = [RC].[ContractGuid]
		left join #Cash [h] on [t].[ContractGuid] = [h].[ContractGuid]
		left join [RepCheck] [R] on [R].[ObjGuid] = [t].[FlatGuid] and [R].[IdReport] = 5000
	where
		([R].[ObjGuid] is not null and @ShowIsCheck = 1)
		or
		([R].[ObjGuid] is null and @ShowIsNotCheck = 1)
		
	
	update	
		#EndRes
	set
		custBalance = C.Balance
	From
		#EndRes E
		inner join #CustBalance C on C.AcGuid = E.AcGuid
----------------------------
	/*
	Select 
		*,
		Case when [R].[ObjGuid] is null then 0 
			 when [R].[ObjGuid] is not null  then 1 end as [Check]
	into #EndRes
	From
		@Tbl [L]
		left join [RepCheck] [R] on [R].[ObjGuid] = [L].[FlatGuid] and [R].[IdReport] = 5000
	where
		([R].[ObjGuid] is not null and @ShowIsCheck = 1)
		or
		([R].[ObjGuid] is null and @ShowIsNotCheck = 1)
	Order By 
		[BuildingName],
		[FlatNo]
	*/

	--    
	--Select * from @Tbl where FlatGuid = '57EEBC86-9078-421D-A447-2798E15E428A'
	Update 
		#EndRes
	Set
		SalePrice1 = L.Sale
	From
		#EndRes T
		inner join vwLastFlatSalesPrice L on L.ParentGuid = T.[FlatGuid]

	Update 
		#EndRes
	Set
		SalePrice2 = L.Sale
	From
		#EndRes T
		inner join vwLastFlatSalesPrice2 L on L.ParentGuid = T.[FlatGuid]
		
	Update 
		#EndRes
	Set
		SalePrice3 = L.Sale
	From
		#EndRes T
		inner join vwLastFlatSalesPrice3 L on L.ParentGuid = T.[FlatGuid]		

	if @ShowSaleRealty = 0
	begin
			
		delete #EndRes 
		From
			#EndRes R
			inner join LeaseApartment L on L.ApartmentGuid = R.FlatGuid
		where 
			(LeaseKind = 2) or (LeaseKind = 3)
	end

	if @ExportCSV = 1
	begin
		exec dropobject 'RepFlatRentcsv'
		
		Select 
			*
		into RepFlatRentcsv
		from 
			#EndRes
		Order By 
			[BuildingName],
			[FlatNo]		
		return
	end
	
	Select 
		* 
	from 
		#EndRes
	Order By 
		[BuildingName],
		[FlatNo]
	
	Select
		[BuildingName],
		Sum(Case when [State] = dbo.sc('') then 1 else 0 end) as [StateRent],
		Sum(Case when [State] = dbo.sc(' ') then 1 else 0 end) as [StateNotRent],
		COUNT(*) as UnitCount,
		Sum([Rent]) as [Rent],
		Sum([RentAfterDiscount]) as [RentAfterDiscount],
		Sum(Case when [Judicial] = dbo.SC('') then 1 else 0 end) as [Judicial],
		SUM([Collection]) as [Collection],
		SUM([Cash]) as [Cash],
		SUM([TotalPays]) as [TotalPays],
		SUM([ContractRest]) as [ContractRest],
		SUM([CheckNotCollection]) as [CheckNotCollection],
		0 as Kind
	into #EndRes_2
	From
		#EndRes
	Group By
		[BuildingName]

	insert into #EndRes_2
	Select
		dbo.SC('') as [BuildingName],
		Sum([StateRent]),
		Sum([StateNotRent]),
		isNull(Sum([StateRent]),0) + isNull(Sum([StateNotRent]),0),
		Sum([Rent]) as [Rent],
		Sum([RentAfterDiscount]) as [RentAfterDiscount],
		Sum([Judicial]),
		SUM([Collection]),
		SUM([Cash]) as [Cash],
		SUM([TotalPays]) as [TotalPays],
		SUM([ContractRest]) as [ContractRest],
		SUM([CheckNotCollection]) as [CheckNotCollection],
		1 as Kind
	From
		#EndRes_2

	Select
		*
	From
		#EndRes_2
	Order By
		Kind , BuildingName		

	Declare @AllCount int
	Select @AllCount  = COUNT(*) from #EndRes 

	Select 
		CustNationality, COUNT(*) as [Count] , 
		100.00 * COUNT(*) / @AllCount * 1.00 as [Percent] , 
		@AllCount as AllCount from #EndRes 
	group by
		CustNationality
	order by
		[Percent] desc

GO

SET ANSI_NULLS, QUOTED_IDENTIFIER ON
GO

Create Trigger [TRG_Trace_EntryType]
on [EntryType]
 
for update
As
	SET NOCOUNT ON;
	if Not exists(Select Value from DMD_const where vName = 'ActiveLogCardUpdate' and Value = '1' ) return
	
	Declare @UserGuid uniqueidentifier, @Guid uniqueidentifier
	Set @Guid = NEWID()
	
	Select Top 1 @UserGuid = userGuid From CurrentUsers where Spid = @@SPID
			
	insert into [Trace]
	([Guid],[ParentGuid],[Date],[userGuid],[HostName],ParentTbl )
	Select Top 1
		@Guid,
		N.Guid,
		GETDATE(),
		@UserGuid,
		Host_Name(),
		'EntryType'
	From
		[inserted] n 
		
	insert into [TraceDetail]
	([ParentGuid],[Caption],[Old],[New],[Tbl])
	Select Top 1
		@Guid,
		' ' as [Caption],
		D.[SecLvl] as [old],
		N.[SecLvl] as [New],
		''
	From
		[deleted] d
		inner join [inserted] n on D.Guid = N.Guid
	where
		N.[SecLvl] <> D.[SecLvl]
		
	insert into [TraceDetail]
	([ParentGuid],[Caption],[Old],[New],[Tbl])
	Select Top 1
		@Guid,
		'' as [Caption],
		D.[Code] as [old],
		N.[Code] as [New],
		''
	From
		[deleted] d
		inner join [inserted] n on D.Guid = N.Guid
	where
		N.[Code] <> D.[Code]
		
	insert into [TraceDetail]
	([ParentGuid],[Caption],[Old],[New],[Tbl])
	Select Top 1
		@Guid,
		'' as [Caption],
		D.[Name] as [old],
		N.[Name] as [New],
		''
	From
		[deleted] d
		inner join [inserted] n on D.Guid = N.Guid
	where
		N.[Name] <> D.[Name]
		
	insert into [TraceDetail]
	([ParentGuid],[Caption],[Old],[New],[Tbl])
	Select Top 1
		@Guid,
		' ' as [Caption],
		D.[ltnName] as [old],
		N.[ltnName] as [New],
		''
	From
		[deleted] d
		inner join [inserted] n on D.Guid = N.Guid
	where
		N.[ltnName] <> D.[ltnName]
		
	insert into [TraceDetail]
	([ParentGuid],[Caption],[Old],[New],[Tbl])
	Select Top 1
		@Guid,
		' ' as [Caption],
		D.[Menu] as [old],
		N.[Menu] as [New],
		''
	From
		[deleted] d
		inner join [inserted] n on D.Guid = N.Guid
	where
		N.[Menu] <> D.[Menu]
		
	insert into [TraceDetail]
	([ParentGuid],[Caption],[Old],[New],[Tbl])
	Select Top 1
		@Guid,
		'  ' as [Caption],
		D.[LtnMenu] as [old],
		N.[LtnMenu] as [New],
		''
	From
		[deleted] d
		inner join [inserted] n on D.Guid = N.Guid
	where
		N.[LtnMenu] <> D.[LtnMenu]
		
	insert into [TraceDetail]
	([ParentGuid],[Caption],[Old],[New],[Tbl])
	Select Top 1
		@Guid,
		' ' as [Caption],
		D.[ShortCut] as [old],
		N.[ShortCut] as [New],
		''
	From
		[deleted] d
		inner join [inserted] n on D.Guid = N.Guid
	where
		N.[ShortCut] <> D.[ShortCut]
		
	insert into [TraceDetail]
	([ParentGuid],[Caption],[Old],[New],[Tbl])
	Select Top 1
		@Guid,
		'' as [Caption],
		D.[DefAccountGuid] as [old],
		N.[DefAccountGuid] as [New],
		'[Account]'
	From
		[deleted] d
		inner join [inserted] n on D.Guid = N.Guid
	where
		N.[DefAccountGuid] <> D.[DefAccountGuid]
		
	insert into [TraceDetail]
	([ParentGuid],[Caption],[Old],[New],[Tbl])
	Select Top 1
		@Guid,
		'  ' as [Caption],
		D.[DebitField] as [old],
		N.[DebitField] as [New],
		''
	From
		[deleted] d
		inner join [inserted] n on D.Guid = N.Guid
	where
		N.[DebitField] <> D.[DebitField]
		
	insert into [TraceDetail]
	([ParentGuid],[Caption],[Old],[New],[Tbl])
	Select Top 1
		@Guid,
		'  ' as [Caption],
		D.[CreditField] as [old],
		N.[CreditField] as [New],
		''
	From
		[deleted] d
		inner join [inserted] n on D.Guid = N.Guid
	where
		N.[CreditField] <> D.[CreditField]
		
	insert into [TraceDetail]
	([ParentGuid],[Caption],[Old],[New],[Tbl])
	Select Top 1
		@Guid,
		'  ' as [Caption],
		D.[DebitCaption] as [old],
		N.[DebitCaption] as [New],
		''
	From
		[deleted] d
		inner join [inserted] n on D.Guid = N.Guid
	where
		N.[DebitCaption] <> D.[DebitCaption]
		
	insert into [TraceDetail]
	([ParentGuid],[Caption],[Old],[New],[Tbl])
	Select Top 1
		@Guid,
		'  ' as [Caption],
		D.[CreditCaption] as [old],
		N.[CreditCaption] as [New],
		''
	From
		[deleted] d
		inner join [inserted] n on D.Guid = N.Guid
	where
		N.[CreditCaption] <> D.[CreditCaption]
		
	insert into [TraceDetail]
	([ParentGuid],[Caption],[Old],[New],[Tbl])
	Select Top 1
		@Guid,
		'   ' as [Caption],
		D.[LtnDebitCaption] as [old],
		N.[LtnDebitCaption] as [New],
		''
	From
		[deleted] d
		inner join [inserted] n on D.Guid = N.Guid
	where
		N.[LtnDebitCaption] <> D.[LtnDebitCaption]
		
	insert into [TraceDetail]
	([ParentGuid],[Caption],[Old],[New],[Tbl])
	Select Top 1
		@Guid,
		'   ' as [Caption],
		D.[LtnCreditCaption] as [old],
		N.[LtnCreditCaption] as [New],
		''
	From
		[deleted] d
		inner join [inserted] n on D.Guid = N.Guid
	where
		N.[LtnCreditCaption] <> D.[LtnCreditCaption]
		
	insert into [TraceDetail]
	([ParentGuid],[Caption],[Old],[New],[Tbl])
	Select Top 1
		@Guid,
		' ' as [Caption],
		D.[CkCurrency] as [old],
		N.[CkCurrency] as [New],
		''
	From
		[deleted] d
		inner join [inserted] n on D.Guid = N.Guid
	where
		N.[CkCurrency] <> D.[CkCurrency]
		
	insert into [TraceDetail]
	([ParentGuid],[Caption],[Old],[New],[Tbl])
	Select Top 1
		@Guid,
		'  ' as [Caption],
		D.[CkCost] as [old],
		N.[CkCost] as [New],
		''
	From
		[deleted] d
		inner join [inserted] n on D.Guid = N.Guid
	where
		N.[CkCost] <> D.[CkCost]
		
	insert into [TraceDetail]
	([ParentGuid],[Caption],[Old],[New],[Tbl])
	Select Top 1
		@Guid,
		' ' as [Caption],
		D.[CkNote] as [old],
		N.[CkNote] as [New],
		''
	From
		[deleted] d
		inner join [inserted] n on D.Guid = N.Guid
	where
		N.[CkNote] <> D.[CkNote]
		
	insert into [TraceDetail]
	([ParentGuid],[Caption],[Old],[New],[Tbl])
	Select Top 1
		@Guid,
		'  1' as [Caption],
		D.[Color1] as [old],
		N.[Color1] as [New],
		''
	From
		[deleted] d
		inner join [inserted] n on D.Guid = N.Guid
	where
		N.[Color1] <> D.[Color1]
		
	insert into [TraceDetail]
	([ParentGuid],[Caption],[Old],[New],[Tbl])
	Select Top 1
		@Guid,
		'  2' as [Caption],
		D.[Color2] as [old],
		N.[Color2] as [New],
		''
	From
		[deleted] d
		inner join [inserted] n on D.Guid = N.Guid
	where
		N.[Color2] <> D.[Color2]
		
	insert into [TraceDetail]
	([ParentGuid],[Caption],[Old],[New],[Tbl])
	Select Top 1
		@Guid,
		' ' as [Caption],
		D.[CreateEntry] as [old],
		N.[CreateEntry] as [New],
		''
	From
		[deleted] d
		inner join [inserted] n on D.Guid = N.Guid
	where
		N.[CreateEntry] <> D.[CreateEntry]
		
	insert into [TraceDetail]
	([ParentGuid],[Caption],[Old],[New],[Tbl])
	Select Top 1
		@Guid,
		'   ' as [Caption],
		D.[AutoCreateEntry] as [old],
		N.[AutoCreateEntry] as [New],
		''
	From
		[deleted] d
		inner join [inserted] n on D.Guid = N.Guid
	where
		N.[AutoCreateEntry] <> D.[AutoCreateEntry]
		
	insert into [TraceDetail]
	([ParentGuid],[Caption],[Old],[New],[Tbl])
	Select Top 1
		@Guid,
		'   ' as [Caption],
		D.[AutoPostedEntry] as [old],
		N.[AutoPostedEntry] as [New],
		''
	From
		[deleted] d
		inner join [inserted] n on D.Guid = N.Guid
	where
		N.[AutoPostedEntry] <> D.[AutoPostedEntry]
		
	insert into [TraceDetail]
	([ParentGuid],[Caption],[Old],[New],[Tbl])
	Select Top 1
		@Guid,
		'     ' as [Caption],
		D.[OpMoveCostwithDefAccount] as [old],
		N.[OpMoveCostwithDefAccount] as [New],
		''
	From
		[deleted] d
		inner join [inserted] n on D.Guid = N.Guid
	where
		N.[OpMoveCostwithDefAccount] <> D.[OpMoveCostwithDefAccount]
		
	insert into [TraceDetail]
	([ParentGuid],[Caption],[Old],[New],[Tbl])
	Select Top 1
		@Guid,
		'   ' as [Caption],
		D.[OpEntryForOneItem] as [old],
		N.[OpEntryForOneItem] as [New],
		''
	From
		[deleted] d
		inner join [inserted] n on D.Guid = N.Guid
	where
		N.[OpEntryForOneItem] <> D.[OpEntryForOneItem]
		
	insert into [TraceDetail]
	([ParentGuid],[Caption],[Old],[New],[Tbl])
	Select Top 1
		@Guid,
		'      ' as [Caption],
		D.[OpObverseNoteItem] as [old],
		N.[OpObverseNoteItem] as [New],
		''
	From
		[deleted] d
		inner join [inserted] n on D.Guid = N.Guid
	where
		N.[OpObverseNoteItem] <> D.[OpObverseNoteItem]
		
	insert into [TraceDetail]
	([ParentGuid],[Caption],[Old],[New],[Tbl])
	Select Top 1
		@Guid,
		'     ' as [Caption],
		D.[NeedCostItem] as [old],
		N.[NeedCostItem] as [New],
		''
	From
		[deleted] d
		inner join [inserted] n on D.Guid = N.Guid
	where
		N.[NeedCostItem] <> D.[NeedCostItem]
		
	insert into [TraceDetail]
	([ParentGuid],[Caption],[Old],[New],[Tbl])
	Select Top 1
		@Guid,
		'    ' as [Caption],
		D.[NeedNoteItem] as [old],
		N.[NeedNoteItem] as [New],
		''
	From
		[deleted] d
		inner join [inserted] n on D.Guid = N.Guid
	where
		N.[NeedNoteItem] <> D.[NeedNoteItem]
		
	insert into [TraceDetail]
	([ParentGuid],[Caption],[Old],[New],[Tbl])
	Select Top 1
		@Guid,
		'   ' as [Caption],
		D.[AutoSMSAfterAdd] as [old],
		N.[AutoSMSAfterAdd] as [New],
		''
	From
		[deleted] d
		inner join [inserted] n on D.Guid = N.Guid
	where
		N.[AutoSMSAfterAdd] <> D.[AutoSMSAfterAdd]
		
	insert into [TraceDetail]
	([ParentGuid],[Caption],[Old],[New],[Tbl])
	Select Top 1
		@Guid,
		'  ' as [Caption],
		D.[SMSMsg] as [old],
		N.[SMSMsg] as [New],
		''
	From
		[deleted] d
		inner join [inserted] n on D.Guid = N.Guid
	where
		N.[SMSMsg] <> D.[SMSMsg]
		
	insert into [TraceDetail]
	([ParentGuid],[Caption],[Old],[New],[Tbl])
	Select Top 1
		@Guid,
		'  ' as [Caption],
		D.[SMSMsgEn] as [old],
		N.[SMSMsgEn] as [New],
		''
	From
		[deleted] d
		inner join [inserted] n on D.Guid = N.Guid
	where
		N.[SMSMsgEn] <> D.[SMSMsgEn]
		
	insert into [TraceDetail]
	([ParentGuid],[Caption],[Old],[New],[Tbl])
	Select Top 1
		@Guid,
		'  ' as [Caption],
		D.[DefPrintPath] as [old],
		N.[DefPrintPath] as [New],
		''
	From
		[deleted] d
		inner join [inserted] n on D.Guid = N.Guid
	where
		N.[DefPrintPath] <> D.[DefPrintPath]
		
	delete Trace From Trace t left join [TraceDetail] D on T.guid = D.ParentGuid
	where
		d.ParentGuid is Null and t.Guid = @Guid


GO

SET ANSI_NULLS, QUOTED_IDENTIFIER ON
GO

Create Procedure [PrcDayBook]
(
	@AccountGuid uniqueidentifier = '780ED9BA-5F69-4790-9C7F-41A75690FAF5',
	@CostGuid uniqueidentifier = 0x0,
	@BranchGuid uniqueidentifier = 0x0,
	@SalesManGuid uniqueidentifier = 0x0,
	@CurrencyGuid uniqueidentifier = '11111111-C748-4B13-8B91-1E9B299DF1C1',
	@CurrencyVal Float = 1,
	@CheckField int = 0 , -- 0 Debit   1 Credit  
	@Operation int = 0 , -- 0    1     2    3    4    5      6  
	@CheckValue1 Float = 0,
	@CheckValue2 Float = 0,
	@LikeNote Varchar(256) = '',
	@NotLikeNote Varchar(256) = '',

	@IsPosted Bit = 1,
	@IsNotPosted Bit = 1,

	@ActiveNum Bit = 0,
	@Num1 int = 0,
	@Num2 int = 1000,

	@ActiveDate Bit = 0,
	@Date1 DateTime = '1/31/2017',
	@Date2 DateTime = '12/15/2017',

	@CheckEntry bit = 1,
	@CheckPosted bit = 1,
	@Checkcollected bit = 1,
	@CheckPartialcollected bit = 1,
	@CheckReturned bit = 1,
	@CheckEndorsement bit = 1,
	@Mark Bit = 1,
	@NotMark Bit = 1,
	@GroupingEntry Bit = 0
)
 
as
	Select * Into #fnGetAccountList From [dbo].[fnGetAccountList](@AccountGuid)

	Select
		[M].[Date]
		,[En].[AcGuid]
		,Isnull(case when [En].[Debit] <> 0 then [En].[Debit] * 
			Case when [En].[CurrencyGuid] = @CurrencyGuid then 1 
			else [En].[CurrencyVal] / @CurrencyVal end
		end,0) as [Debit]
		,Isnull(case when [En].[Credit] <> 0 then [En].[Credit] * 
			Case when [En].[CurrencyGuid] = @CurrencyGuid then 1 
			else [En].[CurrencyVal] / @CurrencyVal end
		end,0) as [Credit]
		,[En].[Note]
		,[M].[Number] as [DocNum]
		,[M].[Number]
		,[En].[CostGuid]
		,[En].[ObverseAcGuid]
		,[M].[Guid]
		,[M].[ParentKind]
	into #Entry
	from
		[DEntry] [En]
		inner Join [vwEntry] [M] on [M].[Guid] = [En].[ParentGuid]
		inner join [dbo].#fnGetAccountList [FC] on [FC].[Guid] = [En].[AcGuid]
	where 
		([M].[BranchGuid] = @BranchGuid or @BranchGuid = 0x0)
		and ([En].[Note] Not Like '%'+@NotLikeNote+'%' or @NotLikeNote = '')
		and ([En].[Note] Like '%'+@LikeNote+'%' )
		and ([M].[Date] Between @Date1 And @Date2 or @ActiveDate = 0)
		and ([M].[Number] Between @Num1 And @Num2 or @ActiveNum = 0)
		and (
				(IsNull([M].[IsPosted],0) = 1 and @IsPosted = 1)
				or (IsNull([M].[IsPosted],0) = 0  and @IsNotPosted = 1)
			)
			
	--Select * from #Entry

	-- 
	if @CostGuid <> 0x0
	begin
		Select * into #fnGetCostList from [dbo].[fnGetCostList](@CostGuid)
		delete #Entry 
		from	
			#Entry En
			left Join [dbo].#fnGetCostList [Co] on [Co].[Guid] = [En].[CostGuid]
		where
			Co.Guid is Null
	end

	--Select * from #Entry
	
	Declare @Tbl Table
	(
		[Date] Datetime,
		[AccountGuid] uniqueidentifier,
		[debit] Float,
		[Credit] Float,
		[Note] varchar(256),
		[ReceiptNo] varchar(256),
		[Doc] varchar(256),
		[DocName] varchar(256),
		[DocNum] int,
		[Num] int,
		[CostGuid]  uniqueidentifier,
		[ObverseAcGuid]  uniqueidentifier,
		[Kind] int,
		[Guid] uniqueidentifier,
		[TypeGuid] uniqueidentifier,
		[Mark] Bit,
		[OrderDate] Datetime
	)

	--  
	if Exists(
				Select Top 1 Guid From [Resource] where [Guid] = 0x0 and [Spid] = @@Spid
			)
	Insert into @Tbl
	Select 
		[En].[Date]
		,[En].[AcGuid]
		,[En].[Debit]
		,[En].[Credit]
		,[En].[Note]
		,'' as [ReceiptNo]
		,'' [Doc]
		,'' [DocName]
		,[En].[Number] as [DocNum]
		,[En].[Number]
		,[En].[CostGuid]
		,[En].[ObverseAcGuid]
		,2 as [Kind]
		,[En].[Guid]
		,0x0
		,Null [Mark]
		,[En].[Date]
	from 
		#Entry En
	where 
		(
			([en].[ParentKind] = 0) --  
			or ([en].[ParentKind] = 158) --  
			or ([en].[ParentKind] = 150) --  
			or ([en].[ParentKind] = 151) --  
			or ([en].[ParentKind] = 152) --  
			or ([en].[ParentKind] = 153) --  
		)
		and (@SalesManGuid = 0x0)
	Order By 
		[En].[Date]


	--  
	if Exists(
				Select Top 1 Guid From [Resource] where [Guid] = '{11111111-0000-0000-0000-000000000000}' and [Spid] = @@Spid
			)
	Insert into @Tbl
	Select 
		[En].[Date]
		,[En].[AcGuid]
		,[en].[Debit]
		,[en].[Credit]
		,[En].[Note]
		,'' as [ReceiptNo]
		,'' [Doc]
		,dbo.Sc(' ') [DocName]
		,[En].[Number] as [DocNum]
		,[En].[Number]
		,[En].[CostGuid]
		,[En].[ObverseAcGuid]
		,2 as [Kind]
		,[En].[Guid]
		,0x0
		,Null [Mark]
		,[En].[Date]
	from 
		#entry en
	where 
		[ParentKind] = 1 --  
		and (@SalesManGuid = 0x0)
	Order By 
		[En].[Date]


	-- 
	Insert into @Tbl
	Select 
		[En].[Date]
		,[En].[AcGuid]
		,[en].[Debit]
		,[en].[Credit]
		,[En].[Note]
		,[S].[ReceiptNo]
		,[T].[Code] +'/'+ Cast(S.Number as Varchar(256))[Doc]
		,[T].Name as [DocName]
		,[S].[Number] as [DocNum]
		,[En].[Number]
		,[En].[CostGuid]
		,[En].[ObverseAcGuid]
		,2 as [Kind]
		,[En].[Guid]
		,S.TypeGuid
		,[s].[Mark]
		,[En].[Date]
	from 
		#entry En
		inner join [Secondary_Entry] [S] on [S].[Guid] = [En].[Guid]
		inner join [EntryType] T on T.Guid = S.TypeGuid
		inner join [Resource] [R] on [R].[Guid] = [S].[TypeGuid] and [Spid] = @@Spid
	where 
		(
				([S].[Mark] = 1 and @Mark = 1)
				or ([S].[Mark] = 0 and @NotMark = 1)
			)
		and ([S].[SalesManGuid] = @SalesManGuid or @SalesManGuid = 0x0)

	--___________________________________

	-- 
	Insert into @Tbl
	Select 
		[En].[Date]
		,[En].[AcGuid]
		,[en].[Debit]
		,[en].[Credit]
		,[En].[Note]
		,'' as [ReceiptNo]
		,T.Code +'/'+ Cast(S.Number as Varchar(256))[Doc]
		,T.Name as [DocName]
		,[S].[Number] as [DocNum]
		,[En].[Number]
		,[En].[CostGuid]
		,[En].[ObverseAcGuid]
		,2 as [Kind]
		,[En].[Guid]
		,S.TypeGuid
		,0 as [Mark]
		,[En].[Date]
	from 
		#entry En
		inner join [Bill] [S] on [S].EntryGuid = [En].[Guid]
		inner join [BillType] T on T.Guid = S.TypeGuid
		inner join [Resource] [R] on [R].[Guid] = [S].[TypeGuid] and [Spid] = @@Spid

	--___________________________________


	--
	Insert into @Tbl
	Select 
		[En].[Date]
		,[En].[AcGuid]
		,[en].[Debit]
		,[en].[Credit]
		,[En].[Note]
		,'' as [ReceiptNo]
		,S.TypeCode +'/'+ Cast(S.Number as Varchar(256))[Doc]
		,S.TypeName as [DocName]
		,[S].[Number] as [DocNum]
		,[En].[Number]
		,[En].[CostGuid]
		,[En].[ObverseAcGuid]
		,2 as [Kind]
		,[En].[Guid]
		,[S].[TypeGuid]
		,Null as Mark
		,[En].[Date]
	from 
		#entry En
		inner join [vwAllContract] [S] on [S].[Guid] = [En].[Guid]
		inner join [Resource] [R] on [R].[Guid] = [S].[TypeGuid] and [Spid] = @@Spid
	where 
		([S].[SalesManGuid] = @SalesManGuid or @SalesManGuid = 0x0)


	-- 
	Insert into @Tbl
	Select 
		[En].[Date]
		,[En].[AcGuid]
		,[en].[Debit]
		,[en].[Credit]
		,[En].[Note]
		,'' as [ReceiptNo]
		,T.Code +'/'+ Cast(S.Number as Varchar(256))[Doc]
		,T.Name [DocName]
		,[S].[Number] as [DocNum]
		,[En].[Number]
		,[En].[CostGuid]
		,[En].[ObverseAcGuid]
		,2 as [Kind]
		,[En].[Guid]
		,S.TypeGuid
		,0 as [Mark]
		,[En].[Date]
	from 
		#entry En
		inner join [Bill] [S] on [S].EntryGuid = [En].[Guid]
		inner join [BillType] T on T.Guid = S.TypeGuid
		inner join [Resource] [R] on [R].[Guid] = [S].[TypeGuid] and [Spid] = @@Spid

	--
		--  
	if @CheckEntry = 1
	Insert into @Tbl
	Select 
		[En].[Date]
		,[En].[AcGuid]
		,[en].[Debit]
		,[en].[Credit]
		,[En].[Note]
		,'' as [ReceiptNo]
		,T.Code +'/'+ Cast(C.Number as Varchar(256))[Doc]
		,T.Name as [DocName]
		,[C].[Number] as [DocNum]
		,[En].[Number]
		,[En].[CostGuid]
		,[En].[ObverseAcGuid]
		,2 as [Kind]
		,[En].[Guid]
		,[C].[TypeGuid]
		,Null as Mark
		,[En].[Date]
	from 
		#Entry En
		inner join [LinkEntry_Checks] [L] on [L].[EntryGuid] = [En].[Guid]
		inner join [Checks] [C] on [C].[Guid] = [L].[CheckGuid] and [L].[Kind] = 1600
		inner join [CheckType] T on t.Guid = C.TypeGuid
		inner join [Resource] [R] on ([R].[Guid] = [C].[TypeGuid] and [R].[Spid] = @@Spid)
	where 
		([C].[SalesManGuid] = @SalesManGuid or @SalesManGuid = 0x0)


	--
		--  
	Insert into @Tbl
	Select 
		[En].[Date]
		,[En].[AcGuid]
		,[en].[Debit]
		,[en].[Credit]
		,[En].[Note]
		,'' as [ReceiptNo]
		,T.Code +'/'+ Cast(C.Number as Varchar(256))[Doc]
		,T.Name as [DocName]
		,[C].[Number] as [DocNum]
		,[En].[Number]
		,[En].[CostGuid]
		,[En].[ObverseAcGuid]
		,2 as [Kind]
		,[En].[Guid]
		,[C].[TypeGuid]
		,Null as Mark
		,[En].[Date]
	from 
		#Entry En
		inner join [LinkEntry_Checks] [L] on [L].[EntryGuid] = [En].[Guid]
		inner join [Checks] [C] on [C].[Guid] = [L].[CheckGuid] and (
																		([L].[Kind] = 1660 + Case when @CheckPosted = 1 then 0 end)
																	or	([L].[Kind] = 1660 + Case when @Checkcollected = 1 then 1 end)
																	or	([L].[Kind] = 1660 + Case when @CheckEndorsement = 1 then 2 end)
																	or	([L].[Kind] = 1660 + Case when @CheckReturned = 1 then 3 end)
																	)
		inner join [CheckType] T on t.Guid = C.TypeGuid
		inner join [Resource] [R] on ([R].[Guid] = [C].[TypeGuid] and [R].[Spid] = @@Spid)
	where 
		([C].[SalesManGuid] = @SalesManGuid or @SalesManGuid = 0x0)

	
	--
		--  
	if @CheckPartialcollected = 1
	Insert into @Tbl
	Select 
		[En].[Date]
		,[En].[AcGuid]
		,[en].[Debit]
		,[en].[Credit]
		,[En].[Note]
		,'' as [ReceiptNo]
		,T.Code +'/'+ Cast(C.Number as Varchar(256))[Doc]
		,T.Name as [DocName]
		,[C].[Number] as [DocNum]
		,[En].[Number]
		,[En].[CostGuid]
		,[En].[ObverseAcGuid]
		,2 as [Kind]
		,[En].[Guid]
		,[C].[TypeGuid]
		,Null as Mark
		,[En].[Date]
	from 
		#Entry En
		INNER JOIN [ChecksPartialCollection] [L] ON [L].[Guid] = [En].[Guid]
		inner join [Checks] [C] on [C].[Guid] = [L].[CheckGuid] 
		inner join [CheckType] T on t.Guid = C.TypeGuid
		inner join [Resource] [R] on ([R].[Guid] = [C].[TypeGuid] and [R].[Spid] = @@Spid)
	where 
		([C].[SalesManGuid] = @SalesManGuid or @SalesManGuid = 0x0)


	Delete @Tbl
	where
		(
			Case
				-- Non
				when @Operation = 0 then 1 
				-- <
				when @Operation = 1 then Case when 
													(
														Case 
																when @CheckField = 0 then [Debit]
																when @CheckField = 1 then [Credit] 
														 end
													 ) < @CheckValue1 then 1 else 0  
										 end
			
				-- >
				when @Operation = 2 then Case when 
													(
														Case 
																when @CheckField = 0 then [Debit]
																when @CheckField = 1 then [Credit] 
														 end
													 ) > @CheckValue1 then 1 else 0  
										 end
				-- =
				when @Operation = 3 then Case when 
													(
														Case 
																when @CheckField = 0 then [Debit]
																when @CheckField = 1 then [Credit] 
														 end
													 ) = @CheckValue1 then 1 else 0  
										 end
				-- 
				when @Operation = 4 then Case when 
													(
														Case 
																when @CheckField = 0 then [Debit]
																when @CheckField = 1 then [Credit] 
														 end
													 ) between @CheckValue1 and @CheckValue2 then 1 else 0  
										 end
				-- <=
				when @Operation = 5 then Case when 
													(
														Case 
																when @CheckField = 0 then [Debit]
																when @CheckField = 1 then [Credit] 
														 end
													 ) <= @CheckValue1 then 1 else 0  
										 end
				-- >=
				when @Operation = 6 then Case when 
													(
														Case 
																when @CheckField = 0 then [Debit]
																when @CheckField = 1 then [Credit] 
														 end
													 ) >= @CheckValue1 then 1 else 0  
										 end
			end
			= 0	
			)



	Select 
		[Date],
		[Ac].[Code]+'-'+[Ac].[Name] as [Account],
		[T].[debit],
		[T].[Credit],
		[T].[Note],
		[T].[ReceiptNo],
		[T].[Doc],
		[T].[DocNum],
		T.[DocName],
		[T].[Num],
		CAST('' as Varchar(256)) as [Cost],
		CAST('' as Varchar(256)) as [ObverseAc],
		[T].[Kind],
		[T].[Guid],
		[T].[CostGuid],
		[T].ObverseAcGuid,
		[T].[Orderdate]
	Into #EndRes
	from 
		@Tbl [T]
		inner join [vwAccount] [Ac] on [Ac].[Guid] = [T].[AccountGuid]
		
	
	update #EndRes Set [Cost] = [Co2].[Code]+'-'+[Co2].[Name]
	From
		#EndRes T
		--inner Join [dbo].[fnGetCostList](@CostGuid) [Co] on [Co].[Guid] = [T].[CostGuid]
		inner join [vwCost] [Co2] on [Co2].[Guid] = [T].[CostGuid]	
		
	update #EndRes Set [ObverseAc] = [Ac3].[Code]+'-'+[Ac3].[Name]
	From
		#EndRes T
		inner Join [vwAccount] [Ac3] on [Ac3].[Guid] = [T].[ObverseAcGuid]
		

	Insert into #EndRes
	(
		[Date],
		[Account],
		[debit],
		[Credit],
		[Note],
		[Doc],
		[Num],
		[Cost],
		[ObverseAc],
		[Kind],
		[Guid],
		[OrderDate]
	)
	Select 
		[Date],
		'' as [Account],
		Sum([debit]),
		Sum([Credit]),
		'' as [Note],
		[Doc],
		[Num],
		'' as [Cost],
		'' as [ObverseAc],
		1 as [Kind],
		[Guid],
		[OrderDate]
	from 
		#EndRes
	Group By
		[Date],
		[Doc],
		[Num],
		[Guid],
		[OrderDate]
	

	Select 
		Sum([debit]) as [debit],
		Sum([Credit]) as [Credit]
	from 
		#EndRes [T]
	where 
		Kind = 1
		
	Select 
		Case when Kind = 1 or @GroupingEntry = 0 then [Date] end as [Date],
		[Account],
		[T].[debit],
		[T].[Credit],
		[T].[Note],
		[T].[ReceiptNo],
		[T].[Doc],
		[T].[DocName],
		[T].[DocNum],
		[T].[Num],
		[Cost],
		[ObverseAc],
		[T].[Kind],
		[T].[Guid],
		[OrderDate],
		0 as [Operation]
	from 
		#EndRes [T]
	where
		Kind = 2 or @GroupingEntry = 1
	Order by 
		[OrderDate] ,[Num], [Kind]

GO

SET ANSI_NULLS, QUOTED_IDENTIFIER ON
GO

Create Procedure [PrcServicesContractList]
(
	@CustGuid uniqueidentifier = 0x0
	,@Emirate Varchar(256) = ''
	,@Suburb Varchar(256) = ''
	,@Area Varchar(256) = ''
	,@Street Varchar(256) = ''
	,@ContractState int = 1
	,@PayType int = 4
	,@Datewith int = 0
	,@Date1 DateTime = '12/30/1899'
	,@Date2 DateTime = '12/30/2016'
	,@ShowIsCheck Bit = 1
	,@ShowIsNotCheck Bit = 1
	,@CKDate Bit = 0
	,@EndState int = 2
	,@NewState int = 2
	,@Mark Bit = 1
	,@NotMark Bit = 1
	,@AcquittancePrinted int = 2
	,@AcquittancePrintedByUserGuid uniqueidentifier = 0x0
	,@LinkCheck int = 2
	,@whereabouts varchar(255) = ''
	,@Trademark varchar(255) = ''
	,@FinishDate int = 3
	,@ContractValue int = 2
)
 
as
	Set noCount on

	Declare @Msg varchar(255),
			@MsgConst varchar(255)
	Set @MsgConst = dbo.SC('  ')
			
	Set @Msg = @MsgConst
	exec PrcSetProgrss @Msg, 100, 0

	Declare @Tbl Table
	(
		[ContractNo] Varchar(256)
		,[BuildingName] Varchar(256)
		,[Value] Float
		,[Discount] Float
		,[ValueAfterDiscount] Float
		,[ContractState] Varchar(256)
		,[Emirate] Varchar(256)
		,[Suburb] Varchar(256)
		,[Area] Varchar(256)
		,[Street] Varchar(256)
		,[CustName] Varchar(256)
		,[CustPhone] Varchar(256)
		,[CustNationality] Varchar(256)
		,[CustEMail] Varchar(256)
		,[ContractDateEdit] Datetime
		,[ContractDateBegin] Datetime
		,[ContractDateEnd] Datetime
		,[ServicesContractType] Varchar(256)
		,[ContractFinish] Bit
		,[ContractGuid] uniqueidentifier
		,[NewState] int

		,[ContractFinishDate] Datetime
		,[ResultingAmount] Float
		,[ResultingAmount2] Float
		,[Note2] Varchar(1000)
		,[Purpose] Varchar(256)
		,Trademark Varchar(256)
		
		,[CountOldContract] int
		
		,[AcquittancePrinted] Bit
		,[AcquittancePrintdate] Datetime
		,[AcquittancePrintedBy] Varchar(256)
		,[CostGuid] uniqueidentifier
		,[AccountGuid] uniqueidentifier
		,[Mark] Bit

		--,[PrvContractFinishDate] Datetime
		--,[PrvContractEndDate] Datetime

		,[Kind] Int
		,[Sort] int
	)

	Declare  @Now_Date Datetime
	Set @Now_Date = GetDate()
	

	Set @Msg = @MsgConst
	exec PrcSetProgrss @Msg, 100, 5
	
	--Building
	Select
		*
	Into #Building_CL
	From
		[vwBuilding] B
	where
		([B].[Emirate] = @Emirate or @Emirate = '')
		and ([B].[Suburb] = @Suburb or @Suburb = '')
		and ([B].[Area] = @Area or @Area = '')
		and ([B].[Street] = @Street or @Street = '')
		
	Set @Msg = @MsgConst
	exec PrcSetProgrss @Msg, 100, 7
		

	--Select * from #Building_CL
		
	
	Select
		L.*
		--,(Select [ContractFinishDate] from [ServicesContract] where Guid = L.[PrvContractGuid]) as [PrvContractFinishDate]
		--,(Select [ToDate] from [ServicesContract] where Guid = L.[PrvContractGuid]) as [PrvContractEndDate]
		,T.Name as ContractName
		,U.LoginName as [AcquittancePrintedBy]
	into #ServicesContract_CL
	From
		[ServicesContract] L
		inner join ServicesContractType T on T.Guid = L.TypeGuid
		inner join [Resource] [R2] on [R2].[Guid] = [L].[TypeGuid]  and [R2].[Kind] = 100 and [R2].[spid] = @@Spid 
		left join [Realty_Users] U on U.[Guid] = L.AcquittancePrintedByGuid
	where
		([L].[CustomerGuid] = @CustGuid or @CustGuid = 0x0)
		and ([L].[ContractFinish] = @EndState or @EndState = 2)
		and (
				([l].[Mark] = 1 and @Mark = 1)
				or ([l].[Mark] = 0 and @NotMark = 1)
			)
		and (L.PayType = @PayType or @PayType  = 4)
		and (L.Trademark = @Trademark or @Trademark = '')
		and (L.AcquittancePrintedByGuid = @AcquittancePrintedByUserGuid or @AcquittancePrintedByUserGuid = 0x0)
		
		and (L.whereabouts = @whereabouts or @whereabouts = '')
		and (
				(
					(
					([ContractFinishDate] < [ToDate] and @FinishDate = 0) or
					([ContractFinishDate] > [ToDate] and @FinishDate = 1) or
					([ContractFinishDate] = [ToDate] and @FinishDate = 2) 
					)
				and [ContractFinish] = 1
				)
				or @FinishDate = 3
			)
		and (
				(([L].Rent - [L].DiscountValue) <> 0 and @ContractValue = 0) or
				(([L].Rent - [L].DiscountValue) = 0 and @ContractValue = 1) or
				@ContractValue = 2
			)
	
		and	(
				((([L].[ToDate] <= @Now_Date) or ([L].[ContractFinish] = 1)) and @ContractState = 0)
			  	or ([L].[ToDate] > @Now_Date and @ContractState = 1)
				or @ContractState = 2
			)		
			and (
				(
					([L].[FromDate] >= @Date1 and @Datewith  = 0)
					and ([L].[FromDate] <= @Date2 and @Datewith  = 0 or @Date2 = '12/30/1899')
				)
				or
				(
					([L].[ToDate] >= @Date1 and @Datewith  = 1)
					and ([L].[ToDate] <= @Date2 and @Datewith  = 1 or @Date2 = '12/30/1899')
				)

				or
				(
					([L].[ContractFinishDate] >= @Date1 and @Datewith  = 2)
					and ([L].[ContractFinishDate] <= @Date2 and @Datewith  = 2 or @Date2 = '12/30/1899')
					and ([L].[ContractFinish] = 1)
				)

				or
				(
					([L].[EditDate] >= @Date1 and @Datewith  = 3)
					and ([L].[EditDate] <= @Date2 and @Datewith  = 3 or @Date2 = '12/30/1899')
				)
				or
				(
					([L].[AcquittancePrintdate] >= @Date1 and @Datewith  = 4)
					and ([L].[AcquittancePrintdate] <= @Date2 and @Datewith  = 4 or @Date2 = '12/30/1899')
				)

				or @CKDate = 0
			) 
		and (L.AcquittancePrinted = @AcquittancePrinted or @AcquittancePrinted = 2)			

	Set @Msg = @MsgConst
	exec PrcSetProgrss @Msg, 100, 12

	
	--Customer 
	Select
		*
	into #Customer
	From
		vwCustomer
	where
		([Guid] = @CustGuid or @CustGuid = 0x0)
		
    
	Insert into @Tbl 
	Select 
		[L].[ContractNo]
		,[B].[Name] as [BuildingName]
		,[L].[Rent]
		,[L].[DiscountValue]
		,[L].[Rent] - [L].[DiscountValue]
		,Case when ([L].[ToDate] <= @Now_Date) or ([L].[ContractFinish] = 1) then dbo.sc(' ')  
			  when [L].[ToDate] > @Now_Date then dbo.sc('  ') end as [ContractState]
		,[B].[Emirate] as [Emirate]
		,[B].[Suburb] as [Suburb]
		,[B].[Area] as [Area]
		,[B].[Street] as [Street]
		,[Cu].[Name] as [CustName]
		,[Cu].[Mobile] as [CustPhone]
		,[Cu].Nationality
		,Cu.EMail as CustEMail
		,[L].[EditDate] as [ContractDateEdit]
		,[L].[FromDate] as [ContractDateBegin]
		,[L].[ToDate] as [ContractDateEnd]
		,[L].[ContractName]
		,[L].[ContractFinish]
		,[L].[Guid] as [ContractGuid]
		,[L].[NewState] 

		,[ContractFinishDate]
		,[ResultingAmount]
		,[ResultingAmount2]
		,[Note2] 
		,L.[Purpose]
		,L.Trademark
		,l.[CountOldContract]
		,l.AcquittancePrinted
		,L.AcquittancePrintDate
		,L.[AcquittancePrintedBy]
		,[L].[CostGuid]
		,L.[CustAccountGuid]
		,[L].[Mark]

		--,[PrvContractFinishDate]
		--,[PrvContractEndDate]

		,0 as [Kind]
		,0 as [Sort]
	from 
		#Building_CL [B]
		Inner join #ServicesContract_CL [L] On [B].[Guid] = [L].[BuildingGuid] 
		inner join [Resource] [R] on [R].[Guid] = [B].[Guid]  and [R].[Kind] = 101 and [R].[spid] = @@Spid 
		Inner join [#Customer] [Cu] on [Cu].[Guid] = [L].[CustomerGuid] 
		


	Set @Msg = @MsgConst +' '+ dbo.SC('')
	exec PrcSetProgrss @Msg, 100, 60

	Declare @PCheck Bit 
	Set @PCheck = 1	
	Declare @PNotCheck Bit 
	Set @PNotCheck = 0

	if @LinkCheck = 0 --  
	Delete @Tbl
	From
		@Tbl T
		inner join [Checks] C on C.ContractGuid = T.ContractGuid
	
	if @LinkCheck = 1 --  
	Delete @Tbl
	From
		@Tbl T
		left join [Checks] C on C.ContractGuid = T.ContractGuid
	where
		C.Guid is Null
		
	Set @Msg = @MsgConst +' '+ dbo.SC(' ')
	exec PrcSetProgrss @Msg, 100, 70

	-- 
	Create Table #Collection_CL
	(
		[ContractGuid] uniqueidentifier,
		[Total] Float,
		[Collection] Float
	)
	
	Select
		p.Guid as [CheckGuid],
		[P].[ContractGuid],
		IsNull([P].[Value] * [P].[CurrencyVal],0) as [checkValue]
	into #Collection_Contract_Checks
	From
		[vbChecks] [P]
		inner join @Tbl [t] on [t].[ContractGuid] = [P].[ContractGuid]

	Select
		[CC].[ContractGuid],
		Sum(IsNull([C1].[Value] * [C1].[CurrencyVal],0)) as [Collection]
	Into #Collection_Sum_CL
	From
		#Collection_Contract_Checks CC
		inner join [ChecksCollection] [C1] on [C1].[CheckGuid] = [CC].[CheckGuid] and [C1].[Kind] = 1
	Group By
		[CC].[ContractGuid]
		
	insert into #Collection_CL
	([ContractGuid] ,[Total],[Collection])
	Select
		[ContractGuid],
		Sum(IsNull([CC].[checkValue],0)) as [Total],
		0
	From
		#Collection_Contract_Checks CC
	Group by
		[ContractGuid]
		
	update #Collection_CL Set [Collection] = S.[Collection]
	From
		#Collection_CL C
		inner join #Collection_Sum_CL S on C.ContractGuid = S.ContractGuid

	Set @Msg = @MsgConst +' '+ dbo.SC(' ')
	exec PrcSetProgrss @Msg, 100, 75

	-- 
	Select
		[P].[ContractGuid],
		Sum(IsNull([P].[Value] * [P].[CurrencyVal],0)) as [Cash]
	Into #Cash
	From
		[vwContractCachPayment] [P]
		inner join @Tbl [t] on [t].[ContractGuid] = [P].[ContractGuid] and P.AcGuid = t.AccountGuid
	Group By
		[P].[ContractGuid]	

	Set @Msg = @MsgConst +' '+ dbo.SC(' ')
	exec PrcSetProgrss @Msg, 100, 80

	Select
		En.AcGuid,
		SUM(En.debit - en.Credit) as [Balance]
	into #CustBalance
	From
		(Select distinct AccountGuid from @Tbl ) T
		inner join DEntry En on En.AcGuid = T.AccountGuid
	Group By
		En.AcGuid

	
	
	Set @Msg = ''
	exec PrcSetProgrss @Msg, 100, 90

	Select 
		[E].*,
		
		Case when isnUll([ContractFinish],0) = 0 then dbo.sc('') else dbo.sc('') end As [ContractFinishStr],
		Case when isnUll([NewState],0) = 0 then dbo.sc('') 
			 when isnUll([NewState],0) = 1 then dbo.sc('') 
		else 
			''
		end As [NewStateStr],
		
		
		isNull([C].[Collection],0) as [Collection],
		isNull([C].[Total],0) - isNull([C].[Collection],0) as [CheckNotCollection],
		isNull([h].[Cash],0) as [Cash],
		IsNull([C].[Collection],0) + IsNull([h].[Cash],0) as [TotalPays],
		isNull(E.ValueAfterDiscount ,0) - IsNull([C].[Collection],0) - IsNull([h].[Cash],0) as [ContractRest],
		CAST(0 as Float) as [CustBalance],
				
		Case when [R].[ObjGuid] is null then @PNotCheck
			 when [R].[ObjGuid] is not null  then @PCheck end as [Check],
		1 as [DoOperation]
	into #ServicesContractList_4
	From
		@Tbl [E]
		left join #Collection_CL [C] on [E].[ContractGuid] = [C].[ContractGuid]
		left join #Cash [h] on [E].[ContractGuid] = [h].[ContractGuid]
		left join [RepCheck] [R] on [R].[ObjGuid] = [E].[ContractGuid] and [R].[IdReport] = 2000
	where
		(
			([R].[ObjGuid] is not null and @ShowIsCheck = 1)
			or
			([R].[ObjGuid] is null and @ShowIsNotCheck = 1)
		)
		and (Isnull([E].[NewState],0) = @NewState or @NewState = 2)
		
	Set @Msg = ''
	exec PrcSetProgrss @Msg, 100, 95
	
	update	
		#ServicesContractList_4
	set
		custBalance = C.Balance
	From
		#ServicesContractList_4 E
		inner join #CustBalance C on C.AcGuid = E.AccountGuid 
	
	Set @Msg = ''
	exec PrcSetProgrss @Msg, 0, 0
	
	Select
		*
	from
		#ServicesContractList_4
	Order By 
		[Sort],
		[BuildingName]
		
	
	Select
		SUM(Value) as [Value],
		SUM(ValueAfterDiscount) as ValueAfterDiscount,
		SUM(ResultingAmount) as ResultingAmount
	From
		#ServicesContractList_4
	where
		[Sort] = 0
		

GO

SET ANSI_NULLS, QUOTED_IDENTIFIER ON
GO
Create View vwBill
 
as
	Select
		[b].[Number] as [BuNumber], 		[b].[Guid] as [BuGuid], 		[b].[SecLvl] as [BuSecLvl], 		[b].[TypeGuid] as [BuTypeGuid], 		[b].[Date] as [BuDate], 		[b].[CustGuid] as [BuCustGuid], 		[b].[CurrencyGuid] as [BuCurrencyGuid], 		[b].[CurrencyVal] as [BuCurrencyVal], 		[b].[PayType] as [BuPayType],		Case when [b].[PayType] = 0 then '' 			 when [b].[PayType] = 1 then '' 		end as [BuPayTypeStr],		[b].[StoreGuid] as [BuStoreGuid], 		[b].[CustAccGuid] as [BuCustAccGuid], 		[b].[CostGuid] as [BuCostGuid], 		[b].[BranchGuid] as [BuBranchGuid], 		[b].[Class] as [BuClass], 		[b].[Note] as [BuNote], 		[b].[EntryGuid] as [BuEntryGuid], 		[b].[EntryNumber] as [BuEntryNumber], 		[b].[ItemsTotal] as [BuItemsTotal],		[b].[ItemsDiscount] as [BuItemsDiscount],		[b].[ItemsExtra] as [BuItemsExtra],		[b].[BuExtra],		[b].[BuDiscount],		[b].[ItemsTotal]  +	[b].[BuExtra] - [b].[BuDiscount] as [BuCleanValue],		[b].[BuOnly],		[b].[isPosted] as [BuisPosted],		[b].[CheckCreateEntry] as [BuCheckCreateEntry],
		Case when b.isPosted = 0 then dbo.SC(' ')
			 when b.isPosted = 1 then dbo.SC('')
		end as [BillPost],
		
		[b].[AddFld1],
		[b].[AddFld2],
		[b].[AddFld3],
		[b].[AddFld4],
		[b].[AddFld5],
		[b].[AddFld6],
		[b].[AddFld7],
		[b].[AddFld8],
		
		[t].[Number] as [BtNumber], 		[t].[Guid] as [BtGuid], 		[t].[SecLvl] as [BtSecLvl], 		[t].[Code] as [BtCode], 		[t].[Name] as [BtName], 		[t].[LtnName] as [BtLtnName], 		[t].[BillKind] as [BtBillKind], 		Case when [t].[BillKind] in (0, 3, 4) then 1			 when [t].[BillKind] in (1, 2, 5) then -1		end as [BtInOut],		[t].[Menu] as [BtMenu], 		[t].[LtnMenu] as [BtLtnMenu], 		[t].[ShortCut] as [BtShortCut], 		[t].[DefPrintPath] as [BtDefPrintPath], 		[t].[Note] as [BtNote], 		[t].[Color1] as [BtColor1], 		[t].[Color2] as [BtColor2], 		[t].[DefCashAccountGuid] as [BtDefCashAccountGuid], 		[t].[DefCostGuid] as [BtDefCostGuid], 		[t].[DefStoreGuid] as [BtDefStoreGuid], 		[t].[DefDiscountAccountGuid] as [BtDefDiscountAccountGuid], 		[t].[DefExtraAccountGuid] as [BtDefExtraAccountGuid], 		[t].[PostToStores] as [BtPostToStores], 		[t].[PostToStoresAuto] as [BtPostToStoresAuto], 		[t].[EntryCreated] as [BtEntryCreated], 		[t].[EntryCreatedAuto] as [BtEntryCreatedAuto], 		[t].[AutoPostedEntry] as [BtAutoPostedEntry], 		[t].[DefMatAccountGuid] as [BtDefMatAccountGuid],
		[t].[PriceEffected] as [btPriceEffected],
		
		[c].[CardKind] as [CuCardKind], 		[c].[Number] as [CuNumber], 		[c].[Guid] as [CuGuid], 		[c].[ArName] as [CuArName], 		[c].[LtnName] as [CuLtnName], 		[c].[Name] as [CuName], 		[c].[Nationality] as [CuNationality], 		[c].[Profession] as [CuProfession], 		[c].[PassportNO] as [CuPassportNO], 		[c].[Domicile] as [CuDomicile], 		[c].[Security] as [CuSecurity], 		[c].[MemoSecurity] as [CuMemoSecurity], 		[c].[PhoneJob] as [CuPhoneJob], 		[c].[Mobile] as [CuMobile], 		[c].[Note] as [CuNote], 		[c].[AcGuid] as [CuAcGuid], 		[c].[Address] as [CuAddress], 		[c].[BoxNo] as [CuBoxNo], 		[c].[InsuranceAccountGuid] as [CuInsuranceAccountGuid], 		[c].[PersonalityNo1] as [CuPersonalityNo1], 		[c].[PersonalityNo2] as [CuPersonalityNo2], 		[c].[Adjective] as [CuAdjective], 		[c].[Fax] as [CuFax], 		[c].[EMail] as [CuEMail], 		[c].[Ban] as [CuBan], 		[c].[PassportExpireDate] as [CuPassportExpireDate], 		[c].[BankName] as [CuBankName], 		[c].[BankAccCode] as [CuBankAccCode],
		
		[m].[Code] as [MyCode], 		[m].[LtnCode] as [MyLtnCode], 		[m].[Name] as [MyName], 		[m].[LtnName] as [MyLtnName], 		[m].[CurrencyVal] as [MyCurrencyVal], 		
		[Ac].[Code] as [AcCode], 		[Ac].[LtnName] as [AcLtnName], 		[Ac].[ArName] as [AcArName], 		[Ac].[Name] as [AcName], 		[St].[Code] as [StCode], 		[St].[Name] as [StName], 		[St].[LtnName] as [StLtnName], 		
		[Co].[Code] as [CoCode], 		[Co].[Name] as [CoName], 		[Co].[LtnName] as [CoLtnName],		B.[entryGuid],		B.[ContractGuid]
	From
		[vbBill] [B]
		inner join BillType [t] on [t].Guid = [b].TypeGuid
		left join vwCustomer [C] on [C].Guid = [b].CustGuid
		left join Currency [m] on [m].Guid = [b].CurrencyGuid
		inner join vwStore [st] on [st].Guid = [b].StoreGuid
		left join vwAccount [Ac] on [Ac].Guid = [b].CustAccGuid
		left join vwCost [Co] on [b].Guid = [b].CostGuid
		left join Branch [br] on [br].Guid = [b].BranchGuid

GO

SET ANSI_NULLS, QUOTED_IDENTIFIER ON
GO

Create Procedure [PrcPrintReceiptContract]
(
	@Guid uniqueidentifier = '44BAA61B-A0A7-43B5-B07B-299242BD419B',
	@Only Varchar(256) = '',
	@OnlyAr Varchar(256) = '',
	@OnlyEn Varchar(256) = '',	
	@OnlySumCheckAr Varchar(256) = '',	
	@OnlySumChecken Varchar(256) = '',	
	@OnlySumCashAr Varchar(256) = '',	
    @OnlySumCashEn Varchar(256) = '',
    @PrintCheckEnryOnly bit = 0
	
)
 
as
	Set NoCount On
	
	--  
	Declare @SumCheck Float, @SumCach Float, @SumPay Float
	
	Select
		@SumCheck = Sum([Value])
	From
		[LinkCheckContract] [C]
		inner join (Select Distinct Guid From [Resource] where [Spid] = @@Spid) [R] on [R].[Guid] = [C].ParentGuid
	where
		[ContractGuid] = @Guid

	Select
		@SumCach = isnull(Sum([Value] * [CurrencyVal]),0)
	From
		[vwContractCachPayment] [C]
		inner join (Select Distinct Guid From [Resource] where [Spid] = @@Spid) [R] on [R].[Guid] = [C].[Guid]
	where
		[ContractGuid] = @Guid

	Set @SumPay = ISNULL(@SumCheck,0) + ISNULL(@SumCach,0)

	if @PrintCheckEnryOnly = 0
	begin
		
		/*
		Select 
			@SumPay = @SumPay + IsNull(OtherFee,0) + IsNull(InsuranceValue,0) + IsNull(CertificatValue,0)
		From
			[vwLeaseApartment]
		where 
			([Guid] = @Guid or @Guid = 0x0)		
		*/
		
		Select
			[A].[Number],
			[A].[ContractNo],
			
			[A].[CustName],
			[A].[CustArName],
			[A].[CustLtnName],
			[A].[CustomerPhonejob],
			[A].[CustomerMobile],
			[A].[CustomerNationality],
			
			[cu].[Barcode] as [Cust_Barcode], 			[cu].[Name] as [Cust_Name], 			[cu].[LtnName] as [Cust_LtnName], 			[cu].[CardKind] as [Cust_CardKind], 			[cu].[CardKind2] as [Cust_CardKind2], 			[cu].[Nationality] as [Cust_Nationality], 			[cu].[LtnNationality] as [Cust_LtnNationality], 			[cu].[Profession] as [Cust_Profession], 			[cu].[LtnProfession] as [Cust_LtnProfession], 			[cu].[PassportNO] as [Cust_PassportNO], 			[cu].[PassportExpireDate] as [Cust_PassportExpireDate], 			[cu].[Domicile] as [Cust_Domicile], 			[cu].[Security] as [Cust_Security], 			[cu].[LtnSecurity] as [Cust_LtnSecurity], 			[cu].[PhoneJob] as [Cust_PhoneJob], 			[cu].[Mobile] as [Cust_Mobile], 			[cu].[Note] as [Cust_Note], 			[cu].[Trademark] as [Cust_Trademark], 			[cu].[LtnTrademark] as [Cust_LtnTrademark], 			[cu].[MemoSecurity] as [Cust_MemoSecurity], 			[cu].[LtnMemoSecurity] as [Cust_LtnMemoSecurity], 			[cu].[Address] as [Cust_Address], 			[cu].[LtnAddress] as [Cust_LtnAddress], 			[cu].[BoxNo] as [Cust_BoxNo], 			[cu].[PersonalityNo1] as [Cust_PersonalityNo1], 			[cu].[PersonalityNo2] as [Cust_PersonalityNo2], 			[cu].[Fax] as [Cust_Fax], 			[cu].[EMail] as [Cust_EMail], 			[cu].[Adjective] as [Cust_Adjective], 			[cu].[LtnAdjective] as [Cust_LtnAdjective], 			[cu].[CkHideInSearch] as [Cust_CkHideInSearch], 			[cu].[ban] as [Cust_ban], 			[cu].[BankName] as [Cust_BankName], 			[cu].[BankAccCode] as [Cust_BankAccCode], 			[cu].[Birthday] as [Cust_Birthday], 			[cu].[DomicileEndDate] as [Cust_DomicileEndDate], 			[cu].[PersonalityEndDate] as [Cust_PersonalityEndDate], 			[cu].[CustNote1] as [Cust_CustNote1], 			[cu].[CustNote2] as [Cust_CustNote2], 			[cu].[CustNote3] as [Cust_CustNote3], 			[cu].[CustNote4] as [Cust_CustNote4], 			[cu].[CustNote5] as [Cust_CustNote5], 			[cu].[CustNote6] as [Cust_CustNote6], 			[cu].[CustNote7] as [Cust_CustNote7], 			[cu].[banContract] as [Cust_banContract], 
			A.accountbalance,
			
			@SumCheck as [SumCheck],
			@SumCach as [SumCach],
			@SumPay as [SumPay], 
			@Only as [OnlySumCheck], 
			@OnlyAr as [OnlySumCheckAr], 
			@OnlyEn as [OnlySumCheckEn], 

			@OnlySumCheckAr as OnlySumCheckAr,
			@OnlySumChecken as OnlySumChecken,
			@OnlySumCashAr as OnlySumCashAr,
			@OnlySumCashEn AS OnlySumCashEn,

			[A].[EditDate],
			[A].[FromDate],
			[A].[ToDate],
			A.ContractDays,
			A.ContractDaysDifference,
			[A].[BuildingName],
			[A].[BuildingArName],
			[A].[BuildingLtnName],
			[A].[FlatNo],
			[A].[Note2],

			[A].[Rent] as [ContractValue],

			[A].[DiscountPercent],
			[A].[DiscountValue],
			[A].[Rent] - [A].[DiscountValue] as [RentAfterDiscount],	

			[A].[MonthlyValue] ,
			[A].[MonthlyValue] * 12.00 as [YearValue],
			[A].[CurrencyName],
			[A].[DiscountPercent],
			[A].[DiscountValue],
			[A].[InsuranceValueOld],
			[A].[InsuranceValue],
			[A].[InsuranceValuePercent],
			[A].[CommissionFromCustValue],
			[A].[CommissionFromOwnerValue],
			[A].[ElectricityInsurance],
			[A].[ElectricityCounter],
			[A].[ContractPrice],
			[A].[CertificatValue],
			[A].[OtherFee],
			[A].[FlatKind],--  
			[A].[ApartmentType], --
			[A].[NewStateStr], --  
			Case when isnull([A].FlatOwner,0) = 0 then dbo.sc('') else dbo.sc(' ') end as [FlatOwnerStr],
			A.Purpose,
			A.ResidentCount,
			A.Trademark,
			A.whereabouts,
			A.RentDuration,
			A.LtnRentDuration,
			A.Rentype,
			A.LtnRentype,
			A.TermsOfPayment,
			A.LtnTermsOfPayment,
			
			Case when isnull([A].NewState,0) = 0 then dbo.sc('') else dbo.sc('') end as [NewSate],
			Case when isnull([A].NewState,0) = 0 then '' else '' end as [ArNewSate],
			Case when isnull([A].NewState,0) = 0 then 'New' else 'Renewal' end as [LtnNewSate],
			S.Name as [SalesMan]
		From 
			[vwLeaseApartment] A
			left join Salesman S on S.Guid = [A].[SalesManGuid]
			inner join Customer Cu on Cu.Guid = A.CustomerGuid
		where 
			([A].[Guid] = @Guid or @Guid = 0x0)
	end

	Create Table [#Tbl]
	(
		[Number] int,
		[BankName] Varchar(256),
		[Value] Float,
		[Currency] Varchar(256),
		[No]  Varchar(256),
		[EditDate] DateTime,
		[DueDate] DateTime,
		[State] Varchar(256),
		[Note3] Varchar(256),
		[Note] Varchar(256)
	)

	Insert Into [#Tbl]
	Select
		P.Number,
		[BankName],
		[LL].[Value] as [Value],
		[CurrencyName]  as [Currency],
		[No],
		P.Date as [EditDate],
		[DueDate],
		Case 		
			when  [C3].[CheckGuid] is not null then dbo.SC('')
			when  [C1].[CheckGuid] is not null then dbo.SC('') 
			when  [C4].[CheckGuid] is not null then dbo.SC(' ') 
			when  [C].[CheckGuid] is not null then dbo.SC('') 
			when  [C2].[CheckGuid] is not null then dbo.SC('') 
		end as [State],
		[P].[Note3],
		[P].[Note]
	From
		[vwChecks] [P]
		inner join [LinkCheckContract] LL on LL.ParentGuid = P.Guid
 		left join [vwChecksCollection] [C] on [C].[CheckGuid] = [P].[Guid] and [C].[Kind] = 0
 		left join [vwChecksCollection] [C1] on [C1].[CheckGuid] = [P].[Guid] and [C1].[Kind] = 1
 		left join [vwChecksCollection] [C2] on [C2].[CheckGuid] = [P].[Guid] and [C2].[Kind] = 2
 		left join [vwChecksCollection] [C3] on [C3].[CheckGuid] = [P].[Guid] and [C3].[Kind] = 3
 		left join [ChecksPartialCollection]  [C4] on [C4].[CheckGuid] = [P].[Guid] and [C3].[Kind] = 3
		inner join (Select Distinct Guid From [Resource] where [Spid] = @@Spid) [R] on [R].[Guid] = [P].[Guid]
	where
		LL.[ContractGuid] = @Guid


	Select * from [#Tbl]
	Order By
		[DueDate], [No]

	Select
		C.Number,
		C.[RecieptVoucherNumber],
		C.SNumber,
		dbo.sc('') as [BankName],
		[Value]  as [Value],
		[Currency]  as [Currency],
		'' as [No],
		[Date],
		'' as State,
		[C].[HNote],
		[C].[DNote]
	From
		[vwContractCachPayment] [C]
		inner join (Select Distinct Guid From [Resource] where [Spid] = @@Spid) [R] on [R].[Guid] = [C].[Guid] 
	where
		[ContractGuid] = @Guid
	Order By
		[Number],[DNumber]


GO

SET ANSI_NULLS, QUOTED_IDENTIFIER ON
GO

Create Procedure [PrcCreateContractFlatShopEntry]
(	
	@ContractGuid uniqueidentifier = '9D865944-064A-4D89-8C95-5927CCB15E56',
	@MaxDate Datetime = 43098
)
 
AS
	Set NoCount on 
	
	Declare 
			@EnNum int,
			@EnGuid [uniqueidentifier]

	--  
	Select 
		@EnNum = isnull([Number],0)
		,@EnGuid = isnull([Guid],0x0)
	From
		[HEntry]
	where
		[Guid] = @ContractGuid

	if isnull(@EnNum,0) = 0
	begin	
		Select @EnNum = IsNull(Max([Number]),0) + 1 from [HEntry]
	END
	
	if isnull(@EnGuid,0x0) = 0x0
	Set @EnGuid = @ContractGuid

	if Exists(Select Number From HEntry where Number = @EnNum and [Guid] <> @EnGuid)
	Select @EnNum = IsNull(Max([Number]),0) + 1 from [HEntry]

	--   
	Delete
		[DEntry]
	where
		[ParentGuid] = @EnGuid

	Delete
		[HEntry]
	where
		[Guid] = @EnGuid

		
	--return
	DECLARE 
		@FlatNo Varchar(256),
		@FlatOwner int,
		@EntryDate Datetime,
		@CreateEntry bit,
		@MoveCost bit,
		@MoveCostCredit bit,
		@MoveCostWithIncom bit,
		@MoveCostWithInconEndContract bit,
		@MoveCostWithFineEndContract bit,
		@MoveCostWithInsurance bit,
		@MoveCostWithContractPrice bit,
		@MoveCostWithCertificat bit,
		@MoveCostWithFee bit,
		@MoveCostWithclientComm bit,
		@MoveCostWithOwnerComm bit,
		@MoveCostWithDiscount bit,
		@MoveCostWithDiscountCredit bit,
		@MoveCostWithIncomCredit bit,
		@MoveCostWithInconEndContractCredit bit,
		@MoveCostWithFineEndContractCredit bit,
		@MoveCostWithInsuranceCredit bit,
		@MoveCostWithContractPriceCredit bit,
		@MoveCostWithCertificatCredit bit,
		@MoveCostWithFeeCredit bit,
		@MoveCostWithclientCommCredit bit,
		@MoveCostWithOwnerCommCredit bit,
		@SecLvl int,
		@CurrencyGuid uniqueidentifier,
		@CurrencyVal Float,
		@TypeName varchar(256),
		@ContractNumber int,
		@Note2 varchar(256),
		@LeaseKind int,
		@AutoPostedEntry bit,
		@Mark bit,
		@RealtyGuid uniqueidentifier,
		@BuildingGuid uniqueidentifier,
		@EntryNote Varchar(255),
		@DetailNum Int,
		@Rent Float,
		@CostGuid  uniqueidentifier,
		@CustGuid uniqueidentifier,
		@CustAccountGuid uniqueidentifier,
		@RevenueAccountGuid uniqueidentifier,
		@CommissionFromCustValue Float,
		@AcCommissionFromCustGuid uniqueidentifier,
		@AcCommissionFromCustNote varchar(256),
		@AcCustOwnerGuid uniqueidentifier,
		@CommissionFromOwnerValue Float,
		@AcCommissionFromOwnerGuid uniqueidentifier,
		@AcCommissionFromOwnerNote varchar(256),
		@UnearnedrRevenue bit,
		@Fromdate datetime,
		@Todate datetime,
		@AcIncomNextYearGuid uniqueidentifier,
		@InsuranceValue Float,
		@InsuranceAccountGuid uniqueidentifier,
		@CertificatValue Float,
		@AccountCertificatValueGuid uniqueidentifier,
		@OtherFeeAccountGuid uniqueidentifier,
		@OtherFee Float,
		@ContractPrice Float,
		@AccountContractPriceGuid uniqueidentifier,
		@DiscountValue fLoat,
		@DiscountAccountGuid uniqueidentifier,
		@BranchGuid uniqueidentifier,
		
		@CommissionFromSalesManrPercent fLoat,
		@CommissionFromSalesManValue fLoat,
		@AcSalesManCommissionGuid uniqueidentifier,
		@AcCommissionExpenseGuid uniqueidentifier,
		@SalesManCommNote varchar(255)
		
	
	SELECT	TOP 1
		@FlatNo = C.FlatNo,
		@FlatOwner = isNull(C.FlatOwner, -1),
		@EntryDate = Case when T.EntryDate = 0 then C.FromDate else C.EditDate end,
		@AutoPostedEntry = T.AutoPostedEntry,
		@CreateEntry = T.CreateEntry,
		@MoveCost = T.MoveCost,
		@MoveCostCredit = T.MoveCostCredit,

		@MoveCostWithIncom = T.MoveCostWithIncom,
		@MoveCostWithInconEndContract = T.MoveCostWithInconEndContract,
		@MoveCostWithFineEndContract = T.MoveCostWithFineEndContract,
		@MoveCostWithInsurance = T.MoveCostWithInsurance,
		@MoveCostWithContractPrice = T.MoveCostWithContractPrice,
		@MoveCostWithCertificat = T.MoveCostWithCertificat,
		@MoveCostWithFee = T.MoveCostWithFee,
		@MoveCostWithclientComm = T.MoveCostWithclientComm,
		@MoveCostWithOwnerComm = T.MoveCostWithOwnerComm,

		@MoveCostWithDiscount = T.MoveCostWithDiscount,
		@MoveCostWithDiscountCredit = T.MoveCostWithDiscountCredit,

		@MoveCostWithIncomCredit = T.MoveCostWithIncomCredit,
		@MoveCostWithInconEndContractCredit = T.MoveCostWithInconEndContractCredit,
		@MoveCostWithFineEndContractCredit = T.MoveCostWithFineEndContractCredit,
		@MoveCostWithInsuranceCredit = T.MoveCostWithInsuranceCredit,
		@MoveCostWithContractPriceCredit = T.MoveCostWithContractPriceCredit,
		@MoveCostWithCertificatCredit = T.MoveCostWithCertificatCredit,
		@MoveCostWithFeeCredit = T.MoveCostWithFeeCredit,
		@MoveCostWithclientCommCredit = T.MoveCostWithclientCommCredit,
		@MoveCostWithOwnerCommCredit = T.MoveCostWithOwnerCommCredit,
		@SecLvl = C.SecLvl,
		@CurrencyGuid = C.CurrencyGuid,
		@CurrencyVal = C.CurrencyVal,
		@TypeName = T.Name,
		@ContractNumber = C.Number ,
		@Note2 = C.Note2,
		@LeaseKind = C.Leasekind,
		@AutoPostedEntry = T.AutoPostedEntry,
		@Mark = C.Mark,
		@RealtyGuid =C.ApartmentGuid,
		@BuildingGuid = C.BuildingGuid,
		@Rent = C.Rent,
		@CostGuid = C.CostGuid,
		@CustGuid = C.CustomerGuid,
		@CustAccountGuid = C.CustAccountGuid,
		@RevenueAccountGuid = C.RevenueAccountGuid,
		@CommissionFromCustValue = C.CommissionFromCustValue,
		@AcCommissionFromCustGuid = C.AcCommissionFromCustGuid,
		@AcCommissionFromCustNote = C.AcCommissionFromCustNote,
		@CommissionFromOwnerValue = C.CommissionFromOwnerValue,
		@AcCommissionFromOwnerGuid = C.AcCommissionFromOwnerGuid ,
		@AcCommissionFromOwnerNote = C.AcCommissionFromOwnerNote,
		@UnearnedrRevenue = Case when (T.UnearnedrRevenue = 1) and (C.Todate > @MaxDate) then 1 else 0 end,
		@Fromdate = C.FromDate,
		@Todate = C.ToDate,
		@AcIncomNextYearGuid = C.AcIncomNextYearGuid,
		@InsuranceValue = C.InsuranceValue,
		@InsuranceAccountGuid = C.InsuranceAccountGuid,
		@CertificatValue = C.CertificatValue,
		@AccountCertificatValueGuid = C.AccountCertificatValue,
		@OtherFee = C.OtherFee,
		@OtherFeeAccountGuid = C.OtherFeeAccountGUID,

		@ContractPrice = C.ContractPrice,
		@AccountContractPriceGuid = C.AccountContractPrice,
		@DiscountValue = C.DiscountValue,
		@DiscountAccountGuid = C.DiscountAccountGuid,
		@BranchGuid = C.BranchGuid,
		@EntryNote = [T].[ContractNote],

		@CommissionFromSalesManrPercent = C.[CommissionFromSalesManrPercent],
		@CommissionFromSalesManValue = C.CommissionFromSalesManValue,
		@AcSalesManCommissionGuid = C.AcSalesManCommissionGuid,
		@AcCommissionExpenseGuid = C.AcCommissionExpenseGuid,
		@SalesManCommNote = C.SalesManCommNote

	FROM
		[vwLeaseApartment]  C
		inner join [vwContractType] T on T.Guid = C.TypeGuid
	WHERE
		C.Guid = @ContractGuid

	
	Select 
		@EntryNote  =				REPLACE(REPLACE(REPLACE(REPLACE(REPLACE(REPLACE(
									REPLACE(REPLACE(REPLACE(REPLACE(REPLACE(REPLACE(
									@EntryNote, '[N]', TypeNameAr),
									'[M]', TypeNameLtn),
									'[A]', CustArName),
									'[B]', CustltnName),
									'[C]', FlatNo),
									'[D]', BuildingArName),
									'[E]', BuildingLtnName),
									'[F]', dbo.fndate(EditDate)),
									'[G]', dbo.fndate(Fromdate)),
									'[H]', dbo.fndate(Todate)),
									'[K]', ContractNo),
									'[L]', Cast(Value as varchar(50)))
									
	from 
		[vwAllContract]
	where
		Guid = @ContractGuid
	
		
	--Set @EntryNote = @TypeName +' '+dbo.sc(' ')+' '+CAST( @ContractNumber as varchar(255)) +' '+dbo.sc(' ')+' '+@FlatNo +' '+@Note2
	--
	
	if (@LeaseKind = 0) or (@LeaseKind = 2)
	begin
		Select
			@AcCustOwnerGuid = [Cu].[AcGuid]
		from
			Apartment P
			inner join [Customer] [Cu] on [P].[CustOwnerGuid] = [Cu].[Guid]
		where
			[P].[Guid] = @RealtyGuid 

		if ISNULL(@AcCustOwnerGuid,0x0) = 0x0
		Select
			@AcCustOwnerGuid = [Cu].[AcGuid]
		from
			vwApartment P
			inner join [Customer] [Cu] on [P].[BuildingOwnerName] = [Cu].[Guid]
		where
			[P].[Guid] = @RealtyGuid 
	end
		
	if (@LeaseKind = 1) or (@LeaseKind = 3)
	begin

		Select
			@AcCustOwnerGuid = [Cu].[AcGuid]
		from
			Shop P
			inner join [Customer] [Cu] on [P].CustGuid = [Cu].[Guid]
		where
			[P].[Guid] = @RealtyGuid 

		if ISNULL(@AcCustOwnerGuid,0x0) = 0x0
		select
			@AcCustOwnerGuid = [Cu].[AcGuid]
		from
			vwShop P
			inner join [Customer] [Cu] on [P].[BuildingOwnerName] = [Cu].[Guid]
		where
			[P].[Guid] = @RealtyGuid 
	end

	if (@FlatOwner = 0 or @FlatOwner = -1)
	begin
		
		if (@LeaseKind = 2 or @LeaseKind = 3) --   
		begin
				Insert Into [HEntry]
				([Guid],[SecLvl],[Number],[Date], [CurrencyGuid], [CurrencyVal], [Note], [ParentKind], [BranchGuid], [IsPosted], Mark)
				Select
					@EnGuid,
					@SecLvl,
					@EnNum,
					@EntryDate,
					@CurrencyGuid,
					@CurrencyVal,
					@EntryNote as [Note],
					1000+@LeaseKind as [ParentKind], 
					@BranchGuid as [BranchGuid], 
					@AutoPostedEntry as [IsPosted],
					@Mark
					
				Set @DetailNum = 0
				
				if Not Exists(Select Top 1 * from [ContractAccountDetail] where ParentGuid = @ContractGuid)
				begin
					Insert into [DEntry]
		 			([ParentGuid],[Number],[AcGuid],[Debit],[Credit],[CurrencyGuid],[CurrencyVal],[CostGuid],[ObverseAcGuid],[Note])
					Select
						@EnGuid,
						@DetailNum,
						@CustAccountGuid,
						@Rent as Debit,
						0 as Credit,
						@CurrencyGuid,
						@CurrencyVal,
						Case when @MoveCost = 1 then @CostGuid end,
						Null as [ObverseAcGuid],
						@EntryNote
				end
				else
				begin
					Select @CustAccountGuid = AcGuid From Customer Cu where Cu.Guid = @CustGuid
					
					Insert into [DEntry]
		 			([ParentGuid],[Number],[AcGuid],[Debit],[Credit],[CurrencyGuid],[CurrencyVal],[CostGuid],[ObverseAcGuid],[Note])
					Select
						@EnGuid,
						@DetailNum,
						D.AccountGuid,
						D.value as Debit,
						0 as Credit,
						@CurrencyGuid,
						@CurrencyVal,
						Case when @MoveCost = 1 then @CostGuid end,
						Null as [ObverseAcGuid],
						@EntryNote
					from
						[ContractAccountDetail] D
					where 
						ParentGuid = @ContractGuid
				end

				-- 
				Declare @CostPrice Float
				
				if @LeaseKind = 0 or @LeaseKind = 2
				Select	@CostPrice = CostPrice	From Apartment where Guid = @RealtyGuid
				if @LeaseKind = 1 or @LeaseKind = 3
				Select	@CostPrice = CostPrice	From Shop where Guid = @RealtyGuid
				
				if @CostPrice > 0
				begin
					Declare @BuildingAcGuid uniqueidentifier
					Select @BuildingAcGuid = BuildingAccountGuid From Building where Guid = @BuildingGuid
					
					if IsNull(@BuildingAcGuid,0x0) <> 0x0
					begin
						Set @DetailNum = @DetailNum + 1
						Insert into [DEntry]
		 				([ParentGuid],[Number],[AcGuid],[Debit],[Credit],[CurrencyGuid],[CurrencyVal],[CostGuid],[ObverseAcGuid],[Note])
						Select
							@EnGuid,
							@DetailNum,
							@BuildingAcGuid,
							0 as Debit,
							@CostPrice as Credit,
							@CurrencyGuid,
							@CurrencyVal,
							Case when @MoveCost = 1 then @CostGuid end,
							Null as [ObverseAcGuid],
							@EntryNote
					end
				end
				
				if @CostPrice <= @Rent
				begin
						Set @DetailNum = @DetailNum + 1
						Insert into [DEntry]
		 				([ParentGuid],[Number],[AcGuid],[Debit],[Credit],[CurrencyGuid],[CurrencyVal],[CostGuid],[ObverseAcGuid],[Note])
						Select
							@EnGuid,
							@DetailNum,
							@RevenueAccountGuid,
							0 as Debit,
							@Rent - @CostPrice as Credit,
							@CurrencyGuid,
							@CurrencyVal,
							Case when @MoveCostWithIncomCredit = 1 then @CostGuid end,
							@CustAccountGuid as [ObverseAcGuid],
							@EntryNote
				end

				if @CostPrice > @Rent
				begin
						Set @DetailNum = @DetailNum + 1
						Insert into [DEntry]
		 				([ParentGuid],[Number],[AcGuid],[Debit],[Credit],[CurrencyGuid],[CurrencyVal],[CostGuid],[ObverseAcGuid],[Note])
						Select
							@EnGuid,
							@DetailNum,
							@RevenueAccountGuid,
							@CostPrice - @Rent as Debit,
							0 as Credit,
							@CurrencyGuid,
							@CurrencyVal,
							Case when @MoveCostWithIncom = 1 then @CostGuid end,
							@CustAccountGuid as [ObverseAcGuid],
							@EntryNote
				end
				
				if @CommissionFromCustValue > 0
				begin
						Set @DetailNum = @DetailNum + 1
						Insert into [DEntry]
		 				([ParentGuid],[Number],[AcGuid],[Debit],[Credit],[CurrencyGuid],[CurrencyVal],[CostGuid],[ObverseAcGuid],[Note])
						Select
							@EnGuid,
							@DetailNum,
							@CustAccountGuid,
							@CommissionFromCustValue as Debit,
							0 as Credit,
							@CurrencyGuid,
							@CurrencyVal,
							Case when @MoveCost = 1 then @CostGuid end,
							@AcCommissionFromCustGuid as [ObverseAcGuid],
							Case when @AcCommissionFromCustNote <> '' then @AcCommissionFromCustNote else @EntryNote end

						Set @DetailNum = @DetailNum + 1
						Insert into [DEntry]
		 				([ParentGuid],[Number],[AcGuid],[Debit],[Credit],[CurrencyGuid],[CurrencyVal],[CostGuid],[ObverseAcGuid],[Note])
						Select
							@EnGuid,
							@DetailNum,
							@AcCommissionFromCustGuid,
							0 as Debit,
							@CommissionFromCustValue as Credit,
							@CurrencyGuid,
							@CurrencyVal,
							Case when @MoveCostWithclientCommCredit = 1 then @CostGuid end,
							@CustAccountGuid as [ObverseAcGuid],
							Case when @AcCommissionFromCustNote <> '' then @AcCommissionFromCustNote else @EntryNote end
				end
				
				if @CommissionFromOwnerValue > 0
				begin

						Set @DetailNum = @DetailNum + 1
						Insert into [DEntry]
		 				([ParentGuid],[Number],[AcGuid],[Debit],[Credit],[CurrencyGuid],[CurrencyVal],[CostGuid],[ObverseAcGuid],[Note])
						Select
							@EnGuid,
							@DetailNum,
							@AcCustOwnerGuid,
							@CommissionFromOwnerValue as Debit,
							0 as Credit,
							@CurrencyGuid,
							@CurrencyVal,
							Case when @MoveCostWithOwnerComm = 1 then @CostGuid end,
							@AcCommissionFromOwnerGuid as [ObverseAcGuid],
							@EntryNote

						Set @DetailNum = @DetailNum + 1
						Insert into [DEntry]
		 				([ParentGuid],[Number],[AcGuid],[Debit],[Credit],[CurrencyGuid],[CurrencyVal],[CostGuid],[ObverseAcGuid],[Note])
						Select
							@EnGuid,
							@DetailNum,
							@AcCommissionFromOwnerGuid,
							0 as Debit,
							@CommissionFromOwnerValue as Credit,
							@CurrencyGuid,
							@CurrencyVal,
							Case when @MoveCostWithclientCommCredit = 1 then @CostGuid end,
							@AcCustOwnerGuid as [ObverseAcGuid],
							Case when @AcCommissionFromOwnerNote <> '' then @AcCommissionFromOwnerNote else @EntryNote end
							
				end
				
				if @CommissionFromSalesManValue > 0
				begin
						Set @DetailNum = @DetailNum + 1
						Insert into [DEntry]
		 				([ParentGuid],[Number],[AcGuid],[Debit],[Credit],[CurrencyGuid],[CurrencyVal],[CostGuid],[ObverseAcGuid],[Note])
						Select
							@EnGuid,
							@DetailNum,
							@AcCommissionExpenseGuid,
							@CommissionFromSalesManValue as Debit,
							0 as Credit,
							@CurrencyGuid,
							@CurrencyVal,
							Case when @MoveCost = 1 then @CostGuid end,
							@AcSalesManCommissionGuid as [ObverseAcGuid],
							Case when @SalesManCommNote <> '' then @SalesManCommNote else @EntryNote end

						Set @DetailNum = @DetailNum + 1
						Insert into [DEntry]
		 				([ParentGuid],[Number],[AcGuid],[Debit],[Credit],[CurrencyGuid],[CurrencyVal],[CostGuid],[ObverseAcGuid],[Note])
						Select
							@EnGuid,
							@DetailNum,
							@AcSalesManCommissionGuid,
							0 as Debit,
							@CommissionFromSalesManValue as Credit,
							@CurrencyGuid,
							@CurrencyVal,
							Case when @MoveCostWithclientCommCredit = 1 then @CostGuid end,
							@AcCommissionExpenseGuid as [ObverseAcGuid],
							Case when @SalesManCommNote <> '' then @SalesManCommNote else @EntryNote end
				end
				
		end			
		
		if (@LeaseKind = 0) or (@LeaseKind = 1)
		begin			
				
				Insert Into [HEntry]
				([Guid],[SecLvl],[Number],[Date], [CurrencyGuid], [CurrencyVal], [Note], [ParentKind], [BranchGuid], [IsPosted], Mark)
				Select
					@EnGuid,
					@SecLvl,
					@EnNum,
					@EntryDate,
					@CurrencyGuid,
					@CurrencyVal,
					@EntryNote as [Note],
					1000+@LeaseKind as [ParentKind], 
					@BranchGuid as [BranchGuid], 
					@AutoPostedEntry as [IsPosted],
					@Mark
			
				Set @DetailNum = 0
				
				if @Rent <> 0
				begin
						if Not Exists(Select Top 1 * from [ContractAccountDetail] where ParentGuid = @ContractGuid)
						begin
							Insert into [DEntry]
		 					([ParentGuid],[Number],[AcGuid],[Debit],[Credit],[CurrencyGuid],[CurrencyVal],[CostGuid],[ObverseAcGuid],[Note])
							Select
								@EnGuid,
								@DetailNum,
								@CustAccountGuid as [AccountGuid],
								Case when @UnearnedrRevenue = 0 then @Rent else (@Rent - @DiscountValue) end as Debit,
								0 as Credit,
								@CurrencyGuid,
								@CurrencyVal,
								Case when @MoveCost = 1 then @CostGuid end,
								@RevenueAccountGuid as [ObverseAcGuid],
								@EntryNote as [Note]
								
								--Select * from [DEntry] where ParentGuid = @EnGuid
						end
						else
						begin
							Select @CustAccountGuid = AcGuid From Customer Cu where Cu.Guid = @CustGuid
							
							Insert into [DEntry]
		 					([ParentGuid],[Number],[AcGuid],[Debit],[Credit],[CurrencyGuid],[CurrencyVal],[CostGuid],[ObverseAcGuid],[Note])
							Select
								@EnGuid,
								@DetailNum,
								D.AccountGuid as [AccountGuid],
								D.value as Debit,
								0 as Credit,
								@CurrencyGuid,
								@CurrencyVal,
								Case when @MoveCost = 1 then @CostGuid end,
								@RevenueAccountGuid as [ObverseAcGuid],
								@EntryNote as [Note]
							from
								[ContractAccountDetail] D
							where 
								ParentGuid = @ContractGuid
						end
						
				end
					
				if @UnearnedrRevenue = 0
				begin
						Set @DetailNum = @DetailNum + 1
						Insert into [DEntry]
	 					([ParentGuid],[Number],[AcGuid],[Debit],[Credit],[CurrencyGuid],[CurrencyVal],[CostGuid],[ObverseAcGuid],[Note])
						Select
							@EnGuid,
							@DetailNum,
							@RevenueAccountGuid as [AccountGuid],
							0 as Debit,
							@Rent as Credit,
							@CurrencyGuid,
							@CurrencyVal,
							Case when @MoveCostWithIncomCredit = 1 then @CostGuid end,
							@CustAccountGuid as [ObverseAcGuid],
							@EntryNote as [Note]
				end
				else
				begin
					if @DiscountValue <> 0
					Set @DetailNum = @DetailNum + 1
						Insert into [DEntry]
	 					([ParentGuid],[Number],[AcGuid],[Debit],[Credit],[CurrencyGuid],[CurrencyVal],[CostGuid],[ObverseAcGuid],[Note])
						Select
							@EnGuid,
							@DetailNum,
							@DiscountAccountGuid as [AccountGuid],
							@DiscountValue as Debit,
							0 as Credit,
							@CurrencyGuid,
							@CurrencyVal,
							Case when @MoveCostWithIncomCredit = 1 then @CostGuid end,
							@CustAccountGuid as [ObverseAcGuid],
							@EntryNote as [Note]

					Set @DetailNum = @DetailNum + 1
						Insert into [DEntry]
	 					([ParentGuid],[Number],[AcGuid],[Debit],[Credit],[CurrencyGuid],[CurrencyVal],[CostGuid],[ObverseAcGuid],[Note])
						Select
							@EnGuid,
							@DetailNum,
							@RevenueAccountGuid as [AccountGuid],
							0 as Debit,
							dbo.FnMyRound(
											((
												(@Rent - @discountValue) /
												dbo.fnDaysBetween(@fromdate, @ToDate)
											)
											* 
											dbo.fnDaysBetween(@fromdate, @MaxDate)
											)
											+ @discountValue										
										,1),
							@CurrencyGuid,
							@CurrencyVal,
							Case when @MoveCostWithIncomCredit = 1 then @CostGuid end,
							@CustAccountGuid as [ObverseAcGuid],
							--'From : '+Cast(@fromdate as Varchar(255))+' Max : '+ Cast(@MaxDate as Varchar(255))+' '+CAST(dbo.fnDaysBetween(@fromdate, @MaxDate) as Varchar(255))--
							@EntryNote as [Note]

						Set @DetailNum = @DetailNum + 1
						Insert into [DEntry]
						([ParentGuid],[Number],[AcGuid],[Debit],[Credit],[CurrencyGuid],[CurrencyVal],[CostGuid],[ObverseAcGuid],[Note])
						Select
							@EnGuid,
							@DetailNum,
							@AcIncomNextYearGuid as [AccountGuid],
							0 as Debit,
							dbo.FnMyRound(
											(
											(@Rent - @DiscountValue) -
											(
												(
													(@Rent - @DiscountValue) /
													dbo.fnDaysBetween(@fromdate, @ToDate)
												)
												* 
												dbo.fnDaysBetween(@fromdate, @MaxDate)
											)
											)
																					
										,1) ,
							@CurrencyGuid,
							@CurrencyVal,
							Case when @MoveCostWithIncomCredit = 1 then @CostGuid end,
							@CustAccountGuid as [ObverseAcGuid],
							@EntryNote as [Note]
				end
				
				if @InsuranceValue <> 0
				begin
						Set @DetailNum = @DetailNum + 1
						Insert into [DEntry]
	 					([ParentGuid],[Number],[AcGuid],[Debit],[Credit],[CurrencyGuid],[CurrencyVal],[CostGuid],[ObverseAcGuid],[Note])
						Select
							@EnGuid,
							@DetailNum,
							@CustAccountGuid,
							@InsuranceValue,
							0,
							@CurrencyGuid,
							@CurrencyVal,
							Case when @MoveCost = 1 then @CostGuid end,
							@InsuranceAccountGuid,
							@EntryNote

						Set @DetailNum = @DetailNum + 1
						Insert into [DEntry]
	 					([ParentGuid],[Number],[AcGuid],[Debit],[Credit],[CurrencyGuid],[CurrencyVal],[CostGuid],[ObverseAcGuid],[Note])
						Select
							@EnGuid,
							@DetailNum,
							@InsuranceAccountGuid,
							0,
							@InsuranceValue,
							@CurrencyGuid,
							@CurrencyVal,
							Case when @MoveCostWithInsuranceCredit = 1 then @CostGuid end,
							@CustAccountGuid,
							@EntryNote
				end

				if @CommissionFromCustValue > 0
				begin
						Set @DetailNum = @DetailNum + 1
						Insert into [DEntry]
	 					([ParentGuid],[Number],[AcGuid],[Debit],[Credit],[CurrencyGuid],[CurrencyVal],[CostGuid],[ObverseAcGuid],[Note])
						Select
							@EnGuid,
							@DetailNum,
							@CustAccountGuid,
							@CommissionFromCustValue as Debit,
							0 as Credit,
							@CurrencyGuid,
							@CurrencyVal,
							Case when @MoveCost = 1 then @CostGuid end,
							@AcCommissionFromCustGuid as [ObverseAcGuid],
							Case when @AcCommissionFromCustNote <> '' then @AcCommissionFromCustNote else @EntryNote end

						Set @DetailNum = @DetailNum + 1
						Insert into [DEntry]
	 					([ParentGuid],[Number],[AcGuid],[Debit],[Credit],[CurrencyGuid],[CurrencyVal],[CostGuid],[ObverseAcGuid],[Note])
						Select
							@EnGuid,
							@DetailNum,
							@AcCommissionFromCustGuid,
							0 as Debit,
							@CommissionFromCustValue as Credit,
							@CurrencyGuid,
							@CurrencyVal,
							Case when @MoveCostWithclientCommCredit = 1 then @CostGuid end,
							@CustAccountGuid as [ObverseAcGuid],
							Case when @AcCommissionFromCustNote <> '' then @AcCommissionFromCustNote else @EntryNote end
				end	

				if @CommissionFromOwnerValue > 0
				begin
						Set @DetailNum = @DetailNum + 1
						Insert into [DEntry]
	 					([ParentGuid],[Number],[AcGuid],[Debit],[Credit],[CurrencyGuid],[CurrencyVal],[CostGuid],[ObverseAcGuid],[Note])
						Select
							@EnGuid,
							@DetailNum,
							@AcCustOwnerGuid,
							@CommissionFromOwnerValue as Debit,
							0 as Credit,
							@CurrencyGuid,
							@CurrencyVal,
							Case when @MoveCostWithOwnerComm = 1 then @CostGuid end,
							@AcCommissionFromOwnerGuid as [ObverseAcGuid],
							@EntryNote

						Set @DetailNum = @DetailNum + 1
						Insert into [DEntry]
	 					([ParentGuid],[Number],[AcGuid],[Debit],[Credit],[CurrencyGuid],[CurrencyVal],[CostGuid],[ObverseAcGuid],[Note])
						Select
							@EnGuid,
							@DetailNum,
							@AcCommissionFromOwnerGuid,
							0 as Debit,
							@CommissionFromOwnerValue as Credit,
							@CurrencyGuid,
							@CurrencyVal,
							Case when @MoveCostWithOwnerCommCredit = 1 then @CostGuid end,
							@AcCustOwnerGuid as [ObverseAcGuid],
							Case when @AcCommissionFromOwnerNote <> '' then @AcCommissionFromOwnerNote else @EntryNote end
				end

				if @CommissionFromSalesManValue > 0
				begin
						Set @DetailNum = @DetailNum + 1
						Insert into [DEntry]
		 				([ParentGuid],[Number],[AcGuid],[Debit],[Credit],[CurrencyGuid],[CurrencyVal],[CostGuid],[ObverseAcGuid],[Note])
						Select
							@EnGuid,
							@DetailNum,
							@AcCommissionExpenseGuid,
							@CommissionFromSalesManValue as Debit,
							0 as Credit,
							@CurrencyGuid,
							@CurrencyVal,
							Case when @MoveCost = 1 then @CostGuid end,
							@AcSalesManCommissionGuid as [ObverseAcGuid],
							Case when @SalesManCommNote <> '' then @SalesManCommNote else @EntryNote end

						Set @DetailNum = @DetailNum + 1
						Insert into [DEntry]
		 				([ParentGuid],[Number],[AcGuid],[Debit],[Credit],[CurrencyGuid],[CurrencyVal],[CostGuid],[ObverseAcGuid],[Note])
						Select
							@EnGuid,
							@DetailNum,
							@AcSalesManCommissionGuid,
							0 as Debit,
							@CommissionFromSalesManValue as Credit,
							@CurrencyGuid,
							@CurrencyVal,
							Case when @MoveCostWithclientCommCredit = 1 then @CostGuid end,
							@AcCommissionExpenseGuid as [ObverseAcGuid],
							Case when @SalesManCommNote <> '' then @SalesManCommNote else @EntryNote end
				end

				if @CertificatValue > 0
				begin
						Set @DetailNum = @DetailNum + 1
						Insert into [DEntry]
	 					([ParentGuid],[Number],[AcGuid],[Debit],[Credit],[CurrencyGuid],[CurrencyVal],[CostGuid],[ObverseAcGuid],[Note])
						Select
							@EnGuid,
							@DetailNum,
							@CustAccountGuid,
							@CertificatValue as Debit,
							0 as Credit,
							@CurrencyGuid,
							@CurrencyVal,
							Case when @MoveCost = 1 then @CostGuid end,
							@AccountCertificatValueGuid as [ObverseAcGuid],
							@EntryNote

						Set @DetailNum = @DetailNum + 1
						Insert into [DEntry]
	 					([ParentGuid],[Number],[AcGuid],[Debit],[Credit],[CurrencyGuid],[CurrencyVal],[CostGuid],[ObverseAcGuid],[Note])
						Select
							@EnGuid,
							@DetailNum,
							@AccountCertificatValueGuid,
							0 as Debit,
							@CertificatValue as Credit,
							@CurrencyGuid,
							@CurrencyVal,
							Case when @MoveCostWithCertificatCredit = 1 then @CostGuid end,
							@CustAccountGuid as [ObverseAcGuid],
							@EntryNote
				end	
				
				if @OtherFee > 0
				begin
						Set @DetailNum = @DetailNum + 1
						Insert into [DEntry]
	 					([ParentGuid],[Number],[AcGuid],[Debit],[Credit],[CurrencyGuid],[CurrencyVal],[CostGuid],[ObverseAcGuid],[Note])
						Select
							@EnGuid,
							@DetailNum,
							@CustAccountGuid,
							@OtherFee as Debit,
							0 as Credit,
							@CurrencyGuid,
							@CurrencyVal,
							Case when @MoveCost = 1 then @CostGuid end,
							@OtherFeeAccountGuid as [ObverseAcGuid],
							@EntryNote

						Set @DetailNum = @DetailNum + 1
						Insert into [DEntry]
	 					([ParentGuid],[Number],[AcGuid],[Debit],[Credit],[CurrencyGuid],[CurrencyVal],[CostGuid],[ObverseAcGuid],[Note])
						Select
							@EnGuid,
							@DetailNum,
							@OtherFeeAccountGuid,
							0 as Debit,
							@OtherFee as Credit,
							@CurrencyGuid,
							@CurrencyVal,
							Case when @MoveCostWithFeeCredit = 1 then @CostGuid end,
							@CustAccountGuid as [ObverseAcGuid],
							@EntryNote
				end	
				
				if @ContractPrice > 0
				begin
						Set @DetailNum = @DetailNum + 1
						Insert into [DEntry]
	 					([ParentGuid],[Number],[AcGuid],[Debit],[Credit],[CurrencyGuid],[CurrencyVal],[CostGuid],[ObverseAcGuid],[Note])
						Select
							@EnGuid,
							@DetailNum,
							@CustAccountGuid,
							@ContractPrice as Debit,
							0 as Credit,
							@CurrencyGuid,
							@CurrencyVal,
							Case when @MoveCost = 1 then @CostGuid end,
							@AccountContractPriceGuid as [ObverseAcGuid],
							@EntryNote

						Set @DetailNum = @DetailNum + 1
						Insert into [DEntry]
	 					([ParentGuid],[Number],[AcGuid],[Debit],[Credit],[CurrencyGuid],[CurrencyVal],[CostGuid],[ObverseAcGuid],[Note])
						Select
							@EnGuid,
							@DetailNum,
							@AccountContractPriceGuid,
							0 as Debit,
							@ContractPrice as Credit,
							@CurrencyGuid,
							@CurrencyVal,
							Case when @MoveCostWithFeeCredit = 1 then @CostGuid end,
							@CustAccountGuid as [ObverseAcGuid],
							@EntryNote
				end	
				
				if (@DiscountValue > 0) and (@UnearnedrRevenue = 0)
				begin
					Set @DetailNum = @DetailNum + 1
					Insert into [DEntry]
					([ParentGuid],[Number],[AcGuid],[Debit],[Credit],[CurrencyGuid],[CurrencyVal],[CostGuid],[ObverseAcGuid],[Note])
					Select
							@EnGuid,
							@DetailNum,
							@DiscountAccountGuid,
							@DiscountValue as Debit,
							0 as Credit,
							@CurrencyGuid,
							@CurrencyVal,
							Case when @MoveCostWithDiscount = 1 then @CostGuid end,
							@custAccountGuid,
							dbo.SC('  ') + @EntryNote

					Set @DetailNum = @DetailNum + 1
					Insert into [DEntry]
					([ParentGuid],[Number],[AcGuid],[Debit],[Credit],[CurrencyGuid],[CurrencyVal],[CostGuid],[ObverseAcGuid],[Note])
					Select
						@EnGuid,
						@DetailNum,
						@custAccountGuid,
						0,
						@DiscountValue,
						@CurrencyGuid,
						@CurrencyVal,
						Case when @MoveCostWithDiscountCredit = 1 then @CostGuid end,
						@DiscountAccountGuid as [ObverseAcGuid],
						dbo.SC('  ') + @EntryNote
			end	
			
				--Select * from [DEntry] where ParentGuid = @EnGuid
				--Select @ContractGuid
				exec [PrcCreateEntryFromFlatContractFee] @ContractGuid
				
		end 
	end--end FlatOwner
	
		--Select @FlatOwner

	if (@FlatOwner <> 0) and (@FlatOwner <> -1)
	begin
			Insert Into [HEntry]
			([Guid],[SecLvl],[Number],[Date], [CurrencyGuid], [CurrencyVal], [Note], [ParentKind], [BranchGuid], [IsPosted], Mark)
			Select
				@EnGuid,
				@SecLvl,
				@EnNum,
				@EntryDate,
				@CurrencyGuid,
				@CurrencyVal,
				@EntryNote as [Note],
				1000+@LeaseKind as [ParentKind], 
				@BranchGuid  as [BranchGuid], 
				@AutoPostedEntry as [IsPosted],
				@Mark
				
			Set @DetailNum = 0
			
			if @Rent <> 0
			begin
					if Not Exists(Select Top 1 * from [ContractAccountDetail] where ParentGuid = @ContractGuid)
					begin
						Insert into [DEntry]
	 					([ParentGuid],[Number],[AcGuid],[Debit],[Credit],[CurrencyGuid],[CurrencyVal],[CostGuid],[ObverseAcGuid],[Note])
						Select
							@EnGuid,
							@DetailNum,
							@CustAccountGuid as [AccountGuid],
							Case when @UnearnedrRevenue = 0 then @Rent else (@Rent - @DiscountValue) end as Debit,
							0 as Credit,
							@CurrencyGuid,
							@CurrencyVal,
							Case when @MoveCost = 1 then @CostGuid end,
							@RevenueAccountGuid as [ObverseAcGuid],
							@EntryNote as [Note]
					end
					else
					begin
						Select @CustAccountGuid = AcGuid From Customer Cu where Cu.Guid = @CustGuid
						
						Insert into [DEntry]
	 					([ParentGuid],[Number],[AcGuid],[Debit],[Credit],[CurrencyGuid],[CurrencyVal],[CostGuid],[ObverseAcGuid],[Note])
						Select
							@EnGuid,
							@DetailNum,
							D.AccountGuid as [AccountGuid],
							D.value as Debit,
							0 as Credit,
							@CurrencyGuid,
							@CurrencyVal,
							Case when @MoveCost = 1 then @CostGuid end,
							@RevenueAccountGuid as [ObverseAcGuid],
							@EntryNote as [Note]
						from
							[ContractAccountDetail] D
						where 
							ParentGuid = @ContractGuid
					end
						
				if @UnearnedrRevenue = 0
				begin
						Set @DetailNum = @DetailNum + 1
						Insert into [DEntry]
	 					([ParentGuid],[Number],[AcGuid],[Debit],[Credit],[CurrencyGuid],[CurrencyVal],[CostGuid],[ObverseAcGuid],[Note])
						Select
							@EnGuid,
							@DetailNum,
							@RevenueAccountGuid as [AccountGuid],
							0 as Debit,
							@Rent as Credit,
							@CurrencyGuid,
							@CurrencyVal,
							Case when @MoveCostWithIncomCredit = 1 then @CostGuid end,
							@CustAccountGuid as [ObverseAcGuid],
							@EntryNote as [Note]
				end
				else
				begin
					if @DiscountValue <> 0
					Set @DetailNum = @DetailNum + 1
						Insert into [DEntry]
	 					([ParentGuid],[Number],[AcGuid],[Debit],[Credit],[CurrencyGuid],[CurrencyVal],[CostGuid],[ObverseAcGuid],[Note])
						Select
							@EnGuid,
							@DetailNum,
							@DiscountAccountGuid as [AccountGuid],
							@DiscountValue as Debit,
							0 as Credit,
							@CurrencyGuid,
							@CurrencyVal,
							Case when @MoveCostWithIncomCredit = 1 then @CostGuid end,
							@CustAccountGuid as [ObverseAcGuid],
							@EntryNote as [Note]

					Set @DetailNum = @DetailNum + 1
						Insert into [DEntry]
	 					([ParentGuid],[Number],[AcGuid],[Debit],[Credit],[CurrencyGuid],[CurrencyVal],[CostGuid],[ObverseAcGuid],[Note])
						Select
							@EnGuid,
							@DetailNum,
							@RevenueAccountGuid as [AccountGuid],
							0 as Debit,
							dbo.FnMyRound(
											((
												(@Rent - @discountValue) /
												dbo.fnDaysBetween(@fromdate, @ToDate)
											)
											* 
											dbo.fnDaysBetween(@fromdate, @MaxDate)
											)
											+ @discountValue										
										,1),
							@CurrencyGuid,
							@CurrencyVal,
							Case when @MoveCostWithIncomCredit = 1 then @CostGuid end,
							@CustAccountGuid as [ObverseAcGuid],
							--'From : '+Cast(@fromdate as Varchar(255))+' Max : '+ Cast(@MaxDate as Varchar(255))+' '+CAST(dbo.fnDaysBetween(@fromdate, @MaxDate) as Varchar(255))--
							@EntryNote as [Note]

						Set @DetailNum = @DetailNum + 1
						Insert into [DEntry]
						([ParentGuid],[Number],[AcGuid],[Debit],[Credit],[CurrencyGuid],[CurrencyVal],[CostGuid],[ObverseAcGuid],[Note])
						Select
							@EnGuid,
							@DetailNum,
							@AcIncomNextYearGuid as [AccountGuid],
							0 as Debit,
							dbo.FnMyRound(
											(
											(@Rent - @DiscountValue) -
											(
												(
													(@Rent - @DiscountValue) /
													dbo.fnDaysBetween(@fromdate, @ToDate)
												)
												* 
												dbo.fnDaysBetween(@fromdate, @MaxDate)
											)
											)
																					
										,1) ,
							@CurrencyGuid,
							@CurrencyVal,
							Case when @MoveCostWithIncomCredit = 1 then @CostGuid end,
							@CustAccountGuid as [ObverseAcGuid],
							@EntryNote as [Note]
				end
			end
						
			if @InsuranceValue <> 0
			begin
				Set @DetailNum = @DetailNum + 1
				Insert into [DEntry]
				([ParentGuid],[Number],[AcGuid],[Debit],[Credit],[CurrencyGuid],[CurrencyVal],[CostGuid],[ObverseAcGuid],[Note])
				Select
					@EnGuid,
					@DetailNum,
					@CustAccountGuid,
					@InsuranceValue,
					0,
					@CurrencyGuid,
					@CurrencyVal,
					Case when @MoveCost = 1 then @CostGuid end,
					@InsuranceAccountGuid,
					@EntryNote
					
				Set @DetailNum = @DetailNum + 1
				Insert into [DEntry]
				([ParentGuid],[Number],[AcGuid],[Debit],[Credit],[CurrencyGuid],[CurrencyVal],[CostGuid],[ObverseAcGuid],[Note])
				Select
					@EnGuid,
					@DetailNum,
					@InsuranceAccountGuid,
					0,
					@InsuranceValue,
					@CurrencyGuid,
					@CurrencyVal,
					Case when @MoveCostWithInsuranceCredit = 1 then @CostGuid end,
					@CustAccountGuid,
					@EntryNote
			end

			if @CommissionFromCustValue > 0
			begin
					Set @DetailNum = @DetailNum + 1
					Insert into [DEntry]
					([ParentGuid],[Number],[AcGuid],[Debit],[Credit],[CurrencyGuid],[CurrencyVal],[CostGuid],[ObverseAcGuid],[Note])
					Select
						@EnGuid,
						@DetailNum,
						@CustAccountGuid,
						@CommissionFromCustValue as Debit,
						0 as Credit,
						@CurrencyGuid,
						@CurrencyVal,
						Case when @MoveCost = 1 then @CostGuid end,
						@AcCommissionFromCustGuid as [ObverseAcGuid],
						Case when @AcCommissionFromCustNote <> '' then @AcCommissionFromCustNote else @EntryNote end

					Set @DetailNum = @DetailNum + 1
					Insert into [DEntry]
					([ParentGuid],[Number],[AcGuid],[Debit],[Credit],[CurrencyGuid],[CurrencyVal],[CostGuid],[ObverseAcGuid],[Note])
					Select
						@EnGuid,
						@DetailNum,
						@AcCommissionFromCustGuid,
						0 as Debit,
						@CommissionFromCustValue as Credit,
						@CurrencyGuid,
						@CurrencyVal,
						Case when @MoveCostWithclientCommCredit = 1 then @CostGuid end,
						@CustAccountGuid as [ObverseAcGuid],
						Case when @AcCommissionFromCustNote <> '' then @AcCommissionFromCustNote else @EntryNote end
			end

			if @CommissionFromOwnerValue > 0
			begin
					Set @DetailNum = @DetailNum + 1
					Insert into [DEntry]
					([ParentGuid],[Number],[AcGuid],[Debit],[Credit],[CurrencyGuid],[CurrencyVal],[CostGuid],[ObverseAcGuid],[Note])
					Select
						@EnGuid,
						@DetailNum,
						@AcCustOwnerGuid,
						@CommissionFromOwnerValue as Debit,
						0 as Credit,
						@CurrencyGuid,
						@CurrencyVal,
						Case when @MoveCostWithOwnerComm = 1 then @CostGuid end,
						@AcCommissionFromOwnerGuid as [ObverseAcGuid],
						@EntryNote

					Set @DetailNum = @DetailNum + 1
					Insert into [DEntry]
					([ParentGuid],[Number],[AcGuid],[Debit],[Credit],[CurrencyGuid],[CurrencyVal],[CostGuid],[ObverseAcGuid],[Note])
					Select
						@EnGuid,
						@DetailNum,
						@AcCommissionFromOwnerGuid,
						0 as Debit,
						@CommissionFromOwnerValue as Credit,
						@CurrencyGuid,
						@CurrencyVal,
						Case when @MoveCostWithclientCommCredit = 1 then @CostGuid end,
						@AcCustOwnerGuid as [ObverseAcGuid],
						Case when @AcCommissionFromOwnerNote <> '' then @AcCommissionFromOwnerNote else @EntryNote end
			end

				if @CommissionFromSalesManValue > 0
				begin
						Set @DetailNum = @DetailNum + 1
						Insert into [DEntry]
		 				([ParentGuid],[Number],[AcGuid],[Debit],[Credit],[CurrencyGuid],[CurrencyVal],[CostGuid],[ObverseAcGuid],[Note])
						Select
							@EnGuid,
							@DetailNum,
							@AcCommissionExpenseGuid,
							@CommissionFromSalesManValue as Debit,
							0 as Credit,
							@CurrencyGuid,
							@CurrencyVal,
							Case when @MoveCost = 1 then @CostGuid end,
							@AcSalesManCommissionGuid as [ObverseAcGuid],
							Case when @SalesManCommNote <> '' then @SalesManCommNote else @EntryNote end

						Set @DetailNum = @DetailNum + 1
						Insert into [DEntry]
		 				([ParentGuid],[Number],[AcGuid],[Debit],[Credit],[CurrencyGuid],[CurrencyVal],[CostGuid],[ObverseAcGuid],[Note])
						Select
							@EnGuid,
							@DetailNum,
							@AcSalesManCommissionGuid,
							0 as Debit,
							@CommissionFromSalesManValue as Credit,
							@CurrencyGuid,
							@CurrencyVal,
							Case when @MoveCostWithclientCommCredit = 1 then @CostGuid end,
							@AcCommissionExpenseGuid as [ObverseAcGuid],
							Case when @SalesManCommNote <> '' then @SalesManCommNote else @EntryNote end
				end

			if @CertificatValue > 0
			begin
					Set @DetailNum = @DetailNum + 1
					Insert into [DEntry]
					([ParentGuid],[Number],[AcGuid],[Debit],[Credit],[CurrencyGuid],[CurrencyVal],[CostGuid],[ObverseAcGuid],[Note])
					Select
						@EnGuid,
						@DetailNum,
						@CustAccountGuid,
						@CertificatValue,
						0,
						@CurrencyGuid,
						@CurrencyVal,
						Case when @MoveCost = 1 then @CostGuid end,
						@AccountCertificatValueGuid,
						@EntryNote

					Set @DetailNum = @DetailNum + 1
					Insert into [DEntry]
					([ParentGuid],[Number],[AcGuid],[Debit],[Credit],[CurrencyGuid],[CurrencyVal],[CostGuid],[ObverseAcGuid],[Note])
					Select
						@EnGuid,
						@DetailNum,
						@AccountCertificatValueGuid,
						0 as Debit,
						@CertificatValue as Credit,
						@CurrencyGuid,
						@CurrencyVal,
						Case when @MoveCostWithCertificatCredit = 1 then @CostGuid end,
						@CustAccountGuid as [ObverseAcGuid],
						@EntryNote
			end	

			if @OtherFee > 0
			begin
					Set @DetailNum = @DetailNum + 1
					Insert into [DEntry]
					([ParentGuid],[Number],[AcGuid],[Debit],[Credit],[CurrencyGuid],[CurrencyVal],[CostGuid],[ObverseAcGuid],[Note])
					Select
						@EnGuid,
						@DetailNum,
						@CustAccountGuid,
						@OtherFee as Debit,
						0 as Credit,
						@CurrencyGuid,
						@CurrencyVal,
						Case when @MoveCost = 1 then @CostGuid end,
						@OtherFeeAccountGuid as [ObverseAcGuid],
						@EntryNote

					Set @DetailNum = @DetailNum + 1
					Insert into [DEntry]
					([ParentGuid],[Number],[AcGuid],[Debit],[Credit],[CurrencyGuid],[CurrencyVal],[CostGuid],[ObverseAcGuid],[Note])
					Select
						@EnGuid,
						@DetailNum,
						@OtherFeeAccountGuid,
						0 as Debit,
						@OtherFee as Credit,
						@CurrencyGuid,
						@CurrencyVal,
						Case when @MoveCostWithFeeCredit = 1 then @CostGuid end,
						@CustAccountGuid as [ObverseAcGuid],
						@EntryNote
			end	
				
			if @ContractPrice > 0
			begin
					Set @DetailNum = @DetailNum + 1
					Insert into [DEntry]
					([ParentGuid],[Number],[AcGuid],[Debit],[Credit],[CurrencyGuid],[CurrencyVal],[CostGuid],[ObverseAcGuid],[Note])
					Select
						@EnGuid,
						@DetailNum,
						@CustAccountGuid,
						@ContractPrice as Debit,
						0 as Credit,
						@CurrencyGuid,
						@CurrencyVal,
						Case when @MoveCost = 1 then @CostGuid end,
						@AccountContractPriceGuid as [ObverseAcGuid],
						@EntryNote

					Set @DetailNum = @DetailNum + 1
					Insert into [DEntry]
					([ParentGuid],[Number],[AcGuid],[Debit],[Credit],[CurrencyGuid],[CurrencyVal],[CostGuid],[ObverseAcGuid],[Note])
					Select
						@EnGuid,
						@DetailNum,
						@AccountContractPriceGuid,
						0 as Debit,
						@ContractPrice as Credit,
						@CurrencyGuid,
						@CurrencyVal,
						Case when @MoveCostWithFeeCredit = 1 then @CostGuid end,
						@CustAccountGuid as [ObverseAcGuid],
						@EntryNote
			end	

			if (@DiscountValue > 0) and (@UnearnedrRevenue = 0)
			begin
				Set @DetailNum = @DetailNum + 1
					Insert into [DEntry]
					([ParentGuid],[Number],[AcGuid],[Debit],[Credit],[CurrencyGuid],[CurrencyVal],[CostGuid],[ObverseAcGuid],[Note])
					Select
						@EnGuid,
						@DetailNum,
						@DiscountAccountGuid,
						@DiscountValue as Debit,
						0 as Credit,
						@CurrencyGuid,
						@CurrencyVal,
						Case when @MoveCostWithDiscount = 1 then @CostGuid end,
						@custAccountGuid,
						dbo.SC('  ') + @EntryNote

				Set @DetailNum = @DetailNum + 1
				Insert into [DEntry]
				([ParentGuid],[Number],[AcGuid],[Debit],[Credit],[CurrencyGuid],[CurrencyVal],[CostGuid],[ObverseAcGuid],[Note])
				Select
					@EnGuid,
					@DetailNum,
					@custAccountGuid,
					0,
					@DiscountValue,
					@CurrencyGuid,
					@CurrencyVal,
					Case when @MoveCostWithDiscountCredit = 1 then @CostGuid end,
					@DiscountAccountGuid as [ObverseAcGuid],
					dbo.SC('  ') + @EntryNote
		end	

			exec [PrcCreateEntryFromFlatContractFee] @ContractGuid
	end				

	exec PrcDoDistributiveEntry @EnGuid
	
	if @AutoPostedEntry = 1
	Update [Hentry] Set IsPosted = 1 where Guid = @EnGuid
	
	--Select * from [Hentry] where Guid = @EnGuid 
	--Select * from [Dentry] where parentGuid = @EnGuid order by number
		

GO

SET ANSI_NULLS, QUOTED_IDENTIFIER ON
GO

Create Procedure [PrcCreateEntryChecksPartialCollection]
(
	@CollectionGuid uniqueidentifier = '437E969C-5C8D-45C0-B946-ADFCAD2E9135',
	@CheckGuid uniqueidentifier = '437E969C-5C8D-45C0-B946-ADFCAD2E9135',
	@TypeGuid uniqueidentifier = '090E44FF-AE92-4744-8430-5CF559E58FB1',
	@Sender int = 0
)
 
as
	Declare @PartialCollectedEntryTypeGuid uniqueidentifier
	select
		@PartialCollectedEntryTypeGuid = T.PartialCollectedEntryTypeGuid
	from
		CheckType T 
	where
		T.Guid = @TypeGuid

	--   
	if isNull(@partialCollectedEntryTypeGuid, 0x0) <> 0x0
	begin
		exec [PrcCreateEntrytypeChecksPartialCollection] @CollectionGuid ,@CheckGuid ,@TypeGuid ,@Sender, @PartialCollectedEntryTypeGuid
	end
	else
	Delete
		[Secondary_Entry]
	where
		[Guid] = @CollectionGuid


	Declare 
			@EnNum int

	--  
	Select 
		@EnNum = isnull([h].[Number],0)
	From
		[ChecksPartialCollection] [C]
		inner join [Hentry] [H] On [H].[Guid] = [C].[Guid]
	where
		[C].[Guid] = @CollectionGuid

	if isnull(@EnNum,0) = 0
	begin	
		Select @EnNum = IsNull(Max([Number]),0) + 1 from [HEntry]
	END

	--    
	Delete [ContractCachPayment] where [EntryGuid] = @CollectionGuid
	Delete [LandContractCachPayment] where [EntryGuid] = @CollectionGuid
	Delete [ContractParkingCachPayment] where [EntryGuid] = @CollectionGuid
	Delete [ElectricityCachPayment] where [EntryGuid] = @CollectionGuid
	

	--   
	Delete
		[HEntry]
	where
		[Guid] = @CollectionGuid

	DECLARE 
		@CreateEntry BIT,
		@AutoPostedEntry Bit

	
	SELECT	TOP 1
		@CreateEntry = 
		Case when [partialcollectedCreatedEntry] = 1 and (
													([partialcollectedAutoCreatedEntry] = 1) or (@Sender = 1)
												   ) then 1 else 0 end,
		@AutoPostedEntry = [partialcollectedAutoPostedEntry]
	FROM
		[CheckType]
	WHERE
		Guid = @TypeGuid

	DECLARE
		@CheckKind INT,
		@SecLvl Int,
		@Mark Bit,
		@Value Float,
		@CurrencyGUID [uniqueidentifier],
		@CurrencyVal [float],
		@Date DateTime,

		@DebitAccountGuid [uniqueidentifier]  ,
		@DebitCostGuid [uniqueidentifier]  ,
		@CreditAccountGuid [uniqueidentifier]  ,
		@CreditCostGuid [uniqueidentifier]  ,
		@Commission Float,
		@CommCostGuid [uniqueidentifier],
		@CommCostCreditGuid [uniqueidentifier],
		@CommNote varchar(256),
		@LossComm Bit,
		@CommType int,
		@CommAccountGuid [uniqueidentifier],
		@CommAccountCreditGuid [uniqueidentifier],
		@Note Varchar(256),
		@BranchGuid [uniqueidentifier],
		@IsRounded bit

	SELECT
		@CheckKind				= [T].[CheckKind],
		@SecLvl					= [C].[SecLvl],
		@Mark					= [L].[Mark],
		@Value					= [L].[Value],
		@CurrencyGUID			= [C].[CurrencyGUID],
		@CurrencyVal			= [C].[CurrencyVal],
		@Date					= [L].[Date],

		@DebitAccountGuid		= [L].[DebitAccountGuid],
		@DebitCostGuid			= [L].[DebitCostGuid],
		@CreditAccountGuid		= [L].[CreditAccountGuid],
		@CreditCostGuid			= [L].[CreditCostGuid],
		@Commission				= [L].[Commission],
		@CommCostGuid			= Case when T.CommMoveCost = 1 then L.[CommCostGuid] end,
		@CommCostCreditGuid			= Case when T.CommMoveCostCredit = 1 then L.[CommCostGuid] end,
		@CommNote 				= [L].[CommNote],
		@LossComm				= [L].[LossComm],
		@CommType				= [T].[CommType],
		@CommAccountGuid		= [L].[CommAccountGuid],
		@CommAccountCreditGuid	= [L].[CommAccountCreditGuid],
		@Note					= [L].[Note],
		@BranchGuid				= [C].[BranchGuid],
		@IsRounded				= IsNull(L.IsRounded,0)
	FROM 
		[Checks] [C]
		INNER JOIN [ChecksPartialCollection] [L] ON [L].[CheckGuid] = [C].[Guid]
		INNER JOIN [CheckType] [T] ON [T].[Guid] = [C].[TypeGuid]
	WHERE
		[L].[Guid] = @CollectionGuid 


	if (@CreateEntry = 1) and (@IsRounded = 0)
	BEGIN
			Insert Into [HEntry]
			([Guid],[SecLvl],[Number],[Mark],[Date], [CurrencyGuid], [CurrencyVal], [Note], [ParentKind], [BranchGuid],[isPosted])
			Select
				@CollectionGuid,
				@SecLvl,
				@EnNum,
				@Mark,
				@Date,
				@CurrencyGuid,
				@CurrencyVal,
				'',
				1670,
				@BranchGuid,
				@AutoPostedEntry
				
			Declare @DetailNum Int
			Set @DetailNum = 0

			Declare @CheckValue Float,
					@CommValue Float

			Set @CheckValue = Case when @LossComm = 1 then
														Case
															when @CommType = 0 then @Value - @Commission
															else @Value
														end
									else
									@Value
							  end

			Set @CommValue = @Commission
		
			if not (isNull(@partialCollectedEntryTypeGuid, 0x0) <> 0x0) --      
			begin
				Insert into [DEntry]
		 		([ParentGuid],[Number],[AcGuid],[Debit],[Credit],[CurrencyGuid],[CurrencyVal],[CostGuid],[Note],[ObverseAcGuid])
				Select
					@CollectionGuid,
					@DetailNum,
					@DebitAccountGuid,
					@CheckValue,
					0,
					@CurrencyGuid,
					@CurrencyVal,
					@DebitCostGuid,
					@Note,
					@CreditAccountGuid
					
				
				Set @DetailNum = @DetailNum + 1
				Insert into [DEntry]
		 		([ParentGuid],[Number],[AcGuid],[Debit],[Credit],[CurrencyGuid], [CurrencyVal],[CostGuid],[Note],[ObverseAcGuid])
				Select
					@CollectionGuid,
					@DetailNum,
					@CreditAccountGuid,
					0,
					@CheckValue,
					@CurrencyGuid,
					@CurrencyVal,
					@CreditCostGuid,
					@Note,
					@DebitAccountGuid
			end

			IF @LossComm = 1  --  
			BEGIN
				Set @DetailNum = @DetailNum + 1
				Insert into [DEntry]
		 		([ParentGuid],[Number],[AcGuid],[Debit],[Credit],[CurrencyGuid], [CurrencyVal],[CostGuid],[Note],[ObverseAcGuid])
				Select
					@CollectionGuid,
					@DetailNum,
					@CommAccountGuid,
					@CommValue,					
					0,
					@CurrencyGuid,
					@CurrencyVal,
					@CommCostGuid,
					@CommNote,
					@CommAccountCreditGuid

					Set @DetailNum = @DetailNum + 1
					Insert into [DEntry]
			 		([ParentGuid],[Number],[AcGuid],[Debit],[Credit],[CurrencyGuid], [CurrencyVal],[CostGuid],[Note],[ObverseAcGuid])
					Select
						@CollectionGuid,
						@DetailNum,
						@CommAccountCreditGuid,
						0,
						@Commission,
						@CurrencyGuid,
						@CurrencyVal,
						@CommCostCreditGuid,
						@CommNote,
						@CommAccountGuid
			END
			
			if @DetailNum = 0
			Delete HEntry where Guid = @CollectionGuid

	end

	--    
	--      
	if Exists(Select Top 1 * From [HEntry] where [Guid] = @CollectionGuid )
	begin
		Declare @ContractKind int
				,@ContractGuid uniqueidentifier
		Set @ContractKind = -1
		
		Select
			@ContractKind = Al.[Kind] ,
			@ContractGuid = [Al].[Guid]
		FROM 
			[Checks] [C]
			INNER JOIN [ChecksPartialCollection] [L] ON [L].[CheckGuid] = [C].[Guid]
			INNER JOIN [CheckType] [T] ON [T].[Guid] = [C].[TypeGuid]
			inner join [vwAllContract] [Al] on [Al].[Guid] = [C].[ContractGuid]
		WHERE
			[L].[Guid] = @CollectionGuid 

		--   
		if @ContractKind = 0
		begin
			
			Insert into [ContractCachPayment] 
			([ContractGuid], [EntryGuid])
			Select
				@ContractGuid,
				@CollectionGuid 
			
		end

		--   
		if @ContractKind = 1
		begin
			Insert into [ContractParkingCachPayment] 
			([ContractGuid], [EntryGuid])
			Select
				@ContractGuid,
				@CollectionGuid 
		end

		--   
		if @ContractKind = 2
		begin
			Insert into [LandContractCachPayment] 
			([ContractGuid], [EntryGuid])
			Select
				@ContractGuid,
				@CollectionGuid 
		end

		if @ContractKind is Null
		begin
			
			Select
				@ContractGuid = [Al].[Guid]
			FROM 
				[Checks] [C]
				INNER JOIN [ChecksPartialCollection] [L] ON [L].[CheckGuid] = [C].[Guid]
				INNER JOIN [CheckType] [T] ON [T].[Guid] = [C].[TypeGuid]
				inner join [vwElectricityBill] [Al] on [Al].[Guid] = [C].[ContractGuid]
			WHERE
				[L].[Guid] = @CollectionGuid 
				
			if isNull(@ContractGuid, 0x0) <> 0x0	
			Insert into [ElectricityCachPayment] 
			([ContractGuid], [EntryGuid])
			Select
				@ContractGuid,
				@CollectionGuid 
			
		end
	end


GO

SET ANSI_NULLS, QUOTED_IDENTIFIER ON
GO

Create Procedure [PrcCheckOfContract]
(
	@CustGuid uniqueidentifier = '88D74D66-39A5-4D76-9917-DE9625471194'
	,@Nationality Varchar(256) = ''
	,@Purpose Varchar(256) = ''
	,@Emirate Varchar(256) = ''
	,@Suburb Varchar(256) = ''
	,@Area Varchar(256) = ''
	,@Street Varchar(256) = ''
	,@FlatKind Varchar(256) = ''
	,@ApartmentType Varchar(256) = ''
	,@ContractState int = 1
	,@Judicial int = 2
	,@PayType int = 4
	,@Datewith int = 0
	,@Date1 DateTime = '12/30/1899'
	,@Date2 DateTime = '12/30/2016'
	,@RentInfoGuid uniqueidentifier = 0x0
	,@SalesManGuid uniqueidentifier = 0x0
	,@CKDate Bit = 0
	,@EndState int = 2
	,@NewState int = 2
	,@Mark Bit = 1
	,@NotMark Bit = 1
	,@AutoRenewal int = 1
	,@LinkCheck int = 2
	,@FldCurrentContract bit = 1
	,@BanRealty int = 0
	,@whereabouts varchar(255) = ''
)
 
as
	
	Declare @Tbl Table
	(
		[ContractNo] Varchar(256)
		,[FlatNo] Varchar(256)
		,[BuildingName] Varchar(256)
		,[Value] Float
		,[ValueAfterDiscount] Float
		,[FlatKind] Varchar(256)
		,[FlatType] Varchar(256)
		,[ContractState] Varchar(256)
		,[Emirate] Varchar(256)
		,[FloorNo] Varchar(256)
		,[CustName] Varchar(256)
		,[CustPhone] Varchar(256)
		,[CustNationality] Varchar(256)
		,[ContractDateEdit] Datetime
		,[ContractDateBegin] Datetime
		,[ContractDateEnd] Datetime
		,[ContractType] Varchar(256)
		,[ContractFinish] Bit
		,[ContractGuid] uniqueidentifier
		,[NewState] int

		,[RentMan] Varchar(256)
		,[SalesMan] Varchar(256)
		,[ContractFinishDate] Datetime
		,[Note2] Varchar(1000)
		,[Purpose] Varchar(256)
		
		,[CountOldContract] int
		,[CountCurrentContract] int
		
		,[CostGuid] uniqueidentifier
		,[AccountGuid] uniqueidentifier
		,[Judicial] Bit
		,[Mark] Bit
		,[isAutoRenewal] Bit
		,[Kind] Int
		,[Sort] int
	)

	Declare  @Now_Date Datetime
	Set @Now_Date = GetDate()
	
	--  
	Create Table #CurrentContract
	(
		CustomerGuid uniqueidentifier,
		ApartmentGuid uniqueidentifier,
		[ContractCount] int
	)
	
	if @FldCurrentContract = 1
	begin
		insert into #CurrentContract
		Select 
			CustomerGuid,
			ApartmentGuid,
			IsNull(COUNT(*),0) as [ContractCount]
		From 
			[LeaseApartment]
		Group By
			CustomerGuid,
			ApartmentGuid
	end
	

	--Building
	Select
		*
	Into #Building_CL
	From
		[vwBuilding] B
	where
		([B].[Emirate] = @Emirate or @Emirate = '')
		and ([B].[Suburb] = @Suburb or @Suburb = '')
		and ([B].[Area] = @Area or @Area = '')
		and ([B].[Street] = @Street or @Street = '')
		
		
    select Distinct
		ContractKind
	into #Resource_Type
	From
		ContractType T
		inner join [Resource] [R2] on [R2].[Guid] = [T].[Guid]  and [R2].[Kind] = 100 and [R2].[spid] = @@Spid 
		
	--Select * from #Resource_Type
	--return
		

	--Select * from #Building_CL
		
	--[vwLeaseApartment]
	Declare @p_RentFlat bit,
			@p_RentShop bit,
			@p_SaleFlat bit,
			@p_SaleShop bit,
			@p_RentParking bit,
			@p_SaleParking bit,
			@p_SaleLand bit,
			@p_RentLand bit,
			@p_SaleVilla bit,
			@p_RentVilla bit
			
	if exists(Select * From #Resource_Type where ContractKind = 0)
	Set @p_RentFlat = 1 else Set @p_RentFlat = 0
	
	if exists(Select * From #Resource_Type where ContractKind = 1)
	Set @p_RentShop = 1 else Set @p_RentShop = 0 

	if exists(Select * From #Resource_Type where ContractKind = 2)
	Set @p_SaleFlat = 1 else Set @p_SaleFlat = 0 

	if exists(Select * From #Resource_Type where ContractKind = 3)
	Set @p_SaleShop = 1 else Set @p_SaleShop = 0 

	if exists(Select * From #Resource_Type where ContractKind = 4)
	Set @p_RentParking = 1 else Set @p_RentParking = 0 

	if exists(Select * From #Resource_Type where ContractKind = 5)
	Set @p_SaleParking = 1 else Set @p_SaleParking = 0 

	if exists(Select * From #Resource_Type where ContractKind = 6)
	Set @p_SaleLand = 1 else Set @p_SaleLand = 0 

	if exists(Select * From #Resource_Type where ContractKind = 7)
	Set @p_RentLand = 1 else Set @p_RentLand = 0 

	if exists(Select * From #Resource_Type where ContractKind = 8)
	Set @p_SaleVilla = 1 else Set @p_SaleVilla = 0 

	if exists(Select * From #Resource_Type where ContractKind = 9)
	Set @p_RentVilla = 1 else Set @p_RentVilla = 0 
	
	Select
		L.*
		,T.Name as ContractName
		,[L].[Judicial] as [ContractJudicial]
		,S.Name as [SalesMan]
	into #LeaseApartment_CL
	From
		[LeaseApartment] L
		inner join ContractType T on T.Guid = L.TypeGuid
		inner join [Resource] [R2] on [R2].[Guid] = [L].[TypeGuid]  and [R2].[Kind] = 100 and [R2].[spid] = @@Spid 
		left join Salesman S on S.Guid = L.SalesManGuid
	where
		([L].[CustomerGuid] = @CustGuid or @CustGuid = 0x0)
		and ([L].[RentInfoGuid] = @RentInfoGuid or @RentInfoGuid = 0x0)
		and ([L].[SalesManGuid] = @SalesManGuid or @SalesManGuid = 0x0)
		and ([L].[ContractFinish] = @EndState or @EndState = 2)
		and (
				([l].[Mark] = 1 and @Mark = 1)
				or ([l].[Mark] = 0 and @NotMark = 1)
			)
		and (L.PayType = @PayType or @PayType  = 4)
		and (isNull([L].[Judicial],0) = @Judicial or @Judicial = 2)
		and (L.Purpose = @Purpose or @Purpose = '')
		
		and (@p_RentFlat = 1 or @p_RentShop = 1 or @p_SaleFlat = 1 or @p_SaleShop = 1)
		and (L.isAutoRenewal = @AutoRenewal or @AutoRenewal = 2)
		and (L.whereabouts = @whereabouts or @whereabouts = '')
		
	
	Select * into #LeaseApartment_Rent from #LeaseApartment_CL L
	where
			(
				((([L].[ToDate] <= @Now_Date) or ([L].[ContractFinish] = 1)) and @ContractState = 0)
			  	or ([L].[ToDate] > @Now_Date and @ContractState = 1)
				or @ContractState = 2
			)		
			and (
				(
					([L].[FromDate] >= @Date1 and @Datewith  = 0)
					and ([L].[FromDate] <= @Date2 and @Datewith  = 0 or @Date2 = '12/30/1899')
				)
				or
				(
					([L].[ToDate] >= @Date1 and @Datewith  = 1)
					and ([L].[ToDate] <= @Date2 and @Datewith  = 1 or @Date2 = '12/30/1899')
				)

				or
				(
					([L].[ContractFinishDate] >= @Date1 and @Datewith  = 2)
					and ([L].[ContractFinishDate] <= @Date2 and @Datewith  = 2 or @Date2 = '12/30/1899')
					and ([L].[ContractFinish] = 1)
				)

				or
				(
					([L].[EditDate] >= @Date1 and @Datewith  = 3)
					and ([L].[EditDate] <= @Date2 and @Datewith  = 3 or @Date2 = '12/30/1899')
				)
				or
				(
					([L].[AcquittancePrintdate] >= @Date1 and @Datewith  = 4)
					and ([L].[AcquittancePrintdate] <= @Date2 and @Datewith  = 4 or @Date2 = '12/30/1899')
				)

				or
				(
					([L].LeaveDate >= @Date1 and @Datewith  = 5)
					and ([L].LeaveDate <= @Date2 and @Datewith  = 5 or @Date2 = '12/30/1899')
				)

				or @CKDate = 0
			) 

	--Select * from #LeaseApartment_Rent return	
	-- 	
	Select * into #RentInfo_CL from [RentInfo] where Guid = @RentInfoGuid or @RentInfoGuid = 0x0
	
	--Customer 
	Select
		*
	into #Customer
	From
		vwCustomer
	where
		([Guid] = @CustGuid or @CustGuid = 0x0)
		and ([Nationality] = @Nationality or @Nationality = '')
		
    
   --Select * from #LeaseApartment_CL where [ContractJudicial] = 1
    
	-- 	
	if @p_RentFlat = 1
	Insert into @Tbl 
	Select 
		[L].[ContractNo]
		,[A].[No] as [FlatNo]
		,[B].[Name] as [BuildingName]
		,[L].[Rent]
		,[L].[Rent] - [L].[DiscountValue]
		,[A].[FlatKind] as [FlatKind]
		,[A].[ApartmentType] as [FlatType]
		,Case when ([L].[ToDate] <= @Now_Date) or ([L].[ContractFinish] = 1) then dbo.sc(' ')  
			  when [L].[ToDate] > @Now_Date then dbo.sc('  ') end as [ContractState]
		,[B].[Emirate] as [Emirate]
		,[A].[FloorNo]
		,[Cu].[Name] as [CustName]
		,[Cu].[Mobile] as [CustPhone]
		,[Cu].Nationality
		,[L].[EditDate] as [ContractDateEdit]
		,[L].[FromDate] as [ContractDateBegin]
		,[L].[ToDate] as [ContractDateEnd]
		,[L].[ContractName]
		,[L].[ContractFinish]
		,[L].[Guid] as [ContractGuid]
		,[L].[NewState] 

		,[I].[Name]	
		,L.[SalesMan]
		,[ContractFinishDate]
		,[Note2] 
		,L.[Purpose]
		,l.[CountOldContract]
		,(Select [ContractCount] From #CurrentContract where L.CustomerGuid = CustomerGuid and [L].ApartmentGuid = ApartmentGuid)as [CurrentContract]
		,[L].[CostGuid]
		,L.[CustAccountGuid]
		,L.[ContractJudicial]
		,[L].[Mark]
		,[L].[isAutoRenewal]

		,0 as [Kind]
		,0 as [Sort]
	from 
		#Building_CL [B]
		Inner join [vbApartment] [A] On [A].[BuildingGuid] = [B].[Guid]
		Inner join #LeaseApartment_Rent [L] On [A].[Guid] = [L].[ApartmentGuid] and [LeaseKind]  = 0
		inner join [Resource] [R] on [R].[Guid] = [B].[Guid]  and [R].[Kind] = 101 and [R].[spid] = @@Spid 
		--inner join [vwContractType] [T] on [T].[Guid] = [L].[TypeGuid]  
		--inner join [Resource] [R2] on [R2].[Guid] = [T].[Guid]  and [R2].[Kind] = 100 and [R2].[spid] = @@Spid 
		Inner join [#Customer] [Cu] on [Cu].[Guid] = [L].[CustomerGuid] 
		left join #RentInfo_CL [I] on [I].[Guid] = [L].[RentInfoGuid]
	where
		([A].[FlatKind] = @FlatKind or @FlatKind = '')
		and ([A].[ApartmentType] = @ApartmentType or @ApartmentType = '')
		and (A.Ban = @banRealty or @banRealty = 2)
		
	-- 	
	if @p_RentShop = 1
	Insert into @Tbl 
	Select 
		[L].[ContractNo]
		,[A].[No] as [FlatNo]
		,[B].[Name] as [BuildingName]
		,[L].[Rent]
		,[L].[Rent] - [L].[DiscountValue]
		,[ShopKind] as [FlatKind]
		,A.[Description] as [FlatType]
		,Case when ([L].[ToDate] <= GetDate()) or ([L].[ContractFinish] = 1) then dbo.sc(' ')  
			  when [L].[ToDate] > GetDate() then dbo.sc('  ') end as [ContractState]
		,[B].[Emirate] as [Emirate]
		,'' as [FloorNo]
		,[Cu].[Name] as [CustName]
		,[Cu].[Mobile] as [CustPhone]
		,[Cu].Nationality
		,[L].[EditDate] as [ContractDateEdit]
		,[L].[FromDate] as [ContractDateBegin]
		,[L].[ToDate]as [ContractDateEnd]
		,[L].[ContractName]
		,[L].[ContractFinish]
		,[L].[Guid] as [ContractGuid]
		,[L].[NewState] 

		,[I].[Name]	
		,L.[SalesMan]
		,[ContractFinishDate]
		,Left([L].[Note2],255)
		,L.[Purpose]
		,L.[CountOldContract]
		,(Select [ContractCount] From #CurrentContract where L.CustomerGuid = CustomerGuid and [L].ApartmentGuid = ApartmentGuid)as [CurrentContract]
		,[L].[CostGuid]
		,L.[CustAccountGuid]
		,L.[ContractJudicial]
		,[L].[mark]
		,[L].[isAutoRenewal]
		,1 as [Kind]
		,0 as [Sort]
	from 
		#Building_CL [B]
		Inner join [vwShopall] [A] On [A].[BuildingGuid] = [B].[Guid]
		inner join #LeaseApartment_Rent [L] On [A].[Guid] = [L].[ApartmentGuid] and [LeaseKind]  = 1
		Inner join [Resource] [R] on [R].[Guid] = [B].[Guid]  and [R].[Kind] = 101 and [R].[spid] = @@Spid 
		--inner  join [vwContractType] [T] on [T].[Guid] = [L].[TypeGuid]  
		--Inner join [Resource] [R2] on [R2].[Guid] = [T].[Guid]  and [R2].[Kind] = 100 and [R2].[spid] = @@Spid 
		inner  join [#Customer] [Cu] on [Cu].[Guid] = [L].[CustomerGuid] 
		left  join #RentInfo_CL [I] on [I].[Guid] = [L].[RentInfoGuid]
		and (A.Ban = @banRealty or @banRealty = 2)

	-- 
	if @p_SaleFlat = 1
	Insert into @Tbl 
	Select 
		[L].[ContractNo]
		,[A].[No] as [FlatNo]
		,[B].[Name] as [BuildingName]
		,[L].[Rent]
		,[L].[Rent] - [L].[DiscountValue]
		,[A].[FlatKind] as [FlatKind]
		,[A].[ApartmentType] as [FlatType]
		,Case when ([L].[ToDate] <= GetDate()) or ([L].[ContractFinish] = 1) then dbo.sc(' ')  
			  when [L].[ToDate] > GetDate() then dbo.sc('  ') end as [ContractState]
		,[B].[Emirate] as [Emirate]
		,[A].[FloorNo]
		,[Cu].[Name] as [CustName]
		,[Cu].[Mobile] as [CustPhone]
		,[Cu].[Nationality]
		,[L].[EditDate] as [ContractDateEdit]
		,[L].[FromDate] as [ContractDateBegin]
		,[L].[ToDate]as [ContractDateEnd]
		,[L].[ContractName]
		,Null as [ContractFinish]
		,[L].[Guid] as [ContractGuid]
		,-1 as [NewState] 

		,[I].[Name]	
		,L.[SalesMan]
		,[ContractFinishDate]
		,[Note2] 
		,L.[Purpose]
		,L.[CountOldContract]
		,(Select [ContractCount] From #CurrentContract where L.CustomerGuid = CustomerGuid and [L].ApartmentGuid = ApartmentGuid)as [CurrentContract]
		,[L].[CostGuid]
		,L.[CustAccountGuid]
		,L.[ContractJudicial]
		,[L].[Mark]
		,[L].[isAutoRenewal]
		,2 as [Kind]
		,0 as [Sort]
	from 
		#Building_CL [B]
		Inner join [vwApartmentall] [A] On [A].[BuildingGuid] = [B].[Guid]
		Inner join #LeaseApartment_CL [L] On [A].[Guid] = [L].[ApartmentGuid] and [LeaseKind]  = 2
		Inner join [Resource] [R] on [R].[Guid] = [B].[Guid]  and [R].[Kind] = 101 and [R].[spid] = @@Spid 
		--inner join [vwContractType] [T] on [T].[Guid] = [L].[TypeGuid]  
		--Inner join [Resource] [R2] on [R2].[Guid] = [T].[Guid]  and [R2].[Kind] = 100 and [R2].[spid] = @@Spid 
		Inner join [#Customer] [Cu] on [Cu].[Guid] = [L].[CustomerGuid] 
		left join #RentInfo_CL [I] on [I].[Guid] = [L].[RentInfoGuid]
	where
		([A].[FlatKind] = @FlatKind or @FlatKind = '')
		and ([A].[ApartmentType] = @ApartmentType or @ApartmentType = '')
		and (
				(
					([L].[FromDate] >= @Date1 and @Datewith  = 0)
					and ([L].[FromDate] <= @Date2 and @Datewith  = 0 or @Date2 = '12/30/1899')
					
				)
				
				or
				(
					([L].[EditDate] >= @Date1 and @Datewith  = 3)
					and ([L].[EditDate] <= @Date2 and @Datewith  = 3 or @Date2 = '12/30/1899')
				)
				or
				(
					([L].[AcquittancePrintdate] >= @Date1 and @Datewith  = 4)
					and ([L].[AcquittancePrintdate] <= @Date2 and @Datewith  = 4 or @Date2 = '12/30/1899')
				)
				
				or
				(
					([L].LeaveDate >= @Date1 and @Datewith  = 5)
					and ([L].LeaveDate <= @Date2 and @Datewith  = 5 or @Date2 = '12/30/1899')
				)

				or @CKDate = 0
			) 
		and (@EndState = 2)
		and (A.Ban = @banRealty or @banRealty = 2)

	
	-- 
	if @p_SaleShop = 1
	Insert into @Tbl 
	Select 
		[L].[ContractNo]
		,[A].[No] as [FlatNo]
		,[B].[Name] as [BuildingName]
		,[L].[Rent]
		,[L].[Rent] - [L].[DiscountValue]
		,[ShopKind] as [FlatKind]
		,A.[Description] as [FlatType]
		,Case when ([L].[ToDate] <= GetDate()) or ([L].[ContractFinish] = 1) then dbo.sc(' ')  
			  when [L].[ToDate] > GetDate() then dbo.sc('  ') end as [ContractState]
		,[B].[Emirate] as [Emirate]
		,'' as [FloorNo]
		,[Cu].[Name] as [CustName]
		,[Cu].[Mobile] as [CustPhone]
		,[Cu].[Nationality]
		,[L].[EditDate] as [ContractDateEdit]
		,[L].[FromDate] as [ContractDateBegin]
		,[L].[ToDate]as [ContractDateEnd]
		,[L].[ContractName]
		,Null as [ContractFinish]
		,[L].[Guid] as [ContractGuid]
		,-1 as [NewState] 

		,[I].[Name]	
		,L.[SalesMan]
		,[ContractFinishDate]
		,[Note2] 
		,L.[Purpose]
		,L.[CountOldContract]
		,(Select [ContractCount] From #CurrentContract where L.CustomerGuid = CustomerGuid and [L].ApartmentGuid = ApartmentGuid)as [CurrentContract]
		,[L].[CostGuid]
		,L.[CustAccountGuid]
		,L.[ContractJudicial]
		,[L].[Mark]
		,[L].[isAutoRenewal]
		,3 as [Kind]
		,0 as [Sort]
	from 
		#Building_CL [B]
		Inner join [vwShopAll] [A] On [A].[BuildingGuid] = [B].[Guid]
		Inner join #LeaseApartment_CL [L] On [A].[Guid] = [L].[ApartmentGuid] and [LeaseKind]  = 3
		Inner join [Resource] [R] on [R].[Guid] = [B].[Guid]  and [R].[Kind] = 101 and [R].[spid] = @@Spid 
		inner join [vwContractType] [T] on [T].[Guid] = [L].[TypeGuid]  
		Inner join [Resource] [R2] on [R2].[Guid] = [T].[Guid]  and [R2].[Kind] = 100 and [R2].[spid] = @@Spid 
		Inner join [#Customer] [Cu] on [Cu].[Guid] = [L].[CustomerGuid] 
		left join #RentInfo_CL [I] on [I].[Guid] = [L].[RentInfoGuid]
	where
		(
				(
					([L].[FromDate] >= @Date1 and @Datewith  = 0)
					and ([L].[FromDate] <= @Date2 and @Datewith  = 0 or @Date2 = '12/30/1899')
				)
				or
				(
					([L].[EditDate] >= @Date1 and @Datewith  = 3)
					and ([L].[EditDate] <= @Date2 and @Datewith  = 3 or @Date2 = '12/30/1899')
				)
				
				or
				(
					([L].[AcquittancePrintdate] >= @Date1 and @Datewith  = 4)
					and ([L].[AcquittancePrintdate] <= @Date2 and @Datewith  = 4 or @Date2 = '12/30/1899')
				)
				
				or
				(
					([L].LeaveDate >= @Date1 and @Datewith  = 5)
					and ([L].LeaveDate <= @Date2 and @Datewith  = 5 or @Date2 = '12/30/1899')
				)

				or @CKDate = 0
			) 

		and (@EndState = 2)
		and (A.Ban = @banRealty or @banRealty = 2)


	--
	if (@Purpose = '') and (@p_RentParking = 1)
	Insert into @Tbl 
	Select 
		[L].[ContractNo]
		,[A].[No] as [FlatNo]
		,[B].[Name] as [BuildingName]
		,[L].[Rent]
		,[L].[Rent] - 0
		,[ParkingKind] as [FlatKind]
		,A.[Description] as [FlatType]
		,Case when ([L].[ToDate] <= GetDate()) or ([L].[ContractFinish] = 1) then dbo.sc(' ')  
			  when [L].[ToDate] > GetDate() then dbo.sc('  ') end as [ContractState]
		,[B].[Emirate] as [Emirate]
		,[A].[FloorNo]
		,[Cu].[Name] as [CustName]
		,[Cu].[Mobile] as [CustPhone]
		,[Cu].[Nationality]
		,[L].[EditDate] as [ContractDateEdit]
		,[L].[FromDate] as [ContractDateBegin]
		,[L].[ToDate]as [ContractDateEnd]
		,[T].[Name]
		,[L].[ContractFinish]
		,[L].[Guid] as [ContractGuid]
		,[L].[NewState] 

		,[I].[Name]	
		,S.Name as [SalesMan]	
		,[ContractFinishDate]
		,[Note2] 
		,''
		,0 as [CountOldContract]
		,0
		,[L].[CostGuid]
		,L.[CustAccountGuid]
		,L.[Judicial]
		,[L].[Mark]
		,[L].[isAutoRenewal]

		,[R2].[spid]
		,0 as [Sort]
	from 
		#Building_CL [B]
		Inner join [vwParkingAll] [A] On [A].[BuildingGuid] = [B].[Guid]
		Inner join [vwParkingContract] [L] On [A].[Guid] = [L].[ParkingGuid]
		Inner join [Resource] [R] on [R].[Guid] = [B].[Guid]  and [R].[Kind] = 101 and [R].[spid] = @@Spid 
		inner join [vwContractType] [T] on [T].[Guid] = [L].[TypeGuid]  
		Inner join [Resource] [R2] on [R2].[Guid] = [T].[Guid]  and [R2].[Kind] = 100 and [R2].[spid] = @@Spid 
		Inner join [#Customer] [Cu] on [Cu].[Guid] = [L].[CustomerGuid] 
		left join #RentInfo_CL [I] on [I].[Guid] = [L].[RentInfoGuid]
		left join Salesman S on S.Guid = L.SalesManGuid
	where
		([L].[CustomerGuid] = @CustGuid or @CustGuid = 0x0)
		and 
			(
				((([L].[ToDate] <= GetDate()) or ([L].[ContractFinish] = 1)) and @ContractState = 0)
			  	or ([L].[ToDate] > GetDate() and @ContractState = 1)
				or @ContractState = 2
			)

		and (
				(
					([L].[FromDate] >= @Date1 and @Datewith  = 0)
					and ([L].[FromDate] <= @Date2 and @Datewith  = 0 or @Date2 = '12/30/1899')
				)
				or
				(
					([L].[ToDate] >= @Date1 and @Datewith  = 1)
					and ([L].[ToDate] <= @Date2 and @Datewith  = 1 or @Date2 = '12/30/1899')
				)

				or
				(
					([L].[ContractFinishDate] >= @Date1 and @Datewith  = 2)
					and ([L].[ContractFinishDate] <= @Date2 and @Datewith  = 2 or @Date2 = '12/30/1899')
					and ([L].[ContractFinish] = 1)
				)

				or
				(
					([L].[EditDate] >= @Date1 and @Datewith  = 3)
					and ([L].[EditDate] <= @Date2 and @Datewith  = 3 or @Date2 = '12/30/1899')
				)
				and @Datewith  <> 4 and @Datewith  <> 5

				or @CKDate = 0
			)

		and ([L].[RentInfoGuid] = @RentInfoGuid or @RentInfoGuid = 0x0)
		and ([L].[SalesManGuid] = @SalesManGuid or @SalesManGuid = 0x0)

		and ([L].[ContractFinish] = @EndState or @EndState = 2)
		and (
				([l].[Mark] = 1 and @Mark = 1)
				or ([l].[Mark] = 0 and @NotMark = 1)
			)
		and (L.PayType = @PayType or @PayType  = 4)
		and ([L].[Judicial] = @Judicial or @Judicial = 2)
		and (L.isAutoRenewal = @AutoRenewal or @AutoRenewal = 2)
		and (A.Ban = @banRealty or @banRealty = 2)

	--
	if (@p_RentLand = 1 or @p_SaleLand = 1)
	Insert into @Tbl 
	Select 
		[L].[ContractNo]
		,[A].[Name] as [FlatNo]
		,'' as [BuildingName]
		,[L].[Rent]
		,[L].[Rent] - [L].[DiscountValue]
		,'' as [FlatKind]
		,'' as [FlatType]
		,Case when ([L].[ToDate] <= GetDate()) or ([L].[ContractFinish] = 1) then dbo.sc(' ')  
			  when [L].[ToDate] > GetDate() then dbo.sc('  ') end as [ContractState]
		,'' as [Emirate]
		,'' as [FloorNo]
		,[Cu].[Name] as [CustName]
		,[Cu].[Mobile] as [CustPhone]
		,[Cu].[Nationality] 
		,[L].[EditDate] as [ContractDateEdit]
		,[L].[FromDate] as [ContractDateBegin]
		,[L].[ToDate] as [ContractDateEnd]
		,[T].[Name]
		,[ContractFinish]
		,[L].[Guid] as [ContractGuid]
		,[L].[NewState]
		,[I].[Name]
		,S.Name as [SalesMan]
		,[ContractFinishDate]
		,[Note2] 
		,L.[Purpose]
		,0 as [CountOldContract]
		,0
		,[L].[CostGuid]
		,L.[CustAccountGuid]
		,L.[Judicial]
		,[L].[Mark]
		,[L].[isAutoRenewal]
		,[R2].[spid]
		,0 as [Sort]
	from 
		[vwEarthAll] [A] 
		Inner join [vwLandContract] [L] On [A].[Guid] = [L].[LandGuid]
		inner join [vwContractType] [T] on [T].[Guid] = [L].[TypeGuid]  
		Inner join [Resource] [R2] on [R2].[Guid] = [T].[Guid]  and [R2].[Kind] = 100 and [R2].[spid] = @@Spid 
		Inner join [#Customer] [Cu] on [Cu].[Guid] = [L].[CustomerGuid] 
		left join #RentInfo_CL [I] on [I].[Guid] = [L].[RentInfoGuid]
		left join Salesman S on S.Guid = L.SalesManGuid
	where
		([L].[CustomerGuid] = @CustGuid or @CustGuid = 0x0)
		and	([L].[SalesManGuid] = @SalesManGuid or @SalesManGuid = 0x0)
		and 
			(
				((([L].[ToDate] <= GetDate()) or ([L].[ContractFinish] = 1)) and @ContractState = 0)
			  	or ([L].[ToDate] > GetDate() and @ContractState = 1)
				or @ContractState = 2
			)
		and (
				(
					([L].[FromDate] >= @Date1 and @Datewith  = 0)
					and ([L].[FromDate] <= @Date2 and @Datewith  = 0 or @Date2 = '12/30/1899')
				)
				or
				(
					([L].[ToDate] >= @Date1 and @Datewith  = 1)
					and ([L].[ToDate] <= @Date2 and @Datewith  = 1 or @Date2 = '12/30/1899')
				)

				or
				(
					([L].[ContractFinishDate] >= @Date1 and @Datewith  = 2)
					and ([L].[ContractFinishDate] <= @Date2 and @Datewith  = 2 or @Date2 = '12/30/1899')
					and ([L].[ContractFinish] = 1)
				)

				or
				(
					([L].[EditDate] >= @Date1 and @Datewith  = 3)
					and ([L].[EditDate] <= @Date2 and @Datewith  = 3 or @Date2 = '12/30/1899')
				)
				or
				(
					([L].[AcquittancePrintdate] >= @Date1 and @Datewith  = 4)
					and ([L].[AcquittancePrintdate] <= @Date2 and @Datewith  = 4 or @Date2 = '12/30/1899')
				)

				or
				(
					([L].LeaveDate >= @Date1 and @Datewith  = 5)
					and ([L].LeaveDate <= @Date2 and @Datewith  = 5 or @Date2 = '12/30/1899')
				)
				

				or @CKDate = 0
			) 

		and ([L].[ContractFinish] = @EndState or @EndState = 2)
		and (
				([l].[Mark] = 1 and @Mark = 1)
				or ([l].[Mark] = 0 and @NotMark = 1)
			)
		and (L.PayType = @PayType or @PayType  = 4)
		and ([L].[Judicial] = @Judicial or @Judicial = 2)
		and (L.Purpose = @Purpose or @Purpose = '') 
		and (l.isAutoRenewal = @AutoRenewal or @AutoRenewal = 2)
		and (A.Ban = @banRealty or @banRealty = 2)
		
	--
	if (@p_RentVilla = 1 or @p_SaleVilla = 1)
	Insert into @Tbl 
	Select 
		[L].[ContractNo]
		,[A].[Name] as [FlatNo]
		,'' as [BuildingName]
		,[L].[Rent]
		,[L].[Rent] - [L].[DiscountValue]
		,'' as [FlatKind]
		,'' as [FlatType]
		,Case when ([L].[ToDate] <= GetDate()) or ([L].[ContractFinish] = 1) then dbo.sc(' ')  
			  when [L].[ToDate] > GetDate() then dbo.sc('  ') end as [ContractState]
		,'' as [Emirate]
		,'' as [FloorNo]
		,[Cu].[Name] as [CustName]
		,[Cu].[Mobile] as [CustPhone]
		,[Cu].[Nationality]
		,[L].[EditDate] as [ContractDateEdit]
		,[L].[FromDate] as [ContractDateBegin]
		,[L].[ToDate] as [ContractDateEnd]
		,[T].[Name]
		,[ContractFinish]
		,[L].[Guid] as [ContractGuid]
		,[L].[NewState]  

		,[I].[Name]
		,S.name  as [SalesMan]
		,[ContractFinishDate]
		,[Note2] 
		,L.[Purpose]
		,0 as [CountOldContract]
		,0
		,[L].[CostGuid]
		,L.[CustAccountGuid]
		,L.[Judicial]
		,[L].[Mark]
		,[L].[isAutoRenewal]
		,[R2].[spid]
		,0 as [Sort]
	from 
		[vwVillaAll] [A] 
		Inner join [vwLandContract] [L] On [A].[Guid] = [L].[LandGuid]
		inner join [vwContractType] [T] on [T].[Guid] = [L].[TypeGuid]  
		Inner join [Resource] [R2] on [R2].[Guid] = [T].[Guid]  and [R2].[Kind] = 100 and [R2].[spid] = @@Spid 
		Inner join [#Customer] [Cu] on [Cu].[Guid] = [L].[CustomerGuid] 
		left join #RentInfo_CL [I] on [I].[Guid] = [L].[RentInfoGuid]
		left join Salesman S on S.Guid = L.SalesManGuid
	where
		([L].[CustomerGuid] = @CustGuid or @CustGuid = 0x0)
		and	([L].[SalesManGuid] = @SalesManGuid or @SalesManGuid = 0x0)
		and 
			(
				((([L].[ToDate] <= GetDate()) or ([L].[ContractFinish] = 1)) and @ContractState = 0)
			  	or ([L].[ToDate] > GetDate() and @ContractState = 1)
				or @ContractState = 2
			)
		and (
				(
					([L].[FromDate] >= @Date1 and @Datewith  = 0)
					and ([L].[FromDate] <= @Date2 and @Datewith  = 0 or @Date2 = '12/30/1899')
				)
				or
				(
					([L].[ToDate] >= @Date1 and @Datewith  = 1)
					and ([L].[ToDate] <= @Date2 and @Datewith  = 1 or @Date2 = '12/30/1899')
				)

				or
				(
					([L].[ContractFinishDate] >= @Date1 and @Datewith  = 2)
					and ([L].[ContractFinishDate] <= @Date2 and @Datewith  = 2 or @Date2 = '12/30/1899')
					and ([L].[ContractFinish] = 1)
				)

				or
				(
					([L].[EditDate] >= @Date1 and @Datewith  = 3)
					and ([L].[EditDate] <= @Date2 and @Datewith  = 3 or @Date2 = '12/30/1899')
				)
				or
				(
					([L].[AcquittancePrintdate] >= @Date1 and @Datewith  = 4)
					and ([L].[AcquittancePrintdate] <= @Date2 and @Datewith  = 4 or @Date2 = '12/30/1899')
				)
				or
				(
					([L].LeaveDate >= @Date1 and @Datewith  = 5)
					and ([L].LeaveDate <= @Date2 and @Datewith  = 5 or @Date2 = '12/30/1899')
				)

				or @CKDate = 0
			) 

		and ([L].[ContractFinish] = @EndState or @EndState = 2)
		and (
				([l].[Mark] = 1 and @Mark = 1)
				or ([l].[Mark] = 0 and @NotMark = 1)
			)
		and (L.PayType = @PayType or @PayType  = 4)
		and ([L].[Judicial] = @Judicial or @Judicial = 2)
		and (L.Purpose = @Purpose or @Purpose = '') 
		and (l.isAutoRenewal = @AutoRenewal or @AutoRenewal = 2)
		and (A.Ban = @banRealty or @banRealty = 2)

	
	if @LinkCheck = 0 --  
	Delete @Tbl
	From
		@Tbl T
		inner join [Checks] C on C.ContractGuid = T.ContractGuid
	
	if @LinkCheck = 1 --  
	Delete @Tbl
	From
		@Tbl T
		left join [Checks] C on C.ContractGuid = T.ContractGuid
	where
		C.Guid is Null

	-- 
	Select
		[P].[ContractGuid],
		Sum(IsNull([P].[Value] * [P].[CurrencyVal],0)) as [Cash]
	Into #Cash
	From
		[vwContractCachPayment] [P]
		inner join @Tbl [t] on [t].[ContractGuid] = [P].[ContractGuid] and P.AcGuid = t.AccountGuid
	Group By
		[P].[ContractGuid]	


	Select 
		MAX(p.Date) as [LastPartialCollectionDate],
		CheckGuid
	into #LastPartialCollectionDate
	from
		ChecksPartialCollection P
		inner join Checks C on C.Guid = P.CheckGuid
		inner join @Tbl [t] on [t].[ContractGuid] = [C].[ContractGuid]
	Group by
		CheckGuid
	
	-- 
	Select
		P.date as EditDate,
		P.DueDate,
		Case when CS.IsPosted = 1 then (Select Date from vwChecksCollection where Kind = 0 and [CheckGuid] = P.Guid) end as [PostDate],
		Case when CS.IsCollection = 1 then (Select Date from vwChecksCollection where Kind = 1 and [CheckGuid] = P.Guid) end as [CollectionDate],
		Case when CS.IsEndorsement = 1 then (Select Date from vwChecksCollection where Kind = 2 and [CheckGuid] = P.Guid) end as [EndorsementDate],
		Case when CS.IsReturned = 1 then (Select Date from vwChecksCollection where Kind = 3 and [CheckGuid] = P.Guid) end as [ReturnedDate],
		(Select [LastPartialCollectionDate] from #LastPartialCollectionDate where CheckGuid = p.Guid) as [LastPartialCollectionDate],
		[P].[ContractGuid],
		P.TypeName,
		p.NO,
		P.Number as CheckNumber,
		IsNull([P].[Value] * [P].[CurrencyVal],0) as [CheckValue],
		IsNull([C1].[Value] * [C1].[CurrencyVal],0) + IsNull(C4.Value,0) as [Collection],
		Case 
			when Cs.IsReturned = 1 then dbo.sc('')
			when Cs.IsEndorsement = 1 then dbo.sc('') 
			when Cs.IsCollection = 1 then dbo.sc('')
			when Cs.IsPartialCollection = 1 then dbo.sc(' ')
			when Cs.IsPosted = 1 then dbo.sc('')
		end as [CheckState]
	Into #Collection_CL
	From
		[vwChecks] [P]
		inner join vwChecksCollectionState cs on cs.CheckGuid = p.Guid
		left join [vwChecksCollection] [C1] on [C1].[CheckGuid] = [P].[Guid] and [C1].[Kind] = 1
		left join (
						Select 
							[CheckGuid],
							Sum([Value] * CurrencyVal) as [Value] 
						From
							[ChecksPartialCollection] 
						Group By
							[CheckGuid]
					) [C4] on [C4].[CheckGuid] = [P].[Guid]
		inner join @Tbl [t] on [t].[ContractGuid] = [P].[ContractGuid]

	Select
		En.AcGuid,
		SUM(En.debit - en.Credit) as [Balance]
	into #CustBalance
	From
		(Select distinct AccountGuid from @Tbl ) T
		inner join DEntry En on En.AcGuid = T.AccountGuid
	Group By
		En.AcGuid


	Declare @CheckOfContract_4 Table
	(
		[ContractNo] Varchar(256)
		,[FlatNo] Varchar(256)
		,[BuildingName] Varchar(256)
		,[Value] Float
		,[ValueAfterDiscount] Float
		,[FlatKind] Varchar(256)
		,[FlatType] Varchar(256)
		,[ContractState] Varchar(256)
		,[Emirate] Varchar(256)
		,[FloorNo] Varchar(256)
		,[CustName] Varchar(256)
		,[CustPhone] Varchar(256)
		,[CustNationality] Varchar(256)
		,[ContractDateEdit] Datetime
		,[ContractDateBegin] Datetime
		,[ContractDateEnd] Datetime
		,[ContractType] Varchar(256)
		,[ContractFinish] Bit
		,[ContractGuid] uniqueidentifier
		,[NewState] int

		,[RentMan] Varchar(256)
		,[SalesMan] Varchar(256)
		,[ContractFinishDate] Datetime
		,[Note2] Varchar(1000)
		,[Purpose] Varchar(256)
		
		,[CountOldContract] int
		,[CountCurrentContract] int
		
		,[CostGuid] uniqueidentifier
		,[AccountGuid] uniqueidentifier
		,[Judicial] Bit
		,[Mark] Bit
		,[isAutoRenewal] Bit
		,[Kind] Int
		,[Sort] int
		,[ContractFinishStr] varchar(255)
		,[NewStateStr] varchar(255)
		,[Cash] float
		,[CheckType] varchar(255)
		,[CheckNo] varchar(255)
		,[CheckNumber] int
		,[CheckValue] Float
		,[Collection] float
		,[CheckNotCollection] Float
		,[CheckState] varchar(255)
		
		,[Editdate] datetime
		,[DueDate] datetime
		,[PostDate] datetime
		,[CollectionDate] datetime
		,[EndorsementDate] datetime
		,[ReturnedDate] datetime
		,[LastPartialCollectionDate] datetime
		
		,[CustBalance] Float
	)

	insert into @CheckOfContract_4
	([ContractNo],
		[FlatNo],
		[BuildingName],
		[Value],
		[ValueAfterDiscount],
		[FlatKind],
		[FlatType],
		[ContractState],
		[Emirate],
		[FloorNo],
		[CustName],
		[CustPhone],
		[CustNationality],
		[ContractDateEdit],
		[ContractDateBegin],
		[ContractDateEnd],
		[ContractType],
		[ContractFinish],
		[ContractGuid],
		[NewState],
		[RentMan],
		[SalesMan],
		[ContractFinishDate],
		[Note2],
		[Purpose],
		[CountOldContract],
		[CountCurrentContract],
		[CostGuid],
		[AccountGuid],
		[Judicial],
		[Mark],
		[isAutoRenewal],
		[Kind],
		[Sort],
		[ContractFinishStr],
		[NewStateStr],
		[Cash],
		[CheckType],
		[CheckNo],
		[CheckNumber],
		[CheckValue],
		[Collection],
		[CheckNotCollection],
		[CheckState],

		[Editdate],
		[DueDate],
		[PostDate],
		[CollectionDate],
		[EndorsementDate],
		[ReturnedDate],
		[LastPartialCollectionDate],

		[CustBalance]
	)
	Select 
		[E].[ContractNo],
		[E].[FlatNo],
		[E].[BuildingName],
		[E].[Value],
		[E].[ValueAfterDiscount],
		[E].[FlatKind],
		[E].[FlatType],
		[E].[ContractState],
		[E].[Emirate],
		[E].[FloorNo],
		[E].[CustName],
		[E].[CustPhone],
		[E].[CustNationality],
		[E].[ContractDateEdit],
		[E].[ContractDateBegin],
		[E].[ContractDateEnd],
		[E].[ContractType],
		[E].[ContractFinish],
		[E].[ContractGuid],
		[E].[NewState],
		[E].[RentMan],
		[E].[SalesMan],
		[E].[ContractFinishDate],
		[E].[Note2],
		[E].[Purpose],
		[E].[CountOldContract],
		[E].[CountCurrentContract],
		[E].[CostGuid],
		[E].[AccountGuid],
		[E].[Judicial],
		[E].[Mark],
		[E].[isAutoRenewal],
		[E].[Kind],
		[E].[Sort],
		Case when isnUll([ContractFinish],0) = 0 then dbo.sc('') else dbo.sc('') end As [ContractFinishStr],
		
		Case when isnUll([NewState],0) = 0 then dbo.sc('') 
			 when isnUll([NewState],0) = 1 then dbo.sc('') 
		else 
			''
		end As [NewStateStr],
		
		isNull([h].[Cash],0) as [Cash],
		C.TypeName as CheckType,
		C.NO as [CheckNo],
		C.CheckNumber,
		C.CheckValue,
		isNull([C].[Collection],0) as [Collection],
		isNull([C].[CheckValue],0) - isNull([C].[Collection],0)   as [CheckNotCollection],
		c. [CheckState],

		C.[Editdate],
		C.[DueDate],
		C.[PostDate],
		C.[CollectionDate],
		C.[EndorsementDate],
		C.[ReturnedDate],
		C.[LastPartialCollectionDate],

		CAST(0 as Float) as [CustBalance]
				
	From
		@Tbl [E]
		left join #Collection_CL [C] on [E].[ContractGuid] = [C].[ContractGuid]
		left join #Cash [h] on [E].[ContractGuid] = [h].[ContractGuid]
	where
		(Isnull([E].[NewState],0) = @NewState or @NewState = 2)

	--		
	insert into @CheckOfContract_4
	([BuildingName],[ContractDateBegin],[ContractNo],
		[CustName],
		[Sort],
		[CheckType],
		[CheckValue],
		[Collection],
		[CheckNotCollection],
		[Value],
		[ValueAfterDiscount],
		[cash]
	)
	Select 
		[BuildingName],	
		[ContractDateBegin],
		[ContractNo],
		dbo.sc('') +' '+ [CustName],
		1 as [Sort],
		dbo.sc('') as [CheckType],
		Sum([CheckValue]),
		Sum([Collection]),
		Sum([CheckNotCollection]),
		[Value],
		[ValueAfterDiscount],
		[cash]
	From
		@CheckOfContract_4
	Group by
		[BuildingName],[ContractDateBegin],[ContractNo],[CustName],
		[Value],
		[ValueAfterDiscount],
		[cash]
	
	update	
		@CheckOfContract_4
	set
		custBalance = C.Balance
	From
		@CheckOfContract_4 E
		inner join #CustBalance C on C.AcGuid = E.AccountGuid 
	
	
	Select
		*
	from
		@CheckOfContract_4
	Order By 
		
		[BuildingName],[ContractDateBegin],[ContractNo],[Sort],
		[FlatNo],
		CheckNumber
		
	
		

GO

SET ANSI_NULLS, QUOTED_IDENTIFIER ON
GO

Create Procedure [dbo].[PrcStrSource1]
 
as

insert into [StrSource] 
([Ar],[En])
select  '  ','Revenues report'
 
insert into [StrSource] 
([Ar],[En])
select  ' ','Buildings report'
 
insert into [StrSource] 
([Ar],[En])
select  ' ','Reminder report'
 
insert into [StrSource] 
([Ar],[En])
select  '  ','Overdue payments report'
 
insert into [StrSource] 
([Ar],[En])
select  ' ','Customers report'
 
insert into [StrSource] 
([Ar],[En])
select  ' ','Flat report'
 
insert into [StrSource] 
([Ar],[En])
select  '     ','Leased and non-leased flats report'
 
insert into [StrSource] 
([Ar],[En])
select  '     ','Sold and unsold flats report'
 
insert into [StrSource] 
([Ar],[En])
select  '       ','Flats and Shops report'
 
insert into [StrSource] 
([Ar],[En])
select  '      ','Non-leased flats and shops report'
 
insert into [StrSource] 
([Ar],[En])
select  '     ','leased flats and shops report'
 
insert into [StrSource] 
([Ar],[En])
select  '     ','Sold flats and shops report'
 
insert into [StrSource] 
([Ar],[En])
select  '      ','Non-sold flats and shops report'
 
insert into [StrSource] 
([Ar],[En])
select  ' ','Complaints report'
 
insert into [StrSource] 
([Ar],[En])
select  ' ','Cheque Report'
 
insert into [StrSource] 
([Ar],[En])
select  ' ','Villas report'
 
insert into [StrSource] 
([Ar],[En])
select  ' ','Shops report'
 
insert into [StrSource] 
([Ar],[En])
select  ' ','Parking report'
 
insert into [StrSource] 
([Ar],[En])
select  '     ','Leased and non-leased parking report'
 
insert into [StrSource] 
([Ar],[En])
select  '  ','Reserved units report'
 
insert into [StrSource] 
([Ar],[En])
select  '  ','Remind cards report'
 
insert into [StrSource] 
([Ar],[En])
select  '  ','Contracts deposit report'
 
insert into [StrSource] 
([Ar],[En])
select  '    ','Changes report of flats rent pricing'
 
insert into [StrSource] 
([Ar],[En])
select  '   ','Changes report of flats pricing'
 
insert into [StrSource] 
([Ar],[En])
select  '    ','Changes report of flats sell pricing'
 
insert into [StrSource] 
([Ar],[En])
select  '   ','Changes report of flats pricing'
 
insert into [StrSource] 
([Ar],[En])
select  '   ','Change asset location report'
 
insert into [StrSource] 
([Ar],[En])
select  '  ','Assets inventory report'
 
insert into [StrSource] 
([Ar],[En])
select  '  ','Contract cycle report'
 
insert into [StrSource] 
([Ar],[En])
select  '   ','Cheque buildings annual report'
 
insert into [StrSource] 
([Ar],[En])
select  '  ','Buildings offers report'
 
insert into [StrSource] 
([Ar],[En])
select  '  ','Lands offers report'
 
insert into [StrSource] 
([Ar],[En])
select  '  ','Flats offers report'
 
insert into [StrSource] 
([Ar],[En])
select  '  ','Villas offers report'
 
insert into [StrSource] 
([Ar],[En])
select  '  ','Shops offers report'
 
insert into [StrSource] 
([Ar],[En])
select  '  ','Asset operations report'
 
insert into [StrSource] 
([Ar],[En])
select  '   ','Shrink database'
 
insert into [StrSource] 
([Ar],[En])
select  ' ','Maximize windows'
 
insert into [StrSource] 
([Ar],[En])
select  ' ','Situation recurrence'
 
insert into [StrSource] 
([Ar],[En])
select  ' ','Building cost'
 
insert into [StrSource] 
([Ar],[En])
select  ' ','Average price'
 
insert into [StrSource] 
([Ar],[En])
select  ' ','last price'
 
insert into [StrSource] 
([Ar],[En])
select  ' ','largest price'
 
insert into [StrSource] 
([Ar],[En])
select  ' ...','New material...'
 
insert into [StrSource] 
([Ar],[En])
select  ' ','Storekeeper'
 
insert into [StrSource] 
([Ar],[En])
select  ' ','Main Store'
 
insert into [StrSource] 
([Ar],[En])
select  '  ','Create Sub-Store'
 
insert into [StrSource] 
([Ar],[En])
select  ' ','Store card'
 
insert into [StrSource] 
([Ar],[En])
select  '','Group'
 
insert into [StrSource] 
([Ar],[En])
select  '  ','Input stock transfer types'
 
insert into [StrSource] 
([Ar],[En])
select  '  ','Output stock transfer types'
 
insert into [StrSource] 
([Ar],[En])
select  ' ','Bill number'
 
insert into [StrSource] 
([Ar],[En])
select  ' ','Bill details'
 
insert into [StrSource] 
([Ar],[En])
select  ' ','Bill type'
 
insert into [StrSource] 
([Ar],[En])
select  ' ','Currency rate'
 
insert into [StrSource] 
([Ar],[En])
select  ' ','Account name'
 
insert into [StrSource] 
([Ar],[En])
select  ' ','Store code'
 
insert into [StrSource] 
([Ar],[En])
select  ' ','Material code'
 
insert into [StrSource] 
([Ar],[En])
select  ' ','Material name'
 
insert into [StrSource] 
([Ar],[En])
select  ' ','Line unit'
 
insert into [StrSource] 
([Ar],[En])
select  ' ','Unit price'
 
insert into [StrSource] 
([Ar],[En])
select  ' ','Total price'
 
insert into [StrSource] 
([Ar],[En])
select  ' ','Line details'
 
insert into [StrSource] 
([Ar],[En])
select  '  ','Grouped by Category'
 
insert into [StrSource] 
([Ar],[En])
select  '   ','View empty materials'
 
insert into [StrSource] 
([Ar],[En])
select  '  ','Stores details'
 
insert into [StrSource] 
([Ar],[En])
select  '   ','View stocking materials'
 
insert into [StrSource] 
([Ar],[En])
select  '  ','View service materials'
 
insert into [StrSource] 
([Ar],[En])
select  '  ','Calculate quantities Group'
 
insert into [StrSource] 
([Ar],[En])
select  '  ','Calculating quantity method'
 
insert into [StrSource] 
([Ar],[En])
select  '[A]  [B]   [C]  [D] ','[A] Category [B] Length [C] Width [D] Height'
 
insert into [StrSource] 
([Ar],[En])
select  '','Check'
 
insert into [StrSource] 
([Ar],[En])
select  '  ','First period inventory'
 
insert into [StrSource] 
([Ar],[En])
select  ' ','Paste table'
 
insert into [StrSource] 
([Ar],[En])
select  ' ','Purchase bill'
 
insert into [StrSource] 
([Ar],[En])
select  ' ','Sales bill'
 
insert into [StrSource] 
([Ar],[En])
select  '  ','Purchase return bill'
 
insert into [StrSource] 
([Ar],[En])
select  '  ','Sales return bill'
 
insert into [StrSource] 
([Ar],[En])
select  '','Stock transfer'
 
insert into [StrSource] 
([Ar],[En])
select  '  ','Output from'
 
insert into [StrSource] 
([Ar],[En])
select  ' ','Input to'
 
insert into [StrSource] 
([Ar],[En])
select  '  ','load print files'
 
insert into [StrSource] 
([Ar],[En])
select  '        ','Enter print path for this type correctly'
 
insert into [StrSource] 
([Ar],[En])
select  '        ','Contract expiry date is larger than investment end date of the building'
 
insert into [StrSource] 
([Ar],[En])
select  '  ','End duration date'
 
insert into [StrSource] 
([Ar],[En])
select  '','Date'
 
insert into [StrSource] 
([Ar],[En])
select  '   ','Enter account name'
 
insert into [StrSource] 
([Ar],[En])
select  '   ','Check connection settings'
 
insert into [StrSource] 
([Ar],[En])
select  '      ','Enter correctly number of days'
 
insert into [StrSource] 
([Ar],[En])
select  '    : ','Check the path'
 
insert into [StrSource] 
([Ar],[En])
select  '  ','Verify password'
 
insert into [StrSource] 
([Ar],[En])
select  '    ','Flats rent changing'
 
insert into [StrSource] 
([Ar],[En])
select  '  ','Flats price changing'
 
insert into [StrSource] 
([Ar],[En])
select  '   ','Flat rental update'
 
insert into [StrSource] 
([Ar],[En])
select  '   ','Flat selling update'
 
insert into [StrSource] 
([Ar],[En])
select  ' ','Pricing update'
 
insert into [StrSource] 
([Ar],[En])
select  ' ','Rental update'
 
insert into [StrSource] 
([Ar],[En])
select  '  ','Tools'
 
insert into [StrSource] 
([Ar],[En])
select  '  ','Card'
 
insert into [StrSource] 
([Ar],[En])
select  '  ','Reports'
 
insert into [StrSource] 
([Ar],[En])
select  '  ','Accounts'
 
insert into [StrSource] 
([Ar],[En])
select  '   ','Maintenance'
 
insert into [StrSource] 
([Ar],[En])
select  '    ','Users'
 
insert into [StrSource] 
([Ar],[En])
select  '  ','Transactions'
 
insert into [StrSource] 
([Ar],[En])
select  '  ','Options'
 
insert into [StrSource] 
([Ar],[En])
select  '   ','General Options'
 
insert into [StrSource] 
([Ar],[En])
select  '   ','Maintenance operations'
 
insert into [StrSource] 
([Ar],[En])
select  '  ','File'
 
insert into [StrSource] 
([Ar],[En])
select  '   : ','To:'
 
insert into [StrSource] 
([Ar],[En])
select  '    : ','to date:'
 
insert into [StrSource] 
([Ar],[En])
select  '       ','Immediately send SMS when check return'
 
insert into [StrSource] 
([Ar],[En])
select  '[K]  ','[K] Closing Date'
 
insert into [StrSource] 
([Ar],[En])
select  ' ','Profits flats'
 
insert into [StrSource] 
([Ar],[En])
select  ' ','Receipts No'
 
insert into [StrSource] 
([Ar],[En])
select  '      ','Use customer account as default collection account'
 
insert into [StrSource] 
([Ar],[En])
select  '  ','Latin name contains'
 
insert into [StrSource] 
([Ar],[En])
select  '','Current'
 
insert into [StrSource] 
([Ar],[En])
select  '','Code'
 
insert into [StrSource] 
([Ar],[En])
select  '','Collected'
 
insert into [StrSource] 
([Ar],[En])
select  ' ','Vacating In'
 
insert into [StrSource] 
([Ar],[En])
select  '         ','This land consists of assembling more than one land, It''s:'
 
insert into [StrSource] 
([Ar],[En])
select  '       ','This flat consists of assembling more than one flat'
 
insert into [StrSource] 
([Ar],[En])
select  '  ','The process will be success'
 
insert into [StrSource] 
([Ar],[En])
select  ' ','Install version'
 
insert into [StrSource] 
([Ar],[En])
select  ' ','Install description'
 
insert into [StrSource] 
([Ar],[En])
select  '','Ignore'
 
insert into [StrSource] 
([Ar],[En])
select  '','Renewal'
 
insert into [StrSource] 
([Ar],[En])
select  ' ','Contract renewal'
 
insert into [StrSource] 
([Ar],[En])
select  '','Assembly'
 
insert into [StrSource] 
([Ar],[En])
select  '','Update'
 
insert into [StrSource] 
([Ar],[En])
select  '   ','Flat rental update'
 
insert into [StrSource] 
([Ar],[En])
select  ' ','Auto-Update'
 
insert into [StrSource] 
([Ar],[En])
select  ' ','Version update'
 
insert into [StrSource] 
([Ar],[En])
select  ' ','Check all'
 
insert into [StrSource] 
([Ar],[En])
select  ' ','Complaint issue date'
 
insert into [StrSource] 
([Ar],[En])
select  ' ','Contract issue'
 
insert into [StrSource] 
([Ar],[En])
select  '     ','Cost center belong to commission discount'
 
insert into [StrSource] 
([Ar],[En])
select  '      ','Cost center belong to commission client account'
 
insert into [StrSource] 
([Ar],[En])
select  '       ','Cost center belong to commission owner account'
 
insert into [StrSource] 
([Ar],[En])
select  '    ','Cost center belong to tenant account'
 
insert into [StrSource] 
([Ar],[En])
select  '      ','Cost center belong to contract termination fees account'
 
insert into [StrSource] 
([Ar],[En])
select  '','Collect'
 
insert into [StrSource] 
([Ar],[En])
select  ' ','cheque collection'
 
insert into [StrSource] 
([Ar],[En])
select  ' ','Partial collection'
 
insert into [StrSource] 
([Ar],[En])
select  '  ...','Loading libraries ...'
 
insert into [StrSource] 
([Ar],[En])
select  '    ','Language'
 
insert into [StrSource] 
([Ar],[En])
select  '','Customize'
 
insert into [StrSource] 
([Ar],[En])
select  ' ','Select path'
 
insert into [StrSource] 
([Ar],[En])
select  '  ','Select printing folder'
 
insert into [StrSource] 
([Ar],[En])
select  '  ...','Select printing folder'
 
insert into [StrSource] 
([Ar],[En])
select  ' ','Check box'
 
insert into [StrSource] 
([Ar],[En])
select  ' ','Closing File'
 
insert into [StrSource] 
([Ar],[En])
select  '  ','Close cards only'
 
insert into [StrSource] 
([Ar],[En])
select  '      ','Close all Data until the last operation date'
 
insert into [StrSource] 
([Ar],[En])
select  '        ','Close all data to specific date without move subsequent operations'
 
insert into [StrSource] 
([Ar],[En])
select  '        ','Close all data to specific date with move subsequent operations'
 
insert into [StrSource] 
([Ar],[En])
select  '   ','Reminder for all users'
 
insert into [StrSource] 
([Ar],[En])
select  '   ','Reminder for current user only'
 
insert into [StrSource] 
([Ar],[En])
select  ' ','Message Translate'
 
insert into [StrSource] 
([Ar],[En])
select  '','Post'
 
insert into [StrSource] 
([Ar],[En])
select  ' ','Post cheque'
 
insert into [StrSource] 
([Ar],[En])
select  '   ','Post journal entry automatically'
 
insert into [StrSource] 
([Ar],[En])
select  ' ','Municipal licensing'
 
insert into [StrSource] 
([Ar],[En])
select  '   ','Municipality license to date'
 
insert into [StrSource] 
([Ar],[En])
select  '   ','Municipality license from date'
 
insert into [StrSource] 
([Ar],[En])
select  '  ','Civil defense licensing'
 
insert into [StrSource] 
([Ar],[En])
select  '    ','Civil defense license to date'
 
insert into [StrSource] 
([Ar],[En])
select  '    ','Civil defense license from date'
 
insert into [StrSource] 
([Ar],[En])
select  ' ','Login'
 
insert into [StrSource] 
([Ar],[En])
select  ' ','Generate notes'
 
insert into [StrSource] 
([Ar],[En])
select  '','Ascending'
 
insert into [StrSource] 
([Ar],[En])
select  ' txt','Export to TXT'
 
insert into [StrSource] 
([Ar],[En])
select  ' xls ...','Export to xls...'
 
insert into [StrSource] 
([Ar],[En])
select  '  ','Export to excel file'
 
insert into [StrSource] 
([Ar],[En])
select  ' ','Contract registration'
 
insert into [StrSource] 
([Ar],[En])
select  '  ','Filter report by'
 
insert into [StrSource] 
([Ar],[En])
select  '','Design'
 
insert into [StrSource] 
([Ar],[En])
select  '','Relief'
 
insert into [StrSource] 
([Ar],[En])
select  '  ','Include partial collection'
 
insert into [StrSource] 
([Ar],[En])
select  '','Apply'
 
insert into [StrSource] 
([Ar],[En])
select  ' ','Real estate development'
 
insert into [StrSource] 
([Ar],[En])
select  '','Endorsement'
 
insert into [StrSource] 
([Ar],[En])
select  ' ','Cheque endorsement'
 
insert into [StrSource] 
([Ar],[En])
select  '','Modify'
 
insert into [StrSource] 
([Ar],[En])
select  ' ','Modify data'
 
insert into [StrSource] 
([Ar],[En])
select  ' ','Modify checked'
 
insert into [StrSource] 
([Ar],[En])
select  '  ','Modify others reminders'
 
insert into [StrSource] 
([Ar],[En])
select  '      ','Signed contract has been received from both sides'
 
insert into [StrSource] 
([Ar],[En])
select  '     ','Last backup was taken since'
 
insert into [StrSource] 
([Ar],[En])
select  '  ','Revenue fee account'
 
insert into [StrSource] 
([Ar],[En])
select  '   ','Contract registration revenue account'
 
insert into [StrSource] 
([Ar],[En])
select  '   ','Contract price revenue account'
 
insert into [StrSource] 
([Ar],[En])
select  '','Lawsuit'
 
insert into [StrSource] 
([Ar],[En])
select  ' ','Evacuation request'
 
insert into [StrSource] 
([Ar],[En])
select  '    ','Contract No. in old files'
 
insert into [StrSource] 
([Ar],[En])
select  '  ','Licensed to '
 
insert into [StrSource] 
([Ar],[En])
select  '  ','Modify contract price'
 
insert into [StrSource] 
([Ar],[En])
select  '   ','Modify flat cost price'
 
insert into [StrSource] 
([Ar],[En])
select  '  ','Edit branch permissions'
 
insert into [StrSource] 
([Ar],[En])
select  '        ','Modify delay fee value'
 
insert into [StrSource] 
([Ar],[En])
select  '  ','Modify commission'
 
insert into [StrSource] 
([Ar],[En])
select  '  ','Change rental rates'
 
insert into [StrSource] 
([Ar],[En])
select  '  ','Change sell rates'
 
insert into [StrSource] 
([Ar],[En])
select  '  1','Update 1st Price'
 
insert into [StrSource] 
([Ar],[En])
select  '  2','Update 2nd Price'
 
insert into [StrSource] 
([Ar],[En])
select  '  3','Update 3rd Price'
 
insert into [StrSource] 
([Ar],[En])
select  '  ','Change sell rate'
 
insert into [StrSource] 
([Ar],[En])
select  '  ','Change asset location'
 
insert into [StrSource] 
([Ar],[En])
select  ' ','Change user'
 
insert into [StrSource] 
([Ar],[En])
select  '  ','Update price to'
 
insert into [StrSource] 
([Ar],[En])
select  '  ','Update every price to'
 
insert into [StrSource] 
([Ar],[En])
select  '  ','Change password'
 
insert into [StrSource] 
([Ar],[En])
select  '  ','Change printing folder'
 
insert into [StrSource] 
([Ar],[En])
select  '','Reports'
 
insert into [StrSource] 
([Ar],[En])
select  ' 1','Detailed 1'
 
insert into [StrSource] 
([Ar],[En])
select  ' 2','Detailed 2'
 
insert into [StrSource] 
([Ar],[En])
select  ' 3','Detailed 3'
 
insert into [StrSource] 
([Ar],[En])
select  ' 4','Detailed 4'
 
insert into [StrSource] 
([Ar],[En])
select  '','Activate'
 
insert into [StrSource] 
([Ar],[En])
select  '  ','Active contract types'
 
insert into [StrSource] 
([Ar],[En])
select  ' ','Active buildings'
 
insert into [StrSource] 
([Ar],[En])
select  ' ','Active date'
 
insert into [StrSource] 
([Ar],[En])
select  ' ','Active No.'
 
insert into [StrSource] 
([Ar],[En])
select  '      ','Active others operations of the check when it is return'
 
insert into [StrSource] 
([Ar],[En])
select  ' ','Activate Branch System'
 
insert into [StrSource] 
([Ar],[En])
select  '  ','Activate log file'
 
insert into [StrSource] 
([Ar],[En])
select  '  ','Activate log window'
 
insert into [StrSource] 
([Ar],[En])
select  '','Reports'
 
insert into [StrSource] 
([Ar],[En])
select  ' SMS','SMS Reports'
 
insert into [StrSource] 
([Ar],[En])
select  ' ','Statistical reports'
 
insert into [StrSource] 
([Ar],[En])
select  '  ','Revenue reports'
 
insert into [StrSource] 
([Ar],[En])
select  '   ','Offers reports'
 
insert into [StrSource] 
([Ar],[En])
select  ' ','Contract reports'
 
insert into [StrSource] 
([Ar],[En])
select  '    ','Stores report'
 
insert into [StrSource] 
([Ar],[En])
select  '      ','Realty units reports'
 
insert into [StrSource] 
([Ar],[En])
select  '  ','Flats revenue report'
 
insert into [StrSource] 
([Ar],[En])
select  '  SMS','SMS send report'
 
insert into [StrSource] 
([Ar],[En])
select  '  ','Maintenance orders report'
 
insert into [StrSource] 
([Ar],[En])
select  ' ','Lands report'
 
insert into [StrSource] 
([Ar],[En])
select  '  ','Note papers report'
 
insert into [StrSource] 
([Ar],[En])
select  '   ','Due note papers report'
 
insert into [StrSource] 
([Ar],[En])
select  '   ','Program will restart'
 
insert into [StrSource] 
([Ar],[En])
select  '    ','Journal entry will have new number'
 
insert into [StrSource] 
([Ar],[En])
select  '     ','All opened windows will closed'
 
insert into [StrSource] 
([Ar],[En])
select  '      ','All users will be stop working'
 
insert into [StrSource] 
([Ar],[En])
select  '          ','Last contract amount will be placed in flats rent changing'
 
insert into [StrSource] 
([Ar],[En])
select  '     ','SMS will be sent to each selected customer'
 
insert into [StrSource] 
([Ar],[En])
select  '  ','window will be closed'
 
insert into [StrSource] 
([Ar],[En])
select  ' ','Contract will be renewed'
 
insert into [StrSource] 
([Ar],[En])
select  '       
  ','All prices of selected units wil be updated
Do you want to continue?'
 
insert into [StrSource] 
([Ar],[En])
select  '      ','All prices of selected building units wil be updated'
 
insert into [StrSource] 
([Ar],[En])
select  '      
  ','All prices of selected building units wil be updated
Do you want to continue?
'
 
insert into [StrSource] 
([Ar],[En])
select  '      ','Process will be implemented and will not be able to undo'
 
insert into [StrSource] 
([Ar],[En])
select  '       ','All related cheque will be deleted'
 
insert into [StrSource] 
([Ar],[En])
select  '    ','This process will publish user permissions'
 
insert into [StrSource] 
([Ar],[En])
select  '   ','This process will move all cards'
 
insert into [StrSource] 
([Ar],[En])
select  '     ','This process will stop dealing with the current data'
 
insert into [StrSource] 
([Ar],[En])
select  '       ','Balance will be different according to specific sorting'
 
insert into [StrSource] 
([Ar],[En])
select  '         ','This wizard will help you to close the file in an easy and safe way'
 
insert into [StrSource] 
([Ar],[En])
select  '','Purchase '
 
insert into [StrSource] 
([Ar],[En])
select  '','Company'
 
insert into [StrSource] 
([Ar],[En])
select  ' ','Payment terms'
 
insert into [StrSource] 
([Ar],[En])
select  ' ','Contract terms'
 
insert into [StrSource] 
([Ar],[En])
select  ' ','Amount terms'
 
insert into [StrSource] 
([Ar],[En])
select  ' ','Remind bar'
 
insert into [StrSource] 
([Ar],[En])
select  ' ','Remind bar'
 
insert into [StrSource] 
([Ar],[En])
select  '','Flat'
 
insert into [StrSource] 
([Ar],[En])
select  ' ','Assemblage flat'
 
insert into [StrSource] 
([Ar],[En])
select  ' ','Building flats'
 
insert into [StrSource] 
([Ar],[En])
select  ' ','Servants flats'
 
insert into [StrSource] 
([Ar],[En])
select  ' ','Drivers flats'
 
insert into [StrSource] 
([Ar],[En])
select  ' ','Building flats'
 
insert into [StrSource] 
([Ar],[En])
select  '   ','Building shops / flats'
 
insert into [StrSource] 
([Ar],[En])
select  ' ','Maintenance complaint'
 
insert into [StrSource] 
([Ar],[En])
select  '','Month'
 
insert into [StrSource] 
([Ar],[En])
select  '','Monthly'
 
insert into [StrSource] 
([Ar],[En])
select  '','cheque'
 
insert into [StrSource] 
([Ar],[En])
select  '  ','Cheque paid to'
 
insert into [StrSource] 
([Ar],[En])
select  '  ','Cheque received from'
 
insert into [StrSource] 
([Ar],[En])
select  '','Cheques'
 
insert into [StrSource] 
([Ar],[En])
select  '  ','cheques by plan'
 
insert into [StrSource] 
([Ar],[En])
select  ' ','Payable cheques'
 
insert into [StrSource] 
([Ar],[En])
select  ' ','Recievable cheques'
 
insert into [StrSource] 
([Ar],[En])
select  ' ','Due cheques'
 
insert into [StrSource] 
([Ar],[En])
select  ' ','Property owner'
 
insert into [StrSource] 
([Ar],[En])
select  '  ','Net due amount'
 
insert into [StrSource] 
([Ar],[En])
select  '    / ','Net due amount to Owner / Customer'
 
insert into [StrSource] 
([Ar],[En])
select  '  ','Net due amount for customer'
 
insert into [StrSource] 
([Ar],[En])
select  ' ','Card pages'
 
insert into [StrSource] 
([Ar],[En])
select  ' ','Branches permissions'
 
insert into [StrSource] 
([Ar],[En])
select  ' ','Menu permissions'
 
insert into [StrSource] 
([Ar],[En])
select  ' ','P.O.Box'
 
insert into [StrSource] 
([Ar],[En])
select  ' ','P.O.Box'
 
insert into [StrSource] 
([Ar],[En])
select  '','Photos'
 
insert into [StrSource] 
([Ar],[En])
select  '','File maintenance'
 
insert into [StrSource] 
([Ar],[En])
select  ' ','Asset maintenance'
 
insert into [StrSource] 
([Ar],[En])
select  '  ','Included previous years'
 
insert into [StrSource] 
([Ar],[En])
select  ' ','Mizanin floor'
 
insert into [StrSource] 
([Ar],[En])
select  '','Print'
 
insert into [StrSource] 
([Ar],[En])
select  ' ','Print receipt'
 
insert into [StrSource] 
([Ar],[En])
select  ' ','Print warning'
 
insert into [StrSource] 
([Ar],[En])
select  ' ','Print reciept'
 
insert into [StrSource] 
([Ar],[En])
select  '  ','Print clearance'
 
insert into [StrSource] 
([Ar],[En])
select  ' ','Villa details'
 
insert into [StrSource] 
([Ar],[En])
select  ' ','Note details'
 
insert into [StrSource] 
([Ar],[En])
select  ' ','Flat details'
 
insert into [StrSource] 
([Ar],[En])
select  ' ','Complaint details'
 
insert into [StrSource] 
([Ar],[En])
select  '  ','Villa exterior details'
 
insert into [StrSource] 
([Ar],[En])
select  '  ','Villa interior details'
 
insert into [StrSource] 
([Ar],[En])
select  ' ','Sponser data'
 
insert into [StrSource] 
([Ar],[En])
select  ' ','Parking data'
 
insert into [StrSource] 
([Ar],[En])
select  '  1','Peronal data 1'
 
insert into [StrSource] 
([Ar],[En])
select  '  2','Peronal data 2'
 
insert into [StrSource] 
([Ar],[En])
select  '','Sell'
 
insert into [StrSource] 
([Ar],[En])
select  ' ','Flat Selling'
 
insert into [StrSource] 
([Ar],[En])
select  ' ','Shop Selling'
 
insert into [StrSource] 
([Ar],[En])
select  '','Between'
 
insert into [StrSource] 
([Ar],[En])
select  '     ','Make sure you enter the date correctly'
 
insert into [StrSource] 
([Ar],[En])
select  '     ','Make sure you enter the amounts correctly'
 
insert into [StrSource] 
([Ar],[En])
select  '   ','Make sure to enter percentages'
 
insert into [StrSource] 
([Ar],[En])
select  '        ','Make sure you do not add duplicate flat to the same building'
 
insert into [StrSource] 
([Ar],[En])
select  '        ','Make sure you do not add duplicate warehouses for the same building'
 
insert into [StrSource] 
([Ar],[En])
select  '   ','Check termination date'
 
insert into [StrSource] 
([Ar],[En])
select  '   ','Check the password'
 
insert into [StrSource] 
([Ar],[En])
select  '   ','Make sure the program is exist'
 
insert into [StrSource] 
([Ar],[En])
select  '  ','Current contract deposit'
 
insert into [StrSource] 
([Ar],[En])
select  '  ','Previous contract deposit'
 
insert into [StrSource] 
([Ar],[En])
select  ' ','Electicity deposit'
 
insert into [StrSource] 
([Ar],[En])
select  ' ','Contracts deposit report'
 
insert into [StrSource] 
([Ar],[En])
select  '','Date'
 
insert into [StrSource] 
([Ar],[En])
select  '   ','Last payment date'
 
insert into [StrSource] 
([Ar],[En])
select  '   ','Last due payment date'
 
insert into [StrSource] 
([Ar],[En])
select  '  ','Building investment date'
 
insert into [StrSource] 
([Ar],[En])
select  '  ','Payment due date'
 
insert into [StrSource] 
([Ar],[En])
select  '    ','Maintenance order closing date'
 
insert into [StrSource] 
([Ar],[En])
select  '  ','Residence end date'
 
insert into [StrSource] 
([Ar],[En])
select  '   ','Booking end date specified'
 
insert into [StrSource] 
([Ar],[En])
select  '  ','Date of expiration'
 
insert into [StrSource] 
([Ar],[En])
select  '  ','Booking termination date'
 
insert into [StrSource] 
([Ar],[En])
select  '  ','Contract termination date'
 
insert into [StrSource] 
([Ar],[En])
select  '        ','Contract termination date is smaller than contract start date'
 
insert into [StrSource] 
([Ar],[En])
select  '      ','Contract termination date before strarting date'
 
insert into [StrSource] 
([Ar],[En])
select  '  ','First installment date'
 
insert into [StrSource] 
([Ar],[En])
select  ' ','Evacuation date'
 
insert into [StrSource] 
([Ar],[En])
select  ' ','Input date'
 
insert into [StrSource] 
([Ar],[En])
select  ' ','Return date'
 
insert into [StrSource] 
([Ar],[En])
select  ' ','Due date'
 
insert into [StrSource] 
([Ar],[En])
select  ' ','Received date'
 
insert into [StrSource] 
([Ar],[En])
select  ' ','Closing date'
 
insert into [StrSource] 
([Ar],[En])
select  ' ','Production date'
 
insert into [StrSource] 
([Ar],[En])
select  ' ','Expire Date'
 
insert into [StrSource] 
([Ar],[En])
select  '  ','Termination date specific'
 
insert into [StrSource] 
([Ar],[En])
select  ' ','Return date'
 
insert into [StrSource] 
([Ar],[En])
select  ' ','Due date'
 
insert into [StrSource] 
([Ar],[En])
select  '  ','Expected completion date'
 
insert into [StrSource] 
([Ar],[En])
select  '     ','Start date is larger than the expiration date'
 
insert into [StrSource] 
([Ar],[En])
select  ' ','Start Date'
 
insert into [StrSource] 
([Ar],[En])
select  ' ','Selling date'
 
insert into [StrSource] 
([Ar],[En])
select  ' ','Issue date'
 
insert into [StrSource] 
([Ar],[En])
select  ' ','Collect date'
 
insert into [StrSource] 
([Ar],[En])
select  ' ','Reminder date'
 
insert into [StrSource] 
([Ar],[En])
select  ' ','Deposit date'
 
insert into [StrSource] 
([Ar],[En])
select  ' ','Endorsement date'
 
insert into [StrSource] 
([Ar],[En])
select  ' ','Booking date'
 
insert into [StrSource] 
([Ar],[En])
select  ' ','Leaving date'
 
insert into [StrSource] 
([Ar],[En])
select  ' ','Joining date'
 
insert into [StrSource] 
([Ar],[En])
select  ' ','Payment date'
 
insert into [StrSource] 
([Ar],[En])
select  ' ','Entry date'
 
insert into [StrSource] 
([Ar],[En])
select  ' ','Shipping date'
 
insert into [StrSource] 
([Ar],[En])
select  ' ','Purchase date'
 
insert into [StrSource] 
([Ar],[En])
select  '  ','Joining date'
 
insert into [StrSource] 
([Ar],[En])
select  ' ','Contract date'
 
insert into [StrSource] 
([Ar],[En])
select  ' ','Operation date'
 
insert into [StrSource] 
([Ar],[En])
select  ' ','Date of birth'
 
insert into [StrSource] 
([Ar],[En])
select  ' ','Expire Date'
 
insert into [StrSource] 
([Ar],[En])
select  ' ','Arrive date'
 
insert into [StrSource] 
([Ar],[En])
select  '   ','Expiry passport date'
 
insert into [StrSource] 
([Ar],[En])
select  '  ','Warranty start date'
 
insert into [StrSource] 
([Ar],[En])
select  '  ','Investment starting date'
 
insert into [StrSource] 
([Ar],[En])
select  '  ','Depreciation starting date'
 
insert into [StrSource] 
([Ar],[En])
select  '  ','Maintenance starting date'
 
insert into [StrSource] 
([Ar],[En])
select  '  ','Contract starting date'
 
insert into [StrSource] 
([Ar],[En])
select  '       !','Contract starting date is larger than investment starting date'
 
insert into [StrSource] 
([Ar],[En])
select  '  ','Start duration date'
 
insert into [StrSource] 
([Ar],[En])
select  '  ','Warn printing date'
 
insert into [StrSource] 
([Ar],[En])
select  '  ','Maintenance contract starting date'
 
insert into [StrSource] 
([Ar],[En])
select  '  ','Investment expiry date'
 
insert into [StrSource] 
([Ar],[En])
select  '  ','Contract expiry date'
 
insert into [StrSource] 
([Ar],[En])
select  '        ','Contract expiry date is larger than investment end date of the land'
 
insert into [StrSource] 
([Ar],[En])
select  ' ','Various offers'
 
insert into [StrSource] 
([Ar],[En])
select  '','Bold'
 
insert into [StrSource] 
([Ar],[En])
select  ' ','Land contract'
 
insert into [StrSource] 
([Ar],[En])
select  '  ','Land rent contract'
 
insert into [StrSource] 
([Ar],[En])
select  '  ','Flat rent contract'
 
insert into [StrSource] 
([Ar],[En])
select  '  ','Villa rent contract'
 
insert into [StrSource] 
([Ar],[En])
select  '  ','Shop rent contract'
 
insert into [StrSource] 
([Ar],[En])
select  '  ','Parking rent contract'
 
insert into [StrSource] 
([Ar],[En])
select  ' ','Maintenance contract'
 
insert into [StrSource] 
([Ar],[En])
select  '  ','Flat rent contract'
 
insert into [StrSource] 
([Ar],[En])
select  '  ','Shop rent rontract'
 
insert into [StrSource] 
([Ar],[En])
select  '  ','Parking rent contract'
 
insert into [StrSource] 
([Ar],[En])
select  '  ','Land selling contract'
 
insert into [StrSource] 
([Ar],[En])
select  '  ','Flat selling contract'
 
insert into [StrSource] 
([Ar],[En])
select  '  ','Villa selling contract'
 
insert into [StrSource] 
([Ar],[En])
select  '  ','Shop selling contract'
 
insert into [StrSource] 
([Ar],[En])
select  '  ','Parking selling contract'
 
insert into [StrSource] 
([Ar],[En])
select  ' ','Parking contract'
 
insert into [StrSource] 
([Ar],[En])
select  '   ','Rent contracts'
 
insert into [StrSource] 
([Ar],[En])
select  '   ','Selling contracts'
 
insert into [StrSource] 
([Ar],[En])
select  '  ','Related parking contracts'
 
insert into [StrSource] 
([Ar],[En])
select  '  ','Lawsuit'
 
insert into [StrSource] 
([Ar],[En])
select  '  ','Lawsuit'
 
insert into [StrSource] 
([Ar],[En])
select  ' ','Maintenance workers'
 
insert into [StrSource] 
([Ar],[En])
select  ' ','Asset age'
 
insert into [StrSource] 
([Ar],[En])
select  '  ','Notes operations'
 
insert into [StrSource] 
([Ar],[En])
select  ' ','Maintenance operations'
 
insert into [StrSource] 
([Ar],[En])
select  '','Vertical'
 
insert into [StrSource] 
([Ar],[En])
select  ' ','Service commission'
 
insert into [StrSource] 
([Ar],[En])
select  ' ','Map element'
 
insert into [StrSource] 
([Ar],[En])
select  ' ','Customer address'
 
insert into [StrSource] 
([Ar],[En])
select  ' ','Delay fees'
 
insert into [StrSource] 
([Ar],[En])
select  '        ','Automatically send SMS before contract expiration'
 
insert into [StrSource] 
([Ar],[En])
select  ' ','Shortcuts'
 
insert into [StrSource] 
([Ar],[En])
select  ' ','Tools'
 
insert into [StrSource] 
([Ar],[En])
select  '   SMS','SMS'
 
insert into [StrSource] 
([Ar],[En])
select  '   ','in addition to'
 
insert into [StrSource] 
([Ar],[En])
select  '   ','Reset Location'
 
insert into [StrSource] 
([Ar],[En])
select  '       ','Add value to the installment due after Flat Sale'
 
insert into [StrSource] 
([Ar],[En])
select  '        ','Wrong username or password'
 
insert into [StrSource] 
([Ar],[En])
select  '  ','General Options'
 
insert into [StrSource] 
([Ar],[En])
select  ' ','Flat'
 
insert into [StrSource] 
([Ar],[En])
select  '  ','Previous contracts'
 
insert into [StrSource] 
([Ar],[En])
select  '   ','Calculate quantity groups'
 
insert into [StrSource] 
([Ar],[En])
select  '        ','Demo version you can''t access this database'
 
insert into [StrSource] 
([Ar],[En])
select  '  ','To:'
 
insert into [StrSource] 
([Ar],[En])
select  '    ','You must install new version'
 
insert into [StrSource] 
([Ar],[En])
select  '&','&Modify'
 
insert into [StrSource] 
([Ar],[En])
select  '& ','&Save'
 
insert into [StrSource] 
([Ar],[En])
select  '[A]   ','[A] Arabic Customer Name'
 
insert into [StrSource] 
([Ar],[En])
select  '[A] ','[A] Account'
 
insert into [StrSource] 
([Ar],[En])
select  '[A]  ','[A] Entry Date'
 
insert into [StrSource] 
([Ar],[En])
select  '[A]  ','[A] CheckNo'
 
insert into [StrSource] 
([Ar],[En])
select  '[B]   ','[B] Latin Customer Name'
 
insert into [StrSource] 
([Ar],[En])
select  '[B]  ','[B] Obverse Account'
 
insert into [StrSource] 
([Ar],[En])
select  '[B]    ','[B] Entry Card No'
 
insert into [StrSource] 
([Ar],[En])
select  '[B]  ','[B] Check Value'
 
insert into [StrSource] 
([Ar],[En])
select  '[C] ','[C] Value'
 
insert into [StrSource] 
([Ar],[En])
select  '[C]  ','[C] Due Date'
 
insert into [StrSource] 
([Ar],[En])
select  '[C]  ','[C] Flat Number'
 
insert into [StrSource] 
([Ar],[En])
select  '[C]    ','[C] Complaint No'
 
insert into [StrSource] 
([Ar],[En])
select  '[C]  ','[C] Property No.'
 
insert into [StrSource] 
([Ar],[En])
select  '[C]   ','[C] ChequeValue'
 
insert into [StrSource] 
([Ar],[En])
select  '[C] ','[C] Debit'
 
insert into [StrSource] 
([Ar],[En])
select  '[D]   ','[D] Building Arabic Name'
 
insert into [StrSource] 
([Ar],[En])
select  '[D]  ','[D] Bank Name'
 
insert into [StrSource] 
([Ar],[En])
select  '[D] ','[D] Credit'
 
insert into [StrSource] 
([Ar],[En])
select  '[D]    ','[D] Complaint Date'
 
insert into [StrSource] 
([Ar],[En])
select  '[D]   ','[D] Maintenance Order No'
 
insert into [StrSource] 
([Ar],[En])
select  '[D]   ','[D] Cheque No'
 
insert into [StrSource] 
([Ar],[En])
select  '[D]  ','[D] Contract No'
 
insert into [StrSource] 
([Ar],[En])
select  '[E]   ','[E]  Building Latin Name'
 
insert into [StrSource] 
([Ar],[En])
select  '[E]   ','[E] Recipient Name'
 
insert into [StrSource] 
([Ar],[En])
select  '[E]    ','[E] Arabic Building Name'
 
insert into [StrSource] 
([Ar],[En])
select  '[E]    ','[E] Bank Name'
 
insert into [StrSource] 
([Ar],[En])
select  '[E] ','[E] Number'
 
insert into [StrSource] 
([Ar],[En])
select  '[E]  ','[E] Entry Details'
 
insert into [StrSource] 
([Ar],[En])
select  '[F]    ','[F] Latin Building Name'
 
insert into [StrSource] 
([Ar],[En])
select  '[F]  ','[F] Line Details'
 
insert into [StrSource] 
([Ar],[En])
select  '[F]  ','[F] Due Date'
 
insert into [StrSource] 
([Ar],[En])
select  '[F]   ','[F] Due Date'
 
insert into [StrSource] 
([Ar],[En])
select  '[F]  ','[F] Issue Date'
 
insert into [StrSource] 
([Ar],[En])
select  '[G]   ','[G] Payee name'
 
insert into [StrSource] 
([Ar],[En])
select  '[G]   ','[G] Entry Account Name'
 
insert into [StrSource] 
([Ar],[En])
select  '[G]   ','[G] Worker Name'
 
insert into [StrSource] 
([Ar],[En])
select  '[G]   ','[G] Contract expiry date'
 
insert into [StrSource] 
([Ar],[En])
select  '[G]   ','[G] Contract Starting Date'
 
insert into [StrSource] 
([Ar],[En])
select  ' ','Return fee'
 
insert into [StrSource] 
([Ar],[En])
select  ' ','Delay fees'
 
insert into [StrSource] 
([Ar],[En])
select  '  ','Returned cheque fees'
 
insert into [StrSource] 
([Ar],[En])
select  '','Return fee'
 
insert into [StrSource] 
([Ar],[En])
select  ' ','Non-leased'
 
insert into [StrSource] 
([Ar],[En])
select  ' ','Unsold'
 
insert into [StrSource] 
([Ar],[En])
select  ' ','Un-collected'
 
insert into [StrSource] 
([Ar],[En])
select  ' ','Un-blocking'
 
insert into [StrSource] 
([Ar],[En])
select  ' ','Not returned'
 
insert into [StrSource] 
([Ar],[En])
select  '  / ','Not deposit \ Value'
 
insert into [StrSource] 
([Ar],[En])
select  ' ','Un-finished'
 
insert into [StrSource] 
([Ar],[En])
select  '  ','Unable to return'
 
insert into [StrSource] 
([Ar],[En])
select  '  ','Unable to collect'
 
insert into [StrSource] 
([Ar],[En])
select  '  ','Unable to deposit'
 
insert into [StrSource] 
([Ar],[En])
select  '  ','Unable to endorsement'
 
insert into [StrSource] 
([Ar],[En])
select  ' ','Non-leased'
 
insert into [StrSource] 
([Ar],[En])
select  ' ','Non-leased'
 
insert into [StrSource] 
([Ar],[En])
select  ' ','Not sold'
 
insert into [StrSource] 
([Ar],[En])
select  ' ','Uncollected'
 
insert into [StrSource] 
([Ar],[En])
select  '  ','It is already not collected'
 
insert into [StrSource] 
([Ar],[En])
select  ' ','Not returned'
 
insert into [StrSource] 
([Ar],[En])
select  '  ','It is already not returned'
 
insert into [StrSource] 
([Ar],[En])
select  ' ','Not posted'
 
insert into [StrSource] 
([Ar],[En])
select  '  ','It is already not posted'
 
insert into [StrSource] 
([Ar],[En])
select  '  ','Not posted to bank'
 
insert into [StrSource] 
([Ar],[En])
select  '  ','Not posted to bank'
 
insert into [StrSource] 
([Ar],[En])
select  '  ','It is already not endorsed'
 
insert into [StrSource] 
([Ar],[En])
select  ' ','Not endorsed'
 
insert into [StrSource] 
([Ar],[En])
select  ' ','valid'
 
insert into [StrSource] 
([Ar],[En])
select  '  ','Not expired'
 
insert into [StrSource] 
([Ar],[En])
select  ' ','Not available'
 
insert into [StrSource] 
([Ar],[En])
select  ' ','Electricity bill'
 
insert into [StrSource] 
([Ar],[En])
select  '','Fax'
 
insert into [StrSource] 
([Ar],[En])
select  '','Open'
 
insert into [StrSource] 
([Ar],[En])
select  ' ','Settings'
 
insert into [StrSource] 
([Ar],[En])
select  ' ','Open data'
 
insert into [StrSource] 
([Ar],[En])
select  '  ','Open chart of account'
 
insert into [StrSource] 
([Ar],[En])
select  '   ','Open chart of cost center'
 
insert into [StrSource] 
([Ar],[En])
select  '   : ','Revenue calculate period:'
 
insert into [StrSource] 
([Ar],[En])
select  '','Person'
 
insert into [StrSource] 
([Ar],[En])
select  '    ','Force filling details for each line'
 
insert into [StrSource] 
([Ar],[En])
select  '     ','Force filling cost center for each line'
 
insert into [StrSource] 
([Ar],[En])
select  '  ','Currency rate differences'
 
insert into [StrSource] 
([Ar],[En])
select  ' ','Electricity bills'
 
insert into [StrSource] 
([Ar],[En])
select  ' ','Electricity bills'
 
insert into [StrSource] 
([Ar],[En])
select  '[G]   ','[G] Flat No'
 
insert into [StrSource] 
([Ar],[En])
select  '[H]  ','[H] Building Name'
 
insert into [StrSource] 
([Ar],[En])
select  '[H]   ','[H] Line Account Name'
 
insert into [StrSource] 
([Ar],[En])
select  '[H]   ','[H] Status'
 
insert into [StrSource] 
([Ar],[En])
select  '[H]   ','[H] Contract End Date'
 
insert into [StrSource] 
([Ar],[En])
select  '[H]  ','[H] Property No.'
 
insert into [StrSource] 
([Ar],[En])
select  '[H]    ','[H] Contract No'
 
insert into [StrSource] 
([Ar],[En])
select  '[H]      ','[H] Worker Mobile No'
 
insert into [StrSource] 
([Ar],[En])
select  '[I]    ','[I] Arabic Building Name'
 
insert into [StrSource] 
([Ar],[En])
select  '[I]    ','[I] Expected completion date'
 
insert into [StrSource] 
([Ar],[En])
select  '[J]    ','[J] Latin Building Name'
 
insert into [StrSource] 
([Ar],[En])
select  '[J]  ','[J] Flat No.'
 
insert into [StrSource] 
([Ar],[En])
select  '[J]  ','[J] Maintenance Starting Date'
 
insert into [StrSource] 
([Ar],[En])
select  '[J]  ','[J] Maintenance Starting Date'
 
insert into [StrSource] 
([Ar],[En])
select  '[K]  ','[K] Return Date'
 
insert into [StrSource] 
([Ar],[En])
select  '','Building'
 
insert into [StrSource] 
([Ar],[En])
select  '','Building'
 
insert into [StrSource] 
([Ar],[En])
select  ' ','Pent house'
 
insert into [StrSource] 
([Ar],[En])
select  ' ','Land details'
 
insert into [StrSource] 
([Ar],[En])
select  ' ','Account notes'
 
insert into [StrSource] 
([Ar],[En])
select  '  ','Obverse account notes'
 
insert into [StrSource] 
([Ar],[En])
select  ' ','Journal entry details'
 
insert into [StrSource] 
([Ar],[En])
select  ' ','Property details'
 
insert into [StrSource] 
([Ar],[En])
select  ' ','Contract details'
 
insert into [StrSource] 
([Ar],[En])
select  ' ','Operations details'
 
insert into [StrSource] 
([Ar],[En])
select  ' ','Flats cost'
 
insert into [StrSource] 
([Ar],[En])
select  '','Done'
 
insert into [StrSource] 
([Ar],[En])
select  '    ','Journal entry unbalanced'
 
insert into [StrSource] 
([Ar],[En])
select  ' ','Journal enrty'
 
insert into [StrSource] 
([Ar],[En])
select  '','Entries'
 
insert into [StrSource] 
([Ar],[En])
select  ' ','Journal entries'
 
insert into [StrSource] 
([Ar],[En])
select  '    ','Payment vouchers'
 
insert into [StrSource] 
([Ar],[En])
select  '    ','Reciept vouchers'
 
insert into [StrSource] 
([Ar],[En])
select  '   ','Previous data will be restored'
 
insert into [StrSource] 
([Ar],[En])
select  '    ','Selected checks will be added'
 
insert into [StrSource] 
([Ar],[En])
select  '    
  ','Selected checks will be added
Do you want to continue?'
 
insert into [StrSource] 
([Ar],[En])
select  '      ','Selected flats building cards will be added'
 
insert into [StrSource] 
([Ar],[En])
select  '      ','Selected office building cards will be added'
 
insert into [StrSource] 
([Ar],[En])
select  ' ','Unit cost'
 
insert into [StrSource] 
([Ar],[En])
select  ' ','Password'
 
insert into [StrSource] 
([Ar],[En])
select  '  ','New Password'
 
insert into [StrSource] 
([Ar],[En])
select  '   ','Old Password'
 
insert into [StrSource] 
([Ar],[En])
select  '   ','Password is incorrect'
 
insert into [StrSource] 
([Ar],[En])
select  '  [X]','Consumption quantity [X]'
 
insert into [StrSource] 
([Ar],[En])
select  '','Electricity'
 
insert into [StrSource] 
([Ar],[En])
select  ' ','Distribution method'
 
insert into [StrSource] 
([Ar],[En])
select  '','No'
 
insert into [StrSource] 
([Ar],[En])
select  '     ','You don''t have permission to do this operation'
 
insert into [StrSource] 
([Ar],[En])
select  '     
  

  ','You don''t have permission to do this operation because of security level
Contact your system administrator'
 
insert into [StrSource] 
([Ar],[En])
select  '     ','You don''t have permission to see all information'
 
insert into [StrSource] 
([Ar],[En])
select  '     ','You don''t have permission to modify contracts made by another user'
 
insert into [StrSource] 
([Ar],[En])
select  '   ','No result'
 
insert into [StrSource] 
([Ar],[En])
select  ' ','Not contain'
 
insert into [StrSource] 
([Ar],[En])
select  '    ,     : ','Reservations can not be completed, the property leased, Contract No:'
 
insert into [StrSource] 
([Ar],[En])
select  '    ,     : ','Reservations can not be completed, the property is reserved, card number:'
 
insert into [StrSource] 
([Ar],[En])
select  '    ,     : ','Can not complete the contract, the property leased, Contract No:'
 
insert into [StrSource] 
([Ar],[En])
select  '    ,      : ','Can not complete the contract, the property sold Contract No:'
 
insert into [StrSource] 
([Ar],[En])
select  '    ,     : ','Can not complete the contract, the property is reserved, card number:'
 
insert into [StrSource] 
([Ar],[En])
select  '      ','The contract can not be completed because the parking is reserved'
 
insert into [StrSource] 
([Ar],[En])
select  '   ','Can not complete the process'
 
insert into [StrSource] 
([Ar],[En])
select  '    : ','Account can not be inserted:'
 
insert into [StrSource] 
([Ar],[En])
select  '          ','Unable to add sub-cost center to cost center already used in flat card'
 
insert into [StrSource] 
([Ar],[En])
select  '          ','Unable to add sub-cost center to cost center already used in journal entry'
 
insert into [StrSource] 
([Ar],[En])
select  '        ','You can not add sub-account to account used in entries'
 
insert into [StrSource] 
([Ar],[En])
select  '        : ','You can not add the flat because it is contained in the contract:'
 
insert into [StrSource] 
([Ar],[En])
select  '        : ','You can not add the shop because it is contained in the contract:'
 
insert into [StrSource] 
([Ar],[En])
select  '           ','Main group can''t be the same group itself or its sons'
 
insert into [StrSource] 
([Ar],[En])
select  '             ','Main store can''t be the same store itself or its sons'
 
insert into [StrSource] 
([Ar],[En])
select  '           ','Closing account can''t be the same account itself or its sons'
 
insert into [StrSource] 
([Ar],[En])
select  '           ','Main account can''t be the same account itself or its sons'
 
insert into [StrSource] 
([Ar],[En])
select  '           ','Main cost center account can''t be the same account itself or its sons'
 
insert into [StrSource] 
([Ar],[En])
select  '       ','Unable to modify now'
 
insert into [StrSource] 
([Ar],[En])
select  '   ','Can not do this operation'
 
insert into [StrSource] 
([Ar],[En])
select  '       ','Unable to do this operation now'
 
insert into [StrSource] 
([Ar],[En])
select  '    ','Can not do this operation'
 
insert into [StrSource] 
([Ar],[En])
select  '    ','Unable to generate cost center'
 
insert into [StrSource] 
([Ar],[En])
select  '       ','Unable to delete current journal entry because it''s has origin'
 
insert into [StrSource] 
([Ar],[En])
select  '    ','Can not save empty entry'
 
insert into [StrSource] 
([Ar],[En])
select  '    ','No map for selected type'
 
insert into [StrSource] 
([Ar],[En])
select  '  ','No lawsuit'
 
insert into [StrSource] 
([Ar],[En])
select  '','Latin'
 
insert into [StrSource] 
([Ar],[En])
select  '   ','because this check is collected'
 
insert into [StrSource] 
([Ar],[En])
select  '    ','because this check is already collected'
 
insert into [StrSource] 
([Ar],[En])
select  '   ','because this check is already returned'
 
insert into [StrSource] 
([Ar],[En])
select  '   ','because this check is already deposited'
 
insert into [StrSource] 
([Ar],[En])
select  '    ','because this check is already deposited'
 
insert into [StrSource] 
([Ar],[En])
select  '   ','because this check is already endorsed'
 
insert into [StrSource] 
([Ar],[En])
select  '     ','To apply changes you must restart the program'
 
insert into [StrSource] 
([Ar],[En])
select  '     ','You have a new version of the program'
 
insert into [StrSource] 
([Ar],[En])
select  '     
  
      ','You have a new version of the program 
You must update the files 
Do you want to update now?'
 
insert into [StrSource] 
([Ar],[En])
select  '  ','Number of leased land'
 
insert into [StrSource] 
([Ar],[En])
select  '   ','Number of non-leased land'
 
insert into [StrSource] 
([Ar],[En])
select  '    ','Number of digits after required comma'
 
insert into [StrSource] 
([Ar],[En])
select  '    ','Number of digits after optional comma'
 
insert into [StrSource] 
([Ar],[En])
select  ' ','Number of Installments'
 
insert into [StrSource] 
([Ar],[En])
select  ' ','Number of days'
 
insert into [StrSource] 
([Ar],[En])
select  '  ','Remaining days No'
 
insert into [StrSource] 
([Ar],[En])
select  '     ','Remaining days number of reservation is smaller than'
 
insert into [StrSource] 
([Ar],[En])
select  '  ','Due days No.'
 
insert into [StrSource] 
([Ar],[En])
select  '  ','Number of days from'
 
insert into [StrSource] 
([Ar],[En])
select  ' ','Gardens No.'
 
insert into [StrSource] 
([Ar],[En])
select  ' ','Bathroom No.'
 
insert into [StrSource] 
([Ar],[En])
select  ' ','Residents count'
 
insert into [StrSource] 
([Ar],[En])
select  ' ','Number of Years'
 
insert into [StrSource] 
([Ar],[En])
select  ' ','Balcony No.'
 
insert into [StrSource] 
([Ar],[En])
select  ' ','Flats count'
 
insert into [StrSource] 
([Ar],[En])
select  '     ','Number of flats has lawsuit'
 
insert into [StrSource] 
([Ar],[En])
select  '  ','Number of leased flats'
 
insert into [StrSource] 
([Ar],[En])
select  '   ','Number of non-leased flats'
 
insert into [StrSource] 
([Ar],[En])
select  '   ','Flats No. in floor'
 
insert into [StrSource] 
([Ar],[En])
select  ' ','Streets No.'
 
insert into [StrSource] 
([Ar],[En])
select  ' ','Floors count'
 
insert into [StrSource] 
([Ar],[En])
select  ' ','Number of contracts'
 
insert into [StrSource] 
([Ar],[En])
select  '  ','Number of extra rooms'
 
insert into [StrSource] 
([Ar],[En])
select  '  ','Number of main rooms'
 
insert into [StrSource] 
([Ar],[En])
select  ' ','Shops count'
 
insert into [StrSource] 
([Ar],[En])
select  ' ','Basin count'
 
insert into [StrSource] 
([Ar],[En])
select  ' ','Warehouses No.'
 
insert into [StrSource] 
([Ar],[En])
select  ' ','Play yards count'
 
insert into [StrSource] 
([Ar],[En])
select  '  ','Number of temporary copies'
 
insert into [StrSource] 
([Ar],[En])
select  '  ','Number of drivers flats'
 
insert into [StrSource] 
([Ar],[En])
select  '  ','Number of flats building'
 
insert into [StrSource] 
([Ar],[En])
select  '   ','Number of servants flats'
 
insert into [StrSource] 
([Ar],[En])
select  '  ','Number of drivers flats'
 
insert into [StrSource] 
([Ar],[En])
select  '   ','Number of penthouse floors'
 
insert into [StrSource] 
([Ar],[En])
select  '  ','Number of flats floors'
 
insert into [StrSource] 
([Ar],[En])
select  '  ','Number of offices floors'
 
insert into [StrSource] 
([Ar],[En])
select  '  ','Number of parking floors'
 
insert into [StrSource] 
([Ar],[En])
select  '    ','Number of underground parking floors'
 
insert into [StrSource] 
([Ar],[En])
select  '  ','Number of mizanen floors'
 
insert into [StrSource] 
([Ar],[En])
select  '  ','Number of maid room'
 
insert into [StrSource] 
([Ar],[En])
select  '   SMS','Number of times send SMS'
 
insert into [StrSource] 
([Ar],[En])
select  '  ','Number of times printing'
 
insert into [StrSource] 
([Ar],[En])
select  '  ','Parking count'
 
insert into [StrSource] 
([Ar],[En])
select  '  ','Lighting points count'
 
insert into [StrSource] 
([Ar],[En])
select  '   ','Expected production units number'
 
insert into [StrSource] 
([Ar],[En])
select  ' ','No response'
 
insert into [StrSource] 
([Ar],[En])
select  '  ','No balance'
 
insert into [StrSource] 
([Ar],[En])
select  '','Arabic'
 
insert into [StrSource] 
([Ar],[En])
select  '','Preview'
 
insert into [StrSource] 
([Ar],[En])
select  '    ','View due payable notes'
 
insert into [StrSource] 
([Ar],[En])
select  '    ','View due recievable notes'
 
insert into [StrSource] 
([Ar],[En])
select  ' ','View card'
 
insert into [StrSource] 
([Ar],[En])
select  ' ','View cheque'
 
insert into [StrSource] 
([Ar],[En])
select  ' ','View entry'
 
insert into [StrSource] 
([Ar],[En])
select  '  ','View posted entry'
 
insert into [StrSource] 
([Ar],[En])
select  '   ','View non-posted entry'
 
insert into [StrSource] 
([Ar],[En])
select  '  ','Show paid amount'
 
insert into [StrSource] 
([Ar],[En])
select  ' ','Show checked box'
 
insert into [StrSource] 
([Ar],[En])
select  ' ','View checked'
 
insert into [StrSource] 
([Ar],[En])
select  ' ','Show by balance'
 
insert into [StrSource] 
([Ar],[En])
select  ' ','Show by total'
 
insert into [StrSource] 
([Ar],[En])
select  '  ','Show cost price'
 
insert into [StrSource] 
([Ar],[En])
select  '  ','Show Unchecked box'
 
insert into [StrSource] 
([Ar],[En])
select  '  ','View un-checked'
 
insert into [StrSource] 
([Ar],[En])
select  ' ','View entry'
 
insert into [StrSource] 
([Ar],[En])
select  '  ','View deposit entry'
 
insert into [StrSource] 
([Ar],[En])
select  '   ','View due amount entry'
 
insert into [StrSource] 
([Ar],[En])
select  ' ','Contract duration'
 
insert into [StrSource] 
([Ar],[En])
select  '','Paid'
 
insert into [StrSource] 
([Ar],[En])
select  '','Debit'
 
insert into [StrSource] 
([Ar],[En])
select  '','Debited'
 
insert into [StrSource] 
([Ar],[En])
select  '  ','Depreciation asset card'
 
insert into [StrSource] 
([Ar],[En])
select  '','Checked'
 
insert into [StrSource] 
([Ar],[En])
select  '   ','Checked for notes operations'
 
insert into [StrSource] 
([Ar],[En])
select  ' ','Cost centers'
 
insert into [StrSource] 
([Ar],[En])
select  '    ','Cost centers'
 
insert into [StrSource] 
([Ar],[En])
select  ' ','Linked to building'
 
insert into [StrSource] 
([Ar],[En])
select  '','Returned'
 
insert into [StrSource] 
([Ar],[En])
select  ' ','Purchase return'
 
insert into [StrSource] 
([Ar],[En])
select  ' ','Sales return'
 
insert into [StrSource] 
([Ar],[En])
select  ' ','Already returned'
 
insert into [StrSource] 
([Ar],[En])
select  '','Returned'
 
insert into [StrSource] 
([Ar],[En])
select  '  /','Returned from / day'
 
insert into [StrSource] 
([Ar],[En])
select  '','Posted'
 
insert into [StrSource] 
([Ar],[En])
select  '','Posted'
 
insert into [StrSource] 
([Ar],[En])
select  ' ','Posted to bank'
 
insert into [StrSource] 
([Ar],[En])
select  '','Posted'
 
insert into [StrSource] 
([Ar],[En])
select  ' ','Posted to bank'
 
insert into [StrSource] 
([Ar],[En])
select  ' ','Cost center'
 
insert into [StrSource] 
([Ar],[En])
select  '   ','Main building cost center'
 
insert into [StrSource] 
([Ar],[En])
select  '  ','Main cost center'
 
insert into [StrSource] 
([Ar],[En])
select  '  ','Credit cost center'
 
insert into [StrSource] 
([Ar],[En])
select  '  ','Debit cost center'
 
insert into [StrSource] 
([Ar],[En])
select  '     ','Cost center is used in entries'
 
insert into [StrSource] 
([Ar],[En])
select  '  ','Duplicate cost center'
 
insert into [StrSource] 
([Ar],[En])
select  '  ','Main cost center'
 
insert into [StrSource] 
([Ar],[En])
select  '    ','Main cost center for flats'
 
insert into [StrSource] 
([Ar],[En])
select  ' ','Land area'
 
insert into [StrSource] 
([Ar],[En])
select  '  ','Built land area'
 
insert into [StrSource] 
([Ar],[En])
select  ' ','Gardens area'
 
insert into [StrSource] 
([Ar],[En])
select  ' ','Play yard area'
 
insert into [StrSource] 
([Ar],[En])
select  '  ','Car parking area'
 
insert into [StrSource] 
([Ar],[En])
select  ' 1','Path 1'
 
insert into [StrSource] 
([Ar],[En])
select  ' 2','Path 2'
 
insert into [StrSource] 
([Ar],[En])
select  '  ','Backup location path'
 
insert into [StrSource] 
([Ar],[En])
select  '','Help'
 
insert into [StrSource] 
([Ar],[En])
select  '','Due'
 
insert into [StrSource] 
([Ar],[En])
select  '','Stored'
 
insert into [StrSource] 
([Ar],[En])
select  '','Villa'
 
insert into [StrSource] 
([Ar],[En])
select  '','Villa'
 
insert into [StrSource] 
([Ar],[En])
select  ' ','Can be returned'
 
insert into [StrSource] 
([Ar],[En])
select  ' ','Can be build'
 
insert into [StrSource] 
([Ar],[En])
select  ' ','Can be collected'
 
insert into [StrSource] 
([Ar],[En])
select  '  ','Can be partial collection'
 
insert into [StrSource] 
([Ar],[En])
select  ' ','Can be posted'
 
insert into [StrSource] 
([Ar],[En])
select  ' ','Can be endrosed'
 
insert into [StrSource] 
([Ar],[En])
select  '      ','Database already exists please use another name'
 
insert into [StrSource] 
([Ar],[En])
select  '   ','Before starting restore process'
 
insert into [StrSource] 
([Ar],[En])
select  '      ','Results will be different depending on the specific conditions of report'
 
insert into [StrSource] 
([Ar],[En])
select  ' ','Near to evacuate'
 
insert into [StrSource] 
([Ar],[En])
select  '  ','Contract near to expire'
 
insert into [StrSource] 
([Ar],[En])
select  '','Cut'
 
insert into [StrSource] 
([Ar],[En])
select  '   ','First delete asset'
 
insert into [StrSource] 
([Ar],[En])
select  '    ','First you have to delete all related operations'
 
insert into [StrSource] 
([Ar],[En])
select  '    ','First you have to save current card'
 
insert into [StrSource] 
([Ar],[En])
select  '    ','First delete current card'
 
insert into [StrSource] 
([Ar],[En])
select  '   ','First delete card'
 
insert into [StrSource] 
([Ar],[En])
select  '','Entry'
 
insert into [StrSource] 
([Ar],[En])
select  ' ','Opening journal entry'
 
insert into [StrSource] 
([Ar],[En])
select  '  ','Opening journal entry'
 
insert into [StrSource] 
([Ar],[En])
select  ' ','Under process'
 
insert into [StrSource] 
([Ar],[En])
select  '   ','Exchange rate entry'
 
insert into [StrSource] 
([Ar],[En])
select  '   ','Last payment value'
 
insert into [StrSource] 
([Ar],[En])
select  ' ','Input value'
 
insert into [StrSource] 
([Ar],[En])
select  ' ','Land value'
 
insert into [StrSource] 
([Ar],[En])
select  ' ','Investment value'
 
insert into [StrSource] 
([Ar],[En])
select  ' ','Consumption value'
 
insert into [StrSource] 
([Ar],[En])
select  ' ','Asset value'
 
insert into [StrSource] 
([Ar],[En])
select  '  ','Asset value as scrap'
 
insert into [StrSource] 
([Ar],[En])
select  ' ','Extra value '
 
insert into [StrSource] 
([Ar],[En])
select  ' ','Depreciation value'
 
insert into [StrSource] 
([Ar],[En])
select  ' ','Rent value'
 
insert into [StrSource] 
([Ar],[En])
select  ' ','Selling value'
 
insert into [StrSource] 
([Ar],[En])
select  '  ','Current deposit value'
 
insert into [StrSource] 
([Ar],[En])
select  '  ','Previous deposit value'
 
insert into [StrSource] 
([Ar],[En])
select  ' ','Discount value'
 
insert into [StrSource] 
([Ar],[En])
select  ' ','Scrap value'
 
insert into [StrSource] 
([Ar],[En])
select  '  ','Late payments value'
 
insert into [StrSource] 
([Ar],[En])
select  '  ','Collected payments value'
 
insert into [StrSource] 
([Ar],[En])
select  ' ','Finishing quality'
 
insert into [StrSource] 
([Ar],[En])
select  ' ','Security level'
 
insert into [StrSource] 
([Ar],[En])
select  ' ','Security level'
 
insert into [StrSource] 
([Ar],[En])
select  '  ','Drawn on Bank'
 
insert into [StrSource] 
([Ar],[En])
select  '','Busy'
 
insert into [StrSource] 
([Ar],[En])
select  ' ','Report sources'
 
insert into [StrSource] 
([Ar],[En])
select  '','Compressed'
 
insert into [StrSource] 
([Ar],[En])
select  ' ','Building Combarision'
 
insert into [StrSource] 
([Ar],[En])
select  '','Endorsed'
 
insert into [StrSource] 
([Ar],[En])
select  '','Endorsed'
 
insert into [StrSource] 
([Ar],[En])
select  '','Endorsed'
 
insert into [StrSource] 
([Ar],[En])
select  ' ','Closing file wizard'
 
insert into [StrSource] 
([Ar],[En])
select  '  ','Print preview'
 
insert into [StrSource] 
([Ar],[En])
select  ' ','Depreciation average'
 
insert into [StrSource] 
([Ar],[En])
select  '','Information'
 
insert into [StrSource] 
([Ar],[En])
select  ' ','Distribution information'
 
insert into [StrSource] 
([Ar],[En])
select  ' ','Contract information'
 
insert into [StrSource] 
([Ar],[En])
select  ' ','User information'
 
insert into [StrSource] 
([Ar],[En])
select  ' ','Account information'
 
insert into [StrSource] 
([Ar],[En])
select  ' ','General information'
 
insert into [StrSource] 
([Ar],[En])
select  '','Closed'
 
insert into [StrSource] 
([Ar],[En])
select  ' ','Shortcut key'
 
insert into [StrSource] 
([Ar],[En])
select  '','Opened'
 
insert into [StrSource] 
([Ar],[En])
select  '','Receivable'
 
insert into [StrSource] 
([Ar],[En])
select  '','Offices'
 
insert into [StrSource] 
([Ar],[En])
select  ' ','Contract location'
 
insert into [StrSource] 
([Ar],[En])
select  ' ','Destination'
 
insert into [StrSource] 
([Ar],[En])
select  '','Duplicate'
 
insert into [StrSource] 
([Ar],[En])
select  '','Notes'
 
insert into [StrSource] 
([Ar],[En])
select  '','Notes'
 
insert into [StrSource] 
([Ar],[En])
select  '','Note'
 
insert into [StrSource] 
([Ar],[En])
select  ' ','Depreciation summary'
 
insert into [StrSource] 
([Ar],[En])
select  '','File'
 
insert into [StrSource] 
([Ar],[En])
select  ' ','Data file'
 
insert into [StrSource] 
([Ar],[En])
select  ' ','Log file'
 
insert into [StrSource] 
([Ar],[En])
select  '   ','Print file does not exist'
 
insert into [StrSource] 
([Ar],[En])
select  ' ','New File'
 
insert into [StrSource] 
([Ar],[En])
select  '','Owned'
 
insert into [StrSource] 
([Ar],[En])
select  ' ','Flat ownership'
 
insert into [StrSource] 
([Ar],[En])
select  '','From'
 
insert into [StrSource] 
([Ar],[En])
select  ' ','From location'
 
insert into [StrSource] 
([Ar],[En])
select  ' ','From Date'
 
insert into [StrSource] 
([Ar],[En])
select  '  : ','From Date:'
 
insert into [StrSource] 
([Ar],[En])
select  ' ','From No'
 
insert into [StrSource] 
([Ar],[En])
select  '','Terminated'
 
insert into [StrSource] 
([Ar],[En])
select  ' ','Expired'
 
insert into [StrSource] 
([Ar],[En])
select  '    ','Expired contract and terminated'
 
insert into [StrSource] 
([Ar],[En])
select  '     ','Expired contract and didn''t terminated'
 
insert into [StrSource] 
([Ar],[En])
select  ' ','Expired contract'
 
insert into [StrSource] 
([Ar],[En])
select  '','Low'
 
insert into [StrSource] 
([Ar],[En])
select  ' ','Sales agent'
 
insert into [StrSource] 
([Ar],[En])
select  '/ ','Since / Day'
 
insert into [StrSource] 
([Ar],[En])
select  '','Materials'
 
insert into [StrSource] 
([Ar],[En])
select  '','Specifications'
 
insert into [StrSource] 
([Ar],[En])
select  ' ','Materials specification'
 
insert into [StrSource] 
([Ar],[En])
select  '','OK'
 
insert into [StrSource] 
([Ar],[En])
select  ' ','Asset locations'
 
insert into [StrSource] 
([Ar],[En])
select  ' ','Car parking'
 
insert into [StrSource] 
([Ar],[En])
select  '   ','Underground car parking'
 
insert into [StrSource] 
([Ar],[En])
select  ' ','Custom print'
 
insert into [StrSource] 
([Ar],[En])
select  '  ','Quantity calculation methods'
 
insert into [StrSource] 
([Ar],[En])
select  ' ','Depreciation method'
 
insert into [StrSource] 
([Ar],[En])
select  ' ','Change type'
 
insert into [StrSource] 
([Ar],[En])
select  ' ','Calculation method'
 
insert into [StrSource] 
([Ar],[En])
select  ' ','Payment method'
 
insert into [StrSource] 
([Ar],[En])
select  '  ','Payment method in words'
 
insert into [StrSource] 
([Ar],[En])
select  ' ','Shipping Method'
 
insert into [StrSource] 
([Ar],[En])
select  '  ','Building ownership'
 
insert into [StrSource] 
([Ar],[En])
select  '','Length'
 
insert into [StrSource] 
([Ar],[En])
select  '  ','Fence length'
 
insert into [StrSource] 
([Ar],[En])
select  '','Print'
 
insert into [StrSource] 
([Ar],[En])
select  '     ','Show checks generation window when adding contract'
 
insert into [StrSource] 
([Ar],[En])
select  '','Normal'
 
insert into [StrSource] 
([Ar],[En])
select  '','High'
 
insert into [StrSource] 
([Ar],[En])
select  '','General'
 
insert into [StrSource] 
([Ar],[En])
select  '  ','For all users'
 
insert into [StrSource] 
([Ar],[En])
select  ' ','Exchange'
 
insert into [StrSource] 
([Ar],[En])
select  '  ','Revenue days No.'
 
insert into [StrSource] 
([Ar],[En])
select  '  ','Delay days No.'
 
insert into [StrSource] 
([Ar],[En])
select  '   ','Delay days No. between'
 
insert into [StrSource] 
([Ar],[En])
select  '  ','Contract days'
 
insert into [StrSource] 
([Ar],[En])
select  '   ','Partial collected payments value'
 
insert into [StrSource] 
([Ar],[En])
select  '  ','Due payments value'
 
insert into [StrSource] 
([Ar],[En])
select  '   ','Partial due payments value'
 
insert into [StrSource] 
([Ar],[En])
select  ' ','Payment value'
 
insert into [StrSource] 
([Ar],[En])
select  ' ','Contract amount'
 
insert into [StrSource] 
([Ar],[En])
select  '   ','Discounted contract amount '
 
insert into [StrSource] 
([Ar],[En])
select  '   ','Commission amount from customer'
 
insert into [StrSource] 
([Ar],[En])
select  '    ','Commission amount from owner'
 
insert into [StrSource] 
([Ar],[En])
select  ' ','Expenses amount'
 
insert into [StrSource] 
([Ar],[En])
select  ' ','Land report'
 
insert into [StrSource] 
([Ar],[En])
select  ' ','Building report'
 
insert into [StrSource] 
([Ar],[En])
select  ' ','Flats report'
 
insert into [StrSource] 
([Ar],[En])
select  '  ','Various offers report'
 
insert into [StrSource] 
([Ar],[En])
select  ' ','Contract report'
 
insert into [StrSource] 
([Ar],[En])
select  '  ','Customer properties report'
 
insert into [StrSource] 
([Ar],[En])
select  '','Every'
 
insert into [StrSource] 
([Ar],[En])
select  ' ','Every week'
 
insert into [StrSource] 
([Ar],[En])
select  ' ','Full authoritize'
 
insert into [StrSource] 
([Ar],[En])
select  ' ','Every month'
 
insert into [StrSource] 
([Ar],[En])
select  ' ','Every day'
 
insert into [StrSource] 
([Ar],[En])
select  '','Both'
 
insert into [StrSource] 
([Ar],[En])
select  '  ','Sold flat cost'
 
insert into [StrSource] 
([Ar],[En])
select  ' ','Property cost'
 
insert into [StrSource] 
([Ar],[En])
select  ' ','Shop cost'
 
insert into [StrSource] 
([Ar],[En])
select  ' ','Project cost'
 
insert into [StrSource] 
([Ar],[En])
select  ' ','Parking cost'
 
insert into [StrSource] 
([Ar],[En])
select  ' ','End date'
 
insert into [StrSource] 
([Ar],[En])
select  '','Type'
 
insert into [StrSource] 
([Ar],[En])
select  ' ','Land type'
 
insert into [StrSource] 
([Ar],[En])
select  '   / ','Rent type Annually / Monthly'
 
insert into [StrSource] 
([Ar],[En])
select  ' ','Card type'
 
insert into [StrSource] 
([Ar],[En])
select  ' ','Account type'
 
insert into [StrSource] 
([Ar],[En])
select  ' ','Font type'
 
insert into [StrSource] 
([Ar],[En])
select  ' ','Payment method'
 
insert into [StrSource] 
([Ar],[En])
select  ' ','Ownership type'
 
insert into [StrSource] 
([Ar],[En])
select  ' ','Car type'
 
insert into [StrSource] 
([Ar],[En])
select  ' ','Flat type'
 
insert into [StrSource] 
([Ar],[En])
select  ' ','Cheque type'
 
insert into [StrSource] 
([Ar],[En])
select  ' ','Offer type'
 
insert into [StrSource] 
([Ar],[En])
select  ' ','Unit type'
 
insert into [StrSource] 
([Ar],[En])
select  ' ','Contract type'
 
insert into [StrSource] 
([Ar],[En])
select  ' ','Property type'
 
insert into [StrSource] 
([Ar],[En])
select  '  ','Check type'
 
insert into [StrSource] 
([Ar],[En])
select  '   ','Safety system type'
 
insert into [StrSource] 
([Ar],[En])
select  '','Telephone'
 
insert into [StrSource] 
([Ar],[En])
select  ' ','Customer tel'
 
insert into [StrSource] 
([Ar],[En])
select  ' ','Business telephone'
 
insert into [StrSource] 
([Ar],[En])
select  '       ','This rate does not exist in exchange rate window'
 
insert into [StrSource] 
([Ar],[En])
select  '    ','This cheque is linked with contract'
 
insert into [StrSource] 
([Ar],[En])
select  '    
  ','This cheque is linked with contract
Do you want to modify?'
 
insert into [StrSource] 
([Ar],[En])
select  '    
  ','This cheque is linked with contract
Do you want to delete?'
 
insert into [StrSource] 
([Ar],[En])
select  '    ','This cheque linked with bill'
 
insert into [StrSource] 
([Ar],[En])
select  '   : ','This contract No.'
 
insert into [StrSource] 
([Ar],[En])
select  '   : 2','This contract No: 2'
 
insert into [StrSource] 
([Ar],[En])
select  '        ','This journal entry has origin are you sure to delete?'
 
insert into [StrSource] 
([Ar],[En])
select  '         ','This is multiple shop and one of its components is included in the contract'
 
insert into [StrSource] 
([Ar],[En])
select  '          ','This is multiple land and one of its components is included in the contract'
 
insert into [StrSource] 
([Ar],[En])
select  '        ','This is multiple land and one of its components is included in the contract'
 
insert into [StrSource] 
([Ar],[En])
select  '          ','This is multiple flat and one of its components is included in the contract'
 
insert into [StrSource] 
([Ar],[En])
select  '        ','This flat include in multiple flat inside contract'
 
insert into [StrSource] 
([Ar],[En])
select  '        ','This shop include in multiple shop inside contract'
 
insert into [StrSource] 
([Ar],[En])
select  '         ','This window contains some information that can be duplicated'
 
insert into [StrSource] 
([Ar],[En])
select  '   ','Are you sure to add it now?'
 
insert into [StrSource] 
([Ar],[En])
select  '    ','Do you want to restart programs now?'
 
insert into [StrSource] 
([Ar],[En])
select  '     ','Do you want to renumber the selected cards?'
 
insert into [StrSource] 
([Ar],[En])
select  '       ','Do you want to regnerate notes that is already exist?'
 
insert into [StrSource] 
([Ar],[En])
select  '    ','Do you want to close the current window?'
 
insert into [StrSource] 
([Ar],[En])
select  '   ','Do you want to cancel reservation?'
 
insert into [StrSource] 
([Ar],[En])
select  '  ','Do you want to renew?'
 
insert into [StrSource] 
([Ar],[En])
select  '  ','Do you want to modify?'
 
insert into [StrSource] 
([Ar],[En])
select  '  ','Do you want to delete?'
 
insert into [StrSource] 
([Ar],[En])
select  '    ','Do you want to close the program?'
 
insert into [StrSource] 
([Ar],[En])
select  '     ','Do you want to make backup'
 
insert into [StrSource] 
([Ar],[En])
select  '      ','Do you want to update now?'
 
insert into [StrSource] 
([Ar],[En])
select  '  ','Do you want to proceed?'
 
insert into [StrSource] 
([Ar],[En])
select  '  ','Do you want to proceed?'
 
insert into [StrSource] 
([Ar],[En])
select  '       ','Do you want to terminate the current contract using contract end date?'
 
insert into [StrSource] 
([Ar],[En])
select  '      ','Are you sure to change flats cost prices?'
 
insert into [StrSource] 
([Ar],[En])
select  '   ','Do you want to post the bill?'
 
insert into [StrSource] 
([Ar],[En])
select  '   ','Do you want to post the journal entry?'
 
insert into [StrSource] 
([Ar],[En])
select  '    ','Are you sure to post selected entries?'
 
insert into [StrSource] 
([Ar],[En])
select  '     ','Do you want to fill obverse account?'
 
insert into [StrSource] 
([Ar],[En])
select  '      ?','Do you want to set him in current site?'
 
insert into [StrSource] 
([Ar],[En])
select  '       ','Do you want to show cost center in opening entry?'
 
insert into [StrSource] 
([Ar],[En])
select  '      ','Are you sure to delete current Hijri year settings?'
 
insert into [StrSource] 
([Ar],[En])
select  '     ','Do you want to delete related account card?'
 
insert into [StrSource] 
([Ar],[En])
select  '      ','Do you want to delete related deposit account card?'
 
insert into [StrSource] 
([Ar],[En])
select  '      ','Do you want to delete related cost center card?'
 
insert into [StrSource] 
([Ar],[En])
select  '     ','Do you want to delete building account also?'
 
insert into [StrSource] 
([Ar],[En])
select  '      ','Do you want to delete building bank account also?'
 
insert into [StrSource] 
([Ar],[En])
select  '        ','Do you want to delete building cost center account also?'
 
insert into [StrSource] 
([Ar],[En])
select  '     ','Do you want to delete current settings of Hijri Year?'
 
insert into [StrSource] 
([Ar],[En])
select  '     ','Do you want to save?'
 
insert into [StrSource] 
([Ar],[En])
select  '     ','Do you want renumbering sub-accounts?'
 
insert into [StrSource] 
([Ar],[En])
select  '    ','Are you sure to delete?'
 
insert into [StrSource] 
([Ar],[En])
select  '      ','Do you want to add now?'
 
insert into [StrSource] 
([Ar],[En])
select  '      ','Do you want to shrink size of the database'
 
insert into [StrSource] 
([Ar],[En])
select  '    ','Do you want to reserve the flat?'
 
insert into [StrSource] 
([Ar],[En])
select  '    ','Do you want to reserve the shop?'
 
insert into [StrSource] 
([Ar],[En])
select  '    ','Do you want to reserve the parking?'
 
insert into [StrSource] 
([Ar],[En])
select  '       ','Are you sure to delete all selected notes?'
 
insert into [StrSource] 
([Ar],[En])
select  ' ','Font color'
 
insert into [StrSource] 
([Ar],[En])
select  ' ','Car color'
 
insert into [StrSource] 
([Ar],[En])
select  '','Leased'
 
insert into [StrSource] 
([Ar],[En])
select  '','Leased'
 
insert into [StrSource] 
([Ar],[En])
select  '','Italic'
 
insert into [StrSource] 
([Ar],[En])
select  '','Sold'
 
insert into [StrSource] 
([Ar],[En])
select  '','Sold'
 
insert into [StrSource] 
([Ar],[En])
select  '','Amount'
 
insert into [StrSource] 
([Ar],[En])
select  '','Sales'
 
insert into [StrSource] 
([Ar],[En])
select  ' ','Asset sale'
 
insert into [StrSource] 
([Ar],[En])
select  '2','Sales2'
 
insert into [StrSource] 
([Ar],[En])
select  '3','Sales3'
 
insert into [StrSource] 
([Ar],[En])
select  '','Continue'
 
insert into [StrSource] 
([Ar],[En])
select  '','Various'
 
insert into [StrSource] 
([Ar],[En])
select  '','Medium'
 
insert into [StrSource] 
([Ar],[En])
select  '  ','Default printing folder'
 
insert into [StrSource] 
([Ar],[En])
select  ' ','New Folder'
 
insert into [StrSource] 
([Ar],[En])
select  ' ','Depreciation accumulated'
 
insert into [StrSource] 
([Ar],[En])
select  '   ','New depreciation accumulated'
 
insert into [StrSource] 
([Ar],[En])
select  '','Total'
 
insert into [StrSource] 
([Ar],[En])
select  '   ','Total debit period'
 
insert into [StrSource] 
([Ar],[En])
select  ' ','Deposit total'
 
insert into [StrSource] 
([Ar],[En])
select  '   ','Total current deposit of contracts'
 
insert into [StrSource] 
([Ar],[En])
select  '   ','Total previous deposit of contracts'
 
insert into [StrSource] 
([Ar],[En])
select  '  ','Total general deposit'
 
insert into [StrSource] 
([Ar],[En])
select  '   ','Total due payments'
 
insert into [StrSource] 
([Ar],[En])
select  '  ','Current entry total'
 
insert into [StrSource] 
([Ar],[En])
select  '  ','Total credit period'
 
insert into [StrSource] 
([Ar],[En])
select  ' ','Total value'
 
insert into [StrSource] 
([Ar],[En])
select  ' ','Total cost'
 
insert into [StrSource] 
([Ar],[En])
select  ' ','Total expenses'
 
insert into [StrSource] 
([Ar],[En])
select  '     ','Total current percentage  '
 
insert into [StrSource] 
([Ar],[En])
select  '  ','Total capital'
 
insert into [StrSource] 
([Ar],[En])
select  '  ','Previous total credit'
 
insert into [StrSource] 
([Ar],[En])
select  '  ','Previous total debit'
 
insert into [StrSource] 
([Ar],[En])
select  '      ','The sum of cheque values smaller then remaining amount'
 
insert into [StrSource] 
([Ar],[En])
select  '      ','The sum of cheque values larger then remaining amount'
 
insert into [StrSource] 
([Ar],[En])
select  '  ','Total value of contracts'
 
insert into [StrSource] 
([Ar],[En])
select  '  ','Total credit'
 
insert into [StrSource] 
([Ar],[En])
select  '  ','Total debit'
 
insert into [StrSource] 
([Ar],[En])
select  ' ','Materials group'
 
insert into [StrSource] 
([Ar],[En])
select  '','Reserved'
 
insert into [StrSource] 
([Ar],[En])
select  '','Reserved'
 
insert into [StrSource] 
([Ar],[En])
select  '','character'
 
insert into [StrSource] 
([Ar],[En])
select  '','Collected '
 
insert into [StrSource] 
([Ar],[En])
select  '','Collected'
 
insert into [StrSource] 
([Ar],[En])
select  ' ','Partial collected'
 
insert into [StrSource] 
([Ar],[En])
select  ' ','Partial collected'
 
insert into [StrSource] 
([Ar],[En])
select  ' ','Partial collected'
 
insert into [StrSource] 
([Ar],[En])
select  '  / ','Partial collected / Value'
 
insert into [StrSource] 
([Ar],[En])
select  '  /','Collected drom / Day'
 
insert into [StrSource] 
([Ar],[En])
select  '','Collected'
 
insert into [StrSource] 
([Ar],[En])
select  '','Blocked'
 
insert into [StrSource] 
([Ar],[En])
select  '','Shop'
 
insert into [StrSource] 
([Ar],[En])
select  ' ','Compilation shop'
 
insert into [StrSource] 
([Ar],[En])
select  '','Shops'
 
insert into [StrSource] 
([Ar],[En])
select  '','Customized'
 
insert into [StrSource] 
([Ar],[En])
select  ' ','Building chart'
 
insert into [StrSource] 
([Ar],[En])
select  '  ','Rent duration in word'
 
insert into [StrSource] 
([Ar],[En])
select  ' ','Computer'
 
insert into [StrSource] 
([Ar],[En])
select  'Test      Font','Test      Font'
 
insert into [StrSource] 
([Ar],[En])
select  '  ','Total development cost'
 
insert into [StrSource] 
([Ar],[En])
select  '   ','Total value of the property developer'
 
insert into [StrSource] 
([Ar],[En])
select  '  ','Enter cost center'
 
insert into [StrSource] 
([Ar],[En])
select  '   ','Enter main cost center'
 
insert into [StrSource] 
([Ar],[En])
select  '    ','Enter cost center to line'
 
insert into [StrSource] 
([Ar],[En])
select  '   ','Enter cost center'
 
insert into [StrSource] 
([Ar],[En])
select  '       ','Enter land cost center in land card'
 
insert into [StrSource] 
([Ar],[En])
select  '      ','Enter land cost center in land card'
 
insert into [StrSource] 
([Ar],[En])
select  '      ','Enter flat cost center in flat card'
 
insert into [StrSource] 
([Ar],[En])
select  '      ','Enter villa cost center in villa card'
 
insert into [StrSource] 
([Ar],[En])
select  '      ','Enter shop cost center in shop card'
 
insert into [StrSource] 
([Ar],[En])
select  '      ','Enter parking cost center in parking card'
 
insert into [StrSource] 
([Ar],[En])
select  ' ','Owner name'
 
insert into [StrSource] 
([Ar],[En])
select  ' ','Plans name'
 
insert into [StrSource] 
([Ar],[En])
select  ' ','Add parking'
 
insert into [StrSource] 
([Ar],[En])
select  '  ','Show empty cost center'
 
insert into [StrSource] 
([Ar],[En])
select  '    ','Show cost center for contract'
 
insert into [StrSource] 
([Ar],[En])
select  '  ','Recoding sub accounts'
 
insert into [StrSource] 
([Ar],[En])
select  '  ','Generate cost center'
 
insert into [StrSource] 
([Ar],[En])
select  '   ','Add sub cost center'
 
insert into [StrSource] 
([Ar],[En])
select  '        ','Set cash account of building as default account of partial collection'
 
insert into [StrSource] 
([Ar],[En])
select  '','Dimensions'
 
insert into [StrSource] 
([Ar],[En])
select  '  ','Dimensions and border'
 
insert into [StrSource] 
([Ar],[En])
select  '  ','Coordinates from Google'
 
insert into [StrSource] 
([Ar],[En])
select  '','Goods'
 
insert into [StrSource] 
([Ar],[En])
select  '','Analysis'
 
insert into [StrSource] 
([Ar],[En])
select  '','Organization'
 
insert into [StrSource] 
([Ar],[En])
select  '','Border'
 
insert into [StrSource] 
([Ar],[En])
select  '','Neighborhood'
 
insert into [StrSource] 
([Ar],[En])
select  ' ','Main road'
 
insert into [StrSource] 
([Ar],[En])
select  '','Instrument'
 
insert into [StrSource] 
([Ar],[En])
select  '','Nature'
 
insert into [StrSource] 
([Ar],[En])
select  '  ','Factors and projects affecting'
 
insert into [StrSource] 
([Ar],[En])
select  ' ','Public facilities'
 
insert into [StrSource] 
([Ar],[En])
select  '','Attachments'
 
insert into [StrSource] 
([Ar],[En])
select  ' ','Main cost center'
 
insert into [StrSource] 
([Ar],[En])
select  '','Source'
 
insert into [StrSource] 
([Ar],[En])
select  '','equal'
 
insert into [StrSource] 
([Ar],[En])
select  '','Results'
 
insert into [StrSource] 
([Ar],[En])
select  '','Text'
 
insert into [StrSource] 
([Ar],[En])
select  '','Interfaces'
 
insert into [StrSource] 
([Ar],[En])
select  ' ','Commissioned by'
 
insert into [StrSource] 
([Ar],[En])
select  '  ','Cost center card'
 
insert into [StrSource] 
([Ar],[En])
select  '  ','Cost center card'
 
insert into [StrSource] 
([Ar],[En])
select  ' ','Property information'
 
insert into [StrSource] 
([Ar],[En])
select  ' ','Ownership information'
 
insert into [StrSource] 
([Ar],[En])
select  '  ','Latin personal information'
 
insert into [StrSource] 
([Ar],[En])
select  '     ','Cost center belong to credits account'
 
insert into [StrSource] 
([Ar],[En])
select  '     ','Cost center belong to debits account'
 
insert into [StrSource] 
([Ar],[En])
select  '    ','Cost center belong to contracts'
 
insert into [StrSource] 
([Ar],[En])
select  '    ','Cost center belong to commission account'
 
insert into [StrSource] 
([Ar],[En])
select  '      ','Cost center belong to commission credit account'
 
insert into [StrSource] 
([Ar],[En])
select  '      ','Cost center belong to commission debit account'
 
insert into [StrSource] 
([Ar],[En])
select  '     ','Cost center belong to deposit account'
 
insert into [StrSource] 
([Ar],[En])
select  '      ','Cost center belong to other fees account'
 
insert into [StrSource] 
([Ar],[En])
select  '      ','Cost center belong to contract registration account'
 
insert into [StrSource] 
([Ar],[En])
select  '      ','Cost center belong to contract price account'
 
insert into [StrSource] 
([Ar],[En])
select  ' ','Area classification'
 
insert into [StrSource] 
([Ar],[En])
select  '  ','Modify Parking Specifications'
 
insert into [StrSource] 
([Ar],[En])
select  ' ','Windows format'
 
insert into [StrSource] 
([Ar],[En])
select  ' ','Specific format'
 
insert into [StrSource] 
([Ar],[En])
select  '  ','Generate cheques'
 
insert into [StrSource] 
([Ar],[En])
select  '','South'
 
insert into [StrSource] 
([Ar],[En])
select  ' ','Issuer'
 
insert into [StrSource] 
([Ar],[En])
select  '/   ','Ending inventory A/C'
 
insert into [StrSource] 
([Ar],[En])
select  '  ','Delete selected parking'
 
insert into [StrSource] 
([Ar],[En])
select  '  ','Building deposit account'
 
insert into [StrSource] 
([Ar],[En])
select  '   ','Ending inventory account'
 
insert into [StrSource] 
([Ar],[En])
select  '  ','Calculate development cost'
 
insert into [StrSource] 
([Ar],[En])
select  '  ','Building cash account'
 
insert into [StrSource] 
([Ar],[En])
select  '   ','Calculate developed property value'
 
insert into [StrSource] 
([Ar],[En])
select  ' ','Customers account'
 
insert into [StrSource] 
([Ar],[En])
select  '   ','Block card in all transactions'
 
insert into [StrSource] 
([Ar],[En])
select  '  ','Block card in contracts'
 
insert into [StrSource] 
([Ar],[En])
select  '   1','Customer field 1'
 
insert into [StrSource] 
([Ar],[En])
select  '   2','Customer field 2'
 
insert into [StrSource] 
([Ar],[En])
select  '   3','Customer field 3'
 
insert into [StrSource] 
([Ar],[En])
select  '   4','Customer field 4'
 
insert into [StrSource] 
([Ar],[En])
select  '   5','Customer field 5'
 
insert into [StrSource] 
([Ar],[En])
select  '   6','Customer field 6'
 
insert into [StrSource] 
([Ar],[En])
select  '   7','Customer field 7'
 
insert into [StrSource] 
([Ar],[En])
select  '  ','Outside urban boundary'
 
insert into [StrSource] 
([Ar],[En])
select  ' ','Available services'
 
insert into [StrSource] 
([Ar],[En])
select  '  ','Inside urban boundary'
 
insert into [StrSource] 
([Ar],[En])
select  '  ','Civil Defense License'
 
insert into [StrSource] 
([Ar],[En])
select  ' ','Registration number'
 
insert into [StrSource] 
([Ar],[En])
select  ' ','Planned No.'
 
insert into [StrSource] 
([Ar],[En])
select  '  ','Cost center code'
 
insert into [StrSource] 
([Ar],[En])
select  '','East'
 
insert into [StrSource] 
([Ar],[En])
select  '','North'
 
insert into [StrSource] 
([Ar],[En])
select  ' ','Sanitation'
 
insert into [StrSource] 
([Ar],[En])
select  ' ','Nature of the land'
 
insert into [StrSource] 
([Ar],[En])
select  ' ','Nature area'
 
insert into [StrSource] 
([Ar],[En])
select  ' ','Evaluation method'
 
insert into [StrSource] 
([Ar],[En])
select  '','West'
 
insert into [StrSource] 
([Ar],[En])
select  '  ','Exchange differences'
 
insert into [StrSource] 
([Ar],[En])
select  '2','Square meter'
 
insert into [StrSource] 
([Ar],[En])
select  '','Water'
 
insert into [StrSource] 
([Ar],[En])
select  '  ','Mutli Entry'
 
insert into [StrSource] 
([Ar],[En])
select  '  ','The lowest price of the property'
 
insert into [StrSource] 
([Ar],[En])
select  ' ','Sales man'
 
insert into [StrSource] 
([Ar],[En])
select  '      ','Show assembled parking which contract was terminated'
 
insert into [StrSource] 
([Ar],[En])
select  '    ','Show parking that inside assembled parking'
 
insert into [StrSource] 
([Ar],[En])
select  ' ','Recoding'
 
insert into [StrSource] 
([Ar],[En])
select  '   ','Recoding cost centers'
 
insert into [StrSource] 
([Ar],[En])
select  '   ','Renaming cost centers'
 
insert into [StrSource] 
([Ar],[En])
select  '    ','Recreate entries for contracts'
 
insert into [StrSource] 
([Ar],[En])
select  '   ','Use default options in Types'
 
insert into [StrSource] 
([Ar],[En])
select  '  ','Highest price for a property'
 
insert into [StrSource] 
([Ar],[En])
select  ' !','Please note !!'
 
insert into [StrSource] 
([Ar],[En])
select  '    ','Press start to proceed'
 
insert into [StrSource] 
([Ar],[En])
select  ' ','Reindexing'
 
insert into [StrSource] 
([Ar],[En])
select  ' ','Rename'
 
insert into [StrSource] 
([Ar],[En])
select  '   ','Renaming cost centers'
 
insert into [StrSource] 
([Ar],[En])
select  '  ','Assen inactive'
 
insert into [StrSource] 
([Ar],[En])
select  ' ','Latin view'
 
insert into [StrSource] 
([Ar],[En])
select  '','Benefit'
 
insert into [StrSource] 
([Ar],[En])
select  ' ','Autor enew'
 
insert into [StrSource] 
([Ar],[En])
select  '   ','Checking the connection with server'
 
insert into [StrSource] 
([Ar],[En])
select  ' ','New number'
 
insert into [StrSource] 
([Ar],[En])
select  ' ','Current number'
 
insert into [StrSource] 
([Ar],[En])
select  ' ','Used roads'
 
insert into [StrSource] 
([Ar],[En])
select  '  ','Operations on cheques'
 
insert into [StrSource] 
([Ar],[En])
select  '  ','Amount partly collected'
 
insert into [StrSource] 
([Ar],[En])
select  ' ','Leased area'
 
insert into [StrSource] 
([Ar],[En])
select  '  ','Non-leased area'
 
insert into [StrSource] 
([Ar],[En])
select  '  ','File does not exist'
 
insert into [StrSource] 
([Ar],[En])
select  '','Suppliers'
 
insert into [StrSource] 
([Ar],[En])
select  ' ','Blocked units'
 
insert into [StrSource] 
([Ar],[En])
select  ' ','Latin description'
 
insert into [StrSource] 
([Ar],[En])
select  ' :  [0] -  [1]:  [0] -  [1] :  [0] -  [1] -  [2] - [3] -  [4]','Notice: card type: Customer (0) - Supplier (1) Type: Company (0) - Person (1) Security level: Without (0) - Low (1) - Intermediate (2) - High (3) - Special (4)'
 
insert into [StrSource] 
([Ar],[En])
select  '  ','First payment details'
 
insert into [StrSource] 
([Ar],[En])
select  '   ','First payment latin details'
 
insert into [StrSource] 
([Ar],[En])
select  '  ','Contract latin details'
 
insert into [StrSource] 
([Ar],[En])
select  '  ','Return processing details'
 
insert into [StrSource] 
([Ar],[En])
select  '   ','Returned cheque termination date'
 
insert into [StrSource] 
([Ar],[En])
select  '       ','Cost center belong to contract termination account'
 
insert into [StrSource] 
([Ar],[En])
select  '    ','Cost center belong to revenue account'
 
insert into [StrSource] 
([Ar],[En])
select  '     ','Cost center belong to default account'
 
insert into [StrSource] 
([Ar],[En])
select  ' ','Loading data'
 
insert into [StrSource] 
([Ar],[En])
select  '  ','Loading card information'
 
insert into [StrSource] 
([Ar],[En])
select  '  ','Loading accounts table'
 
insert into [StrSource] 
([Ar],[En])
select  '  ','Loading customers table'
 
insert into [StrSource] 
([Ar],[En])
select  '  ','Loading units table'
 
insert into [StrSource] 
([Ar],[En])
select  '   ','Loading jobcost table'
 
insert into [StrSource] 
([Ar],[En])
select  ' ','Checking account balances'
 
insert into [StrSource] 
([Ar],[En])
select  ' ','Checking prices'
 
insert into [StrSource] 
([Ar],[En])
select  ' ','Checking data'
 
insert into [StrSource] 
([Ar],[En])
select  ' ','Checking permission'
 
insert into [StrSource] 
([Ar],[En])
select  ' ','Apply changes'
 
insert into [StrSource] 
([Ar],[En])
select  '  ','Estimate property value'
 
insert into [StrSource] 
([Ar],[En])
select  '  ','Return processing'
 
insert into [StrSource] 
([Ar],[En])
select  ' ','Prepare window'
 
insert into [StrSource] 
([Ar],[En])
select  '    ','Generate entries for contracts without exist entry'
 
insert into [StrSource] 
([Ar],[En])
select  ' ','Parking status'
 
insert into [StrSource] 
([Ar],[En])
select  ' ','Fees account'
 
insert into [StrSource] 
([Ar],[En])
select  ' ','Location map'
 
insert into [StrSource] 
([Ar],[En])
select  '  ','Floor No. between'
 
insert into [StrSource] 
([Ar],[En])
select  '             ','Report results will not be arranged properly and balance will not be different depending on selected sorting option'
 
insert into [StrSource] 
([Ar],[En])
select  '  ','Price per square meter'
 
insert into [StrSource] 
([Ar],[En])
select  '    ','Generating entries will be processed'
 
insert into [StrSource] 
([Ar],[En])
select  '      ','Data of this year will be transferred to new file'
 
insert into [StrSource] 
([Ar],[En])
select  '','Apartments'
 
insert into [StrSource] 
([Ar],[En])
select  '  ','Current contracts No.'
 
insert into [StrSource] 
([Ar],[En])
select  '  ','Previous contracts No.'
 
insert into [StrSource] 
([Ar],[En])
select  '  ','Leased villas No.'
 
insert into [StrSource] 
([Ar],[En])
select  '   ','Non-leased villas No.'
 
insert into [StrSource] 
([Ar],[En])
select  '   : ','You chose: '
 
insert into [StrSource] 
([Ar],[En])
select  '  ','Land current value'
 
insert into [StrSource] 
([Ar],[En])
select  '  ','Depreciation account value'
 
insert into [StrSource] 
([Ar],[En])
select  ' ','January'
 
insert into [StrSource] 
([Ar],[En])
select  '  ','Click Next to continue'
 
insert into [StrSource] 
([Ar],[En])
select  ' ','Shopping malls'
 
insert into [StrSource] 
([Ar],[En])
select  '  /','Returned since/day'
 
insert into [StrSource] 
([Ar],[En])
select  '  ','Credit cost center'
 
insert into [StrSource] 
([Ar],[En])
select  '  ','Debit cost center'
 
insert into [StrSource] 
([Ar],[En])
select  '','Mosque'
 
insert into [StrSource] 
([Ar],[En])
select  '  ','It went on Return'
 
insert into [StrSource] 
([Ar],[En])
select  '','Restaurants'
 
insert into [StrSource] 
([Ar],[En])
select  ' ','Return processing'
 
insert into [StrSource] 
([Ar],[En])
select  ' ','Building factors'
 
insert into [StrSource] 
([Ar],[En])
select  ' ','Area information'
 
insert into [StrSource] 
([Ar],[En])
select  '','Parking'
 
insert into [StrSource] 
([Ar],[En])
select  ' ','Property Features'
 
insert into [StrSource] 
([Ar],[En])
select  '  ','Property positives & negatives features'
 
insert into [StrSource] 
([Ar],[En])
select  '  ','About Property'
 
insert into [StrSource] 
([Ar],[En])
select  ' ','Evaluation Results'
 
insert into [StrSource] 
([Ar],[En])
select  '    ','Increased percentage of current contract'
 
insert into [StrSource] 
([Ar],[En])
select  '                  [A]   ','Text                [A] Customer name'
 
insert into [StrSource] 
([Ar],[En])
select  ' ','Region-wide'
 
insert into [StrSource] 
([Ar],[En])
select  ' ','Building system'
 
insert into [StrSource] 
([Ar],[En])
select  '  ','Latin property type'
 
insert into [StrSource] 
([Ar],[En])
select  '               ','This means that contracts will be modified according to the default accounts and will not be able to undo this process?'
 
insert into [StrSource] 
([Ar],[En])
select  '     ','Do you want to Renumbering cheques'
 
insert into [StrSource] 
([Ar],[En])
select  '    ','Do you want to Renumbering contracts'
 
insert into [StrSource] 
([Ar],[En])
select  '  ?','Do you want to continue?'
 
insert into [StrSource] 
([Ar],[En])
select  '     ','Do you want to delete the selected file attached'
 
insert into [StrSource] 
([Ar],[En])
select  '       ','We prefer to take a backup before performing this operation'
 
insert into [StrSource] 
([Ar],[En])
select  '',''
 
insert into [StrSource] 
([Ar],[En])
select  'SMS','SMS'
 
insert into [StrSource] 
([Ar],[En])
select  '   ','Last date of partial collection'
 
insert into [StrSource] 
([Ar],[En])
select  ' Email','Send Email'
 
insert into [StrSource] 
([Ar],[En])
select  '   ','Renumbering accounts card'
 
insert into [StrSource] 
([Ar],[En])
select  ' ','Use date'
 
insert into [StrSource] 
([Ar],[En])
select  '','Fees'
 
insert into [StrSource] 
([Ar],[En])
select  ' ','Commercial name'
 
insert into [StrSource] 
([Ar],[En])
select  '','Order'
 
insert into [StrSource] 
([Ar],[En])
select  '','Deposits'
 
insert into [StrSource] 
([Ar],[En])
select  '  ','Monthly Report'
 
insert into [StrSource] 
([Ar],[En])
select  ' ','Leased apartments'
 
insert into [StrSource] 
([Ar],[En])
select  '   ','Contracts near to expire'
 
insert into [StrSource] 
([Ar],[En])
select  '  ','Default value'
 
insert into [StrSource] 
([Ar],[En])
select  ' ','To type'
 
insert into [StrSource] 
([Ar],[En])
select  '  ','Services contract types'
 
insert into [StrSource] 
([Ar],[En])
select  '     ','Obverse account details from entry details'
 
insert into [StrSource] 
([Ar],[En])
select  '  ','Deposit retrieve date'
 
insert into [StrSource] 
([Ar],[En])
select  '     ','Move cost center with earned discount'
 
insert into [StrSource] 
([Ar],[En])
select  '    ','Move cost center with expenses'
 
insert into [StrSource] 
([Ar],[En])
select  ' ','Sequence cheque'
 
insert into [StrSource] 
([Ar],[En])
select  '  ','Deposits has been retrieved'
 
insert into [StrSource] 
([Ar],[En])
select  '   ','Contract has been delivered to customer'
 
insert into [StrSource] 
([Ar],[En])
select  '  ','Extra fields description'
 
insert into [StrSource] 
([Ar],[En])
select  '/  ','Sanitation A/C'
 
insert into [StrSource] 
([Ar],[En])
select  '  ','Cheque status'
 
insert into [StrSource] 
([Ar],[En])
select  '  : ','Until:'
 
insert into [StrSource] 
([Ar],[En])
select  ' ','Select building'
 
insert into [StrSource] 
([Ar],[En])
select  ' ','Delete return'
 
insert into [StrSource] 
([Ar],[En])
select  ' ','Delete collection'
 
insert into [StrSource] 
([Ar],[En])
select  '  ','Delete partial collection'
 
insert into [StrSource] 
([Ar],[En])
select  ' ','Delete deposit'
 
insert into [StrSource] 
([Ar],[En])
select  ' ','Delete endorsement'
 
insert into [StrSource] 
([Ar],[En])
select  ' ','Delete photos'
 
insert into [StrSource] 
([Ar],[En])
select  ' ','Fees account'
 
insert into [StrSource] 
([Ar],[En])
select  ' ','Electricity account'
 
insert into [StrSource] 
([Ar],[En])
select  ' ','Water account'
 
insert into [StrSource] 
([Ar],[En])
select  '   1','Fees revenue account 1'
 
insert into [StrSource] 
([Ar],[En])
select  '   2','Fees revenue account 2'
 
insert into [StrSource] 
([Ar],[En])
select  '   3','Fees revenue account 3'
 
insert into [StrSource] 
([Ar],[En])
select  '   4','Fees revenue account 4'
 
insert into [StrSource] 
([Ar],[En])
select  '   5','Fees revenue account 5'
 
insert into [StrSource] 
([Ar],[En])
select  ' ','Saving data'
 
insert into [StrSource] 
([Ar],[En])
select  ' ','Extra fields'
 
insert into [StrSource] 
([Ar],[En])
select  '   ','New message'
 
insert into [StrSource] 
([Ar],[En])
select  ' ','Material balance'
 
insert into [StrSource] 
([Ar],[En])
select  ' :','No:'
 
insert into [StrSource] 
([Ar],[En])
select  '  ','Duplicate report number'
 
insert into [StrSource] 
([Ar],[En])
select  ' ','Session number'
 
insert into [StrSource] 
([Ar],[En])
select  '  ','Duplicate shop number'
 
insert into [StrSource] 
([Ar],[En])
select  '  ','Entries has origin'
 
insert into [StrSource] 
([Ar],[En])
select  '       ','Jobcost for selected building will be Recoded'
 
insert into [StrSource] 
([Ar],[En])
select  '       ','Jobcost for selected building will be Renamed'
 
insert into [StrSource] 
([Ar],[En])
select  '   ','Select contracts will be renewed'
 
insert into [StrSource] 
([Ar],[En])
select  '  ','Data will be modified'
 
insert into [StrSource] 
([Ar],[En])
select  ' ','Contracts permission'
 
insert into [StrSource] 
([Ar],[En])
select  '  ','Adjust columns width'
 
insert into [StrSource] 
([Ar],[En])
select  '    ','Print unposted entreis origin'
 
insert into [StrSource] 
([Ar],[En])
select  ' ','Print receipts'
 
insert into [StrSource] 
([Ar],[En])
select  ' ','Print receipt'
 
insert into [StrSource] 
([Ar],[En])
select  ' ','Print photo'
 
insert into [StrSource] 
([Ar],[En])
select  '  ','Contracts total No.'
 
insert into [StrSource] 
([Ar],[En])
select  '    ','Contracts No. in previous years'
 
insert into [StrSource] 
([Ar],[En])
select  '      ','Not terminate contract when there is a customer balance'
 
insert into [StrSource] 
([Ar],[En])
select  ' ','Services contract'
 
insert into [StrSource] 
([Ar],[En])
select  ' ','Services contracts'
 
insert into [StrSource] 
([Ar],[En])
select  ' ','Maintenance contracts'
 
insert into [StrSource] 
([Ar],[En])
select  '','Return'
 
insert into [StrSource] 
([Ar],[En])
select  ' ','Unblocked'
 
insert into [StrSource] 
([Ar],[En])
select  ' ','Not refunded'
 
insert into [StrSource] 
([Ar],[En])
select  ' ','Electricity bill'
 
insert into [StrSource] 
([Ar],[En])
select  '    ','Revenue period from date'
 
insert into [StrSource] 
([Ar],[En])
select  '','Failed'
 
insert into [StrSource] 
([Ar],[En])
select  '  ','Allow automatic renewal'
 
insert into [StrSource] 
([Ar],[En])
select  ' ','Fees amount'
 
insert into [StrSource] 
([Ar],[En])
select  '    ','Increased value on current contract'
 
insert into [StrSource] 
([Ar],[En])
select  ' ','Cheque value'
 
insert into [StrSource] 
([Ar],[En])
select  '   ','Contract value after Increased'
 
insert into [StrSource] 
([Ar],[En])
select  '  ','Customer account statement'
 
insert into [StrSource] 
([Ar],[En])
select  ' ','Do not automatically renewed'
 
insert into [StrSource] 
([Ar],[En])
select  '   ','To retrieve apartments latest price'
 
insert into [StrSource] 
([Ar],[En])
select  '  ','Processing not complete'
 
insert into [StrSource] 
([Ar],[En])
select  '    ','Jobcost not created'
 
insert into [StrSource] 
([Ar],[En])
select  '          ','Total value in multiple jobcost is not match with cheque value'
 
insert into [StrSource] 
([Ar],[En])
select  '   = ','Total current rates ='
 
insert into [StrSource] 
([Ar],[En])
select  '','Admin'
 
insert into [StrSource] 
([Ar],[En])
select  '  ','Multiple cost center'
 
insert into [StrSource] 
([Ar],[En])
select  '','Refund'
 
insert into [StrSource] 
([Ar],[En])
select  ' ','From type'
 
insert into [StrSource] 
([Ar],[En])
select  '  ','Move entries cards'
 
insert into [StrSource] 
([Ar],[En])
select  ' ','Price type'
 
insert into [StrSource] 
([Ar],[En])
select  '    ','This entry is related with cheque'
 
insert into [StrSource] 
([Ar],[En])
select  '     ','This process may take a long time'
 
insert into [StrSource] 
([Ar],[En])
select  '    ','Do you want to delete the selected photo?'
 
insert into [StrSource] 
([Ar],[En])
select  '      ','Do you want to save the changes to increase contracts value'
 
insert into [StrSource] 
([Ar],[En])
select  ' ','Bill unit'
 
insert into [StrSource] 
([Ar],[En])
select  ' ','Entry time'
 
insert into [StrSource] 
([Ar],[En])
select  ' ','Automatically renewed'
 
insert into [StrSource] 
([Ar],[En])
select  ' !!','Please attention !!'
 
insert into [StrSource] 
([Ar],[En])
select  '  ','Maintenance operations'
 
insert into [StrSource] 
([Ar],[En])
select  '1 =  ','1 = debit only'
 
insert into [StrSource] 
([Ar],[En])
select  '10 ','10 months'
 
insert into [StrSource] 
([Ar],[En])
select  '11 ','11 months'
 
insert into [StrSource] 
([Ar],[En])
select  '2 =  ','2 = credit only'
 
insert into [StrSource] 
([Ar],[En])
select  '3 =   ','3 = credit or debit'
 
insert into [StrSource] 
([Ar],[En])
select  '4 ','4 months'
 
insert into [StrSource] 
([Ar],[En])
select  '5 ','5 months'
 
insert into [StrSource] 
([Ar],[En])
select  '7 ','7 months'
 
insert into [StrSource] 
([Ar],[En])
select  '8 ','8 months'
 
insert into [StrSource] 
([Ar],[En])
select  '9 ','9 months'
 
insert into [StrSource] 
([Ar],[En])
select  '  ','Negative products output'
 
insert into [StrSource] 
([Ar],[En])
select  '     ','Enter default account for receipt voucher type'
 
insert into [StrSource] 
([Ar],[En])
select  '    ','Enter credit account of return fees'
 
insert into [StrSource] 
([Ar],[En])
select  '   ','Enter credit account of deposit'
 
insert into [StrSource] 
([Ar],[En])
select  '    ','Enter debit account of return fees'
 
insert into [StrSource] 
([Ar],[En])
select  '   ','Enter debit account of deposit'
 
insert into [StrSource] 
([Ar],[En])
select  '  ','Enter deposit date'
 
insert into [StrSource] 
([Ar],[En])
select  '   ','Enter credit return account'
 
insert into [StrSource] 
([Ar],[En])
select  '   ','Enter debit return account'
 
insert into [StrSource] 
([Ar],[En])
select  '   ','Enter credit collection account'
 
insert into [StrSource] 
([Ar],[En])
select  '   ','Enter debit collection account'
 
insert into [StrSource] 
([Ar],[En])
select  '   ','Enter fees account for the line'
 
insert into [StrSource] 
([Ar],[En])
select  '    ','Enter units for this building'
 
insert into [StrSource] 
([Ar],[En])
select  '  ','Enter property type'
 
insert into [StrSource] 
([Ar],[En])
select  '  ','Send Email'
 
insert into [StrSource] 
([Ar],[En])
select  ' Google Maps','Browse Google Maps'
 
insert into [StrSource] 
([Ar],[En])
select  '    ','ReNumbering jobcost for building'
 
insert into [StrSource] 
([Ar],[En])
select  '  ','Uncheck All'
 
insert into [StrSource] 
([Ar],[En])
select  ' ','Create entries'
 
insert into [StrSource] 
([Ar],[En])
select  ' ','Entries types'
 
insert into [StrSource] 
([Ar],[En])
select  '  ','Services contract types'
 
insert into [StrSource] 
([Ar],[En])
select  '  ','Maintenance contract types'
 
insert into [StrSource] 
([Ar],[En])
select  '','Stop'
 
insert into [StrSource] 
([Ar],[En])
select  ' ','Add Photo'
 
insert into [StrSource] 
([Ar],[En])
select  '  ','Scanner settings'
 
insert into [StrSource] 
([Ar],[En])
select  '','Tools'
 
insert into [StrSource] 
([Ar],[En])
select  '  ','Contracts cheque report'
 
insert into [StrSource] 
([Ar],[En])
select  '','Revenue'
 
insert into [StrSource] 
([Ar],[En])
select  '  ','Contracts cheque report'
 
insert into [StrSource] 
([Ar],[En])
select  '','Deposits'
 
insert into [StrSource] 
([Ar],[En])
select  '','Issue'
 
insert into [StrSource] 
([Ar],[En])
select  '','Reports'
 
insert into [StrSource] 
([Ar],[En])
select  ' ','Monthly Report'
 
insert into [StrSource] 
([Ar],[En])
select  ' ','Minimum'
 
insert into [StrSource] 
([Ar],[En])
select  ' ','Maximum'
 
insert into [StrSource] 
([Ar],[En])
select  '   ','Increase on the current contract'
 
insert into [StrSource] 
([Ar],[En])
select  ' ','Returned cheques'
 
insert into [StrSource] 
([Ar],[En])
select  '  ','Expired contract'
 
insert into [StrSource] 
([Ar],[En])
select  ' ','Bill checked'
 
insert into [StrSource] 
([Ar],[En])
select  '  ','Unposted entry'
 
insert into [StrSource] 
([Ar],[En])
select  '      ','Entry has origin are you sure to modify?'
 
insert into [StrSource] 
([Ar],[En])
select  '    ','Entry is related to cheque collection'
 
insert into [StrSource] 
([Ar],[En])
select  ' ','Annual value'
 
insert into [StrSource] 
([Ar],[En])
select  '  ','New Quantity become'
 
insert into [StrSource] 
([Ar],[En])
select  ' ','Current quantity'
 
insert into [StrSource] 
([Ar],[En])
select  '','Blocked'
 
insert into [StrSource] 
([Ar],[En])
select  '','Expenses'
 
insert into [StrSource] 
([Ar],[En])
select  '  ','File is invalid'
 
insert into [StrSource] 
([Ar],[En])
select  ' ','Empty units'
 
insert into [StrSource] 
([Ar],[En])
select  '','Warning'
 
insert into [StrSource] 
([Ar],[En])
select  ' ','Residence expiry'
 
insert into [StrSource] 
([Ar],[En])
select  ' ','ID expiry'
 
insert into [StrSource] 
([Ar],[En])
select  '  ','Passport expiry'
 
insert into [StrSource] 
([Ar],[En])
select  '','Revenue'
 
insert into [StrSource] 
([Ar],[En])
select  ' ','Lawsuit card'
 
insert into [StrSource] 
([Ar],[En])
select  ' ','Villa card'
 
insert into [StrSource] 
([Ar],[En])
select  '    ','Regardless of the specific options'
 
insert into [StrSource] 
([Ar],[En])
select  '     ','Make sure you enter code characters only'
 
insert into [StrSource] 
([Ar],[En])
select  '      : ','Make sure the database path:'
 
insert into [StrSource] 
([Ar],[En])
select  ' ','Due date'
 
insert into [StrSource] 
([Ar],[En])
select  ' ','Refund date'
 
insert into [StrSource] 
([Ar],[En])
select  ' ','Return date'
 
insert into [StrSource] 
([Ar],[En])
select  '      ','Make sure you enter value in the line'
 
insert into [StrSource] 
([Ar],[En])
select  '   ','Make sure the correct path'
 
insert into [StrSource] 
([Ar],[En])
select  ' ','Ignore all'
 
insert into [StrSource] 
([Ar],[En])
select  ' ','Material exceeded'
 
insert into [StrSource] 
([Ar],[En])
select  '     ','Exceeded allowed discount rate'
 
insert into [StrSource] 
([Ar],[En])
select  '   ','Renew lands and villas contract'
 
insert into [StrSource] 
([Ar],[En])
select  '   ','Renew flats and shops contract'
 
insert into [StrSource] 
([Ar],[En])
select  '  ','Renew parking contract'
 
insert into [StrSource] 
([Ar],[En])
select  '   ','Update contract fees'
 
insert into [StrSource] 
([Ar],[En])
select  '  ','Select all'
 
insert into [StrSource] 
([Ar],[En])
select  ' ...','Loading ...'
 
insert into [StrSource] 
([Ar],[En])
select  ' ','Loading currency'
 
insert into [StrSource] 
([Ar],[En])
select  '  ','Checking account balances'
 
insert into [StrSource] 
([Ar],[En])
select  ' csv ...','Export csv ...'
 
insert into [StrSource] 
([Ar],[En])
select  '  ','Message has been sent'
 
insert into [StrSource] 
([Ar],[En])
select  '    ','Contract sent to registration'
 
insert into [StrSource] 
([Ar],[En])
select  '    ','Data restore successfully done'
 
insert into [StrSource] 
([Ar],[En])
select  '  ','Contract was terminated'
 
insert into [StrSource] 
([Ar],[En])
select  '    ','Contract received from registration'
 
insert into [StrSource] 
([Ar],[En])
select  ' ','Evacuated'
 
insert into [StrSource] 
([Ar],[En])
select  ' ','Sent'
 
insert into [StrSource] 
([Ar],[En])
select  '  ','Sent to registration'
 
insert into [StrSource] 
([Ar],[En])
select  '   ','Received from registration'
 
insert into [StrSource] 
([Ar],[En])
select  ' ','Terminated'
 
insert into [StrSource] 
([Ar],[En])
select  ' ','Deposited'
 
insert into [StrSource] 
([Ar],[En])
select  ' ','Lawsuit expenses'
 
insert into [StrSource] 
([Ar],[En])
select  '  ','Result unknown'
 
insert into [StrSource] 
([Ar],[En])
select  'Check connection settings','Check connection settings'
 
insert into [StrSource] 
([Ar],[En])
select  'Check database path : ','Check database path : '
 
insert into [StrSource] 
([Ar],[En])
select  '  ','Add partial collection'
 
insert into [StrSource] 
([Ar],[En])
select  '  ','without due date'
 
insert into [StrSource] 
([Ar],[En])
select  '        ','Contract end date outside of starting and ending period'
 
insert into [StrSource] 
([Ar],[En])
select  '  ','Design printed receipt'
 
insert into [StrSource] 
([Ar],[En])
select  '  ','Modify partial collection'
 
insert into [StrSource] 
([Ar],[En])
select  '  ','Modify flats specification'
 
insert into [StrSource] 
([Ar],[En])
select  '  ','Modify shops specification'
 
insert into [StrSource] 
([Ar],[En])
select  ' ','Change account'
 
insert into [StrSource] 
([Ar],[En])
select  ' ','Change accounts'
 
insert into [StrSource] 
([Ar],[En])
select  ' ','Lawsuits report'
 
insert into [StrSource] 
([Ar],[En])
select  '  ','Buildings offer report'
 
insert into [StrSource] 
([Ar],[En])
select  '   ','Contract checking has been canceled'
 
insert into [StrSource] 
([Ar],[En])
select  '  ','Deposit has been returned'
 
insert into [StrSource] 
([Ar],[En])
select  ' ','Has been renewal'
 
insert into [StrSource] 
([Ar],[En])
select  '  ','Redirected to'
 
insert into [StrSource] 
([Ar],[En])
select  '        ,   ','Data has been modified by another user, the data will be updated'
 
insert into [StrSource] 
([Ar],[En])
select  ' ','Renewal has been done'
 
insert into [StrSource] 
([Ar],[En])
select  ' ','Update done'
 
insert into [StrSource] 
([Ar],[En])
select  '  : ','Update done'
 
insert into [StrSource] 
([Ar],[En])
select  '   ','Prices have been updated'
 
insert into [StrSource] 
([Ar],[En])
select  '       ','Fees has been collected by receipt order'
 
insert into [StrSource] 
([Ar],[En])
select  '    ','Contract delivered to customer'
 
insert into [StrSource] 
([Ar],[En])
select  '  : ','It has been modified'
 
insert into [StrSource] 
([Ar],[En])
select  '      ,     ','Building name has been modified by you, do you want to modify account name?'
 
insert into [StrSource] 
([Ar],[En])
select  '      ,       ','Building name has been modified by you, do you want to modify cost center account name?'
 
insert into [StrSource] 
([Ar],[En])
select  '      ,      ','Building name has been modified by you, do you want to modify cost center account name?'
 
insert into [StrSource] 
([Ar],[En])
select  '      ,     ','Customer name has been modified by you, do you want to modify account name?'
 
insert into [StrSource] 
([Ar],[En])
select  '      ,      ','Customer name has been modified by you, do you want to modify deposit account name?'
 
insert into [StrSource] 
([Ar],[En])
select  '   ','Status has been modified successfully'
 
insert into [StrSource] 
([Ar],[En])
select  '        ','Flat number has been changed, do you want to change cost center account name?'
 
insert into [StrSource] 
([Ar],[En])
select  '        ','Shop No has been modified do you want to modify cost center?'
 
insert into [StrSource] 
([Ar],[En])
select  '    ','Password was modified successfully'
 
insert into [StrSource] 
([Ar],[En])
select  '      ','Calculation method has been defined for this group'
 
insert into [StrSource] 
([Ar],[En])
select  ' ','Changes has been done'
 
insert into [StrSource] 
([Ar],[En])
select  '       ','Column places was changed ,Do you want to save changes?'
 
insert into [StrSource] 
([Ar],[En])
select  '  ','Contract registered'
 
insert into [StrSource] 
([Ar],[En])
select  '    ','Contract printed and authorized'
 
insert into [StrSource] 
([Ar],[En])
select  '  ','Contract checking has been done'
 
insert into [StrSource] 
([Ar],[En])
select  ' ','Transfer has been done'
 
insert into [StrSource] 
([Ar],[En])
select  ' ','Maintenance done'
 
insert into [StrSource] 
([Ar],[En])
select  '  ','Operation successfully complete'
 
insert into [StrSource] 
([Ar],[En])
select  '   ','Closing files process has successfully complete'
 
insert into [StrSource] 
([Ar],[En])
select  '  ','Maintenance done'
 
insert into [StrSource] 
([Ar],[En])
select  '          ','This process enables you to re-write details of selected checks'
 
insert into [StrSource] 
([Ar],[En])
select  '          
  ','This process enables you to re-write details of selected checks
Do you want to continue?'
 
insert into [StrSource] 
([Ar],[En])
select  '          
  ','This process enables you to re-write details of selected checks
Do you want to continue?'
 
insert into [StrSource] 
([Ar],[En])
select  '','Descending'
 
insert into [StrSource] 
([Ar],[En])
select  '     ','Alert for due payble cheque before'
 
insert into [StrSource] 
([Ar],[En])
select  '     :','Alert for due receivable cheque before'
 
insert into [StrSource] 
([Ar],[En])
select  '     ','Alert for contracts expiry before'
 
insert into [StrSource] 
([Ar],[En])
select  '    ','Alert for due payble cheques before:'
 
insert into [StrSource] 
([Ar],[En])
select  '    ','Alert for due receivable cheques before:'
 
insert into [StrSource] 
([Ar],[En])
select  '    ','Alert for contracts expiry before:'
 
insert into [StrSource] 
([Ar],[En])
select  ' SMS','SMS Alerts'
 
insert into [StrSource] 
([Ar],[En])
select  ' ','Numbers format'
 
insert into [StrSource] 
([Ar],[En])
select  ' ','Date format'
 
insert into [StrSource] 
([Ar],[En])
select  ' ','Processing'
 
insert into [StrSource] 
([Ar],[En])
select  ' ','Contract registration'
 
insert into [StrSource] 
([Ar],[En])
select  ' ','Profit distribution'
 
insert into [StrSource] 
([Ar],[En])
select  ' ','Amount distribution'
 
insert into [StrSource] 
([Ar],[En])
select  ' ','Multiple accounts'
 
insert into [StrSource] 
([Ar],[En])
select  '  ','Customer credit balance'
 
insert into [StrSource] 
([Ar],[En])
select  '    ','Customer balance is not equal to zero'
 
insert into [StrSource] 
([Ar],[En])
select  '  ','Customer debit balance'
 
insert into [StrSource] 
([Ar],[En])
select  '  ','Duplicate receipt number'
 
insert into [StrSource] 
([Ar],[En])
select  ' ','Selling Price'
 
insert into [StrSource] 
([Ar],[En])
select  '  1','Selling Price 1'
 
insert into [StrSource] 
([Ar],[En])
select  '  2','Selling Price 2'
 
insert into [StrSource] 
([Ar],[En])
select  '  3','Selling Price 3'
 
insert into [StrSource] 
([Ar],[En])
select  ' ','Contract price'
 
insert into [StrSource] 
([Ar],[En])
select  ' ','Cost price'
 
insert into [StrSource] 
([Ar],[En])
select  ' ','Specific price'
 
insert into [StrSource] 
([Ar],[En])
select  '','Year'
 
insert into [StrSource] 
([Ar],[En])
select  ' ','Journal enrty'
 
insert into [StrSource] 
([Ar],[En])
select  ' ','Journal entry'
 
insert into [StrSource] 
([Ar],[En])
select  ' ','Payment voucher'
 
insert into [StrSource] 
([Ar],[En])
select  ' ','Payment voucher'
 
insert into [StrSource] 
([Ar],[En])
select  ' ','Reciept voucher'
 
insert into [StrSource] 
([Ar],[En])
select  ' ','Journal enrty'
 
insert into [StrSource] 
([Ar],[En])
select  '','Annual'
 
insert into [StrSource] 
([Ar],[En])
select  '    ','User session will be terminated'
 
insert into [StrSource] 
([Ar],[En])
select  '    ','Checking accounts balance will start now'
 
insert into [StrSource] 
([Ar],[En])
select  '','2 month'
 
insert into [StrSource] 
([Ar],[En])
select  '  ','Contract days No'
 
insert into [StrSource] 
([Ar],[En])
select  '  ','Contract terminate difference'
 
insert into [StrSource] 
([Ar],[En])
select  '   ','Contract amount was collected'
 
insert into [StrSource] 
([Ar],[En])
select  '     ','Total value is not match with contract value'
 
insert into [StrSource] 
([Ar],[En])
select  '        ','Total value in multiple accounts is not match with contract value'
 
insert into [StrSource] 
([Ar],[En])
select  '','Canceled'
 
insert into [StrSource] 
([Ar],[En])
select  '      ','Discount rate larger than the allowable percentage'
 
insert into [StrSource] 
([Ar],[En])
select  '      ','Do you want to cancel checked of related cheques?'
 
insert into [StrSource] 
([Ar],[En])
select  '      ','Do you want to cancel checked of related cash payments?'
 
insert into [StrSource] 
([Ar],[En])
select  '   ','Do you want to continue?'
 
insert into [StrSource] 
([Ar],[En])
select  '     ','Do you want to check the related cheques?'
 
insert into [StrSource] 
([Ar],[En])
select  '     ','Do you want to review the related cash payments?'
 
insert into [StrSource] 
([Ar],[En])
select  ' ','Suspended'
 
insert into [StrSource] 
([Ar],[En])
select  ' !','Please attention !!'
 
insert into [StrSource] 
([Ar],[En])
select  '     ','There is related parking contracts with this contract'
 
insert into [StrSource] 
([Ar],[En])
select  ' ','Problem causes'
 
insert into [StrSource] 
([Ar],[En])
select  '  ','Reasons for non-completion'
 
insert into [StrSource] 
([Ar],[En])
select  '','Week'
 
insert into [StrSource] 
([Ar],[En])
select  '  ','Exclude from asset'
 
insert into [StrSource] 
([Ar],[En])
select  '  ','Exclude from asset'
 
insert into [StrSource] 
([Ar],[En])
select  '','Investment'
 
insert into [StrSource] 
([Ar],[En])
select  ' ','Exception cards'
 
insert into [StrSource] 
([Ar],[En])
select  '    ','Exclude empty and balanced cards'
 
insert into [StrSource] 
([Ar],[En])
select  '  ','Exclude opening entries'
 
insert into [StrSource] 
([Ar],[En])
select  '','Restore'
 
insert into [StrSource] 
([Ar],[En])
select  '  ','Restore data backup'
 
insert into [StrSource] 
([Ar],[En])
select  '  ','Restore data backup'
 
insert into [StrSource] 
([Ar],[En])
select  '  ','Restore columns sort'
 
insert into [StrSource] 
([Ar],[En])
select  '  ','Restore data backup'
 
insert into [StrSource] 
([Ar],[En])
select  ' ','View accounts'
 
insert into [StrSource] 
([Ar],[En])
select  ' ','View checked'
 
insert into [StrSource] 
([Ar],[En])
select  '  ','View branch permissions'
 
insert into [StrSource] 
([Ar],[En])
select  '   ','View exchange rate'
 
insert into [StrSource] 
([Ar],[En])
select  '  ','View log file'
 
insert into [StrSource] 
([Ar],[En])
select  '  ','View installments windows '
 
insert into [StrSource] 
([Ar],[En])
select  '  ','View log window'
 
insert into [StrSource] 
([Ar],[En])
select  '...','Browse...'
 
insert into [StrSource] 
([Ar],[En])
select  ' ','Receiving building'
 
insert into [StrSource] 
([Ar],[En])
select  ' xls ...','Import From xls ...'
 
insert into [StrSource] 
([Ar],[En])
select  '','Prices'
 
insert into [StrSource] 
([Ar],[En])
select  ' ','Exchange rates'
 
insert into [StrSource] 
([Ar],[En])
select  ' ','Asset name'
 
insert into [StrSource] 
([Ar],[En])
select  ' ','Order name'
 
insert into [StrSource] 
([Ar],[En])
select  ' ','Building name'
 
insert into [StrSource] 
([Ar],[En])
select  ' ','Bank name'
 
insert into [StrSource] 
([Ar],[En])
select  ' ','Account name'
 
insert into [StrSource] 
([Ar],[En])
select  '  ','Account name duplicate'
 
insert into [StrSource] 
([Ar],[En])
select  ' ','Customer name'
 
insert into [StrSource] 
([Ar],[En])
select  ' ','Partner name'
 
insert into [StrSource] 
([Ar],[En])
select  ' ','Menu name'
 
insert into [StrSource] 
([Ar],[En])
select  '  ','Latin menu name'
 
insert into [StrSource] 
([Ar],[En])
select  ' ','Computer name'
 
insert into [StrSource] 
([Ar],[En])
select  ' ','Complex name'
 
insert into [StrSource] 
([Ar],[En])
select  '  ','City name duplicate'
 
insert into [StrSource] 
([Ar],[En])
select  ' ','Tenants name'
 
insert into [StrSource] 
([Ar],[En])
select  ' ','Tenants name'
 
insert into [StrSource] 
([Ar],[En])
select  ' ','User Name'
 
insert into [StrSource] 
([Ar],[En])
select  ' ','Beneficiary name'
 
insert into [StrSource] 
([Ar],[En])
select  ' ','Area name'
 
insert into [StrSource] 
([Ar],[En])
select  ' ','Supplier name'
 
insert into [StrSource] 
([Ar],[En])
select  ' ','Type Name'
 
insert into [StrSource] 
([Ar],[En])
select  '  ','Currency part name'
 
insert into [StrSource] 
([Ar],[En])
select  '   ','Currency part latin name'
 
insert into [StrSource] 
([Ar],[En])
select  '  ','Currency part name'
 
insert into [StrSource] 
([Ar],[En])
select  '   ','Currency part latin name'
 
insert into [StrSource] 
([Ar],[En])
select  '  ','Property owner name'
 
insert into [StrSource] 
([Ar],[En])
select  '    ','Name of new database file'
 
insert into [StrSource] 
([Ar],[En])
select  '  ','Less or Equal'
 
insert into [StrSource] 
([Ar],[En])
select  ' ','Less than'
 
insert into [StrSource] 
([Ar],[En])
select  ' ','Asset category'
 
insert into [StrSource] 
([Ar],[En])
select  '','Additions'
 
insert into [StrSource] 
([Ar],[En])
select  ' ','Processed'
 
insert into [StrSource] 
([Ar],[En])
select  '  ','Expand all columns'
 
insert into [StrSource] 
([Ar],[En])
select  '   /      ','Allow to generate cheques even with the mismatch amount'
 
insert into [StrSource] 
([Ar],[En])
select  '/  ','Revenue A/C'
 
insert into [StrSource] 
([Ar],[En])
select  '/   ','Currency differences A/C'
 
insert into [StrSource] 
([Ar],[En])
select  '  ','Contract input case'
 
insert into [StrSource] 
([Ar],[En])
select  ' ','Land status'
 
insert into [StrSource] 
([Ar],[En])
select  ' ','Termination status'
 
insert into [StrSource] 
([Ar],[En])
select  ' ','Leaasing status'
 
insert into [StrSource] 
([Ar],[En])
select  ' ','Garden status'
 
insert into [StrSource] 
([Ar],[En])
select  ' ','Flat status'
 
insert into [StrSource] 
([Ar],[En])
select  ' ','Maintenance status'
 
insert into [StrSource] 
([Ar],[En])
select  ' ','Offer status'
 
insert into [StrSource] 
([Ar],[En])
select  ' ','Property status'
 
insert into [StrSource] 
([Ar],[En])
select  ' ','Contract status'
 
insert into [StrSource] 
([Ar],[En])
select  ' ','Villa status'
 
insert into [StrSource] 
([Ar],[En])
select  '','Reserve'
 
insert into [StrSource] 
([Ar],[En])
select  ' ','Property reservation'
 
insert into [StrSource] 
([Ar],[En])
select  ' ','Font size'
 
insert into [StrSource] 
([Ar],[En])
select  '  ','The following error occurred'
 
insert into [StrSource] 
([Ar],[En])
select  '  ','Select the user name'
 
insert into [StrSource] 
([Ar],[En])
select  '    ','Select the final accounts to be closed'
 
insert into [StrSource] 
([Ar],[En])
select  '    ','Chose Debit / Credit account'
 
insert into [StrSource] 
([Ar],[En])
select  '  ','Select ownership type'
 
insert into [StrSource] 
([Ar],[En])
select  '','Delete'
 
insert into [StrSource] 
([Ar],[En])
select  '  ','Delete All'
 
insert into [StrSource] 
([Ar],[En])
select  '  ','Delete selected land'
 
insert into [StrSource] 
([Ar],[En])
select  '  ','Delete selected flats'
 
insert into [StrSource] 
([Ar],[En])
select  ' ','Delete flats'
 
insert into [StrSource] 
([Ar],[En])
select  '  ','Delete servants flats'
 
insert into [StrSource] 
([Ar],[En])
select  '  ','Delete selected line'
 
insert into [StrSource] 
([Ar],[En])
select  ' ','Delete journal entry'
 
insert into [StrSource] 
([Ar],[En])
select  '  ','Delete selected shop'
 
insert into [StrSource] 
([Ar],[En])
select  ' ','Delete shops'
 
insert into [StrSource] 
([Ar],[En])
select  ' ','Delete warehouses'
 
insert into [StrSource] 
([Ar],[En])
select  ' ','Delete offices'
 
insert into [StrSource] 
([Ar],[En])
select  ' ','Delete parking'
 
insert into [StrSource] 
([Ar],[En])
select  ' ','Delete location'
 
insert into [StrSource] 
([Ar],[En])
select  '  ','Delete others reminders'
 
insert into [StrSource] 
([Ar],[En])
select  ' ','Delete row'
 
insert into [StrSource] 
([Ar],[En])
select  '  ','Delete drivers flats'
 
insert into [StrSource] 
([Ar],[En])
select  '  ','Delete mizanin'
 
insert into [StrSource] 
([Ar],[En])
select  '   ','Delete pent house'
 
insert into [StrSource] 
([Ar],[En])
select  '','Activity'
 
insert into [StrSource] 
([Ar],[En])
select  '','Add'
 
insert into [StrSource] 
([Ar],[En])
select  ' ','Add land'
 
insert into [StrSource] 
([Ar],[En])
select  ' ...','Add details...'
 
insert into [StrSource] 
([Ar],[En])
select  '  ','Add to asset'
 
insert into [StrSource] 
([Ar],[En])
select  '  ','Add to asset'
 
insert into [StrSource] 
([Ar],[En])
select  ' ','Add flat'
 
insert into [StrSource] 
([Ar],[En])
select  '  ','Add buildings flats'
 
insert into [StrSource] 
([Ar],[En])
select  '  ','Add buildings flats'
 
insert into [StrSource] 
([Ar],[En])
select  '   ','Try again'
 
insert into [StrSource] 
([Ar],[En])
select  ' ','Maps settings'
 
insert into [StrSource] 
([Ar],[En])
select  '','Settings'
 
insert into [StrSource] 
([Ar],[En])
select  ' &SMS','SMS Settings'
 
insert into [StrSource] 
([Ar],[En])
select  ' SMS','SMS Settings'
 
insert into [StrSource] 
([Ar],[En])
select  ' ','Map ettings'
 
insert into [StrSource] 
([Ar],[En])
select  '  ','Previous years settings'
 
insert into [StrSource] 
([Ar],[En])
select  ' ','General settings'
 
insert into [StrSource] 
([Ar],[En])
select  '  ','Building plan settings'
 
insert into [StrSource] 
([Ar],[En])
select  '','Close'
 
insert into [StrSource] 
([Ar],[En])
select  '  ','Close all windows'
 
insert into [StrSource] 
([Ar],[En])
select  '','Default'
 
insert into [StrSource] 
([Ar],[En])
select  '     ','Partial collection generate journal entry automatically'
 
insert into [StrSource] 
([Ar],[En])
select  '  ','Collection generate journal entry'
 
insert into [StrSource] 
([Ar],[En])
select  '    ','Collection generate journal entry automatically'
 
insert into [StrSource] 
([Ar],[En])
select  '','Check box'
 
insert into [StrSource] 
([Ar],[En])
select  '','Reminder'
 
insert into [StrSource] 
([Ar],[En])
select  '','Sorting'
 
insert into [StrSource] 
([Ar],[En])
select  '','Translate'
 
insert into [StrSource] 
([Ar],[En])
select  '    ','Data backup successfully done'
 
insert into [StrSource] 
([Ar],[En])
select  '  SMS','SMS was sent successfully'
 
insert into [StrSource] 
([Ar],[En])
select  '  ','Chart of cost center'
 
insert into [StrSource] 
([Ar],[En])
select  ' ','Contract cycle'
 
insert into [StrSource] 
([Ar],[En])
select  ' ','Capital'
 
insert into [StrSource] 
([Ar],[En])
select  '  ','Contact system administrator'
 
insert into [StrSource] 
([Ar],[En])
select  '  ','Link user with salesman'
 
insert into [StrSource] 
([Ar],[En])
select  '','Back'
 
insert into [StrSource] 
([Ar],[En])
select  ' ','Other fees'
 
insert into [StrSource] 
([Ar],[En])
select  ' ','Activity balance'
 
insert into [StrSource] 
([Ar],[En])
select  ' ','SMS Balance'
 
insert into [StrSource] 
([Ar],[En])
select  ' ','Customer balance'
 
insert into [StrSource] 
([Ar],[En])
select  '  ','Period credit balance'
 
insert into [StrSource] 
([Ar],[En])
select  '  ','Period debit balance'
 
insert into [StrSource] 
([Ar],[En])
select  ' ','Account balance'
 
insert into [StrSource] 
([Ar],[En])
select  '  ','Previous credit balance'
 
insert into [StrSource] 
([Ar],[En])
select  '  ','Previous debit balance'
 
insert into [StrSource] 
([Ar],[En])
select  '  ','Final credit balance'
 
insert into [StrSource] 
([Ar],[En])
select  '  ','Final debit balance'
 
insert into [StrSource] 
([Ar],[En])
select  '','No.'
 
insert into [StrSource] 
([Ar],[En])
select  '  ','Maintenance order No.'
 
insert into [StrSource] 
([Ar],[En])
select  '  ','Building No.'
 
insert into [StrSource] 
([Ar],[En])
select  ' ','Receipt No.'
 
insert into [StrSource] 
([Ar],[En])
select  ' ','Card No.'
 
insert into [StrSource] 
([Ar],[En])
select  '  : ','Card number:'
 
insert into [StrSource] 
([Ar],[En])
select  ' ','Building No.'
 
insert into [StrSource] 
([Ar],[En])
select  ' ','Mobile'
 
insert into [StrSource] 
([Ar],[En])
select  ' ','Account No.'
 
insert into [StrSource] 
([Ar],[En])
select  ' ','Basin No.'
 
insert into [StrSource] 
([Ar],[En])
select  ' ','Ownership entry No.'
 
insert into [StrSource] 
([Ar],[En])
select  ' ','Car plate No.'
 
insert into [StrSource] 
([Ar],[En])
select  ' ','Shipping number'
 
insert into [StrSource] 
([Ar],[En])
select  ' ','Flat No.'
 
insert into [StrSource] 
([Ar],[En])
select  '  / ','Flat / Shop No.'
 
insert into [StrSource] 
([Ar],[En])
select  ' ','Complaint No.'
 
insert into [StrSource] 
([Ar],[En])
select  '  ','Complaint number duplicate'
 
insert into [StrSource] 
([Ar],[En])
select  ' ','Cheque No.'
 
insert into [StrSource] 
([Ar],[En])
select  ' ','Property No.'
 
insert into [StrSource] 
([Ar],[En])
select  ' ','Contract No.'
 
insert into [StrSource] 
([Ar],[En])
select  '  : ','Contract No.'
 
insert into [StrSource] 
([Ar],[En])
select  ' ','Villa No.'
 
insert into [StrSource] 
([Ar],[En])
select  ' ','Area No.'
 
insert into [StrSource] 
([Ar],[En])
select  '  ','Entry No.'
 
insert into [StrSource] 
([Ar],[En])
select  '  ','Opening entry number'
 
insert into [StrSource] 
([Ar],[En])
select  '  ','Journal entry duplicate'
 
insert into [StrSource] 
([Ar],[En])
select  ' ','Shop No.'
 
insert into [StrSource] 
([Ar],[En])
select  ' ','Parking No.'
 
insert into [StrSource] 
([Ar],[En])
select  ' ','Phone No.'
 
insert into [StrSource] 
([Ar],[En])
select  ' ','Unit No.'
 
insert into [StrSource] 
([Ar],[En])
select  '  ','Labour card No.'
 
insert into [StrSource] 
([Ar],[En])
select  '  ','Lessor card No.'
 
insert into [StrSource] 
([Ar],[En])
select  '   ','ID card No.'
 
insert into [StrSource] 
([Ar],[En])
select  '  ','Passport No.'
 
insert into [StrSource] 
([Ar],[En])
select  '  ','Electricity meter No.'
 
insert into [StrSource] 
([Ar],[En])
select  '  ','Water meter No.'
 
insert into [StrSource] 
([Ar],[En])
select  '  ','Business No.'
 
insert into [StrSource] 
([Ar],[En])
select  '    ','Resident No. and issued by'
 
insert into [StrSource] 
([Ar],[En])
select  ' ','Asset code'
 
insert into [StrSource] 
([Ar],[En])
select  ' ','Barcode'
 
insert into [StrSource] 
([Ar],[En])
select  ' ','Building code'
 
insert into [StrSource] 
([Ar],[En])
select  ' ','Account code'
 
insert into [StrSource] 
([Ar],[En])
select  '','Asset code'
 
insert into [StrSource] 
([Ar],[En])
select  '','Cutomer'
 
insert into [StrSource] 
([Ar],[En])
select  '   ','Increase in asset life'
 
insert into [StrSource] 
([Ar],[En])
select  ' ','Reminder time'
 
insert into [StrSource] 
([Ar],[En])
select  ' ','Return reason'
 
insert into [StrSource] 
([Ar],[En])
select  ' ','Delay reason'
 
insert into [StrSource] 
([Ar],[En])
select  '      :','All activities of this account will be transferred:'
 
insert into [StrSource] 
([Ar],[En])
select  ' ','Desktop'
 
insert into [StrSource] 
([Ar],[En])
select  ' ','New row'
 
insert into [StrSource] 
([Ar],[En])
select  ' ','Rent price'
 
insert into [StrSource] 
([Ar],[En])
select  ' ','Rent price'
 
insert into [StrSource] 
([Ar],[En])
select  ' ','Rent price'
 
insert into [StrSource] 
([Ar],[En])
select  '    ','Empty window after data added'
 
insert into [StrSource] 
([Ar],[En])
select  '    ','Empty window after data deletion'
 
insert into [StrSource] 
([Ar],[En])
select  '','Horizontally'
 
insert into [StrSource] 
([Ar],[En])
select  ' ','Contract installments'
 
insert into [StrSource] 
([Ar],[En])
select  '   ','Contract installments by plan'
 
insert into [StrSource] 
([Ar],[En])
select  '  ','Close maintenance order '
 
insert into [StrSource] 
([Ar],[En])
select  ' ','Close complaint'
 
insert into [StrSource] 
([Ar],[En])
select  '  ','Close maintenance complaint'
 
insert into [StrSource] 
([Ar],[En])
select  '  ','Largest or Equal'
 
insert into [StrSource] 
([Ar],[En])
select  ' ','More than'
 
insert into [StrSource] 
([Ar],[En])
select  '  ','More than once'
 
insert into [StrSource] 
([Ar],[En])
select  ' ','Cancel'
 
insert into [StrSource] 
([Ar],[En])
select  ' ','Cancel reservation'
 
insert into [StrSource] 
([Ar],[En])
select  '  ','Cancel other reservation'
 
insert into [StrSource] 
([Ar],[En])
select  ' ','Land ownership'
 
insert into [StrSource] 
([Ar],[En])
select  ' ','Building ownership'
 
insert into [StrSource] 
([Ar],[En])
select  ' ','Maintenance order'
 
insert into [StrSource] 
([Ar],[En])
select  '   ','Maintenance order in progress'
 
insert into [StrSource] 
([Ar],[En])
select  ' ','Maintenance order'
 
insert into [StrSource] 
([Ar],[En])
select  '  ','Export to Excel'
 
insert into [StrSource] 
([Ar],[En])
select  '   ','Modify other users journal entries'
 
insert into [StrSource] 
([Ar],[En])
select  '   ','Modify other users cheques'
 
insert into [StrSource] 
([Ar],[En])
select  '   ','Modify other users contracts'
 
insert into [StrSource] 
([Ar],[En])
select  '  ','Change salesman'
 
insert into [StrSource] 
([Ar],[En])
select  '   ','Change password'
 
insert into [StrSource] 
([Ar],[En])
select  '     ','Delete journal entries with origin'
 
insert into [StrSource] 
([Ar],[En])
select  '  ','Print Reports'
 
insert into [StrSource] 
([Ar],[En])
select  '       ','Attentions: journal entries will be renumbering by date order!!!'
 
insert into [StrSource] 
([Ar],[En])
select  '!','Attention!'
 
insert into [StrSource] 
([Ar],[En])
select  '   ','Create procedures and triggers'
 
insert into [StrSource] 
([Ar],[En])
select  ' ','Create tables'
 
insert into [StrSource] 
([Ar],[En])
select  ' ','Create journal entry'
 
insert into [StrSource] 
([Ar],[En])
select  '  ','Create journal entry on date'
 
insert into [StrSource] 
([Ar],[En])
select  ' ','Create File'
 
insert into [StrSource] 
([Ar],[En])
select  '  ','Add subaccount'
 
insert into [StrSource] 
([Ar],[En])
select  ' ','Create into'
 
insert into [StrSource] 
([Ar],[En])
select  '  ','Add sub-branch'
 
insert into [StrSource] 
([Ar],[En])
select  '  ','Create database'
 
insert into [StrSource] 
([Ar],[En])
select  '   ','Generate New File'
 
insert into [StrSource] 
([Ar],[En])
select  '   ','Decrease in asset life'
 
insert into [StrSource] 
([Ar],[En])
select  '  ','Note Papers Types'
 
insert into [StrSource] 
([Ar],[En])
select  ' ','Entries Types'
 
insert into [StrSource] 
([Ar],[En])
select  ' ','Cheques Types'
 
insert into [StrSource] 
([Ar],[En])
select  ' ','Contracts Types'
 
insert into [StrSource] 
([Ar],[En])
select  ' ','Bill Types'
 
insert into [StrSource] 
([Ar],[En])
select  '  ','Accounting journal entry types'
 
insert into [StrSource] 
([Ar],[En])
select  '  ','Electricity Bill Types'
 
insert into [StrSource] 
([Ar],[En])
select  '','Terminate'
 
insert into [StrSource] 
([Ar],[En])
select  '  ','Finish returned cheques'
 
insert into [StrSource] 
([Ar],[En])
select  '  ','Finish returned cheques'
 
insert into [StrSource] 
([Ar],[En])
select  '  ','Finish returned cheques'
 
insert into [StrSource] 
([Ar],[En])
select  ' ','Close maintenance'
 
insert into [StrSource] 
([Ar],[En])
select  ' ','Contract termination'
 
insert into [StrSource] 
([Ar],[En])
select  ' ','Assets depreciation'
 
insert into [StrSource] 
([Ar],[En])
select  ' ','First time'
 
insert into [StrSource] 
([Ar],[En])
select  '','Rent'
 
insert into [StrSource] 
([Ar],[En])
select  ' ','Flat rent'
 
insert into [StrSource] 
([Ar],[En])
select  '','Tools'
 
insert into [StrSource] 
([Ar],[En])
select  ' SMS ','Send SMS to group'
 
insert into [StrSource] 
([Ar],[En])
select  '','Investment'
 
insert into [StrSource] 
([Ar],[En])
select  '  ','View checked'
 
insert into [StrSource] 
([Ar],[En])
select  '  ','View others reminder'
 
insert into [StrSource] 
([Ar],[En])
select  '   ','View information window'
 
insert into [StrSource] 
([Ar],[En])
select  '','Posting'
 
insert into [StrSource] 
([Ar],[En])
select  '  ','Posting generate journal entry'
 
insert into [StrSource] 
([Ar],[En])
select  '    ','Posting generate journal entry automatically'
 
insert into [StrSource] 
([Ar],[En])
select  '','Sequence'
 
insert into [StrSource] 
([Ar],[En])
select  ' ','New name'
 
insert into [StrSource] 
([Ar],[En])
select  '','Class'
 
insert into [StrSource] 
([Ar],[En])
select  '','Endrosement'
 
insert into [StrSource] 
([Ar],[En])
select  '  ','Endrosement generate journal entry'
 
insert into [StrSource] 
([Ar],[En])
select  '    ','Endrosement generate journal entry automatically'
 
insert into [StrSource] 
([Ar],[En])
select  '','Rate'
 
insert into [StrSource] 
([Ar],[En])
select  '','Details'
 
insert into [StrSource] 
([Ar],[En])
select  ' ','Realty Reports'
 
insert into [StrSource] 
([Ar],[En])
select  '','Distributive'
 
insert into [StrSource] 
([Ar],[En])
select  ' ','Generate journal entry'
 
insert into [StrSource] 
([Ar],[En])
select  '   ','Generate journal entry automatically'
 
insert into [StrSource] 
([Ar],[En])
select  '  ','Generate checks'
 
insert into [StrSource] 
([Ar],[En])
select  '    ','Generate checks by plan'
 
insert into [StrSource] 
([Ar],[En])
select  ' ','Generating flats'
 
insert into [StrSource] 
([Ar],[En])
select  '  ','Generate servants flats'
 
insert into [StrSource] 
([Ar],[En])
select  '  ','Generate drivers flats'
 
insert into [StrSource] 
([Ar],[En])
select  ' ','Generate journal entry'
 
insert into [StrSource] 
([Ar],[En])
select  ' ','Generate All'
 
insert into [StrSource] 
([Ar],[En])
select  ' ','Generate shops'
 
insert into [StrSource] 
([Ar],[En])
select  ' ','Generate warehouses'
 
insert into [StrSource] 
([Ar],[En])
select  ' ','Generate offices'
 
insert into [StrSource] 
([Ar],[En])
select  ' ','Generate parking'
 
insert into [StrSource] 
([Ar],[En])
select  '  ','Generate journal entry'
 
insert into [StrSource] 
([Ar],[En])
select  '  ','Generate mizanin'
 
insert into [StrSource] 
([Ar],[En])
select  '   ','Generate pent house'
 
insert into [StrSource] 
([Ar],[En])
select  ' ','Generate cheques'
 
insert into [StrSource] 
([Ar],[En])
select  '    ','Generate cheques by plan'
 
insert into [StrSource] 
([Ar],[En])
select  ' ','Generate journal entry'
 
insert into [StrSource] 
([Ar],[En])
select  '  ','Generate termination journal entry'
 
insert into [StrSource] 
([Ar],[En])
select  '   ','Generate journal entry automatically'
 
insert into [StrSource] 
([Ar],[En])
select  '    ','Generate exchange rate journal entry'
 
insert into [StrSource] 
([Ar],[En])
select  '   ','Generate journal entry for each line'
 
insert into [StrSource] 
([Ar],[En])
select  '  ','Profits flats sales'
 
insert into [StrSource] 
([Ar],[En])
select  '','Return'
 
insert into [StrSource] 
([Ar],[En])
select  ' ','cheque return'
 
insert into [StrSource] 
([Ar],[En])
select  '','Send'
 
insert into [StrSource] 
([Ar],[En])
select  ' &SMS','Send SMS'
 
insert into [StrSource] 
([Ar],[En])
select  ' SMS','Send SMS'
 
insert into [StrSource] 
([Ar],[En])
select  ' SMS ','Send SMS to Group'
 
insert into [StrSource] 
([Ar],[En])
select  ' ','Automatically Send'
 
insert into [StrSource] 
([Ar],[En])
select  '     ','Automatically send SMS when add maintenance order'
 
insert into [StrSource] 
([Ar],[En])
select  '    ','Automatically send SMS when add complaint'
 
insert into [StrSource] 
([Ar],[En])
select  '   ','Automatically send SMS when add'
 
insert into [StrSource] 
([Ar],[En])
select  '       ','Automatically send SMS before check due date'
 
insert into [StrSource] 
([Ar],[En])
select  '  ','Send the selected page'
 
insert into [StrSource] 
([Ar],[En])
select  '   ','Send contract to registration'
 
insert into [StrSource] 
([Ar],[En])
select  '      ','Automatically send SMS when collect the check'
 
insert into [StrSource] 
([Ar],[En])
select  '       ','Automatically send SMS on contract expiry day'
 
insert into [StrSource] 
([Ar],[En])
select  '      ','Automatically send SMS after return the check'
 
insert into [StrSource] 
([Ar],[En])
select  '     ','Automatically send SMS after expiration of contract'
 
insert into [StrSource] 
([Ar],[En])
select  '      ','Automatically send SMS after collect the check'
 
insert into [StrSource] 
([Ar],[En])
select  '  SMS ','Send All SMS'
 
insert into [StrSource] 
([Ar],[En])
select  '','Land'
 
insert into [StrSource] 
([Ar],[En])
select  '  ','Remove checked mark'
 
insert into [StrSource] 
([Ar],[En])
select  ' ','Delay reasons'
 
insert into [StrSource] 
([Ar],[En])
select  '','Return'
 
insert into [StrSource] 
([Ar],[En])
select  '     ','check return generates journal entry automatically'
 
insert into [StrSource] 
([Ar],[En])
select  '  ','check return generates journal entry'
 
insert into [StrSource] 
([Ar],[En])
select  '  SMS','Automatic SMS sending'
 
insert into [StrSource] 
([Ar],[En])
select  '','Land'
 
insert into [StrSource] 
([Ar],[En])
select  '  ','Consignee numbers'
 
insert into [StrSource] 
([Ar],[En])
select  '','Displacement'
 
insert into [StrSource] 
([Ar],[En])
select  '','Disposals'
 
insert into [StrSource] 
([Ar],[En])
select  '','Due'
 
insert into [StrSource] 
([Ar],[En])
select  '  ','Balance inquiry'
 
insert into [StrSource] 
([Ar],[En])
select  '','Consumption'
 
insert into [StrSource] 
([Ar],[En])
select  '','Name'
 
insert into [StrSource] 
([Ar],[En])
select  ' ','Full name'
 
insert into [StrSource] 
([Ar],[En])
select  '  ','Full name contains'
 
insert into [StrSource] 
([Ar],[En])
select  ' ','Latin name'
 
insert into [StrSource] 
([Ar],[En])
select  '  ','Duplicate latin name'
 
insert into [StrSource] 
([Ar],[En])
select  ' ','Duplicate name'
 
insert into [StrSource] 
([Ar],[En])
select  '  ','Version No.'
 
insert into [StrSource] 
([Ar],[En])
select  '','Origin'
 
insert into [StrSource] 
([Ar],[En])
select  ' ','Asset active'
 
insert into [StrSource] 
([Ar],[En])
select  ' ','Asset sold'
 
insert into [StrSource] 
([Ar],[En])
select  '','Assets'
 
insert into [StrSource] 
([Ar],[En])
select  '','Extras'
 
insert into [StrSource] 
([Ar],[En])
select  ' ','Opened windows'
 
insert into [StrSource] 
([Ar],[En])
select  '','View'
 
insert into [StrSource] 
([Ar],[En])
select  '','View'
 
insert into [StrSource] 
([Ar],[En])
select  '','Numbers'
 
insert into [StrSource] 
([Ar],[En])
select  '','Settings'
 
insert into [StrSource] 
([Ar],[En])
select  '','Maximum'
 
insert into [StrSource] 
([Ar],[En])
select  '','Defaults'
 
insert into [StrSource] 
([Ar],[En])
select  '','Defaults'
 
insert into [StrSource] 
([Ar],[En])
select  '','Installments'
 
insert into [StrSource] 
([Ar],[En])
select  '','Emirate'
 
insert into [StrSource] 
([Ar],[En])
select  '','Please wait'
 
insert into [StrSource] 
([Ar],[En])
select  '','Types'
 
insert into [StrSource] 
([Ar],[En])
select  '  ','Note types'
 
insert into [StrSource] 
([Ar],[En])
select  '','Depreciation'
 
insert into [StrSource] 
([Ar],[En])
select  '','Depreciations'
 
insert into [StrSource] 
([Ar],[En])
select  ' ','Note papers'
 
insert into [StrSource] 
([Ar],[En])
select  '     ','Checks without any case'
 
insert into [StrSource] 
([Ar],[En])
select  '  ','Collected checks'
 
insert into [StrSource] 
([Ar],[En])
select  '  ','Returned checks'
 
insert into [StrSource] 
([Ar],[En])
select  '  ','Due checks'
 
insert into [StrSource] 
([Ar],[En])
select  '','First'
 
insert into [StrSource] 
([Ar],[En])
select  '','Rent'
 
insert into [StrSource] 
([Ar],[En])
select  '','Income'
 
insert into [StrSource] 
([Ar],[En])
select  ' ','Revenues'
 
insert into [StrSource] 
([Ar],[En])
select  ' ','Receipt duplicate'
 
insert into [StrSource] 
([Ar],[En])
select  '','Total'
 
insert into [StrSource] 
([Ar],[En])
select  '','Land'
 
insert into [StrSource] 
([Ar],[En])
select  '   : ','Land contained in contract:'
 
insert into [StrSource] 
([Ar],[En])
select  '','Disposals'
 
insert into [StrSource] 
([Ar],[En])
select  '','Due'
 
insert into [StrSource] 
([Ar],[En])
select  '','Name'
 
insert into [StrSource] 
([Ar],[En])
select  ' ','Commercial Name'
 
insert into [StrSource] 
([Ar],[En])
select  '','Added'
 
insert into [StrSource] 
([Ar],[En])
select  ' ','Completed works'
 
insert into [StrSource] 
([Ar],[En])
select  '','First'
 
insert into [StrSource] 
([Ar],[En])
select  '','Deposit'
 
insert into [StrSource] 
([Ar],[En])
select  '','Salesman'
 
insert into [StrSource] 
([Ar],[En])
select  '','Barcode'
 
insert into [StrSource] 
([Ar],[En])
select  '','Rest'
 
insert into [StrSource] 
([Ar],[En])
select  '','Search'
 
insert into [StrSource] 
([Ar],[En])
select  '  ','Search in contracts'
 
insert into [StrSource] 
([Ar],[En])
select  '','Program'
 
insert into [StrSource] 
([Ar],[En])
select  '','Cards'
 
insert into [StrSource] 
([Ar],[En])
select  '','Cards'
 
insert into [StrSource] 
([Ar],[En])
select  ' ','Processing'
 
insert into [StrSource] 
([Ar],[En])
select  '','New'
 
insert into [StrSource] 
([Ar],[En])
select  ' ','Assets inventory'
 
insert into [StrSource] 
([Ar],[En])
select  ' ','Materials inventory'
 
insert into [StrSource] 
([Ar],[En])
select  '  ','Warehouses detailed inventory'
 
insert into [StrSource] 
([Ar],[En])
select  '  ','Warehouses detailed inventory'
 
insert into [StrSource] 
([Ar],[En])
select  '','Mobile'
 
insert into [StrSource] 
([Ar],[En])
select  ' ','Customer mobile'
 
insert into [StrSource] 
([Ar],[En])
select  '/ ','Extra A/C'
 
insert into [StrSource] 
([Ar],[En])
select  '/ ','Discount A/C'
 
insert into [StrSource] 
([Ar],[En])
select  '  ','Add fixed amount'
 
insert into [StrSource] 
([Ar],[En])
select  ' ','Add shop'
 
insert into [StrSource] 
([Ar],[En])
select  ' ','Add file'
 
insert into [StrSource] 
([Ar],[En])
select  ' ','Add location'
 
insert into [StrSource] 
([Ar],[En])
select  '    ','Press the start button to start the process'
 
insert into [StrSource] 
([Ar],[En])
select  '','Window'
 
insert into [StrSource] 
([Ar],[En])
select  '  ','Show account name'
 
insert into [StrSource] 
([Ar],[En])
select  '    ','Show checks that not related with contracts'
 
insert into [StrSource] 
([Ar],[En])
select  ' ','Show details'
 
insert into [StrSource] 
([Ar],[En])
select  ' ','Show activities'
 
insert into [StrSource] 
([Ar],[En])
select  '  ','Show closing accounts'
 
insert into [StrSource] 
([Ar],[En])
select  '  ','Show main accounts'
 
insert into [StrSource] 
([Ar],[En])
select  '  ','Show empty accounts'
 
insert into [StrSource] 
([Ar],[En])
select  '   ','Show empty sub accounts'
 
insert into [StrSource] 
([Ar],[En])
select  '  ','Show balanced accounts'
 
insert into [StrSource] 
([Ar],[En])
select  '   ','Show accounts in contracts'
 
insert into [StrSource] 
([Ar],[En])
select  ' ','Show fields'
 
insert into [StrSource] 
([Ar],[En])
select  ' ','Show maps'
 
insert into [StrSource] 
([Ar],[En])
select  ' ','Show credit'
 
insert into [StrSource] 
([Ar],[En])
select  ' ','Show balance'
 
insert into [StrSource] 
([Ar],[En])
select  '  ','Show previous balance'
 
insert into [StrSource] 
([Ar],[En])
select  ' ','Show flats'
 
insert into [StrSource] 
([Ar],[En])
select  '       ','Show merged shops and flats'
 
insert into [StrSource] 
([Ar],[En])
select  ' ','Show properties'
 
insert into [StrSource] 
([Ar],[En])
select  '     ','Show contracts without security deposit'
 
insert into [StrSource] 
([Ar],[En])
select  '  ','Show thousand separator'
 
insert into [StrSource] 
([Ar],[En])
select  ' ','Show shops'
 
insert into [StrSource] 
([Ar],[En])
select  ' ','Show debit'
 
insert into [StrSource] 
([Ar],[En])
select  '  ','Show annual summary'
 
insert into [StrSource] 
([Ar],[En])
select  ' ','Show parking'
 
insert into [StrSource] 
([Ar],[En])
select  '   ','Show closing accounts details'
 
insert into [StrSource] 
([Ar],[En])
select  '   / ','Show supplier / customer accounts'
 
insert into [StrSource] 
([Ar],[En])
select  '  ','Show credit account'
 
insert into [StrSource] 
([Ar],[En])
select  '  ','Show contract field'
 
insert into [StrSource] 
([Ar],[En])
select  '  ','Show debit account'
 
insert into [StrSource] 
([Ar],[En])
select  '    ','Show successfully finisshed messages'
 
insert into [StrSource] 
([Ar],[En])
select  '   ','Show save confirming messages'
 
insert into [StrSource] 
([Ar],[En])
select  '  ','Show account code'
 
insert into [StrSource] 
([Ar],[En])
select  ' ','Renumbering'
 
insert into [StrSource] 
([Ar],[En])
select  ' ','Renumbering'
 
insert into [StrSource] 
([Ar],[En])
select  '   ','Renumbering checks'
 
insert into [StrSource] 
([Ar],[En])
select  '  ','Renumbering contracts'
 
insert into [StrSource] 
([Ar],[En])
select  '   ','Renumbering land cards'
 
insert into [StrSource] 
([Ar],[En])
select  '   ','Renumbering flat cards'
 
insert into [StrSource] 
([Ar],[En])
select  '   ','Renumbering villa cards'
 
insert into [StrSource] 
([Ar],[En])
select  '   ','Renumbering shop cards'
 
insert into [StrSource] 
([Ar],[En])
select  '   ','Renumbering parking cards'
 
insert into [StrSource] 
([Ar],[En])
select  '   ','Renumbering journal entries'
 
insert into [StrSource] 
([Ar],[En])
select  '    ','Renumbering notes type'
 
insert into [StrSource] 
([Ar],[En])
select  '   ','Renumbering journal entries type'
 
insert into [StrSource] 
([Ar],[En])
select  '   ','Renumbering contract type'
 
insert into [StrSource] 
([Ar],[En])
select  '   ','Renumbering subaccounts'
 
insert into [StrSource] 
([Ar],[En])
select  ' ','Rename'
 
insert into [StrSource] 
([Ar],[En])
select  '  ','File rename'
 
insert into [StrSource] 
([Ar],[En])
select  '  ','Regenerate notes'
 
insert into [StrSource] 
([Ar],[En])
select  '   ','Regenerate journal entries'
 
insert into [StrSource] 
([Ar],[En])
select  '    ','Regenerate cheque journal entries'
 
insert into [StrSource] 
([Ar],[En])
select  '  ','Reprocessing notes'
 
insert into [StrSource] 
([Ar],[En])
select  '  ','Use default accounts'
 
insert into [StrSource] 
([Ar],[En])
select  ' ','Use date'
 
insert into [StrSource] 
([Ar],[En])
select  '  ','Use due date'
 
insert into [StrSource] 
([Ar],[En])
select  '        ','Use building revenue account as default account of collection commission'
 
insert into [StrSource] 
([Ar],[En])
select  '        ','Use customer account as default partial collection account'
 
insert into [StrSource] 
([Ar],[En])
select  ' ','Use Level'
 
insert into [StrSource] 
([Ar],[En])
select  '   ','Use security level of cheque'
 
insert into [StrSource] 
([Ar],[En])
select  '      ','Enter new password correctly'
 
insert into [StrSource] 
([Ar],[En])
select  '   ','Try again'
 
insert into [StrSource] 
([Ar],[En])
select  '    : ','Card is opened from computer:'
 
insert into [StrSource] 
([Ar],[En])
select  '','Building'
 
insert into [StrSource] 
([Ar],[En])
select  '','Building'
 
insert into [StrSource] 
([Ar],[En])
select  ' ','Pent House'
 
insert into [StrSource] 
([Ar],[En])
select  '','Bank'
 
insert into [StrSource] 
([Ar],[En])
select  '','Notes'
 
insert into [StrSource] 
([Ar],[En])
select  ' 2','Notes2'
 
insert into [StrSource] 
([Ar],[En])
select  ' ','Customs statement'
 
insert into [StrSource] 
([Ar],[En])
select  ' ','Notes Contain'
 
insert into [StrSource] 
([Ar],[En])
select  '2','Notes2'
 
insert into [StrSource] 
([Ar],[En])
select  '','Data'
 
insert into [StrSource] 
([Ar],[En])
select  ' ','Financial data'
 
insert into [StrSource] 
([Ar],[En])
select  '       ','Data still unsaved, Do you want to ignore changes?'
 
insert into [StrSource] 
([Ar],[En])
select  '     ','Data used and cannot be deleted'
 
insert into [StrSource] 
([Ar],[En])
select  '','Sales'
 
insert into [StrSource] 
([Ar],[En])
select  '','Security deposit'
 
insert into [StrSource] 
([Ar],[En])
select  '  ','effect on age'
 
insert into [StrSource] 
([Ar],[En])
select  '','Date'
 
insert into [StrSource] 
([Ar],[En])
select  ' ','Remind date'
 
insert into [StrSource] 
([Ar],[En])
select  '    ','Expected date to finish maintenance'
 
insert into [StrSource] 
([Ar],[En])
select  '     ','Date is smaller than fixed date'
 
insert into [StrSource] 
([Ar],[En])
select  '      ','Selected date is smaller than starting date'
 
insert into [StrSource] 
([Ar],[En])
select  '      ','Selected date is larger than starting date'
 
insert into [StrSource] 
([Ar],[En])
select  ' ','Date by'
 
insert into [StrSource] 
([Ar],[En])
select  '  ','Date is not match'
 
insert into [StrSource] 
([Ar],[En])
select  '','Next'
 
insert into [StrSource] 
([Ar],[En])
select  '','Collection'
 
insert into [StrSource] 
([Ar],[En])
select  ' ','Partial collection'
 
insert into [StrSource] 
([Ar],[En])
select  '   ','Partial collection generate journal entry'
 
insert into [StrSource] 
([Ar],[En])
select  ' ','Annual payment'
 
insert into [StrSource] 
([Ar],[En])
select  ' ','Monthly payment'
 
insert into [StrSource] 
([Ar],[En])
select  ' ','Due payment'
 
insert into [StrSource] 
([Ar],[En])
select  '','Country'
 
insert into [StrSource] 
([Ar],[En])
select  '   ','View image window'
 
insert into [StrSource] 
([Ar],[En])
select  '    ','Contract received from registration'
 
insert into [StrSource] 
([Ar],[En])
select  ' ','Complex name'
 
insert into [StrSource] 
([Ar],[En])
select  ' ','User Name'
 
insert into [StrSource] 
([Ar],[En])
select  ' ','File name'
 
insert into [StrSource] 
([Ar],[En])
select  '','Window'
 
insert into [StrSource] 
([Ar],[En])
select  '','View'
 
insert into [StrSource] 
([Ar],[En])
select  '   ','Show overdue payments report'
 
insert into [StrSource] 
([Ar],[En])
select  '        ','Consider due payment as late payment if exceeded'
 
insert into [StrSource] 
([Ar],[En])
select  ' ','Consider commission'
 
insert into [StrSource] 
([Ar],[En])
select  '       ','Use expiry of investment date as contracts expiry date'
 
insert into [StrSource] 
([Ar],[En])
select  '       ','Use collection account as default observe account of delay fees'
 
insert into [StrSource] 
([Ar],[En])
select  '   /     ','Use supplier / customer account as default account of check return fees'
 
insert into [StrSource] 
([Ar],[En])
select  '   /     ','Use supplier / customer account as default account of delay fees'
 
insert into [StrSource] 
([Ar],[En])
select  '   /    ','Use supplier / customer account as default account of check return'
 
insert into [StrSource] 
([Ar],[En])
select  '      ','Use customer account as default account of check post'
 
insert into [StrSource] 
([Ar],[En])
select  '       ','Use bank account as default account of check return'
 
insert into [StrSource] 
([Ar],[En])
select  '       ','Use bank account as default account of check post'
 
insert into [StrSource] 
([Ar],[En])
select  '        ','Use building bank account as default account partial collection'
 
insert into [StrSource] 
([Ar],[En])
select  '       ','Use owner account as default account of collect commssion'
 
insert into [StrSource] 
([Ar],[En])
select  '       ','Use owner account as default account of check post'
 
insert into [StrSource] 
([Ar],[En])
select  '     ','Use commession rate from building card'
 
insert into [StrSource] 
([Ar],[En])
select  '  ','Previous years settings'
 
insert into [StrSource] 
([Ar],[En])
select  '  ','Favorite accounts settings'
 
insert into [StrSource] 
([Ar],[En])
select  '','Installments'
 
insert into [StrSource] 
([Ar],[En])
select  '','Buildings'
 
insert into [StrSource] 
([Ar],[En])
select  '  ','Connect New File'
 
insert into [StrSource] 
([Ar],[En])
select  '','Total Amount'
 
insert into [StrSource] 
([Ar],[En])
select  '','Shotcut'
 
insert into [StrSource] 
([Ar],[En])
select  ' ','Duplicate shortcut'
 
insert into [StrSource] 
([Ar],[En])
select  '','Shotcuts'
 
insert into [StrSource] 
([Ar],[En])
select  '','Last'
 
insert into [StrSource] 
([Ar],[En])
select  '','Input'
 
insert into [StrSource] 
([Ar],[En])
select  ' ','External tools'
 
insert into [StrSource] 
([Ar],[En])
select  '','Lands'
 
insert into [StrSource] 
([Ar],[En])
select  '    ','Leased and non-leased lands'
 
insert into [StrSource] 
([Ar],[En])
select  '   ','Leased and non-leased lands'
 
insert into [StrSource] 
([Ar],[En])
select  '    ','Sold and Non-Sold Lands'
 
insert into [StrSource] 
([Ar],[En])
select  '','Link'
 
insert into [StrSource] 
([Ar],[En])
select  '','Income'
 
insert into [StrSource] 
([Ar],[En])
select  '','License'
 
insert into [StrSource] 
([Ar],[En])
select  '  ','License to date'
 
insert into [StrSource] 
([Ar],[En])
select  '  ','License from date'
 
insert into [StrSource] 
([Ar],[En])
select  ' ','SMS'
 
insert into [StrSource] 
([Ar],[En])
select  ' ','Sent SMS'
 
insert into [StrSource] 
([Ar],[En])
select  '','Balance'
 
insert into [StrSource] 
([Ar],[En])
select  ' ','Previous balance'
 
insert into [StrSource] 
([Ar],[En])
select  ' ','Final balance'
 
insert into [StrSource] 
([Ar],[En])
select  ' ','Cumulative balance'
 
insert into [StrSource] 
([Ar],[En])
select  '','Number'
 
insert into [StrSource] 
([Ar],[En])
select  ' ','Serial Number'
 
insert into [StrSource] 
([Ar],[En])
select  ' ','Internal Number'
 
insert into [StrSource] 
([Ar],[En])
select  '  ','Duplicate serial number'
 
insert into [StrSource] 
([Ar],[En])
select  ' ','Latin code'
 
insert into [StrSource] 
([Ar],[En])
select  ' ','Duplicate code'
 
insert into [StrSource] 
([Ar],[En])
select  '','Customers'
 
insert into [StrSource] 
([Ar],[En])
select  ' ','Blocked customers'
 
insert into [StrSource] 
([Ar],[En])
select  '','Customer'
 
insert into [StrSource] 
([Ar],[En])
select  '                  ','The customer in this contract is different from the customer in the contract to be linked to the flat, are you sure to continue?'
 
insert into [StrSource] 
([Ar],[En])
select  '','Customer'
 
insert into [StrSource] 
([Ar],[En])
select  '','Previous'
 
insert into [StrSource] 
([Ar],[En])
select  ' >>','Previous >>'
 
insert into [StrSource] 
([Ar],[En])
select  '','Timing'
 
insert into [StrSource] 
([Ar],[En])
select  ' ','Trading license'
 
insert into [StrSource] 
([Ar],[En])
select  '','Price'
 
insert into [StrSource] 
([Ar],[En])
select  ' ','Total price'
 
insert into [StrSource] 
([Ar],[En])
select  ' ','Minimum price'
 
insert into [StrSource] 
([Ar],[En])
select  ' ','Maximum price'
 
insert into [StrSource] 
([Ar],[En])
select  ' ','Unit price'
 
insert into [StrSource] 
([Ar],[En])
select  ' ','Price between'
 
insert into [StrSource] 
([Ar],[En])
select  '         ','Allow adding a new contract for the same client without ending the old contract'
 
insert into [StrSource] 
([Ar],[En])
select  ' ','Current year'
 
insert into [StrSource] 
([Ar],[En])
select  '','Ownership voucher'
 
insert into [StrSource] 
([Ar],[En])
select  ' ','Entry checked'
 
insert into [StrSource] 
([Ar],[En])
select  '','Journal entries'
 
insert into [StrSource] 
([Ar],[En])
select  ' ','Previous years'
 
insert into [StrSource] 
([Ar],[En])
select  '','Street'
 
insert into [StrSource] 
([Ar],[En])
select  '','Shipping'
 
insert into [StrSource] 
([Ar],[En])
select  '','Company'
 
insert into [StrSource] 
([Ar],[En])
select  '','Flat'
 
insert into [StrSource] 
([Ar],[En])
select  '    : ','Flat reserved by:'
 
insert into [StrSource] 
([Ar],[En])
select  '   : ','The Flat in contract:'
 
insert into [StrSource] 
([Ar],[En])
select  '','Flats'
 
insert into [StrSource] 
([Ar],[En])
select  '','Complaints'
 
insert into [StrSource] 
([Ar],[En])
select  '','Theme'
 
insert into [StrSource] 
([Ar],[En])
select  '','Complaints'
 
insert into [StrSource] 
([Ar],[En])
select  '','Month'
 
insert into [StrSource] 
([Ar],[En])
select  ' 1','Month 1'
 
insert into [StrSource] 
([Ar],[En])
select  ' 10','Month 10'
 
insert into [StrSource] 
([Ar],[En])
select  ' 11','Month 11'
 
insert into [StrSource] 
([Ar],[En])
select  ' 12','Month 12'
 
insert into [StrSource] 
([Ar],[En])
select  ' 2','Month 2'
 
insert into [StrSource] 
([Ar],[En])
select  ' 3','Month 3'
 
insert into [StrSource] 
([Ar],[En])
select  ' 4','Month 4'
 
insert into [StrSource] 
([Ar],[En])
select  ' 5','Month 5'
 
insert into [StrSource] 
([Ar],[En])
select  ' 6','Month 6'
 
insert into [StrSource] 
([Ar],[En])
select  ' 7','Month 7'
 
insert into [StrSource] 
([Ar],[En])
select  ' 8','Month 8'
 
insert into [StrSource] 
([Ar],[En])
select  ' 9','Month 9'
 
insert into [StrSource] 
([Ar],[En])
select  '','Cheques'
 
insert into [StrSource] 
([Ar],[En])
select  '[N]  ','[N] Contract Place'
 
insert into [StrSource] 
([Ar],[En])
select  '<<    ','<<   Next'
 
insert into [StrSource] 
([Ar],[En])
select  '3 ','3 Months'
 
insert into [StrSource] 
([Ar],[En])
select  '6 ','6 Months'
 
insert into [StrSource] 
([Ar],[En])
select  '&','A&dd'
 
insert into [StrSource] 
([Ar],[En])
select  '&','C&lose'
 
insert into [StrSource] 
([Ar],[En])
select  ' ','Start file closing'
 
insert into [StrSource] 
([Ar],[En])
select  ' ','Import license'
 
insert into [StrSource] 
([Ar],[En])
select  '','Credit'
 
insert into [StrSource] 
([Ar],[En])
select  '   ','Total rent after discount'
 
insert into [StrSource] 
([Ar],[En])
select  '   ','Total rent before discount'
 
insert into [StrSource] 
([Ar],[En])
select  ' ','Total revenue'
 
insert into [StrSource] 
([Ar],[En])
select  ' ','Total security deposit'
 
insert into [StrSource] 
([Ar],[En])
select  '  ','Total collected amount'
 
insert into [StrSource] 
([Ar],[En])
select  '   ','Total due amount to owner'
 
insert into [StrSource] 
([Ar],[En])
select  '   ','Total uncollected amount'
 
insert into [StrSource] 
([Ar],[En])
select  '   ','Sold and Non-Sold Lands'
 
insert into [StrSource] 
([Ar],[En])
select  '  ','Profit and Loss'
 
insert into [StrSource] 
([Ar],[En])
select  '    ','Profit, Loss and Balance'
 
insert into [StrSource] 
([Ar],[En])
select  '','Hight'
 
insert into [StrSource] 
([Ar],[En])
select  ' ','Deferred cheques'
 
insert into [StrSource] 
([Ar],[En])
select  ' ','Collected cheques'
 
insert into [StrSource] 
([Ar],[En])
select  ' ','Received cheques'
 
insert into [StrSource] 
([Ar],[En])
select  '  ','Uncollected cheques'
 
insert into [StrSource] 
([Ar],[En])
select  '','Adjective'
 
insert into [StrSource] 
([Ar],[En])
select  '','Permissions'
 
insert into [StrSource] 
([Ar],[En])
select  '','Permission'
 
insert into [StrSource] 
([Ar],[En])
select  '','Category'
 
insert into [StrSource] 
([Ar],[En])
select  ' ','Main category'
 
insert into [StrSource] 
([Ar],[En])
select  '','Pictures'
 
insert into [StrSource] 
([Ar],[En])
select  '','Maintenance'
 
insert into [StrSource] 
([Ar],[En])
select  '','Suburb'
 
insert into [StrSource] 
([Ar],[En])
select  '  ','Multiplication by fixed number'
 
insert into [StrSource] 
([Ar],[En])
select  '  ','Multiplication by percentage'
 
insert into [StrSource] 
([Ar],[En])
select  '','Floor'
 
insert into [StrSource] 
([Ar],[En])
select  '','Printing'
 
insert into [StrSource] 
([Ar],[En])
select  '','Length'
 
insert into [StrSource] 
([Ar],[En])
select  ' ','Responsible worker'
 
insert into [StrSource] 
([Ar],[En])
select  '','Meter'
 
insert into [StrSource] 
([Ar],[En])
select  ' ','Current meter'
 
insert into [StrSource] 
([Ar],[En])
select  ' ','Previous meter'
 
insert into [StrSource] 
([Ar],[En])
select  '','Number'
 
insert into [StrSource] 
([Ar],[En])
select  ' ','Total number'
 
insert into [StrSource] 
([Ar],[En])
select  '  ','No. in each floor'
 
insert into [StrSource] 
([Ar],[En])
select  '','Status'
 
insert into [StrSource] 
([Ar],[En])
select  '','Offers'
 
insert into [StrSource] 
([Ar],[En])
select  '','Property'
 
insert into [StrSource] 
([Ar],[En])
select  '','Properties'
 
insert into [StrSource] 
([Ar],[En])
select  '','Contract'
 
insert into [StrSource] 
([Ar],[En])
select  ' ','Related contract'
 
insert into [StrSource] 
([Ar],[En])
select  ' ','Contract checked'
 
insert into [StrSource] 
([Ar],[En])
select  '','Contracts'
 
insert into [StrSource] 
([Ar],[En])
select  '  ','Expired contracts'
 
insert into [StrSource] 
([Ar],[En])
select  '      ','Expired contracts and Non-terminated contracts'
 
insert into [StrSource] 
([Ar],[En])
select  ' ','Useful life'
 
insert into [StrSource] 
([Ar],[En])
select  ' ','Useful life'
 
insert into [StrSource] 
([Ar],[En])
select  ' ','Action required'
 
insert into [StrSource] 
([Ar],[En])
select  '  ','Work in Hijri date format'
 
insert into [StrSource] 
([Ar],[En])
select  '','Currencies'
 
insert into [StrSource] 
([Ar],[En])
select  '','Currency'
 
insert into [StrSource] 
([Ar],[En])
select  ' ','Default currency'
 
insert into [StrSource] 
([Ar],[En])
select  '  ','Currency & Rate'
 
insert into [StrSource] 
([Ar],[En])
select  '','Operations'
 
insert into [StrSource] 
([Ar],[En])
select  '  ','Operations on asset'
 
insert into [StrSource] 
([Ar],[En])
select  '    ','Operations in note report'
 
insert into [StrSource] 
([Ar],[En])
select  '    ','Operations in note report'
 
insert into [StrSource] 
([Ar],[En])
select  '','Transaction'
 
insert into [StrSource] 
([Ar],[En])
select  '','Commission'
 
insert into [StrSource] 
([Ar],[En])
select  '','Client'
 
insert into [StrSource] 
([Ar],[En])
select  '     ','Element specified in another location'
 
insert into [StrSource] 
([Ar],[En])
select  '','Address'
 
insert into [StrSource] 
([Ar],[En])
select  ' ','Address contain'
 
insert into [StrSource] 
([Ar],[En])
select  ' ','Cancel return'
 
insert into [StrSource] 
([Ar],[En])
select  '   ','Cash due'
 
insert into [StrSource] 
([Ar],[En])
select  '','Amount'
 
insert into [StrSource] 
([Ar],[En])
select  ' ','Total amount'
 
insert into [StrSource] 
([Ar],[En])
select  ' ','Remaining amount'
 
insert into [StrSource] 
([Ar],[En])
select  ' ','Due amount'
 
insert into [StrSource] 
([Ar],[En])
select  ' ','Paid amount'
 
insert into [StrSource] 
([Ar],[En])
select  ' ','Amount due'
 
insert into [StrSource] 
([Ar],[En])
select  '  ','Amount due'
 
insert into [StrSource] 
([Ar],[En])
select  '','Trading sheet'
 
insert into [StrSource] 
([Ar],[En])
select  '','Overdue amounts'
 
insert into [StrSource] 
([Ar],[En])
select  '','Variables'
 
insert into [StrSource] 
([Ar],[En])
select  '','Complex'
 
insert into [StrSource] 
([Ar],[En])
select  '','Total'
 
insert into [StrSource] 
([Ar],[En])
select  ' ','Main group'
 
insert into [StrSource] 
([Ar],[En])
select  '    F1','Contents    F1'
 
insert into [StrSource] 
([Ar],[En])
select  '','Reserved'
 
insert into [StrSource] 
([Ar],[En])
select  '','Collected'
 
insert into [StrSource] 
([Ar],[En])
select  ' / ','Collected / Value'
 
insert into [StrSource] 
([Ar],[En])
select  ' ','Previously collected'
 
insert into [StrSource] 
([Ar],[En])
select  ' 3','Unit 3'
 
insert into [StrSource] 
([Ar],[En])
select  '  ','Note is checked'
 
insert into [StrSource] 
([Ar],[En])
select  '','Average'
 
insert into [StrSource] 
([Ar],[En])
select  '','Description'
 
insert into [StrSource] 
([Ar],[En])
select  '','Ocupation'
 
insert into [StrSource] 
([Ar],[En])
select  '','To'
 
insert into [StrSource] 
([Ar],[En])
select  ' ','To account'
 
insert into [StrSource] 
([Ar],[En])
select  ' ','Total percentages'
 
insert into [StrSource] 
([Ar],[En])
select  ' ','Total collected'
 
insert into [StrSource] 
([Ar],[En])
select  ' ','Total paid'
 
insert into [StrSource] 
([Ar],[En])
select  ' ','Commission calculation '
 
insert into [StrSource] 
([Ar],[En])
select  '','Test'
 
insert into [StrSource] 
([Ar],[En])
select  '  ','Select file closing type'
 
insert into [StrSource] 
([Ar],[En])
select  ' ','Font test'
 
insert into [StrSource] 
([Ar],[En])
select  ' ','Choose path'
 
insert into [StrSource] 
([Ar],[En])
select  '  ','Last meter reading'
 
insert into [StrSource] 
([Ar],[En])
select  '','Output'
 
insert into [StrSource] 
([Ar],[En])
select  '   ','Hide in search window'
 
insert into [StrSource] 
([Ar],[En])
select  ' ','Hide the file'
 
insert into [StrSource] 
([Ar],[En])
select  '','Management'
 
insert into [StrSource] 
([Ar],[En])
select  ' ','Land Management'
 
insert into [StrSource] 
([Ar],[En])
select  '      ','Types Manager'
 
insert into [StrSource] 
([Ar],[En])
select  ' ','Properties management'
 
insert into [StrSource] 
([Ar],[En])
select  ' ','Users Manager'
 
insert into [StrSource] 
([Ar],[En])
select  ' ','Properties management'
 
insert into [StrSource] 
([Ar],[En])
select  '    ','Enter revenue contract registration account'
 
insert into [StrSource] 
([Ar],[En])
select  '    ','Enter contract registration revenue account'
 
insert into [StrSource] 
([Ar],[En])
select  '','Input'
 
insert into [StrSource] 
([Ar],[En])
select  '  ','Add cash transactions'
 
insert into [StrSource] 
([Ar],[En])
select  '   ','Enter flat No.'
 
insert into [StrSource] 
([Ar],[En])
select  '   ','Enter shop No.'
 
insert into [StrSource] 
([Ar],[En])
select  '  ','Enter building name'
 
insert into [StrSource] 
([Ar],[En])
select  '  ','Enter account name'
 
insert into [StrSource] 
([Ar],[En])
select  '  ','Enter customer name'
 
insert into [StrSource] 
([Ar],[En])
select  '  ','Enter file name'
 
insert into [StrSource] 
([Ar],[En])
select  '  ','Enter supplier name'
 
insert into [StrSource] 
([Ar],[En])
select  '   ','Enter property owner name'
 
insert into [StrSource] 
([Ar],[En])
select  '      ','Enter property owner name in building card'
 
insert into [StrSource] 
([Ar],[En])
select  '      ','Enter property owner name in property card'
 
insert into [StrSource] 
([Ar],[En])
select  '     : ','Enter property owner name to line:'
 
insert into [StrSource] 
([Ar],[En])
select  '      ','Enter parking owner name in parking card'
 
insert into [StrSource] 
([Ar],[En])
select  '      ','Enter User Name and Password to access the file'
 
insert into [StrSource] 
([Ar],[En])
select  ' ','Enter Name'
 
insert into [StrSource] 
([Ar],[En])
select  '   ','Enter line details'
 
insert into [StrSource] 
([Ar],[En])
select  ' ','Enter date'
 
insert into [StrSource] 
([Ar],[En])
select  '   ','Enter date to line'
 
insert into [StrSource] 
([Ar],[En])
select  '    ','Enter rate to line'
 
insert into [StrSource] 
([Ar],[En])
select  ' ','Enter account'
 
insert into [StrSource] 
([Ar],[En])
select  '  ','Enter closing account'
 
insert into [StrSource] 
([Ar],[En])
select  '  ','Enter credit account'
 
insert into [StrSource] 
([Ar],[En])
select  '       ','Enter tenant''s security deposit account in building card'
 
insert into [StrSource] 
([Ar],[En])
select  '      ','Enter tenants account in building card'
 
insert into [StrSource] 
([Ar],[En])
select  '  ','Enter debit account'
 
insert into [StrSource] 
([Ar],[En])
select  '  ','Enter obverse account'
 
insert into [StrSource] 
([Ar],[En])
select  '     ','Enter account in building card'
 
insert into [StrSource] 
([Ar],[En])
select  '   ','Enter default accounts to check type'
 
insert into [StrSource] 
([Ar],[En])
select  ' ','Enter number'
 
insert into [StrSource] 
([Ar],[En])
select  ' ','Enter code'
 
insert into [StrSource] 
([Ar],[En])
select  '   ','Enter numbers only for code'
 
insert into [StrSource] 
([Ar],[En])
select  ' ','Enter customer'
 
insert into [StrSource] 
([Ar],[En])
select  ' ','Enter year'
 
insert into [StrSource] 
([Ar],[En])
select  ' ','Chose currency'
 
insert into [StrSource] 
([Ar],[En])
select  ' ','Enter branch'
 
insert into [StrSource] 
([Ar],[En])
select  ' ','Enter value'
 
insert into [StrSource] 
([Ar],[En])
select  '  ','Enter first type'
 
insert into [StrSource] 
([Ar],[En])
select  '  ','Enter second type'
 
insert into [StrSource] 
([Ar],[En])
select  '   ','Enter first period date'
 
insert into [StrSource] 
([Ar],[En])
select  '    ','Enter first period date'
 
insert into [StrSource] 
([Ar],[En])
select  '  2','Realty Reports'
 
insert into [StrSource] 
([Ar],[En])
select  '    ','Accounting Reports'
 
insert into [StrSource] 
([Ar],[En])
select  ' ','Round to'
 
insert into [StrSource] 
([Ar],[En])
select  ' ','Warning printed'
 
insert into [StrSource] 
([Ar],[En])
select  '','Alerts'
 
insert into [StrSource] 
([Ar],[En])
select  '','Implementation'
 
insert into [StrSource] 
([Ar],[En])
select  '','Description'
 
insert into [StrSource] 
([Ar],[En])
select  ' ','Latin description'
 
insert into [StrSource] 
([Ar],[En])
select  '  ','Signature not match'
 
insert into [StrSource] 
([Ar],[En])
select  '','Third'
 
insert into [StrSource] 
([Ar],[En])
select  '','Third'
 
insert into [StrSource] 
([Ar],[En])
select  '','Second'
 
insert into [StrSource] 
([Ar],[En])
select  '','Second'
 
insert into [StrSource] 
([Ar],[En])
select  '','Fixed value'
 
insert into [StrSource] 
([Ar],[En])
select  '  : ','Related table:'
 
insert into [StrSource] 
([Ar],[En])
select  '','Part'
 
insert into [StrSource] 
([Ar],[En])
select  '','Nationality'
 
insert into [StrSource] 
([Ar],[En])
select  '','Direction'
 
insert into [StrSource] 
([Ar],[En])
select  '  ','Registered by'
 
insert into [StrSource] 
([Ar],[En])
select  '','Mobile'
 
insert into [StrSource] 
([Ar],[En])
select  '','Computer'
 
insert into [StrSource] 
([Ar],[En])
select  '','Calculator'
 
insert into [StrSource] 
([Ar],[En])
select  '','Clipboard'
 
insert into [StrSource] 
([Ar],[En])
select  '','Status'
 
insert into [StrSource] 
([Ar],[En])
select  '','Booking'
 
insert into [StrSource] 
([Ar],[En])
select  ' ','Booking canceled'
 
insert into [StrSource] 
([Ar],[En])
select  '   ','Minimum level of collection commission'
 
insert into [StrSource] 
([Ar],[En])
select  '','Delete'
 
insert into [StrSource] 
([Ar],[En])
select  '      ','Delete all cheques at notes report'
 
insert into [StrSource] 
([Ar],[En])
select  '  ','Daily activity of contracts'
 
insert into [StrSource] 
([Ar],[En])
select  '','Account'
 
insert into [StrSource] 
([Ar],[En])
select  '   ','Main account of customers deposit account'
 
insert into [StrSource] 
([Ar],[En])
select  '  ','Buildings main account'
 
insert into [StrSource] 
([Ar],[En])
select  '  ','Customers main account'
 
insert into [StrSource] 
([Ar],[En])
select  '  ','suppliers main account'
 
insert into [StrSource] 
([Ar],[En])
select  ' ','Default account'
 
insert into [StrSource] 
([Ar],[En])
select  ' ','Closing account'
 
insert into [StrSource] 
([Ar],[En])
select  ' ','Credit account'
 
insert into [StrSource] 
([Ar],[En])
select  ' ','Main account'
 
insert into [StrSource] 
([Ar],[En])
select  '   ','Main account of customers deposit account'
 
insert into [StrSource] 
([Ar],[En])
select  '  ','Customers deposit account'
 
insert into [StrSource] 
([Ar],[En])
select  ' ','Debit account'
 
insert into [StrSource] 
([Ar],[En])
select  ' ','Obverse account'
 
insert into [StrSource] 
([Ar],[En])
select  '','Accounts'
 
insert into [StrSource] 
([Ar],[En])
select  ' ','Default accounts'
 
insert into [StrSource] 
([Ar],[En])
select  '   ','Default accounts of collection commission'
 
insert into [StrSource] 
([Ar],[En])
select  ' ','Balanced accounts'
 
insert into [StrSource] 
([Ar],[En])
select  ' ','Favorite accounts'
 
insert into [StrSource] 
([Ar],[En])
select  ' ','Maximum discount'
 
insert into [StrSource] 
([Ar],[En])
select  '','Discounts '
 
insert into [StrSource] 
([Ar],[En])
select  '','Blocking'
 
insert into [StrSource] 
([Ar],[En])
select  '','Feild'
 
insert into [StrSource] 
([Ar],[En])
select  '','Feilds'
 
insert into [StrSource] 
([Ar],[En])
select  '   : ','Solution in contract:'
 
insert into [StrSource] 
([Ar],[En])
select  ' ','Registered at'
 
insert into [StrSource] 
([Ar],[En])
select  '','Basin'
 
insert into [StrSource] 
([Ar],[En])
select  '','Maps'
 
insert into [StrSource] 
([Ar],[En])
select  '','Credit'
 
insert into [StrSource] 
([Ar],[En])
select  '','Payments'
 
insert into [StrSource] 
([Ar],[En])
select  ' ','Due payments'
 
insert into [StrSource] 
([Ar],[En])
select  ' ','Cash payments'
 
insert into [StrSource] 
([Ar],[En])
select  '  ','Received cash payments'
 
insert into [StrSource] 
([Ar],[En])
select  '','Payment'
 
insert into [StrSource] 
([Ar],[En])
select  ' ','Last payment'
 
insert into [StrSource] 
([Ar],[En])
select  ' ','First payment'
 
insert into [StrSource] 
([Ar],[En])
select  '      ','First cash payment generates entry at cheque generation window'
 
insert into [StrSource] 
([Ar],[En])
select  '','Blocked'
 
insert into [StrSource] 
([Ar],[En])
select  ' ','Real estate briefcase'
 
insert into [StrSource] 
([Ar],[En])
select  '','Shop'
 
insert into [StrSource] 
([Ar],[En])
select  '    : ','Shop is reserved by:'
 
insert into [StrSource] 
([Ar],[En])
select  '   : ','Shop inside contract:'
 
insert into [StrSource] 
([Ar],[En])
select  '','Shops'
 
insert into [StrSource] 
([Ar],[En])
select  '','Debit'
 
insert into [StrSource] 
([Ar],[En])
select  '','City'
 
insert into [StrSource] 
([Ar],[En])
select  '   ','Checked for notes operations'
 
insert into [StrSource] 
([Ar],[En])
select  '','Checked'
 
insert into [StrSource] 
([Ar],[En])
select  '','Returned'
 
insert into [StrSource] 
([Ar],[En])
select  ' / ','Returned / Value'
 
insert into [StrSource] 
([Ar],[En])
select  '','Returned'
 
insert into [StrSource] 
([Ar],[En])
select  '','Posted'
 
insert into [StrSource] 
([Ar],[En])
select  ' / ','Posted / Value'
 
insert into [StrSource] 
([Ar],[En])
select  '','Posted'
 
insert into [StrSource] 
([Ar],[En])
select  '','Sent'
 
insert into [StrSource] 
([Ar],[En])
select  '','Balance sheet'
 
insert into [StrSource] 
([Ar],[En])
select  '','Area'
 
insert into [StrSource] 
([Ar],[En])
select  ' ','Total area'
 
insert into [StrSource] 
([Ar],[En])
select  ' ','Area between'
 
insert into [StrSource] 
([Ar],[En])
select  ' ','Area from'
 
insert into [StrSource] 
([Ar],[En])
select  '  ','Space area and finishing'
 
insert into [StrSource] 
([Ar],[En])
select  '','File location'
 
insert into [StrSource] 
([Ar],[En])
select  ' ','Default path'
 
insert into [StrSource] 
([Ar],[En])
select  '','Tenant'
 
insert into [StrSource] 
([Ar],[En])
select  '','User'
 
insert into [StrSource] 
([Ar],[En])
select  '','Users'
 
insert into [StrSource] 
([Ar],[En])
select  '','Users'
 
insert into [StrSource] 
([Ar],[En])
select  ' ','Current users'
 
insert into [StrSource] 
([Ar],[En])
select  '','Beneficiary'
 
insert into [StrSource] 
([Ar],[En])
select  '','Voucher'
 
insert into [StrSource] 
([Ar],[En])
select  '','Store'
 
insert into [StrSource] 
([Ar],[En])
select  '','Warehouses'
 
insert into [StrSource] 
([Ar],[En])
select  '','Level'
 
insert into [StrSource] 
([Ar],[En])
select  ' ','Customs expenses'
 
insert into [StrSource] 
([Ar],[En])
select  ' :','Term:'
 
insert into [StrSource] 
([Ar],[En])
select  ' ','New term'
 
insert into [StrSource] 
([Ar],[En])
select  '','Terms'
 
insert into [StrSource] 
([Ar],[En])
select  ' ','Old term'
 
insert into [StrSource] 
([Ar],[En])
select  '','Endorsement'
 
insert into [StrSource] 
([Ar],[En])
select  ' / ','Endorsement / Value'
 
insert into [StrSource] 
([Ar],[En])
select  '','Endorsement'
 
insert into [StrSource] 
([Ar],[En])
select  '','Transactions'
 
insert into [StrSource] 
([Ar],[En])
select  ' ','Realty Transactions'
 
insert into [StrSource] 
([Ar],[En])
select  ' ','Accounting Transactions'
 
insert into [StrSource] 
([Ar],[En])
select  ' ','General Information'
 
insert into [StrSource] 
([Ar],[En])
select  ' ','Financial Information'
 
insert into [StrSource] 
([Ar],[En])
select  '','Key'
 
insert into [StrSource] 
([Ar],[En])
select  '','Offices'
 
insert into [StrSource] 
([Ar],[En])
select  '','Notes'
 
insert into [StrSource] 
([Ar],[En])
select  '  ','Lessor and sales man card'
 
insert into [StrSource] 
([Ar],[En])
select  ' ','Termination date'
 
insert into [StrSource] 
([Ar],[En])
select  ' ','Fixed date'
 
insert into [StrSource] 
([Ar],[En])
select  '  ','Contract issue date'
 
insert into [StrSource] 
([Ar],[En])
select  ' ','Fixed operations'
 
insert into [StrSource] 
([Ar],[En])
select  ' ','Ascending order'
 
insert into [StrSource] 
([Ar],[En])
select  ' ','Descending order'
 
insert into [StrSource] 
([Ar],[En])
select  ' xls','Export XLS'
 
insert into [StrSource] 
([Ar],[En])
select  '   SMS','SMS Report'
 
insert into [StrSource] 
([Ar],[En])
select  '  ','Snet SMS report'
 
insert into [StrSource] 
([Ar],[En])
select  '  ','Generate servants flats'
 
insert into [StrSource] 
([Ar],[En])
select  '  ','Generate driver flats'
 
insert into [StrSource] 
([Ar],[En])
select  ' ','Jumada I'
 
insert into [StrSource] 
([Ar],[En])
select  ' ','Jumada II'
 
insert into [StrSource] 
([Ar],[En])
select  ' ','Delete checked'
 
insert into [StrSource] 
([Ar],[En])
select  '  ','Delete servants flats'
 
insert into [StrSource] 
([Ar],[En])
select  ' ','Zulhijjah'
 
insert into [StrSource] 
([Ar],[En])
select  ' ','Zulkaedah'
 
insert into [StrSource] 
([Ar],[En])
select  ' ','rabee al awwal'
 
insert into [StrSource] 
([Ar],[En])
select  ' ','rabee al thani'
 
insert into [StrSource] 
([Ar],[En])
select  '','Rajab'
 
insert into [StrSource] 
([Ar],[En])
select  '','Ramadan'
 
insert into [StrSource] 
([Ar],[En])
select  '','Shaban'
 
insert into [StrSource] 
([Ar],[En])
select  '[K]   ','[K] Collection Date'
 
insert into [StrSource] 
([Ar],[En])
select  '[K]  ','[K] Contract No.'
 
insert into [StrSource] 
([Ar],[En])
select  '[L] ','[L] Note'
 
insert into [StrSource] 
([Ar],[En])
select  '[L]  ','[L] Contract Value'
 
insert into [StrSource] 
([Ar],[En])
select  ' ','Cancel'
 
insert into [StrSource] 
([Ar],[En])
select  ' ','Cancel collection'
 
insert into [StrSource] 
([Ar],[En])
select  ' ','Cancel deposit'
 
insert into [StrSource] 
([Ar],[En])
select  ' ','Cancel endorsement'
 
insert into [StrSource] 
([Ar],[En])
select  '  ','Uncheck All'
 
insert into [StrSource] 
([Ar],[En])
select  '','Fines'
 
insert into [StrSource] 
([Ar],[En])
select  '  ','Purpose of rent'
 
insert into [StrSource] 
([Ar],[En])
select  '  ','Rooms and Flats'
 
insert into [StrSource] 
([Ar],[En])
select  ' ','Sort By'
 
insert into [StrSource] 
([Ar],[En])
select  '...','Sort...'
 
insert into [StrSource] 
([Ar],[En])
select  '','Brunch'
 
insert into [StrSource] 
([Ar],[En])
select  ' ','Main branch'
 
insert into [StrSource] 
([Ar],[En])
select  '','Difference'
 
insert into [StrSource] 
([Ar],[En])
select  '','Branches'
 
insert into [StrSource] 
([Ar],[En])
select  '','Actual'
 
insert into [StrSource] 
([Ar],[En])
select  '','Villas'
 
insert into [StrSource] 
([Ar],[En])
select  '    ','Leased and Non-leased villas'
 
insert into [StrSource] 
([Ar],[En])
select  '   ','Leased and Non-leased villas'
 
insert into [StrSource] 
([Ar],[En])
select  '    ','Sold and Non-sold villas'
 
insert into [StrSource] 
([Ar],[En])
select  '   ','Sold and Non-sold villas'
 
insert into [StrSource] 
([Ar],[En])
select  '','Bills'
 
insert into [StrSource] 
([Ar],[En])
select  '','Villa'
 
insert into [StrSource] 
([Ar],[En])
select  '   ','Leased and Non-leased villas'
 
insert into [StrSource] 
([Ar],[En])
select  '','List'
 
insert into [StrSource] 
([Ar],[En])
select  '','Payemnt'
 
insert into [StrSource] 
([Ar],[En])
select  ' ','Fixed installment'
 
insert into [StrSource] 
([Ar],[En])
select  ' ','Increasing installment'
 
insert into [StrSource] 
([Ar],[En])
select  ' ','Decreasing installment'
 
insert into [StrSource] 
([Ar],[En])
select  ' ','Satellite'
 
insert into [StrSource] 
([Ar],[En])
select  '','Menus'
 
insert into [StrSource] 
([Ar],[En])
select  '  ','Do matching procedures'
 
insert into [StrSource] 
([Ar],[En])
select  ' ','Opening entry'
 
insert into [StrSource] 
([Ar],[En])
select  ' ','Opening entry'
 
insert into [StrSource] 
([Ar],[En])
select  ' ','Journal entry'
 
insert into [StrSource] 
([Ar],[En])
select  '       ','Journal entry does not contain customer account'
 
insert into [StrSource] 
([Ar],[En])
select  '  ','illogical journal entry'
 
insert into [StrSource] 
([Ar],[En])
select  '','Value'
 
insert into [StrSource] 
([Ar],[En])
select  ' 1','Value 1'
 
insert into [StrSource] 
([Ar],[En])
select  ' 2','Value 2'
 
insert into [StrSource] 
([Ar],[En])
select  ' ','Total amount'
 
insert into [StrSource] 
([Ar],[En])
select  '    ','Primary value to calculate depreciation'
 
insert into [StrSource] 
([Ar],[En])
select  '  ','New value of asset'
 
insert into [StrSource] 
([Ar],[En])
select  ' ','Current value'
 
insert into [StrSource] 
([Ar],[En])
select  ' ','Monthly value'
 
insert into [StrSource] 
([Ar],[En])
select  ' ','Value received'
 
insert into [StrSource] 
([Ar],[En])
select  '     ','Collected value is lager than total value'
 
insert into [StrSource] 
([Ar],[En])
select  '  ','Value due to owner'
 
insert into [StrSource] 
([Ar],[En])
select  '  ','Value due to tenant'
 
insert into [StrSource] 
([Ar],[En])
select  ' 2','Notes 2'
 
insert into [StrSource] 
([Ar],[En])
select  '','Canceled'
 
insert into [StrSource] 
([Ar],[En])
select  '','Ownership'
 
insert into [StrSource] 
([Ar],[En])
select  '','Areas'
 
insert into [StrSource] 
([Ar],[En])
select  '','Transfers'
 
insert into [StrSource] 
([Ar],[En])
select  '','Finished'
 
insert into [StrSource] 
([Ar],[En])
select  '','Origin'
 
insert into [StrSource] 
([Ar],[En])
select  '','Area name'
 
insert into [StrSource] 
([Ar],[En])
select  '','Occupation'
 
insert into [StrSource] 
([Ar],[En])
select  '','Materials'
 
insert into [StrSource] 
([Ar],[En])
select  ' ','Used materials'
 
insert into [StrSource] 
([Ar],[En])
select  '','Parking'
 
insert into [StrSource] 
([Ar],[En])
select  '    ','Leased and Non-leased Parking'
 
insert into [StrSource] 
([Ar],[En])
select  ' ','Sheltered parking'
 
insert into [StrSource] 
([Ar],[En])
select  '','Supplier'
 
insert into [StrSource] 
([Ar],[En])
select  '','Theme'
 
insert into [StrSource] 
([Ar],[En])
select  '  Theme','Theme'
 
insert into [StrSource] 
([Ar],[En])
select  ' ','Subject contains'
 
insert into [StrSource] 
([Ar],[En])
select  '','Location'
 
insert into [StrSource] 
([Ar],[En])
select  ' ','Main location'
 
insert into [StrSource] 
([Ar],[En])
select  ' ','First location'
 
insert into [StrSource] 
([Ar],[En])
select  ' ','New location'
 
insert into [StrSource] 
([Ar],[En])
select  ' ','Current location'
 
insert into [StrSource] 
([Ar],[En])
select  '  ','Location on map'
 
insert into [StrSource] 
([Ar],[En])
select  '','Parkings'
 
insert into [StrSource] 
([Ar],[En])
select  '    : ','Parking is reserved by:'
 
insert into [StrSource] 
([Ar],[En])
select  '','Balance sheet'
 
insert into [StrSource] 
([Ar],[En])
select  '','Mezzanine'
 
insert into [StrSource] 
([Ar],[En])
select  '','Window'
 
insert into [StrSource] 
([Ar],[En])
select  '','Result'
 
insert into [StrSource] 
([Ar],[En])
select  ' %','Percentage %'
 
insert into [StrSource] 
([Ar],[En])
select  ' ','Paid percentage'
 
insert into [StrSource] 
([Ar],[En])
select  '  ','Auto backup'
 
insert into [StrSource] 
([Ar],[En])
select  ' ','Backup'
 
insert into [StrSource] 
([Ar],[En])
select  '   ','Backup on external device'
 
insert into [StrSource] 
([Ar],[En])
select  '   ','Backup is not valid'
 
insert into [StrSource] 
([Ar],[En])
select  '  ','Basin Filter System'
 
insert into [StrSource] 
([Ar],[En])
select  '','Type'
 
insert into [StrSource] 
([Ar],[En])
select  ' ','Opened windows'
 
insert into [StrSource] 
([Ar],[En])
select  '','Type'
 
insert into [StrSource] 
([Ar],[En])
select  '','Phone'
 
insert into [StrSource] 
([Ar],[En])
select  '','Gifts'
 
insert into [StrSource] 
([Ar],[En])
select  '','Units'
 
insert into [StrSource] 
([Ar],[En])
select  '   ','Units that will be vacated'
 
insert into [StrSource] 
([Ar],[En])
select  '   ','Leased and Non-leased units'
 
insert into [StrSource] 
([Ar],[En])
select  '   ','Sold and Non-sold units'
 
insert into [StrSource] 
([Ar],[En])
select  '','Unit'
 
insert into [StrSource] 
([Ar],[En])
select  ' 2','Unit 2'
 
insert into [StrSource] 
([Ar],[En])
select  '  ','Enter due date'
 
insert into [StrSource] 
([Ar],[En])
select  '  ','Enter closing date'
 
insert into [StrSource] 
([Ar],[En])
select  '  ','Enter issue date'
 
insert into [StrSource] 
([Ar],[En])
select  '  ','Enter purchase date'
 
insert into [StrSource] 
([Ar],[En])
select  ' ','Value as scrap'
 
insert into [StrSource] 
([Ar],[En])
select  '','Entries'
 
insert into [StrSource] 
([Ar],[En])
select  '','Warranty'
 
insert into [StrSource] 
([Ar],[En])
select  '','Sponser'
 
insert into [StrSource] 
([Ar],[En])
select  '','All'
 
insert into [StrSource] 
([Ar],[En])
select  '','Cost'
 
insert into [StrSource] 
([Ar],[En])
select  ' ','Total cost'
 
insert into [StrSource] 
([Ar],[En])
select  ' ','Unit cost'
 
insert into [StrSource] 
([Ar],[En])
select  '','Quantity'
 
insert into [StrSource] 
([Ar],[En])
select  ' 2','Quantity 2'
 
insert into [StrSource] 
([Ar],[En])
select  ' 3','Quantity 3'
 
insert into [StrSource] 
([Ar],[En])
select  '','Electricity'
 
insert into [StrSource] 
([Ar],[En])
select  '','Language'
 
insert into [StrSource] 
([Ar],[En])
select  '','Color'
 
insert into [StrSource] 
([Ar],[En])
select  ' ','1st Color'
 
insert into [StrSource] 
([Ar],[En])
select  ' ','2nd Color'
 
insert into [StrSource] 
([Ar],[En])
select  '','Lessor'
 
insert into [StrSource] 
([Ar],[En])
select  '','Leased'
 
insert into [StrSource] 
([Ar],[En])
select  '','Material'
 
insert into [StrSource] 
([Ar],[En])
select  '','Owner'
 
insert into [StrSource] 
([Ar],[En])
select  ' ','Previous owner'
 
insert into [StrSource] 
([Ar],[En])
select  '','Sold '
 
insert into [StrSource] 
([Ar],[En])
select  '','Without'
 
insert into [StrSource] 
([Ar],[En])
select  ' ','Without depreciation'
 
insert into [StrSource] 
([Ar],[En])
select  ' ','No rounding'
 
insert into [StrSource] 
([Ar],[En])
select  '  ','Without downpayment'
 
insert into [StrSource] 
([Ar],[En])
select  '  ','Clearance'
 
insert into [StrSource] 
([Ar],[En])
select  ' ','Email Address'
 
insert into [StrSource] 
([Ar],[En])
select  '  ','Because of permission level'
 
insert into [StrSource] 
([Ar],[En])
select  '','Cards'
 
insert into [StrSource] 
([Ar],[En])
select  '  ','Empty accounts cards'
 
insert into [StrSource] 
([Ar],[En])
select  '  ','Balanced customer cards'
 
insert into [StrSource] 
([Ar],[En])
select  '','Card'
 
insert into [StrSource] 
([Ar],[En])
select  ' ','Land card'
 
insert into [StrSource] 
([Ar],[En])
select  '  ()','Land card (Offers)'
 
insert into [StrSource] 
([Ar],[En])
select  '    ','Land & Villa card'
 
insert into [StrSource] 
([Ar],[En])
select  ' ','Asset card'
 
insert into [StrSource] 
([Ar],[En])
select  ' ','Account card'
 
insert into [StrSource] 
([Ar],[En])
select  ' ','Customer card'
 
insert into [StrSource] 
([Ar],[En])
select  ' ','Property card'
 
insert into [StrSource] 
([Ar],[En])
select  ' ','Currency card'
 
insert into [StrSource] 
([Ar],[En])
select  ' ','Branch card'
 
insert into [StrSource] 
([Ar],[En])
select  ' ','Material card'
 
insert into [StrSource] 
([Ar],[En])
select  ' ','Group card'
 
insert into [StrSource] 
([Ar],[En])
select  ' ','Briefcase card'
 
insert into [StrSource] 
([Ar],[En])
select  '  ','Realty briefcase card'
 
insert into [StrSource] 
([Ar],[En])
select  ' ','Salesman card'
 
insert into [StrSource] 
([Ar],[En])
select  ' ','Building card'
 
insert into [StrSource] 
([Ar],[En])
select  ' ','Building card'
 
insert into [StrSource] 
([Ar],[En])
select  '  ()','Building card (Offers)'
 
insert into [StrSource] 
([Ar],[En])
select  ' ','Assemblage card'
 
insert into [StrSource] 
([Ar],[En])
select  ' ','Card reminder'
 
insert into [StrSource] 
([Ar],[En])
select  '  ','Property booking card'
 
insert into [StrSource] 
([Ar],[En])
select  ' ','Account card'
 
insert into [StrSource] 
([Ar],[En])
select  ' ','Customer card'
 
insert into [StrSource] 
([Ar],[En])
select  '  / ','Customer / Supplier card'
 
insert into [StrSource] 
([Ar],[En])
select  ' ','Flat card'
 
insert into [StrSource] 
([Ar],[En])
select  '  ()','Flat card (Offers)'
 
insert into [StrSource] 
([Ar],[En])
select  ' ','Complaint card'
 
insert into [StrSource] 
([Ar],[En])
select  '  ','Maintenance worker card'
 
insert into [StrSource] 
([Ar],[En])
select  '  ','Maintenance worker card'
 
insert into [StrSource] 
([Ar],[En])
select  ' ','Building card'
 
insert into [StrSource] 
([Ar],[En])
select  ' ','Currency card'
 
insert into [StrSource] 
([Ar],[En])
select  ' ','Branch card'
 
insert into [StrSource] 
([Ar],[En])
select  ' ','Villa card'
 
insert into [StrSource] 
([Ar],[En])
select  '  ()','Villa card (Offers)'
 
insert into [StrSource] 
([Ar],[En])
select  '   ','Lessor & Sales man card'
 
insert into [StrSource] 
([Ar],[En])
select  ' ','Material card'
 
insert into [StrSource] 
([Ar],[En])
select  ' ','Owner card'
 
insert into [StrSource] 
([Ar],[En])
select  ' ','Group card'
 
insert into [StrSource] 
([Ar],[En])
select  ' ','Shop card'
 
insert into [StrSource] 
([Ar],[En])
select  '  ()','Shop card (Offers)'
 
insert into [StrSource] 
([Ar],[En])
select  '   ','Shop & Parking Card'
 
insert into [StrSource] 
([Ar],[En])
select  ' ','City card'
 
insert into [StrSource] 
([Ar],[En])
select  '  / ','Customer / Supplier card'
 
insert into [StrSource] 
([Ar],[En])
select  ' ','Store card'
 
insert into [StrSource] 
([Ar],[En])
select  ' ','Area card'
 
insert into [StrSource] 
([Ar],[En])
select  ' ','Parking card'
 
insert into [StrSource] 
([Ar],[En])
select  ' / ','Day / Left'
 
insert into [StrSource] 
([Ar],[En])
select  '  ','Time of contract expiry'
 
insert into [StrSource] 
([Ar],[En])
select  '','Fixed'
 
insert into [StrSource] 
([Ar],[En])
select  '  ','Contract termination status'
 
insert into [StrSource] 
([Ar],[En])
select  '  ','Chart of cost center'
 
insert into [StrSource] 
([Ar],[En])
select  '  ','Entry origin No'
 
insert into [StrSource] 
([Ar],[En])
select  '  ','Journal entry No'
 
insert into [StrSource] 
([Ar],[En])
select  '','Price'
 
insert into [StrSource] 
([Ar],[En])
select  '  ','Show cost center'
 
insert into [StrSource] 
([Ar],[En])
select  ' ','Not Sent'
 
insert into [StrSource] 
([Ar],[En])
select  '  ','Revenue period'
 
insert into [StrSource] 
([Ar],[En])
select  ' ','Return entry'
 
insert into [StrSource] 
([Ar],[En])
select  ' ','Collect entry'
 
insert into [StrSource] 
([Ar],[En])
select  '  ','Partial collect entry'
 
insert into [StrSource] 
([Ar],[En])
select  ' ','Deposit entry'
 
insert into [StrSource] 
([Ar],[En])
select  ' ','Endorsement entry'
 
insert into [StrSource] 
([Ar],[En])
select  ' ','Note entry'
 
insert into [StrSource] 
([Ar],[En])
select  ' ','Material type'
 
insert into [StrSource] 
([Ar],[En])
select  '     ','Clearance printed by'
 
insert into [StrSource] 
([Ar],[En])
select  ' ','Fees total'
 
insert into [StrSource] 
([Ar],[En])
select  ' ','Pricing policy'
 
insert into [StrSource] 
([Ar],[En])
select  '   ','Enter investment starting date'
 
insert into [StrSource] 
([Ar],[En])
select  '   ','Enter contract end date'
 
insert into [StrSource] 
([Ar],[En])
select  '  ','Enter currency rate'
 
insert into [StrSource] 
([Ar],[En])
select  '   ','Enter currency rate of investment'
 
insert into [StrSource] 
([Ar],[En])
select  '   ','Enter currency rate of purchase'
 
insert into [StrSource] 
([Ar],[En])
select  '  ','Enter file description'
 
insert into [StrSource] 
([Ar],[En])
select  '   ','Enter new file description'
 
insert into [StrSource] 
([Ar],[En])
select  '    ','Enter incoming account of contract price'
 
insert into [StrSource] 
([Ar],[En])
select  '  ','Enter closing account'
 
insert into [StrSource] 
([Ar],[En])
select  '     ','Enter closing account of profit and loss'
 
insert into [StrSource] 
([Ar],[En])
select  '  ','Enter revenue account'
 
insert into [StrSource] 
([Ar],[En])
select  '  ','Enter building account'
 
insert into [StrSource] 
([Ar],[En])
select  '  ','Enter security deposit account'
 
insert into [StrSource] 
([Ar],[En])
select  '  ','Enter discount account'
 
insert into [StrSource] 
([Ar],[En])
select  '   ','Enter down payment account'
 
insert into [StrSource] 
([Ar],[En])
select  '    ','Enter commission account from customer'
 
insert into [StrSource] 
([Ar],[En])
select  '     ','Enter commission account from building owner'
 
insert into [StrSource] 
([Ar],[En])
select  '     ','Enter commission account from property owner'
 
insert into [StrSource] 
([Ar],[En])
select  '  ','Enter customer account'
 
insert into [StrSource] 
([Ar],[En])
select  '  ','Enter owner account'
 
insert into [StrSource] 
([Ar],[En])
select  '  ','Enter project account'
 
insert into [StrSource] 
([Ar],[En])
select  '  ','Enter supplier account'
 
insert into [StrSource] 
([Ar],[En])
select  '      ','Enter owner account to property card'
 
insert into [StrSource] 
([Ar],[En])
select  '       ','Enter exchange rate account in program settings'
 
insert into [StrSource] 
([Ar],[En])
select  '    ','Enter account of revenue other fees'
 
insert into [StrSource] 
([Ar],[En])
select  '    ','Enter revenue account of other fees'
 
insert into [StrSource] 
([Ar],[En])
select  '  ','Enter account code'
 
insert into [StrSource] 
([Ar],[En])
select  '  ','Enter investment currency'
 
insert into [StrSource] 
([Ar],[En])
select  '  ','Enter purchase currency'
 
insert into [StrSource] 
([Ar],[En])
select  '       (IpAddress)','Enter computer IP Address where the dongle was installed'
 
insert into [StrSource] 
([Ar],[En])
select  '  ','Enter investment value'
 
insert into [StrSource] 
([Ar],[En])
select  '  ','Enter value payment'
 
insert into [StrSource] 
([Ar],[En])
select  '  ','Enter purchase amount'
 
insert into [StrSource] 
([Ar],[En])
select  '  ','Enter cheque type'
 
insert into [StrSource] 
([Ar],[En])
select  '   ','Enter receipt voucher type'
 
insert into [StrSource] 
([Ar],[En])
select  '  ','Enter payment type'
 
insert into [StrSource] 
([Ar],[En])
select  '','Tools'
 
insert into [StrSource] 
([Ar],[En])
select  ' ','External Tools'
 
insert into [StrSource] 
([Ar],[En])
select  ' ...','External Tools'
 
insert into [StrSource] 
([Ar],[En])
select  '    ','If you want to modify data press the Modify button'
 
insert into [StrSource] 
([Ar],[En])
select  '','Lands'
 
insert into [StrSource] 
([Ar],[En])
select  ' ','Receipt numbers'
 
insert into [StrSource] 
([Ar],[En])
select  ' xls','Import XLS'
 
insert into [StrSource] 
([Ar],[En])
select  ' ','Import Data'
 
insert into [StrSource] 
([Ar],[En])
select  ' ','Street No.'
 
insert into [StrSource] 
([Ar],[En])
select  '     ','Only show checks that not related with contracts'
 
insert into [StrSource] 
([Ar],[En])
select  '    ','Show message in SMS report'
 
insert into [StrSource] 
([Ar],[En])
select  '         ','Show message in SMS report after check return in'
 
insert into [StrSource] 
([Ar],[En])
select  '        ','Show message in SMS report after contract expires in'
 
insert into [StrSource] 
([Ar],[En])
select  '         ','Show message in SMS report after collect check in'
 
insert into [StrSource] 
([Ar],[En])
select  '       ','Show message in SMS report immediately after check return'
 
insert into [StrSource] 
([Ar],[En])
select  '       ','Show message in SMS report immediately after check collect'
 
insert into [StrSource] 
([Ar],[En])
select  '        ','Show message in SMS report when contract expire'
 
insert into [StrSource] 
([Ar],[En])
select  '        ','Show message in SMS report before contract expire in'
 
insert into [StrSource] 
([Ar],[En])
select  '      ','Show assembled flat that contract has been terminated'
 
insert into [StrSource] 
([Ar],[En])
select  '   ','Deposit journal entry'
 
insert into [StrSource] 
([Ar],[En])
select  '   ','Create deposit accounts into'
 
insert into [StrSource] 
([Ar],[En])
select  '  ','Create accounts into'
 
insert into [StrSource] 
([Ar],[En])
select  '  ','Exclude returned cheque'
 
insert into [StrSource] 
([Ar],[En])
select  '    ','Exclude cheque without due date'
 
insert into [StrSource] 
([Ar],[En])
select  ' ','Table name'
 
insert into [StrSource] 
([Ar],[En])
select  '     ','Remind backup every'
 
insert into [StrSource] 
([Ar],[En])
select  '  SMS','SMS'
 
insert into [StrSource] 
([Ar],[En])
select  '       ','Allow users with full authorize passing fixed date of operations'
 
insert into [StrSource] 
([Ar],[En])
select  ' ','Contract Expired'
 
insert into [StrSource] 
([Ar],[En])
select  ' ','Multi entries'
 
insert into [StrSource] 
([Ar],[En])
select  ' ','Total value'
 
insert into [StrSource] 
([Ar],[En])
select  ' ','Partial collected'
 
insert into [StrSource] 
([Ar],[En])
select  ' ','Partial collected'
 
insert into [StrSource] 
([Ar],[En])
select  ' ','Completely collected'
 
insert into [StrSource] 
([Ar],[En])
select  '  ','Receipt print folder'
 
insert into [StrSource] 
([Ar],[En])
select  '   ','Clearance print folder'
 
insert into [StrSource] 
([Ar],[En])
select  '  ','Total revenue'
 
insert into [StrSource] 
([Ar],[En])
select  '  ','Collected payments total'
 
insert into [StrSource] 
([Ar],[En])
select  '   ','Due paymants total'
 
insert into [StrSource] 
([Ar],[En])
select  '  ','Collected cheque total'
 
insert into [StrSource] 
([Ar],[En])
select  '  ','Due cheque total'
 
insert into [StrSource] 
([Ar],[En])
select  ' ','Total fines'
 
insert into [StrSource] 
([Ar],[En])
select  '   ','Sum of values ??due to owner'
 
insert into [StrSource] 
([Ar],[En])
select  '    ','Sum of values ??due to tenant'
 
insert into [StrSource] 
([Ar],[En])
select  '   ','Total net due for tenants'
 
insert into [StrSource] 
([Ar],[En])
select  '     ','Total value of contracts after discount'
 
insert into [StrSource] 
([Ar],[En])
select  '     ','Total value of contracts before discount'
 
insert into [StrSource] 
([Ar],[En])
select  '','Muharram'
 
insert into [StrSource] 
([Ar],[En])
select  ' ','Cost center'
 
insert into [StrSource] 
([Ar],[En])
select  ' ','Contract note'
 
insert into [StrSource] 
([Ar],[En])
select  ' ','Assemblage parking'
 
insert into [StrSource] 
([Ar],[En])
select  '   ','Cost center trail balance'
 
insert into [StrSource] 
([Ar],[En])
select  '','Gregorian'
 
insert into [StrSource] 
([Ar],[En])
select  ' ','Send result'
 
insert into [StrSource] 
([Ar],[En])
select  '  [M]','The Message [M]'
 
insert into [StrSource] 
([Ar],[En])
select  '  /','Card type Customer/Supplier'
 
insert into [StrSource] 
([Ar],[En])
select  '','Hijri'
 
insert into [StrSource] 
([Ar],[En])
select  '   :','Those parking are:'
 
insert into [StrSource] 
([Ar],[En])
select  '       ','This parking consists of assembling more than one parking'
 
insert into [StrSource] 
([Ar],[En])
select  '     ','There is valid contract for same property'
 
insert into [StrSource] 
([Ar],[En])
select  '  ','Security deposit required'
 
insert into [StrSource] 
([Ar],[En])
select  '  ','Enter Username'
 
insert into [StrSource] 
([Ar],[En])
select  '      ','Enter owner name in parking card'
 
insert into [StrSource] 
([Ar],[En])
select  '     ','Send SMS when adding maintenance order'
 
insert into [StrSource] 
([Ar],[En])
select  '    ','Send SMS when adding complaint'
 
insert into [StrSource] 
([Ar],[En])
select  '   ','Send SMS when returning check'
 
insert into [StrSource] 
([Ar],[En])
select  '   ','Send SMS when collecting check'
 
insert into [StrSource] 
([Ar],[En])
select  '  ','Send SMS when add'
 
insert into [StrSource] 
([Ar],[En])
select  '      ','Send SMS before check due in'
 
insert into [StrSource] 
([Ar],[En])
select  '     ','Send SMS when closing complaint'
 
insert into [StrSource] 
([Ar],[En])
select  '    ','Show building in contracts'
 
insert into [StrSource] 
([Ar],[En])
select  ' ','Customer name'
 
insert into [StrSource] 
([Ar],[En])
select  ' ','Sender name'
 
insert into [StrSource] 
([Ar],[En])
select  ' ','Saved revenues'
 
insert into [StrSource] 
([Ar],[En])
select  ' ','Realty Estimation'
 
insert into [StrSource] 
([Ar],[En])
select  '','Message'
 
insert into [StrSource] 
([Ar],[En])
select  '','Fees'
 
insert into [StrSource] 
([Ar],[En])
select  '  ','Customer balance'
 
insert into [StrSource] 
([Ar],[En])
select  ' ','Special Code'
 
insert into [StrSource] 
([Ar],[En])
select  '  ','Price after discount'
 
insert into [StrSource] 
([Ar],[En])
select  ' ','New value'
 
insert into [StrSource] 
([Ar],[En])
select  ' ','Previous value'
 
insert into [StrSource] 
([Ar],[En])
select  ' ','Returned value'
 
insert into [StrSource] 
([Ar],[En])
select  ' ','Arabic description'
 
insert into [StrSource] 
([Ar],[En])
select  ' ','Latin description'
 
insert into [StrSource] 
([Ar],[En])
select  '  ','To selected users'
 
insert into [StrSource] 
([Ar],[En])
select  ' ','To location'
 
insert into [StrSource] 
([Ar],[En])
select  ' ','To date'
 
insert into [StrSource] 
([Ar],[En])
select  ' ','Current date'
 
insert into [StrSource] 
([Ar],[En])
select  ' !  ','Warning !'
 
insert into [StrSource] 
([Ar],[En])
select  ' ','End of contract'
 
insert into [StrSource] 
([Ar],[En])
select  ' ','Generate journal entry'
 
insert into [StrSource] 
([Ar],[En])
select  ' ','Connection lost'
 
insert into [StrSource] 
([Ar],[En])
select  '  ','Note Paper Types'
 
insert into [StrSource] 
([Ar],[En])
select  ' ','Contract Types'
 
insert into [StrSource] 
([Ar],[En])
select  ' ','Bills Type'
 
insert into [StrSource] 
([Ar],[En])
select  ' ','Terminate contract'
 
insert into [StrSource] 
([Ar],[En])
select  '','Rent'
 
insert into [StrSource] 
([Ar],[En])
select  ' ','Daily income'
 
insert into [StrSource] 
([Ar],[En])
select  '  ','Rental income earned'
 
insert into [StrSource] 
([Ar],[En])
select  ' ','Rest of collection'
 
insert into [StrSource] 
([Ar],[En])
select  '','date'
 
insert into [StrSource] 
([Ar],[En])
select  '','Search'
 
insert into [StrSource] 
([Ar],[En])
select  ' ','without installments'
 
insert into [StrSource] 
([Ar],[En])
select  ' ','Entry details'
 
insert into [StrSource] 
([Ar],[En])
select  ' ','Personal informations'
 
insert into [StrSource] 
([Ar],[En])
select  '  ','Latin Personal Information'
 
insert into [StrSource] 
([Ar],[En])
select  '   ','Residence expiry date'
 
insert into [StrSource] 
([Ar],[En])
select  '   ','Last delayed cheque'
 
insert into [StrSource] 
([Ar],[En])
select  '  ','ID expiry date'
 
insert into [StrSource] 
([Ar],[En])
select  '   ','Previous contract termination date'
 
insert into [StrSource] 
([Ar],[En])
select  '  ','First payment date'
 
insert into [StrSource] 
([Ar],[En])
select  '   ','First delayed cheque'
 
insert into [StrSource] 
([Ar],[En])
select  '   ','Clearance print date'
 
insert into [StrSource] 
([Ar],[En])
select  '  ','Due end date'
 
insert into [StrSource] 
([Ar],[En])
select  '   ','Previous contract ending date'
 
insert into [StrSource] 
([Ar],[En])
select  '   ','Check prices and material balances'
 
insert into [StrSource] 
([Ar],[En])
select  '  XLS','Export table to XLS'
 
insert into [StrSource] 
([Ar],[En])
select  '       ','Active unrealized revenue account for same year'
 
insert into [StrSource] 
([Ar],[En])
select  '  SMS','SMS Report'
 
insert into [StrSource] 
([Ar],[En])
select  '  ','Quotations Report'
 
insert into [StrSource] 
([Ar],[En])
select  '     ','Registered contract has been received from customer'
 
insert into [StrSource] 
([Ar],[En])
select  '    ','Contract has been received for send it to registration'
 
insert into [StrSource] 
([Ar],[En])
select  ' ','Data has been imported'
 
insert into [StrSource] 
([Ar],[En])
select  '    ','Registered contract has been delivered to customer'
 
insert into [StrSource] 
([Ar],[En])
select  '   ','Contract has been delivered to customer'
 
insert into [StrSource] 
([Ar],[En])
select  '  ','Contract printed'
 
insert into [StrSource] 
([Ar],[En])
select  '   ','Extension paper printed'
 
insert into [StrSource] 
([Ar],[En])
select  ' ','Tables description'
 
insert into [StrSource] 
([Ar],[En])
select  '  ','Generate entry by type'
 
insert into [StrSource] 
([Ar],[En])
select  '   ','Unrealized revenue account'
 
insert into [StrSource] 
([Ar],[En])
select  ' ','Link with'
 
insert into [StrSource] 
([Ar],[En])
select  '  ','Contract price value'
 
insert into [StrSource] 
([Ar],[En])
select  ' ','Land No.'
 
insert into [StrSource] 
([Ar],[En])
select  ' ','Residence No.'
 
insert into [StrSource] 
([Ar],[En])
select  ' ','Report No.'
 
insert into [StrSource] 
([Ar],[En])
select  '  ','Related flat No.'
 
insert into [StrSource] 
([Ar],[En])
select  '  ','Cheque serial No.'
 
insert into [StrSource] 
([Ar],[En])
select  ' ','Quotation No.'
 
insert into [StrSource] 
([Ar],[En])
select  '  ','Contract serial No.'
 
insert into [StrSource] 
([Ar],[En])
select  ' ','Last purchase'
 
insert into [StrSource] 
([Ar],[En])
select  '    ','Customers data will be imported'
 
insert into [StrSource] 
([Ar],[En])
select  '       ','All related entries will be deleted'
 
insert into [StrSource] 
([Ar],[En])
select  ' ','Buildings Permission'
 
insert into [StrSource] 
([Ar],[En])
select  '  ','Empty days No.'
 
insert into [StrSource] 
([Ar],[En])
select  '  ','Late payments No'
 
insert into [StrSource] 
([Ar],[En])
select  '  ','Dwell flats No.'
 
insert into [StrSource] 
([Ar],[En])
select  ' ','Quotation Card'
 
insert into [StrSource] 
([Ar],[En])
select  '','Contract'
 
insert into [StrSource] 
([Ar],[En])
select  ' ','Not specified'
 
insert into [StrSource] 
([Ar],[En])
select  '','Villas'
 
insert into [StrSource] 
([Ar],[En])
select  ' ','Installment value'
 
insert into [StrSource] 
([Ar],[En])
select  '','Nothing'
 
insert into [StrSource] 
([Ar],[En])
select  ' ','with installments'
 
insert into [StrSource] 
([Ar],[En])
select  ' ','Cheque period'
 
insert into [StrSource] 
([Ar],[En])
select  ' ','Property area'
 
insert into [StrSource] 
([Ar],[En])
select  ' ','From computer'
 
insert into [StrSource] 
([Ar],[En])
select  '   ','Log file with editing'
 
insert into [StrSource] 
([Ar],[En])
select  ' ','Information Window'
 
insert into [StrSource] 
([Ar],[En])
select  '    ','Move the following when renewing contract'
 
insert into [StrSource] 
([Ar],[En])
select  '  ','Total units number'
 
insert into [StrSource] 
([Ar],[En])
select  '    ','Remove clearance print check'
 
insert into [StrSource] 
([Ar],[En])
select  '  ','Browse other users'
 
insert into [StrSource] 
([Ar],[En])
select  '   XLS','Import table from XLS'
 
insert into [StrSource] 
([Ar],[En])
select  '  ','Import Customers Data'
 
insert into [StrSource] 
([Ar],[En])
select  ' ','Server Namer'
 
insert into [StrSource] 
([Ar],[En])
select  ' ','Sender ID'
 
insert into [StrSource] 
([Ar],[En])
select  ' ','Report Name'
 
insert into [StrSource] 
([Ar],[En])
select  ' ','Entry origin'
 
insert into [StrSource] 
([Ar],[En])
select  ' ','Show currency'
 
insert into [StrSource] 
([Ar],[En])
select  '    ','Show choose language dialog box'
 
insert into [StrSource] 
([Ar],[En])
select  ' ','Fixed assets'
 
insert into [StrSource] 
([Ar],[En])
select  '','Additions'
 
insert into [StrSource] 
([Ar],[En])
select  '    ','Rent by last registered contract'
 
insert into [StrSource] 
([Ar],[En])
select  '','Colors'
 
insert into [StrSource] 
([Ar],[En])
select  '','Card'
 
insert into [StrSource] 
([Ar],[En])
select  '','Device'
 
insert into [StrSource] 
([Ar],[En])
select  ' ','Issued by'
 
insert into [StrSource] 
([Ar],[En])
select  '  ','Receipt issued by'
 
insert into [StrSource] 
([Ar],[En])
select  '  ','Selected status only'
 
insert into [StrSource] 
([Ar],[En])
select  ' ','Account by'
 
insert into [StrSource] 
([Ar],[En])
select  '','Discount'
 
insert into [StrSource] 
([Ar],[En])
select  '','Lawsuite'
 
insert into [StrSource] 
([Ar],[En])
select  '    / Feeder','Use feeder'
 
insert into [StrSource] 
([Ar],[En])
select  '     ','Allow leased units after sell it'
 
insert into [StrSource] 
([Ar],[En])
select  '  ','Commission from customer value'
 
insert into [StrSource] 
([Ar],[En])
select  '   ','Commission from owner value'
 
insert into [StrSource] 
([Ar],[En])
select  ' ','Value Between'
 
insert into [StrSource] 
([Ar],[En])
select  '  ','Value not collected'
 
insert into [StrSource] 
([Ar],[En])
select  ' ','Cash Amount'
 
insert into [StrSource] 
([Ar],[En])
select  ' ','Grand total'
 
insert into [StrSource] 
([Ar],[En])
select  '  ','Checked for entries type'
 
insert into [StrSource] 
([Ar],[En])
select  ' ','Scanning settings'
 
insert into [StrSource] 
([Ar],[En])
select  ' ','Internal expenses'
 
insert into [StrSource] 
([Ar],[En])
select  '','Specification'
 
insert into [StrSource] 
([Ar],[En])
select  ' ','First unit'
 
insert into [StrSource] 
([Ar],[En])
select  ' ','Third unit'
 
insert into [StrSource] 
([Ar],[En])
select  ' ','Second unit'
 
insert into [StrSource] 
([Ar],[En])
select  ' ','Note paper'
 
insert into [StrSource] 
([Ar],[En])
select  ' ','Start numbering'
 
insert into [StrSource] 
([Ar],[En])
select  ' ','Contract start'
 
insert into [StrSource] 
([Ar],[En])
select  '  ','Start renumbering process'
 
insert into [StrSource] 
([Ar],[En])
select  '  ','Maintenance order start'
 
insert into [StrSource] 
([Ar],[En])
select  ' ','Contract start date'
 
insert into [StrSource] 
([Ar],[En])
select  ' ','Begining date'
 
insert into [StrSource] 
([Ar],[En])
select  ' ','Receipt details'
 
insert into [StrSource] 
([Ar],[En])
select  '   ','Date abstain from payment'
 
insert into [StrSource] 
([Ar],[En])
select  ' ','Receipt No'
 
insert into [StrSource] 
([Ar],[En])
select  '   ','Date refrain from repayment'
 
insert into [StrSource] 
([Ar],[En])
select  '   ','Delivery date to legal department'
 
insert into [StrSource] 
([Ar],[En])
select  ' ','Execution date'
 
insert into [StrSource] 
([Ar],[En])
select  ' ','Entry No'
 
insert into [StrSource] 
([Ar],[En])
select  '   ','Municipality clearance date'
 
insert into [StrSource] 
([Ar],[En])
select  '   ','Electricity clearance date'
 
insert into [StrSource] 
([Ar],[En])
select  '  ','Lawsuit date'
 
insert into [StrSource] 
([Ar],[En])
select  '  ','Lawsuit end date'
 
insert into [StrSource] 
([Ar],[En])
select  '  ','Current contract deposit'
 
insert into [StrSource] 
([Ar],[En])
select  '  ','Previous contract deposit'
 
insert into [StrSource] 
([Ar],[En])
select  '  ','Specify folder for card'
 
insert into [StrSource] 
([Ar],[En])
select  '  ','Specify folder for type'
 
insert into [StrSource] 
([Ar],[En])
select  ' ','Lawsuit delivery'
 
insert into [StrSource] 
([Ar],[En])
select  '  ','Arabic generate note'
 
insert into [StrSource] 
([Ar],[En])
select  '  ','Latin generate note'
 
insert into [StrSource] 
([Ar],[En])
select  '    ','Active log file with editing'
 
insert into [StrSource] 
([Ar],[En])
select  ' ','Editing report'
 
insert into [StrSource] 
([Ar],[En])
select  '  ','Lawsuit Report'
 
insert into [StrSource] 
([Ar],[En])
select  '  ','Quotations report'
 
insert into [StrSource] 
([Ar],[En])
select  ' ','Assess furniture'
 
insert into [StrSource] 
([Ar],[En])
select  '   ','Lawsuite termination on'
 
insert into [StrSource] 
([Ar],[En])
select  '   ','Retrieved from customer'
 
insert into [StrSource] 
([Ar],[En])
select  ' ','Received'
 
insert into [StrSource] 
([Ar],[En])
select  '  ','Execution stop on'
 
insert into [StrSource] 
([Ar],[En])
select  '      ','Generate obverse account details using lines details'
 
insert into [StrSource] 
([Ar],[En])
select  ' ','Lawsuite status'
 
insert into [StrSource] 
([Ar],[En])
select  ' ','Credit account'
 
insert into [StrSource] 
([Ar],[En])
select  ' ','Debit account'
 
insert into [StrSource] 
([Ar],[En])
select  ' ','Fees Accounts'
 
insert into [StrSource] 
([Ar],[En])
select  '   1','Fees revenue account 1'
 
insert into [StrSource] 
([Ar],[En])
select  '   2','Fees revenue account 2'
 
insert into [StrSource] 
([Ar],[En])
select  '   3','Fees revenue account 3'
 
insert into [StrSource] 
([Ar],[En])
select  '  ','Save photo with extension'
 
insert into [StrSource] 
([Ar],[En])
select  '   jpg','Jpg Resolution'
 
insert into [StrSource] 
([Ar],[En])
select  '    ','Link user with lawsuit status'
 
insert into [StrSource] 
([Ar],[En])
select  '    ','Link user with lawsuit expenses'
 
insert into [StrSource] 
([Ar],[En])
select  ' ','Municipal license'
 
insert into [StrSource] 
([Ar],[En])
select  '  ','Contract registration value'
 
insert into [StrSource] 
([Ar],[En])
select  ' ','Execution No'
 
insert into [StrSource] 
([Ar],[En])
select  ' ','Lawsuit No'
 
insert into [StrSource] 
([Ar],[En])
select  ' ','Quotations'
 
insert into [StrSource] 
([Ar],[En])
select  '   ','Flat contract linked to parking'
 
insert into [StrSource] 
([Ar],[En])
select  ' ','Open Lawsuit'
 
insert into [StrSource] 
([Ar],[En])
select  ' ','Receipt value'
 
insert into [StrSource] 
([Ar],[En])
select  ' ','Cheque Amount'
 
insert into [StrSource] 
([Ar],[En])
select  '  ','Rent amount due'
 
insert into [StrSource] 
([Ar],[En])
select  ' ','Total additions'
 
insert into [StrSource] 
([Ar],[En])
select  ' ','Total discount'
 
insert into [StrSource] 
([Ar],[En])
select  '  ','Total paid cheques'
 
insert into [StrSource] 
([Ar],[En])
select  ' ','Total Amount'
 
insert into [StrSource] 
([Ar],[En])
select  ' ','Maintenance expenses'
 
insert into [StrSource] 
([Ar],[En])
select  '  ','Receive voucher type'
 
insert into [StrSource] 
([Ar],[En])
select  '   ','End other users session'
 
insert into [StrSource] 
([Ar],[En])
select  '  ','Import Customers Data'
 
insert into [StrSource] 
([Ar],[En])
select  '','Evacuate date'
 
insert into [StrSource] 
([Ar],[En])
select  ' ','E-mail'
 
insert into [StrSource] 
([Ar],[En])
select  '','Report'
 
insert into [StrSource] 
([Ar],[En])
select  '   ','Maximum limit of discount rate'
 
insert into [StrSource] 
([Ar],[En])
select  ' ','Lawsuit'
 
insert into [StrSource] 
([Ar],[En])
select  ' ','SMS Message'
 
insert into [StrSource] 
([Ar],[En])
select  '       ','Allow to add a new contract without terminate the old contract'
 
insert into [StrSource] 
([Ar],[En])
select  '','Net'
 
insert into [StrSource] 
([Ar],[En])
select  ' ','Return Value'
 
insert into [StrSource] 
([Ar],[En])
select  '','Printed'
 
insert into [StrSource] 
([Ar],[En])
select  '  ','Customer Name'
 
insert into [StrSource] 
([Ar],[En])
select  '   [A]','Customer Name'
 
insert into [StrSource] 
([Ar],[En])
select  '  [A]','Customer Name'
 
insert into [StrSource] 
([Ar],[En])
select  ' ','Clearance'
 
insert into [StrSource] 
([Ar],[En])
select  ' ','Extra Information'
 
insert into [StrSource] 
([Ar],[En])
select  '   ','Last due check date'
 
insert into [StrSource] 
([Ar],[En])
select  '    ','Contract delivery date to registration'
 
insert into [StrSource] 
([Ar],[En])
select  '     ','Contract received date from customer'
 
insert into [StrSource] 
([Ar],[En])
select  '   ','Passport expiry date'
 
insert into [StrSource] 
([Ar],[En])
select  '         : ','Contract termination date inside the period of contract No:'
 
insert into [StrSource] 
([Ar],[En])
select  '    ','Contract received date for registration'
 
insert into [StrSource] 
([Ar],[En])
select  '    ','Contract received date from registration'
 
insert into [StrSource] 
([Ar],[En])
select  '    ','Registered contract delivery date to customer'
 
insert into [StrSource] 
([Ar],[En])
select  '   ','Contract delivery date to customer'
 
insert into [StrSource] 
([Ar],[En])
select  '  ','Collapse lines Entries'
 
insert into [StrSource] 
([Ar],[En])
select  '  ','Checking quantity balance'
 
insert into [StrSource] 
([Ar],[En])
select  '    ','Modify clearance print date'
 
insert into [StrSource] 
([Ar],[En])
select  '  ','Meaning of return values'
 
insert into [StrSource] 
([Ar],[En])
select  '  ','Active buildings permission'
 
insert into [StrSource] 
([Ar],[En])
select  '    ','Contract received from customer'
 
insert into [StrSource] 
([Ar],[En])
select  '   ','Clearance Printed'
 
insert into [StrSource] 
([Ar],[En])
select  ' ','Customer nationality'
 
insert into [StrSource] 
([Ar],[En])
select  ' ','Fees account'
 
insert into [StrSource] 
([Ar],[En])
select  ' ','Customer account'
 
insert into [StrSource] 
([Ar],[En])
select  '  ','Save picture as'
 
insert into [StrSource] 
([Ar],[En])
select  '   1','Customer information 1'
 
insert into [StrSource] 
([Ar],[En])
select  '   2','Customer information 2'
 
insert into [StrSource] 
([Ar],[En])
select  '   3','Customer information 3'
 
insert into [StrSource] 
([Ar],[En])
select  '   4','Customer information 4'
 
insert into [StrSource] 
([Ar],[En])
select  '   5','Customer information 5'
 
insert into [StrSource] 
([Ar],[En])
select  '   6','Customer information 6'
 
insert into [StrSource] 
([Ar],[En])
select  '   7','Customer information 7'
 
insert into [StrSource] 
([Ar],[En])
select  ' ','General Services'
 
insert into [StrSource] 
([Ar],[En])
select  ' ','Report Option'
 
insert into [StrSource] 
([Ar],[En])
select  ' ','Sending link'
 
insert into [StrSource] 
([Ar],[En])
select  ' 1','Fees 1'
 
insert into [StrSource] 
([Ar],[En])
select  ' 2','Fees 2'
 
insert into [StrSource] 
([Ar],[En])
select  ' 3','Fees 3'
 
insert into [StrSource] 
([Ar],[En])
select  ' 4','Fees 4'
 
insert into [StrSource] 
([Ar],[En])
select  ' 5','Fees 5'
 
insert into [StrSource] 
([Ar],[En])
select  ' ','Fax No'
 
insert into [StrSource] 
([Ar],[En])
select  '','Shawal'
 
insert into [StrSource] 
([Ar],[En])
select  '','Safar'
 
insert into [StrSource] 
([Ar],[En])
select  '  ','Compress backup'
 
insert into [StrSource] 
([Ar],[En])
select  '  ','Clearance print'
 
insert into [StrSource] 
([Ar],[En])
select  '  ','Leased units Number'
 
insert into [StrSource] 
([Ar],[En])
select  '   ','Non-leased units number'
 
insert into [StrSource] 
([Ar],[En])
select  ' ','Not Printed'
 
insert into [StrSource] 
([Ar],[En])
select  '  ','Cash payments value'
 
insert into [StrSource] 
([Ar],[En])
select  '   ','Partial due amounts value'
 
insert into [StrSource] 
([Ar],[En])
select  '  ','for arabic message'
 
insert into [StrSource] 
([Ar],[En])
select  '  ','for english message'
 
insert into [StrSource] 
([Ar],[En])
select  '     ','You have exceeded limit of discount rate'
 
insert into [StrSource] 
([Ar],[En])
select  '[V]  ','[V] Collected amount'
 
insert into [StrSource] 
([Ar],[En])
select  '[M]   ','[M] Cheque card no.'
 
insert into [StrSource] 
([Ar],[En])
select  '[N]   ','[N] Type arabic name'
 
insert into [StrSource] 
([Ar],[En])
select  '[M]   ','[M] Type latin name'
 
insert into [StrSource] 
([Ar],[En])
select  '[F]   ','[F] Building latin name'
 
insert into [StrSource] 
([Ar],[En])
select  '[H]   ','[H] Customer latin name'
 
insert into [StrSource] 
([Ar],[En])
select  '         ','To apply changes you must restart the program
Do you want to restart programs now?'
 
insert into [StrSource] 
([Ar],[En])
select  ' ','Chart of Asset'
 
insert into [StrSource] 
([Ar],[En])
select  '  ','Create sub-group'
 
insert into [StrSource] 
([Ar],[En])
select  ' ','Asset card'
 
insert into [StrSource] 
([Ar],[En])
select  '  ...','Create sub-group...'
 
insert into [StrSource] 
([Ar],[En])
select  ' ','New asset'
 
insert into [StrSource] 
([Ar],[En])
select  '','Suspend'
 
insert into [StrSource] 
([Ar],[En])
select  '','Delayed'
 
insert into [StrSource] 
([Ar],[En])
select  '  ','Out of control'
 
insert into [StrSource] 
([Ar],[En])
select  '         ','Do you want to save the changes of Warning printed column?'
 
insert into [StrSource] 
([Ar],[En])
select  '     ','You should not change the default currency rate'
 
insert into [StrSource] 
([Ar],[En])
select  '    ','Inversed entry from entry No.'
 
insert into [StrSource] 
([Ar],[En])
select  '<  >','<Contract days No>'
 
insert into [StrSource] 
([Ar],[En])
select  '< >','<Customer balance>'
 
insert into [StrSource] 
([Ar],[En])
select  '    ','Do you want to delete selected flats'
 
insert into [StrSource] 
([Ar],[En])
select  '    ','Do you want to add selected flats'
 
insert into [StrSource] 
([Ar],[En])
select  '    ','Do you want to delete selected shops'
 
insert into [StrSource] 
([Ar],[En])
select  '    ','Do you want to add selected shops'
 
insert into [StrSource] 
([Ar],[En])
select  '','Select'
 
insert into [StrSource] 
([Ar],[En])
select  '    ','Select the flats you want to assemble'
 
insert into [StrSource] 
([Ar],[En])
select  '  ','Add selected flats'
 
insert into [StrSource] 
([Ar],[En])
select  '  ','Delete selected shops'
 
insert into [StrSource] 
([Ar],[En])
select  '  ','Add selected shops'
 
insert into [StrSource] 
([Ar],[En])
select  '  ','Group by category'
 
insert into [StrSource] 
([Ar],[En])
select  '     ','Show assets without activity'
 
insert into [StrSource] 
([Ar],[En])
select  '  ','Previous depreciation accumulated'
 
insert into [StrSource] 
([Ar],[En])
select  '      ','Consider assembled units in as leased'
 
insert into [StrSource] 
([Ar],[En])
select  ' !             ','Attention please!
The results of the report is going to be not properly arranged and the balance will be different depending on the options selected in the sorting'
 
insert into [StrSource] 
([Ar],[En])
select  ' ','New filter'
 
insert into [StrSource] 
([Ar],[En])
select  ' ','Remove filter'
 
insert into [StrSource] 
([Ar],[En])
select  '  : ','Cost Center :'
 
insert into [StrSource] 
([Ar],[En])
select  ' /  ','Show / Hide column'
 
insert into [StrSource] 
([Ar],[En])
select  ' ','Variable type'
 
insert into [StrSource] 
([Ar],[En])
select  '','Description'
 
insert into [StrSource] 
([Ar],[En])
select  '','Group'
 
insert into [StrSource] 
([Ar],[En])
select  '    ','Link type with other groups'
 
insert into [StrSource] 
([Ar],[En])
select  '','Condition'
 
insert into [StrSource] 
([Ar],[En])
select  '','Specified'
 
insert into [StrSource] 
([Ar],[En])
select  ' ','Delete condition'
 
insert into [StrSource] 
([Ar],[En])
select  ' ','Add group'
 
insert into [StrSource] 
([Ar],[En])
select  ' ','Add condition'
 
insert into [StrSource] 
([Ar],[En])
select  ' ','Delete filter'
 
insert into [StrSource] 
([Ar],[En])
select  '','Variables'
 
insert into [StrSource] 
([Ar],[En])
select  '','Delete'
 
insert into [StrSource] 
([Ar],[En])
select  '    :','There is a problem in Entry No:'
 
insert into [StrSource] 
([Ar],[En])
select  '','Variable'
 
insert into [StrSource] 
([Ar],[En])
select  '','Value'
 
insert into [StrSource] 
([Ar],[En])
select  '','Filter'
 
insert into [StrSource] 
([Ar],[En])
select  ' ','Apple variables'
 
insert into [StrSource] 
([Ar],[En])
select  '','Variables'
 
insert into [StrSource] 
([Ar],[En])
select  ' ','Inverse entry'
 
insert into [StrSource] 
([Ar],[En])
select  '   ','Send Report by Email'
 
insert into [StrSource] 
([Ar],[En])
select  '','Extension'
 
insert into [StrSource] 
([Ar],[En])
select  ' ','Include fonts'
 
insert into [StrSource] 
([Ar],[En])
select  '  ','General ledger entry'
 
insert into [StrSource] 
([Ar],[En])
select  '          ','Use bank account as default account of cheque return if it is collected'
 
insert into [StrSource] 
([Ar],[En])
select  '             ','We strongly recommended to backup your data before you start this process
Do you want to make backup now?'
 
insert into [StrSource] 
([Ar],[En])
select  '           ?','Regenerate entries will start now, this process may take a long time, do you continue?'
 
insert into [StrSource] 
([Ar],[En])
select  '        ','We strongly recommended to backup your data before you start this process'
 
insert into [StrSource] 
([Ar],[En])
select  '     ','Do you want to make backup now?'
 
insert into [StrSource] 
([Ar],[En])
select  '     ','This process may take a long time'
 
insert into [StrSource] 
([Ar],[En])
select  '  ','Empty days value'
 
insert into [StrSource] 
([Ar],[En])
select  '  ','Electricity bills report'
 
insert into [StrSource] 
([Ar],[En])
select  '  ... ','Loading libraries...Favorite accounts'
 
insert into [StrSource] 
([Ar],[En])
select  '  ','Electricity consumption amount'
 
insert into [StrSource] 
([Ar],[En])
select  '  ','Electricity consumption value'
 
insert into [StrSource] 
([Ar],[En])
select  ' ','Water value'
 
insert into [StrSource] 
([Ar],[En])
select  '  ','Sewerage value'
 
insert into [StrSource] 
([Ar],[En])
select  ' ','View bill'
 
insert into [StrSource] 
([Ar],[En])
select  ' ','View contract'
 
insert into [StrSource] 
([Ar],[En])
select  '   ','Renumbering customer cards'
 
insert into [StrSource] 
([Ar],[En])
select  '    ','Renumbering electricity bills type'
 
insert into [StrSource] 
([Ar],[En])
select  ' ','Cheque value'
 
insert into [StrSource] 
([Ar],[En])
select  ' ','Collected amount'
 
insert into [StrSource] 
([Ar],[En])
select  '  ','Show balanced bills'
 
insert into [StrSource] 
([Ar],[En])
select  ' ','Electricity consumption'
 
insert into [StrSource] 
([Ar],[En])
select  ' ','Return termination'
 
insert into [StrSource] 
([Ar],[En])
select  '    ','Smaller than contract end date'
 
insert into [StrSource] 
([Ar],[En])
select  '    ','Bigger than contract end date'
 
insert into [StrSource] 
([Ar],[En])
select  '   ','Equal the contract end date'
 
insert into [StrSource] 
([Ar],[En])
select  '    ','Excluding returned cheque with reason'
 
insert into [StrSource] 
([Ar],[En])
select  '       ','Allow save contract starting after end duration date'
 
insert into [StrSource] 
([Ar],[En])
select  ' ','Lessor card'
 
insert into [StrSource] 
([Ar],[En])
select  '   ','Except return reason'
 
insert into [StrSource] 
([Ar],[En])
select  ' ','Default account'
 
insert into [StrSource] 
([Ar],[En])
select  '[T]  ','[T] Issue date'
 
insert into [StrSource] 
([Ar],[En])
select  '[O]  ','[O] Operation date'
 
insert into [StrSource] 
([Ar],[En])
select  '','Filter'
 
insert into [StrSource] 
([Ar],[En])
select  '  ','Value from field'
 
insert into [StrSource] 
([Ar],[En])
select  '  ','Close file to date'
 
insert into [StrSource] 
([Ar],[En])
select  '        ','Move terminated contracts that has uncollected cheques'
 
insert into [StrSource] 
([Ar],[En])
select  ' ','Cash account'
 
insert into [StrSource] 
([Ar],[En])
select  '   ','Show building in reports'
 
insert into [StrSource] 
([Ar],[En])
select  '  ','Delete previous data'
 
insert into [StrSource] 
([Ar],[En])
select  '  ','Save entry lines'
 
insert into [StrSource] 
([Ar],[En])
select  '','Field'
 
insert into [StrSource] 
([Ar],[En])
select  '       ','Contract start date is bigger than End date period'
 
insert into [StrSource] 
([Ar],[En])
select  ' ','Print log'
 
insert into [StrSource] 
([Ar],[En])
select  '  ','Enter cash account'
 
insert into [StrSource] 
([Ar],[En])
select  '  ','Enter cheque account'
 
insert into [StrSource] 
([Ar],[En])
select  '','Petty cash'
 
insert into [StrSource] 
([Ar],[En])
select  '    ','Modify contracts using default options'
 
insert into [StrSource] 
([Ar],[En])
select  '    ','ReGenerate entries for contracts'
 
insert into [StrSource] 
([Ar],[En])
select  '     ','Modify parking contracts using default options'
 
insert into [StrSource] 
([Ar],[En])
select  '     ','ReGenerate entries for parking contracts'
 
insert into [StrSource] 
([Ar],[En])
select  '     ','Modify land contracts using default options'
 
insert into [StrSource] 
([Ar],[En])
select  '     ','ReGenerate entries for land contracts'
 
insert into [StrSource] 
([Ar],[En])
select  '   ','Lawsuit on unit'
 
insert into [StrSource] 
([Ar],[En])
select  '   ','Lawsuit on contract'
 
insert into [StrSource] 
([Ar],[En])
select  '  ','Customer Email'
 
insert into [StrSource] 
([Ar],[En])
select  '','Owner'
 
insert into [StrSource] 
([Ar],[En])
select  '','Tenant'
 
insert into [StrSource] 
([Ar],[En])
select  '','Vendor'
 
insert into [StrSource] 
([Ar],[En])
select  '','Buyer'
 
insert into [StrSource] 
([Ar],[En])
select  ' ','Potential customer'
 
insert into [StrSource] 
([Ar],[En])
select  '=%','=%'
 
insert into [StrSource] 
([Ar],[En])
select  '0000','0000'
 
insert into [StrSource] 
([Ar],[En])
select  '  ','Contract receipts No.'
 
insert into [StrSource] 
([Ar],[En])
select  '','Details'
 
insert into [StrSource] 
([Ar],[En])
select  ' ','Land activity'
 
insert into [StrSource] 
([Ar],[En])
select  ' ','Flat activity'
 
insert into [StrSource] 
([Ar],[En])
select  ' ','Property activity'
 
insert into [StrSource] 
([Ar],[En])
select  '  ','Daily working report'
 
insert into [StrSource] 
([Ar],[En])
select  ' ','Villa activity'
 
insert into [StrSource] 
([Ar],[En])
select  ' ','Shop activity'
 
insert into [StrSource] 
([Ar],[En])
select  ' ','Parking activity'
 
insert into [StrSource] 
([Ar],[En])
select  ' ','Flat activity'
 
insert into [StrSource] 
([Ar],[En])
select  ' ','Property activity'
 
insert into [StrSource] 
([Ar],[En])
select  ' ','Material activity'
 
insert into [StrSource] 
([Ar],[En])
select  '  ','Revaluation account'
 
insert into [StrSource] 
([Ar],[En])
select  '  ','Capital profit account'
 
insert into [StrSource] 
([Ar],[En])
select  ' ','Output account'
 
insert into [StrSource] 
([Ar],[En])
select  ' ','Input account'
 
insert into [StrSource] 
([Ar],[En])
select  ' ','Asset account'
 
insert into [StrSource] 
([Ar],[En])
select  ' ','Closing account'
 
insert into [StrSource] 
([Ar],[En])
select  ' ','Depreciation account'
 
insert into [StrSource] 
([Ar],[En])
select  '   ','Depreciation account to date'
 
insert into [StrSource] 
([Ar],[En])
select  ' ','Revenue A/C'
 
insert into [StrSource] 
([Ar],[En])
select  ' ','Building A/C'
 
insert into [StrSource] 
([Ar],[En])
select  '  ','Land bank account'
 
insert into [StrSource] 
([Ar],[En])
select  '  ','Building bank A/C'
 
insert into [StrSource] 
([Ar],[En])
select  '  ','Villa bank A/C'
 
insert into [StrSource] 
([Ar],[En])
select  '  ','Bank account closed'
 
insert into [StrSource] 
([Ar],[En])
select  ' ','Deposit A/C'
 
insert into [StrSource] 
([Ar],[En])
select  ' ','Deposit A/C'
 
insert into [StrSource] 
([Ar],[En])
select  ' ','Discount A/C'
 
insert into [StrSource] 
([Ar],[En])
select  '  ','Down payment A/C'
 
insert into [StrSource] 
([Ar],[En])
select  ' ','Commission account'
 
insert into [StrSource] 
([Ar],[En])
select  '   ','Commission from client A/C'
 
insert into [StrSource] 
([Ar],[En])
select  '    ','Commission from owner A/C'
 
insert into [StrSource] 
([Ar],[En])
select  ' ','Customer A/C'
 
insert into [StrSource] 
([Ar],[En])
select  ' ','Villa account'
 
insert into [StrSource] 
([Ar],[En])
select  ' ','Owner account'
 
insert into [StrSource] 
([Ar],[En])
select  '  ','Calculate due amount'
 
insert into [StrSource] 
([Ar],[En])
select  ' ','Project account'
 
insert into [StrSource] 
([Ar],[En])
select  ' ','Expense account'
 
insert into [StrSource] 
([Ar],[En])
select  ' ','Supplier account'
 
insert into [StrSource] 
([Ar],[En])
select  ' ','Calculate results'
 
insert into [StrSource] 
([Ar],[En])
select  '  ','Fees revenue account'
 
insert into [StrSource] 
([Ar],[En])
select  '  ','Fines revenue account'
 
insert into [StrSource] 
([Ar],[En])
select  '   ','Delay fines revenue A/C'
 
insert into [StrSource] 
([Ar],[En])
select  '  ','Fees revenue account'
 
insert into [StrSource] 
([Ar],[En])
select  '   ','Contract registration revenue A/C'
 
insert into [StrSource] 
([Ar],[En])
select  '   ','Contract price revenue A/C'
 
insert into [StrSource] 
([Ar],[En])
select  ' ','Automatic calculate'
 
insert into [StrSource] 
([Ar],[En])
select  '  ','Capital lost account'
 
insert into [StrSource] 
([Ar],[En])
select  '  ','Depreciation accumulated account'
 
insert into [StrSource] 
([Ar],[En])
select  '','Accounts'
 
insert into [StrSource] 
([Ar],[En])
select  ' ','Default accounts'
 
insert into [StrSource] 
([Ar],[En])
select  ' ','Building account'
 
insert into [StrSource] 
([Ar],[En])
select  ' ','by'
 
insert into [StrSource] 
([Ar],[En])
select  ' ','By date'
 
insert into [StrSource] 
([Ar],[En])
select  ' ','By plan'
 
insert into [StrSource] 
([Ar],[En])
select  '  ','By days number'
 
insert into [StrSource] 
([Ar],[En])
select  '  ','Discount on'
 
insert into [StrSource] 
([Ar],[En])
select  ' ','Block card'
 
insert into [StrSource] 
([Ar],[En])
select  '','Save'
 
insert into [StrSource] 
([Ar],[En])
select  ' XML','Save as XML'
 
insert into [StrSource] 
([Ar],[En])
select  ' ','Save settings'
 
insert into [StrSource] 
([Ar],[En])
select  ' ','Save checked'
 
insert into [StrSource] 
([Ar],[En])
select  ' ','Save all'
 
insert into [StrSource] 
([Ar],[En])
select  '','Telephones'
 
insert into [StrSource] 
([Ar],[En])
select  '','and'
 
insert into [StrSource] 
([Ar],[En])
select  ' ','Until'
 
insert into [StrSource] 
([Ar],[En])
select  '','Units'
 
insert into [StrSource] 
([Ar],[En])
select  ' ','Production units'
 
insert into [StrSource] 
([Ar],[En])
select  ' ','Problem description'
 
insert into [StrSource] 
([Ar],[En])
select  '','Descriptions'
 
insert into [StrSource] 
([Ar],[En])
select  '','Until'
 
insert into [StrSource] 
([Ar],[En])
select  '     ','and you will not be able to retrieve current data'
 
insert into [StrSource] 
([Ar],[En])
select  '   :','These flats are:'
 
insert into [StrSource] 
([Ar],[En])
select  '   :','These shops are:'
 
insert into [StrSource] 
([Ar],[En])
select  '       ','This is a collective shop'
 
insert into [StrSource] 
([Ar],[En])
select  '   ','Connection must first set up'
 
insert into [StrSource] 
([Ar],[En])
select  '  ','Files must be updated'
 
insert into [StrSource] 
([Ar],[En])
select  '             ','Opening entries number which will be excluded must be specified for correct information in the report'
 
insert into [StrSource] 
([Ar],[En])
select  '     ,     ','Chart must be refreshed, Do you want to do it?'
 
insert into [StrSource] 
([Ar],[En])
select  '','Contain'
 
insert into [StrSource] 
([Ar],[En])
select  '  ','Please enter the amount'
 
insert into [StrSource] 
([Ar],[En])
select  '           ','Please note that the flats did not specify with area, the cost will not change'
 
insert into [StrSource] 
([Ar],[En])
select  '','Equal'
 
insert into [StrSource] 
([Ar],[En])
select  '  ','Payment within'
 
insert into [StrSource] 
([Ar],[En])
select  '  ','This user has all permissions'
 
insert into [StrSource] 
([Ar],[En])
select  ' ','There is lawsuit'
 
insert into [StrSource] 
([Ar],[En])
select  ' ','Payment available'
 
insert into [StrSource] 
([Ar],[En])
select  '  ','Interior stairs'
 
insert into [StrSource] 
([Ar],[En])
select  '        ','There is existing contract for same customer and property'
 
insert into [StrSource] 
([Ar],[En])
select  '    ','There is parking contract for same customer'
 
insert into [StrSource] 
([Ar],[En])
select  '      ','There is another cost center has same code'
 
insert into [StrSource] 
([Ar],[En])
select  '    ','There is another User has same name'
 
insert into [StrSource] 
([Ar],[En])
select  '  ','Safety system available'
 
insert into [StrSource] 
([Ar],[En])
select  ' ','Generate entry'
 
insert into [StrSource] 
([Ar],[En])
select  '   ','Generate entry automatically'
 
insert into [StrSource] 
([Ar],[En])
select  '','Day'
 
insert into [StrSource] 
([Ar],[En])
select  ' ','Daily entries report'
 
insert into [StrSource] 
([Ar],[En])
select  '[A]  ','[A] Building Name'
 
insert into [StrSource] 
([Ar],[En])
select  '[B]  ','[B] Unit No'
 
insert into [StrSource] 
([Ar],[En])
select  '[C] ','[C] Customer name'
 
insert into [StrSource] 
([Ar],[En])
select  '[D] ','[D] Contract No'
 
insert into [StrSource] 
([Ar],[En])
select  '[E]  ','[E] Contract serial No'
 
insert into [StrSource] 
([Ar],[En])
select  '[N]   ','[N] Cheque Serial No'
 
insert into [StrSource] 
([Ar],[En])
select  '[N]   ','[N] Contract Serial No'
 
insert into [StrSource] 
([Ar],[En])
select  '[P]   ','[P] Due End Date'
 
insert into [StrSource] 
([Ar],[En])
select  ' ','Total bill'
 
insert into [StrSource] 
([Ar],[En])
select  '  ','Total amount due'
 
insert into [StrSource] 
([Ar],[En])
select  '    ','Sned SMS on partial collection'
 
insert into [StrSource] 
([Ar],[En])
select  '   ','View log window with editing'
 
insert into [StrSource] 
([Ar],[En])
select  ' ','Computer name'
 
insert into [StrSource] 
([Ar],[En])
select  '  ','Fields printing name'
 
insert into [StrSource] 
([Ar],[En])
select  '  ','Scanning settings'
 
insert into [StrSource] 
([Ar],[En])
select  '  ','Received Orders Types'
 
insert into [StrSource] 
([Ar],[En])
select  '  ','Received Orders Types'
 
insert into [StrSource] 
([Ar],[En])
select  ' ','Lawsuit terminate'
 
insert into [StrSource] 
([Ar],[En])
select  '  ','Lawsuite termination'
 
insert into [StrSource] 
([Ar],[En])
select  ' ','Received orders'
 
insert into [StrSource] 
([Ar],[En])
select  ' ','Attorney fees'
 
insert into [StrSource] 
([Ar],[En])
select  ' SMS','Send SMS'
 
insert into [StrSource] 
([Ar],[En])
select  '  ','Use device software'
 
insert into [StrSource] 
([Ar],[En])
select  '  ','Fields printing name'
 
insert into [StrSource] 
([Ar],[En])
select  '      ','Use customer account as default lawsuit account'
 
insert into [StrSource] 
([Ar],[En])
select  ' ','Save note'
 
insert into [StrSource] 
([Ar],[En])
select  ' ','Temporary save'
 
insert into [StrSource] 
([Ar],[En])
select  ' ','About program'
 
insert into [StrSource] 
([Ar],[En])
select  '','Private'
 
insert into [StrSource] 
([Ar],[En])
select  '  ','Specified for current user'
 
insert into [StrSource] 
([Ar],[En])
select  '','Vacant'
 
insert into [StrSource] 
([Ar],[En])
select  '','Closing'
 
insert into [StrSource] 
([Ar],[En])
select  '','Services'
 
insert into [StrSource] 
([Ar],[En])
select  '','Exit'
 
insert into [StrSource] 
([Ar],[En])
select  ' ','Detailed map'
 
insert into [StrSource] 
([Ar],[En])
select  '','Discount'
 
insert into [StrSource] 
([Ar],[En])
select  ' ','Discount commission'
 
insert into [StrSource] 
([Ar],[En])
select  ' ','Permission error'
 
insert into [StrSource] 
([Ar],[En])
select  '   ','Error in the file name'
 
insert into [StrSource] 
([Ar],[En])
select  '   ','An error in settings file'
 
insert into [StrSource] 
([Ar],[En])
select  '     ','Generate journal entry at contract expiry option'
 
insert into [StrSource] 
([Ar],[En])
select  '','Options'
 
insert into [StrSource] 
([Ar],[En])
select  ' ','General options'
 
insert into [StrSource] 
([Ar],[En])
select  '','Credit'
 
insert into [StrSource] 
([Ar],[En])
select  '','Enter'
 
insert into [StrSource] 
([Ar],[En])
select  ' ','Security level'
 
insert into [StrSource] 
([Ar],[En])
select  ' ','Lawsuit'
 
insert into [StrSource] 
([Ar],[En])
select  ' ','Lawsuit'
 
insert into [StrSource] 
([Ar],[En])
select  '   ','Cost center general ledger'
 
insert into [StrSource] 
([Ar],[En])
select  ' ','General ledger'
 
insert into [StrSource] 
([Ar],[En])
select  '  ','General ledger'
 
insert into [StrSource] 
([Ar],[En])
select  '    ','Cost center general ledger'
 
insert into [StrSource] 
([Ar],[En])
select  '   ','Cost center general ledger'
 
insert into [StrSource] 
([Ar],[En])
select  ' ','General Ledger'
 
insert into [StrSource] 
([Ar],[En])
select  ' ','General Ledger'
 
insert into [StrSource] 
([Ar],[En])
select  ' ','Journal Ledger'
 
insert into [StrSource] 
([Ar],[En])
select  ' ','Color list'
 
insert into [StrSource] 
([Ar],[En])
select  ' ','Chart of Accounts'
 
insert into [StrSource] 
([Ar],[En])
select  ' ','Chart of Branches'
 
insert into [StrSource] 
([Ar],[En])
select  ' ','Chart of Stores'
 
insert into [StrSource] 
([Ar],[En])
select  ' ','Chart of Materials'
 
insert into [StrSource] 
([Ar],[En])
select  '','Supplier'
 
insert into [StrSource] 
([Ar],[En])
select  ' ','Other location'
 
insert into [StrSource] 
([Ar],[En])
select  '','Parking'
 
insert into [StrSource] 
([Ar],[En])
select  ' ','Car parking'
 
insert into [StrSource] 
([Ar],[En])
select  ' ','Trial Balance'
 
insert into [StrSource] 
([Ar],[En])
select  '  ','Annual Trail Balance'
 
insert into [StrSource] 
([Ar],[En])
select  '   ','Cost center trail balance'
 
insert into [StrSource] 
([Ar],[En])
select  '  ','Accounts balance window'
 
insert into [StrSource] 
([Ar],[En])
select  ' ','Log file'
 
insert into [StrSource] 
([Ar],[En])
select  '  - ','Log File - '
 
insert into [StrSource] 
([Ar],[En])
select  ' ','Alerts window'
 
insert into [StrSource] 
([Ar],[En])
select  ' ','Pictures window'
 
insert into [StrSource] 
([Ar],[En])
select  '   SMS','SMS sent result'
 
insert into [StrSource] 
([Ar],[En])
select  ' ','Extra rate'
 
insert into [StrSource] 
([Ar],[En])
select  '   ','Depreciation annual percentage'
 
insert into [StrSource] 
([Ar],[En])
select  ' ','Discount rate'
 
insert into [StrSource] 
([Ar],[En])
select  '  ','Maximum discount rate'
 
insert into [StrSource] 
([Ar],[En])
select  ' ','Commission rate'
 
insert into [StrSource] 
([Ar],[En])
select  '','Copy'
 
insert into [StrSource] 
([Ar],[En])
select  ' ','Backup'
 
insert into [StrSource] 
([Ar],[En])
select  ' ','Copy table'
 
insert into [StrSource] 
([Ar],[En])
select  ' ','Copy all'
 
insert into [StrSource] 
([Ar],[En])
select  '      ','Database version is latest than the program version'
 
insert into [StrSource] 
([Ar],[En])
select  '','Publish'
 
insert into [StrSource] 
([Ar],[En])
select  ' ','Publish permissions'
 
insert into [StrSource] 
([Ar],[En])
select  '  ','Publish user permissions'
 
insert into [StrSource] 
([Ar],[En])
select  '  ','Bulletin currency prices'
 
insert into [StrSource] 
([Ar],[En])
select  ' ','Message text'
 
insert into [StrSource] 
([Ar],[En])
select  '  ','SMS Arabic text'
 
insert into [StrSource] 
([Ar],[En])
select  '  ','SMS Latin text'
 
insert into [StrSource] 
([Ar],[En])
select  ' ','Safety system'
 
insert into [StrSource] 
([Ar],[En])
select  '','Yes'
 
insert into [StrSource] 
([Ar],[En])
select  '','Cash'
 
insert into [StrSource] 
([Ar],[En])
select  '','Transfar'
 
insert into [StrSource] 
([Ar],[En])
select  ' ','Move cards'
 
insert into [StrSource] 
([Ar],[En])
select  '   ','Transfer cards between types'
 
insert into [StrSource] 
([Ar],[En])
select  '   ','Transfer cards between accounts'
 
insert into [StrSource] 
([Ar],[En])
select  '  ','Transfer activity of accounts'
 
insert into [StrSource] 
([Ar],[En])
select  '    ','Are you sure to change cost center?'
 
insert into [StrSource] 
([Ar],[En])
select  '','Paste'
 
insert into [StrSource] 
([Ar],[En])
select  ' ','Paste table'
 
insert into [StrSource] 
([Ar],[En])
select  ' ','Paste all'
 
insert into [StrSource] 
([Ar],[En])
select  '','Print'
 
insert into [StrSource] 
([Ar],[En])
select  '      ','Failed to generate the entries of due cash amount'
 
insert into [StrSource] 
([Ar],[En])
select  '    ','Failed to generate deposit entries'
 
insert into [StrSource] 
([Ar],[En])
select  '  ','Maintenance not finish'
 
insert into [StrSource] 
([Ar],[En])
select  '       ','Generating entries process for duo amount does not succeed'
 
insert into [StrSource] 
([Ar],[En])
select  ' ','Process not finish'
 
insert into [StrSource] 
([Ar],[En])
select  '       ','No backup copy has been taken yet'
 
insert into [StrSource] 
([Ar],[En])
select  '  ','Contract not terminated'
 
insert into [StrSource] 
([Ar],[En])
select  '  ','Not deposit'
 
insert into [StrSource] 
([Ar],[En])
select  '                ','Opening entry number which will be excluded does not specified ,the report may contain wrong information'
 
insert into [StrSource] 
([Ar],[En])
select  '     ','All alerts doesnt show'
 
insert into [StrSource] 
([Ar],[En])
select  '   ','Failed to generate journal entry'
 
insert into [StrSource] 
([Ar],[En])
select  '    ','Generating deposit entries process does not succeed'
 
insert into [StrSource] 
([Ar],[En])
select  '     ','You can not undo this operation'
 
insert into [StrSource] 
([Ar],[En])
select  '        ','You can not undo this operation
Are you sure?'
 
insert into [StrSource] 
([Ar],[En])
select  ' ','Same customer'
 
insert into [StrSource] 
([Ar],[En])
select  '   ','Transfar all account activity'
 
insert into [StrSource] 
([Ar],[En])
select  '      ','Default note type in generating contract installments'
 
insert into [StrSource] 
([Ar],[En])
select  ' ','Map type'
 
insert into [StrSource] 
([Ar],[En])
select  ' ','Cheque type'
 
insert into [StrSource] 
([Ar],[En])
select  '     ','Default note type in generating cheques'
 
insert into [StrSource] 
([Ar],[En])
select  ' ','Contract expiry date'
 
insert into [StrSource] 
([Ar],[En])
select  ' ','Stock transfers type'
 
insert into [StrSource] 
([Ar],[En])
select  ' ','Material account'
 
insert into [StrSource] 
([Ar],[En])
select  '  ','Generate journal entry automatically'
 
insert into [StrSource] 
([Ar],[En])
select  '','Pricing'
 
insert into [StrSource] 
([Ar],[En])
select  '','or'
 
insert into [StrSource] 
([Ar],[En])
select  '  ','Customer last price'
 
insert into [StrSource] 
([Ar],[En])
select  '   ','Effect materials pricing'
 
insert into [StrSource] 
([Ar],[En])
select  ' ','Default store'
 
insert into [StrSource] 
([Ar],[En])
select  ' ','To store'
 
insert into [StrSource] 
([Ar],[En])
select  '  ','To cost center'
 
insert into [StrSource] 
([Ar],[En])
select  ' ','Bill type'
 
insert into [StrSource] 
([Ar],[En])
select  '  ','To cost center'
 
insert into [StrSource] 
([Ar],[En])
select  ' ','From store'
 
insert into [StrSource] 
([Ar],[En])
select  '  ','Table line color'
 
insert into [StrSource] 
([Ar],[En])
select  ' ','Bill fields'
 
insert into [StrSource] 
([Ar],[En])
select  ' ','Cash account'
 
insert into [StrSource] 
([Ar],[En])
select  ' ','Discount material'
 
insert into [StrSource] 
([Ar],[En])
select  ' ','Extra account'
 
insert into [StrSource] 
([Ar],[En])
select  '   ','Post to store automatically'
 
insert into [StrSource] 
([Ar],[En])
select  '  ','Post to store'

insert into [StrSource] 
([Ar],[En])
select  '  ','Add new reconciliation'

insert into [StrSource] 
([Ar],[En])
select  '  ','Show actual balance'

insert into [StrSource] 
([Ar],[En])
select  ' ','Actual balance'

insert into [StrSource] 
([Ar],[En])
select  '  ','Delete selected reconciliation'

insert into [StrSource] 
([Ar],[En])
select  ' ','New reconciliation'

insert into [StrSource] 
([Ar],[En])
select  ' ','Account reconciliation'

insert into [StrSource] 
([Ar],[En])
select  '  ','From last reconciliation'

insert into [StrSource] 
([Ar],[En])
select  ' ','Reconciliation balance'

insert into [StrSource] 
([Ar],[En])
select  '','Log file'

insert into [StrSource] 
([Ar],[En])
select  ' ','Not posted'

insert into [StrSource] 
([Ar],[En])
select  '','Replace'

insert into [StrSource] 
([Ar],[En])
select  '','Banks'

insert into [StrSource] 
([Ar],[En])
select  '','New'

insert into [StrSource] 
([Ar],[En])
select  ' ','Latin nationality'

insert into [StrSource] 
([Ar],[En])
select  '','Old'

insert into [StrSource] 
([Ar],[En])
select  '  ','List default data'

insert into [StrSource] 
([Ar],[En])
select  '     ','Old value will be replaced by the New value'

insert into [StrSource] 
([Ar],[En])
select  '       ','Old value will be replaced by the New value, Do you want to continue?'

insert into [StrSource] 
([Ar],[En])
select  '     ','Do you want to delete the old value?'

insert into [StrSource] 
([Ar],[En])
select  '  ','Do you want to continue?'

insert into [StrSource] 
([Ar],[En])
select  '  :','Replaced data :'

insert into [StrSource] 
([Ar],[En])
select  '[Q]  ','[Q] Problem description'

insert into [StrSource] 
([Ar],[En])
select  '[P]    ','[P] Arabic building name'

insert into [StrSource] 
([Ar],[En])
select  '[O]    ','[O] Latin building name'

insert into [StrSource] 
([Ar],[En])
select  '[N]   ','[N] Flat No.'

insert into [StrSource] 
([Ar],[En])
select  '[M]   ','[M] Latin worker name'

insert into [StrSource] 
([Ar],[En])
select  '[L]   ','[L] Arabic worker name'

insert into [StrSource] 
([Ar],[En])
select  '    SMS','Send SMS to worker'

insert into [StrSource] 
([Ar],[En])
select  ' ','Maintenance orders'

insert into [StrSource] 
([Ar],[En])
select  '  ','Worker maintenance order'

insert into [StrSource] 
([Ar],[En])
select  '[R]  ','[R] Customer mobile'

insert into [StrSource] 
([Ar],[En])
select  '','Transaction'

insert into [StrSource] 
([Ar],[En])
select  '   ','Cost centers cross report'

insert into [StrSource] 
([Ar],[En])
select  ' ','Net loss'

insert into [StrSource] 
([Ar],[En])
select  '','Finish'

insert into [StrSource] 
([Ar],[En])
select  ' ','Gross profit'

insert into [StrSource] 
([Ar],[En])
select  ' ','Commission expense'

insert into [StrSource] 
([Ar],[En])
select  '  ','Log print folder'

insert into [StrSource] 
([Ar],[En])
select  '  ','Salesman commission value'

insert into [StrSource] 
([Ar],[En])
select  '  ','Commission expense account'

insert into [StrSource] 
([Ar],[En])
select  '  ','Salesman commission account'

insert into [StrSource] 
([Ar],[En])
select  '  ','Property delivery date'

insert into [StrSource] 
([Ar],[En])
select  '  ','Customer Email'

insert into [StrSource] 
([Ar],[En])
select  ' ','New tab'

insert into [StrSource] 
([Ar],[En])
select  '  ','Collecting card files'

insert into [StrSource] 
([Ar],[En])
select  '          :','Select the folder that will transfer all card files to it:'

insert into [StrSource] 
([Ar],[En])
select  '       ','Select the files that you want transfer it to selected folder'

insert into [StrSource] 
([Ar],[En])
select  '','File'

insert into [StrSource] 
([Ar],[En])
select  ' ','Returns fines'

insert into [StrSource] 
([Ar],[En])
select  '   ','Collected checques of revenue period'

insert into [StrSource] 
([Ar],[En])
select  '   ','Cash payments of revenue period'

insert into [StrSource] 
([Ar],[En])
select  '      ','Enter property owner name in property card'

insert into [StrSource] 
([Ar],[En])
select  '   ','Remove selected file'

insert into [StrSource] 
([Ar],[En])
select  ' ','Attach files'

insert into [StrSource] 
([Ar],[En])
select  '  ','Units total number'

insert into [StrSource] 
([Ar],[En])
select  '  ','Rename tab'

insert into [StrSource] 
([Ar],[En])
select  '  ','File already exists'

insert into [StrSource] 
([Ar],[En])
select  '     ','Be sure to enter the code numbers only'

insert into [StrSource] 
([Ar],[En])
select  '     ','Make sure of the new path specified'

insert into [StrSource] 
([Ar],[En])
select  ' ','Assembling files'

insert into [StrSource] 
([Ar],[En])
select  '      ,     ','Salesman name has been modified, do you want to modify the account name?'

insert into [StrSource] 
([Ar],[En])
select  '','Stop'

insert into [StrSource] 
([Ar],[En])
select  '       ','Selected files will be transferred to the specified folder'

insert into [StrSource] 
([Ar],[En])
select  '','closed'

insert into [StrSource] 
([Ar],[En])
select  ' ','Already added'

insert into [StrSource] 
([Ar],[En])
select  '     ','Do you want to delete selected reconciliation?'

insert into [StrSource]

([Ar],[En])

select  ' : ','Property:'

insert into [StrSource]

([Ar],[En])

select  ' ','Residual value'

insert into [StrSource]

([Ar],[En])

select  ' ','Report description'

insert into [StrSource]

([Ar],[En])

select  ' ','UnChecked'

insert into [StrSource]

([Ar],[En])

select  '','Operations'

insert into [StrSource]

([Ar],[En])

select  '      ','Selected checks will be added
Do you want to continue?'

insert into [StrSource]

([Ar],[En])

select  ' ','Property deed'

insert into [StrSource]

([Ar],[En])

select  ' ','UnPost'

insert into [StrSource]

([Ar],[En])

select  ' / ','Assembled / Detailed'

insert into [StrSource]

([Ar],[En])

select  ' ','Assemble accounts'

insert into [StrSource]

([Ar],[En])

select  ' ','UnPost'

insert into [StrSource]

([Ar],[En])

select  '   ','Selected entries will be posted'

insert into [StrSource]

([Ar],[En])

select  '     ','Selected entries will be UnPosted'

insert into [StrSource]

([Ar],[En])

select  '    : ','Last modification by User:'

insert into [StrSource]

([Ar],[En])

select  ' : ','Last modification:'

insert into [StrSource]

([Ar],[En])

select  ': ','Created'

insert into [StrSource]

([Ar],[En])

select  ': ','Date:'

insert into [StrSource]

([Ar],[En])

select  '    : ','Created by User'

insert into [StrSource]

([Ar],[En])

select  '    ','Transfar all job cost activity'

insert into [StrSource]

([Ar],[En])

select  '    ','Transfer activities between job costs'

insert into [StrSource]

([Ar],[En])

select  ' ','Origin name'

insert into [StrSource]

([Ar],[En])

select  '  ','Material Latin name'

insert into [StrSource]

([Ar],[En])

select  '   ','Show last bills only'

insert into [StrSource]

([Ar],[En])

select  ' ','Latin address'

insert into [StrSource]

([Ar],[En])

select  ' 1','Quantity 1'

insert into [StrSource]

([Ar],[En])

select  '','Email'

insert into [StrSource]

([Ar],[En])

select  ' ','Post bill'

insert into [StrSource]

([Ar],[En])

select  ' ','Customer serial'

insert into [StrSource]

([Ar],[En])

select  ' ','Entries option'

insert into [StrSource]

([Ar],[En])

select  ' ','Bills option'

insert into [StrSource]

([Ar],[En])

select  ' ','Origin No'

insert into [StrSource]

([Ar],[En])

select  '  ','Customer card No'

insert into [StrSource]

([Ar],[En])

select  '  ','Customer ID No'

insert into [StrSource]

([Ar],[En])

select  '    ','Cusomter bank account No'

insert into [StrSource]

([Ar],[En])

select  ' ','Material group'

insert into [StrSource]

([Ar],[En])

select  '  ','Bill payment type'

insert into [StrSource]

([Ar],[En])

select  '','Gifts'

insert into [StrSource]

([Ar],[En])

select  ' ','Net profit'

insert into [StrSource]

([Ar],[En])

select  ' ','Create journal entry'

insert into [StrSource]

([Ar],[En])

select  '   ','Execute the last command'

insert into [StrSource]

([Ar],[En])

select  '','Percentage'

insert into [StrSource]

([Ar],[En])

select  '     ','Make sure the distribution of values properly'

insert into [StrSource]

([Ar],[En])

select  '       ,       ','The linked value with contract is different then the cheque amount, Do you want to redistribute the amount by percentages?'

insert into [StrSource]

([Ar],[En])

select  '   ','Link cheque with contracts'

insert into [StrSource]

([Ar],[En])

select  ' ','Multi-Link'

insert into [StrSource]

([Ar],[En])

select  '       :','All transactions of this cost center will be moved'

insert into [StrSource]

([Ar],[En])

select  '','Multi'

insert into [StrSource]

([Ar],[En])

select  ' ','Commands log'

insert into [StrSource]

([Ar],[En])

select  ' ','Synchronize files'

insert into [StrSource]

([Ar],[En])

select  ' ','Fees value'

insert into [StrSource]

([Ar],[En])

select  '  ','Owners Associations fees'

insert into [StrSource]

([Ar],[En])

select  ' ','Contract payments report'

insert into [StrSource]

([Ar],[En])

select  ' ','Revenue account'

insert into [StrSource]

([Ar],[En])

select  '   ','Owners Associations fees'

insert into [StrSource] 
([Ar],[En])
select  '   ','Cost center belong to credits account'
 
insert into [StrSource] 
([Ar],[En])
select  '   ','Cost center belong to debits account'

insert into [StrSource]

([Ar],[En])

select  ' ','Unit price'

insert into [StrSource]

([Ar],[En])

select  ' ','Return termination'

insert into [StrSource]

([Ar],[En])

select  '[B]  ','[B] Building name'

insert into [StrSource]

([Ar],[En])

select  '[N]  ','[N] Property No'

insert into [StrSource]

([Ar],[En])

select  '[O]  ','[O] Owner name'

insert into [StrSource]

([Ar],[En])

select  '  ','File already exist'

insert into [StrSource]

([Ar],[En])

select  ' ','Without an area'

insert into [StrSource]

([Ar],[En])

select  '  ','Select destination path'

insert into [StrSource]

([Ar],[En])

select  '  ','Select source path'

insert into [StrSource]

([Ar],[En])

select  '      ','Selected files will be copied to the the new path'

insert into [StrSource]

([Ar],[En])

select  ' ','No journal entry'

insert into [StrSource]

([Ar],[En])

select  '             ','Journal entry will not be created for units without owner or area'

insert into [StrSource]

([Ar],[En])

select  '   ','does not has owner account'

insert into [StrSource]

([Ar],[En])

select  '','Modified'

insert into [StrSource]

([Ar],[En])

select  '','Succeed'

insert into [StrSource]

([Ar],[En])

select  '   ','Selected contracts will be terminated'

insert into [StrSource]

([Ar],[En])

select  ' ','Terminated'

insert into [StrSource]

([Ar],[En])

select  '  ','Parking contracts termination'

insert into [StrSource]

([Ar],[En])

select  '   ','lands and villas contracts termination'

insert into [StrSource]

([Ar],[En])

select  ' ','Terminated'

insert into [StrSource]

([Ar],[En])

select  ' ','Enter Building'

insert into [StrSource]

([Ar],[En])

select  '  ','Terminate selected contracts'

insert into [StrSource]

([Ar],[En])

select  '  ','Renew selected contracts'

insert into [StrSource] 
([Ar],[En])
select  '  ','Water consumption value'

insert into [StrSource] 
([Ar],[En])
select  ' ','Water consumption'

insert into [StrSource] 
([Ar],[En])
select  '     ','Generate journal entry on termination automatically'

insert into [StrSource] 
([Ar],[En])
select  '  ','Water calculation method'

insert into [StrSource] 
([Ar],[En])
select  '  ','Electricity calculation method'

insert into [StrSource] 
([Ar],[En])
select  '  ','Electricity current meter'
 
insert into [StrSource] 
([Ar],[En])
select  '  ','Electricity previous meter'

insert into [StrSource] 
([Ar],[En])
select  '  ','Water current meter'
 
insert into [StrSource] 
([Ar],[En])
select  '  ','Water previous meter'

insert into [StrSource] 
([Ar],[En])
select  '  ','Water consumption amount'

insert into [StrSource] 
([Ar],[En])
select  '  ','Water calculation method'

insert into [StrSource] 
([Ar],[En])
select  '  ','Electricity calculation method'

insert into [StrSource] 
([Ar],[En])
select  '   ','Electricity calculation method'

insert into [StrSource] 
([Ar],[En])
select  ' ','New name'

insert into [StrSource] 
([Ar],[En])
select  ' ','Current name'

insert into [StrSource] 
([Ar],[En])
select  '  ','Latin trading license'

insert into [StrSource] 
([Ar],[En])
select  ' ','Latin Adjective'

insert into [StrSource] 
([Ar],[En])
select  ' ','Latin Sponser'

insert into [StrSource] 
([Ar],[En])
select  ' ','Latin Occupation'

insert into [StrSource] 
([Ar],[En])
select  '  ','Latin Sponser data'

insert into [StrSource] 
([Ar],[En])
select  '','Barcode'

insert into [StrSource] 
([Ar],[En])
select  '  ','Modify Customer cards'

insert into [StrSource] 
([Ar],[En])
select  '  1','Field 1'

insert into [StrSource] 
([Ar],[En])
select  '  2','Field 2'

insert into [StrSource] 
([Ar],[En])
select  '  3','Field 3'

insert into [StrSource] 
([Ar],[En])
select  '  4','Field 4'

insert into [StrSource] 
([Ar],[En])
select  '  5','Field 5'

insert into [StrSource] 
([Ar],[En])
select  '  6','Field 6'

insert into [StrSource] 
([Ar],[En])
select  '  7','Field 7'

insert into [StrSource] 
([Ar],[En])
select  ' ','Total area'

insert into [StrSource] 
([Ar],[En])
select  ' ','Termination fines'

insert into [StrSource] 
([Ar],[En])
select  ' ','Fines fees'

insert into [StrSource] 
([Ar],[En])
select  ' ','Without amount'

insert into [StrSource] 
([Ar],[En])
select  ' ','With amount'

insert into [StrSource] 
([Ar],[En])
select  '   ','ID card number duplicate'

insert into [StrSource] 
([Ar],[En])
select  '   ','Create accounts for Customers cards'

insert into [StrSource] 
([Ar],[En])
select  '','Start'

insert into [StrSource] 
([Ar],[En])
select  '   ','Click start to create accounts'

insert into [StrSource] 
([Ar],[En])
select  ' ','Create account'

insert into [StrSource] 
([Ar],[En])
select  '  ','Create deposit account'

insert into [StrSource] 
([Ar],[En])
select  '','Close'

insert into [StrSource] 
([Ar],[En])
select  '      ','Select cards that you want to create accounts'

insert into [StrSource] 
([Ar],[En])
select  '   ','Select main account for customers'

insert into [StrSource] 
([Ar],[En])
select  '  ','Select main account'

insert into [StrSource] 
([Ar],[En])
select  '    ','Select main deposit account for customers'

insert into [StrSource] 
([Ar],[En])
select  '             ','This wizard help you to create accounts for customers that does not have account or deposit account'

insert into [StrSource] 
([Ar],[En])
select  '         ','These cards does not have account or deposit account'

insert into [StrSource] 
([Ar],[En])
select  '   ','Select main account for customers'

insert into [StrSource] 
([Ar],[En])
select  '       ','You dont have permission for this operation Check with your System Administrator'

insert into [StrSource] 
([Ar],[En])
select  '','License'

insert into [StrSource] 
([Ar],[En])
select  '   ','Accounts Balance Chart'

insert into [StrSource] 
([Ar],[En])
select  '   ','Accounts Balance Chart'

insert into [StrSource] 
([Ar],[En])
select  ' ','Credit balance'

insert into [StrSource] 
([Ar],[En])
select  ' ','Debit balance'

insert into [StrSource] 
([Ar],[En])
select  '  ','Purpose of the contract'

insert into [StrSource] 
([Ar],[En])
select  '   ','Purpose of the contract Latin'

insert into [StrSource] 
([Ar],[En])
select  '','Period'

insert into [StrSource] 
([Ar],[En])
select  ' ','Card category'

insert into [StrSource] 
([Ar],[En])
select  ' ','Categories chart'

insert into [StrSource] 
([Ar],[En])
select  '  ','Services contracts report'

insert into [StrSource] 
([Ar],[En])
select  ' ','Latin printing'

insert into [StrSource] 
([Ar],[En])
select  '    ','Card account will not be created'

insert into [StrSource] 
([Ar],[En])
select  '      ','Card account will not be created
do you want to continue?'

insert into [StrSource] 
([Ar],[En])
select  '  ','Contract duration in text'

insert into [StrSource] 
([Ar],[En])
select  '  ','Contract location latin'

insert into [StrSource] 
([Ar],[En])
select  '   / ','Contract type yearly / monthly'

insert into [StrSource] 
([Ar],[En])
select  ' ','Income Statement'

insert into [StrSource] 
([Ar],[En])
select  '  ...','Synchronize files ...'

insert into [StrSource] 
([Ar],[En])
select  '      ...','Activating archive files within the database ...'

insert into [StrSource] 
([Ar],[En])
select  '','Archiving'

insert into [StrSource] 
([Ar],[En])
select  '     ...','Load files from Database ...'

insert into [StrSource] 
([Ar],[En])
select  '','Browse'

insert into [StrSource] 
([Ar],[En])
select  '','Folder'

insert into [StrSource] 
([Ar],[En])
select  ' ','New Path'

insert into [StrSource] 
([Ar],[En])
select  ' ','Old Path'

insert into [StrSource] 
([Ar],[En])
select  '','Analysis'

insert into [StrSource] 
([Ar],[En])
select  '','Download'

insert into [StrSource] 
([Ar],[En])
select  '       ','Download documents from Database to the hard drive'

insert into [StrSource] 
([Ar],[En])
select  '   ...','Change files path ...'

insert into [StrSource] 
([Ar],[En])
select  '  ','Change files path'

insert into [StrSource] 
([Ar],[En])
select  '         ','Photos, files and documents will be loaded from the database'

insert into [StrSource] 
([Ar],[En])
select  '   ','Specific type of files'

insert into [StrSource] 
([Ar],[En])
select  '          ','Deactivate save files, documents and images in the database'

insert into [StrSource] 
([Ar],[En])
select  '    ','Keep documents in the original location'

insert into [StrSource] 
([Ar],[En])
select  '   ','Default path to save documents'

insert into [StrSource] 
([Ar],[En])
select  '     ','Activating archive files in the database'

insert into [StrSource] 
([Ar],[En])
select  '        ','Activating save files, documents and images in the database'

insert into [StrSource] 
([Ar],[En])
select  '       ','Activating save files, documents and images in the database'

insert into [StrSource] 
([Ar],[En])
select  '  ','Activation has been applied'

insert into [StrSource] 
([Ar],[En])
select  '   ','Deactivation has been applied'

insert into [StrSource] 
([Ar],[En])
select  ' ','Linking documents'

insert into [StrSource] 
([Ar],[En])
select  '  ','Changes will be applied'

insert into [StrSource] 
([Ar],[En])
select  '    ','Changes will be applied
Do you want to continue?'

insert into [StrSource] 
([Ar],[En])
select  '            ','All files will be deleted from the database, this operation can not be reversed'

insert into [StrSource] 
([Ar],[En])
select  '        ','All attached documents and images will be deleted from the database'

insert into [StrSource] 
([Ar],[En])
select  '        ','All attached documents and images will be copied to the database'

insert into [StrSource] 
([Ar],[En])
select  '   PDF  ','View PDF files'

insert into [StrSource] 
([Ar],[En])
select  '       ','and be noted that it will still be saved on the hard drive'

insert into [StrSource] 
([Ar],[En])
select  '           ','From now on, all files and attached documents will be saved on the database'

insert into [StrSource] 
([Ar],[En])
select  '          ','From now on, all files and attached documents will not be saved on the database'

insert into [StrSource] 
([Ar],[En])
select  '        ','Copy the file to the default path when linking it with the document'

insert into [StrSource] 
([Ar],[En])
select  '        ','Do you want to delete the existing documents and images from the database'

insert into [StrSource] 
([Ar],[En])
select  '          ','Do you want to copy archived files, documents and images to the database'

insert into [StrSource] 
([Ar],[En])
select  '        ','and will be saved in folders on the hard drive only'

insert into [StrSource] 
([Ar],[En])
select  '     ','Enter default account for cash entry type'

insert into [StrSource] 
([Ar],[En])
select  '  ','Cash entry type'

insert into [StrSource] 
([Ar],[En])
select  ' ','Cash entry'

insert into [StrSource] 
([Ar],[En])
select  '     ','Recreate entries for service contracts'

insert into [StrSource] 
([Ar],[En])
select  ' ','Contract type'

insert into [StrSource] 
([Ar],[En])
select  ' ','Material information'

insert into [StrSource] 
([Ar],[En])
select  '  ','Time not ripe'

insert into [StrSource] 
([Ar],[En])
select  '  ','Not Implemented'

insert into [StrSource] 
([Ar],[En])
select  '  ','Maintenance contracts report'

insert into [StrSource] 
([Ar],[En])
select  ' ','Maintenance worker'

insert into [StrSource] 
([Ar],[En])
select  '  ','Reason for non-implementation'

insert into [StrSource] 
([Ar],[En])
select  '  ','Maintenance contract visits'

insert into [StrSource] 
([Ar],[En])
select  ' ','Maintenance visits'

insert into [StrSource] 
([Ar],[En])
select  ' ','Visit Number'

insert into [StrSource] 
([Ar],[En])
select  '   ','Due time but not implement'

insert into [StrSource] 
([Ar],[En])
select  ' ','Implemented'

insert into [StrSource] 
([Ar],[En])
select  '  ','Maintenance visits report'

insert into [StrSource] 
([Ar],[En])
select  '  ','Maintenance work card'

insert into [StrSource] 
([Ar],[En])
select  '    ','Move cost center with revenue account'

insert into [StrSource] 
([Ar],[En])
select  ' ','Visit date'

insert into [StrSource] 
([Ar],[En])
select  '   ','Non-implementation maintenance details'

insert into [StrSource] 
([Ar],[En])
select  '  ','Implementation maintenance details'

insert into [StrSource] 
([Ar],[En])
select  ' ','Visit details'

insert into [StrSource] 
([Ar],[En])
select  '  ','Maintenance contract types'

insert into [StrSource] 
([Ar],[En])
select  '  ','Unit and Maintenance works'

insert into [StrSource] 
([Ar],[En])
select  '','Visits'

insert into [StrSource] 
([Ar],[En])
select  ' ','Required works'

insert into [StrSource] 
([Ar],[En])
select  ' ','Maintenance works'

insert into [StrSource] 
([Ar],[En])
select  ' ','Maintenance works'

insert into [StrSource] 
([Ar],[En])
select  ' ','Contract name'

insert into [StrSource] 
([Ar],[En])
select  '    ','Load files from the database'

insert into [StrSource] 
([Ar],[En])
select  ' ','Units Maintenance'

insert into [StrSource] 
([Ar],[En])
select  ' ','Materials profits'

insert into [StrSource] 
([Ar],[En])
select  '   ','Import materials & groups information'

insert into [StrSource] 
([Ar],[En])
select  '  ','Cash flow statement'

insert into [StrSource] 
([Ar],[En])
select  '  ','Financial position statement'

insert into [StrSource] 
([Ar],[En])
select  '  ','Financial statements classification'

insert into [StrSource] 
([Ar],[En])
select  '  ','Collection & Revenue Period'

insert into [StrSource] 
([Ar],[En])
select  '  ','Due maintenance visits'

insert into [StrSource] 
([Ar],[En])
select  ' ','Counter number'

insert into [StrSource] 
([Ar],[En])
select  ' ','Hour fee'

insert into [StrSource] 
([Ar],[En])
select  ' ','Maintenance fees'

insert into [StrSource] 
([Ar],[En])
select  ' ','Worker name'

insert into [StrSource] 
([Ar],[En])
select  '   ','Classification with income statement'

insert into [StrSource] 
([Ar],[En])
select  ' ','Duplicate number'

insert into [StrSource] 
([Ar],[En])
select  '','Workers'

insert into [StrSource] 
([Ar],[En])
select  ' ','Without contract'

insert into [StrSource] 
([Ar],[En])
select  ' ','Visits report'

insert into [StrSource] 
([Ar],[En])
select  '      ,      ','Security level has been modified for this account, do you want to change it for the sons?'

insert into [StrSource] 
([Ar],[En])
select  '  ','Leased property activity'

insert into [StrSource] 
([Ar],[En])
select  ' ','Expense account'

insert into [StrSource] 
([Ar],[En])
select  ' ','Working hours'

insert into [StrSource] 
([Ar],[En])
select  '  ','Bill of materials'

insert into [StrSource] 
([Ar],[En])
select  '   ','Transfer activity between materials'

insert into [StrSource] 
([Ar],[En])
select  '   ','Cost center for cheque'

insert into [StrSource] 
([Ar],[En])
select  '   ','Each account on a separate sheet'

insert into [StrSource] 
([Ar],[En])
select  ' ','Maintenance contract'

insert into [StrSource] 
([Ar],[En])
select  '  ','Cheque accounts'

insert into [StrSource] 
([Ar],[En])
select  '     ','Alert for units will be vacated before'

insert into [StrSource] 
([Ar],[En])
select  '','Rounded'

insert into [StrSource] 
([Ar],[En])
select  '  ','Default bill type'

insert into [StrSource] 
([Ar],[En])
select  '   ','Alert maintenance visits before'

insert into [StrSource] 
([Ar],[En])
select  '       ','Open the selected type of the bill for materials used for maintenance visit'

insert into [StrSource] 
([Ar],[En])
select  '   ','Automatically send SMS when termination'

insert into [StrSource] 
([Ar],[En])
select  '   ','Default number to send SMS'

insert into [StrSource] 
([Ar],[En])
select  ' ','External Maintenance'

insert into [StrSource] 
([Ar],[En])
select  ' ','Internal Maintenance'

insert into [StrSource] 
([Ar],[En])
select  ' ','When termination'

insert into [StrSource] 
([Ar],[En])
select  ' ','When add'

insert into [StrSource] 
([Ar],[En])
select  '  ','Plural part name'

insert into [StrSource] 
([Ar],[En])
select  ' ','Name in plural'

insert into [StrSource] 
([Ar],[En])
select  ' ','By Country'

insert into [StrSource] 
([Ar],[En])
select  ' ','Arabic in words'

insert into [StrSource] 
([Ar],[En])
select  ' ','Latin in words'

insert into [StrSource] 
([Ar],[En])
select  ' ','Watchman name'

insert into [StrSource] 
([Ar],[En])
select  '','Excel'

insert into [StrSource] 
([Ar],[En])
select  ' ','AutoNumber'

insert into [StrSource] 
([Ar],[En])
select  '  ','Watchman card'

insert into [StrSource] 
([Ar],[En])
select  ' ','Date of hiring'

insert into [StrSource] 
([Ar],[En])
select  '  ','Termination issue date'

insert into [StrSource] 
([Ar],[En])
select  '  ','Alterations of wachtmen'

insert into [StrSource] 
([Ar],[En])
select  ' html.....','Export html....'

insert into [StrSource] 
([Ar],[En])
select  ' ','Activity reports'

insert into [StrSource] 
([Ar],[En])
select  ' ','Managers Reports'

insert into [StrSource] 
([Ar],[En])
select  ' ','Buildings report'

insert into [StrSource] 
([Ar],[En])
select  ' ','Watchman'

insert into [StrSource] 
([Ar],[En])
select  '  ','Total material movement'

insert into [StrSource] 
([Ar],[En])
select  ' ','Built year'

insert into [StrSource] 
([Ar],[En])
select  '  ','Check customers blocking'

insert into [StrSource] 
([Ar],[En])
select  '  ','Electricity meter reading'

insert into [StrSource] 
([Ar],[En])
select  '   ','Building electricity meter reading'

insert into [StrSource] 
([Ar],[En])
select  '  ','Building area'

insert into [StrSource] 
([Ar],[En])
select  ' ','License type'

insert into [StrSource] 
([Ar],[En])
select  '','Cost'

insert into [StrSource] 
([Ar],[En])
select  ' ','Return fees'

insert into [StrSource] 
([Ar],[En])
select  ' ','Commission collection'

insert into [StrSource] 
([Ar],[En])
select  ' ','Orders permission'

insert into [StrSource] 
([Ar],[En])
select  '/','Debit'

insert into [StrSource] 
([Ar],[En])
select  '/ ','Credit'

insert into [StrSource] 
([Ar],[En])
select  '      ','Active file archiving within database'

insert into [StrSource] 
([Ar],[En])
select  '  ','Change files path'

insert into [StrSource] 
([Ar],[En])
select  ' ','Lessor card'

insert into [StrSource] 
([Ar],[En])
select  '','Orders'

insert into [StrSource] 
([Ar],[En])
select  ' ','Orders types'

insert into [StrSource] 
([Ar],[En])
select  ' ','Orders types'

insert into [StrSource] 
([Ar],[En])
select  ' ','Orders types'

insert into [StrSource] 
([Ar],[En])
select  '  ','Last status details'

insert into [StrSource] 
([Ar],[En])
select  ' /  ','User / Last status'

insert into [StrSource] 
([Ar],[En])
select  ' ','Last status'

insert into [StrSource] 
([Ar],[En])
select  '  ','Last status date'

insert into [StrSource] 
([Ar],[En])
select  ' ','Arabic name'

insert into [StrSource] 
([Ar],[En])
select  ' ','Latin name'


GO

SET ANSI_NULLS, QUOTED_IDENTIFIER ON
GO

Create Procedure [dbo].[PrcCheckReturn]
(
	@Fixreturn int = 2,
	@Account UniqueIdentifier = 0x0,
	@obverseAccount UniqueIdentifier = 0x0,
	@AccountWith int = 0,
	@BankName Varchar(256) = '',
	@beneficiary Varchar(256) = '',
	@ReturnCause Varchar(256) = '',
	@ExceptReturnCause Varchar(256) = '',
	@DayCount int = 0,
	@ActiveFixReturnNote bit = 0,
	@OperationFixReturnNote int = 1,
	@FixReturnNote varchar(255) = '',
	@ActiveBuildingList Bit = 1,
	@ReturnFinish int = 2,
	@CkDate Bit = 0,
	@Datewith int = 0,
	@Date1 Datetime = '2008-1-1',
	@Date2 Datetime = '2019-12-31'
)
 
as
	--  
	if @OperationFixReturnNote = 0 --
	Set @FixReturnNote = '%'+@FixReturnNote+'%'

	Select 
		[P].[Number],
		[P].[TypeName],

		[P].[AccountCode],
		[P].[AccountName],

		[P].[ObverseAccountCode],
		[P].[ObverseAccountName]

		,[P].[No]
		,[P].[Value]
		,Cast(0 as Float) as CollectValue
		,Cast(0 as Float) as RestValue
		,[P].[Date]
		,[P].[DueDate]
		,[P].[EndDueDate]
		,[P].[BankName]
		,[P].[Note]
		,[P].[Note3]
		,p.[beneficiary]
		,[P].[Guid]
		,[P].[CurrencyGuid] as [CheckCurrencyGuid]

		,[P].[Mark]
		,[p].[Deposition]
		,[C3].[Date] as [ReturnedDate]
		,DATEDIFF(DAY, [C3].[Date] , GETDATE()) as DayCount
		,[C3].ReturnCause
		,[C3].[FinishDate] as [ReturnedFinishDate]
		,[C3].[Finished] as [ReturnedFinished]
		,[C3].fixReturn
		,[C3].fixReturnNote
		,CAST(0x0 as uniqueidentifier) as BuildingGuid
		,CAST('' as varchar(255)) as BuildingName
		,CAST('' as varchar(255)) as UnitNo
--		,BuildingName,
	into #R_CheckReturn
	From
		[vwChecks] [P]
		inner join [Resource] [RS] on [RS].[Guid] = [P].[TypeGuid] and [RS].[Spid] = @@Spid and [RS].[Kind] = 3000
		inner join [vwChecksCollection] [C3] on [C3].[CheckGuid] = [P].[Guid] and [C3].[Kind] = 3
  	where
		(
			--([P].[Account] = @Account  and @AccountWith = 0) or
			([C3].[DebitAccountGuid] = @Account  and @AccountWith = 1) --
			Or @Account = 0x0
			or @AccountWith = 0
		)
		and
		(
			--([P].[obverseAccount] = @obverseAccount  and @AccountWith = 0) or
			([C3].[creditAccountGuid] = @obverseAccount  and @AccountWith = 1)
			Or @obverseAccount = 0x0
			or @AccountWith = 0
		)

 		and ([P].[beneficiary] = @beneficiary or @beneficiary = '')
  		and ([P].[BankName] = @BankName or @BankName = '')
 		and (
 				([P].[Date] Between @Date1 And @Date2 and @Datewith = 0)
 				or ([P].[DueDate] Between @Date1 And @Date2 and @Datewith = 1)
 				or ([C3].Date Between @Date1 And @Date2 and @Datewith = 2)
 				
 				or @CkDate = 0)
 		and (DATEDIFF(DAY, [C3].[Date] , GETDATE()) >= @DayCount or @DayCount = 0)
 		and (C3.fixReturn = @Fixreturn or @Fixreturn = 2)
 		and (IsNull([C3].ReturnCause,'') = @ReturnCause or @ReturnCause = '')
 		and (IsNull([C3].ReturnCause,'') <> @ExceptReturnCause or @ExceptReturnCause = '')
 		and	(   [C3].[Note] Like @FixReturnNote
 				or @ActiveFixReturnNote= 0
 			)
 		and (isNull(C3.Finished,0) = @ReturnFinish or @ReturnFinish = 2)


	Update #R_CheckReturn Set AccountName = dbo.SC(' '), 
				  AccountCode = dbo.SC(' ')
	From
		#R_CheckReturn R
		inner join ChecksAccountDetail D on D.[ParentGuid] = R.Guid and Kind = 1


	Update #R_CheckReturn Set ObverseAccountName = dbo.SC(' '),
				  ObverseAccountCode = dbo.SC(' ')
	From
		#R_CheckReturn R
		inner join ChecksAccountDetail D on D.[ParentGuid] = R.Guid and Kind = 2

	 if (@Account <> 0x0) and (@AccountWith = 0)
	 begin
		
		Select 
			Distinct [ParentGuid]
		into #ChecksAccountDetail1
		from 
			ChecksAccountDetail D
			inner join #R_CheckReturn R on D.[ParentGuid] = R.Guid and Kind = 1 and D.[AccountGuid] = @Account

		Delete #R_CheckReturn
		From
			#R_CheckReturn R
			left join #ChecksAccountDetail1 D on D.[ParentGuid] = R.Guid 
		where
			D.[ParentGuid] is Null
			and (R.AccountGuid <> @Account)
	 end

	 if (@obverseAccount <> 0x0) and (@AccountWith = 0)
	 begin
		Select 
			Distinct [ParentGuid]
		into #ChecksAccountDetail2
		from 
			ChecksAccountDetail D
			inner join #R_CheckReturn R on D.[ParentGuid] = R.Guid and Kind = 2 and D.[AccountGuid] = @obverseAccount

		Delete #R_CheckReturn
		From
			#R_CheckReturn R
			left join #ChecksAccountDetail2 D on D.[ParentGuid] = R.Guid 
		where
			D.[ParentGuid] is Null
			and (R.obverseAccountGuid <> @obverseAccount)
			
	 end

	Select 
		CheckGuid,
		Sum(Value) as [Value]
	into #ChecksPartialCollection_S
	from 
		ChecksPartialCollection
	Group by
		CheckGuid

	update #R_CheckReturn
	Set
		CollectValue = S.value
	From
		#R_CheckReturn C
		inner join #ChecksPartialCollection_S S on S.CheckGuid = C.Guid
		
	update #R_CheckReturn Set RestValue = value - isNull(CollectValue,0)		


	-- 
	if @ActiveBuildingList = 1
	begin
		Update #R_CheckReturn 
		Set 
			BuildingGuid = C.BuildingGuid,
			BuildingName = C.BuildingName,
			UnitNo = C.FlatNo
		From
			#R_CheckReturn R
			inner join [LinkCheckContract] L on L.parentGuid = R.Guid
			inner join [vwLeaseApartment] C on C.Guid = L.ContractGuid
		
		--Select BuildingGuid, * from #R_CheckReturn
		
		Delete #R_CheckReturn where isNull(BuildingGuid,0x0) = 0x0
			
		Delete #R_CheckReturn
		From
			#R_CheckReturn [L]
			left join [Resource] [R] on [R].[Guid] = [L].[BuildingGuid] and [R].[Kind] = 99 and [R].[Spid] = @@Spid 
		where
			[R].[Guid] Is Null
			--and isNull(L.BuildingGuid,0x0) <> 0x0
	end

	Select 
		*,
		0 as Operation
	From
		#R_CheckReturn
 	order By
 		[ReturnedDate] ,[Date]
 		
 		

GO

SET ANSI_NULLS, QUOTED_IDENTIFIER ON
GO

Create Procedure [dbo].[PrcStrSource3]
 
as

insert into [StrSource] 
([Ar],[En])
select  '[O]  ','[O] Owner name'

insert into [StrSource] 
([Ar],[En])
select  '  ','Enter revenue account'

insert into [StrSource] 
([Ar],[En])
select  ' ','Watchman name'

insert into [StrSource] 
([Ar],[En])
select  '   ','Execute the last command'

insert into [StrSource] 
([Ar],[En])
select  '     ','ReGenerate entries for land contracts'

insert into [StrSource] 
([Ar],[En])
select  ' ','Date by'

insert into [StrSource] 
([Ar],[En])
select  ' ','Total price'

insert into [StrSource] 
([Ar],[En])
select  ' ','Returned value'

insert into [StrSource] 
([Ar],[En])
select  ' ','To date'

insert into [StrSource] 
([Ar],[En])
select  ' ','Merit Date'

insert into [StrSource] 
([Ar],[En])
select  '','Date...'

insert into [StrSource] 
([Ar],[En])
select  '   ','Residence expiry date'

insert into [StrSource] 
([Ar],[En])
select  '   ','Last payment date'

insert into [StrSource] 
([Ar],[En])
select  '   ','Last due payment date'

insert into [StrSource] 
([Ar],[En])
select  '   ','Last delayed cheque'

insert into [StrSource] 
([Ar],[En])
select  '   ','Last due check date'

insert into [StrSource] 
([Ar],[En])
select  '    ','Contract delivery date to registration'

insert into [StrSource] 
([Ar],[En])
select  '  ','Building investment date'

insert into [StrSource] 
([Ar],[En])
select  '  ','Payment due date'

insert into [StrSource] 
([Ar],[En])
select  '  ','Deposit retrieve date'

insert into [StrSource] 
([Ar],[En])
select  '     ','Contract received date from customer'

insert into [StrSource] 
([Ar],[En])
select  '    ','Maintenance order closing date'

insert into [StrSource] 
([Ar],[En])
select  '  ','Residence end date'

insert into [StrSource] 
([Ar],[En])
select  '  ','
The expiry date of release'

insert into [StrSource] 
([Ar],[En])
select  '   ','Booking end date specified'

insert into [StrSource] 
([Ar],[En])
select  '  ','Date of expiration'

insert into [StrSource] 
([Ar],[En])
select  '  ','ID expiry date'

insert into [StrSource] 
([Ar],[En])
select  '   ','Passport expiry date'

insert into [StrSource] 
([Ar],[En])
select  '  ','Booking termination date'

insert into [StrSource] 
([Ar],[En])
select  '   ','Returned cheque termination date'

insert into [StrSource] 
([Ar],[En])
select  '  ','Contract termination date'

insert into [StrSource] 
([Ar],[En])
select  '        ','Contract termination date is smaller than contract start date'

insert into [StrSource] 
([Ar],[En])
select  '   ','Previous contract termination date'

insert into [StrSource] 
([Ar],[En])
select  '         : ','Contract termination date inside the period of contract No:'

insert into [StrSource] 
([Ar],[En])
select  '      ','Contract termination date before strarting date'

insert into [StrSource] 
([Ar],[En])
select  '  ','First installment date'

insert into [StrSource] 
([Ar],[En])
select  '    ','Contract received date for registration'

insert into [StrSource] 
([Ar],[En])
select  '    ','Contract received date from registration'

insert into [StrSource] 
([Ar],[En])
select  ' ','Evacuation date'

insert into [StrSource] 
([Ar],[En])
select  ' ','Input date'

insert into [StrSource] 
([Ar],[En])
select  ' ','Return date'

insert into [StrSource] 
([Ar],[En])
select  ' ','due  date'

insert into [StrSource] 
([Ar],[En])
select  ' ','Refund date'

insert into [StrSource] 
([Ar],[En])
select  ' ','Received date'

insert into [StrSource] 
([Ar],[En])
select  ' ','release date'

insert into [StrSource] 
([Ar],[En])
select  ' ','Closing date'

insert into [StrSource] 
([Ar],[En])
select  '   ','Date abstain from payment'

insert into [StrSource] 
([Ar],[En])
select  ' ','Production date'

insert into [StrSource] 
([Ar],[En])
select  ' ','Expire Date'

insert into [StrSource] 
([Ar],[En])
select  ' ','Termination date'

insert into [StrSource] 
([Ar],[En])
select  '  ','Termination date specific'

insert into [StrSource] 
([Ar],[En])
select  ' ','Receipt Date'

insert into [StrSource] 
([Ar],[En])
select  ' ','Refund date'

insert into [StrSource] 
([Ar],[En])
select  ' ','Claiming date'

insert into [StrSource] 
([Ar],[En])
select  '   ','Date of abstention of paying'

insert into [StrSource] 
([Ar],[En])
select  '  ','Expected completion date'

insert into [StrSource] 
([Ar],[En])
select  '     ','Start date is larger than the expiration date'

insert into [StrSource] 
([Ar],[En])
select  ' ','Start Date'

insert into [StrSource] 
([Ar],[En])
select  ' ','Selling date'

insert into [StrSource] 
([Ar],[En])
select  ' ','Fixed date'

insert into [StrSource] 
([Ar],[En])
select  ' ','Issue date'

insert into [StrSource] 
([Ar],[En])
select  ' ','Collect date'

insert into [StrSource] 
([Ar],[En])
select  ' ','Reminder date'

insert into [StrSource] 
([Ar],[En])
select  ' ','Deposit date'

insert into [StrSource] 
([Ar],[En])
select  ' ','License date'

insert into [StrSource] 
([Ar],[En])
select  '   ','Delivery date to legal department'

insert into [StrSource] 
([Ar],[En])
select  ' ','Endorsement date'

insert into [StrSource] 
([Ar],[En])
select  ' ','Date of hiring'

insert into [StrSource] 
([Ar],[En])
select  ' ','Execution date'

insert into [StrSource] 
([Ar],[En])
select  ' ','Booking date'

insert into [StrSource] 
([Ar],[En])
select  ' ','Leaving date'

insert into [StrSource] 
([Ar],[En])
select  ' ','Entering date'

insert into [StrSource] 
([Ar],[En])
select  ' ','Payment date'

insert into [StrSource] 
([Ar],[En])
select  '  ','First payment date'

insert into [StrSource] 
([Ar],[En])
select  ' ','Visit date'

insert into [StrSource] 
([Ar],[En])
select  ' ','Entry date'

insert into [StrSource] 
([Ar],[En])
select  ' ','Shipping date'

insert into [StrSource] 
([Ar],[En])
select  ' ','Purchase date'

insert into [StrSource] 
([Ar],[En])
select  ' ','Contract date'

insert into [StrSource] 
([Ar],[En])
select  ' ','Operation date'

insert into [StrSource] 
([Ar],[En])
select  '  ','Last read date'

insert into [StrSource] 
([Ar],[En])
select  ' ','Voucher Date'

insert into [StrSource] 
([Ar],[En])
select  ' ','Date of birth'

insert into [StrSource] 
([Ar],[En])
select  ' ','Ending date'

insert into [StrSource] 
([Ar],[En])
select  ' ','Arrive date'

insert into [StrSource] 
([Ar],[En])
select  '   ','Passport Expiry Date'

insert into [StrSource] 
([Ar],[En])
select  '   ','First delayed cheque'

insert into [StrSource] 
([Ar],[En])
select  '  ','Warranty start date'

insert into [StrSource] 
([Ar],[En])
select  '  ','Investment starting date'

insert into [StrSource] 
([Ar],[En])
select  '  ','Depreciation starting date'

insert into [StrSource] 
([Ar],[En])
select  '  ','Maintenance starting date'

insert into [StrSource] 
([Ar],[En])
select  '  ','Contract starting date'

insert into [StrSource] 
([Ar],[En])
select  '       ','Contract start date is bigger than End date period'

insert into [StrSource] 
([Ar],[En])
select  '       !','Contract starting date is larger than investment starting date'

insert into [StrSource] 
([Ar],[En])
select  '  ','Start duration date'

insert into [StrSource] 
([Ar],[En])
select  '   ','Municipality clearance date'

insert into [StrSource] 
([Ar],[En])
select  '   ','Electricity clearance date'

insert into [StrSource] 
([Ar],[En])
select  '  ','Termination issue date'

insert into [StrSource] 
([Ar],[En])
select  '  ','Contract issue date'

insert into [StrSource] 
([Ar],[En])
select  '  ','Property delivery date'

insert into [StrSource] 
([Ar],[En])
select  '    ','Registered contract delivery date to customer'

insert into [StrSource] 
([Ar],[En])
select  '   ','Contract delivery date to customer'

insert into [StrSource] 
([Ar],[En])
select  '  ','Warn printing date'

insert into [StrSource] 
([Ar],[En])
select  '   ','Clearance print date'

insert into [StrSource] 
([Ar],[En])
select  '  ','Maintenance contract starting date'

insert into [StrSource] 
([Ar],[En])
select  '  ','Lawsuit date'

insert into [StrSource] 
([Ar],[En])
select  '  ','Investment expiry date'

insert into [StrSource] 
([Ar],[En])
select  '  ','Due end date'

insert into [StrSource] 
([Ar],[En])
select  '  ','Lawsuit end date'

insert into [StrSource] 
([Ar],[En])
select  '  ','Contract expiry date'

insert into [StrSource] 
([Ar],[En])
select  '        ','Contract expiry date is larger than investment end date of the land'

insert into [StrSource] 
([Ar],[En])
select  '        ','Contract expiry date is larger than investment end date of the building'

insert into [StrSource] 
([Ar],[En])
select  '   ','Previous contract ending date'

insert into [StrSource] 
([Ar],[En])
select  '        ','Contract end date outside of starting and ending period'

insert into [StrSource] 
([Ar],[En])
select  '  ','End duration date'

insert into [StrSource] 
([Ar],[En])
select  '','History'

insert into [StrSource] 
([Ar],[En])
select  '   ','Make sure that account name is correct'

insert into [StrSource] 
([Ar],[En])
select  '      ','Make sure you enter value in the line'

insert into [StrSource] 
([Ar],[En])
select  '   ','Check connection settings'

insert into [StrSource] 
([Ar],[En])
select  '      ','Enter correctly number of days'

insert into [StrSource] 
([Ar],[En])
select  '   ','Make sure the correct path'

insert into [StrSource] 
([Ar],[En])
select  '    : ','Check the path'

insert into [StrSource] 
([Ar],[En])
select  '     ','Make sure of the new path specified'

insert into [StrSource] 
([Ar],[En])
select  '  ','Verify password'

insert into [StrSource] 
([Ar],[En])
select  '    ','Flats rent changing'

insert into [StrSource] 
([Ar],[En])
select  '  ','Flats price changing'

insert into [StrSource] 
([Ar],[En])
select  '  ','Alterations of wachtmen'

insert into [StrSource] 
([Ar],[En])
select  '   ','Change flat rental prices'

insert into [StrSource] 
([Ar],[En])
select  '   ','Flat selling update'

insert into [StrSource] 
([Ar],[En])
select  ' ','Pricing update'

insert into [StrSource] 
([Ar],[En])
select  ' ','Rental update'

insert into [StrSource] 
([Ar],[En])
select  ' ','New tab'

insert into [StrSource] 
([Ar],[En])
select  '         ','This land consists of assembling more than one land, It''s:'

insert into [StrSource] 
([Ar],[En])
select  '       ','This flat consists of assembling more than one flat'

insert into [StrSource] 
([Ar],[En])
select  '  ','The process will be success'

insert into [StrSource] 
([Ar],[En])
select  '  ','To cost center'

insert into [StrSource] 
([Ar],[En])
select  '','Notes '

insert into [StrSource] 
([Ar],[En])
select  ' ','Current date'

insert into [StrSource] 
([Ar],[En])
select  '','Warning'

insert into [StrSource] 
([Ar],[En])
select  ' !  ','Warning !'

insert into [StrSource] 
([Ar],[En])
select  ' :  [0] -  [1]:  [0] -  [1] :  [0] -  [1] -  [2] - [3] -  [4]','Notice: card type: Customer (0) - Supplier (1) Type: Company (0) - Person (1) Security level: Without (0) - Low (1) - Intermediate (2) - High (3) - Special (4)'

insert into [StrSource] 
([Ar],[En])
select  ' ','Residence expiry'

insert into [StrSource] 
([Ar],[En])
select  ' ','End of contract'

insert into [StrSource] 
([Ar],[En])
select  ' ','ID expiry'

insert into [StrSource] 
([Ar],[En])
select  '  ','Passport expiry'

insert into [StrSource] 
([Ar],[En])
select  ' ','Create journal entry'

insert into [StrSource] 
([Ar],[En])
select  ' ','Connection lost'

insert into [StrSource] 
([Ar],[En])
select  ' ','Orders Patterns'

insert into [StrSource] 
([Ar],[En])
select  ' ','Bills Patterns'

insert into [StrSource] 
([Ar],[En])
select  '','Rent'

insert into [StrSource] 
([Ar],[En])
select  ' ','Daily income'

insert into [StrSource] 
([Ar],[En])
select  '  ','Rental income earned'

insert into [StrSource] 
([Ar],[En])
select  '','Email'

insert into [StrSource] 
([Ar],[En])
select  '','Vendor'

insert into [StrSource] 
([Ar],[En])
select  '','Barcode'

insert into [StrSource] 
([Ar],[En])
select  ' ','Rest of collection'

insert into [StrSource] 
([Ar],[En])
select  '','On the date'

insert into [StrSource] 
([Ar],[En])
select  ' ','Commissioned by'

insert into [StrSource] 
([Ar],[En])
select  '','Search'

insert into [StrSource] 
([Ar],[En])
select  ' ','Start numbering'

insert into [StrSource] 
([Ar],[En])
select  ' ','Contract start'

insert into [StrSource] 
([Ar],[En])
select  '  ','Start renumbering process'

insert into [StrSource] 
([Ar],[En])
select  '  ','Maintenance order start'

insert into [StrSource] 
([Ar],[En])
select  ' ','Contract start date'

insert into [StrSource] 
([Ar],[En])
select  ' ','Begining date'

insert into [StrSource] 
([Ar],[En])
select  '  ','Cutomer Name'

insert into [StrSource] 
([Ar],[En])
select  '   [A]','Customer Name [A]'

insert into [StrSource] 
([Ar],[En])
select  '','Without'

insert into [StrSource] 
([Ar],[En])
select  ' ','Without depreciation'

insert into [StrSource] 
([Ar],[En])
select  ' ','without installments'

insert into [StrSource] 
([Ar],[En])
select  '  ','without due date'

insert into [StrSource] 
([Ar],[En])
select  ' ','No rounding'

insert into [StrSource] 
([Ar],[En])
select  '  ','Without downpayment'

insert into [StrSource] 
([Ar],[En])
select  ' ','Without contract'

insert into [StrSource] 
([Ar],[En])
select  ' ','Without an area'

insert into [StrSource] 
([Ar],[En])
select  ' ','Clearance'

insert into [StrSource] 
([Ar],[En])
select  ' ','Email Address'

insert into [StrSource] 
([Ar],[En])
select  '  ','Because of permission level'

insert into [StrSource] 
([Ar],[En])
select  '','Extension'

insert into [StrSource] 
([Ar],[En])
select  '  ','First period inventory'

insert into [StrSource] 
([Ar],[En])
select  '','Cards..'

insert into [StrSource] 
([Ar],[En])
select  '  ','Empty accounts cards'

insert into [StrSource] 
([Ar],[En])
select  '  ','Balanced customer cards'

insert into [StrSource] 
([Ar],[En])
select  ' ','Land card'

insert into [StrSource] 
([Ar],[En])
select  '  ()','Land card (Offers)'

insert into [StrSource] 
([Ar],[En])
select  '    ','Land & Villa card'

insert into [StrSource] 
([Ar],[En])
select  ' ','Asset card'

insert into [StrSource] 
([Ar],[En])
select  ' ','Account card'

insert into [StrSource] 
([Ar],[En])
select  ' ','Lawsuit card'

insert into [StrSource] 
([Ar],[En])
select  ' ','Customer card'

insert into [StrSource] 
([Ar],[En])
select  ' ','Property card'

insert into [StrSource] 
([Ar],[En])
select  ' ','Currency card'

insert into [StrSource] 
([Ar],[En])
select  ' ','Branch card'

insert into [StrSource] 
([Ar],[En])
select  ' ','Material card'

insert into [StrSource] 
([Ar],[En])
select  ' ','Group card'

insert into [StrSource] 
([Ar],[En])
select  ' ','Briefcase card'

insert into [StrSource] 
([Ar],[En])
select  '  ','Realty briefcase card'

insert into [StrSource] 
([Ar],[En])
select  ' ','Store card'

insert into [StrSource] 
([Ar],[En])
select  ' ','Salesman card'

insert into [StrSource] 
([Ar],[En])
select  ' ','Building card'

insert into [StrSource] 
([Ar],[En])
select  ' ','Building Card'

insert into [StrSource] 
([Ar],[En])
select  '  ()','Building card (Offers)'

insert into [StrSource] 
([Ar],[En])
select  ' ','Assemblage card'

insert into [StrSource] 
([Ar],[En])
select  ' ','Card reminder'

insert into [StrSource] 
([Ar],[En])
select  ' ','Card catery'

insert into [StrSource] 
([Ar],[En])
select  '  ','Watchman card'

insert into [StrSource] 
([Ar],[En])
select  '  ','Property booking card'

insert into [StrSource] 
([Ar],[En])
select  ' ','Account Card'

insert into [StrSource] 
([Ar],[En])
select  ' ','Client Card'

insert into [StrSource] 
([Ar],[En])
select  '  / ','Customer / Supplier card'

insert into [StrSource] 
([Ar],[En])
select  ' ','Flat card'

insert into [StrSource] 
([Ar],[En])
select  '  ()','Flat card (Offers)'

insert into [StrSource] 
([Ar],[En])
select  ' ','Complaint card'

insert into [StrSource] 
([Ar],[En])
select  '  ','Maintenance worker card'

insert into [StrSource] 
([Ar],[En])
select  ' ','Branch Card'

insert into [StrSource] 
([Ar],[En])
select  ' ','Villa card'

insert into [StrSource] 
([Ar],[En])
select  '  ()','Villa card (Offers)'

insert into [StrSource] 
([Ar],[En])
select  ' ','Lessor card'

insert into [StrSource] 
([Ar],[En])
select  '   ','Lessor & Sales man card'

insert into [StrSource] 
([Ar],[En])
select  '  ','Lessor and sales man card'

insert into [StrSource] 
([Ar],[En])
select  ' ','Item Card'

insert into [StrSource] 
([Ar],[En])
select  ' ','Owner card'

insert into [StrSource] 
([Ar],[En])
select  ' ','Group Card'

insert into [StrSource] 
([Ar],[En])
select  ' ','Shop card'

insert into [StrSource] 
([Ar],[En])
select  '  ()','Shop card (Offers)'

insert into [StrSource] 
([Ar],[En])
select  '   ','Shop & Parking Card'

insert into [StrSource] 
([Ar],[En])
select  ' ','City card'

insert into [StrSource] 
([Ar],[En])
select  '  ','Cost center card'

insert into [StrSource] 
([Ar],[En])
select  '  / ','Customer / tenant card'

insert into [StrSource] 
([Ar],[En])
select  ' ','Store Card'

insert into [StrSource] 
([Ar],[En])
select  ' ','Area card'

insert into [StrSource] 
([Ar],[En])
select  ' ','Parking card'

insert into [StrSource] 
([Ar],[En])
select  '    ','Regardless of the specific options'

insert into [StrSource] 
([Ar],[En])
select  ' / ','Day / Left'

insert into [StrSource] 
([Ar],[En])
select  '  ','Time of contract expiry'

insert into [StrSource] 
([Ar],[En])
select  ' ','Vacating In'

insert into [StrSource] 
([Ar],[En])
select  '','Building'

insert into [StrSource] 
([Ar],[En])
select  ' ','Bent house'

insert into [StrSource] 
([Ar],[En])
select  ' ','Land details'

insert into [StrSource] 
([Ar],[En])
select  ' ','Receipt details'

insert into [StrSource] 
([Ar],[En])
select  ' ','Account notes'

insert into [StrSource] 
([Ar],[En])
select  '  ','Obverse account notes'

insert into [StrSource] 
([Ar],[En])
select  '     ','Obverse account details from entry details'

insert into [StrSource] 
([Ar],[En])
select  '  ','First payment details'

insert into [StrSource] 
([Ar],[En])
select  '   ','First payment latin details'

insert into [StrSource] 
([Ar],[En])
select  ' ','Visit details'

insert into [StrSource] 
([Ar],[En])
select  ' ','Journal entry details'

insert into [StrSource] 
([Ar],[En])
select  ' ','Property details'

insert into [StrSource] 
([Ar],[En])
select  ' ','Contract Notes'

insert into [StrSource] 
([Ar],[En])
select  '  ','Contract latin details'

insert into [StrSource] 
([Ar],[En])
select  ' ','Operations details'

insert into [StrSource] 
([Ar],[En])
select  ' ','Bill details'

insert into [StrSource] 
([Ar],[En])
select  ' ','Villa details'

insert into [StrSource] 
([Ar],[En])
select  ' ','Line details'

insert into [StrSource] 
([Ar],[En])
select  ' ','Entry details'

insert into [StrSource] 
([Ar],[En])
select  ' ','Note details'

insert into [StrSource] 
([Ar],[En])
select  '  ','Implementation maintenance details'

insert into [StrSource] 
([Ar],[En])
select  '   ','Non-implementation maintenance details'

insert into [StrSource] 
([Ar],[En])
select  '  ','Return processing details'

insert into [StrSource] 
([Ar],[En])
select  ' ','Extra Information'

insert into [StrSource] 
([Ar],[En])
select  ' ','Flat details'

insert into [StrSource] 
([Ar],[En])
select  ' ','Complaint details'

insert into [StrSource] 
([Ar],[En])
select  ' ','Property information'

insert into [StrSource] 
([Ar],[En])
select  '  ','Villa exterior details'

insert into [StrSource] 
([Ar],[En])
select  '  ','Villa interior details'

insert into [StrSource] 
([Ar],[En])
select  '  ','List default data'

insert into [StrSource] 
([Ar],[En])
select  ' ','Sponser data'

insert into [StrSource] 
([Ar],[En])
select  '  ','Latin Sponser data'

insert into [StrSource] 
([Ar],[En])
select  ' ','Ownership information'

insert into [StrSource] 
([Ar],[En])
select  ' ','Parking data'

insert into [StrSource] 
([Ar],[En])
select  '  ','Latin personal info'

insert into [StrSource] 
([Ar],[En])
select  ' ','Personal informations'

insert into [StrSource] 
([Ar],[En])
select  '  1','Peronal data 1'

insert into [StrSource] 
([Ar],[En])
select  '  2','Peronal data 2'

insert into [StrSource] 
([Ar],[En])
select  '  ','Latin personal information'

insert into [StrSource] 
([Ar],[En])
select  '','Sell'

insert into [StrSource] 
([Ar],[En])
select  ' ','Flat Selling'

insert into [StrSource] 
([Ar],[En])
select  ' ','Shop Selling'

insert into [StrSource] 
([Ar],[En])
select  '','Between'

insert into [StrSource] 
([Ar],[En])
select  '   ','Effect materials pricing'

insert into [StrSource] 
([Ar],[En])
select  '     ','Make sure you enter the date correctly'

insert into [StrSource] 
([Ar],[En])
select  '     ','Be sure to enter the code numbers only'

insert into [StrSource] 
([Ar],[En])
select  '     ','Make sure you enter code characters only'

insert into [StrSource] 
([Ar],[En])
select  '     ','Make sure you enter the amounts correctly'

insert into [StrSource] 
([Ar],[En])
select  '   ','Make sure to enter percentages'

insert into [StrSource] 
([Ar],[En])
select  '        ','Make sure you do not add duplicate flat to the same building'

insert into [StrSource] 
([Ar],[En])
select  '        ','Make sure you do not add duplicate warehouses for the same building'

insert into [StrSource] 
([Ar],[En])
select  '   ','Check termination date'

insert into [StrSource] 
([Ar],[En])
select  '     ','Make sure the distribution of values properly'

insert into [StrSource] 
([Ar],[En])
select  '      : ','Make sure the database path:'

insert into [StrSource] 
([Ar],[En])
select  '   ','Check the password'

insert into [StrSource] 
([Ar],[En])
select  '   ','Make sure the program is exist'

insert into [StrSource] 
([Ar],[En])
select  '  ','Current contract deposit'

insert into [StrSource] 
([Ar],[En])
select  '  ','Previous contract deposit'

insert into [StrSource] 
([Ar],[En])
select  ' ','Electicity deposit'

insert into [StrSource] 
([Ar],[En])
select  ' ','Contracts Insurance'

insert into [StrSource] 
([Ar],[En])
select  ' ','Install version'

insert into [StrSource] 
([Ar],[En])
select  ' ','Install description'

insert into [StrSource] 
([Ar],[En])
select  ' ','Fixed operations'

insert into [StrSource] 
([Ar],[En])
select  '','Ignore'

insert into [StrSource] 
([Ar],[En])
select  ' ','Ignore all'

insert into [StrSource] 
([Ar],[En])
select  ' ','Material exceeded'

insert into [StrSource] 
([Ar],[En])
select  '     ','Exceeded allowed discount rate'

insert into [StrSource] 
([Ar],[En])
select  '','Renewal'

insert into [StrSource] 
([Ar],[En])
select  ' ','Contract renewal'

insert into [StrSource] 
([Ar],[En])
select  '  ','Renew selected contracts'

insert into [StrSource] 
([Ar],[En])
select  '   ','Renew lands and villas contract'

insert into [StrSource] 
([Ar],[En])
select  '   ','Renew flats and shops contract'

insert into [StrSource] 
([Ar],[En])
select  '  ','Renew parking contract'

insert into [StrSource] 
([Ar],[En])
select  ' / ','Assembled / Detailed'

insert into [StrSource] 
([Ar],[En])
select  '  ','Collapse lines Entries'

insert into [StrSource] 
([Ar],[En])
select  ' ','Assemble accounts'

insert into [StrSource] 
([Ar],[En])
select  ' ','Assembling files'

insert into [StrSource] 
([Ar],[En])
select  '  ','Group by catery'

insert into [StrSource] 
([Ar],[En])
select  '  ','Grouped by Catery'

insert into [StrSource] 
([Ar],[En])
select  '  ','Collecting card files'

insert into [StrSource] 
([Ar],[En])
select  '','Assembly'

insert into [StrSource] 
([Ar],[En])
select  '','Update'

insert into [StrSource] 
([Ar],[En])
select  '   ','Update Flat rental prices'

insert into [StrSource] 
([Ar],[En])
select  '   ','Update contract fees'

insert into [StrSource] 
([Ar],[En])
select  ' ','Auto-Update'

insert into [StrSource] 
([Ar],[En])
select  ' ','Version update'

insert into [StrSource] 
([Ar],[En])
select  '','Select'

insert into [StrSource] 
([Ar],[En])
select  ' ','Check all'

insert into [StrSource] 
([Ar],[En])
select  '  ','Select all'

insert into [StrSource] 
([Ar],[En])
select  ' ','Complaint issue date'

insert into [StrSource] 
([Ar],[En])
select  ' ','Contract issue'

insert into [StrSource] 
([Ar],[En])
select  '   ','Cost center belong to credits account'

insert into [StrSource] 
([Ar],[En])
select  '     ','Move the cost center with the credits account'

insert into [StrSource] 
([Ar],[En])
select  '     ','Cost center belong to debits account'

insert into [StrSource] 
([Ar],[En])
select  '    ','Cost center belong to contracts'

insert into [StrSource] 
([Ar],[En])
select  '    ','Cost center belong to commission account'

insert into [StrSource] 
([Ar],[En])
select  '      ','Cost center belong to commission credit account'

insert into [StrSource] 
([Ar],[En])
select  '      ','Cost center belong to commission debit account'

insert into [StrSource] 
([Ar],[En])
select  '     ','Cost center belong to deposit account'

insert into [StrSource] 
([Ar],[En])
select  '      ','Cost center belong to other fees account'

insert into [StrSource] 
([Ar],[En])
select  '      ','Cost center belong to contract registration account'

insert into [StrSource] 
([Ar],[En])
select  '      ','Cost center belong to contract price account'

insert into [StrSource] 
([Ar],[En])
select  '       ','Cost center belong to contract termination account'

insert into [StrSource] 
([Ar],[En])
select  '    ','Move cost center with revenue account'

insert into [StrSource] 
([Ar],[En])
select  '     ','Cost center belong to default account'

insert into [StrSource] 
([Ar],[En])
select  '     ','Move cost center with earned discount'

insert into [StrSource] 
([Ar],[En])
select  '     ','Cost center belong to commission discount'

insert into [StrSource] 
([Ar],[En])
select  '      ','Cost center belong to commission client account'

insert into [StrSource] 
([Ar],[En])
select  '       ','Cost center belong to commission owner account'

insert into [StrSource] 
([Ar],[En])
select  '    ','Cost center belong to tenant account'

insert into [StrSource] 
([Ar],[En])
select  '    ','Move cost center with expenses'

insert into [StrSource] 
([Ar],[En])
select  '      ','Cost center belong to contract termination fees account'

insert into [StrSource] 
([Ar],[En])
select  '','Collect'

insert into [StrSource] 
([Ar],[En])
select  ' ','cheque collection'

insert into [StrSource] 
([Ar],[En])
select  ' ','Partial collection'

insert into [StrSource] 
([Ar],[En])
select  '','Loading '

insert into [StrSource] 
([Ar],[En])
select  ' ','Loading data'

insert into [StrSource] 
([Ar],[En])
select  ' ','Loading currency'

insert into [StrSource] 
([Ar],[En])
select  '  ','Loading libraries '

insert into [StrSource] 
([Ar],[En])
select  '  ...','Install Laibraries ...'

insert into [StrSource] 
([Ar],[En])
select  '   ','Loading librariesFavorite accounts'

insert into [StrSource] 
([Ar],[En])
select  '    ','Load files from Database '

insert into [StrSource] 
([Ar],[En])
select  '     ...','Install Files from data base ...'

insert into [StrSource] 
([Ar],[En])
select  '       ','Download documents from Database to the hard drive'

insert into [StrSource] 
([Ar],[En])
select  '  ','Loading card information'

insert into [StrSource] 
([Ar],[En])
select  '  ','Loading accounts table'

insert into [StrSource] 
([Ar],[En])
select  '  ','Loading customers table'

insert into [StrSource] 
([Ar],[En])
select  '  ','Loading units table'

insert into [StrSource] 
([Ar],[En])
select  '   ','Loading jobcost table'

insert into [StrSource] 
([Ar],[En])
select  '  ','load print files'

insert into [StrSource] 
([Ar],[En])
select  '  ','Download print files'

insert into [StrSource] 
([Ar],[En])
select  '  \Bin\Rpt\Contract Rent Flat','Download print files\Bin\Rpt\Contract Rent Flat'

insert into [StrSource] 
([Ar],[En])
select  '  \Bin\Rpt\Receiving Check','Install Printing Files\Bin\Rpt\Receiving Check'

insert into [StrSource] 
([Ar],[En])
select  '  \Bin\Rpt\Receiving Entry','Install Printing Files\Bin\Rpt\Receiving Entry'

insert into [StrSource] 
([Ar],[En])
select  '  D:\ \Al-Aqari\ \ ','Download print filesD:\ \Al-Aqari\ \ '

insert into [StrSource] 
([Ar],[En])
select  '    ','Change Language'

insert into [StrSource] 
([Ar],[En])
select  '','Customize'

insert into [StrSource] 
([Ar],[En])
select  ' ','Select path'

insert into [StrSource] 
([Ar],[En])
select  '  ','Select printing folder'

insert into [StrSource] 
([Ar],[En])
select  '  ...','Specify Printing floder...'

insert into [StrSource] 
([Ar],[En])
select  '  ','Customizable templates folder'

insert into [StrSource] 
([Ar],[En])
select  '  ','Specify folder for card'

insert into [StrSource] 
([Ar],[En])
select  '  ','Specify folder for type'

insert into [StrSource] 
([Ar],[En])
select  '','Check'

insert into [StrSource] 
([Ar],[En])
select  '  ','Checking account balances'

insert into [StrSource] 
([Ar],[En])
select  '  ','Checking quantity balance'

insert into [StrSource] 
([Ar],[En])
select  '   ','Check prices and material balances'

insert into [StrSource] 
([Ar],[En])
select  ' ','Checking prices'

insert into [StrSource] 
([Ar],[En])
select  ' ','Checking data'

insert into [StrSource] 
([Ar],[En])
select  ' ','Auditing the report'

insert into [StrSource] 
([Ar],[En])
select  ' ','Checking permission'

insert into [StrSource] 
([Ar],[En])
select  '        ','Move terminated contracts that has uncollected cheques'

insert into [StrSource] 
([Ar],[En])
select  ' ','Closing File'

insert into [StrSource] 
([Ar],[En])
select  '  ','Close cards only'

insert into [StrSource] 
([Ar],[En])
select  '      ','Close all Data until the last operation date'

insert into [StrSource] 
([Ar],[En])
select  '        ','Close all data to specific date without move subsequent operations'

insert into [StrSource] 
([Ar],[En])
select  '        ','Close all data to specific date with move subsequent operations'

insert into [StrSource] 
([Ar],[En])
select  '  ','Close file to date'

insert into [StrSource] 
([Ar],[En])
select  '   ','Reminder for all users'

insert into [StrSource] 
([Ar],[En])
select  '   ','Reminder for current user only'

insert into [StrSource] 
([Ar],[En])
select  ' ','Ascending order'

insert into [StrSource] 
([Ar],[En])
select  ' ','Descending order'

insert into [StrSource] 
([Ar],[En])
select  ' ','Message Translate'

insert into [StrSource] 
([Ar],[En])
select  '  ','Post to store'

insert into [StrSource] 
([Ar],[En])
select  '   ','Post to store automatically'

insert into [StrSource] 
([Ar],[En])
select  '','Post'

insert into [StrSource] 
([Ar],[En])
select  ' ','Post cheque'

insert into [StrSource] 
([Ar],[En])
select  ' ','Post bill'

insert into [StrSource] 
([Ar],[En])
select  '   ','Post journal entry automatically'

insert into [StrSource] 
([Ar],[En])
select  ' ','Municipal licensing'

insert into [StrSource] 
([Ar],[En])
select  '   ','Municipality license to date'

insert into [StrSource] 
([Ar],[En])
select  '   ','Municipality license from date'

insert into [StrSource] 
([Ar],[En])
select  '  ','Civil defense licensing'

insert into [StrSource] 
([Ar],[En])
select  '    ','Civil defense license to date'

insert into [StrSource] 
([Ar],[En])
select  '    ','Civil defense license from date'

insert into [StrSource] 
([Ar],[En])
select  ' ','Login'

insert into [StrSource] 
([Ar],[En])
select  '   ','Register owners Associations fees'

insert into [StrSource] 
([Ar],[En])
select  ' ','Customer serial'

insert into [StrSource] 
([Ar],[En])
select  ' ','Sequence cheque'

insert into [StrSource] 
([Ar],[En])
select  ' ','Lawsuit delivery'

insert into [StrSource] 
([Ar],[En])
select  ' ','Generate notes'

insert into [StrSource] 
([Ar],[En])
select  '  ','Arabic generate note'

insert into [StrSource] 
([Ar],[En])
select  '  ','Latin generate note'

insert into [StrSource] 
([Ar],[En])
select  '','Ascending'

insert into [StrSource] 
([Ar],[En])
select  ' csv ','Export csv '

insert into [StrSource] 
([Ar],[En])
select  ' csv ...','Export csv ...'

insert into [StrSource] 
([Ar],[En])
select  ' html','Export html'

insert into [StrSource] 
([Ar],[En])
select  ' html.....','Export html.....'

insert into [StrSource] 
([Ar],[En])
select  ' txt','Export to TXT'

insert into [StrSource] 
([Ar],[En])
select  ' xls','Export to xls'

insert into [StrSource] 
([Ar],[En])
select  ' xls ...','Export xls ...'

insert into [StrSource] 
([Ar],[En])
select  '  ','Export to excel file'

insert into [StrSource] 
([Ar],[En])
select  '  ','Export customized Excel'

insert into [StrSource] 
([Ar],[En])
select  '  XLS','Export table to XLS'

insert into [StrSource] 
([Ar],[En])
select  ' ','Validate the contract'

insert into [StrSource] 
([Ar],[En])
select  '','filtering'

insert into [StrSource] 
([Ar],[En])
select  '  ','Filter report by'

insert into [StrSource] 
([Ar],[En])
select  '','Design'

insert into [StrSource] 
([Ar],[En])
select  '  ','Design printed receipt'

insert into [StrSource] 
([Ar],[En])
select  ' ','Area classification'

insert into [StrSource] 
([Ar],[En])
select  '  ','Financial statements classification'

insert into [StrSource] 
([Ar],[En])
select  '','Relief'

insert into [StrSource] 
([Ar],[En])
select  '  ','Include partial collection'

insert into [StrSource] 
([Ar],[En])
select  ' ','Include fonts'

insert into [StrSource] 
([Ar],[En])
select  '','Apply'

insert into [StrSource] 
([Ar],[En])
select  ' ','Apply changes'

insert into [StrSource] 
([Ar],[En])
select  ' ','Apple variables'

insert into [StrSource] 
([Ar],[En])
select  ' ','Real estate development'

insert into [StrSource] 
([Ar],[En])
select  '','Endorsement'

insert into [StrSource] 
([Ar],[En])
select  ' ','Cheque endorsement'

insert into [StrSource] 
([Ar],[En])
select  ' ','Currency rate'

insert into [StrSource] 
([Ar],[En])
select  '','Modify'

insert into [StrSource] 
([Ar],[En])
select  ' ','Modify data'

insert into [StrSource] 
([Ar],[En])
select  '  ','Modify partial collection'

insert into [StrSource] 
([Ar],[En])
select  '    ','Modify contracts using default options'

insert into [StrSource] 
([Ar],[En])
select  ' ','Modify checked'

insert into [StrSource] 
([Ar],[En])
select  '  ','Modify Customer cards'

insert into [StrSource] 
([Ar],[En])
select  '    ','Modify clearance print date'

insert into [StrSource] 
([Ar],[En])
select  '  ','Modify others reminders'

insert into [StrSource] 
([Ar],[En])
select  '  ','Modify contract price'

insert into [StrSource] 
([Ar],[En])
select  '   ','Modify flat cost price'

insert into [StrSource] 
([Ar],[En])
select  '  ','Edit branch permissions'

insert into [StrSource] 
([Ar],[En])
select  '     ','Modify land contracts using default options'

insert into [StrSource] 
([Ar],[En])
select  '     ','Modify parking contracts using default options'

insert into [StrSource] 
([Ar],[En])
select  '        ','Modify delay fee value'

insert into [StrSource] 
([Ar],[En])
select  '  ','Modify flats specification'

insert into [StrSource] 
([Ar],[En])
select  '  ','Modify shops specification'

insert into [StrSource] 
([Ar],[En])
select  '  ','Modify Parking Specifications'

insert into [StrSource] 
([Ar],[En])
select  '  ','Modify commission'

insert into [StrSource] 
([Ar],[En])
select  '  ','Maintenance work card'

insert into [StrSource] 
([Ar],[En])
select  '  ','Change rental rates'

insert into [StrSource] 
([Ar],[En])
select  '  ','Change sell rates'

insert into [StrSource] 
([Ar],[En])
select  ' ','Change account'

insert into [StrSource] 
([Ar],[En])
select  '  1','Update 1st Price'

insert into [StrSource] 
([Ar],[En])
select  '  2','Update 2nd Price'

insert into [StrSource] 
([Ar],[En])
select  '  3','Update 3rd Price'

insert into [StrSource] 
([Ar],[En])
select  '  ','Change sell rate'

insert into [StrSource] 
([Ar],[En])
select  '   ','Change files path '

insert into [StrSource] 
([Ar],[En])
select  '   ...','Change the files path ...'

insert into [StrSource] 
([Ar],[En])
select  '  ','Change asset location'

insert into [StrSource] 
([Ar],[En])
select  ' ','Change accounts'

insert into [StrSource] 
([Ar],[En])
select  ' ','Change user'

insert into [StrSource] 
([Ar],[En])
select  '  ','Update price to'

insert into [StrSource] 
([Ar],[En])
select  '  ','Update every price to'

insert into [StrSource] 
([Ar],[En])
select  '  ','Change password'

insert into [StrSource] 
([Ar],[En])
select  '  ','Change printing folder'

insert into [StrSource] 
([Ar],[En])
select  '  ','Change files path'

insert into [StrSource] 
([Ar],[En])
select  '  ','Contract Details'

insert into [StrSource] 
([Ar],[En])
select  '  ','Meaning of return values'

insert into [StrSource] 
([Ar],[En])
select  '  ','Stores details'

insert into [StrSource] 
([Ar],[En])
select  ' 1','Detailed 1'

insert into [StrSource] 
([Ar],[En])
select  ' 2','Detailed 2'

insert into [StrSource] 
([Ar],[En])
select  ' 3','Detailed 3'

insert into [StrSource] 
([Ar],[En])
select  ' 4','Detailed 4'

insert into [StrSource] 
([Ar],[En])
select  '','Activate'

insert into [StrSource] 
([Ar],[En])
select  '  ','Active contract types'

insert into [StrSource] 
([Ar],[En])
select  '     ','Activating archive files within the database '

insert into [StrSource] 
([Ar],[En])
select  '      ...','Activate archiving file through data base  ...'

insert into [StrSource] 
([Ar],[En])
select  ' ','Active buildings'

insert into [StrSource] 
([Ar],[En])
select  ' ','Active date'

insert into [StrSource] 
([Ar],[En])
select  ' ','Active No'

insert into [StrSource] 
([Ar],[En])
select  '      ','Active others operations of the check when it is return'

insert into [StrSource] 
([Ar],[En])
select  ' ','Activate Branch System'

insert into [StrSource] 
([Ar],[En])
select  '       ','Active unrealized revenue account for same year'

insert into [StrSource] 
([Ar],[En])
select  '        ','Activating save files, documents and images in the database'

insert into [StrSource] 
([Ar],[En])
select  '  ','Active buildings permission'

insert into [StrSource] 
([Ar],[En])
select  '  ','Activate log file'

insert into [StrSource] 
([Ar],[En])
select  '  ','Activate log window'

insert into [StrSource] 
([Ar],[En])
select  '    ','Active log file with editing'

insert into [StrSource] 
([Ar],[En])
select  '','Reports'

insert into [StrSource] 
([Ar],[En])
select  ' SMS','SMS Reports'

insert into [StrSource] 
([Ar],[En])
select  ' ','Statistical reports'

insert into [StrSource] 
([Ar],[En])
select  '  ','Revenue reports'

insert into [StrSource] 
([Ar],[En])
select  ' ','Activity reports'

insert into [StrSource] 
([Ar],[En])
select  '   ','Offers reports'

insert into [StrSource] 
([Ar],[En])
select  ' ','Contract reports'

insert into [StrSource] 
([Ar],[En])
select  ' ','Managers Reports'

insert into [StrSource] 
([Ar],[En])
select  '    ','Stores report'

insert into [StrSource] 
([Ar],[En])
select  '      ','Realty units reports'

insert into [StrSource] 
([Ar],[En])
select  '  ','Estimate property value'

insert into [StrSource] 
([Ar],[En])
select  '  ','Flats revenue report'

insert into [StrSource] 
([Ar],[En])
select  '  SMS','SMS send report'

insert into [StrSource] 
([Ar],[En])
select  '  ','Maintenance orders report'

insert into [StrSource] 
([Ar],[En])
select  ' ','Buildings report'

insert into [StrSource] 
([Ar],[En])
select  ' ','Lands report'

insert into [StrSource] 
([Ar],[En])
select  '  ','Note papers report'

insert into [StrSource] 
([Ar],[En])
select  '   ','Due note papers report'

insert into [StrSource] 
([Ar],[En])
select  '  ','Revenues report'

insert into [StrSource] 
([Ar],[En])
select  ' ','Building Reports '

insert into [StrSource] 
([Ar],[En])
select  ' ','Reminder report'

insert into [StrSource] 
([Ar],[En])
select  ' ','Editing report'

insert into [StrSource] 
([Ar],[En])
select  ' ','Lawsuits report'

insert into [StrSource] 
([Ar],[En])
select  '  ','Lawsuit Report'

insert into [StrSource] 
([Ar],[En])
select  '  ','Overdue payments report'

insert into [StrSource] 
([Ar],[En])
select  '   SMS','SMS Report'

insert into [StrSource] 
([Ar],[En])
select  '  ','Snet SMS report'

insert into [StrSource] 
([Ar],[En])
select  ' ','Customers report'

insert into [StrSource] 
([Ar],[En])
select  ' ','Visits report'

insert into [StrSource] 
([Ar],[En])
select  ' ','Flat report'

insert into [StrSource] 
([Ar],[En])
select  '     ','Leased and non-leased flats report'

insert into [StrSource] 
([Ar],[En])
select  '     ','Sold and unsold flats report'

insert into [StrSource] 
([Ar],[En])
select  '       ','Flats and Shops report'

insert into [StrSource] 
([Ar],[En])
select  '      ','Non-leased flats and shops report'

insert into [StrSource] 
([Ar],[En])
select  '     ','leased flats and shops report'

insert into [StrSource] 
([Ar],[En])
select  '     ','Sold flats and shops report'

insert into [StrSource] 
([Ar],[En])
select  '      ','Non-sold flats and shops report'

insert into [StrSource] 
([Ar],[En])
select  ' ','Complaints report'

insert into [StrSource] 
([Ar],[En])
select  ' ','Cheque Report'

insert into [StrSource] 
([Ar],[En])
select  ' ','Villas report'

insert into [StrSource] 
([Ar],[En])
select  ' ','Shops report'

insert into [StrSource] 
([Ar],[En])
select  ' ','Parking report'

insert into [StrSource] 
([Ar],[En])
select  '     ','Leased and non-leased parking report'

insert into [StrSource] 
([Ar],[En])
select  '  ','Reserved units report'

insert into [StrSource] 
([Ar],[En])
select  '  ','Remind cards report'

insert into [StrSource] 
([Ar],[En])
select  '  ','Contracts deposit report'

insert into [StrSource] 
([Ar],[En])
select  '    ','Changes report of flats rent pricing'

insert into [StrSource] 
([Ar],[En])
select  '   ','Changes report of flats pricing'

insert into [StrSource] 
([Ar],[En])
select  '    ','Changes report of flats sell pricing'

insert into [StrSource] 
([Ar],[En])
select  '   ','Change asset location report'

insert into [StrSource] 
([Ar],[En])
select  '  ','Assets inventory report'

insert into [StrSource] 
([Ar],[En])
select  '  ','Contract cycle report'

insert into [StrSource] 
([Ar],[En])
select  '  ','Maintenance visits report'

insert into [StrSource] 
([Ar],[En])
select  '   ','Cheque buildings annual report'

insert into [StrSource] 
([Ar],[En])
select  '  ','Buildings offers report'

insert into [StrSource] 
([Ar],[En])
select  '  ','Lands offers report'

insert into [StrSource] 
([Ar],[En])
select  '  ','Quotations Report'

insert into [StrSource] 
([Ar],[En])
select  '  ','Flats offers report'

insert into [StrSource] 
([Ar],[En])
select  '  ','Villas offers report'

insert into [StrSource] 
([Ar],[En])
select  '  ','Shops offers report'

insert into [StrSource] 
([Ar],[En])
select  '  ','Asset operations report'

insert into [StrSource] 
([Ar],[En])
select  '  ','Electricity bills report'

insert into [StrSource] 
([Ar],[En])
select  '   ','Cost centers cross report'

insert into [StrSource] 
([Ar],[En])
select  '   ','Shrink database'

insert into [StrSource] 
([Ar],[En])
select  ' ','Assess furniture'

insert into [StrSource] 
([Ar],[En])
select  ' ','Maximize windows'

insert into [StrSource] 
([Ar],[En])
select  ' ','Situation recurrence'

insert into [StrSource] 
([Ar],[En])
select  ' ','Building cost'

insert into [StrSource] 
([Ar],[En])
select  ' ','Flats cost'

insert into [StrSource] 
([Ar],[En])
select  '','AC'

insert into [StrSource] 
([Ar],[En])
select  '','Done'

insert into [StrSource] 
([Ar],[En])
select  '      ','Signed contract has been received from both sides'

insert into [StrSource] 
([Ar],[En])
select  '     ','Last backup was taken since'

insert into [StrSource] 
([Ar],[En])
select  '    ','Data backup successfully done'

insert into [StrSource] 
([Ar],[En])
select  '  SMS','SMS was sent successfully'

insert into [StrSource] 
([Ar],[En])
select  '  ','Message has been sent'

insert into [StrSource] 
([Ar],[En])
select  '    ','Contract sent to registration'

insert into [StrSource] 
([Ar],[En])
select  '  :','Replaced data :'

insert into [StrSource] 
([Ar],[En])
select  '    ','Data restore successfully done'

insert into [StrSource] 
([Ar],[En])
select  '  ','Deposits has been retrieved'

insert into [StrSource] 
([Ar],[En])
select  '     ','Registered contract has been received from customer'

insert into [StrSource] 
([Ar],[En])
select  '   ','Contract checking has been canceled'

insert into [StrSource] 
([Ar],[En])
select  ' ','Terminated'

insert into [StrSource] 
([Ar],[En])
select  '   ','Lawsuite termination on'

insert into [StrSource] 
([Ar],[En])
select  '  ','Contract was terminated'

insert into [StrSource] 
([Ar],[En])
select  '  ','Deposit has been returned'

insert into [StrSource] 
([Ar],[En])
select  '    ','Contract has been received for send it to registration'

insert into [StrSource] 
([Ar],[En])
select  '    ','Contract have been received from credence'

insert into [StrSource] 
([Ar],[En])
select  '    ','Contract received from customer'

insert into [StrSource] 
([Ar],[En])
select  ' ','Evacuated'

insert into [StrSource] 
([Ar],[En])
select  ' ','Sent'

insert into [StrSource] 
([Ar],[En])
select  '  ','Sent to registration'

insert into [StrSource] 
([Ar],[En])
select  '   ','Retrieved from customer'

insert into [StrSource] 
([Ar],[En])
select  '   ','Received from registration'

insert into [StrSource] 
([Ar],[En])
select  ' ','Data has been imported'

insert into [StrSource] 
([Ar],[En])
select  '    : ','Created by User'

insert into [StrSource] 
([Ar],[En])
select  ' ','Received'

insert into [StrSource] 
([Ar],[En])
select  ' ','Deposited'

insert into [StrSource] 
([Ar],[En])
select  ' ','Has been renewal'

insert into [StrSource] 
([Ar],[En])
select  '  ','Redirected to'

insert into [StrSource] 
([Ar],[En])
select  '        ,   ','Data has been modified by another user, the data will be updated'

insert into [StrSource] 
([Ar],[En])
select  ' ','Implemented'

insert into [StrSource] 
([Ar],[En])
select  ' ','Renewal has been done'

insert into [StrSource] 
([Ar],[En])
select  ' ','Update done'

insert into [StrSource] 
([Ar],[En])
select  '   ','Prices have been updated'

insert into [StrSource] 
([Ar],[En])
select  '       ','Fees has been collected by receipt order'

insert into [StrSource] 
([Ar],[En])
select  '    ','Contract delivered to customer'

insert into [StrSource] 
([Ar],[En])
select  '   ','Contract has been delivered to customer'

insert into [StrSource] 
([Ar],[En])
select  '    ','Registered contract has been delivered to customer'

insert into [StrSource] 
([Ar],[En])
select  '  : ','It has been modified'

insert into [StrSource] 
([Ar],[En])
select  '      ,     ','Salesman name has been modified, do you want to modify the account name?'

insert into [StrSource] 
([Ar],[En])
select  '      ,     ','Building name has been modified by you, do you want to modify account name?'

insert into [StrSource] 
([Ar],[En])
select  '      ,       ','Building name has been modified by you, do you want to modify cost center account name?'

insert into [StrSource] 
([Ar],[En])
select  '      ,     ','Customer name has been modified by you, do you want to modify account name?'

insert into [StrSource] 
([Ar],[En])
select  '      ,      ','Customer name has been modified by you, do you want to modify deposit account name?'

insert into [StrSource] 
([Ar],[En])
select  '   ','Status has been modified successfully'

insert into [StrSource] 
([Ar],[En])
select  '      ,      ','Security level has been modified for this account, do you want to change it for the sons?'

insert into [StrSource] 
([Ar],[En])
select  '        ','Flat number has been changed, do you want to change cost center account name?'

insert into [StrSource] 
([Ar],[En])
select  '        ','Shop No has been modified do you want to modify cost center?'

insert into [StrSource] 
([Ar],[En])
select  '    ','Password was modified successfully'

insert into [StrSource] 
([Ar],[En])
select  '      ','Calculation method has been defined for this group'

insert into [StrSource] 
([Ar],[En])
select  ' ','Changes has been done'

insert into [StrSource] 
([Ar],[En])
select  '       ','Column places was changed ,Do you want to save changes?'

insert into [StrSource] 
([Ar],[En])
select  '  ','Contract registered'

insert into [StrSource] 
([Ar],[En])
select  '     ','The contract was signed by the customer'

insert into [StrSource] 
([Ar],[En])
select  '     ','The contract was signed by the owner'

insert into [StrSource] 
([Ar],[En])
select  '  ','Contract printed'

insert into [StrSource] 
([Ar],[En])
select  '   ','Clearance Printed'

insert into [StrSource] 
([Ar],[En])
select  '   ','Extension paper printed'

insert into [StrSource] 
([Ar],[En])
select  '    ','Contract printed and authorized'

insert into [StrSource] 
([Ar],[En])
select  '  ','Contract checking has been done'

insert into [StrSource] 
([Ar],[En])
select  '  ','Return was handled'

insert into [StrSource] 
([Ar],[En])
select  ' ','Transfer has been done'

insert into [StrSource] 
([Ar],[En])
select  '  ','Execution stop on'

insert into [StrSource] 
([Ar],[En])
select  '  ','Operation successfully complete'

insert into [StrSource] 
([Ar],[En])
select  ' ','Processed'

insert into [StrSource] 
([Ar],[En])
select  '   ','Closing files process has successfully complete'

insert into [StrSource] 
([Ar],[En])
select  '  ','Activation has been applied'

insert into [StrSource] 
([Ar],[En])
select  '  ','Maintenance done'

insert into [StrSource] 
([Ar],[En])
select  '   ','Deactivation has been applied'

insert into [StrSource] 
([Ar],[En])
select  '          ','This process enables you to re-write details of selected checks'

insert into [StrSource] 
([Ar],[En])
select  '          
  ','This process enables you to re-write details of selected checks
Do you want to continue?'

insert into [StrSource] 
([Ar],[En])
select  '','Descending'

insert into [StrSource] 
([Ar],[En])
select  '     ','Alert for due payble cheque before'

insert into [StrSource] 
([Ar],[En])
select  '     :','Alert for due receivable cheque before'

insert into [StrSource] 
([Ar],[En])
select  '     ','Alert for units will be vacated before'

insert into [StrSource] 
([Ar],[En])
select  '   ','Alert maintenance visits before'

insert into [StrSource] 
([Ar],[En])
select  '     ','Alert for contracts expiry before'

insert into [StrSource] 
([Ar],[En])
select  '    ','Alert for due payble cheques before:'

insert into [StrSource] 
([Ar],[En])
select  '    ','Alert for due receivable cheques before:'

insert into [StrSource] 
([Ar],[En])
select  '    ','Alert for contracts expiry before:'

insert into [StrSource] 
([Ar],[En])
select  ' SMS','SMS Alerts'

insert into [StrSource] 
([Ar],[En])
select  ' ','Numbers format'

insert into [StrSource] 
([Ar],[En])
select  ' ','Date format'

insert into [StrSource] 
([Ar],[En])
select  ' ','Windows format'

insert into [StrSource] 
([Ar],[En])
select  ' ','Specific format'

insert into [StrSource] 
([Ar],[En])
select  ' ','Implementation of operations'

insert into [StrSource] 
([Ar],[En])
select  ' ','Create Windows'

insert into [StrSource] 
([Ar],[En])
select  ' ','Contract registration'

insert into [StrSource] 
([Ar],[En])
select  ' ','Profit distribution'

insert into [StrSource] 
([Ar],[En])
select  ' ','Amount distribution'

insert into [StrSource] 
([Ar],[En])
select  '','Distributive'

insert into [StrSource] 
([Ar],[En])
select  '  ','Expand all columns'

insert into [StrSource] 
([Ar],[En])
select  ' ','Tables description'

insert into [StrSource] 
([Ar],[En])
select  '  ','Extra fields description'

insert into [StrSource] 
([Ar],[En])
select  ' ','Generate journal entry'

insert into [StrSource] 
([Ar],[En])
select  '   ','Generate journal entry automatically'

insert into [StrSource] 
([Ar],[En])
select  '  ','Generate checks'

insert into [StrSource] 
([Ar],[En])
select  '    ','Generate checks by plan'

insert into [StrSource] 
([Ar],[En])
select  '  ','Generate cheques'

insert into [StrSource] 
([Ar],[En])
select  ' ','Generating flats'

insert into [StrSource] 
([Ar],[En])
select  '  ','Generate servants flats'

insert into [StrSource] 
([Ar],[En])
select  '  ','Generate drivers flats'

insert into [StrSource] 
([Ar],[En])
select  ' ','Generat voucher'

insert into [StrSource] 
([Ar],[En])
select  '    ','Generate entries for contracts without exist entry'

insert into [StrSource] 
([Ar],[En])
select  ' ','Generate All'

insert into [StrSource] 
([Ar],[En])
select  ' ','Generate shops'

insert into [StrSource] 
([Ar],[En])
select  ' ','Generate warehouses'

insert into [StrSource] 
([Ar],[En])
select  ' ','Generate offices'

insert into [StrSource] 
([Ar],[En])
select  ' ','Generate parking'

insert into [StrSource] 
([Ar],[En])
select  '      ','Generate obverse account details using lines details'

insert into [StrSource] 
([Ar],[En])
select  '  ','Generate journal voucher'

insert into [StrSource] 
([Ar],[En])
select  '  ','Generate servant appartments'

insert into [StrSource] 
([Ar],[En])
select  '  ','Generate driver flats'

insert into [StrSource] 
([Ar],[En])
select  '  ','Generate mizanin'

insert into [StrSource] 
([Ar],[En])
select  '   ','Generate pent house'

insert into [StrSource] 
([Ar],[En])
select  '   /      ','Allow to generate cheques even with the mismatch amount'

insert into [StrSource] 
([Ar],[En])
select  '    ','Generate cheques by plan'

insert into [StrSource] 
([Ar],[En])
select  ' ','Generate. Voucher'

insert into [StrSource] 
([Ar],[En])
select  '  ','Generate termination journal entry'

insert into [StrSource] 
([Ar],[En])
select  '   ','Auto Generate Voucher.'

insert into [StrSource] 
([Ar],[En])
select  '  ','Generate entry by type'

insert into [StrSource] 
([Ar],[En])
select  '     ','Generate journal entry on termination automatically'

insert into [StrSource] 
([Ar],[En])
select  '    ','Generate exchange rate journal entry'

insert into [StrSource] 
([Ar],[En])
select  '   ','Generate journal entry for each line'

insert into [StrSource] 
([Ar],[En])
select  '','Fixed'

insert into [StrSource] 
([Ar],[En])
select  '','Jada'

insert into [StrSource] 
([Ar],[En])
select  ' ','Processing'

insert into [StrSource] 
([Ar],[En])
select  '','New'

insert into [StrSource] 
([Ar],[En])
select  ' ','Assets inventory'

insert into [StrSource] 
([Ar],[En])
select  ' ','Materials inventory'

insert into [StrSource] 
([Ar],[En])
select  '  ','Warehouses detailed inventory'

insert into [StrSource] 
([Ar],[En])
select  '  ','Detailed Inventory report'

insert into [StrSource] 
([Ar],[En])
select  ' ','Jumada I'

insert into [StrSource] 
([Ar],[En])
select  ' ','Jumada II'

insert into [StrSource] 
([Ar],[En])
select  ' ','Customer nationality'

insert into [StrSource] 
([Ar],[En])
select  '','South'

insert into [StrSource] 
([Ar],[En])
select  ' ','Issuer'

insert into [StrSource] 
([Ar],[En])
select  '','Mobile'

insert into [StrSource] 
([Ar],[En])
select  ' ','Customer mobile'

insert into [StrSource] 
([Ar],[En])
select  '/ ','Extra A/C'

insert into [StrSource] 
([Ar],[En])
select  '/  ','Sanitation A/C'

insert into [StrSource] 
([Ar],[En])
select  '/  ','Revenue A/C'

insert into [StrSource] 
([Ar],[En])
select  '/   ','Currency differences A/C'

insert into [StrSource] 
([Ar],[En])
select  '/   ','Ending inventory A/C'

insert into [StrSource] 
([Ar],[En])
select  ' ','Watchman'

insert into [StrSource] 
([Ar],[En])
select  '  ','Contract input case'

insert into [StrSource] 
([Ar],[En])
select  '  ','Contract termination status'

insert into [StrSource] 
([Ar],[En])
select  ' ','Land status'

insert into [StrSource] 
([Ar],[En])
select  ' ','Termination status'

insert into [StrSource] 
([Ar],[En])
select  ' ','Leaasing status'

insert into [StrSource] 
([Ar],[En])
select  ' ','Garden status'

insert into [StrSource] 
([Ar],[En])
select  ' ','Lawsuite status'

insert into [StrSource] 
([Ar],[En])
select  ' ','Flat status'

insert into [StrSource] 
([Ar],[En])
select  ' ','Maintenance status'

insert into [StrSource] 
([Ar],[En])
select  ' ','Offer status'

insert into [StrSource] 
([Ar],[En])
select  ' ','Property status'

insert into [StrSource] 
([Ar],[En])
select  ' ','Contract status'

insert into [StrSource] 
([Ar],[En])
select  ' ','Villa status'

insert into [StrSource] 
([Ar],[En])
select  ' ','Parking status'

insert into [StrSource] 
([Ar],[En])
select  '  ','Cheque status'

insert into [StrSource] 
([Ar],[En])
select  '   ','Due time but not implement'

insert into [StrSource] 
([Ar],[En])
select  '  : ','Until:'

insert into [StrSource] 
([Ar],[En])
select  '','Reserve'

insert into [StrSource] 
([Ar],[En])
select  '    ','reserve quantity after adding order'

insert into [StrSource] 
([Ar],[En])
select  ' ','Property reservation'

insert into [StrSource] 
([Ar],[En])
select  ' ','Font size'

insert into [StrSource] 
([Ar],[En])
select  '  ','The following error occurred'

insert into [StrSource] 
([Ar],[En])
select  '  ','Select the user name'

insert into [StrSource] 
([Ar],[En])
select  '      ','Select cards that you want to create accounts'

insert into [StrSource] 
([Ar],[En])
select  ' ','Select building'

insert into [StrSource] 
([Ar],[En])
select  '   ','Select main account for customers'

insert into [StrSource] 
([Ar],[En])
select  '  ','Select main account'

insert into [StrSource] 
([Ar],[En])
select  '    ','Select the final accounts to be closed'

insert into [StrSource] 
([Ar],[En])
select  '    ','Select the flats you want to assemble'

insert into [StrSource] 
([Ar],[En])
select  '          :','Select the folder that will transfer all card files to it:'

insert into [StrSource] 
([Ar],[En])
select  '       ','Select the files that you want transfer it to selected folder'

insert into [StrSource] 
([Ar],[En])
select  '    ','Select main deposit account for customers'

insert into [StrSource] 
([Ar],[En])
select  '    ','Chose Debit / Credit account'

insert into [StrSource] 
([Ar],[En])
select  '  ','Select destination path'

insert into [StrSource] 
([Ar],[En])
select  '  ','Select source path'

insert into [StrSource] 
([Ar],[En])
select  '  ','Select ownership type'

insert into [StrSource] 
([Ar],[En])
select  '','Delete.'

insert into [StrSource] 
([Ar],[En])
select  '  ','Delete All'

insert into [StrSource] 
([Ar],[En])
select  ' ','Delete return'

insert into [StrSource] 
([Ar],[En])
select  '  ','Delete selected land'

insert into [StrSource] 
([Ar],[En])
select  '  ','Delete previous data'

insert into [StrSource] 
([Ar],[En])
select  ' ','Delete collection'

insert into [StrSource] 
([Ar],[En])
select  '  ','Delete partial collection'

insert into [StrSource] 
([Ar],[En])
select  ' ','Delete deposit'

insert into [StrSource] 
([Ar],[En])
select  ' ','Delete endorsement'

insert into [StrSource] 
([Ar],[En])
select  ' ','Delete condition'

insert into [StrSource] 
([Ar],[En])
select  '  ','Delete selected flats'

insert into [StrSource] 
([Ar],[En])
select  ' ','Delete flats'

insert into [StrSource] 
([Ar],[En])
select  '  ','Delete servants flats'

insert into [StrSource] 
([Ar],[En])
select  ' ','Delete filter'

insert into [StrSource] 
([Ar],[En])
select  '  ','Delete selected line'

insert into [StrSource] 
([Ar],[En])
select  ' ','Delete journal entry'

insert into [StrSource] 
([Ar],[En])
select  '  ','Delete selected shop'

insert into [StrSource] 
([Ar],[En])
select  ' ','Delete shops'

insert into [StrSource] 
([Ar],[En])
select  '  ','Delete selected shops'

insert into [StrSource] 
([Ar],[En])
select  ' ','Delete checked'

insert into [StrSource] 
([Ar],[En])
select  ' ','Delete warehouses'

insert into [StrSource] 
([Ar],[En])
select  '  ','Delete selected reconciliation'

insert into [StrSource] 
([Ar],[En])
select  ' ','Delete offices'

insert into [StrSource] 
([Ar],[En])
select  ' ','Delete parking'

insert into [StrSource] 
([Ar],[En])
select  ' ','Delete location'

insert into [StrSource] 
([Ar],[En])
select  '  ','Delete selected parking'

insert into [StrSource] 
([Ar],[En])
select  '  ','Delete others reminders'

insert into [StrSource] 
([Ar],[En])
select  ' ','Delete row'

insert into [StrSource] 
([Ar],[En])
select  '  ','Delete servant appartments'

insert into [StrSource] 
([Ar],[En])
select  '  ','Delete drivers flats'

insert into [StrSource] 
([Ar],[En])
select  '  ','Delete mizanin'

insert into [StrSource] 
([Ar],[En])
select  '   ','Delete pent house'

insert into [StrSource] 
([Ar],[En])
select  ' ','Delete photos'

insert into [StrSource] 
([Ar],[En])
select  '','Activity'

insert into [StrSource] 
([Ar],[En])
select  '  ','Total material movement'

insert into [StrSource] 
([Ar],[En])
select  ' ','Land activity'

insert into [StrSource] 
([Ar],[En])
select  ' ','Flat activity'

insert into [StrSource] 
([Ar],[En])
select  ' ','Property activity'

insert into [StrSource] 
([Ar],[En])
select  '  ','Leased property activity'

insert into [StrSource] 
([Ar],[En])
select  '  ','Daily working report'

insert into [StrSource] 
([Ar],[En])
select  ' ','Villa activity'

insert into [StrSource] 
([Ar],[En])
select  ' ','Shop activity'

insert into [StrSource] 
([Ar],[En])
select  ' ','Parking activity'

insert into [StrSource] 
([Ar],[En])
select  ' ','Material activity'

insert into [StrSource] 
([Ar],[En])
select  '  ','Revaluation account'

insert into [StrSource] 
([Ar],[En])
select  ' ','Revenues Account'

insert into [StrSource] 
([Ar],[En])
select  '  ','Fees revenue account'

insert into [StrSource] 
([Ar],[En])
select  '   ','Contract registration revenue account'

insert into [StrSource] 
([Ar],[En])
select  '   ','Contract price revenue account'

insert into [StrSource] 
([Ar],[En])
select  '  ','Capital profit account'

insert into [StrSource] 
([Ar],[En])
select  ' ','Output account'

insert into [StrSource] 
([Ar],[En])
select  ' ','Input account'

insert into [StrSource] 
([Ar],[En])
select  ' ','Asset account'

insert into [StrSource] 
([Ar],[En])
select  ' ','Extra account'

insert into [StrSource] 
([Ar],[En])
select  ' ','Closing account'

insert into [StrSource] 
([Ar],[En])
select  ' ','Depreciation account'

insert into [StrSource] 
([Ar],[En])
select  '   ','Depreciation account to date'

insert into [StrSource] 
([Ar],[En])
select  ' ','Revenue account'

insert into [StrSource] 
([Ar],[En])
select  '   ','Unrealized revenue account'

insert into [StrSource] 
([Ar],[En])
select  ' ','Building A/C'

insert into [StrSource] 
([Ar],[En])
select  '  ','Land bank account'

insert into [StrSource] 
([Ar],[En])
select  '  ','Building bank A/C'

insert into [StrSource] 
([Ar],[En])
select  '  ','Villa bank A/C'

insert into [StrSource] 
([Ar],[En])
select  '  ','Bank account closed'

insert into [StrSource] 
([Ar],[En])
select  ' ','Deposit A/C'

insert into [StrSource] 
([Ar],[En])
select  '  ','Building deposit account'

insert into [StrSource] 
([Ar],[En])
select  ' ','Insuarance account'

insert into [StrSource] 
([Ar],[En])
select  ' ','Discount A/C'

insert into [StrSource] 
([Ar],[En])
select  ' ','Discount material'

insert into [StrSource] 
([Ar],[En])
select  '  ','Down payment A/C'

insert into [StrSource] 
([Ar],[En])
select  ' ','Fees account'

insert into [StrSource] 
([Ar],[En])
select  ' ','Customer account'

insert into [StrSource] 
([Ar],[En])
select  ' ','Commission account'

insert into [StrSource] 
([Ar],[En])
select  '   ','Commission from client A/C'

insert into [StrSource] 
([Ar],[En])
select  '    ','Commission from owner A/C'

insert into [StrSource] 
([Ar],[En])
select  ' ','Customer A/C'

insert into [StrSource] 
([Ar],[En])
select  ' ','Fines Account'

insert into [StrSource] 
([Ar],[En])
select  ' ','Villa account'

insert into [StrSource] 
([Ar],[En])
select  ' ','Electricity account'

insert into [StrSource] 
([Ar],[En])
select  ' ','Owner account'

insert into [StrSource] 
([Ar],[En])
select  '  ','Calculate due amount'

insert into [StrSource] 
([Ar],[En])
select  ' ','Project account'

insert into [StrSource] 
([Ar],[En])
select  ' ','Expense account'

insert into [StrSource] 
([Ar],[En])
select  ' ','Material account'

insert into [StrSource] 
([Ar],[En])
select  ' ','Supplier account'

insert into [StrSource] 
([Ar],[En])
select  ' ','Water account'

insert into [StrSource] 
([Ar],[En])
select  ' ','Calculate results'

insert into [StrSource] 
([Ar],[En])
select  ' ','Cash account'

insert into [StrSource] 
([Ar],[En])
select  '   1','Fees revenue account 1'

insert into [StrSource] 
([Ar],[En])
select  '   2','Fees revenue account 2'

insert into [StrSource] 
([Ar],[En])
select  '   3','Fees revenue account 3'

insert into [StrSource] 
([Ar],[En])
select  '   4','Fees revenue account 4'

insert into [StrSource] 
([Ar],[En])
select  '   5','Fees revenue account 5'

insert into [StrSource] 
([Ar],[En])
select  '  ','Fines revenue account'

insert into [StrSource] 
([Ar],[En])
select  '   ','Delay fines revenue A/C'

insert into [StrSource] 
([Ar],[En])
select  '   ','Contract registration revenue A/C'

insert into [StrSource] 
([Ar],[En])
select  '   ','Contract price revenue A/C'

insert into [StrSource] 
([Ar],[En])
select  '   ','Ending inventory account'

insert into [StrSource] 
([Ar],[En])
select  '  ','Calculate development cost'

insert into [StrSource] 
([Ar],[En])
select  ' ','Automatic calculate'

insert into [StrSource] 
([Ar],[En])
select  '  ','Capital lost account'

insert into [StrSource] 
([Ar],[En])
select  ' ','Credit account'

insert into [StrSource] 
([Ar],[En])
select  '  ','Building cash account'

insert into [StrSource] 
([Ar],[En])
select  '  ','Salesman commission account'

insert into [StrSource] 
([Ar],[En])
select  '   ','Calculate developed property value'

insert into [StrSource] 
([Ar],[En])
select  '  ','Depreciation accumulated account'

insert into [StrSource] 
([Ar],[En])
select  ' ','Debit account'

insert into [StrSource] 
([Ar],[En])
select  '  ','Commission expense account'

insert into [StrSource] 
([Ar],[En])
select  ' ','Building account'

insert into [StrSource] 
([Ar],[En])
select  ' ','Fees Accounts'

insert into [StrSource] 
([Ar],[En])
select  ' ','Customers account'

insert into [StrSource] 
([Ar],[En])
select  '  ','Cheque accounts'

insert into [StrSource] 
([Ar],[En])
select  '   1','Fees revenue accounts 1'

insert into [StrSource] 
([Ar],[En])
select  '   2','Fees revenue accounts 2'

insert into [StrSource] 
([Ar],[En])
select  '   3','Fees revenue accounts 3'

insert into [StrSource] 
([Ar],[En])
select  ' ','Multiple accounts'

insert into [StrSource] 
([Ar],[En])
select  ' ','by'

insert into [StrSource] 
([Ar],[En])
select  ' ','By date'

insert into [StrSource] 
([Ar],[En])
select  ' ','By Country'

insert into [StrSource] 
([Ar],[En])
select  ' ','By plan'

insert into [StrSource] 
([Ar],[En])
select  '  ','By days number'

insert into [StrSource] 
([Ar],[En])
select  '  ','Discount on'

insert into [StrSource] 
([Ar],[En])
select  ' ','Block card'

insert into [StrSource] 
([Ar],[En])
select  '   ','Block card in all transactions'

insert into [StrSource] 
([Ar],[En])
select  '  ','Block card in contracts'

insert into [StrSource] 
([Ar],[En])
select  '  ','Save photo with extension'

insert into [StrSource] 
([Ar],[En])
select  '','Save'

insert into [StrSource] 
([Ar],[En])
select  ' XML','Save as XML'

insert into [StrSource] 
([Ar],[En])
select  '  ','Save entry lines'

insert into [StrSource] 
([Ar],[En])
select  ' ','Save settings'

insert into [StrSource] 
([Ar],[En])
select  ' ','Saving data'

insert into [StrSource] 
([Ar],[En])
select  ' ','Save checked'

insert into [StrSource] 
([Ar],[En])
select  '  ','Save picture as'

insert into [StrSource] 
([Ar],[En])
select  ' ','Save all'

insert into [StrSource] 
([Ar],[En])
select  ' ','Save note'

insert into [StrSource] 
([Ar],[En])
select  ' ','Temporary save'

insert into [StrSource] 
([Ar],[En])
select  'C:\Users\Public\Pictures\Sample Pictures\Desertjpg','saveC:\Users\Public\Pictures\Sample Pictures\Desertjpg'

insert into [StrSource] 
([Ar],[En])
select  '','Field'

insert into [StrSource] 
([Ar],[En])
select  '  1','Field 1'

insert into [StrSource] 
([Ar],[En])
select  '  2','Field 2'

insert into [StrSource] 
([Ar],[En])
select  '  3','Field 3'

insert into [StrSource] 
([Ar],[En])
select  '  4','Field 4'

insert into [StrSource] 
([Ar],[En])
select  '  5','Field 5'

insert into [StrSource] 
([Ar],[En])
select  '  6','Field 6'

insert into [StrSource] 
([Ar],[En])
select  '  7','Field 7'

insert into [StrSource] 
([Ar],[En])
select  '   1','Customer information 1'

insert into [StrSource] 
([Ar],[En])
select  '   2','Customer information 2'

insert into [StrSource] 
([Ar],[En])
select  '   3','Customer information 3'

insert into [StrSource] 
([Ar],[En])
select  '   4','Customer information 4'

insert into [StrSource] 
([Ar],[En])
select  '   5','Customer information 5'

insert into [StrSource] 
([Ar],[En])
select  '   6','Customer information 6'

insert into [StrSource] 
([Ar],[En])
select  '   7','Customer information 7'

insert into [StrSource] 
([Ar],[En])
select  '   1','Customer field 1'

insert into [StrSource] 
([Ar],[En])
select  '   2','Customer field 2'

insert into [StrSource] 
([Ar],[En])
select  '   3','Customer field 3'

insert into [StrSource] 
([Ar],[En])
select  '   4','Customer field 4'

insert into [StrSource] 
([Ar],[En])
select  '   5','Customer field 5'

insert into [StrSource] 
([Ar],[En])
select  '   6','Customer field 6'

insert into [StrSource] 
([Ar],[En])
select  '   7','Customer field 7'

insert into [StrSource] 
([Ar],[En])
select  ' ','Extra fields'

insert into [StrSource] 
([Ar],[En])
select  ' ','Bill fields'

insert into [StrSource] 
([Ar],[En])
select  ' ','About program'

insert into [StrSource] 
([Ar],[En])
select  '  ','Outside urban boundary'

insert into [StrSource] 
([Ar],[En])
select  '  ','Out of control'

insert into [StrSource] 
([Ar],[En])
select  '','Private'

insert into [StrSource] 
([Ar],[En])
select  '  ','Specified for current user'

insert into [StrSource] 
([Ar],[En])
select  '','Vacant'

insert into [StrSource] 
([Ar],[En])
select  '','Closing'

insert into [StrSource] 
([Ar],[En])
select  ' ','General Services'

insert into [StrSource] 
([Ar],[En])
select  ' ','Available services'

insert into [StrSource] 
([Ar],[En])
select  '','Services'

insert into [StrSource] 
([Ar],[En])
select  '','Exit'

insert into [StrSource] 
([Ar],[En])
select  ' ','Location map'

insert into [StrSource] 
([Ar],[En])
select  ' ','Detailed map'

insert into [StrSource] 
([Ar],[En])
select  ' ','Discount commission'

insert into [StrSource] 
([Ar],[En])
select  ' ','Permission error'

insert into [StrSource] 
([Ar],[En])
select  '   ','Error in the file name'

insert into [StrSource] 
([Ar],[En])
select  '   ','An error in settings file'

insert into [StrSource] 
([Ar],[En])
select  '     ','Generate journal entry at contract expiry option'

insert into [StrSource] 
([Ar],[En])
select  '','Options'

insert into [StrSource] 
([Ar],[En])
select  ' ','Report Option'

insert into [StrSource] 
([Ar],[En])
select  ' ','Entries option'

insert into [StrSource] 
([Ar],[En])
select  ' ','Bills option'

insert into [StrSource] 
([Ar],[En])
select  '','Crediit'

insert into [StrSource] 
([Ar],[En])
select  '  ','Inside urban boundary'

insert into [StrSource] 
([Ar],[En])
select  '','Enter'

insert into [StrSource] 
([Ar],[En])
select  ' ','Security degree'

insert into [StrSource] 
([Ar],[En])
select  '','Lawsuit.'

insert into [StrSource] 
([Ar],[En])
select  ' ','lawsuit'

insert into [StrSource] 
([Ar],[En])
select  '   ','Lawsuit on contract'

insert into [StrSource] 
([Ar],[En])
select  '   ','Lawsuit on unit'

insert into [StrSource] 
([Ar],[En])
select  '   ','Cost center general ledger'

insert into [StrSource] 
([Ar],[En])
select  '  ','Account General Ledger'

insert into [StrSource] 
([Ar],[En])
select  ' ','General ledger'

insert into [StrSource] 
([Ar],[En])
select  ' ','General Ledger'

insert into [StrSource] 
([Ar],[En])
select  ' ','Journal Ledger'

insert into [StrSource] 
([Ar],[En])
select  ' ','Contract payments report'

insert into [StrSource] 
([Ar],[En])
select  '   jpg','Jpg Resolution'

insert into [StrSource] 
([Ar],[En])
select  ' ','Chart of Asset'

insert into [StrSource] 
([Ar],[En])
select  ' ','Color list'

insert into [StrSource] 
([Ar],[En])
select  ' ','Cateries chart'

insert into [StrSource] 
([Ar],[En])
select  ' ','Chart of Accounts'

insert into [StrSource] 
([Ar],[En])
select  ' ','Chart of Branches'

insert into [StrSource] 
([Ar],[En])
select  ' ','Chart of Stores'

insert into [StrSource] 
([Ar],[En])
select  ' ','Chart of Materials'

insert into [StrSource] 
([Ar],[En])
select  '  ','Chart of cost center'

insert into [StrSource] 
([Ar],[En])
select  ' ','Contract cycle'

insert into [StrSource] 
([Ar],[En])
select  ' ','Without amount'

insert into [StrSource] 
([Ar],[En])
select  ' ','Zulhijjah'

insert into [StrSource] 
([Ar],[En])
select  ' ','Zulkaedah'

insert into [StrSource] 
([Ar],[En])
select  ' ','Capital'

insert into [StrSource] 
([Ar],[En])
select  ' ','Sending link'

insert into [StrSource] 
([Ar],[En])
select  '  ','Contact system administrator'

insert into [StrSource] 
([Ar],[En])
select  '   ','Link cheque with contracts'

insert into [StrSource] 
([Ar],[En])
select  '  ','Link user with salesman'

insert into [StrSource] 
([Ar],[En])
select  '    ','Link user with lawsuit status'

insert into [StrSource] 
([Ar],[En])
select  '    ','Link user with lawsuit expenses'

insert into [StrSource] 
([Ar],[En])
select  ' ','Linking documents'

insert into [StrSource] 
([Ar],[En])
select  ' ','Multi-Link'

insert into [StrSource] 
([Ar],[En])
select  ' ','Link with'

insert into [StrSource] 
([Ar],[En])
select  ' ','rabee al awwal'

insert into [StrSource] 
([Ar],[En])
select  ' ','rabee al thani'

insert into [StrSource] 
([Ar],[En])
select  '','Rajab'

insert into [StrSource] 
([Ar],[En])
select  '','Back'

insert into [StrSource] 
([Ar],[En])
select  ' ','Municipal license'

insert into [StrSource] 
([Ar],[En])
select  '  ','Civil Defense License'

insert into [StrSource] 
([Ar],[En])
select  '   ','New message'

insert into [StrSource] 
([Ar],[En])
select  ' 1','Fees 1'

insert into [StrSource] 
([Ar],[En])
select  ' 2','Fees 2'

insert into [StrSource] 
([Ar],[En])
select  ' 3','Fees 3'

insert into [StrSource] 
([Ar],[En])
select  ' 4','Fees 4'

insert into [StrSource] 
([Ar],[En])
select  ' 5','Fees 5'

insert into [StrSource] 
([Ar],[En])
select  ' ','Other fees'

insert into [StrSource] 
([Ar],[En])
select  '  ','Owners Associations fees'

insert into [StrSource] 
([Ar],[En])
select  ' ','Fines fees'

insert into [StrSource] 
([Ar],[En])
select  '  ','Contract registration value'

insert into [StrSource] 
([Ar],[En])
select  '  ','Contract price value'

insert into [StrSource] 
([Ar],[En])
select  ' ','Activity balance'

insert into [StrSource] 
([Ar],[En])
select  ' ','SMS Balance'

insert into [StrSource] 
([Ar],[En])
select  ' ','Customer balance'

insert into [StrSource] 
([Ar],[En])
select  '  ','Customer credit balance'

insert into [StrSource] 
([Ar],[En])
select  '    ','Customer balance is not equal to zero'

insert into [StrSource] 
([Ar],[En])
select  '  ','Customer debit balance'

insert into [StrSource] 
([Ar],[En])
select  '  ','Period credit balance'

insert into [StrSource] 
([Ar],[En])
select  '  ','Period debit balance'

insert into [StrSource] 
([Ar],[En])
select  ' ','Material balance'

insert into [StrSource] 
([Ar],[En])
select  ' ','Reconciliation balance'

insert into [StrSource] 
([Ar],[En])
select  ' ','Account balance'

insert into [StrSource] 
([Ar],[En])
select  '  ','Previous credit balance'

insert into [StrSource] 
([Ar],[En])
select  '  ','Previous debit balance'

insert into [StrSource] 
([Ar],[En])
select  '  ','Final credit balance'

insert into [StrSource] 
([Ar],[En])
select  '  ','Final debit balance'

insert into [StrSource] 
([Ar],[En])
select  '','number'

insert into [StrSource] 
([Ar],[En])
select  ' :','No:'

insert into [StrSource] 
([Ar],[En])
select  '  ','Entry origin No'

insert into [StrSource] 
([Ar],[En])
select  '  ','Maintenance order No'

insert into [StrSource] 
([Ar],[En])
select  ' ','Land No'

insert into [StrSource] 
([Ar],[En])
select  ' ','Origin No'

insert into [StrSource] 
([Ar],[En])
select  ' ','Residence No'

insert into [StrSource] 
([Ar],[En])
select  ' ','Receipt No'

insert into [StrSource] 
([Ar],[En])
select  '  ','Duplicate receipt number'

insert into [StrSource] 
([Ar],[En])
select  ' ','Card No'

insert into [StrSource] 
([Ar],[En])
select  '  : ','Card number:'

insert into [StrSource] 
([Ar],[En])
select  '  ','Customer card No'

insert into [StrSource] 
([Ar],[En])
select  ' ','Building No'

insert into [StrSource] 
([Ar],[En])
select  ' ','License No'

insert into [StrSource] 
([Ar],[En])
select  ' ','Registration number'

insert into [StrSource] 
([Ar],[En])
select  ' ','Report No'

insert into [StrSource] 
([Ar],[En])
select  '  ','Duplicate report number'

insert into [StrSource] 
([Ar],[En])
select  ' ','Execution No'

insert into [StrSource] 
([Ar],[En])
select  ' ','Session number'

insert into [StrSource] 
([Ar],[En])
select  ' ','Mobile Number'

insert into [StrSource] 
([Ar],[En])
select  ' ','Account No'

insert into [StrSource] 
([Ar],[En])
select  ' ','Basin No'

insert into [StrSource] 
([Ar],[En])
select  ' ','Lawsuit No'

insert into [StrSource] 
([Ar],[En])
select  ' ','Visit Number'

insert into [StrSource] 
([Ar],[En])
select  ' ','Ownership entry No'

insert into [StrSource] 
([Ar],[En])
select  ' ','Car plate No'

insert into [StrSource] 
([Ar],[En])
select  ' ','Shipping number'

insert into [StrSource] 
([Ar],[En])
select  ' ','Flat No'

insert into [StrSource] 
([Ar],[En])
select  '  / ','Flat / Shop No'

insert into [StrSource] 
([Ar],[En])
select  '  ','Related flat No'

insert into [StrSource] 
([Ar],[En])
select  ' ','Complaint No'

insert into [StrSource] 
([Ar],[En])
select  '  ','Complaint number duplicate'

insert into [StrSource] 
([Ar],[En])
select  ' ','Cheque No'

insert into [StrSource] 
([Ar],[En])
select  '  ','Cheque serial No'

insert into [StrSource] 
([Ar],[En])
select  '  ','Floor No between'

insert into [StrSource] 
([Ar],[En])
select  ' ','Meter number'

insert into [StrSource] 
([Ar],[En])
select  ' ','Quotation No'

insert into [StrSource] 
([Ar],[En])
select  ' ','Property No'

insert into [StrSource] 
([Ar],[En])
select  ' ','Contract No'

insert into [StrSource] 
([Ar],[En])
select  '  ','Contract serial No'

insert into [StrSource] 
([Ar],[En])
select  ' ','Bill number'

insert into [StrSource] 
([Ar],[En])
select  ' ','Fax No'

insert into [StrSource] 
([Ar],[En])
select  ' ','Villa No'

insert into [StrSource] 
([Ar],[En])
select  ' ','Plot No'

insert into [StrSource] 
([Ar],[En])
select  ' ','Area No'

insert into [StrSource] 
([Ar],[En])
select  '  ','Voucher Number'

insert into [StrSource] 
([Ar],[En])
select  '  ','Opening entry number'

insert into [StrSource] 
([Ar],[En])
select  '  ','Journal entry duplicate'

insert into [StrSource] 
([Ar],[En])
select  ' ','Shop No'

insert into [StrSource] 
([Ar],[En])
select  '  ','Duplicate shop number'

insert into [StrSource] 
([Ar],[En])
select  ' ','Planned No'

insert into [StrSource] 
([Ar],[En])
select  ' ','Parking No'

insert into [StrSource] 
([Ar],[En])
select  ' ','Phone No'

insert into [StrSource] 
([Ar],[En])
select  '  ','Customer ID No'

insert into [StrSource] 
([Ar],[En])
select  ' ','Unit No'

insert into [StrSource] 
([Ar],[En])
select  '  ','Labour card No'

insert into [StrSource] 
([Ar],[En])
select  '  ','Lessor card No'

insert into [StrSource] 
([Ar],[En])
select  '   ','ID card No'

insert into [StrSource] 
([Ar],[En])
select  '   ','ID card number duplicate'

insert into [StrSource] 
([Ar],[En])
select  '  ','Passport No'

insert into [StrSource] 
([Ar],[En])
select  '    ','Cusomter bank account No'

insert into [StrSource] 
([Ar],[En])
select  '  ','Journal entry No'

insert into [StrSource] 
([Ar],[En])
select  '  ','Electricity meter No'

insert into [StrSource] 
([Ar],[En])
select  '  ','Water meter No'

insert into [StrSource] 
([Ar],[En])
select  '  ','Business No'

insert into [StrSource] 
([Ar],[En])
select  '    ','Resident No and issued by'

insert into [StrSource] 
([Ar],[En])
select  ' ','Asset code'

insert into [StrSource] 
([Ar],[En])
select  ' ','Barcode code'

insert into [StrSource] 
([Ar],[En])
select  ' ','Building code'

insert into [StrSource] 
([Ar],[En])
select  ' ','Account code'

insert into [StrSource] 
([Ar],[En])
select  ' ','Material code'

insert into [StrSource] 
([Ar],[En])
select  ' ','Store code'

insert into [StrSource] 
([Ar],[En])
select  '  ','Cost center code'

insert into [StrSource] 
([Ar],[En])
select  '','Ramadan'

insert into [StrSource] 
([Ar],[En])
select  '','Cutomer'

insert into [StrSource] 
([Ar],[En])
select  ' ','Potential customer'

insert into [StrSource] 
([Ar],[En])
select  '   ','Increase in asset life'

insert into [StrSource] 
([Ar],[En])
select  ' ','Maintenance visits'

insert into [StrSource] 
([Ar],[En])
select  '  ','Due maintenance visits'

insert into [StrSource] 
([Ar],[En])
select  '  ','Maintenance contract visits'

insert into [StrSource] 
([Ar],[En])
select  ' ','Reminder time'

insert into [StrSource] 
([Ar],[En])
select  ' ','Return reason'

insert into [StrSource] 
([Ar],[En])
select  ' ','Delay reason'

insert into [StrSource] 
([Ar],[En])
select  '  ','Reason for non-implementation'

insert into [StrSource] 
([Ar],[En])
select  '             ','Report results will not be arranged properly and balance will not be different depending on selected sorting option'

insert into [StrSource] 
([Ar],[En])
select  '      :','All activities of this account will be transferred:'

insert into [StrSource] 
([Ar],[En])
select  '       :','All transactions of this cost center will be moved'

insert into [StrSource] 
([Ar],[En])
select  ' ','Commands log'

insert into [StrSource] 
([Ar],[En])
select  ' ','Desktop'

insert into [StrSource] 
([Ar],[En])
select  ' ','New row'

insert into [StrSource] 
([Ar],[En])
select  '','Price'

insert into [StrSource] 
([Ar],[En])
select  ' ','Rent price'

insert into [StrSource] 
([Ar],[En])
select  ' ','Rent price'

insert into [StrSource] 
([Ar],[En])
select  ' ','Selling Price'

insert into [StrSource] 
([Ar],[En])
select  '  1','Selling Price 1'

insert into [StrSource] 
([Ar],[En])
select  '  2','Selling Price 2'

insert into [StrSource] 
([Ar],[En])
select  '  3','Selling Price 3'

insert into [StrSource] 
([Ar],[En])
select  ' ','Contract price'

insert into [StrSource] 
([Ar],[En])
select  ' ','Cost price'

insert into [StrSource] 
([Ar],[En])
select  '  ','Price per square meter'

insert into [StrSource] 
([Ar],[En])
select  ' ','Specific price'

insert into [StrSource] 
([Ar],[En])
select  '','Year'

insert into [StrSource] 
([Ar],[En])
select  ' ','Built year'

insert into [StrSource] 
([Ar],[En])
select  ' ','Journal enrty'

insert into [StrSource] 
([Ar],[En])
select  ' ','Property deed'

insert into [StrSource] 
([Ar],[En])
select  ' ','Payment voucher'

insert into [StrSource] 
([Ar],[En])
select  ' ','Receipt  voucher'

insert into [StrSource] 
([Ar],[En])
select  ' ','Reciept voucher'

insert into [StrSource] 
([Ar],[En])
select  ' ','Journal Voucher'

insert into [StrSource] 
([Ar],[En])
select  '    ','Journal entry unbalanced'

insert into [StrSource] 
([Ar],[En])
select  ' ','Daily Voucher'

insert into [StrSource] 
([Ar],[En])
select  '','Vouchers'

insert into [StrSource] 
([Ar],[En])
select  ' ','Journal entries'

insert into [StrSource] 
([Ar],[En])
select  '    ','Payment vouchers'

insert into [StrSource] 
([Ar],[En])
select  '    ','Reciept vouchers'

insert into [StrSource] 
([Ar],[En])
select  '  ','Entries has origin'

insert into [StrSource] 
([Ar],[En])
select  '','Annual'

insert into [StrSource] 
([Ar],[En])
select  ' ','Last purchase'

insert into [StrSource] 
([Ar],[En])
select  '     ','Selected entries will be UnPosted'

insert into [StrSource] 
([Ar],[En])
select  '     ','Old value will be replaced by the New value'

insert into [StrSource] 
([Ar],[En])
select  '       ','Old value will be replaced by the New value, Do you want to continue?'

insert into [StrSource] 
([Ar],[En])
select  '   ','Previous data will be restored'

insert into [StrSource] 
([Ar],[En])
select  '    ','Customers data will be imported'

insert into [StrSource] 
([Ar],[En])
select  '    ','Selected checks will be added'

insert into [StrSource] 
([Ar],[En])
select  '      ','
Will be added to the securities specified Do you want to proceed'

insert into [StrSource] 
([Ar],[En])
select  '      ','Selected Cheques will be added
Do you want to continue?'

insert into [StrSource] 
([Ar],[En])
select  '      ','Selected flats building cards will be added'

insert into [StrSource] 
([Ar],[En])
select  '      ','Selected office building cards will be added'

insert into [StrSource] 
([Ar],[En])
select  '       ','Jobcost for selected building will be Recoded'

insert into [StrSource] 
([Ar],[En])
select  '       ','Jobcost for selected building will be Renamed'

insert into [StrSource] 
([Ar],[En])
select  '   ','Program will restart'

insert into [StrSource] 
([Ar],[En])
select  '    ','Journal entry will have new number'

insert into [StrSource] 
([Ar],[En])
select  '     ','All opened windows will closed'

insert into [StrSource] 
([Ar],[En])
select  '    ','User session will be terminated'

insert into [StrSource] 
([Ar],[En])
select  '   ','Selected contracts will be terminated'

insert into [StrSource] 
([Ar],[En])
select  '      ','All users will be stop working'

insert into [StrSource] 
([Ar],[En])
select  '          ','Last contract amount will be placed in flats rent changing'

insert into [StrSource] 
([Ar],[En])
select  '     ','SMS will be sent to each selected customer'

insert into [StrSource] 
([Ar],[En])
select  '    ','Generating entries will be processed'

insert into [StrSource] 
([Ar],[En])
select  '           ?','Regenerate entries will start now, this process may take a long time, do you continue?'

insert into [StrSource] 
([Ar],[En])
select  '  ','window will be closed'

insert into [StrSource] 
([Ar],[En])
select  '    ','Checking accounts balance will start now'

insert into [StrSource] 
([Ar],[En])
select  ' ','Contract will be renewed'

insert into [StrSource] 
([Ar],[En])
select  '   ','Select contracts will be renewed'

insert into [StrSource] 
([Ar],[En])
select  '       
  ','All prices of selected units wil be updated
Do you want to continue?'

insert into [StrSource] 
([Ar],[En])
select  '         ','Photos, files and documents will be loaded from the database'

insert into [StrSource] 
([Ar],[En])
select  '  ','Cards'

insert into [StrSource] 
([Ar],[En])
select  '  ','Reports'

insert into [StrSource] 
([Ar],[En])
select  '   : ','Till :'

insert into [StrSource] 
([Ar],[En])
select  '    : ','to date:'

insert into [StrSource] 
([Ar],[En])
select  '       ','Send a message automatically at return immediately'

insert into [StrSource] 
([Ar],[En])
select  '        ','Send a message automatically before the end of the contract'

insert into [StrSource] 
([Ar],[En])
select  ' ','Shortcuts'

insert into [StrSource] 
([Ar],[En])
select  ' ','Tools'

insert into [StrSource] 
([Ar],[En])
select  '   SMS','Short Message SMS'

insert into [StrSource] 
([Ar],[En])
select  '          ','Deactivate save files, documents and images in the database'

insert into [StrSource] 
([Ar],[En])
select  '  ','Journal Entry'

insert into [StrSource] 
([Ar],[En])
select  '   ','in addition to'

insert into [StrSource] 
([Ar],[En])
select  '   ','Reset Location'

insert into [StrSource] 
([Ar],[En])
select  '     ','Clearance printed by'

insert into [StrSource] 
([Ar],[En])
select  '       ','insert payable installment value after the sale of apartments'

insert into [StrSource] 
([Ar],[En])
select  '        ','Wrong username or password'

insert into [StrSource] 
([Ar],[En])
select  '  ','General Options'

insert into [StrSource] 
([Ar],[En])
select  ' ','Flat'

insert into [StrSource] 
([Ar],[En])
select  '   ','Except return reason'

insert into [StrSource] 
([Ar],[En])
select  '  ','Previous contracts'

insert into [StrSource] 
([Ar],[En])
select  '    SMS','Send SMS to maintenance worker'

insert into [StrSource] 
([Ar],[En])
select  '   ','Calculate quantity groups'

insert into [StrSource] 
([Ar],[En])
select  '        ','Demo version you can''t access this database'

insert into [StrSource] 
([Ar],[En])
select  '         ','Do you want to save the changes on the alarm printed coloumn ?'

insert into [StrSource] 
([Ar],[En])
select  '  ','To'

insert into [StrSource] 
([Ar],[En])
select  '    ','You must install new version'

insert into [StrSource] 
([Ar],[En])
select  '&','&Modify'

insert into [StrSource] 
([Ar],[En])
select  '& ','&Save'

insert into [StrSource] 
([Ar],[En])
select  '[A]  ','[A] Building Name'

insert into [StrSource] 
([Ar],[En])
select  '[A]   ','[A] CustomerArabic Name'

insert into [StrSource] 
([Ar],[En])
select  '[A]  [B]   [C]  [D] ','[A] Catery [B] Length [C] Width [D] Height'

insert into [StrSource] 
([Ar],[En])
select  '[A] ','[A] Account'

insert into [StrSource] 
([Ar],[En])
select  '[A]  ','[A] Voucher Date'

insert into [StrSource] 
([Ar],[En])
select  '[A]  ','[A] Paper No'

insert into [StrSource] 
([Ar],[En])
select  '[B]  ','[B] Building name'

insert into [StrSource] 
([Ar],[En])
select  '[B]   ','[B] Customer Latin  Name'

insert into [StrSource] 
([Ar],[En])
select  '[B]  ','[B] Contra Account'

insert into [StrSource] 
([Ar],[En])
select  '[B]  ','[B] Property No'

insert into [StrSource] 
([Ar],[En])
select  '[B]    ','[B] Voucher Card No'

insert into [StrSource] 
([Ar],[En])
select  '[B]  ','[B] paper Value'

insert into [StrSource] 
([Ar],[En])
select  '[C] ','[C] Value'

insert into [StrSource] 
([Ar],[En])
select  '[C]  ','[C] Due Date'

insert into [StrSource] 
([Ar],[En])
select  '[C]  ','[C] Flat Number'

insert into [StrSource] 
([Ar],[En])
select  '[C]    ','[C] Complaint No'

insert into [StrSource] 
([Ar],[En])
select  '[C]  ','[C] Property No'

insert into [StrSource] 
([Ar],[En])
select  '[C]   ','[C] ChequeValue'

insert into [StrSource] 
([Ar],[En])
select  '[C] ','[C] Debit'

insert into [StrSource] 
([Ar],[En])
select  '[C] ','[C] Customer name'

insert into [StrSource] 
([Ar],[En])
select  '[D]   ','[D] Building Arabic Name'

insert into [StrSource] 
([Ar],[En])
select  '[D]  ','[D] Bank Name'

insert into [StrSource] 
([Ar],[En])
select  '[D] ','[D] Credit'

insert into [StrSource] 
([Ar],[En])
select  '[D]    ','[D] Complaint Date'

insert into [StrSource] 
([Ar],[En])
select  '[D]   ','[D] Maintenance Order No'

insert into [StrSource] 
([Ar],[En])
select  '[D]   ','[D] Cheque No'

insert into [StrSource] 
([Ar],[En])
select  '[D]  ','[D] Contract No'

insert into [StrSource] 
([Ar],[En])
select  '[E]   ','[E]  Building Latin Name'

insert into [StrSource] 
([Ar],[En])
select  '[E]   ','[E] Recipient Name'

insert into [StrSource] 
([Ar],[En])
select  '[E]    ','[E] Building Arabic  Name'

insert into [StrSource] 
([Ar],[En])
select  '[E]    ','[E] Bank Name'

insert into [StrSource] 
([Ar],[En])
select  '[E] ','[E] Number'

insert into [StrSource] 
([Ar],[En])
select  '[E]  ','[E] Voucher Details'

insert into [StrSource] 
([Ar],[En])
select  '[E]  ','[E] Contract serial No'

insert into [StrSource] 
([Ar],[En])
select  '[F]   ','[F] Building latin name'

insert into [StrSource] 
([Ar],[En])
select  '[F]    ','[F] Building Latin  Name'

insert into [StrSource] 
([Ar],[En])
select  '[F]  ','[F] Line Details'

insert into [StrSource] 
([Ar],[En])
select  '[F]  ','[F] Due Date'

insert into [StrSource] 
([Ar],[En])
select  '[F]  ','[F] Issue Date'

insert into [StrSource] 
([Ar],[En])
select  '[G]   ','[G] Payee name'

insert into [StrSource] 
([Ar],[En])
select  '[G]   ','[G] Voucher Account Name'

insert into [StrSource] 
([Ar],[En])
select  '[G]   ','[G] Worker Name'

insert into [StrSource] 
([Ar],[En])
select  '[G]   ','[G] Contract expiry date'

insert into [StrSource] 
([Ar],[En])
select  '[G]   ','[G] Contract Starting Date'

insert into [StrSource] 
([Ar],[En])
select  '[G]   ','[G] Flat No'

insert into [StrSource] 
([Ar],[En])
select  '[H]  ','[H] Building Name'

insert into [StrSource] 
([Ar],[En])
select  '[H]   ','[H] Line Account Name'

insert into [StrSource] 
([Ar],[En])
select  '[H]   ','[H] Status'

insert into [StrSource] 
([Ar],[En])
select  '[H]   ','[H] Contract End Date'

insert into [StrSource] 
([Ar],[En])
select  '[H]  ','[H] Property No'

insert into [StrSource] 
([Ar],[En])
select  '[H]    ','[H] Contract No'

insert into [StrSource] 
([Ar],[En])
select  '[H]      ','[H] Worker Mobile No'

insert into [StrSource] 
([Ar],[En])
select  '[H]   ','[H] Customer latin name'

insert into [StrSource] 
([Ar],[En])
select  '[I]    ','[I] Arabic Building Name'

insert into [StrSource] 
([Ar],[En])
select  '[I]    ','[I] Expected completion date'

insert into [StrSource] 
([Ar],[En])
select  '[J]    ','[J] Latin Building Name'

insert into [StrSource] 
([Ar],[En])
select  '[J]  ','[J] Flat No'

insert into [StrSource] 
([Ar],[En])
select  '[J]  ','[J] Maintenance Starting Date'

insert into [StrSource] 
([Ar],[En])
select  '[K]  ','[K] Return Date'

insert into [StrSource] 
([Ar],[En])
select  '[K]  ','[K] Closing Date'

insert into [StrSource] 
([Ar],[En])
select  '[K]   ','[K] Collection Date'

insert into [StrSource] 
([Ar],[En])
select  '[K]  ','[K] Contract No'

insert into [StrSource] 
([Ar],[En])
select  '[L]   ','[L] Arabic worker name'

insert into [StrSource] 
([Ar],[En])
select  '[L] ','[L] Note'

insert into [StrSource] 
([Ar],[En])
select  '[L]  ','[L] Contract Value'

insert into [StrSource] 
([Ar],[En])
select  '[M]   ','[M] Latin pattern name'

insert into [StrSource] 
([Ar],[En])
select  '[M]   ','[M] Latin worker name'

insert into [StrSource] 
([Ar],[En])
select  '[M]   ','[M] Cheque serial no'

insert into [StrSource] 
([Ar],[En])
select  '[N]   ','[N] pattern arabic name'

insert into [StrSource] 
([Ar],[En])
select  '[N]   ','[N] Flat No'

insert into [StrSource] 
([Ar],[En])
select  '[N]   ','[N] Cheque Serial No'

insert into [StrSource] 
([Ar],[En])
select  '[N]  ','[N] Property No'

insert into [StrSource] 
([Ar],[En])
select  '[N]   ','[N] Contract Serial No'

insert into [StrSource] 
([Ar],[En])
select  '[N]  ','[N] Contract Place'

insert into [StrSource] 
([Ar],[En])
select  '      ','Data of this year will be transferred to new file'

insert into [StrSource] 
([Ar],[En])
select  '   ','Selected entries will be posted'

insert into [StrSource] 
([Ar],[En])
select  '  ','Changes will be applied'

insert into [StrSource] 
([Ar],[En])
select  '    ','Changes will be applied
Do you want to continue?'

insert into [StrSource] 
([Ar],[En])
select  '  ','Data will be modified'

insert into [StrSource] 
([Ar],[En])
select  '      ','All prices of selected building units wil be updated'

insert into [StrSource] 
([Ar],[En])
select  '      
  ','All prices of selected building units wil be updated
Do you want to continue?
'

insert into [StrSource] 
([Ar],[En])
select  '      ','Process will be implemented and will not be able to undo'

insert into [StrSource] 
([Ar],[En])
select  '       ','All related entries will be deleted'

insert into [StrSource] 
([Ar],[En])
select  '       ','All related cheque will be deleted'

insert into [StrSource] 
([Ar],[En])
select  '            ','All files will be deleted from the database, this operation can not be reversed'

insert into [StrSource] 
([Ar],[En])
select  '        ','All attached documents and images will be deleted from the database'

insert into [StrSource] 
([Ar],[En])
select  '      ','Selected files will be copied to the the new path'

insert into [StrSource] 
([Ar],[En])
select  '        ','All attached documents and images will be copied to the database'

insert into [StrSource] 
([Ar],[En])
select  '    ','This process will publish user permissions'

insert into [StrSource] 
([Ar],[En])
select  '   ','This process will move all cards'

insert into [StrSource] 
([Ar],[En])
select  '       ','Selected files will be transferred to the specified folder'

insert into [StrSource] 
([Ar],[En])
select  '     ','This process will stop dealing with the current data'

insert into [StrSource] 
([Ar],[En])
select  '       ','Balance will be different according to specific sorting'

insert into [StrSource] 
([Ar],[En])
select  '         ','This wizard will help you to close the file in an easy and safe way'

insert into [StrSource] 
([Ar],[En])
select  '','Purchase '

insert into [StrSource] 
([Ar],[En])
select  '','Condition'

insert into [StrSource] 
([Ar],[En])
select  '','East'

insert into [StrSource] 
([Ar],[En])
select  '','Company'

insert into [StrSource] 
([Ar],[En])
select  ' ','Payment terms'

insert into [StrSource] 
([Ar],[En])
select  ' ','Contract terms'

insert into [StrSource] 
([Ar],[En])
select  ' ','Amount terms'

insert into [StrSource] 
([Ar],[En])
select  ' ','Remind bar'

insert into [StrSource] 
([Ar],[En])
select  ' ','Notifications bar'

insert into [StrSource] 
([Ar],[En])
select  '','Shaban'

insert into [StrSource] 
([Ar],[En])
select  '','Flat .'

insert into [StrSource] 
([Ar],[En])
select  ' ','Assemblage flat'

insert into [StrSource] 
([Ar],[En])
select  '0101','Appartment 1010'

insert into [StrSource] 
([Ar],[En])
select  '','Apartments'

insert into [StrSource] 
([Ar],[En])
select  ' ','Building flats'

insert into [StrSource] 
([Ar],[En])
select  ' ','Servants flats'

insert into [StrSource] 
([Ar],[En])
select  ' ','Drivers flats'

insert into [StrSource] 
([Ar],[En])
select  '   ','Building shops / flats'

insert into [StrSource] 
([Ar],[En])
select  ' ','Maintenance complaint'

insert into [StrSource] 
([Ar],[En])
select  '','North'

insert into [StrSource] 
([Ar],[En])
select  '','month'

insert into [StrSource] 
([Ar],[En])
select  '','Monthly'

insert into [StrSource] 
([Ar],[En])
select  '','2 month'

insert into [StrSource] 
([Ar],[En])
select  '','Shawal'

insert into [StrSource] 
([Ar],[En])
select  '','cheque'

insert into [StrSource] 
([Ar],[En])
select  '  ','Cheque paid to'

insert into [StrSource] 
([Ar],[En])
select  '  ','Cheque received from'

insert into [StrSource] 
([Ar],[En])
select  '','Cheques'

insert into [StrSource] 
([Ar],[En])
select  '  ','cheques by plan'

insert into [StrSource] 
([Ar],[En])
select  ' ','Payable cheques'

insert into [StrSource] 
([Ar],[En])
select  ' ','Recievable cheques'

insert into [StrSource] 
([Ar],[En])
select  ' ','Due cheques'

insert into [StrSource] 
([Ar],[En])
select  ' ','Property owner'

insert into [StrSource] 
([Ar],[En])
select  ' ','Net loss'

insert into [StrSource] 
([Ar],[En])
select  ' ','Net profit'

insert into [StrSource] 
([Ar],[En])
select  '  ','Net due amount'

insert into [StrSource] 
([Ar],[En])
select  '    / ','Net due amount to Owner / Customer'

insert into [StrSource] 
([Ar],[En])
select  '  ','Net due amount for customer'

insert into [StrSource] 
([Ar],[En])
select  ' ','Sanitation'

insert into [StrSource] 
([Ar],[En])
select  ' ','Card pages'

insert into [StrSource] 
([Ar],[En])
select  '','Safar'

insert into [StrSource] 
([Ar],[En])
select  ' ','Buildings Permission'

insert into [StrSource] 
([Ar],[En])
select  ' ','Contracts permission'

insert into [StrSource] 
([Ar],[En])
select  ' ','Branches permissions'

insert into [StrSource] 
([Ar],[En])
select  ' ','Menu permissions'

insert into [StrSource] 
([Ar],[En])
select  ' ','POBox'

insert into [StrSource] 
([Ar],[En])
select  ' ','P.O.B'

insert into [StrSource] 
([Ar],[En])
select  '','Photos'

insert into [StrSource] 
([Ar],[En])
select  '','File maintenance'

insert into [StrSource] 
([Ar],[En])
select  ' ','Asset maintenance'

insert into [StrSource] 
([Ar],[En])
select  ' ','Units Maintenance'

insert into [StrSource] 
([Ar],[En])
select  '  ','Adjust columns width'

insert into [StrSource] 
([Ar],[En])
select  '  ','Compress backup'

insert into [StrSource] 
([Ar],[En])
select  '  ','Included previous years'

insert into [StrSource] 
([Ar],[En])
select  ' ','Mizanin floor'

insert into [StrSource] 
([Ar],[En])
select  '','Print'

insert into [StrSource] 
([Ar],[En])
select  '    ','Print unposted entreis origin'

insert into [StrSource] 
([Ar],[En])
select  ' ','Print receipt'

insert into [StrSource] 
([Ar],[En])
select  ' ','Print receipts'

insert into [StrSource] 
([Ar],[En])
select  ' ','Print warning'

insert into [StrSource] 
([Ar],[En])
select  ' ','Print log'

insert into [StrSource] 
([Ar],[En])
select  ' ','Print Reciept'

insert into [StrSource] 
([Ar],[En])
select  '  ','Clearance print'

insert into [StrSource] 
([Ar],[En])
select  '  ','Print clearance'

insert into [StrSource] 
([Ar],[En])
select  ' ','Print photo'

insert into [StrSource] 
([Ar],[En])
select  ' ','Custom print'

insert into [StrSource] 
([Ar],[En])
select  ' ','Nature of the land'

insert into [StrSource] 
([Ar],[En])
select  ' ','Nature area'

insert into [StrSource] 
([Ar],[En])
select  '  ','Quantity calculation methods'

insert into [StrSource] 
([Ar],[En])
select  '   ','Electricity calculation method'

insert into [StrSource] 
([Ar],[En])
select  ' ','Depreciation method'

insert into [StrSource] 
([Ar],[En])
select  ' ','Evaluation method'

insert into [StrSource] 
([Ar],[En])
select  ' ','Change type'

insert into [StrSource] 
([Ar],[En])
select  ' ','Calculation method'

insert into [StrSource] 
([Ar],[En])
select  '  ','Water calculation method'

insert into [StrSource] 
([Ar],[En])
select  ' ','Payment type'

insert into [StrSource] 
([Ar],[En])
select  '  ','Payment method in words'

insert into [StrSource] 
([Ar],[En])
select  ' ','Shipping Method'

insert into [StrSource] 
([Ar],[En])
select  '  ','Type of building owner ship'

insert into [StrSource] 
([Ar],[En])
select  '  ','Calculating quantity method'

insert into [StrSource] 
([Ar],[En])
select  ' ','Evacuation request'

insert into [StrSource] 
([Ar],[En])
select  '  ','Fence length'

insert into [StrSource] 
([Ar],[En])
select  '','Print.'

insert into [StrSource] 
([Ar],[En])
select  '     ','Show checks generation window when adding contract'

insert into [StrSource] 
([Ar],[En])
select  '','Normal'

insert into [StrSource] 
([Ar],[En])
select  '','High'

insert into [StrSource] 
([Ar],[En])
select  '','General'

insert into [StrSource] 
([Ar],[En])
select  '  ','For all users'

insert into [StrSource] 
([Ar],[En])
select  '  ','Worker maintenance order'

insert into [StrSource] 
([Ar],[En])
select  ' ','Exchange'

insert into [StrSource] 
([Ar],[En])
select  ' ','Maintenance worker'

insert into [StrSource] 
([Ar],[En])
select  '  ','Electricity current meter'

insert into [StrSource] 
([Ar],[En])
select  '  ','Electricity previous meter'

insert into [StrSource] 
([Ar],[En])
select  '  ','Water current meter'

insert into [StrSource] 
([Ar],[En])
select  '  ','Water previous meter'

insert into [StrSource] 
([Ar],[En])
select  '  ','Revenue days No'

insert into [StrSource] 
([Ar],[En])
select  '  ','Delay days No'

insert into [StrSource] 
([Ar],[En])
select  '   ','Delay days No between'

insert into [StrSource] 
([Ar],[En])
select  '  ','Number of days contract'

insert into [StrSource] 
([Ar],[En])
select  '  ','Number of leased land'

insert into [StrSource] 
([Ar],[En])
select  '   ','Number of non-leased land'

insert into [StrSource] 
([Ar],[En])
select  '    ','Number of digits after required comma'

insert into [StrSource] 
([Ar],[En])
select  '    ','Number of digits after optional comma'

insert into [StrSource] 
([Ar],[En])
select  ' ','Number of Installments'

insert into [StrSource] 
([Ar],[En])
select  ' ','Number of days'

insert into [StrSource] 
([Ar],[En])
select  '  ','Empty days No'

insert into [StrSource] 
([Ar],[En])
select  '  ','Remaining days No'

insert into [StrSource] 
([Ar],[En])
select  '     ','Remaining days number of reservation is smaller than'

insert into [StrSource] 
([Ar],[En])
select  '  ','Due days No'

insert into [StrSource] 
([Ar],[En])
select  '  ','Number of days from'

insert into [StrSource] 
([Ar],[En])
select  ' ','number of children'

insert into [StrSource] 
([Ar],[En])
select  ' ','Gardens No'

insert into [StrSource] 
([Ar],[En])
select  ' ','Bathroom No'

insert into [StrSource] 
([Ar],[En])
select  '  ','Late payments No'

insert into [StrSource] 
([Ar],[En])
select  ' ','Visits Count'

insert into [StrSource] 
([Ar],[En])
select  ' ','Working hours'

insert into [StrSource] 
([Ar],[En])
select  ' ','Residents count'

insert into [StrSource] 
([Ar],[En])
select  ' ','Number of Years'

insert into [StrSource] 
([Ar],[En])
select  ' ','Balcony No'

insert into [StrSource] 
([Ar],[En])
select  ' ','Flats count'

insert into [StrSource] 
([Ar],[En])
select  '     ','Number of flats has lawsuit'

insert into [StrSource] 
([Ar],[En])
select  '  ','Number of leased flats'

insert into [StrSource] 
([Ar],[En])
select  '   ','Number of non-leased flats'

insert into [StrSource] 
([Ar],[En])
select  '   ','Flats No in floor'

insert into [StrSource] 
([Ar],[En])
select  ' ','Streets No'

insert into [StrSource] 
([Ar],[En])
select  ' ','Floors count'

insert into [StrSource] 
([Ar],[En])
select  ' ','Number of contracts'

insert into [StrSource] 
([Ar],[En])
select  '  ','Current contracts No'

insert into [StrSource] 
([Ar],[En])
select  '[O]    ','[O] Latin building name'

insert into [StrSource] 
([Ar],[En])
select  '[O]  ','[O] Operation date'

insert into [StrSource] 
([Ar],[En])
select  '[P]    ','[P] Arabic building name'

insert into [StrSource] 
([Ar],[En])
select  '[P]   ','[P] Due End Date'

insert into [StrSource] 
([Ar],[En])
select  '[Q]  ','[Q] Problem description'

insert into [StrSource] 
([Ar],[En])
select  '[R]  ','[R] Customer mobile'

insert into [StrSource] 
([Ar],[En])
select  '[T]  ','[T] Issue date'

insert into [StrSource] 
([Ar],[En])
select  '[V]  ','[V] Collected amount'

insert into [StrSource] 
([Ar],[En])
select  '<>','<<   Next'

insert into [StrSource] 
([Ar],[En])
select  '< >','<Customer balance>'

insert into [StrSource] 
([Ar],[En])
select  '<  >','<Contract count days>'

insert into [StrSource] 
([Ar],[En])
select  '1    ','1   debit only'

insert into [StrSource] 
([Ar],[En])
select  '10 ','10 months'

insert into [StrSource] 
([Ar],[En])
select  '11 ','11 months'

insert into [StrSource] 
([Ar],[En])
select  '2    ','2   credit only'

insert into [StrSource] 
([Ar],[En])
select  '3     ','3   credit or debit'

insert into [StrSource] 
([Ar],[En])
select  '3 ','3 Months'

insert into [StrSource] 
([Ar],[En])
select  '4 ','4 months'

insert into [StrSource] 
([Ar],[En])
select  '5 ','5 months'

insert into [StrSource] 
([Ar],[En])
select  '6 ','6 Months'

insert into [StrSource] 
([Ar],[En])
select  '7 ','7 months'

insert into [StrSource] 
([Ar],[En])
select  '8 ','8 months'

insert into [StrSource] 
([Ar],[En])
select  '9 ','9 months'

insert into [StrSource] 
([Ar],[En])
select  'Selected checks will be added  ','Selected checks will be added, do you want to continue?'

insert into [StrSource] 
([Ar],[En])
select  'Warning !Selected flats building cards will be added  ','Warning !Selected flats building cards will be added, Do you want to continue ?'

insert into [StrSource] 
([Ar],[En])
select  '&','&Add'

insert into [StrSource] 
([Ar],[En])
select  '&','&Close'

insert into [StrSource] 
([Ar],[En])
select  ' ','Start Closing Books'

insert into [StrSource] 
([Ar],[En])
select  '','Start'

insert into [StrSource] 
([Ar],[En])
select  '    ','Keep documents in the original location'

insert into [StrSource] 
([Ar],[En])
select  ' ','Allow Import'

insert into [StrSource] 
([Ar],[En])
select  ' ','Hour fee'

insert into [StrSource] 
([Ar],[En])
select  '','Credit.'

insert into [StrSource] 
([Ar],[En])
select  '   ','Total rent after discount'

insert into [StrSource] 
([Ar],[En])
select  '   ','Total rent before discount'

insert into [StrSource] 
([Ar],[En])
select  ' ','Total Insurances'

insert into [StrSource] 
([Ar],[En])
select  ' ','Total Fees'

insert into [StrSource] 
([Ar],[En])
select  ' ','Total Invocie'

insert into [StrSource] 
([Ar],[En])
select  '  ','Total collected amount'

insert into [StrSource] 
([Ar],[En])
select  '  ','Total amount due'

insert into [StrSource] 
([Ar],[En])
select  '   ','Total amount due to owner'

insert into [StrSource] 
([Ar],[En])
select  '   ','Total uncollected amount'

insert into [StrSource] 
([Ar],[En])
select  ' ','Total collected'

insert into [StrSource] 
([Ar],[En])
select  ' ','Total paid'

insert into [StrSource] 
([Ar],[En])
select  '  ','Total development cost'

insert into [StrSource] 
([Ar],[En])
select  '  ','Total number of units'

insert into [StrSource] 
([Ar],[En])
select  '   ','Total Value Of Developed Property'

insert into [StrSource] 
([Ar],[En])
select  ' ','Maintenance fees'

insert into [StrSource] 
([Ar],[En])
select  ' ','Commission calculation '

insert into [StrSource] 
([Ar],[En])
select  '','Test'

insert into [StrSource] 
([Ar],[En])
select  '  ','Select file closing type'

insert into [StrSource] 
([Ar],[En])
select  ' ','Font test'

insert into [StrSource] 
([Ar],[En])
select  ' ','Choose path'

insert into [StrSource] 
([Ar],[En])
select  '   ','Last date of partial collection'

insert into [StrSource] 
([Ar],[En])
select  '    : ','Last modify by User:'

insert into [StrSource] 
([Ar],[En])
select  ' : ','Last modifiy:'

insert into [StrSource] 
([Ar],[En])
select  ' ','last price'

insert into [StrSource] 
([Ar],[En])
select  '  ','Customer last price'

insert into [StrSource] 
([Ar],[En])
select  ' ','Last purchase price'

insert into [StrSource] 
([Ar],[En])
select  '  ','Last meter reading'

insert into [StrSource] 
([Ar],[En])
select  '','Output'

insert into [StrSource] 
([Ar],[En])
select  '  ','Negative products output'

insert into [StrSource] 
([Ar],[En])
select  '  ','Output from'

insert into [StrSource] 
([Ar],[En])
select  '   ','Hide in search window'

insert into [StrSource] 
([Ar],[En])
select  ' ','Hide the file'

insert into [StrSource] 
([Ar],[En])
select  '','Management'

insert into [StrSource] 
([Ar],[En])
select  ' ','Land Management'

insert into [StrSource] 
([Ar],[En])
select  '      ','Types Manager'

insert into [StrSource] 
([Ar],[En])
select  ' ','MOSAI Manager'

insert into [StrSource] 
([Ar],[En])
select  ' ','Properties management'

insert into [StrSource] 
([Ar],[En])
select  ' ','Users Manager'

insert into [StrSource] 
([Ar],[En])
select  ' ','Real Estate Management'

insert into [StrSource] 
([Ar],[En])
select  '    ','Enter revenue contract registration account'

insert into [StrSource] 
([Ar],[En])
select  '    ','Enter contract registration revenue account'

insert into [StrSource] 
([Ar],[En])
select  '','Input'

insert into [StrSource] 
([Ar],[En])
select  '  ','Insurance required'

insert into [StrSource] 
([Ar],[En])
select  '  ','Add cash Voucher'

insert into [StrSource] 
([Ar],[En])
select  ' ','Input to'

insert into [StrSource] 
([Ar],[En])
select  '   ','Enter flat No'

insert into [StrSource] 
([Ar],[En])
select  '   ','Enter shop No'

insert into [StrSource] 
([Ar],[En])
select  '  ','Enter building name'

insert into [StrSource] 
([Ar],[En])
select  '  ','Enter account name'

insert into [StrSource] 
([Ar],[En])
select  '  ','Enter customer name'

insert into [StrSource] 
([Ar],[En])
select  '  ','Enter Username'

insert into [StrSource] 
([Ar],[En])
select  '  ','Enter file name'

insert into [StrSource] 
([Ar],[En])
select  '  ','Enter supplier name'

insert into [StrSource] 
([Ar],[En])
select  '   ','Enter property owner name'

insert into [StrSource] 
([Ar],[En])
select  '      ','Enter property owner name in building card'

insert into [StrSource] 
([Ar],[En])
select  '      ','Enter property owner name in property card'

insert into [StrSource] 
([Ar],[En])
select  '      ','Enter owner name in parking card'

insert into [StrSource] 
([Ar],[En])
select  '     : ','Enter property owner name to line:'

insert into [StrSource] 
([Ar],[En])
select  '      ','Enter parking owner name in parking card'

insert into [StrSource] 
([Ar],[En])
select  '      ','Enter User Name and Password to access the file'

insert into [StrSource] 
([Ar],[En])
select  ' ','Enter Name'

insert into [StrSource] 
([Ar],[En])
select  ' ','Enter Building'

insert into [StrSource] 
([Ar],[En])
select  '   ','Enter line details'

insert into [StrSource] 
([Ar],[En])
select  ' ','Enter date'

insert into [StrSource] 
([Ar],[En])
select  '   ','Enter date to line'

insert into [StrSource] 
([Ar],[En])
select  '    ','Enter rate to line'

insert into [StrSource] 
([Ar],[En])
select  ' ','Enter account'

insert into [StrSource] 
([Ar],[En])
select  '     ','Enter the default account for cash voucher type'

insert into [StrSource] 
([Ar],[En])
select  '     ','Enter default account for receipt voucher type'

insert into [StrSource] 
([Ar],[En])
select  '  ','Enter closing account'

insert into [StrSource] 
([Ar],[En])
select  '  ','Enter credit account'

insert into [StrSource] 
([Ar],[En])
select  '   ','Enter credit account of deposit'

insert into [StrSource] 
([Ar],[En])
select  '       ','Enter tenant''s Insurance  account in building card'

insert into [StrSource] 
([Ar],[En])
select  '      ','Enter tenant''s main account in building card'

insert into [StrSource] 
([Ar],[En])
select  '  ','Enter debit account'

insert into [StrSource] 
([Ar],[En])
select  '    ','Enter the credit account for the comission refunds'

insert into [StrSource] 
([Ar],[En])
select  '   ','Enter debit account for deposits'

insert into [StrSource] 
([Ar],[En])
select  '  ','Enter conta account'

insert into [StrSource] 
([Ar],[En])
select  '     ','Enter account in building card'

insert into [StrSource] 
([Ar],[En])
select  '   ','Enter the default accounts for this type'

insert into [StrSource] 
([Ar],[En])
select  ' ','Enter number'

insert into [StrSource] 
([Ar],[En])
select  ' ','Enter code'

insert into [StrSource] 
([Ar],[En])
select  '   ','Enter the code is numbers only'

insert into [StrSource] 
([Ar],[En])
select  ' ','Enter customer'

insert into [StrSource] 
([Ar],[En])
select  ' ','Enter year'

insert into [StrSource] 
([Ar],[En])
select  ' ','Enter Currency'

insert into [StrSource] 
([Ar],[En])
select  ' ','Enter branch'

insert into [StrSource] 
([Ar],[En])
select  ' ','Enter value'

insert into [StrSource] 
([Ar],[En])
select  '  ','Enter the first pattern'

insert into [StrSource] 
([Ar],[En])
select  '  ','Enter second pattern'

insert into [StrSource] 
([Ar],[En])
select  '   ','Enter beginning  period date'

insert into [StrSource] 
([Ar],[En])
select  '    ','Enter the new beginning  period date'

insert into [StrSource] 
([Ar],[En])
select  '  ','Enter due date'

insert into [StrSource] 
([Ar],[En])
select  '  ','Enter closing date'

insert into [StrSource] 
([Ar],[En])
select  '  ','Enter issue date'

insert into [StrSource] 
([Ar],[En])
select  '  ','Enter deposit date'

insert into [StrSource] 
([Ar],[En])
select  '  ','Enter purchase date'

insert into [StrSource] 
([Ar],[En])
select  '   ','Enter investment starting date'

insert into [StrSource] 
([Ar],[En])
select  '   ','Enter contract end date'

insert into [StrSource] 
([Ar],[En])
select  '  ','Enter currency rate'

insert into [StrSource] 
([Ar],[En])
select  '   ','Enter currency rate of investment'

insert into [StrSource] 
([Ar],[En])
select  '   ','Enter currency rate of purchase'

insert into [StrSource] 
([Ar],[En])
select  '  ','Enter file description'

insert into [StrSource] 
([Ar],[En])
select  '   ','Enter new file description'

insert into [StrSource] 
([Ar],[En])
select  '    ','Enter revenue account of other fees'

insert into [StrSource] 
([Ar],[En])
select  '    ','Enter revenue account of contract price'

insert into [StrSource] 
([Ar],[En])
select  '   ','Enter credit return account'

insert into [StrSource] 
([Ar],[En])
select  '   ','Enter debit return account'

insert into [StrSource] 
([Ar],[En])
select  '     ','Enter closing account of profit and loss'

insert into [StrSource] 
([Ar],[En])
select  '  ','Enter building account'

insert into [StrSource] 
([Ar],[En])
select  '  ','Enter insurance account'

insert into [StrSource] 
([Ar],[En])
select  '   ','Enter the credit collection account'

insert into [StrSource] 
([Ar],[En])
select  '   ','Enter debit collection account'

insert into [StrSource] 
([Ar],[En])
select  '  ','Enter discount account'

insert into [StrSource] 
([Ar],[En])
select  '   ','Enter down payment account'

insert into [StrSource] 
([Ar],[En])
select  '   ','Enter fees account for the line'

insert into [StrSource] 
([Ar],[En])
select  '  ','Enter cheques account'

insert into [StrSource] 
([Ar],[En])
select  '  ','Enter cash account'

insert into [StrSource] 
([Ar],[En])
select  '    ','Enter the commission from customer account'

insert into [StrSource] 
([Ar],[En])
select  '     ','Enter commission from building owner account'

insert into [StrSource] 
([Ar],[En])
select  '     ','Enter commission from property owner account'

insert into [StrSource] 
([Ar],[En])
select  '  ','Enter customer account'

insert into [StrSource] 
([Ar],[En])
select  '  ','Enter owner account'

insert into [StrSource] 
([Ar],[En])
select  '  ','Enter project account'

insert into [StrSource] 
([Ar],[En])
select  '  ','Enter the expense account'

insert into [StrSource] 
([Ar],[En])
select  '  ','Enter supplier account'

insert into [StrSource] 
([Ar],[En])
select  '      ','Enter owner account in property card'

insert into [StrSource] 
([Ar],[En])
select  '       ','Enter exchange rate account in program settings'

insert into [StrSource] 
([Ar],[En])
select  '  ','Enter account code'

insert into [StrSource] 
([Ar],[En])
select  '    ','Enter units for this building'

insert into [StrSource] 
([Ar],[En])
select  '  ','Enter investment currency'

insert into [StrSource] 
([Ar],[En])
select  '  ','Enter purchase currency'

insert into [StrSource] 
([Ar],[En])
select  '       (IpAddress)','Enter computer IP Address where the dongle was installed'

insert into [StrSource] 
([Ar],[En])
select  '  ','Enter investment value'

insert into [StrSource] 
([Ar],[En])
select  '  ','Enter the insurance value'

insert into [StrSource] 
([Ar],[En])
select  '  ','Enter value payment'

insert into [StrSource] 
([Ar],[En])
select  '  ','Enter the contract value'

insert into [StrSource] 
([Ar],[En])
select  '  ','Enter purchase amount'

insert into [StrSource] 
([Ar],[En])
select  '  ','Enter cost center'

insert into [StrSource] 
([Ar],[En])
select  '   ','Enter main cost center'

insert into [StrSource] 
([Ar],[En])
select  '    ','Enter cost center to line'

insert into [StrSource] 
([Ar],[En])
select  '       ','Enter land cost center in land card'

insert into [StrSource] 
([Ar],[En])
select  '      ','Enter flat cost center in flat card'

insert into [StrSource] 
([Ar],[En])
select  '      ','Enter villa cost center in villa card'

insert into [StrSource] 
([Ar],[En])
select  '      ','Enter shop cost center in shop card'

insert into [StrSource] 
([Ar],[En])
select  '      ','Enter parking cost center in parking card'

insert into [StrSource] 
([Ar],[En])
select  '        ','Enter print path for this pattern correctly'

insert into [StrSource] 
([Ar],[En])
select  '        ','Enter the path print files for this pattern properly'

insert into [StrSource] 
([Ar],[En])
select  '  ','Enter cheque type'

insert into [StrSource] 
([Ar],[En])
select  '  ','Enter the invoice pattern'

insert into [StrSource] 
([Ar],[En])
select  '   ','Enter receipt voucher type'

insert into [StrSource] 
([Ar],[En])
select  '  ','Enter payment type'

insert into [StrSource] 
([Ar],[En])
select  '  ','Enter property type'

insert into [StrSource] 
([Ar],[En])
select  '  ','The lowest price of the property'

insert into [StrSource] 
([Ar],[En])
select  '','Tools'

insert into [StrSource] 
([Ar],[En])
select  ' ','External Tools'

insert into [StrSource] 
([Ar],[En])
select  ' ...','Extra Tools'

insert into [StrSource] 
([Ar],[En])
select  '    ','If you want to modify data press the Modify button'

insert into [StrSource] 
([Ar],[En])
select  ' ','Profits flats'

insert into [StrSource] 
([Ar],[En])
select  ' ','Materials profits'

insert into [StrSource] 
([Ar],[En])
select  '  ','Profits flats sales'

insert into [StrSource] 
([Ar],[En])
select  '','Refun'

insert into [StrSource] 
([Ar],[En])
select  ' ','cheque return'

insert into [StrSource] 
([Ar],[En])
select  '','Send'

insert into [StrSource] 
([Ar],[En])
select  ' SMS','Send SMS'

insert into [StrSource] 
([Ar],[En])
select  ' SMS ','Send SMS to Group'

insert into [StrSource] 
([Ar],[En])
select  ' ','Automatically Send'

insert into [StrSource] 
([Ar],[En])
select  '     ','Automatically send SMS when add maintenance order'

insert into [StrSource] 
([Ar],[En])
select  '    ','Automatically send SMS when add complaint'

insert into [StrSource] 
([Ar],[En])
select  '   ','Automatically send SMS when termination'

insert into [StrSource] 
([Ar],[En])
select  '   ','Automatically send SMS when add'

insert into [StrSource] 
([Ar],[En])
select  '       ','Automatically send SMS before check due date'

insert into [StrSource] 
([Ar],[En])
select  '  ','Send the selected page'

insert into [StrSource] 
([Ar],[En])
select  '   ','Send contract to registration'

insert into [StrSource] 
([Ar],[En])
select  '  ','Send Email'

insert into [StrSource] 
([Ar],[En])
select  '   ','Send Report by Email'

insert into [StrSource] 
([Ar],[En])
select  '      ','Automatically send SMS when collect the check'

insert into [StrSource] 
([Ar],[En])
select  '       ','Automatically send SMS on contract expiry day'

insert into [StrSource] 
([Ar],[En])
select  '      ','Automatically send SMS after return the check'

insert into [StrSource] 
([Ar],[En])
select  '     ','Automatically send SMS after expiration of contract'

insert into [StrSource] 
([Ar],[En])
select  '      ','Automatically send SMS after collect the check'

insert into [StrSource] 
([Ar],[En])
select  '     ','Send SMS when adding maintenance order'

insert into [StrSource] 
([Ar],[En])
select  '    ','Send SMS when adding complaint'

insert into [StrSource] 
([Ar],[En])
select  '   ','Send SMS when returning check'

insert into [StrSource] 
([Ar],[En])
select  '   ','Send SMS when collecting check'

insert into [StrSource] 
([Ar],[En])
select  '    ','Sned SMS on partial collection'

insert into [StrSource] 
([Ar],[En])
select  '  ','Send SMS when add'

insert into [StrSource] 
([Ar],[En])
select  '      ','Send SMS before check due in'

insert into [StrSource] 
([Ar],[En])
select  '  SMS ','Send All SMS'

insert into [StrSource] 
([Ar],[En])
select  '     ','Send SMS when closing complaint'

insert into [StrSource] 
([Ar],[En])
select  '','Land'

insert into [StrSource] 
([Ar],[En])
select  ' ','Receipts No'

insert into [StrSource] 
([Ar],[En])
select  '  ','Contract receipts No'

insert into [StrSource] 
([Ar],[En])
select  '  ','Remove checked mark'

insert into [StrSource] 
([Ar],[En])
select  '    ','Remove clearance print check'

insert into [StrSource] 
([Ar],[En])
select  '   ','Remove selected file'

insert into [StrSource] 
([Ar],[En])
select  ' ','Delay reasons'

insert into [StrSource] 
([Ar],[En])
select  ' ','Problem causes'

insert into [StrSource] 
([Ar],[En])
select  '  ','Reasons for non-completion'

insert into [StrSource] 
([Ar],[En])
select  '','Week'

insert into [StrSource] 
([Ar],[En])
select  '','Replace'

insert into [StrSource] 
([Ar],[En])
select  '  ','Eliminated out'

insert into [StrSource] 
([Ar],[En])
select  '  ','Exclude from asset'

insert into [StrSource] 
([Ar],[En])
select  '','Investment'

insert into [StrSource] 
([Ar],[En])
select  '    ','Excluding returned cheque with reason'

insert into [StrSource] 
([Ar],[En])
select  ' ','Exception cards'

insert into [StrSource] 
([Ar],[En])
select  '    ','Exclude empty and balanced cards'

insert into [StrSource] 
([Ar],[En])
select  '  ','Exclude opening entries'

insert into [StrSource] 
([Ar],[En])
select  '','Restore'

insert into [StrSource] 
([Ar],[En])
select  '  ','Restore data backup'

insert into [StrSource] 
([Ar],[En])
select  '  ','Recover previous backup'

insert into [StrSource] 
([Ar],[En])
select  '  ','Restore columns sort'

insert into [StrSource] 
([Ar],[En])
select  '','Browse'

insert into [StrSource] 
([Ar],[En])
select  ' ogle Maps','Browse ogle Maps'

insert into [StrSource] 
([Ar],[En])
select  ' ','View accounts'

insert into [StrSource] 
([Ar],[En])
select  ' ','View checked'

insert into [StrSource] 
([Ar],[En])
select  '  ','Browse other users'

insert into [StrSource] 
([Ar],[En])
select  '  ','View branch permissions'

insert into [StrSource] 
([Ar],[En])
select  '   ','View exchange rate'

insert into [StrSource] 
([Ar],[En])
select  '  ','View log file'

insert into [StrSource] 
([Ar],[En])
select  '  ','View installments windows '

insert into [StrSource] 
([Ar],[En])
select  '  ','View log window'

insert into [StrSource] 
([Ar],[En])
select  '   ','View log window with editing'

insert into [StrSource] 
([Ar],[En])
select  '...','Display ..'

insert into [StrSource] 
([Ar],[En])
select  ' ','Building Completed'

insert into [StrSource] 
([Ar],[En])
select  ' xls','Import From xls '

insert into [StrSource] 
([Ar],[En])
select  ' ','Import Data'

insert into [StrSource] 
([Ar],[En])
select  '   XLS','Import table from XLS'

insert into [StrSource] 
([Ar],[En])
select  '  ','Import Customers Data'

insert into [StrSource] 
([Ar],[En])
select  '   ','Import materials & groups information'

insert into [StrSource] 
([Ar],[En])
select  '','Prices'

insert into [StrSource] 
([Ar],[En])
select  ' ','Exchange rates'

insert into [StrSource] 
([Ar],[En])
select  ' ','Asset name'

insert into [StrSource] 
([Ar],[En])
select  ' ','Order name'

insert into [StrSource] 
([Ar],[En])
select  ' ','The Original name'

insert into [StrSource] 
([Ar],[En])
select  ' ','Sales man'

insert into [StrSource] 
([Ar],[En])
select  ' ','Building name'

insert into [StrSource] 
([Ar],[En])
select  ' ','Bank name'

insert into [StrSource] 
([Ar],[En])
select  '  ','Plural part name'

insert into [StrSource] 
([Ar],[En])
select  ' ','Computer name'

insert into [StrSource] 
([Ar],[En])
select  ' ','Account name'

insert into [StrSource] 
([Ar],[En])
select  '  ','Account name duplicate'

insert into [StrSource] 
([Ar],[En])
select  ' ','Customer name'

insert into [StrSource] 
([Ar],[En])
select  ' ','Street No'

insert into [StrSource] 
([Ar],[En])
select  ' ','Partner name'

insert into [StrSource] 
([Ar],[En])
select  ' ','Contract name'

insert into [StrSource] 
([Ar],[En])
select  ' ','Menu name'

insert into [StrSource] 
([Ar],[En])
select  '  ','Latin menu name'

insert into [StrSource] 
([Ar],[En])
select  '  ','Material Latin name'

insert into [StrSource] 
([Ar],[En])
select  ' ','Owner name'

insert into [StrSource] 
([Ar],[En])
select  ' ','Complex name'

insert into [StrSource] 
([Ar],[En])
select  ' ','Server Namer'

insert into [StrSource] 
([Ar],[En])
select  ' ','Plans name'

insert into [StrSource] 
([Ar],[En])
select  '  ','City name duplicate'

insert into [StrSource] 
([Ar],[En])
select  ' ','Sender name'

insert into [StrSource] 
([Ar],[En])
select  ' ','Tenants name'

insert into [StrSource] 
([Ar],[En])
select  ' ','User Name'

insert into [StrSource] 
([Ar],[En])
select  ' ','Beneficiary name'

insert into [StrSource] 
([Ar],[En])
select  ' ','Area Name'

insert into [StrSource] 
([Ar],[En])
select  ' ','Supplier name'

insert into [StrSource] 
([Ar],[En])
select  ' ','pattern Name'

insert into [StrSource] 
([Ar],[En])
select  ' ','Report Name'

insert into [StrSource] 
([Ar],[En])
select  '  ','Currency part name'

insert into [StrSource] 
([Ar],[En])
select  '   ','Currency part latin name'

insert into [StrSource] 
([Ar],[En])
select  '  ','His license name'

insert into [StrSource] 
([Ar],[En])
select  '  ','Property owner name'

insert into [StrSource] 
([Ar],[En])
select  '    ','Name of new database file'

insert into [StrSource] 
([Ar],[En])
select  '  ','Fields printing name'

insert into [StrSource] 
([Ar],[En])
select  '  ','Less or Equal'

insert into [StrSource] 
([Ar],[En])
select  ' ','Less than'

insert into [StrSource] 
([Ar],[En])
select  '    ','Smaller than contract end date'

insert into [StrSource] 
([Ar],[En])
select  ' ','Entry origin'

insert into [StrSource] 
([Ar],[En])
select  ' ','New asset'

insert into [StrSource] 
([Ar],[En])
select  ' ','Asset catery'

insert into [StrSource] 
([Ar],[En])
select  '','Additions'

insert into [StrSource] 
([Ar],[En])
select  '','Add'

insert into [StrSource] 
([Ar],[En])
select  ' ','Add land'

insert into [StrSource] 
([Ar],[En])
select  ' ','Add details'

insert into [StrSource] 
([Ar],[En])
select  ' ...','Add data...'

insert into [StrSource] 
([Ar],[En])
select  '  ','Add partial collection'

insert into [StrSource] 
([Ar],[En])
select  '  ','Add selected flats'

insert into [StrSource] 
([Ar],[En])
select  '  ','Add selected shops'

insert into [StrSource] 
([Ar],[En])
select  '  ','Add to Orrigin'

insert into [StrSource] 
([Ar],[En])
select  '  ','Add to asset'

insert into [StrSource] 
([Ar],[En])
select  ' ','Add condition'

insert into [StrSource] 
([Ar],[En])
select  ' ','Add flat'

insert into [StrSource] 
([Ar],[En])
select  '  ','Add buildings flats'

insert into [StrSource] 
([Ar],[En])
select  '  ','Add building appartments'

insert into [StrSource] 
([Ar],[En])
select  '  ','Add fixed amount'

insert into [StrSource] 
([Ar],[En])
select  ' ','Add group'

insert into [StrSource] 
([Ar],[En])
select  ' ','Add shop'

insert into [StrSource] 
([Ar],[En])
select  ' ','Attach files'

insert into [StrSource] 
([Ar],[En])
select  '  ','Add new reconciliation'

insert into [StrSource] 
([Ar],[En])
select  ' ','Add file'

insert into [StrSource] 
([Ar],[En])
select  ' ','Add location'

insert into [StrSource] 
([Ar],[En])
select  ' ','Add parking'

insert into [StrSource] 
([Ar],[En])
select  '   ','Click start to create accounts'

insert into [StrSource] 
([Ar],[En])
select  '    ','Press the start button to start the process'

insert into [StrSource] 
([Ar],[En])
select  '','Frame'

insert into [StrSource] 
([Ar],[En])
select  ' /  ','Show / Hide column'

insert into [StrSource] 
([Ar],[En])
select  '  ','Show account name'

insert into [StrSource] 
([Ar],[En])
select  '     ','Show assets without activity'

insert into [StrSource] 
([Ar],[En])
select  '    ','Show checks that not related with contracts'

insert into [StrSource] 
([Ar],[En])
select  '     ','Only show checks that not related with contracts'

insert into [StrSource] 
([Ar],[En])
select  '    ','Show building in contracts'

insert into [StrSource] 
([Ar],[En])
select  '   ','Show building in reports'

insert into [StrSource] 
([Ar],[En])
select  ' ','Show details'

insert into [StrSource] 
([Ar],[En])
select  ' ','Show activities'

insert into [StrSource] 
([Ar],[En])
select  '  ','Show closing accounts'

insert into [StrSource] 
([Ar],[En])
select  '  ','Show main accounts'

insert into [StrSource] 
([Ar],[En])
select  '  ','Show empty accounts'

insert into [StrSource] 
([Ar],[En])
select  '   ','Show empty sub accounts'

insert into [StrSource] 
([Ar],[En])
select  '  ','Show balanced accounts'

insert into [StrSource] 
([Ar],[En])
select  '   ','Show accounts in contracts'

insert into [StrSource] 
([Ar],[En])
select  ' ','Show fields'

insert into [StrSource] 
([Ar],[En])
select  ' ','Show maps'

insert into [StrSource] 
([Ar],[En])
select  ' ','Show credit'

insert into [StrSource] 
([Ar],[En])
select  '    ','Show message in SMS report'

insert into [StrSource] 
([Ar],[En])
select  '         ','Show message in SMS report after check return in'

insert into [StrSource] 
([Ar],[En])
select  '        ','Show message in SMS report after contract expires in'

insert into [StrSource] 
([Ar],[En])
select  '         ','Show message in SMS report after collect check in'

insert into [StrSource] 
([Ar],[En])
select  '       ','Show message in SMS report immediately after check return'

insert into [StrSource] 
([Ar],[En])
select  '       ','Show message in SMS report immediately after check collect'

insert into [StrSource] 
([Ar],[En])
select  '        ','Show message in SMS report when contract expire'

insert into [StrSource] 
([Ar],[En])
select  '        ','Show message in SMS report before contract expire in'

insert into [StrSource] 
([Ar],[En])
select  ' ','Show balance'

insert into [StrSource] 
([Ar],[En])
select  '  ','Show previous balance'

insert into [StrSource] 
([Ar],[En])
select  '  ','Show actual balance'

insert into [StrSource] 
([Ar],[En])
select  ' ','Show flats'

insert into [StrSource] 
([Ar],[En])
select  '      ','Show assembled flat that contract has been terminated'

insert into [StrSource] 
([Ar],[En])
select  '       ','Show merged shops and flats'

insert into [StrSource] 
([Ar],[En])
select  ' ','Show properties'

insert into [StrSource] 
([Ar],[En])
select  '     ','Show contracts without security deposit'

insert into [StrSource] 
([Ar],[En])
select  ' ','Show currency'

insert into [StrSource] 
([Ar],[En])
select  '  ','Show thousand separator'

insert into [StrSource] 
([Ar],[En])
select  '   ','Show last bills only'

insert into [StrSource] 
([Ar],[En])
select  '  ','Show balanced bills'

insert into [StrSource] 
([Ar],[En])
select  ' ','Show shops'

insert into [StrSource] 
([Ar],[En])
select  ' ','Show debit'

insert into [StrSource] 
([Ar],[En])
select  '  ','Show empty cost center'

insert into [StrSource] 
([Ar],[En])
select  '  ','Show annual summary'

insert into [StrSource] 
([Ar],[En])
select  ' ','Show parking'

insert into [StrSource] 
([Ar],[En])
select  '      ','Show assembled parking which contract was terminated'

insert into [StrSource] 
([Ar],[En])
select  '    ','Show parking that inside assembled parking'

insert into [StrSource] 
([Ar],[En])
select  '   ','Show closing accounts details'

insert into [StrSource] 
([Ar],[En])
select  '   / ','Show supplier / customer accounts'

insert into [StrSource] 
([Ar],[En])
select  '  ','Show credit account'

insert into [StrSource] 
([Ar],[En])
select  '  ','Show contract field'

insert into [StrSource] 
([Ar],[En])
select  '  ','Show debit account'

insert into [StrSource] 
([Ar],[En])
select  '    ','Show successfully finisshed messages'

insert into [StrSource] 
([Ar],[En])
select  '   ','Show save confirming messages'

insert into [StrSource] 
([Ar],[En])
select  '  ','Show account code'

insert into [StrSource] 
([Ar],[En])
select  '    ','Show choose language dialog box'

insert into [StrSource] 
([Ar],[En])
select  '    ','Show cost center for contract'

insert into [StrSource] 
([Ar],[En])
select  ' ','Re-numbering'

insert into [StrSource] 
([Ar],[En])
select  '   ','Renumbering checks'

insert into [StrSource] 
([Ar],[En])
select  '  ','Renumbering contracts'

insert into [StrSource] 
([Ar],[En])
select  '   ','Renumbering land cards'

insert into [StrSource] 
([Ar],[En])
select  '   ','Renumbering accounts card'

insert into [StrSource] 
([Ar],[En])
select  '   ','Renumbering customer cards'

insert into [StrSource] 
([Ar],[En])
select  '   ','Renumbering flat cards'

insert into [StrSource] 
([Ar],[En])
select  '   ','Renumbering villa cards'

insert into [StrSource] 
([Ar],[En])
select  '   ','Renumbering shop cards'

insert into [StrSource] 
([Ar],[En])
select  '   ','Renumbering parking cards'

insert into [StrSource] 
([Ar],[En])
select  '   ','Renumbering journal entries'

insert into [StrSource] 
([Ar],[En])
select  '    ','Renumbering notes type'

insert into [StrSource] 
([Ar],[En])
select  '   ','Renumbering journal entries type'

insert into [StrSource] 
([Ar],[En])
select  '   ','Renumbering contract type'

insert into [StrSource] 
([Ar],[En])
select  '    ','Renumbering electricity bills type'

insert into [StrSource] 
([Ar],[En])
select  ' ','Recoding'

insert into [StrSource] 
([Ar],[En])
select  '   ','Renumbering subaccounts'

insert into [StrSource] 
([Ar],[En])
select  '  ','Recoding sub accounts'

insert into [StrSource] 
([Ar],[En])
select  '   ','Recoding cost centers'

insert into [StrSource] 
([Ar],[En])
select  ' ','Rename'

insert into [StrSource] 
([Ar],[En])
select  '  ','File rename'

insert into [StrSource] 
([Ar],[En])
select  '   ','Renaming cost centers'

insert into [StrSource] 
([Ar],[En])
select  '    ','ReNumbering jobcost for building'

insert into [StrSource] 
([Ar],[En])
select  '  ','Regenerate notes'

insert into [StrSource] 
([Ar],[En])
select  '   ','Regenerate journal entries'

insert into [StrSource] 
([Ar],[En])
select  '     ','Recreate entries for service contracts'

insert into [StrSource] 
([Ar],[En])
select  '    ','Regenerate cheque journal entries'

insert into [StrSource] 
([Ar],[En])
select  '    ','Regenerate vouchers for contracts'

insert into [StrSource] 
([Ar],[En])
select  '  ','Reprocessing notes'

insert into [StrSource] 
([Ar],[En])
select  '  ','Use default accounts'

insert into [StrSource] 
([Ar],[En])
select  '   ','Use default options in Types'

insert into [StrSource] 
([Ar],[En])
select  ' ','Use date'

insert into [StrSource] 
([Ar],[En])
select  '  ','Use due date'

insert into [StrSource] 
([Ar],[En])
select  '        ','Use building revenue account as default account of collection commission'

insert into [StrSource] 
([Ar],[En])
select  '      ','Use customer account as default collection account'

insert into [StrSource] 
([Ar],[En])
select  '        ','Use customer account as default partial collection account'

insert into [StrSource] 
([Ar],[En])
select  ' ','Use Level'

insert into [StrSource] 
([Ar],[En])
select  '   ','Use security level of cheque'

insert into [StrSource] 
([Ar],[En])
select  '      ','Enter new password correctly'

insert into [StrSource] 
([Ar],[En])
select  '   ','Try again'

insert into [StrSource] 
([Ar],[En])
select  ' ','Maps settings'

insert into [StrSource] 
([Ar],[En])
select  '','Tools'

insert into [StrSource] 
([Ar],[En])
select  ' SMS','SMS Settings'

insert into [StrSource] 
([Ar],[En])
select  ' ','Map ettings'

insert into [StrSource] 
([Ar],[En])
select  '  ','Previous years settings'

insert into [StrSource] 
([Ar],[En])
select  '  ','Scanner settings'

insert into [StrSource] 
([Ar],[En])
select  ' ','General settings'

insert into [StrSource] 
([Ar],[En])
select  '  ','Building plan settings'

insert into [StrSource] 
([Ar],[En])
select  '  ','Highest price for a property'

insert into [StrSource] 
([Ar],[En])
select  ' ','Maintenance works'

insert into [StrSource] 
([Ar],[En])
select  '','Close'

insert into [StrSource] 
([Ar],[En])
select  '  ','Close all windows'

insert into [StrSource] 
([Ar],[En])
select  '','Default'

insert into [StrSource] 
([Ar],[En])
select  '    ','Empty window after data added'

insert into [StrSource] 
([Ar],[En])
select  '    ','Empty window after data deletion'

insert into [StrSource] 
([Ar],[En])
select  '','Horizontally'

insert into [StrSource] 
([Ar],[En])
select  ' ','Contract installments'

insert into [StrSource] 
([Ar],[En])
select  '   ','Contract installments by plan'

insert into [StrSource] 
([Ar],[En])
select  '  ','Close maintenance order '

insert into [StrSource] 
([Ar],[En])
select  ' ','Close complaint'

insert into [StrSource] 
([Ar],[En])
select  '  ','Close maintenance complaint'

insert into [StrSource] 
([Ar],[En])
select  '  ','Largest or Equal'

insert into [StrSource] 
([Ar],[En])
select  ' ','largest price'

insert into [StrSource] 
([Ar],[En])
select  ' ','More than'

insert into [StrSource] 
([Ar],[En])
select  '    ','Bigger than contract end date'

insert into [StrSource] 
([Ar],[En])
select  '  ','More than once'

insert into [StrSource] 
([Ar],[En])
select  ' ','Cancel'

insert into [StrSource] 
([Ar],[En])
select  ' ','Un Post'

insert into [StrSource] 
([Ar],[En])
select  '  ','Uncheck All'

insert into [StrSource] 
([Ar],[En])
select  ' ','Cancel reservation'

insert into [StrSource] 
([Ar],[En])
select  '  ','Cancel other reservation'

insert into [StrSource] 
([Ar],[En])
select  ' ','Land ownership'

insert into [StrSource] 
([Ar],[En])
select  ' ','Building ownership'

insert into [StrSource] 
([Ar],[En])
select  '   ','Maintenance order in progress'

insert into [StrSource] 
([Ar],[En])
select  ' ','Maintenance order'

insert into [StrSource] 
([Ar],[En])
select  '       ','Allow save contract starting after end duration date'

insert into [StrSource] 
([Ar],[En])
select  '  ','Export to Excel'

insert into [StrSource] 
([Ar],[En])
select  '   ','End other users session'

insert into [StrSource] 
([Ar],[En])
select  '   ','Deposit journal entry'

insert into [StrSource] 
([Ar],[En])
select  '   ','Modify other users journal entries'

insert into [StrSource] 
([Ar],[En])
select  '   ','Modify other users cheques'

insert into [StrSource] 
([Ar],[En])
select  '   ','Modify other users contracts'

insert into [StrSource] 
([Ar],[En])
select  '  ','Change salesman'

insert into [StrSource] 
([Ar],[En])
select  '   ','Availabitlty of Changing  password'

insert into [StrSource] 
([Ar],[En])
select  '     ','Delete journal entries with origin'

insert into [StrSource] 
([Ar],[En])
select  '  ','Print Reports'

insert into [StrSource] 
([Ar],[En])
select  ' ','Storekeeper'

insert into [StrSource] 
([Ar],[En])
select  ' !','Please note !!'

insert into [StrSource] 
([Ar],[En])
select  '       ','Attentions: journal entries will be renumbering by date order!!!'

insert into [StrSource] 
([Ar],[En])
select  '!','Attention!'

insert into [StrSource] 
([Ar],[En])
select  '','Finish'

insert into [StrSource] 
([Ar],[En])
select  '   ','Create procedures and triggers'

insert into [StrSource] 
([Ar],[En])
select  ' ','Create tables'

insert into [StrSource] 
([Ar],[En])
select  ' ','Create Voucher'

insert into [StrSource] 
([Ar],[En])
select  '  ','Create journal entry on date'

insert into [StrSource] 
([Ar],[En])
select  ' ','Create entries'

insert into [StrSource] 
([Ar],[En])
select  ' ','Create File'

insert into [StrSource] 
([Ar],[En])
select  ' ','Create account'

insert into [StrSource] 
([Ar],[En])
select  '  ','Create deposit account'

insert into [StrSource] 
([Ar],[En])
select  '  ','Add subaccount'

insert into [StrSource] 
([Ar],[En])
select  '   ','Create deposit accounts into'

insert into [StrSource] 
([Ar],[En])
select  '  ','Create accounts into'

insert into [StrSource] 
([Ar],[En])
select  '   ','Create accounts for Customers cards'

insert into [StrSource] 
([Ar],[En])
select  ' ','Create into'

insert into [StrSource] 
([Ar],[En])
select  '  ','Add sub-branch'

insert into [StrSource] 
([Ar],[En])
select  '  ','Create database'

insert into [StrSource] 
([Ar],[En])
select  '  ','Create sub-group'

insert into [StrSource] 
([Ar],[En])
select  '  ','Generate cost center'

insert into [StrSource] 
([Ar],[En])
select  '   ','Add sub cost center'

insert into [StrSource] 
([Ar],[En])
select  '  ','Create Sub-Store'

insert into [StrSource] 
([Ar],[En])
select  '   ','Generate New File'

insert into [StrSource] 
([Ar],[En])
select  ': ','Created'

insert into [StrSource] 
([Ar],[En])
select  '   ','Decrease in asset life'

insert into [StrSource] 
([Ar],[En])
select  '  ','Received Orders Types'

insert into [StrSource] 
([Ar],[En])
select  '  ','Cheque Pattern'

insert into [StrSource] 
([Ar],[En])
select  ' ','Vouchers patterns '

insert into [StrSource] 
([Ar],[En])
select  ' ','Cheques Types'

insert into [StrSource] 
([Ar],[En])
select  ' ','Orders patterns'

insert into [StrSource] 
([Ar],[En])
select  ' ','Contarcts pattern'

insert into [StrSource] 
([Ar],[En])
select  ' ','Bills Pattern'

insert into [StrSource] 
([Ar],[En])
select  '  ','Accounting journal entry types'

insert into [StrSource] 
([Ar],[En])
select  ' ','Entries patterns '

insert into [StrSource] 
([Ar],[En])
select  ' ','Stock transfers type'

insert into [StrSource] 
([Ar],[En])
select  '  ','Output stock transfer types'

insert into [StrSource] 
([Ar],[En])
select  '  ','Input stock transfer types'

insert into [StrSource] 
([Ar],[En])
select  '  ','Services contract types'

insert into [StrSource] 
([Ar],[En])
select  '  ','Maintenance contract types'

insert into [StrSource] 
([Ar],[En])
select  '  ','Electricity Bill Types'

insert into [StrSource] 
([Ar],[En])
select  '','Terminate'

insert into [StrSource] 
([Ar],[En])
select  ' ','Return termination'

insert into [StrSource] 
([Ar],[En])
select  '   ','Finish returned cheques'

insert into [StrSource] 
([Ar],[En])
select  '  ','Ending the refund of paper notes'

insert into [StrSource] 
([Ar],[En])
select  ' ','Ending the refund'

insert into [StrSource] 
([Ar],[En])
select  ' ','Lawsuit terminate'

insert into [StrSource] 
([Ar],[En])
select  '  ','Lawsuite termination'

insert into [StrSource] 
([Ar],[En])
select  ' ','Close maintenance'

insert into [StrSource] 
([Ar],[En])
select  ' ','Terminate contract'

insert into [StrSource] 
([Ar],[En])
select  '  ','Terminate selected contracts'

insert into [StrSource] 
([Ar],[En])
select  '   ','lands and villas contracts termination'

insert into [StrSource] 
([Ar],[En])
select  '  ','Parking contracts termination'

insert into [StrSource] 
([Ar],[En])
select  ' ','Assets depreciation'

insert into [StrSource] 
([Ar],[En])
select  '','or'

insert into [StrSource] 
([Ar],[En])
select  ' ','Maintenance orders'

insert into [StrSource] 
([Ar],[En])
select  ' ','Received orders'

insert into [StrSource] 
([Ar],[En])
select  ' ','First time'

insert into [StrSource] 
([Ar],[En])
select  '','Rent'

insert into [StrSource] 
([Ar],[En])
select  ' ','Flat rent'

insert into [StrSource] 
([Ar],[En])
select  '','Stop'

insert into [StrSource] 
([Ar],[En])
select  ' ','Attorney fees'

insert into [StrSource] 
([Ar],[En])
select  '','Tool'

insert into [StrSource] 
([Ar],[En])
select  ' SMS ','Send to SMS group'

insert into [StrSource] 
([Ar],[En])
select  '  ','Exclude returned cheque'

insert into [StrSource] 
([Ar],[En])
select  '    ','Exclude cheque without due date'

insert into [StrSource] 
([Ar],[En])
select  '  ','Use device software'

insert into [StrSource] 
([Ar],[En])
select  '   ','View information window'

insert into [StrSource] 
([Ar],[En])
select  '   ','View image window'

insert into [StrSource] 
([Ar],[En])
select  '    ','Contract received from registration'

insert into [StrSource] 
([Ar],[En])
select  ' ','Electricity consumption'

insert into [StrSource] 
([Ar],[En])
select  ' ','Water consumption'

insert into [StrSource] 
([Ar],[En])
select  ' ','Table name'

insert into [StrSource] 
([Ar],[En])
select  ' ','Worker name'

insert into [StrSource] 
([Ar],[En])
select  ' ','Material name'

insert into [StrSource] 
([Ar],[En])
select  ' ','File name'

insert into [StrSource] 
([Ar],[En])
select  ' ','Add Photo'

insert into [StrSource] 
([Ar],[En])
select  '    ','Press start to proceed'

insert into [StrSource] 
([Ar],[En])
select  '','View'

insert into [StrSource] 
([Ar],[En])
select  '  ','Show units sold'

insert into [StrSource] 
([Ar],[En])
select  '   ','Show overdue payments report'

insert into [StrSource] 
([Ar],[En])
select  ' ','Reindexing'

insert into [StrSource] 
([Ar],[En])
select  '  ','Rename tab'

insert into [StrSource] 
([Ar],[En])
select  '   ','Rename the cost center'

insert into [StrSource] 
([Ar],[En])
select  '     ','ReGenerate entries for parking contracts'

insert into [StrSource] 
([Ar],[En])
select  '        ','Consider due payment as late payment if exceeded'

insert into [StrSource] 
([Ar],[En])
select  ' ','Consider commission'

insert into [StrSource] 
([Ar],[En])
select  '      ','Consider assembled units in as leased'

insert into [StrSource] 
([Ar],[En])
select  '       ','Use expiry of investment date as contracts expiry date'

insert into [StrSource] 
([Ar],[En])
select  '       ','Use collection account as default observe account of delay fees'

insert into [StrSource] 
([Ar],[En])
select  '   /     ','Use supplier / customer account as default account of check return fees'

insert into [StrSource] 
([Ar],[En])
select  '   /     ','Use supplier / customer account as default account of delay fees'

insert into [StrSource] 
([Ar],[En])
select  '   /    ','Use supplier / customer account as default account of check return'

insert into [StrSource] 
([Ar],[En])
select  '      ','Use customer account as default account of check post'

insert into [StrSource] 
([Ar],[En])
select  '      ','Use customer account as default lawsuit account'

insert into [StrSource] 
([Ar],[En])
select  '       ','Use bank account as default account of check return'

insert into [StrSource] 
([Ar],[En])
select  '          ','Use bank account as default account of cheque return if it is collected'

insert into [StrSource] 
([Ar],[En])
select  '       ','Use bank account as default account of check post'

insert into [StrSource] 
([Ar],[En])
select  '        ','Use building bank account as default account partial collection'

insert into [StrSource] 
([Ar],[En])
select  '        ','Set cash account of building as default account of partial collection'

insert into [StrSource] 
([Ar],[En])
select  '       ','Use owner account as default account of collect commssion'

insert into [StrSource] 
([Ar],[En])
select  '       ','Use owner account as default account of check post'

insert into [StrSource] 
([Ar],[En])
select  '     ','Use commession rate from building card'

insert into [StrSource] 
([Ar],[En])
select  '  ','Favorite accounts settings'

insert into [StrSource] 
([Ar],[En])
select  ' ','Maintenance work'

insert into [StrSource] 
([Ar],[En])
select  '','Installements'

insert into [StrSource] 
([Ar],[En])
select  '','Excel'

insert into [StrSource] 
([Ar],[En])
select  '','Dimensions'

insert into [StrSource] 
([Ar],[En])
select  '  ','Dimensions and border'

insert into [StrSource] 
([Ar],[En])
select  '','Buildings'

insert into [StrSource] 
([Ar],[En])
select  '  ','Connect New File'

insert into [StrSource] 
([Ar],[En])
select  '','Total.'

insert into [StrSource] 
([Ar],[En])
select  '','Wages'

insert into [StrSource] 
([Ar],[En])
select  '  ','Coordinates from ogle'

insert into [StrSource] 
([Ar],[En])
select  '','Shotcut'

insert into [StrSource] 
([Ar],[En])
select  ' ','Duplicate shortcut'

insert into [StrSource] 
([Ar],[En])
select  '','Shotcuts'

insert into [StrSource] 
([Ar],[En])
select  '','Evacuate date'

insert into [StrSource] 
([Ar],[En])
select  '','Last'

insert into [StrSource] 
([Ar],[En])
select  '','Enter'

insert into [StrSource] 
([Ar],[En])
select  ' ','Extra tools'

insert into [StrSource] 
([Ar],[En])
select  '','Lands'

insert into [StrSource] 
([Ar],[En])
select  '    ','Leased and non-leased lands'

insert into [StrSource] 
([Ar],[En])
select  '   ','Rented and un-rented lands'

insert into [StrSource] 
([Ar],[En])
select  '   ','Sold and Non-Sold Lands'

insert into [StrSource] 
([Ar],[En])
select  '  ','Profit and Loss'

insert into [StrSource] 
([Ar],[En])
select  '    ','Profit, Loss and Balance'

insert into [StrSource] 
([Ar],[En])
select  '','Hight'

insert into [StrSource] 
([Ar],[En])
select  '','Refunded'

insert into [StrSource] 
([Ar],[En])
select  '     ','check return generates journal entry automatically'

insert into [StrSource] 
([Ar],[En])
select  '  ','check return generates journal entry'

insert into [StrSource] 
([Ar],[En])
select  '  SMS','Automatic SMS sending'

insert into [StrSource] 
([Ar],[En])
select  '','Archiving'

insert into [StrSource] 
([Ar],[En])
select  '','Land'

insert into [StrSource] 
([Ar],[En])
select  '  ','Consignee numbers'

insert into [StrSource] 
([Ar],[En])
select  '','Displacement'

insert into [StrSource] 
([Ar],[En])
select  '','Disposals'

insert into [StrSource] 
([Ar],[En])
select  '','Merit'

insert into [StrSource] 
([Ar],[En])
select  '  ','Balance inquiry'

insert into [StrSource] 
([Ar],[En])
select  '','Consumption'

insert into [StrSource] 
([Ar],[En])
select  '','Name'

insert into [StrSource] 
([Ar],[En])
select  ' ','Commercial name'

insert into [StrSource] 
([Ar],[En])
select  ' ','New name'

insert into [StrSource] 
([Ar],[En])
select  ' ','Current name'

insert into [StrSource] 
([Ar],[En])
select  ' ','Arabic Name'

insert into [StrSource] 
([Ar],[En])
select  ' ','Full name'

insert into [StrSource] 
([Ar],[En])
select  '  ','Full name contains'

insert into [StrSource] 
([Ar],[En])
select  ' ','Latin name'

insert into [StrSource] 
([Ar],[En])
select  '  ','Duplicate latin name'

insert into [StrSource] 
([Ar],[En])
select  '  ','Latin name contains'

insert into [StrSource] 
([Ar],[En])
select  ' ','Name in plural'

insert into [StrSource] 
([Ar],[En])
select  ' ','Duplicate name'

insert into [StrSource] 
([Ar],[En])
select  ' Card No 1','Dublicate name Card No 1'

insert into [StrSource] 
([Ar],[En])
select  '  ','Version No'

insert into [StrSource] 
([Ar],[En])
select  '','The Origin'

insert into [StrSource] 
([Ar],[En])
select  '  ','Assen inactive'

insert into [StrSource] 
([Ar],[En])
select  ' ','Asset active'

insert into [StrSource] 
([Ar],[En])
select  ' ','Asset sold'

insert into [StrSource] 
([Ar],[En])
select  '','Assets'

insert into [StrSource] 
([Ar],[En])
select  ' ','Fixed assets'

insert into [StrSource] 
([Ar],[En])
select  '','Extras'

insert into [StrSource] 
([Ar],[En])
select  ' ','Opened Frames'

insert into [StrSource] 
([Ar],[En])
select  '','The view'

insert into [StrSource] 
([Ar],[En])
select  ' ','Latin view'

insert into [StrSource] 
([Ar],[En])
select  '','Numbers'

insert into [StrSource] 
([Ar],[En])
select  '','Settings'

insert into [StrSource] 
([Ar],[En])
select  '','Maximum'

insert into [StrSource] 
([Ar],[En])
select  ' ','Required works'

insert into [StrSource] 
([Ar],[En])
select  '','Benefit'

insert into [StrSource] 
([Ar],[En])
select  '','Defults'

insert into [StrSource] 
([Ar],[En])
select  '','Defaults'

insert into [StrSource] 
([Ar],[En])
select  '','Premiums'

insert into [StrSource] 
([Ar],[En])
select  '','Emirate'

insert into [StrSource] 
([Ar],[En])
select  '','Please wait'

insert into [StrSource] 
([Ar],[En])
select  '','Types'

insert into [StrSource] 
([Ar],[En])
select  '  ','Note types'

insert into [StrSource] 
([Ar],[En])
select  '','Depreciation'

insert into [StrSource] 
([Ar],[En])
select  '','Depreciations'

insert into [StrSource] 
([Ar],[En])
select  ' ','Note papers'

insert into [StrSource] 
([Ar],[En])
select  '     ','Checks without any case'

insert into [StrSource] 
([Ar],[En])
select  '  ','Collected checks'

insert into [StrSource] 
([Ar],[En])
select  '  ','Returned checks'

insert into [StrSource] 
([Ar],[En])
select  '  ','Due checks'

insert into [StrSource] 
([Ar],[En])
select  '  ','Contracts cheque report'

insert into [StrSource] 
([Ar],[En])
select  '','The First'

insert into [StrSource] 
([Ar],[En])
select  '','Rent'

insert into [StrSource] 
([Ar],[En])
select  '    ','Rent by last registered contract'

insert into [StrSource] 
([Ar],[En])
select  '','Revenue'

insert into [StrSource] 
([Ar],[En])
select  '','Revenues'

insert into [StrSource] 
([Ar],[En])
select  ' ','Achieved Revenues'

insert into [StrSource] 
([Ar],[En])
select  ' ','Receipt duplicate'

insert into [StrSource] 
([Ar],[En])
select  '   : ','Land contained in contract:'

insert into [StrSource] 
([Ar],[En])
select  '','Exclusions'

insert into [StrSource] 
([Ar],[En])
select  '','Name'

insert into [StrSource] 
([Ar],[En])
select  ' ','Comercial name'

insert into [StrSource] 
([Ar],[En])
select  ' ','Completed works'

insert into [StrSource] 
([Ar],[En])
select  '','Colors'

insert into [StrSource] 
([Ar],[En])
select  '','Order'

insert into [StrSource] 
([Ar],[En])
select  '  ','Contract Securities'

insert into [StrSource] 
([Ar],[En])
select  '','First'

insert into [StrSource] 
([Ar],[En])
select  '','Deposit'

insert into [StrSource] 
([Ar],[En])
select  ' ','Saved revenues'

insert into [StrSource] 
([Ar],[En])
select  '','Salesman'

insert into [StrSource] 
([Ar],[En])
select  '','Barcode'

insert into [StrSource] 
([Ar],[En])
select  '','Rest'

insert into [StrSource] 
([Ar],[En])
select  '','The Search'

insert into [StrSource] 
([Ar],[En])
select  '  ','Search in contracts'

insert into [StrSource] 
([Ar],[En])
select  '','Program'

insert into [StrSource] 
([Ar],[En])
select  ' ','E-mail'

insert into [StrSource] 
([Ar],[En])
select  '  ','Customer Email'

insert into [StrSource] 
([Ar],[En])
select  '','ods'

insert into [StrSource] 
([Ar],[En])
select  '','Cards.'

insert into [StrSource] 
([Ar],[En])
select  '','Card'

insert into [StrSource] 
([Ar],[En])
select  '    : ','Card is opened from computer:'

insert into [StrSource] 
([Ar],[En])
select  '','Building'

insert into [StrSource] 
([Ar],[En])
select  ' ','Pent House'

insert into [StrSource] 
([Ar],[En])
select  '','Bank'

insert into [StrSource] 
([Ar],[En])
select  '','Banks'

insert into [StrSource] 
([Ar],[En])
select  '','Note'

insert into [StrSource] 
([Ar],[En])
select  ' 2','Note2'

insert into [StrSource] 
([Ar],[En])
select  ' ','Customs statement'

insert into [StrSource] 
([Ar],[En])
select  ' ','Notes Contain'

insert into [StrSource] 
([Ar],[En])
select  '','Data'

insert into [StrSource] 
([Ar],[En])
select  ' ','Financial data'

insert into [StrSource] 
([Ar],[En])
select  '       ','Data still unsaved, Do you want to ignore changes?'

insert into [StrSource] 
([Ar],[En])
select  '     ','Data used and cannot be deleted'

insert into [StrSource] 
([Ar],[En])
select  '','The Sales'

insert into [StrSource] 
([Ar],[En])
select  '','Security deposit'

insert into [StrSource] 
([Ar],[En])
select  '','Deposits'

insert into [StrSource] 
([Ar],[En])
select  '  ','effect on age'

insert into [StrSource] 
([Ar],[En])
select  '','Date'

insert into [StrSource] 
([Ar],[En])
select  ' ','Remind date'

insert into [StrSource] 
([Ar],[En])
select  '    ','Expected date to finish maintenance'

insert into [StrSource] 
([Ar],[En])
select  '     ','Date is smaller than fixed date'

insert into [StrSource] 
([Ar],[En])
select  '      ','Selected date is smaller than starting date'

insert into [StrSource] 
([Ar],[En])
select  '      ','Selected date is larger than starting date'

insert into [StrSource] 
([Ar],[En])
select  '  ','Date is not match'

insert into [StrSource] 
([Ar],[En])
select  ': ','Date:'

insert into [StrSource] 
([Ar],[En])
select  '','Next'

insert into [StrSource] 
([Ar],[En])
select  ' ','Realty Estimation'

insert into [StrSource] 
([Ar],[En])
select  ' ','Autor enew'

insert into [StrSource] 
([Ar],[En])
select  '','Issue'

insert into [StrSource] 
([Ar],[En])
select  '','Collection'

insert into [StrSource] 
([Ar],[En])
select  ' ','The Partial collection'

insert into [StrSource] 
([Ar],[En])
select  '   ','Partial collection generate journal entry'

insert into [StrSource] 
([Ar],[En])
select  '     ','Partial collection generate journal entry automatically'

insert into [StrSource] 
([Ar],[En])
select  '  ','Collection generate journal entry'

insert into [StrSource] 
([Ar],[En])
select  '    ','Collection generate journal entry automatically'

insert into [StrSource] 
([Ar],[En])
select  '   ','Checking the connection with server'

insert into [StrSource] 
([Ar],[En])
select  '','Analysis'

insert into [StrSource] 
([Ar],[En])
select  '','Check box'

insert into [StrSource] 
([Ar],[En])
select  '','Reminder'

insert into [StrSource] 
([Ar],[En])
select  '     ','Remind backup every'

insert into [StrSource] 
([Ar],[En])
select  '','Sorting'

insert into [StrSource] 
([Ar],[En])
select  '','Translate'

insert into [StrSource] 
([Ar],[En])
select  '','Posting'

insert into [StrSource] 
([Ar],[En])
select  '  ','Posting generate journal entry'

insert into [StrSource] 
([Ar],[En])
select  '    ','Posting generate journal entry automatically'

insert into [StrSource] 
([Ar],[En])
select  '','Licensing'

insert into [StrSource] 
([Ar],[En])
select  '','Pricing'

insert into [StrSource] 
([Ar],[En])
select  '','Sequence'

insert into [StrSource] 
([Ar],[En])
select  '','Class'

insert into [StrSource] 
([Ar],[En])
select  '   ','Classification with income statement'

insert into [StrSource] 
([Ar],[En])
select  '','Endrosement'

insert into [StrSource] 
([Ar],[En])
select  '  ','Endrosement generate journal entry'

insert into [StrSource] 
([Ar],[En])
select  '    ','Endrosement generate journal entry automatically'

insert into [StrSource] 
([Ar],[En])
select  '','Rate'

insert into [StrSource] 
([Ar],[En])
select  '','Details'

insert into [StrSource] 
([Ar],[En])
select  ' ','Realty Reports'

insert into [StrSource] 
([Ar],[En])
select  '  2','Realty Reports 2'

insert into [StrSource] 
([Ar],[En])
select  '    ','Accounting Reports'

insert into [StrSource] 
([Ar],[En])
select  ' ','Round to'

insert into [StrSource] 
([Ar],[En])
select  '','Report'

insert into [StrSource] 
([Ar],[En])
select  ' ','Monthly Report'

insert into [StrSource] 
([Ar],[En])
select  '  ','Comprehensive monthly report'

insert into [StrSource] 
([Ar],[En])
select  ' ','Warning printed'

insert into [StrSource] 
([Ar],[En])
select  '','Alerts'

insert into [StrSource] 
([Ar],[En])
select  '','Organization'

insert into [StrSource] 
([Ar],[En])
select  '','Implementation'

insert into [StrSource] 
([Ar],[En])
select  '','Characterization'

insert into [StrSource] 
([Ar],[En])
select  '  ','Signature not match'

insert into [StrSource] 
([Ar],[En])
select  '','Third'

insert into [StrSource] 
([Ar],[En])
select  '','The Third'

insert into [StrSource] 
([Ar],[En])
select  '','Second.'

insert into [StrSource] 
([Ar],[En])
select  '','Second'

insert into [StrSource] 
([Ar],[En])
select  '','Fixed value'

insert into [StrSource] 
([Ar],[En])
select  '  : ','Related table:'

insert into [StrSource] 
([Ar],[En])
select  '','The New'

insert into [StrSource] 
([Ar],[En])
select  '','Part'

insert into [StrSource] 
([Ar],[En])
select  '','Nationality'

insert into [StrSource] 
([Ar],[En])
select  ' ','Latin nationality'

insert into [StrSource] 
([Ar],[En])
select  '','Device'

insert into [StrSource] 
([Ar],[En])
select  '','Direction'

insert into [StrSource] 
([Ar],[En])
select  ' ','Issued by'

insert into [StrSource] 
([Ar],[En])
select  '  ','Receipt issued by'

insert into [StrSource] 
([Ar],[En])
select  '  ','Registered by'

insert into [StrSource] 
([Ar],[En])
select  '','Mobile'

insert into [StrSource] 
([Ar],[En])
select  '','Computer'

insert into [StrSource] 
([Ar],[En])
select  '','Calculator'

insert into [StrSource] 
([Ar],[En])
select  '','Clipboard'

insert into [StrSource] 
([Ar],[En])
select  '','Status'

insert into [StrSource] 
([Ar],[En])
select  '  ','Selected status only'

insert into [StrSource] 
([Ar],[En])
select  '','Current'

insert into [StrSource] 
([Ar],[En])
select  '','Booking'

insert into [StrSource] 
([Ar],[En])
select  ' ','Booking canceled'

insert into [StrSource] 
([Ar],[En])
select  ' ','Minimum'

insert into [StrSource] 
([Ar],[En])
select  '   ','Minimum level of collection commission'

insert into [StrSource] 
([Ar],[En])
select  ' ','the highest rate'

insert into [StrSource] 
([Ar],[En])
select  '   ','Maximum limit of discount rate'

insert into [StrSource] 
([Ar],[En])
select  '','Border'

insert into [StrSource] 
([Ar],[En])
select  '','Delete'

insert into [StrSource] 
([Ar],[En])
select  '      ','Delete all cheques at notes report'

insert into [StrSource] 
([Ar],[En])
select  '','Transaction'

insert into [StrSource] 
([Ar],[En])
select  '  ','Daily activity of contracts'

insert into [StrSource] 
([Ar],[En])
select  '','Account'

insert into [StrSource] 
([Ar],[En])
select  '   ','Main account of customers deposit account'

insert into [StrSource] 
([Ar],[En])
select  '  ','Buildings main account'

insert into [StrSource] 
([Ar],[En])
select  '  ','Customers main account'

insert into [StrSource] 
([Ar],[En])
select  '  ','suppliers main account'

insert into [StrSource] 
([Ar],[En])
select  ' ','Default account'

insert into [StrSource] 
([Ar],[En])
select  ' ','Ending account'

insert into [StrSource] 
([Ar],[En])
select  ' ','Credit account'

insert into [StrSource] 
([Ar],[En])
select  ' ','Main account'

insert into [StrSource] 
([Ar],[En])
select  '   ','The Main Insurance Account for tenants'

insert into [StrSource] 
([Ar],[En])
select  '  ','Customers deposit account'

insert into [StrSource] 
([Ar],[En])
select  ' ','Debit account'

insert into [StrSource] 
([Ar],[En])
select  ' ','Obverse account'

insert into [StrSource] 
([Ar],[En])
select  ' ','Account by'

insert into [StrSource] 
([Ar],[En])
select  '','Accounts'

insert into [StrSource] 
([Ar],[En])
select  ' ','Default accounts'

insert into [StrSource] 
([Ar],[En])
select  '   ','Default accounts of collection commission'

insert into [StrSource] 
([Ar],[En])
select  ' ','Balanced accounts'

insert into [StrSource] 
([Ar],[En])
select  ' ','Favorite accounts'

insert into [StrSource] 
([Ar],[En])
select  '','Discount'

insert into [StrSource] 
([Ar],[En])
select  ' ','Maximum discount'

insert into [StrSource] 
([Ar],[En])
select  '','Discounts '

insert into [StrSource] 
([Ar],[En])
select  '','Blocking'

insert into [StrSource] 
([Ar],[En])
select  '','Feild'

insert into [StrSource] 
([Ar],[En])
select  '','Feilds'

insert into [StrSource] 
([Ar],[En])
select  '   : ','Solution in contract:'

insert into [StrSource] 
([Ar],[En])
select  ' ','Registered at'

insert into [StrSource] 
([Ar],[En])
select  '','Basin'

insert into [StrSource] 
([Ar],[En])
select  '','Neighborhood'

insert into [StrSource] 
([Ar],[En])
select  '','Service'

insert into [StrSource] 
([Ar],[En])
select  '','Maps'

insert into [StrSource] 
([Ar],[En])
select  '','Credit'

insert into [StrSource] 
([Ar],[En])
select  '','Lawsuite'

insert into [StrSource] 
([Ar],[En])
select  ' ','Lawsuit'

insert into [StrSource] 
([Ar],[En])
select  '','Payments'

insert into [StrSource] 
([Ar],[En])
select  ' ','Due payments'

insert into [StrSource] 
([Ar],[En])
select  ' ','Cash payments'

insert into [StrSource] 
([Ar],[En])
select  '  ','Received cash payments'

insert into [StrSource] 
([Ar],[En])
select  '   ','Cash payments of revenue period'

insert into [StrSource] 
([Ar],[En])
select  '','Payment'

insert into [StrSource] 
([Ar],[En])
select  ' ','Last payment'

insert into [StrSource] 
([Ar],[En])
select  ' ','First payment'

insert into [StrSource] 
([Ar],[En])
select  '      ','First cash payment generates entry at cheque generation window'

insert into [StrSource] 
([Ar],[En])
select  ' ','Annual payment'

insert into [StrSource] 
([Ar],[En])
select  ' ','Monthly payment'

insert into [StrSource] 
([Ar],[En])
select  ' ','Due payment'

insert into [StrSource] 
([Ar],[En])
select  '','Country'

insert into [StrSource] 
([Ar],[En])
select  '','Link'

insert into [StrSource] 
([Ar],[En])
select  '','Profit '

insert into [StrSource] 
([Ar],[En])
select  '','License'

insert into [StrSource] 
([Ar],[En])
select  '  ','License to date'

insert into [StrSource] 
([Ar],[En])
select  '  ','License from date'

insert into [StrSource] 
([Ar],[En])
select  ' ','Short Message'

insert into [StrSource] 
([Ar],[En])
select  ' ','Sent SMS'

insert into [StrSource] 
([Ar],[En])
select  ' ','SMS Message'

insert into [StrSource] 
([Ar],[En])
select  '','Message'

insert into [StrSource] 
([Ar],[En])
select  '   ','Accounts Balance Chart'

insert into [StrSource] 
([Ar],[En])
select  '','Fees'

insert into [StrSource] 
([Ar],[En])
select  '','Balance'

insert into [StrSource] 
([Ar],[En])
select  '  ','Note balance of the customer'

insert into [StrSource] 
([Ar],[En])
select  ' ','Previous balance'

insert into [StrSource] 
([Ar],[En])
select  ' ','Actual balance'

insert into [StrSource] 
([Ar],[En])
select  ' ','Final balance'

insert into [StrSource] 
([Ar],[En])
select  ' ','Cumulative balance'

insert into [StrSource] 
([Ar],[En])
select  ' ','Credit balance'

insert into [StrSource] 
([Ar],[En])
select  ' ','Debit balance'

insert into [StrSource] 
([Ar],[En])
select  '','Number'

insert into [StrSource] 
([Ar],[En])
select  '   ','Default number to send SMS'

insert into [StrSource] 
([Ar],[En])
select  ' ','PACI Number'

insert into [StrSource] 
([Ar],[En])
select  '  ','Plot PACI  no'

insert into [StrSource] 
([Ar],[En])
select  '  ','Buliding  PACI no'

insert into [StrSource] 
([Ar],[En])
select  ' ','Serial Number'

insert into [StrSource] 
([Ar],[En])
select  ' ','New number'

insert into [StrSource] 
([Ar],[En])
select  ' ','Current number'

insert into [StrSource] 
([Ar],[En])
select  ' ','Internal Number'

insert into [StrSource] 
([Ar],[En])
select  '  ','Duplicate serial number'

insert into [StrSource] 
([Ar],[En])
select  '  ','Employee civil ID'

insert into [StrSource] 
([Ar],[En])
select  ' ','Unified No'

insert into [StrSource] 
([Ar],[En])
select  ' ','Duplicate number'

insert into [StrSource] 
([Ar],[En])
select  '','Code'

insert into [StrSource] 
([Ar],[En])
select  ' ','Special Code'

insert into [StrSource] 
([Ar],[En])
select  ' ','Latin code'

insert into [StrSource] 
([Ar],[En])
select  ' ','Duplicate code'

insert into [StrSource] 
([Ar],[En])
select  '','Customers'

insert into [StrSource] 
([Ar],[En])
select  ' ','Blocked customers'

insert into [StrSource] 
([Ar],[En])
select  '','Customer'

insert into [StrSource] 
([Ar],[En])
select  '                  ','The customer in this contract is different from the customer in the contract to be linked to the flat, are you sure to continue?'

insert into [StrSource] 
([Ar],[En])
select  '   ','Increase on the current contract'

insert into [StrSource] 
([Ar],[En])
select  '','Visits'

insert into [StrSource] 
([Ar],[En])
select  '','Client'

insert into [StrSource] 
([Ar],[En])
select  '','Previous'

insert into [StrSource] 
([Ar],[En])
select  ' >>','Previous >>'

insert into [StrSource] 
([Ar],[En])
select  '','Timing'

insert into [StrSource] 
([Ar],[En])
select  '','Registry'

insert into [StrSource] 
([Ar],[En])
select  ' ','Trading license'

insert into [StrSource] 
([Ar],[En])
select  '  ','Latin trading license'

insert into [StrSource] 
([Ar],[En])
select  '    / Feeder','Use feeder'

insert into [StrSource] 
([Ar],[En])
select  '','The Price'

insert into [StrSource] 
([Ar],[En])
select  ' ','Minimum price'

insert into [StrSource] 
([Ar],[En])
select  ' ','Maximum price'

insert into [StrSource] 
([Ar],[En])
select  ' ','unit price'

insert into [StrSource] 
([Ar],[En])
select  ' ','Average price'

insert into [StrSource] 
([Ar],[En])
select  '  ','Price after discount'

insert into [StrSource] 
([Ar],[En])
select  ' ','Price between'

insert into [StrSource] 
([Ar],[En])
select  ' ','price per unit'

insert into [StrSource] 
([Ar],[En])
select  '       ','Allow to add a new contract without terminate the old contract'

insert into [StrSource] 
([Ar],[En])
select  '         ','Allow adding a new contract for the same client without ending the old contract'

insert into [StrSource] 
([Ar],[En])
select  '     ','Allow leased units after sell it'

insert into [StrSource] 
([Ar],[En])
select  '       ','Allow users with full authorize passing fixed date of operations'

insert into [StrSource] 
([Ar],[En])
select  ' ','Current year'

insert into [StrSource] 
([Ar],[En])
select  '','Ownership voucher'

insert into [StrSource] 
([Ar],[En])
select  ' ','Cash entry'

insert into [StrSource] 
([Ar],[En])
select  ' ','Entry checked'

insert into [StrSource] 
([Ar],[En])
select  '   ','Vouchers'

insert into [StrSource] 
([Ar],[En])
select  ' ','Previous years'

insert into [StrSource] 
([Ar],[En])
select  '','Street'

insert into [StrSource] 
([Ar],[En])
select  ' ','Main road'

insert into [StrSource] 
([Ar],[En])
select  '','Shipping'

insert into [StrSource] 
([Ar],[En])
select  '','Company'

insert into [StrSource] 
([Ar],[En])
select  '','Flat'

insert into [StrSource] 
([Ar],[En])
select  '    : ','Flat reserved by:'

insert into [StrSource] 
([Ar],[En])
select  '   : ','The Flat in contract:'

insert into [StrSource] 
([Ar],[En])
select  '','Flats'

insert into [StrSource] 
([Ar],[En])
select  ' ','Leased apartments'

insert into [StrSource] 
([Ar],[En])
select  '','Complaints'

insert into [StrSource] 
([Ar],[En])
select  '','Shape'

insert into [StrSource] 
([Ar],[En])
select  '','Month'

insert into [StrSource] 
([Ar],[En])
select  ' 1','Month 1'

insert into [StrSource] 
([Ar],[En])
select  ' 10','Month 10'

insert into [StrSource] 
([Ar],[En])
select  ' 11','Month 11'

insert into [StrSource] 
([Ar],[En])
select  ' 12','Month 12'

insert into [StrSource] 
([Ar],[En])
select  ' 2','Month 2'

insert into [StrSource] 
([Ar],[En])
select  ' 3','Month 3'

insert into [StrSource] 
([Ar],[En])
select  ' 4','Month 4'

insert into [StrSource] 
([Ar],[En])
select  ' 5','Month 5'

insert into [StrSource] 
([Ar],[En])
select  ' 6','Month 6'

insert into [StrSource] 
([Ar],[En])
select  ' 7','Month 7'

insert into [StrSource] 
([Ar],[En])
select  ' 8','Month 8'

insert into [StrSource] 
([Ar],[En])
select  ' 9','Month 9'

insert into [StrSource] 
([Ar],[En])
select  '','Cheques'

insert into [StrSource] 
([Ar],[En])
select  ' ','Deferred cheques'

insert into [StrSource] 
([Ar],[En])
select  ' ','Collected cheques'

insert into [StrSource] 
([Ar],[En])
select  '   ','Collected checques of revenue period'

insert into [StrSource] 
([Ar],[En])
select  ' ','Returned cheques'

insert into [StrSource] 
([Ar],[En])
select  ' ','Received cheques'

insert into [StrSource] 
([Ar],[En])
select  '  ','Uncollected cheques'

insert into [StrSource] 
([Ar],[En])
select  '','Net'

insert into [StrSource] 
([Ar],[En])
select  '','Adjective'

insert into [StrSource] 
([Ar],[En])
select  ' ','Latin Adjective'

insert into [StrSource] 
([Ar],[En])
select  '','Instrument'

insert into [StrSource] 
([Ar],[En])
select  '','Permissions'

insert into [StrSource] 
([Ar],[En])
select  '','Permission'

insert into [StrSource] 
([Ar],[En])
select  '','Petty cash'

insert into [StrSource] 
([Ar],[En])
select  '','Catery'

insert into [StrSource] 
([Ar],[En])
select  ' ','Main catery'

insert into [StrSource] 
([Ar],[En])
select  '','Pictures'

insert into [StrSource] 
([Ar],[En])
select  ' ','Maintenance'

insert into [StrSource] 
([Ar],[En])
select  ' ','External Maintenance'

insert into [StrSource] 
([Ar],[En])
select  ' ','Internal Maintenance'

insert into [StrSource] 
([Ar],[En])
select  '','Suburb'

insert into [StrSource] 
([Ar],[En])
select  '  ','Multiplication by fixed number'

insert into [StrSource] 
([Ar],[En])
select  '  ','Multiplication by percentage'

insert into [StrSource] 
([Ar],[En])
select  '','Floor'

insert into [StrSource] 
([Ar],[En])
select  '','Printing'

insert into [StrSource] 
([Ar],[En])
select  '','Nature'

insert into [StrSource] 
([Ar],[En])
select  ' ','Used roads'

insert into [StrSource] 
([Ar],[En])
select  '','Orders'

insert into [StrSource] 
([Ar],[En])
select  '','Length'

insert into [StrSource] 
([Ar],[En])
select  ' ','Responsible worker'

insert into [StrSource] 
([Ar],[En])
select  '','Meter'

insert into [StrSource] 
([Ar],[En])
select  ' ','Current meter'

insert into [StrSource] 
([Ar],[En])
select  ' ','Previous meter'

insert into [StrSource] 
([Ar],[En])
select  '','Quantity'

insert into [StrSource] 
([Ar],[En])
select  ' ','Total number'

insert into [StrSource] 
([Ar],[En])
select  '  ','No in each floor'

insert into [StrSource] 
([Ar],[En])
select  '','Display'

insert into [StrSource] 
([Ar],[En])
select  '','Offers'

insert into [StrSource] 
([Ar],[En])
select  '','Property'

insert into [StrSource] 
([Ar],[En])
select  ' : ','Property:'

insert into [StrSource] 
([Ar],[En])
select  '  ','Unit and Maintenance works'

insert into [StrSource] 
([Ar],[En])
select  '','Properties'

insert into [StrSource] 
([Ar],[En])
select  '  ','Property maintenace contract'

insert into [StrSource] 
([Ar],[En])
select  '','Contract'

insert into [StrSource] 
([Ar],[En])
select  ' ','Related contract'

insert into [StrSource] 
([Ar],[En])
select  ' ','Contract checked'

insert into [StrSource] 
([Ar],[En])
select  ' ','Contract Expired'

insert into [StrSource] 
([Ar],[En])
select  '','Contracts'

insert into [StrSource] 
([Ar],[En])
select  '   ','Contracts near to expire'

insert into [StrSource] 
([Ar],[En])
select  '  ','Expired contracts'

insert into [StrSource] 
([Ar],[En])
select  '      ','Expired contracts and Non-terminated contracts'

insert into [StrSource] 
([Ar],[En])
select  '  ','Expired contract'

insert into [StrSource] 
([Ar],[En])
select  '','Workers'

insert into [StrSource] 
([Ar],[En])
select  '','Employees'

insert into [StrSource] 
([Ar],[En])
select  ' ','Useful life'

insert into [StrSource] 
([Ar],[En])
select  ' ','Action required'

insert into [StrSource] 
([Ar],[En])
select  '  ','Work in Hijri date format'

insert into [StrSource] 
([Ar],[En])
select  '','Currencies'

insert into [StrSource] 
([Ar],[En])
select  '','Currency'

insert into [StrSource] 
([Ar],[En])
select  ' ','Default currency'

insert into [StrSource] 
([Ar],[En])
select  '  ','Currency & Rate'

insert into [StrSource] 
([Ar],[En])
select  '','Operations'

insert into [StrSource] 
([Ar],[En])
select  '  ','Operations on asset'

insert into [StrSource] 
([Ar],[En])
select  '  ','Operations on cheques'

insert into [StrSource] 
([Ar],[En])
select  '    ','Operations in note report'

insert into [StrSource] 
([Ar],[En])
select  '','Operation'

insert into [StrSource] 
([Ar],[En])
select  '','Commission'

insert into [StrSource] 
([Ar],[En])
select  '  ','Commission from customer value'

insert into [StrSource] 
([Ar],[En])
select  '   ','Commission from owner value'

insert into [StrSource] 
([Ar],[En])
select  '','Client'

insert into [StrSource] 
([Ar],[En])
select  '     ','Element specified in another location'

insert into [StrSource] 
([Ar],[En])
select  '','Address'

insert into [StrSource] 
([Ar],[En])
select  ' ','Latin address'

insert into [StrSource] 
([Ar],[En])
select  ' ','Address contain'

insert into [StrSource] 
([Ar],[En])
select  '  ','Factors and projects affecting'

insert into [StrSource] 
([Ar],[En])
select  ' ','Cancel return'

insert into [StrSource] 
([Ar],[En])
select  ' ','Cancel'

insert into [StrSource] 
([Ar],[En])
select  ' ','Cancel collection'

insert into [StrSource] 
([Ar],[En])
select  ' ','Cancel endorsement'

insert into [StrSource] 
([Ar],[En])
select  ' ','Remove filter'

insert into [StrSource] 
([Ar],[En])
select  ' ','UnPost'

insert into [StrSource] 
([Ar],[En])
select  '','Fines'

insert into [StrSource] 
([Ar],[En])
select  '  ','Purpose of rent'

insert into [StrSource] 
([Ar],[En])
select  '  ','Purpose of the contract'

insert into [StrSource] 
([Ar],[En])
select  '   ','Purpose of the contract Latin'

insert into [StrSource] 
([Ar],[En])
select  '  ','Rooms and Flats'

insert into [StrSource] 
([Ar],[En])
select  ' ','Bill checked'

insert into [StrSource] 
([Ar],[En])
select  '','Period'

insert into [StrSource] 
([Ar],[En])
select  '','Sort'

insert into [StrSource] 
([Ar],[En])
select  ' ','Sort By'

insert into [StrSource] 
([Ar],[En])
select  '...','Sorting ...'

insert into [StrSource] 
([Ar],[En])
select  '','Brunch'

insert into [StrSource] 
([Ar],[En])
select  ' ','Main branch'

insert into [StrSource] 
([Ar],[En])
select  '','Difference'

insert into [StrSource] 
([Ar],[En])
select  '','Branches'

insert into [StrSource] 
([Ar],[En])
select  '','Actual'

insert into [StrSource] 
([Ar],[En])
select  '','Villas'

insert into [StrSource] 
([Ar],[En])
select  '    ','Leased and Non-leased villas'

insert into [StrSource] 
([Ar],[En])
select  '    ','Sold and Non-sold villas'

insert into [StrSource] 
([Ar],[En])
select  '','Bills'

insert into [StrSource] 
([Ar],[En])
select  '','Villa'

insert into [StrSource] 
([Ar],[En])
select  '','List'

insert into [StrSource] 
([Ar],[En])
select  '','Old'

insert into [StrSource] 
([Ar],[En])
select  '','Payemnt'

insert into [StrSource] 
([Ar],[En])
select  ' ','Fixed installment'

insert into [StrSource] 
([Ar],[En])
select  ' ','Increasing installment'

insert into [StrSource] 
([Ar],[En])
select  ' ','Decreasing installment'

insert into [StrSource] 
([Ar],[En])
select  '','Block'

insert into [StrSource] 
([Ar],[En])
select  ' ','Satellite'

insert into [StrSource] 
([Ar],[En])
select  '','Menus'

insert into [StrSource] 
([Ar],[En])
select  '  ','Do matching procedures'

insert into [StrSource] 
([Ar],[En])
select  ' ','Opening entry'

insert into [StrSource] 
([Ar],[En])
select  '   ','Journal Entry'

insert into [StrSource] 
([Ar],[En])
select  '       ','Journal entry does not contain customer account'

insert into [StrSource] 
([Ar],[En])
select  ' ','Multi entries'

insert into [StrSource] 
([Ar],[En])
select  '  ','Unposted entry'

insert into [StrSource] 
([Ar],[En])
select  '  ','illogical journal entry'

insert into [StrSource] 
([Ar],[En])
select  '      ','Entry has origin are you sure to modify?'

insert into [StrSource] 
([Ar],[En])
select  '    ','Entry is related to cheque collection'

insert into [StrSource] 
([Ar],[En])
select  '','Value'

insert into [StrSource] 
([Ar],[En])
select  ' 1','Value 1'

insert into [StrSource] 
([Ar],[En])
select  ' 2','Value 2'

insert into [StrSource] 
([Ar],[En])
select  ' ','Total value'

insert into [StrSource] 
([Ar],[En])
select  '    ','Primary value to calculate depreciation'

insert into [StrSource] 
([Ar],[En])
select  '  ','Default value'

insert into [StrSource] 
([Ar],[En])
select  ' ','New value'

insert into [StrSource] 
([Ar],[En])
select  '  ','New value of asset'

insert into [StrSource] 
([Ar],[En])
select  ' ','Current value'

insert into [StrSource] 
([Ar],[En])
select  ' ','Previous value'

insert into [StrSource] 
([Ar],[En])
select  ' ','Annual value'

insert into [StrSource] 
([Ar],[En])
select  ' ','Monthly value'

insert into [StrSource] 
([Ar],[En])
select  ' ','Residual value'

insert into [StrSource] 
([Ar],[En])
select  ' ','Value received'

insert into [StrSource] 
([Ar],[En])
select  '     ','Collected value is lager than total value'

insert into [StrSource] 
([Ar],[En])
select  '  ','Amount partly collected'

insert into [StrSource] 
([Ar],[En])
select  '       ,       ','The linked value with contract is different then the cheque amount, Do you want to redistribute the amount by percentages?'

insert into [StrSource] 
([Ar],[En])
select  ' ','Return Value'

insert into [StrSource] 
([Ar],[En])
select  '  ','Value due to owner'

insert into [StrSource] 
([Ar],[En])
select  '  ','Value due to tenant'

insert into [StrSource] 
([Ar],[En])
select  ' ','Value Between'

insert into [StrSource] 
([Ar],[En])
select  '  ','Value not collected'

insert into [StrSource] 
([Ar],[En])
select  ' ','Value as scrap'

insert into [StrSource] 
([Ar],[En])
select  '','Entries'

insert into [StrSource] 
([Ar],[En])
select  '','Warranty'

insert into [StrSource] 
([Ar],[En])
select  '','Sponser'

insert into [StrSource] 
([Ar],[En])
select  ' ','Latin Sponser'

insert into [StrSource] 
([Ar],[En])
select  '','All'

insert into [StrSource] 
([Ar],[En])
select  '','Cost'

insert into [StrSource] 
([Ar],[En])
select  ' ','Total cost'

insert into [StrSource] 
([Ar],[En])
select  ' ','Cost per unit'

insert into [StrSource] 
([Ar],[En])
select  '','Quantity'

insert into [StrSource] 
([Ar],[En])
select  ' 1','Quantity 1'

insert into [StrSource] 
([Ar],[En])
select  ' 2','Quantity 2'

insert into [StrSource] 
([Ar],[En])
select  ' 3','Quantity 3'

insert into [StrSource] 
([Ar],[En])
select  '  ','New Quantity become'

insert into [StrSource] 
([Ar],[En])
select  ' ','Current quantity'

insert into [StrSource] 
([Ar],[En])
select  '','Electricity'

insert into [StrSource] 
([Ar],[En])
select  '','Language'

insert into [StrSource] 
([Ar],[En])
select  '','Color'

insert into [StrSource] 
([Ar],[En])
select  ' ','1st Color'

insert into [StrSource] 
([Ar],[En])
select  ' ','2nd Color'

insert into [StrSource] 
([Ar],[En])
select  '','Lessor'

insert into [StrSource] 
([Ar],[En])
select  '','Leased'

insert into [StrSource] 
([Ar],[En])
select  '','Material'

insert into [StrSource] 
([Ar],[En])
select  '','The Owner'

insert into [StrSource] 
([Ar],[En])
select  ' ','Previous owner'

insert into [StrSource] 
([Ar],[En])
select  '','Sold '

insert into [StrSource] 
([Ar],[En])
select  ' ','Cash Amount'

insert into [StrSource] 
([Ar],[En])
select  '   ','Cash due'

insert into [StrSource] 
([Ar],[En])
select  '','Amount'

insert into [StrSource] 
([Ar],[En])
select  ' ','Total amount'

insert into [StrSource] 
([Ar],[En])
select  ' ','Remaining amount'

insert into [StrSource] 
([Ar],[En])
select  ' ','Due amount'

insert into [StrSource] 
([Ar],[En])
select  ' ','Paid amount'

insert into [StrSource] 
([Ar],[En])
select  ' ','Amount due'

insert into [StrSource] 
([Ar],[En])
select  ' ','Collected amount'

insert into [StrSource] 
([Ar],[En])
select  '','Trading sheet'

insert into [StrSource] 
([Ar],[En])
select  '','Overdue amounts'

insert into [StrSource] 
([Ar],[En])
select  '','Transgender'

insert into [StrSource] 
([Ar],[En])
select  '','Variables'

insert into [StrSource] 
([Ar],[En])
select  '','Folder'

insert into [StrSource] 
([Ar],[En])
select  '','Complex'

insert into [StrSource] 
([Ar],[En])
select  '','Total .'

insert into [StrSource] 
([Ar],[En])
select  ' ','Grand total'

insert into [StrSource] 
([Ar],[En])
select  '','Group'

insert into [StrSource] 
([Ar],[En])
select  ' ','Main group'

insert into [StrSource] 
([Ar],[En])
select  '','vernate'

insert into [StrSource] 
([Ar],[En])
select  '    F1','Contents    F1'

insert into [StrSource] 
([Ar],[En])
select  '','Reserved'

insert into [StrSource] 
([Ar],[En])
select  '','Collected'

insert into [StrSource] 
([Ar],[En])
select  ' / ','Collected / Value'

insert into [StrSource] 
([Ar],[En])
select  ' ','Previously collected'

insert into [StrSource] 
([Ar],[En])
select  '','Taken'

insert into [StrSource] 
([Ar],[En])
select  ' ','Partly Taken'

insert into [StrSource] 
([Ar],[En])
select  ' ','Partial collected'

insert into [StrSource] 
([Ar],[En])
select  ' ','Completely collected'

insert into [StrSource] 
([Ar],[En])
select  '','Blocked'

insert into [StrSource] 
([Ar],[En])
select  ' ','Real estate briefcase'

insert into [StrSource] 
([Ar],[En])
select  '','Shop'

insert into [StrSource] 
([Ar],[En])
select  '    : ','Shop is reserved by:'

insert into [StrSource] 
([Ar],[En])
select  '   : ','Shop inside contract:'

insert into [StrSource] 
([Ar],[En])
select  '','Shops'

insert into [StrSource] 
([Ar],[En])
select  '','Debit'

insert into [StrSource] 
([Ar],[En])
select  '','City'

insert into [StrSource] 
([Ar],[En])
select  '','Audited'

insert into [StrSource] 
([Ar],[En])
select  '  ','Checked for entries type'

insert into [StrSource] 
([Ar],[En])
select  ' ','Public facilities'

insert into [StrSource] 
([Ar],[En])
select  '','Discards'

insert into [StrSource] 
([Ar],[En])
select  ' / ','Returned / Value'

insert into [StrSource] 
([Ar],[En])
select  '','The Returned'

insert into [StrSource] 
([Ar],[En])
select  '','Posted'

insert into [StrSource] 
([Ar],[En])
select  ' / ','Posted / Value'

insert into [StrSource] 
([Ar],[En])
select  '','Posted'

insert into [StrSource] 
([Ar],[En])
select  '','Sent by'

insert into [StrSource] 
([Ar],[En])
select  '','Attachments'

insert into [StrSource] 
([Ar],[En])
select  '','Balance sheet'

insert into [StrSource] 
([Ar],[En])
select  '','Area'

insert into [StrSource] 
([Ar],[En])
select  ' ','Total area'

insert into [StrSource] 
([Ar],[En])
select  ' ','Leased area'

insert into [StrSource] 
([Ar],[En])
select  ' ','Area between'

insert into [StrSource] 
([Ar],[En])
select  '  ','Non-leased area'

insert into [StrSource] 
([Ar],[En])
select  ' ','Area from'

insert into [StrSource] 
([Ar],[En])
select  '  ','Space area and finishing'

insert into [StrSource] 
([Ar],[En])
select  '','File location'

insert into [StrSource] 
([Ar],[En])
select  ' ','Default path'

insert into [StrSource] 
([Ar],[En])
select  '   ','Default path to save documents'

insert into [StrSource] 
([Ar],[En])
select  ' ','New Path'

insert into [StrSource] 
([Ar],[En])
select  ' ','Old Path'

insert into [StrSource] 
([Ar],[En])
select  '','Tenant'

insert into [StrSource] 
([Ar],[En])
select  '','User'

insert into [StrSource] 
([Ar],[En])
select  '','Users'

insert into [StrSource] 
([Ar],[En])
select  ' ','Current users'

insert into [StrSource] 
([Ar],[En])
select  '','Beneficiary'

insert into [StrSource] 
([Ar],[En])
select  '','Voucher'

insert into [StrSource] 
([Ar],[En])
select  '','Store'

insert into [StrSource] 
([Ar],[En])
select  ' ','Default store'

insert into [StrSource] 
([Ar],[En])
select  ' ','Main Store'

insert into [StrSource] 
([Ar],[En])
select  '','Warehouses'

insert into [StrSource] 
([Ar],[En])
select  '','Level'

insert into [StrSource] 
([Ar],[En])
select  ' ','Scanning settings'

insert into [StrSource] 
([Ar],[En])
select  '','Expenses'

insert into [StrSource] 
([Ar],[En])
select  ' ','Customs expenses'

insert into [StrSource] 
([Ar],[En])
select  ' ','Internal expenses'

insert into [StrSource] 
([Ar],[En])
select  '','Source'

insert into [StrSource] 
([Ar],[En])
select  ' :','Term:'

insert into [StrSource] 
([Ar],[En])
select  ' ','New term'

insert into [StrSource] 
([Ar],[En])
select  '','Terms'

insert into [StrSource] 
([Ar],[En])
select  ' ','Old term'

insert into [StrSource] 
([Ar],[En])
select  '','Printed'

insert into [StrSource] 
([Ar],[En])
select  '','The Endorsement'

insert into [StrSource] 
([Ar],[En])
select  ' / ','Endorsement / Value'

insert into [StrSource] 
([Ar],[En])
select  '','Transactions'

insert into [StrSource] 
([Ar],[En])
select  ' ','Realty Transactions'

insert into [StrSource] 
([Ar],[En])
select  ' ','Accounting Transactions'

insert into [StrSource] 
([Ar],[En])
select  ' ','General Information'

insert into [StrSource] 
([Ar],[En])
select  ' ','Financial Information'

insert into [StrSource] 
([Ar],[En])
select  '','Key'

insert into [StrSource] 
([Ar],[En])
select  '','Offices'

insert into [StrSource] 
([Ar],[En])
select  '','Equivalent'

insert into [StrSource] 
([Ar],[En])
select  '','Notes'

insert into [StrSource] 
([Ar],[En])
select  ' 2','Notes 2'

insert into [StrSource] 
([Ar],[En])
select  '','Canceled'

insert into [StrSource] 
([Ar],[En])
select  '','File'

insert into [StrSource] 
([Ar],[En])
select  '  ','File is invalid'

insert into [StrSource] 
([Ar],[En])
select  '  ','File does not exist'

insert into [StrSource] 
([Ar],[En])
select  '  ','File already exist'

insert into [StrSource] 
([Ar],[En])
select  '  ','File already exists'

insert into [StrSource] 
([Ar],[En])
select  '','Ownership'

insert into [StrSource] 
([Ar],[En])
select  '','Areas'

insert into [StrSource] 
([Ar],[En])
select  '','Transfers'

insert into [StrSource] 
([Ar],[En])
select  '','Finished'

insert into [StrSource] 
([Ar],[En])
select  '','Origin'

insert into [StrSource] 
([Ar],[En])
select  '','Area name'

insert into [StrSource] 
([Ar],[En])
select  '','Occupation'

insert into [StrSource] 
([Ar],[En])
select  ' ','Latin Occupation'

insert into [StrSource] 
([Ar],[En])
select  '','Materials'

insert into [StrSource] 
([Ar],[En])
select  ' ','Used materials'

insert into [StrSource] 
([Ar],[En])
select  '','Specification'

insert into [StrSource] 
([Ar],[En])
select  '','Parking'

insert into [StrSource] 
([Ar],[En])
select  '    ','Leased and Non-leased Parking'

insert into [StrSource] 
([Ar],[En])
select  ' ','Sheltered parking'

insert into [StrSource] 
([Ar],[En])
select  '','Model'

insert into [StrSource] 
([Ar],[En])
select  '','Supplier'

insert into [StrSource] 
([Ar],[En])
select  '','Suppliers'

insert into [StrSource] 
([Ar],[En])
select  '','Subject'

insert into [StrSource] 
([Ar],[En])
select  '  Theme','Theme'

insert into [StrSource] 
([Ar],[En])
select  ' ','Subject contains'

insert into [StrSource] 
([Ar],[En])
select  '','Location'

insert into [StrSource] 
([Ar],[En])
select  ' ','Main location'

insert into [StrSource] 
([Ar],[En])
select  ' ','First location'

insert into [StrSource] 
([Ar],[En])
select  ' ','New location'

insert into [StrSource] 
([Ar],[En])
select  ' ','Current location'

insert into [StrSource] 
([Ar],[En])
select  '  ','Location on map'

insert into [StrSource] 
([Ar],[En])
select  '','Parkings'

insert into [StrSource] 
([Ar],[En])
select  '    : ','Parking is reserved by:'

insert into [StrSource] 
([Ar],[En])
select  '','Balance sheet'

insert into [StrSource] 
([Ar],[En])
select  '','Mezzanine'

insert into [StrSource] 
([Ar],[En])
select  '','Window'

insert into [StrSource] 
([Ar],[En])
select  '','Results'

insert into [StrSource] 
([Ar],[En])
select  '','Result'

insert into [StrSource] 
([Ar],[En])
select  '','Percentage'

insert into [StrSource] 
([Ar],[En])
select  ' %','Percentage %'

insert into [StrSource] 
([Ar],[En])
select  ' ','Paid percentage'

insert into [StrSource] 
([Ar],[En])
select  '  ','Auto backup'

insert into [StrSource] 
([Ar],[En])
select  ' ','Backup'

insert into [StrSource] 
([Ar],[En])
select  '   ','Backup on external device'

insert into [StrSource] 
([Ar],[En])
select  '   ','Backup is not valid'

insert into [StrSource] 
([Ar],[En])
select  '','Text'

insert into [StrSource] 
([Ar],[En])
select  '  ','Basin Filter System'

insert into [StrSource] 
([Ar],[En])
select  '','pattern'

insert into [StrSource] 
([Ar],[En])
select  ' ','Opened windows'

insert into [StrSource] 
([Ar],[En])
select  '','Type'

insert into [StrSource] 
([Ar],[En])
select  '','Phone'

insert into [StrSource] 
([Ar],[En])
select  '','Gifts'

insert into [StrSource] 
([Ar],[En])
select  '','Interfaces'

insert into [StrSource] 
([Ar],[En])
select  '','Units'

insert into [StrSource] 
([Ar],[En])
select  '   ','Units that will be vacated'

insert into [StrSource] 
([Ar],[En])
select  ' ','Empty units'

insert into [StrSource] 
([Ar],[En])
select  '   ','Leased and Non-leased units'

insert into [StrSource] 
([Ar],[En])
select  '   ','Sold and Non-sold units'

insert into [StrSource] 
([Ar],[En])
select  ' ','Blocked units'

insert into [StrSource] 
([Ar],[En])
select  '','Unit'

insert into [StrSource] 
([Ar],[En])
select  ' 2','Unit 2'

insert into [StrSource] 
([Ar],[En])
select  ' 3','Unit 3'

insert into [StrSource] 
([Ar],[En])
select  ' ','First unit'

insert into [StrSource] 
([Ar],[En])
select  ' ','Third unit'

insert into [StrSource] 
([Ar],[En])
select  ' ','Second unit'

insert into [StrSource] 
([Ar],[En])
select  ' ','Note paper'

insert into [StrSource] 
([Ar],[En])
select  '  ','Note is checked'

insert into [StrSource] 
([Ar],[En])
select  '','Average'

insert into [StrSource] 
([Ar],[En])
select  '','Description'

insert into [StrSource] 
([Ar],[En])
select  ' ','Arabic description'

insert into [StrSource] 
([Ar],[En])
select  ' ','Latin description'

insert into [StrSource] 
([Ar],[En])
select  ' ','Latin Description'

insert into [StrSource] 
([Ar],[En])
select  '','Ocupation'

insert into [StrSource] 
([Ar],[En])
select  '','To'

insert into [StrSource] 
([Ar],[En])
select  ' ','To account'

insert into [StrSource] 
([Ar],[En])
select  '  ','To selected users'

insert into [StrSource] 
([Ar],[En])
select  ' ','To store'

insert into [StrSource] 
([Ar],[En])
select  ' ','To location'

insert into [StrSource] 
([Ar],[En])
select  ' ','To pattern'

insert into [StrSource] 
([Ar],[En])
select  '  ','Previous contracts No'

insert into [StrSource] 
([Ar],[En])
select  '  ','Contracts total No'

insert into [StrSource] 
([Ar],[En])
select  '    ','Contracts No in previous years'

insert into [StrSource] 
([Ar],[En])
select  '    ','Contract No in old files'

insert into [StrSource] 
([Ar],[En])
select  '  ','Number of extra rooms'

insert into [StrSource] 
([Ar],[En])
select  '  ','Number of main rooms'

insert into [StrSource] 
([Ar],[En])
select  '  ','Leased villas No'

insert into [StrSource] 
([Ar],[En])
select  '   ','Non-leased villas No'

insert into [StrSource] 
([Ar],[En])
select  ' ','Shops count'

insert into [StrSource] 
([Ar],[En])
select  ' ','Basin count'

insert into [StrSource] 
([Ar],[En])
select  ' ','Warehouses No'

insert into [StrSource] 
([Ar],[En])
select  ' ','Play yards count'

insert into [StrSource] 
([Ar],[En])
select  '  ','Number of temporary copies'

insert into [StrSource] 
([Ar],[En])
select  '  ','Leased units Number'

insert into [StrSource] 
([Ar],[En])
select  '   ','Non-leased units number'

insert into [StrSource] 
([Ar],[En])
select  '  /  ','Number of days / months of depreciation'

insert into [StrSource] 
([Ar],[En])
select  '  ','Number of drivers flats'

insert into [StrSource] 
([Ar],[En])
select  '  ','Number of flats building'

insert into [StrSource] 
([Ar],[En])
select  '   ','Number of servants flats'

insert into [StrSource] 
([Ar],[En])
select  '  ','Drivers appartment count'

insert into [StrSource] 
([Ar],[En])
select  '  ','Dwell flats No'

insert into [StrSource] 
([Ar],[En])
select  '   ','Number of penthouse floors'

insert into [StrSource] 
([Ar],[En])
select  '  ','Number of flats floors'

insert into [StrSource] 
([Ar],[En])
select  '  ','Number of offices floors'

insert into [StrSource] 
([Ar],[En])
select  '  ','Number of parking floors'

insert into [StrSource] 
([Ar],[En])
select  '    ','Number of underground parking floors'

insert into [StrSource] 
([Ar],[En])
select  '  ','Number of mizanen floors'

insert into [StrSource] 
([Ar],[En])
select  '  ','Number of maid room'

insert into [StrSource] 
([Ar],[En])
select  '   SMS','Number of times send SMS'

insert into [StrSource] 
([Ar],[En])
select  '  ','Number of times printing'

insert into [StrSource] 
([Ar],[En])
select  '  ','Parking count'

insert into [StrSource] 
([Ar],[En])
select  '  ','Lighting points count'

insert into [StrSource] 
([Ar],[En])
select  '   ','Expected production units number'

insert into [StrSource] 
([Ar],[En])
select  ' ','No response'

insert into [StrSource] 
([Ar],[En])
select  '      ','Not terminate contract when there is a customer balance'

insert into [StrSource] 
([Ar],[En])
select  '  ','No balance'

insert into [StrSource] 
([Ar],[En])
select  '','Arabic'

insert into [StrSource] 
([Ar],[En])
select  '','Preview'

insert into [StrSource] 
([Ar],[En])
select  '    ','View due payable notes'

insert into [StrSource] 
([Ar],[En])
select  '    ','View due recievable notes'

insert into [StrSource] 
([Ar],[En])
select  ' ','View card'

insert into [StrSource] 
([Ar],[En])
select  ' ','View cheque'

insert into [StrSource] 
([Ar],[En])
select  ' ','View contract'

insert into [StrSource] 
([Ar],[En])
select  ' ','View bill'

insert into [StrSource] 
([Ar],[En])
select  ' ','View Voucher'

insert into [StrSource] 
([Ar],[En])
select  '  ','View posted entry'

insert into [StrSource] 
([Ar],[En])
select  '   ','View non-posted entry'

insert into [StrSource] 
([Ar],[En])
select  '  ','Show paid amount'

insert into [StrSource] 
([Ar],[En])
select  ' ','Show checked box'

insert into [StrSource] 
([Ar],[En])
select  ' ','View Refrence'

insert into [StrSource] 
([Ar],[En])
select  '  ','View service materials'

insert into [StrSource] 
([Ar],[En])
select  '   ','View empty materials'

insert into [StrSource] 
([Ar],[En])
select  '   ','View stocking materials'

insert into [StrSource] 
([Ar],[En])
select  ' ','Show by balance'

insert into [StrSource] 
([Ar],[En])
select  ' ','Show by total'

insert into [StrSource] 
([Ar],[En])
select  ' ','Quotation Card'

insert into [StrSource] 
([Ar],[En])
select  '  ','Show cost price'

insert into [StrSource] 
([Ar],[En])
select  '  ','Show Unchecked box'

insert into [StrSource] 
([Ar],[En])
select  '  ','View un-checked'

insert into [StrSource] 
([Ar],[En])
select  ' ','View voucher'

insert into [StrSource] 
([Ar],[En])
select  '  ','View deposit entry'

insert into [StrSource] 
([Ar],[En])
select  '   ','View due amount entry'

insert into [StrSource] 
([Ar],[En])
select  '  ','Show cost center'

insert into [StrSource] 
([Ar],[En])
select  '   PDF  ','View PDF files'

insert into [StrSource] 
([Ar],[En])
select  ' ','Quotations'

insert into [StrSource] 
([Ar],[En])
select  ' ','Various offers'

insert into [StrSource] 
([Ar],[En])
select  '','Bold'

insert into [StrSource] 
([Ar],[En])
select  ' ','Land contract'

insert into [StrSource] 
([Ar],[En])
select  '  ','Land rent contract'

insert into [StrSource] 
([Ar],[En])
select  '  ','Flat rent contract'

insert into [StrSource] 
([Ar],[En])
select  '  ','Villa rent contract'

insert into [StrSource] 
([Ar],[En])
select  '  ','Shop rent contract'

insert into [StrSource] 
([Ar],[En])
select  '  ','Parking rent contract'

insert into [StrSource] 
([Ar],[En])
select  '   ','Flat contract linked to parking'

insert into [StrSource] 
([Ar],[En])
select  ' ','Maintenance contract'

insert into [StrSource] 
([Ar],[En])
select  '  1','Lease an apartment 1'

insert into [StrSource] 
([Ar],[En])
select  '  ','Land selling contract'

insert into [StrSource] 
([Ar],[En])
select  '  ','Flat selling contract'

insert into [StrSource] 
([Ar],[En])
select  '  ','Villa selling contract'

insert into [StrSource] 
([Ar],[En])
select  '  ','Shop selling contract'

insert into [StrSource] 
([Ar],[En])
select  '  ','Parking selling contract'

insert into [StrSource] 
([Ar],[En])
select  ' ','Services contract'

insert into [StrSource] 
([Ar],[En])
select  ' ','Parking contract'

insert into [StrSource] 
([Ar],[En])
select  '   ','Rent contracts'

insert into [StrSource] 
([Ar],[En])
select  '   ','Selling contracts'

insert into [StrSource] 
([Ar],[En])
select  ' ','Services contracts'

insert into [StrSource] 
([Ar],[En])
select  ' ','Maintenance contracts'

insert into [StrSource] 
([Ar],[En])
select  '  ','Related parking contracts'

insert into [StrSource] 
([Ar],[En])
select  '','on him'

insert into [StrSource] 
([Ar],[En])
select  '  ','He has a lawsuit'

insert into [StrSource] 
([Ar],[En])
select  '  ','she has a lawsuit'

insert into [StrSource] 
([Ar],[En])
select  ' ','Maintenance workers'

insert into [StrSource] 
([Ar],[En])
select  ' ','Asset age'

insert into [StrSource] 
([Ar],[En])
select  '','Operations'

insert into [StrSource] 
([Ar],[En])
select  '  ','Notes operations'

insert into [StrSource] 
([Ar],[En])
select  ' ','Maintenance operations'

insert into [StrSource] 
([Ar],[En])
select  '','Vertical'

insert into [StrSource] 
([Ar],[En])
select  ' ','Service commission'

insert into [StrSource] 
([Ar],[En])
select  ' ','When termination'

insert into [StrSource] 
([Ar],[En])
select  ' ','When add'

insert into [StrSource] 
([Ar],[En])
select  ' ','Map element'

insert into [StrSource] 
([Ar],[En])
select  ' ','Customer address'

insert into [StrSource] 
([Ar],[En])
select  '','Return'

insert into [StrSource] 
([Ar],[En])
select  ' ','Returns fines'

insert into [StrSource] 
([Ar],[En])
select  ' ','Termination fines'

insert into [StrSource] 
([Ar],[En])
select  ' ','Return fee'

insert into [StrSource] 
([Ar],[En])
select  ' ','Delay fees'

insert into [StrSource] 
([Ar],[En])
select  '  ','Returned cheque fees'

insert into [StrSource] 
([Ar],[En])
select  '','West'

insert into [StrSource] 
([Ar],[En])
select  ' ','Main room'

insert into [StrSource] 
([Ar],[En])
select  ' ','Driver room'

insert into [StrSource] 
([Ar],[En])
select  ' ','Unsold'

insert into [StrSource] 
([Ar],[En])
select  ' ','Un-collected'

insert into [StrSource] 
([Ar],[En])
select  ' ','Un-blocking'

insert into [StrSource] 
([Ar],[En])
select  ' ','Unblocked'

insert into [StrSource] 
([Ar],[En])
select  ' ','Not returned'

insert into [StrSource] 
([Ar],[En])
select  '  / ','Not deposit \ Value'

insert into [StrSource] 
([Ar],[En])
select  ' ','Not Sent'

insert into [StrSource] 
([Ar],[En])
select  ' ','Not Printed'

insert into [StrSource] 
([Ar],[En])
select  ' ','Un-finished'

insert into [StrSource] 
([Ar],[En])
select  '  ','Unable to return'

insert into [StrSource] 
([Ar],[En])
select  '  ','Unable to collect'

insert into [StrSource] 
([Ar],[En])
select  '  ','Unable to deposit'

insert into [StrSource] 
([Ar],[En])
select  '  ','Unable to endorsement'

insert into [StrSource] 
([Ar],[En])
select  ' ','Non-leased'

insert into [StrSource] 
([Ar],[En])
select  ' ','Not sold'

insert into [StrSource] 
([Ar],[En])
select  ' ','Not specified'

insert into [StrSource] 
([Ar],[En])
select  ' ','Uncollected'

insert into [StrSource] 
([Ar],[En])
select  '  ','It is already not collected'

insert into [StrSource] 
([Ar],[En])
select  ' ','UnChecked'

insert into [StrSource] 
([Ar],[En])
select  '  ','It is already not returned'

insert into [StrSource] 
([Ar],[En])
select  ' ','Not posted'

insert into [StrSource] 
([Ar],[En])
select  '  ','It is already not posted'

insert into [StrSource] 
([Ar],[En])
select  '  ','Not posted to bank'

insert into [StrSource] 
([Ar],[En])
select  ' ','Not refunded'

insert into [StrSource] 
([Ar],[En])
select  '  ','It is already not endorsed'

insert into [StrSource] 
([Ar],[En])
select  ' ','Not endorsed'

insert into [StrSource] 
([Ar],[En])
select  ' ','valid'

insert into [StrSource] 
([Ar],[En])
select  '  ','Not expired'

insert into [StrSource] 
([Ar],[En])
select  ' ','Not available'

insert into [StrSource] 
([Ar],[En])
select  ' ','Electricity bill'

insert into [StrSource] 
([Ar],[En])
select  '  ','Bill of materials'

insert into [StrSource] 
([Ar],[En])
select  ' ','Sales bill'

insert into [StrSource] 
([Ar],[En])
select  '  ','Sales return bill'

insert into [StrSource] 
([Ar],[En])
select  '  ','Purchase return bill'

insert into [StrSource] 
([Ar],[En])
select  ' ','Purchase bill'

insert into [StrSource] 
([Ar],[En])
select  '','Fax'

insert into [StrSource] 
([Ar],[En])
select  '','Open'

insert into [StrSource] 
([Ar],[En])
select  ' ','Open Settings'

insert into [StrSource] 
([Ar],[En])
select  ' ','Open data'

insert into [StrSource] 
([Ar],[En])
select  ' ','Open Lawsuit'

insert into [StrSource] 
([Ar],[En])
select  '  ','Open chart of account'

insert into [StrSource] 
([Ar],[En])
select  '   ','Open chart of cost center'

insert into [StrSource] 
([Ar],[En])
select  '       ','Open the selected type of the bill for materials used for maintenance visit'

insert into [StrSource] 
([Ar],[En])
select  '    ','Revenue period from date'

insert into [StrSource] 
([Ar],[En])
select  '  ','Collection & Revenue Period'

insert into [StrSource] 
([Ar],[En])
select  '  ','Revenue period'

insert into [StrSource] 
([Ar],[En])
select  '   : ','Revenue calculate period:'

insert into [StrSource] 
([Ar],[En])
select  '  ','Check customers blocking'

insert into [StrSource] 
([Ar],[En])
select  '    ','Examination of the amount of the warehouse upon delivery'

insert into [StrSource] 
([Ar],[En])
select  '     ','Examination of the amount of the warehouse when creating order'

insert into [StrSource] 
([Ar],[En])
select  '','Person'

insert into [StrSource] 
([Ar],[En])
select  '    ','Force filling details for each line'

insert into [StrSource] 
([Ar],[En])
select  '     ','Force filling cost center for each line'

insert into [StrSource] 
([Ar],[En])
select  '  ','Contract terminate difference'

insert into [StrSource] 
([Ar],[En])
select  '  ','Currency rate differences'

insert into [StrSource] 
([Ar],[En])
select  '','Failed'

insert into [StrSource] 
([Ar],[En])
select  '','Filter'

insert into [StrSource] 
([Ar],[En])
select  ' ','New filter'

insert into [StrSource] 
([Ar],[En])
select  ' ','Electricity bills'

insert into [StrSource] 
([Ar],[En])
select  '','Villa'

insert into [StrSource] 
([Ar],[En])
select  '  ','Cash flow statement'

insert into [StrSource] 
([Ar],[En])
select  '  ','Financial position statement'

insert into [StrSource] 
([Ar],[En])
select  ' ','Can be returned'

insert into [StrSource] 
([Ar],[En])
select  ' ','Can be build'

insert into [StrSource] 
([Ar],[En])
select  '  ','Allow automatic renewal'

insert into [StrSource] 
([Ar],[En])
select  ' ','Can be collected'

insert into [StrSource] 
([Ar],[En])
select  '  ','Can be partial collection'

insert into [StrSource] 
([Ar],[En])
select  ' ','Can be posted'

insert into [StrSource] 
([Ar],[En])
select  ' ','Can be endrosed'

insert into [StrSource] 
([Ar],[En])
select  '      ','Database already exists please use another name'

insert into [StrSource] 
([Ar],[En])
select  '   ','Before starting restore process'

insert into [StrSource] 
([Ar],[En])
select  '      ','Results will be different depending on the specific conditions of report'

insert into [StrSource] 
([Ar],[En])
select  ' ','Meter reading
'

insert into [StrSource] 
([Ar],[En])
select  '  ','Electricity meter reading'

insert into [StrSource] 
([Ar],[En])
select  '   ','Building electricity meter reading'

insert into [StrSource] 
([Ar],[En])
select  '  ','Buliding Meter reading
'

insert into [StrSource] 
([Ar],[En])
select  ' ','Near to evacuate'

insert into [StrSource] 
([Ar],[En])
select  '  ','Contract near to expire'

insert into [StrSource] 
([Ar],[En])
select  '','Cut'

insert into [StrSource] 
([Ar],[En])
select  '   ','First delete asset'

insert into [StrSource] 
([Ar],[En])
select  '    ','First you have to delete all related operations'

insert into [StrSource] 
([Ar],[En])
select  '    ','First you have to save current card'

insert into [StrSource] 
([Ar],[En])
select  '    ','First delete current card'

insert into [StrSource] 
([Ar],[En])
select  '   ','First delete card'

insert into [StrSource] 
([Ar],[En])
select  '   : ','You chose: '

insert into [StrSource] 
([Ar],[En])
select  ' ','Income Statement'

insert into [StrSource] 
([Ar],[En])
select  '','Entry'

insert into [StrSource] 
([Ar],[En])
select  ' ','Opening journal entry'

insert into [StrSource] 
([Ar],[En])
select  ' ','Return entry'

insert into [StrSource] 
([Ar],[En])
select  ' ','Under process'

insert into [StrSource] 
([Ar],[En])
select  ' ','Collect entry'

insert into [StrSource] 
([Ar],[En])
select  '  ','Partial collect entry'

insert into [StrSource] 
([Ar],[En])
select  ' ','Deposit entry'

insert into [StrSource] 
([Ar],[En])
select  ' ','Endorsement entry'

insert into [StrSource] 
([Ar],[En])
select  ' ','Note entry'

insert into [StrSource] 
([Ar],[En])
select  '  ','General ledger entry'

insert into [StrSource] 
([Ar],[En])
select  ' ','Inverse entry'

insert into [StrSource] 
([Ar],[En])
select  '    ','Inversed entry from entry No'

insert into [StrSource] 
([Ar],[En])
select  '   ','Exchange rate entry'

insert into [StrSource] 
([Ar],[En])
select  '   ','Last payment value'

insert into [StrSource] 
([Ar],[En])
select  '  ','Electricity consumption value'

insert into [StrSource] 
([Ar],[En])
select  '  ','Water consumption value'

insert into [StrSource] 
([Ar],[En])
select  ' ','Input value'

insert into [StrSource] 
([Ar],[En])
select  ' ','Land value'

insert into [StrSource] 
([Ar],[En])
select  '  ','Land current value'

insert into [StrSource] 
([Ar],[En])
select  ' ','Investment value'

insert into [StrSource] 
([Ar],[En])
select  ' ','Consumption value'

insert into [StrSource] 
([Ar],[En])
select  ' ','Asset value'

insert into [StrSource] 
([Ar],[En])
select  '  ','Asset value as scrap'

insert into [StrSource] 
([Ar],[En])
select  ' ','Extra value '

insert into [StrSource] 
([Ar],[En])
select  ' ','Depreciation value'

insert into [StrSource] 
([Ar],[En])
select  '  ','Empty days value'

insert into [StrSource] 
([Ar],[En])
select  ' ','Rent value'

insert into [StrSource] 
([Ar],[En])
select  ' ','Receipt value'

insert into [StrSource] 
([Ar],[En])
select  ' ','Selling value'

insert into [StrSource] 
([Ar],[En])
select  '  ','Current deposit value'

insert into [StrSource] 
([Ar],[En])
select  '  ','Previous deposit value'

insert into [StrSource] 
([Ar],[En])
select  ' ','Discount value'

insert into [StrSource] 
([Ar],[En])
select  ' ','Scrap value'

insert into [StrSource] 
([Ar],[En])
select  '  ','Late payments value'

insert into [StrSource] 
([Ar],[En])
select  '  ','Collected payments value'

insert into [StrSource] 
([Ar],[En])
select  '   ','Partial collected payments value'

insert into [StrSource] 
([Ar],[En])
select  '  ','Due payments value'

insert into [StrSource] 
([Ar],[En])
select  '   ','Partial due payments value'

insert into [StrSource] 
([Ar],[En])
select  '  ','Cash payments value'

insert into [StrSource] 
([Ar],[En])
select  ' ','Payment value'

insert into [StrSource] 
([Ar],[En])
select  ' ','Fees amount'

insert into [StrSource] 
([Ar],[En])
select  ' ','Fees value'

insert into [StrSource] 
([Ar],[En])
select  '    ','Increased value on current contract'

insert into [StrSource] 
([Ar],[En])
select  ' ','Cheque value'

insert into [StrSource] 
([Ar],[En])
select  '  ','Sewerage value'

insert into [StrSource] 
([Ar],[En])
select  ' ','Contract amount'

insert into [StrSource] 
([Ar],[En])
select  '   ','Discounted contract amount '

insert into [StrSource] 
([Ar],[En])
select  '   ','Contract value after Increased'

insert into [StrSource] 
([Ar],[En])
select  '  ','Salesman commission value'

insert into [StrSource] 
([Ar],[En])
select  '   ','Commission amount from customer'

insert into [StrSource] 
([Ar],[En])
select  '    ','Commission amount from owner'

insert into [StrSource] 
([Ar],[En])
select  ' ','Installment value'

insert into [StrSource] 
([Ar],[En])
select  ' ','Water value'

insert into [StrSource] 
([Ar],[En])
select  '   ','Partial due amounts value'

insert into [StrSource] 
([Ar],[En])
select  ' ','Expenses amount'

insert into [StrSource] 
([Ar],[En])
select  '  ','Depreciation account value'

insert into [StrSource] 
([Ar],[En])
select  '  ','Value from field'

insert into [StrSource] 
([Ar],[En])
select  ' ','January'

insert into [StrSource] 
([Ar],[En])
select  ' ','Land report'

insert into [StrSource] 
([Ar],[En])
select  ' ','Building report'

insert into [StrSource] 
([Ar],[En])
select  ' ','Flats report'

insert into [StrSource] 
([Ar],[En])
select  '  ','Various offers report'

insert into [StrSource] 
([Ar],[En])
select  ' ','Contract report'

insert into [StrSource] 
([Ar],[En])
select  '  ','Customer account statement'

insert into [StrSource] 
([Ar],[En])
select  '  ','Customer properties report'

insert into [StrSource] 
([Ar],[En])
select  '  ','Services contracts report'

insert into [StrSource] 
([Ar],[En])
select  '  ','Maintenance contracts report'

insert into [StrSource] 
([Ar],[En])
select  '','Every'

insert into [StrSource] 
([Ar],[En])
select  ' ','Every week'

insert into [StrSource] 
([Ar],[En])
select  ' ','Full authoritize'

insert into [StrSource] 
([Ar],[En])
select  '   ','Each account on a separate sheet'

insert into [StrSource] 
([Ar],[En])
select  ' ','Every month'

insert into [StrSource] 
([Ar],[En])
select  ' ','Every day'

insert into [StrSource] 
([Ar],[En])
select  '','Both'

insert into [StrSource] 
([Ar],[En])
select  '  ','Sold flat cost'

insert into [StrSource] 
([Ar],[En])
select  ' ','Property cost'

insert into [StrSource] 
([Ar],[En])
select  ' ','Shop cost'

insert into [StrSource] 
([Ar],[En])
select  ' ','Project cost'

insert into [StrSource] 
([Ar],[En])
select  ' ','Parking cost'

insert into [StrSource] 
([Ar],[En])
select  ' ','Unit cost'

insert into [StrSource] 
([Ar],[En])
select  ' ','Password'

insert into [StrSource] 
([Ar],[En])
select  '  ','New Password'

insert into [StrSource] 
([Ar],[En])
select  '   ','Old Password'

insert into [StrSource] 
([Ar],[En])
select  '   ','Password is incorrect'

insert into [StrSource] 
([Ar],[En])
select  '  ','Electricity consumption amount'

insert into [StrSource] 
([Ar],[En])
select  '  ','Water consumption amount'

insert into [StrSource] 
([Ar],[En])
select  '  [X]','Consumption quantity [X]'

insert into [StrSource] 
([Ar],[En])
select  ' ','Distribution method'

insert into [StrSource] 
([Ar],[En])
select  '','No'

insert into [StrSource] 
([Ar],[En])
select  '     ','You don''t have permission to do this operation'

insert into [StrSource] 
([Ar],[En])
select  '     
  

  ','You don''t have permission to do this operation because of security level
Contact your system administrator'

insert into [StrSource] 
([Ar],[En])
select  '       ','You dont have permission for this operation Check with your System Administrator'

insert into [StrSource] 
([Ar],[En])
select  '     ','You don''t have permission to see all information'

insert into [StrSource] 
([Ar],[En])
select  '     ','You don''t have permission to modify contracts made by another user'

insert into [StrSource] 
([Ar],[En])
select  '   ','No result'

insert into [StrSource] 
([Ar],[En])
select  '     ','You should not change the default currency rate'

insert into [StrSource] 
([Ar],[En])
select  ' ','Not contain'

insert into [StrSource] 
([Ar],[En])
select  '    ,     : ','Reservations can not be completed, the property leased, Contract No:'

insert into [StrSource] 
([Ar],[En])
select  '    ,     : ','Reservations can not be completed, the property is reserved, card number:'

insert into [StrSource] 
([Ar],[En])
select  '    ,     : ','Can not complete the contract, the property leased, Contract No:'

insert into [StrSource] 
([Ar],[En])
select  '    ,      : ','Can not complete the contract, the property sold Contract No:'

insert into [StrSource] 
([Ar],[En])
select  '    ,     : ','Can not complete the contract, the property is reserved, card number:'

insert into [StrSource] 
([Ar],[En])
select  '      ','The contract can not be completed because the parking is reserved'

insert into [StrSource] 
([Ar],[En])
select  '   ','Can not complete the process'

insert into [StrSource] 
([Ar],[En])
select  '    : ','Account can not be inserted:'

insert into [StrSource] 
([Ar],[En])
select  '          ','Unable to add sub-cost center to cost center already used in flat card'

insert into [StrSource] 
([Ar],[En])
select  '          ','Unable to add sub-cost center to cost center already used in journal entry'

insert into [StrSource] 
([Ar],[En])
select  '        ','You can not add sub-account to account used in entries'

insert into [StrSource] 
([Ar],[En])
select  '        : ','You can not add the flat because it is contained in the contract:'

insert into [StrSource] 
([Ar],[En])
select  '        : ','You can not add the shop because it is contained in the contract:'

insert into [StrSource] 
([Ar],[En])
select  '           ','Main group can''t be the same group itself or its sons'

insert into [StrSource] 
([Ar],[En])
select  '             ','Main store can''t be the same store itself or its sons'

insert into [StrSource] 
([Ar],[En])
select  '           ','Closing account can''t be the same account itself or its sons'

insert into [StrSource] 
([Ar],[En])
select  '           ','Main account can''t be the same account itself or its sons'

insert into [StrSource] 
([Ar],[En])
select  '           ','Main cost center account can''t be the same account itself or its sons'

insert into [StrSource] 
([Ar],[En])
select  '       ','Unable to modify now'

insert into [StrSource] 
([Ar],[En])
select  '       ','Unable to do this operation now'

insert into [StrSource] 
([Ar],[En])
select  '    ','Can not do this operation'

insert into [StrSource] 
([Ar],[En])
select  '    ','Unable to generate cost center'

insert into [StrSource] 
([Ar],[En])
select  '       ','Unable to delete current journal entry because it''s has origin'

insert into [StrSource] 
([Ar],[En])
select  '    ','Can not save empty entry'

insert into [StrSource] 
([Ar],[En])
select  '    ','No map for selected type'

insert into [StrSource] 
([Ar],[En])
select  '  ','No lawsuit'

insert into [StrSource] 
([Ar],[En])
select  '','Latin'

insert into [StrSource] 
([Ar],[En])
select  '','Nothing'

insert into [StrSource] 
([Ar],[En])
select  '   ','because this check is collected'

insert into [StrSource] 
([Ar],[En])
select  '    ','because this check is already collected'

insert into [StrSource] 
([Ar],[En])
select  '   ','because this check is already returned'

insert into [StrSource] 
([Ar],[En])
select  '    ','because this check is already deposited'

insert into [StrSource] 
([Ar],[En])
select  '   ','because this check is already endorsed'

insert into [StrSource] 
([Ar],[En])
select  ' ','Do not automatically renewed'

insert into [StrSource] 
([Ar],[En])
select  ' ','No journal entry'

insert into [StrSource] 
([Ar],[En])
select  '     ','To apply changes you must restart the program'

insert into [StrSource] 
([Ar],[En])
select  '         ','To apply the changes you must restart the program
Do you want to restart now?'

insert into [StrSource] 
([Ar],[En])
select  '         ','To apply changes you must restart the program
Do you want to restart programs now?'

insert into [StrSource] 
([Ar],[En])
select  '   ','To retrieve apartments latest price'

insert into [StrSource] 
([Ar],[En])
select  '     ','You have a new version of the program'

insert into [StrSource] 
([Ar],[En])
select  '     
  
      ','You have a new version of the program 
You must update the files 
Do you want to update now?'

insert into [StrSource] 
([Ar],[En])
select  '  ','for arabic message'

insert into [StrSource] 
([Ar],[En])
select  '  ','for english message'

insert into [StrSource] 
([Ar],[En])
select  '','Paste'

insert into [StrSource] 
([Ar],[En])
select  ' ','Paste table'

insert into [StrSource] 
([Ar],[En])
select  ' ','Paste all'

insert into [StrSource] 
([Ar],[En])
select  '     ','You have exceeded limit of discount rate'

insert into [StrSource] 
([Ar],[En])
select  ' ','Arabic in words'

insert into [StrSource] 
([Ar],[En])
select  ' ','Latin in words'

insert into [StrSource] 
([Ar],[En])
select  '','For Print'

insert into [StrSource] 
([Ar],[En])
select  ' ','Latin printing'

insert into [StrSource] 
([Ar],[En])
select  '  ','Click Next to continue'

insert into [StrSource] 
([Ar],[En])
select  '      ','Failed to generate the entries of due cash amount'

insert into [StrSource] 
([Ar],[En])
select  '    ','Failed to generate deposit entries'

insert into [StrSource] 
([Ar],[En])
select  '  ','Maintenance not finish'

insert into [StrSource] 
([Ar],[En])
select  '  ','Processing not complete'

insert into [StrSource] 
([Ar],[En])
select  '       ','Generating entries process for duo amount does not succeed'

insert into [StrSource] 
([Ar],[En])
select  ' ','Process not finish'

insert into [StrSource] 
([Ar],[En])
select  '       ','No backup copy has been taken yet'

insert into [StrSource] 
([Ar],[En])
select  '  ','Contract not terminated'

insert into [StrSource] 
([Ar],[En])
select  '  ','Not deposit'

insert into [StrSource] 
([Ar],[En])
select  '  ','Not Implemented'

insert into [StrSource] 
([Ar],[En])
select  '    ','Jobcost not created'

insert into [StrSource] 
([Ar],[En])
select  '                ','Opening entry number which will be excluded does not specified ,the report may contain wrong information'

insert into [StrSource] 
([Ar],[En])
select  '     ','All alerts doesnt show'

insert into [StrSource] 
([Ar],[En])
select  '  ','Time not ripe'

insert into [StrSource] 
([Ar],[En])
select  '   ','Failed to generate journal entry'

insert into [StrSource] 
([Ar],[En])
select  '    ','Generating deposit entries process does not succeed'

insert into [StrSource] 
([Ar],[En])
select  '     ','You can not undo this operation'

insert into [StrSource] 
([Ar],[En])
select  '        ','You can not undo this operation
Are you sure?'

insert into [StrSource] 
([Ar],[En])
select  '             ','Journal entry will not be created for units without owner or area'

insert into [StrSource] 
([Ar],[En])
select  '    ','Card account will not be created'

insert into [StrSource] 
([Ar],[En])
select  '      ','Card account will not be created
do you want to continue?'

insert into [StrSource] 
([Ar],[En])
select  ' ','Same customer'

insert into [StrSource] 
([Ar],[En])
select  ' ','With amount'

insert into [StrSource] 
([Ar],[En])
select  ' ','with installments'

insert into [StrSource] 
([Ar],[En])
select  '  ','Table line color'

insert into [StrSource] 
([Ar],[En])
select  ' ','Font color'

insert into [StrSource] 
([Ar],[En])
select  ' ','Car color'

insert into [StrSource] 
([Ar],[En])
select  ' ','Not on him'

insert into [StrSource] 
([Ar],[En])
select  '   ','does not has owner account'

insert into [StrSource] 
([Ar],[En])
select  '2','Square meter'

insert into [StrSource] 
([Ar],[En])
select  '','Water'

insert into [StrSource] 
([Ar],[En])
select  '','Italic'

insert into [StrSource] 
([Ar],[En])
select  ' ','New material'

insert into [StrSource] 
([Ar],[En])
select  '','Owner'

insert into [StrSource] 
([Ar],[En])
select  '','Sold'

insert into [StrSource] 
([Ar],[En])
select  ' ','Cheque Amount'

insert into [StrSource] 
([Ar],[En])
select  '','Ammount'

insert into [StrSource] 
([Ar],[En])
select  '  ','Rent amount due'

insert into [StrSource] 
([Ar],[En])
select  '   ','Contract amount was collected'

insert into [StrSource] 
([Ar],[En])
select  '','Sales'

insert into [StrSource] 
([Ar],[En])
select  ' ','Asset sale'

insert into [StrSource] 
([Ar],[En])
select  '2','Sales2'

insert into [StrSource] 
([Ar],[En])
select  '3','Sales3'

insert into [StrSource] 
([Ar],[En])
select  '','Delayed'

insert into [StrSource] 
([Ar],[En])
select  '','Continue'

insert into [StrSource] 
([Ar],[En])
select  '','Variable'

insert into [StrSource] 
([Ar],[En])
select  '','Multi'

insert into [StrSource] 
([Ar],[En])
select  '','Various'

insert into [StrSource] 
([Ar],[En])
select  '','Medium'

insert into [StrSource] 
([Ar],[En])
select  '  ','Default printing folder'

insert into [StrSource] 
([Ar],[En])
select  ' ','New Folder'

insert into [StrSource] 
([Ar],[En])
select  '  ','Receipt print folder'

insert into [StrSource] 
([Ar],[En])
select  '  ','Log print folder'

insert into [StrSource] 
([Ar],[En])
select  '   ','Clearance print folder'

insert into [StrSource] 
([Ar],[En])
select  '  ','Previous depreciation accumulated'

insert into [StrSource] 
([Ar],[En])
select  ' ','Depreciation accumulated'

insert into [StrSource] 
([Ar],[En])
select  '   ','New depreciation accumulated'

insert into [StrSource] 
([Ar],[En])
select  ' ','Gross profit'

insert into [StrSource] 
([Ar],[En])
select  '','Total'

insert into [StrSource] 
([Ar],[En])
select  '   ','Total debit period'

insert into [StrSource] 
([Ar],[En])
select  ' ','Total additions'

insert into [StrSource] 
([Ar],[En])
select  '  ','Total revenue'

insert into [StrSource] 
([Ar],[En])
select  ' ','Deposit total'

insert into [StrSource] 
([Ar],[En])
select  '   ','Total current deposit of contracts'

insert into [StrSource] 
([Ar],[En])
select  '   ','Total previous deposit of contracts'

insert into [StrSource] 
([Ar],[En])
select  '  ','Total general deposit'

insert into [StrSource] 
([Ar],[En])
select  ' ','Total discount'

insert into [StrSource] 
([Ar],[En])
select  '  ','Collected payments total'

insert into [StrSource] 
([Ar],[En])
select  '   ','Due paymants total'

insert into [StrSource] 
([Ar],[En])
select  '   ','Total due payments'

insert into [StrSource] 
([Ar],[En])
select  '  ','Current entry total'

insert into [StrSource] 
([Ar],[En])
select  '  ','Collected cheque total'

insert into [StrSource] 
([Ar],[En])
select  '  ','Total paid cheques'

insert into [StrSource] 
([Ar],[En])
select  '  ','Due cheque total'

insert into [StrSource] 
([Ar],[En])
select  ' ','Total fines'

insert into [StrSource] 
([Ar],[En])
select  '  ','Total credit period'

insert into [StrSource] 
([Ar],[En])
select  '   ','Sum of values ??due to owner'

insert into [StrSource] 
([Ar],[En])
select  '    ','Sum of values ??due to tenant'

insert into [StrSource] 
([Ar],[En])
select  '     ','Total value is not match with contract value'

insert into [StrSource] 
([Ar],[En])
select  '        ','Total value in multiple accounts is not match with contract value'

insert into [StrSource] 
([Ar],[En])
select  '          ','Total value in multiple jobcost is not match with cheque value'

insert into [StrSource] 
([Ar],[En])
select  ' ','Sum of value'

insert into [StrSource] 
([Ar],[En])
select  ' ','Sum of Cost'

insert into [StrSource] 
([Ar],[En])
select  ' ','Sum of Amount'

insert into [StrSource] 
([Ar],[En])
select  ' ','Total expenses'

insert into [StrSource] 
([Ar],[En])
select  ' ','Total percentages'

insert into [StrSource] 
([Ar],[En])
select  '     ','Total current percentage  '

insert into [StrSource] 
([Ar],[En])
select  '  ','Total capital'

insert into [StrSource] 
([Ar],[En])
select  '  ','Previous total credit'

insert into [StrSource] 
([Ar],[En])
select  '  ','Previous total debit'

insert into [StrSource] 
([Ar],[En])
select  '   ','Total net due for tenants'

insert into [StrSource] 
([Ar],[En])
select  '      ','The sum of cheque values smaller then remaining amount'

insert into [StrSource] 
([Ar],[En])
select  '      ','The sum of cheque values larger then remaining amount'

insert into [StrSource] 
([Ar],[En])
select  '  ','Total value of contracts'

insert into [StrSource] 
([Ar],[En])
select  '     ','Total value of contracts after discount'

insert into [StrSource] 
([Ar],[En])
select  '     ','Total value of contracts before discount'

insert into [StrSource] 
([Ar],[En])
select  '  ','Total credit'

insert into [StrSource] 
([Ar],[En])
select  '  ','Total debit'

insert into [StrSource] 
([Ar],[En])
select  '  ','Calculate quantities Group'

insert into [StrSource] 
([Ar],[En])
select  ' ','Materials group'

insert into [StrSource] 
([Ar],[En])
select  ' ','Material group'

insert into [StrSource] 
([Ar],[En])
select  '','Reserved'

insert into [StrSource] 
([Ar],[En])
select  '','Specified'

insert into [StrSource] 
([Ar],[En])
select  '','character'

insert into [StrSource] 
([Ar],[En])
select  '','Muharram'

insert into [StrSource] 
([Ar],[En])
select  '','Collected '

insert into [StrSource] 
([Ar],[En])
select  ' ','Partly collected'

insert into [StrSource] 
([Ar],[En])
select  ' ','Partly collected'

insert into [StrSource] 
([Ar],[En])
select  '  / ','Partial collected / Value'

insert into [StrSource] 
([Ar],[En])
select  '  /','Collected drom / Day'

insert into [StrSource] 
([Ar],[En])
select  '','Showroom'

insert into [StrSource] 
([Ar],[En])
select  ' ','Compilation shop'

insert into [StrSource] 
([Ar],[En])
select  '','Showrooms'

insert into [StrSource] 
([Ar],[En])
select  '','Customized'

insert into [StrSource] 
([Ar],[En])
select  ' ','Building chart'

insert into [StrSource] 
([Ar],[En])
select  '  ','Rent duration in word'

insert into [StrSource] 
([Ar],[En])
select  ' ','Cheque period'

insert into [StrSource] 
([Ar],[En])
select  ' ','Contract duration'

insert into [StrSource] 
([Ar],[En])
select  '  ','Contract duration in text'

insert into [StrSource] 
([Ar],[En])
select  '','Paid'

insert into [StrSource] 
([Ar],[En])
select  '','Books closed'

insert into [StrSource] 
([Ar],[En])
select  '','Rounded'

insert into [StrSource] 
([Ar],[En])
select  '','Admin'

insert into [StrSource] 
([Ar],[En])
select  '','Debit.'

insert into [StrSource] 
([Ar],[En])
select  '','Debited'

insert into [StrSource] 
([Ar],[En])
select  '  ','Depreciation asset card'

insert into [StrSource] 
([Ar],[En])
select  '','Checked'

insert into [StrSource] 
([Ar],[En])
select  '   ','Checked for notes operations'

insert into [StrSource] 
([Ar],[En])
select  '    ','Cost centers'

insert into [StrSource] 
([Ar],[En])
select  '   ','Cost center for cheque'

insert into [StrSource] 
([Ar],[En])
select  ' ','Shopping malls'

insert into [StrSource] 
([Ar],[En])
select  '  ','Multiple cost center'

insert into [StrSource] 
([Ar],[En])
select  ' ','Linked to building'

insert into [StrSource] 
([Ar],[En])
select  '','Refund'

insert into [StrSource] 
([Ar],[En])
select  ' ','Purchase return'

insert into [StrSource] 
([Ar],[En])
select  ' ','Sales return'

insert into [StrSource] 
([Ar],[En])
select  ' ','Already returned'

insert into [StrSource] 
([Ar],[En])
select  '  /','Returned since/day'

insert into [StrSource] 
([Ar],[En])
select  '','Returned'

insert into [StrSource] 
([Ar],[En])
select  '  /','Returned from / day'

insert into [StrSource] 
([Ar],[En])
select  '','Posted'

insert into [StrSource] 
([Ar],[En])
select  ' ','Posted to bank'

insert into [StrSource] 
([Ar],[En])
select  ' ','Cost center'

insert into [StrSource] 
([Ar],[En])
select  '  : ','Cost Center :'

insert into [StrSource] 
([Ar],[En])
select  '   ','Main building cost center'

insert into [StrSource] 
([Ar],[En])
select  '  ','Main cost center'

insert into [StrSource] 
([Ar],[En])
select  '  ','Credit cost center'

insert into [StrSource] 
([Ar],[En])
select  '  ','Debit cost center'

insert into [StrSource] 
([Ar],[En])
select  '     ','Cost center is used in entries'

insert into [StrSource] 
([Ar],[En])
select  '  ','Duplicate cost center'

insert into [StrSource] 
([Ar],[En])
select  ' ','Defult cost center'

insert into [StrSource] 
([Ar],[En])
select  ' ','Cost center'

insert into [StrSource] 
([Ar],[En])
select  '    ','Main cost center for flats'

insert into [StrSource] 
([Ar],[En])
select  ' ','Synchronize files '

insert into [StrSource] 
([Ar],[En])
select  '  ...','Sync Files ...'

insert into [StrSource] 
([Ar],[En])
select  ' ','Land area'

insert into [StrSource] 
([Ar],[En])
select  '  ','Built land area'

insert into [StrSource] 
([Ar],[En])
select  '  ','Building area'

insert into [StrSource] 
([Ar],[En])
select  ' ','Gardens area'

insert into [StrSource] 
([Ar],[En])
select  ' ','Property area'

insert into [StrSource] 
([Ar],[En])
select  ' ','Plot area'

insert into [StrSource] 
([Ar],[En])
select  ' ','Play yard area'

insert into [StrSource] 
([Ar],[En])
select  '  ','Car parking area'

insert into [StrSource] 
([Ar],[En])
select  ' 1','Path 1'

insert into [StrSource] 
([Ar],[En])
select  ' 2','Path 2'

insert into [StrSource] 
([Ar],[En])
select  '  ','Backup location path'

insert into [StrSource] 
([Ar],[En])
select  '','Help'

insert into [StrSource] 
([Ar],[En])
select  '','Tenant'

insert into [StrSource] 
([Ar],[En])
select  '','Accrued'

insert into [StrSource] 
([Ar],[En])
select  '','Refund'

insert into [StrSource] 
([Ar],[En])
select  '','Stored'

insert into [StrSource] 
([Ar],[En])
select  ' ','Finishing quality'

insert into [StrSource] 
([Ar],[En])
select  ' ','Security level'

insert into [StrSource] 
([Ar],[En])
select  ' ','permittivity level'

insert into [StrSource] 
([Ar],[En])
select  '','Mosque'

insert into [StrSource] 
([Ar],[En])
select  '  ','Drawn on Bank'

insert into [StrSource] 
([Ar],[En])
select  '','Buyer'

insert into [StrSource] 
([Ar],[En])
select  '','Busy'

insert into [StrSource] 
([Ar],[En])
select  ' ','Report sources'

insert into [StrSource] 
([Ar],[En])
select  ' ','Lawsuit expenses'

insert into [StrSource] 
([Ar],[En])
select  ' ','Maintenance expenses'

insert into [StrSource] 
([Ar],[En])
select  ' ','Commission expense'

insert into [StrSource] 
([Ar],[En])
select  ' ','Already added'

insert into [StrSource] 
([Ar],[En])
select  '','Compressed'

insert into [StrSource] 
([Ar],[En])
select  '  ','It went on Return'

insert into [StrSource] 
([Ar],[En])
select  ' ','Building Combarision'

insert into [StrSource] 
([Ar],[En])
select  ' ','New reconciliation'

insert into [StrSource] 
([Ar],[En])
select  ' ','Account reconciliation'

insert into [StrSource] 
([Ar],[En])
select  '','Restaurants'

insert into [StrSource] 
([Ar],[En])
select  '','Endorsed'

insert into [StrSource] 
([Ar],[En])
select  '       ','and be noted that it will still be saved on the hard drive'

insert into [StrSource] 
([Ar],[En])
select  '  ','With spare parts'

insert into [StrSource] 
([Ar],[En])
select  ' ','Closing file wizard'

insert into [StrSource] 
([Ar],[En])
select  ' ','Return processing'

insert into [StrSource] 
([Ar],[En])
select  ' ','Building factors'

insert into [StrSource] 
([Ar],[En])
select  '  ','Print preview'

insert into [StrSource] 
([Ar],[En])
select  '','Modified'

insert into [StrSource] 
([Ar],[En])
select  ' ','Depreciation average'

insert into [StrSource] 
([Ar],[En])
select  '','Suspend'

insert into [StrSource] 
([Ar],[En])
select  '','Information'

insert into [StrSource] 
([Ar],[En])
select  ' ','Distribution information'

insert into [StrSource] 
([Ar],[En])
select  ' ','Contract information'

insert into [StrSource] 
([Ar],[En])
select  ' ','User information'

insert into [StrSource] 
([Ar],[En])
select  ' ','Area information'

insert into [StrSource] 
([Ar],[En])
select  ' ','Account information'

insert into [StrSource] 
([Ar],[En])
select  ' ','General information'

insert into [StrSource] 
([Ar],[En])
select  ' ','Material information'

insert into [StrSource] 
([Ar],[En])
select  '','Closed'

insert into [StrSource] 
([Ar],[En])
select  ' ','Shortcut key'

insert into [StrSource] 
([Ar],[En])
select  '','Opened'

insert into [StrSource] 
([Ar],[En])
select  '','Receivable'

insert into [StrSource] 
([Ar],[En])
select  ' ','Contract location'

insert into [StrSource] 
([Ar],[En])
select  '  ','Contract location latin'

insert into [StrSource] 
([Ar],[En])
select  ' ','Destination'

insert into [StrSource] 
([Ar],[En])
select  '','Duplicate'

insert into [StrSource] 
([Ar],[En])
select  '','Notes'

insert into [StrSource] 
([Ar],[En])
select  ' ','Contract note'

insert into [StrSource] 
([Ar],[En])
select  '','Notes..'

insert into [StrSource] 
([Ar],[En])
select  ' ','Depreciation summary'

insert into [StrSource] 
([Ar],[En])
select  '','File'

insert into [StrSource] 
([Ar],[En])
select  ' ','Data file'

insert into [StrSource] 
([Ar],[En])
select  ' ','Log file'

insert into [StrSource] 
([Ar],[En])
select  '   ','Print file does not exist'

insert into [StrSource] 
([Ar],[En])
select  ' ','New File'

insert into [StrSource] 
([Ar],[En])
select  '','Owned'

insert into [StrSource] 
([Ar],[En])
select  ' ','Flat ownership'

insert into [StrSource] 
([Ar],[En])
select  '','From'

insert into [StrSource] 
([Ar],[En])
select  '  ','From last reconciliation'

insert into [StrSource] 
([Ar],[En])
select  '           ','From now on, all files and attached documents will be saved on the database'

insert into [StrSource] 
([Ar],[En])
select  '          ','From now on, all files and attached documents will not be saved on the database'

insert into [StrSource] 
([Ar],[En])
select  ' ','From computer'

insert into [StrSource] 
([Ar],[En])
select  ' ','From store'

insert into [StrSource] 
([Ar],[En])
select  ' ','From location'

insert into [StrSource] 
([Ar],[En])
select  ' ','From pattern'

insert into [StrSource] 
([Ar],[En])
select  ' ','From Date'

insert into [StrSource] 
([Ar],[En])
select  '  : ','From Date:'

insert into [StrSource] 
([Ar],[En])
select  ' ','From No'

insert into [StrSource] 
([Ar],[En])
select  '  ','From cost center'

insert into [StrSource] 
([Ar],[En])
select  '','Stock transfer'

insert into [StrSource] 
([Ar],[En])
select  '','Terminated.'

insert into [StrSource] 
([Ar],[En])
select  ' ','Expired'

insert into [StrSource] 
([Ar],[En])
select  '    ','Expired contract and terminated'

insert into [StrSource] 
([Ar],[En])
select  '     ','Expired contract and didn''t terminated'

insert into [StrSource] 
([Ar],[En])
select  '','Low'

insert into [StrSource] 
([Ar],[En])
select  ' ','Sales agent'

insert into [StrSource] 
([Ar],[En])
select  '/ ','Since / Day'

insert into [StrSource] 
([Ar],[En])
select  '   / ','Mahtlk the day / month'

insert into [StrSource] 
([Ar],[En])
select  '','Items'

insert into [StrSource] 
([Ar],[En])
select  '','Specifications'

insert into [StrSource] 
([Ar],[En])
select  ' ','Materials specification'

insert into [StrSource] 
([Ar],[En])
select  '','OK'

insert into [StrSource] 
([Ar],[En])
select  ' ','Asset locations'

insert into [StrSource] 
([Ar],[En])
select  ' ','Car parking'

insert into [StrSource] 
([Ar],[En])
select  '   ','Underground car parking'

insert into [StrSource] 
([Ar],[En])
select  '','Vendor'

insert into [StrSource] 
([Ar],[En])
select  ' ','Other location'

insert into [StrSource] 
([Ar],[En])
select  '','Park'

insert into [StrSource] 
([Ar],[En])
select  ' ','Assemblage parking'

insert into [StrSource] 
([Ar],[En])
select  ' ','Car Parking'

insert into [StrSource] 
([Ar],[En])
select  ' ','Property Features'

insert into [StrSource] 
([Ar],[En])
select  '  ','Property positives & negatives features'

insert into [StrSource] 
([Ar],[En])
select  ' ','Trial Balance'

insert into [StrSource] 
([Ar],[En])
select  '  ','Annual Trail Balance'

insert into [StrSource] 
([Ar],[En])
select  '   ','Cost center trail balance'

insert into [StrSource] 
([Ar],[En])
select  '   ','Cost Center Trail Balance'

insert into [StrSource] 
([Ar],[En])
select  '','Grerian'

insert into [StrSource] 
([Ar],[En])
select  '  ','Accounts balance window'

insert into [StrSource] 
([Ar],[En])
select  ' ','Log file window'

insert into [StrSource] 
([Ar],[En])
select  '  - ','Log File - '

insert into [StrSource] 
([Ar],[En])
select  '   ','Log file with editing'

insert into [StrSource] 
([Ar],[En])
select  ' ','Alerts window'

insert into [StrSource] 
([Ar],[En])
select  ' ','Pictures window'

insert into [StrSource] 
([Ar],[En])
select  ' ','Information Window'

insert into [StrSource] 
([Ar],[En])
select  '  ','About Property'

insert into [StrSource] 
([Ar],[En])
select  ' ','Evaluation Results'

insert into [StrSource] 
([Ar],[En])
select  '   SMS','SMS sent result'

insert into [StrSource] 
([Ar],[En])
select  ' ','Send result'

insert into [StrSource] 
([Ar],[En])
select  '  ','Result unknown'

insert into [StrSource] 
([Ar],[En])
select  '','Succeed'

insert into [StrSource] 
([Ar],[En])
select  ' ','Extra rate'

insert into [StrSource] 
([Ar],[En])
select  '   ','Depreciation annual percentage'

insert into [StrSource] 
([Ar],[En])
select  ' ','Discount rate'

insert into [StrSource] 
([Ar],[En])
select  '      ','Discount rate larger than the allowable percentage'

insert into [StrSource] 
([Ar],[En])
select  '  ','Maximum discount rate'

insert into [StrSource] 
([Ar],[En])
select  '    ','Increased percentage of current contract'

insert into [StrSource] 
([Ar],[En])
select  ' ','Commission rate'

insert into [StrSource] 
([Ar],[En])
select  '','Copy'

insert into [StrSource] 
([Ar],[En])
select  ' ','Backup'

insert into [StrSource] 
([Ar],[En])
select  ' ','Copy table'

insert into [StrSource] 
([Ar],[En])
select  ' ','Copy all'

insert into [StrSource] 
([Ar],[En])
select  '        ','Copy the file to the default path when linking it with the document'

insert into [StrSource] 
([Ar],[En])
select  '      ','Database version is latest than the program version'

insert into [StrSource] 
([Ar],[En])
select  '  ','Licensed to '

insert into [StrSource] 
([Ar],[En])
select  '','Publish'

insert into [StrSource] 
([Ar],[En])
select  ' ','Publish permissions'

insert into [StrSource] 
([Ar],[En])
select  '  ','Publish user permissions'

insert into [StrSource] 
([Ar],[En])
select  '  ','Bulletin currency prices'

insert into [StrSource] 
([Ar],[En])
select  ' ','Message text'

insert into [StrSource] 
([Ar],[En])
select  '                  [A]   ','Text                [A] Customer name'

insert into [StrSource] 
([Ar],[En])
select  '  [M]','The Message [M]'

insert into [StrSource] 
([Ar],[En])
select  '  ','SMS Arabic text'

insert into [StrSource] 
([Ar],[En])
select  '  ','SMS Latin text'

insert into [StrSource] 
([Ar],[En])
select  ' ','Region-wide'

insert into [StrSource] 
([Ar],[En])
select  ' ','Building system'

insert into [StrSource] 
([Ar],[En])
select  ' ','Safety system'

insert into [StrSource] 
([Ar],[En])
select  '','Yes'

insert into [StrSource] 
([Ar],[En])
select  '','Cash'

insert into [StrSource] 
([Ar],[En])
select  '','Transfar'

insert into [StrSource] 
([Ar],[En])
select  ' ','Move cards'

insert into [StrSource] 
([Ar],[En])
select  '   ','Transfer cards between types'

insert into [StrSource] 
([Ar],[En])
select  '   ','Transfer cards between accounts'

insert into [StrSource] 
([Ar],[En])
select  '   ','Transfer activity between materials'

insert into [StrSource] 
([Ar],[En])
select  '    ','Transfer activities between job costs'

insert into [StrSource] 
([Ar],[En])
select  '  ','Move entries cards'

insert into [StrSource] 
([Ar],[En])
select  '  ','Transfer activity of accounts'

insert into [StrSource] 
([Ar],[En])
select  '   ','Transfar all account activity'

insert into [StrSource] 
([Ar],[En])
select  '    ','Transfar all job cost activity'

insert into [StrSource] 
([Ar],[En])
select  '    ','Move the following when renewing contract'

insert into [StrSource] 
([Ar],[En])
select  '      ','Default note type in generating contract installments'

insert into [StrSource] 
([Ar],[En])
select  ' ','Map type'

insert into [StrSource] 
([Ar],[En])
select  '  ','Cash entry type'

insert into [StrSource] 
([Ar],[En])
select  ' ','Cheque Pattern'

insert into [StrSource] 
([Ar],[En])
select  '     ','Default note type in generating cheques'

insert into [StrSource] 
([Ar],[En])
select  ' ','Contract Patterns'

insert into [StrSource] 
([Ar],[En])
select  ' ','Bill Pattern'

insert into [StrSource] 
([Ar],[En])
select  '  ','Default bill type'

insert into [StrSource] 
([Ar],[En])
select  '  ','Receive voucher type'

insert into [StrSource] 
([Ar],[En])
select  '  ','Sales invoice pattern'

insert into [StrSource] 
([Ar],[En])
select  '        ','We strongly recommended to backup your data before you start this process'

insert into [StrSource] 
([Ar],[En])
select  '             ','We strongly recommended to backup your data before you start this process
Do you want to make backup now?'

insert into [StrSource] 
([Ar],[En])
select  ' ','Ending Period'

insert into [StrSource] 
([Ar],[En])
select  '','type'

insert into [StrSource] 
([Ar],[En])
select  ' ','Land type'

insert into [StrSource] 
([Ar],[En])
select  ' ','Depreciation Type'

insert into [StrSource] 
([Ar],[En])
select  '   / ','Rent type Annually / Monthly'

insert into [StrSource] 
([Ar],[En])
select  ' ','Card type'

insert into [StrSource] 
([Ar],[En])
select  '  /','Card type Customer/Supplier'

insert into [StrSource] 
([Ar],[En])
select  ' ','License type'

insert into [StrSource] 
([Ar],[En])
select  ' ','Account type'

insert into [StrSource] 
([Ar],[En])
select  ' ','Font type'

insert into [StrSource] 
([Ar],[En])
select  ' ','Payment method'

insert into [StrSource] 
([Ar],[En])
select  '  ','Bill payment type'

insert into [StrSource] 
([Ar],[En])
select  '    ','Link type with other groups'

insert into [StrSource] 
([Ar],[En])
select  '   / ','Visit type Monthly / Yearly'

insert into [StrSource] 
([Ar],[En])
select  ' ','Price type'

insert into [StrSource] 
([Ar],[En])
select  ' ','Ownership type'

insert into [StrSource] 
([Ar],[En])
select  ' ','Car type'

insert into [StrSource] 
([Ar],[En])
select  ' ','Flat type'

insert into [StrSource] 
([Ar],[En])
select  ' ','Cheque type'

insert into [StrSource] 
([Ar],[En])
select  ' ','Offer type'

insert into [StrSource] 
([Ar],[En])
select  ' ','Unit type'

insert into [StrSource] 
([Ar],[En])
select  ' ','Contract type'

insert into [StrSource] 
([Ar],[En])
select  '   / ','Contract type yearly / monthly'

insert into [StrSource] 
([Ar],[En])
select  ' ','Property type'

insert into [StrSource] 
([Ar],[En])
select  '  ','Latin property type'

insert into [StrSource] 
([Ar],[En])
select  ' ','Bill type'

insert into [StrSource] 
([Ar],[En])
select  ' ','Material type'

insert into [StrSource] 
([Ar],[En])
select  ' ','Variable type'

insert into [StrSource] 
([Ar],[En])
select  '  ','Check type'

insert into [StrSource] 
([Ar],[En])
select  '   ','Specific type of files'

insert into [StrSource] 
([Ar],[En])
select  '   ','Safety system type'

insert into [StrSource] 
([Ar],[En])
select  '','Telephone'

insert into [StrSource] 
([Ar],[En])
select  ' ','Customer tel'

insert into [StrSource] 
([Ar],[En])
select  ' ','Business telephone'

insert into [StrSource] 
([Ar],[En])
select  '','Hijri'

insert into [StrSource] 
([Ar],[En])
select  '       ','This rate does not exist in exchange rate window'

insert into [StrSource] 
([Ar],[En])
select  '    ','This cheque is linked with contract'

insert into [StrSource] 
([Ar],[En])
select  '    
  ','This cheque is linked with contract
Do you want to modify?'

insert into [StrSource] 
([Ar],[En])
select  '    
  ','This cheque is linked with contract
Do you want to delete?'

insert into [StrSource] 
([Ar],[En])
select  '    ','This cheque linked with bill'

insert into [StrSource] 
([Ar],[En])
select  '   : ','This contract No'

insert into [StrSource] 
([Ar],[En])
select  '   : 2','This contract No: 2'

insert into [StrSource] 
([Ar],[En])
select  '        ','This journal entry has origin are you sure to delete?'

insert into [StrSource] 
([Ar],[En])
select  '    ','This entry is related with cheque'

insert into [StrSource] 
([Ar],[En])
select  '         ','This is multiple shop and one of its components is included in the contract'

insert into [StrSource] 
([Ar],[En])
select  '             ','This wizard help you to create accounts for customers that does not have account or deposit account'

insert into [StrSource] 
([Ar],[En])
select  '               ','This means that contracts will be modified according to the default accounts and will not be able to undo this process?'

insert into [StrSource] 
([Ar],[En])
select  '          ','This is multiple land and one of its components is included in the contract'

insert into [StrSource] 
([Ar],[En])
select  '        ','This Land is from a multiple in the contract'

insert into [StrSource] 
([Ar],[En])
select  '         ','These cards does not have account or deposit account'

insert into [StrSource] 
([Ar],[En])
select  '          ','This is multiple flat and one of its components is included in the contract'

insert into [StrSource] 
([Ar],[En])
select  '        ','This flat include in multiple flat inside contract'

insert into [StrSource] 
([Ar],[En])
select  '     ','This process may take a long time'

insert into [StrSource] 
([Ar],[En])
select  '        ','This shop include in multiple shop inside contract'

insert into [StrSource] 
([Ar],[En])
select  '         ','This window contains some information that can be duplicated'

insert into [StrSource] 
([Ar],[En])
select  '    ','Do you want to add selected flats'

insert into [StrSource] 
([Ar],[En])
select  '    ','Do you want to add selected shops'

insert into [StrSource] 
([Ar],[En])
select  '   ','Are you sure to add it now?'

insert into [StrSource] 
([Ar],[En])
select  '    ','Do you want to restart programs now?'

insert into [StrSource] 
([Ar],[En])
select  '     ','Do you want to renumber the selected cards?'

insert into [StrSource] 
([Ar],[En])
select  '       ','Do you want to regnerate notes that is already exist?'

insert into [StrSource] 
([Ar],[En])
select  '    ','Do you want to close the current window?'

insert into [StrSource] 
([Ar],[En])
select  '   ','Do you want to cancel reservation?'

insert into [StrSource] 
([Ar],[En])
select  '      ','Do you want to cancel checked of related cheques?'

insert into [StrSource] 
([Ar],[En])
select  '      ','Do you want to cancel checked of related cash payments?'

insert into [StrSource] 
([Ar],[En])
select  '     ','Do you want to Renumbering cheques'

insert into [StrSource] 
([Ar],[En])
select  '    ','Do you want to Renumbering contracts'

insert into [StrSource] 
([Ar],[En])
select  '  ','Do you want to renew?'

insert into [StrSource] 
([Ar],[En])
select  '  ','Do you want to modify?'

insert into [StrSource] 
([Ar],[En])
select  '  ','Do you want to delete?'

insert into [StrSource] 
([Ar],[En])
select  '    ','Do you want to close the program?'

insert into [StrSource] 
([Ar],[En])
select  '     ','Do you want to make backup'

insert into [StrSource] 
([Ar],[En])
select  '      ','Do you want to update now?'

insert into [StrSource] 
([Ar],[En])
select  '  ','Do you want to continue'

insert into [StrSource] 
([Ar],[En])
select  '  ?','Do you want to continue?'

insert into [StrSource] 
([Ar],[En])
select  '  ','Do you want to continue?'

insert into [StrSource] 
([Ar],[En])
select  '       ','Do you want to terminate the current contract using contract end date?'

insert into [StrSource] 
([Ar],[En])
select  '      ','Are you sure to change flats cost prices?'

insert into [StrSource] 
([Ar],[En])
select  '   ','Do you want to post the bill?'

insert into [StrSource] 
([Ar],[En])
select  '   ','Do you want to post the journal entry?'

insert into [StrSource] 
([Ar],[En])
select  '    ','Are you sure to post selected entries?'

insert into [StrSource] 
([Ar],[En])
select  '     ','Do you want to fill obverse account?'

insert into [StrSource] 
([Ar],[En])
select  '      ?','Do you want to set him in current site?'

insert into [StrSource] 
([Ar],[En])
select  '    ','Are you sure to change cost center?'

insert into [StrSource] 
([Ar],[En])
select  '       ','Do you want to show cost center in opening entry?'

insert into [StrSource] 
([Ar],[En])
select  '      ','Are you sure to delete current Hijri year settings?'

insert into [StrSource] 
([Ar],[En])
select  '    ','Do you want to delete selected flats'

insert into [StrSource] 
([Ar],[En])
select  '    ','Do you want to delete the selected photo?'

insert into [StrSource] 
([Ar],[En])
select  '     ','Do you want to delete the old value?'

insert into [StrSource] 
([Ar],[En])
select  '    ','Do you want to delete selected shops'

insert into [StrSource] 
([Ar],[En])
select  '     ','Do you want to delete selected reconciliation?'

insert into [StrSource] 
([Ar],[En])
select  '     ','Do you want to delete the selected file attached'

insert into [StrSource] 
([Ar],[En])
select  '        ','Do you want to delete the existing documents and images from the database'

insert into [StrSource] 
([Ar],[En])
select  '     ','Do you want to delete related account card?'

insert into [StrSource] 
([Ar],[En])
select  '      ','Do you want to delete related deposit account card?'

insert into [StrSource] 
([Ar],[En])
select  '      ','Do you want to delete related cost center card?'

insert into [StrSource] 
([Ar],[En])
select  '     ','Do you want to delete building account also?'

insert into [StrSource] 
([Ar],[En])
select  '      ','Do you want to delete building bank account also?'

insert into [StrSource] 
([Ar],[En])
select  '        ','Do you want to delete building cost center account also?'

insert into [StrSource] 
([Ar],[En])
select  '     ','Do you want to delete current settings of Hijri Year?'

insert into [StrSource] 
([Ar],[En])
select  '      ','Do you want to save the changes to increase contracts value'

insert into [StrSource] 
([Ar],[En])
select  '     ','Do you want to make backup now?'

insert into [StrSource] 
([Ar],[En])
select  '     ','Do you want to save?'

insert into [StrSource] 
([Ar],[En])
select  '     ','Do you want renumbering sub-accounts?'

insert into [StrSource] 
([Ar],[En])
select  '    ','Are you sure to delete?'

insert into [StrSource] 
([Ar],[En])
select  '      ','Do you want to add now?'

insert into [StrSource] 
([Ar],[En])
select  '      ','Do you want to shrink size of the database'

insert into [StrSource] 
([Ar],[En])
select  '    ','Do you want to reserve the flat?'

insert into [StrSource] 
([Ar],[En])
select  '    ','Do you want to reserve the shop?'

insert into [StrSource] 
([Ar],[En])
select  '    ','Do you want to reserve the parking?'

insert into [StrSource] 
([Ar],[En])
select  '       ','Are you sure to delete all selected notes?'

insert into [StrSource] 
([Ar],[En])
select  '     ','Do you want to check the related cheques?'

insert into [StrSource] 
([Ar],[En])
select  '     ','Do you want to review the related cash payments?'

insert into [StrSource] 
([Ar],[En])
select  '          ','Do you want to copy archived files, documents and images to the database'

insert into [StrSource] 
([Ar],[En])
select  '','Telephones'

insert into [StrSource] 
([Ar],[En])
select  '','and'

insert into [StrSource] 
([Ar],[En])
select  ' ','Production units'

insert into [StrSource] 
([Ar],[En])
select  ' ','Bill unit'

insert into [StrSource] 
([Ar],[En])
select  ' ','Line unit'

insert into [StrSource] 
([Ar],[En])
select  '        ','and will be saved in folders on the hard drive only'

insert into [StrSource] 
([Ar],[En])
select  ' ','Report description'

insert into [StrSource] 
([Ar],[En])
select  ' ','Problem description'

insert into [StrSource] 
([Ar],[En])
select  '','Descriptions'

insert into [StrSource] 
([Ar],[En])
select  ' ','Entry time'

insert into [StrSource] 
([Ar],[En])
select  ' ','Suspended'

insert into [StrSource] 
([Ar],[En])
select  '','Until'

insert into [StrSource] 
([Ar],[En])
select  '     ','and you will not be able to retrieve current data'

insert into [StrSource] 
([Ar],[En])
select  '   :','These flats are:'

insert into [StrSource] 
([Ar],[En])
select  '   :','These shops are:'

insert into [StrSource] 
([Ar],[En])
select  '   :','Those parking are:'

insert into [StrSource] 
([Ar],[En])
select  '       ','This is a collective shop'

insert into [StrSource] 
([Ar],[En])
select  '       ','This parking consists of assembling more than one parking'

insert into [StrSource] 
([Ar],[En])
select  '   ','Connection must first set up'

insert into [StrSource] 
([Ar],[En])
select  '  ','Files must be updated'

insert into [StrSource] 
([Ar],[En])
select  '             ','Opening entries number which will be excluded must be specified for correct information in the report'

insert into [StrSource] 
([Ar],[En])
select  ' ','Automatically renewed'

insert into [StrSource] 
([Ar],[En])
select  '     ,     ','Chart must be refreshed, Do you want to do it?'

insert into [StrSource] 
([Ar],[En])
select  '','Contain'

insert into [StrSource] 
([Ar],[En])
select  '  ','Please enter the amount'

insert into [StrSource] 
([Ar],[En])
select  '           ','Please note that the flats did not specify with area, the cost will not change'

insert into [StrSource] 
([Ar],[En])
select  ' !','Please attention !!'

insert into [StrSource] 
([Ar],[En])
select  ' !             ','Attention please!
The results of the report is ing to be not properly arranged and the balance will be different depending on the options selected in the sorting'

insert into [StrSource] 
([Ar],[En])
select  '     Please make sure you install protection key','Please make sure you install protection key'

insert into [StrSource] 
([Ar],[En])
select  '','Equal'

insert into [StrSource] 
([Ar],[En])
select  '   ','Equal the contract end date'

insert into [StrSource] 
([Ar],[En])
select  '  ','Payment within'

insert into [StrSource] 
([Ar],[En])
select  '       ','We prefer to take a backup before performing this operation'

insert into [StrSource] 
([Ar],[En])
select  '  ','You can change currency'

insert into [StrSource] 
([Ar],[En])
select  '   ','You can change invoice pattern'

insert into [StrSource] 
([Ar],[En])
select  '  ','This user has all permissions'

insert into [StrSource] 
([Ar],[En])
select  ' ','There is lawsuit'

insert into [StrSource] 
([Ar],[En])
select  ' ','Payment available'

insert into [StrSource] 
([Ar],[En])
select  '  ','There is interios stairs'

insert into [StrSource] 
([Ar],[En])
select  '        ','There is existing contract for same customer and property'

insert into [StrSource] 
([Ar],[En])
select  '     ','There is valid contract for same property'

insert into [StrSource] 
([Ar],[En])
select  '    ','There is parking contract for same customer'

insert into [StrSource] 
([Ar],[En])
select  '     ','There is related parking contracts with this contract'

insert into [StrSource] 
([Ar],[En])
select  '      ','There is another cost center with the same code'

insert into [StrSource] 
([Ar],[En])
select  '    ','There is another User with the same name'

insert into [StrSource] 
([Ar],[En])
select  '    :','There is a problem in voucher No:'

insert into [StrSource] 
([Ar],[En])
select  '  ','Security system available'

insert into [StrSource] 
([Ar],[En])
select  ' ','Generate voucher'

insert into [StrSource] 
([Ar],[En])
select  '   ','Auto Generate voucher'

insert into [StrSource] 
([Ar],[En])
select  '','Day'

insert into [StrSource] 
([Ar],[En])
select  '','Daily'

insert into [StrSource] 
([Ar],[En])
select  ' ','Daily entries report'



GO

SET ANSI_NULLS, QUOTED_IDENTIFIER ON
GO

Create Procedure [PrcCreateContractParkingEntry]
(
	@ContractGuid uniqueidentifier = '{458DE1F0-B983-4E6B-A963-8B11F66ACF8D}',
	@MaxDate int = 42644,
	@Showresult bit = 1
)
 
AS
	Set NoCount on 
	Declare 
			@EnNum int,
			@EnGuid [uniqueidentifier]

	--  
	Select 
		@EnNum = isnull([Number],0)
		,@EnGuid = isnull([Guid],0x0)
	From
		[HEntry]
	where
		[Guid] = @ContractGuid

	if isnull(@EnNum,0) = 0
	begin	
		Select @EnNum = IsNull(Max([Number]),0) + 1 from [HEntry]
	END
	
	if isnull(@EnGuid,0x0) = 0x0
	Set @EnGuid = @ContractGuid

	if Exists(Select Number From HEntry where Number = @EnNum and [Guid] <> @EnGuid)
	Select @EnNum = IsNull(Max([Number]),0) + 1 from [HEntry]

	--   
	Delete
		[HEntry]
	where
		[Guid] = @EnGuid

		
	DECLARE 
		@ParkingNo Varchar(256),
		@FlatOwner int,
		@EntryDate Datetime,
		@AutoCreateEntry bit,
		@CreateEntry bit,
		@MoveCost bit,
		@MoveCostCredit bit,
		@MoveCostWithIncom bit,
		@MoveCostWithInconEndContract bit,
		@MoveCostWithFineEndContract bit,
		@MoveCostWithInsurance bit,
		@MoveCostWithContractPrice bit,
		@MoveCostWithCertificat bit,
		@MoveCostWithFee bit,
		@MoveCostWithclientComm bit,
		@MoveCostWithOwnerComm bit,
		@MoveCostWithDiscount bit,
		@MoveCostWithDiscountCredit bit,
		@MoveCostWithIncomCredit bit,
		@MoveCostWithInconEndContractCredit bit,
		@MoveCostWithFineEndContractCredit bit,
		@MoveCostWithInsuranceCredit bit,
		@MoveCostWithContractPriceCredit bit,
		@MoveCostWithCertificatCredit bit,
		@MoveCostWithFeeCredit bit,
		@MoveCostWithclientCommCredit bit,
		@MoveCostWithOwnerCommCredit bit,
		@SecLvl int,
		@CurrencyGuid uniqueidentifier,
		@CurrencyVal Float,
		@TypeName varchar(256),
		@ContractNumber int,
		@Note2 varchar(256),
		@ContractKind int,
		@AutoPostedEntry bit,
		@Mark bit,
		@RealtyGuid uniqueidentifier,
		@BuildingGuid uniqueidentifier,
		@EntryNote Varchar(255),
		@DetailNum Int,
		@Rent Float,
		@CostGuid  uniqueidentifier,
		@CustAccountGuid uniqueidentifier,
		@RevenueAccountGuid uniqueidentifier,
		@CommissionFromCustValue Float,
		@AcCommissionFromCustGuid uniqueidentifier,
		@AcCommissionFromCustNote varchar(256),
		@AcCustOwnerGuid uniqueidentifier,
		@CommissionFromOwnerValue Float,
		@AcCommissionFromOwnerGuid uniqueidentifier,
		@AcCommissionFromOwnerNote varchar(256),
		@UnearnedrRevenue bit,
		@Fromdate datetime,
		@Todate datetime,
		@AcIncomNextYearGuid uniqueidentifier,
		@InsuranceValue Float,
		@InsuranceAccountGuid uniqueidentifier,
		@CertificatValue Float,
		@AccountCertificatValueGuid uniqueidentifier,
		@OtherFeeAccountGuid uniqueidentifier,
		@OtherFee Float,

		@ContractPrice Float,
		@AccountContractPriceGuid uniqueidentifier,
		@DiscountValue fLoat,
		@DiscountAccountGuid uniqueidentifier,
		@BranchGuid uniqueidentifier,
		
		@CommissionFromSalesManrPercent fLoat,
		@CommissionFromSalesManValue fLoat,
		@AcSalesManCommissionGuid uniqueidentifier,
		@AcCommissionExpenseGuid uniqueidentifier,
		@SalesManCommNote varchar(255)
	
	SELECT	TOP 1
		@ParkingNo = Case when [t].[ContractKind] = 4 then ' '
			 when [t].[ContractKind] = 5 then ' '
		end
		+' /'+ [S].[No] +'/' 
		+' '+[B].[Name],
		
		@FlatOwner = S.FlatOwner,
		@EntryDate = Case when T.EntryDate = 0 then C.FromDate else C.EditDate end,
		@AutoCreateEntry = T.AutoCreateEntry,
		@AutoPostedEntry = T.AutoPostedEntry,
		@CreateEntry = T.CreateEntry,
		@MoveCost = T.MoveCost,
		@MoveCostCredit = T.MoveCostCredit,

		@MoveCostWithIncom = T.MoveCostWithIncom,
		@MoveCostWithInconEndContract = T.MoveCostWithInconEndContract,
		@MoveCostWithFineEndContract = T.MoveCostWithFineEndContract,
		@MoveCostWithInsurance = T.MoveCostWithInsurance,
		@MoveCostWithContractPrice = T.MoveCostWithContractPrice,
		@MoveCostWithCertificat = T.MoveCostWithCertificat,
		@MoveCostWithFee = T.MoveCostWithFee,
		@MoveCostWithclientComm = T.MoveCostWithclientComm,
		@MoveCostWithOwnerComm = T.MoveCostWithOwnerComm,

		@MoveCostWithDiscount = T.MoveCostWithDiscount,
		@MoveCostWithDiscountCredit = T.MoveCostWithDiscountCredit,

		@MoveCostWithIncomCredit = T.MoveCostWithIncomCredit,
		@MoveCostWithInconEndContractCredit = T.MoveCostWithInconEndContractCredit,
		@MoveCostWithFineEndContractCredit = T.MoveCostWithFineEndContractCredit,
		@MoveCostWithInsuranceCredit = T.MoveCostWithInsuranceCredit,
		@MoveCostWithContractPriceCredit = T.MoveCostWithContractPriceCredit,
		@MoveCostWithCertificatCredit = T.MoveCostWithCertificatCredit,
		@MoveCostWithFeeCredit = T.MoveCostWithFeeCredit,
		@MoveCostWithclientCommCredit = T.MoveCostWithclientCommCredit,
		@MoveCostWithOwnerCommCredit = T.MoveCostWithOwnerCommCredit,
		@SecLvl = C.SecLvl,
		@CurrencyGuid = C.CurrencyGuid,
		@CurrencyVal = C.CurrencyVal,
		@TypeName = T.Name,
		@ContractNumber = C.Number ,
		@Note2 = C.Note2,
		@ContractKind = C.ContractKind,
		@AutoPostedEntry = T.AutoPostedEntry,
		@Mark = C.Mark,
		@RealtyGuid = C.ParkingGuid,
		@BuildingGuid = C.BuildingGuid,
		@Rent = C.Rent,
		@CostGuid = C.CostGuid,
		@CustAccountGuid = C.CustAccountGuid,
		@RevenueAccountGuid = C.RevenueAccountGuid,
		@CommissionFromCustValue = C.CommissionFromCustValue,
		@AcCommissionFromCustGuid = C.AcCommissionFromCustGuid,
		@AcCommissionFromCustNote = C.AcCommissionFromCustNote,
		@CommissionFromOwnerValue = C.CommissionFromOwnerValue,
		@AcCommissionFromOwnerGuid = C.AcCommissionFromOwnerGuid ,
		@AcCommissionFromOwnerNote = C.AcCommissionFromOwnerNote,
		@UnearnedrRevenue = Case when (T.UnearnedrRevenue = 1) and (C.Todate > @MaxDate) then 1 else 0 end,
		@Fromdate = C.FromDate,
		@Todate = C.ToDate,
		@AcIncomNextYearGuid = C.AcIncomNextYearGuid,
		@InsuranceValue = C.InsuranceValue,
		@InsuranceAccountGuid = Cu.InsuranceAccountGuid,
		@CertificatValue = C.CertificatValue,
		@AccountCertificatValueGuid = C.AccountCertificatValue,
		@OtherFee = 0, --C.OtherFee,
		@OtherFeeAccountGuid = 0x0, --C.OtherFeeAccountGUID,

		@ContractPrice = C.ContractPrice,
		@AccountContractPriceGuid = C.AccountContractPrice,
		@DiscountValue = C.DiscountValue,
		@DiscountAccountGuid = C.DiscountAccountGuid,
		@BranchGuid = C.BranchGuid,
		@EntryNote = [T].[ContractNote],

		@CommissionFromSalesManrPercent = C.[CommissionFromSalesManrPercent],
		@CommissionFromSalesManValue = C.CommissionFromSalesManValue,
		@AcSalesManCommissionGuid = C.AcSalesManCommissionGuid,
		@AcCommissionExpenseGuid = C.AcCommissionExpenseGuid,
		@SalesManCommNote = C.SalesManCommNote

	FROM
		[ParkingContract]  C
		inner join [vwContractType] T on T.Guid = C.TypeGuid
		inner join [Parking] [S] on [S].[Guid] = [C].[ParkingGuid]
		inner join [vwBuilding] [B] On [S].[BuildingGuid] = [B].[Guid]
		inner join [vwcustomer] [Cu] On [Cu].[Guid] = [C].[CustomerGuid]
	WHERE
		C.Guid = @ContractGuid
	--Set @EntryNote = @TypeName +' '+dbo.sc(' ')+' '+CAST( @ContractNumber as varchar(255)) +' '+dbo.sc(' ')+' '+@ParkingNo +' '+@Note2
	
	Select 
		@EntryNote  =				REPLACE(REPLACE(REPLACE(REPLACE(REPLACE(REPLACE(
									REPLACE(REPLACE(REPLACE(REPLACE(REPLACE(REPLACE(
									@EntryNote, '[N]', TypeNameAr),
									'[M]', TypeNameLtn),
									'[A]', CustArName),
									'[B]', CustltnName),
									'[C]', FlatNo),
									'[D]', BuildingArName),
									'[E]', BuildingLtnName),
									'[F]', dbo.fndate(EditDate)),
									'[G]', dbo.fndate(Fromdate)),
									'[H]', dbo.fndate(Todate)),
									'[K]', ContractNo),
									'[L]', Cast(Value as varchar(50)))
									
	from 
		[vwAllContract]
	where
		Guid = @ContractGuid
		

	Select
		@AcCustOwnerGuid = [Cu].[AcGuid]
	from
		Parking P
		inner join [Customer] [Cu] on [P].CustGuid = [Cu].[Guid]
	where
		[P].[Guid] = @RealtyGuid 

	if ISNULL(@AcCustOwnerGuid,0x0) = 0x0
	select
		@AcCustOwnerGuid = [Cu].[AcGuid]
	from
		vwParking P
		inner join [Customer] [Cu] on [P].[BuildingOwnerName] = [Cu].[Guid]
	where
		[P].[Guid] = @RealtyGuid 

	if (@FlatOwner = 0 or @FlatOwner = -1)
	begin
	if (@ContractKind = 5) --   
	begin
			Insert Into [HEntry]
			([Guid],[SecLvl],[Number],[Date], [CurrencyGuid], [CurrencyVal], [Note], [ParentKind], [BranchGuid], [IsPosted], Mark)
			Select
				@EnGuid,
				@SecLvl,
				@EnNum,
				@EntryDate,
				@CurrencyGuid,
				@CurrencyVal,
				@EntryNote as [Note],
				1000+@ContractKind as [ParentKind], 
				@BranchGuid as [BranchGuid], 
				@AutoPostedEntry as [IsPosted],
				@Mark
				
			Set @DetailNum = 0
			
			Insert into [DEntry]
		 	([ParentGuid],[Number],[AcGuid],[Debit],[Credit],[CurrencyGuid],[CurrencyVal],[CostGuid],[ObverseAcGuid],[Note])
			Select
				@EnGuid,
				@DetailNum,
				@CustAccountGuid,
				@Rent as Debit,
				0 as Credit,
				@CurrencyGuid,
				@CurrencyVal,
				Case when @MoveCost = 1 then @CostGuid end,
				Null as [ObverseAcGuid],
				@EntryNote

			-- 
			Declare @CostPrice Float
			
			Select	@CostPrice = CostPrice	From Parking where Guid = @RealtyGuid
			
			if @CostPrice > 0
			begin
				Declare @BuildingAcGuid uniqueidentifier
				Select @BuildingAcGuid = BuildingAccountGuid From Building where Guid = @BuildingGuid
				
				if IsNull(@BuildingAcGuid,0x0) <> 0x0
				begin
					Set @DetailNum = @DetailNum + 1
					Insert into [DEntry]
		 			([ParentGuid],[Number],[AcGuid],[Debit],[Credit],[CurrencyGuid],[CurrencyVal],[CostGuid],[ObverseAcGuid],[Note])
					Select
						@EnGuid,
						@DetailNum,
						@BuildingAcGuid,
						0 as Debit,
						@CostPrice as Credit,
						@CurrencyGuid,
						@CurrencyVal,
						Case when @MoveCost = 1 then @CostGuid end,
						Null as [ObverseAcGuid],
						@EntryNote
				end
			end
			
			if @CostPrice <= @Rent
			begin
					Set @DetailNum = @DetailNum + 1
					Insert into [DEntry]
		 			([ParentGuid],[Number],[AcGuid],[Debit],[Credit],[CurrencyGuid],[CurrencyVal],[CostGuid],[ObverseAcGuid],[Note])
					Select
						@EnGuid,
						@DetailNum,
						@RevenueAccountGuid,
						0 as Debit,
						@Rent - @CostPrice as Credit,
						@CurrencyGuid,
						@CurrencyVal,
						Case when @MoveCostWithIncomCredit = 1 then @CostGuid end,
						@CustAccountGuid as [ObverseAcGuid],
						@EntryNote
			end
			if @CostPrice > @Rent
			begin
					Set @DetailNum = @DetailNum + 1
					Insert into [DEntry]
		 			([ParentGuid],[Number],[AcGuid],[Debit],[Credit],[CurrencyGuid],[CurrencyVal],[CostGuid],[ObverseAcGuid],[Note])
					Select
						@EnGuid,
						@DetailNum,
						@RevenueAccountGuid,
						@CostPrice - @Rent as Debit,
						0 as Credit,
						@CurrencyGuid,
						@CurrencyVal,
						Case when @MoveCostWithIncom = 1 then @CostGuid end,
						@CustAccountGuid as [ObverseAcGuid],
						@EntryNote
			end
			
			if @CommissionFromCustValue > 0
			begin
					Set @DetailNum = @DetailNum + 1
					Insert into [DEntry]
		 			([ParentGuid],[Number],[AcGuid],[Debit],[Credit],[CurrencyGuid],[CurrencyVal],[CostGuid],[ObverseAcGuid],[Note])
					Select
						@EnGuid,
						@DetailNum,
						@CustAccountGuid,
						@CommissionFromCustValue as Debit,
						0 as Credit,
						@CurrencyGuid,
						@CurrencyVal,
						Case when @MoveCost = 1 then @CostGuid end,
						@AcCommissionFromCustGuid as [ObverseAcGuid],
						@AcCommissionFromCustNote

					Set @DetailNum = @DetailNum + 1
					Insert into [DEntry]
		 			([ParentGuid],[Number],[AcGuid],[Debit],[Credit],[CurrencyGuid],[CurrencyVal],[CostGuid],[ObverseAcGuid],[Note])
					Select
						@EnGuid,
						@DetailNum,
						@AcCommissionFromCustGuid,
						0 as Debit,
						@CommissionFromCustValue as Credit,
						@CurrencyGuid,
						@CurrencyVal,
						Case when @MoveCostWithclientCommCredit = 1 then @CostGuid end,
						@CustAccountGuid as [ObverseAcGuid],
						@AcCommissionFromCustNote
			end

			if @CommissionFromOwnerValue > 0
			begin

					Set @DetailNum = @DetailNum + 1
					Insert into [DEntry]
		 			([ParentGuid],[Number],[AcGuid],[Debit],[Credit],[CurrencyGuid],[CurrencyVal],[CostGuid],[ObverseAcGuid],[Note])
					Select
						@EnGuid,
						@DetailNum,
						@AcCustOwnerGuid,
						@CommissionFromOwnerValue as Debit,
						0 as Credit,
						@CurrencyGuid,
						@CurrencyVal,
						Case when @MoveCostWithOwnerComm = 1 then @CostGuid end,
						@AcCommissionFromOwnerGuid as [ObverseAcGuid],
						@EntryNote

					Set @DetailNum = @DetailNum + 1
					Insert into [DEntry]
		 			([ParentGuid],[Number],[AcGuid],[Debit],[Credit],[CurrencyGuid],[CurrencyVal],[CostGuid],[ObverseAcGuid],[Note])
					Select
						@EnGuid,
						@DetailNum,
						@AcCommissionFromOwnerGuid,
						0 as Debit,
						@CommissionFromOwnerValue as Credit,
						@CurrencyGuid,
						@CurrencyVal,
						Case when @MoveCostWithclientCommCredit = 1 then @CostGuid end,
						@AcCustOwnerGuid as [ObverseAcGuid],
						@AcCommissionFromOwnerNote
						
			end
			
				if @CommissionFromSalesManValue > 0
				begin
						Set @DetailNum = @DetailNum + 1
						Insert into [DEntry]
		 				([ParentGuid],[Number],[AcGuid],[Debit],[Credit],[CurrencyGuid],[CurrencyVal],[CostGuid],[ObverseAcGuid],[Note])
						Select
							@EnGuid,
							@DetailNum,
							@AcCommissionExpenseGuid,
							@CommissionFromSalesManValue as Debit,
							0 as Credit,
							@CurrencyGuid,
							@CurrencyVal,
							Case when @MoveCost = 1 then @CostGuid end,
							@AcSalesManCommissionGuid as [ObverseAcGuid],
							Case when @SalesManCommNote <> '' then @SalesManCommNote else @EntryNote end

						Set @DetailNum = @DetailNum + 1
						Insert into [DEntry]
		 				([ParentGuid],[Number],[AcGuid],[Debit],[Credit],[CurrencyGuid],[CurrencyVal],[CostGuid],[ObverseAcGuid],[Note])
						Select
							@EnGuid,
							@DetailNum,
							@AcSalesManCommissionGuid,
							0 as Debit,
							@CommissionFromSalesManValue as Credit,
							@CurrencyGuid,
							@CurrencyVal,
							Case when @MoveCostWithclientCommCredit = 1 then @CostGuid end,
							@AcCommissionExpenseGuid as [ObverseAcGuid],
							Case when @SalesManCommNote <> '' then @SalesManCommNote else @EntryNote end
				end
	end			
	
	
	if (@ContractKind = 4)
	begin
			Insert Into [HEntry]
			([Guid],[SecLvl],[Number],[Date], [CurrencyGuid], [CurrencyVal], [Note], [ParentKind], [BranchGuid], [IsPosted], Mark)
			Select
				@EnGuid,
				@SecLvl,
				@EnNum,
				@EntryDate,
				@CurrencyGuid,
				@CurrencyVal,
				@EntryNote as [Note],
				1000+@ContractKind as [ParentKind], 
				@BranchGuid as [BranchGuid], 
				@AutoPostedEntry as [IsPosted],
				@Mark
				
			Set @DetailNum = 0
			
			if @Rent <> 0
			begin
					Insert into [DEntry]
		 			([ParentGuid],[Number],[AcGuid],[Debit],[Credit],[CurrencyGuid],[CurrencyVal],[CostGuid],[ObverseAcGuid],[Note])
					Select
						@EnGuid,
						@DetailNum,
						@CustAccountGuid as [AccountGuid],
						Case when @UnearnedrRevenue = 0 then @Rent else (@Rent - @DiscountValue) end as Debit,
						0 as Credit,
						@CurrencyGuid,
						@CurrencyVal,
						Case when @MoveCost = 1 then @CostGuid end,
						@RevenueAccountGuid as [ObverseAcGuid],
						@EntryNote as [Note]
						
					if @UnearnedrRevenue = 0 
					begin
						Set @DetailNum = @DetailNum + 1
						Insert into [DEntry]
		 				([ParentGuid],[Number],[AcGuid],[Debit],[Credit],[CurrencyGuid],[CurrencyVal],[CostGuid],[ObverseAcGuid],[Note])
						Select
							@EnGuid,
							@DetailNum,
							@RevenueAccountGuid as [AccountGuid],
							0 as Debit,
							@Rent as Credit,
							@CurrencyGuid,
							@CurrencyVal,
							Case when @MoveCostWithIncomCredit = 1 then @CostGuid end,
							@CustAccountGuid as [ObverseAcGuid],
							@EntryNote as [Note]
					end
					else
					begin
						Set @DetailNum = @DetailNum + 1
						Insert into [DEntry]
		 				([ParentGuid],[Number],[AcGuid],[Debit],[Credit],[CurrencyGuid],[CurrencyVal],[CostGuid],[ObverseAcGuid],[Note])
						Select
							@EnGuid,
							@DetailNum,
							@RevenueAccountGuid as [AccountGuid],
							0 as Debit,
							(((@Rent - @DiscountValue) / dbo.fnGetCountDayofYear()) * (dbo.fnDaysBetween(@fromdate, @MaxDate))) as Credit,
							@CurrencyGuid,
							@CurrencyVal,
							Case when @MoveCostWithIncomCredit = 1 then @CostGuid end,
							@CustAccountGuid as [ObverseAcGuid],
							@EntryNote as [Note]
	
						Set @DetailNum = @DetailNum + 1
						Insert into [DEntry]
		 				([ParentGuid],[Number],[AcGuid],[Debit],[Credit],[CurrencyGuid],[CurrencyVal],[CostGuid],[ObverseAcGuid],[Note])
						Select
							@EnGuid,
							@DetailNum,
							@AcIncomNextYearGuid as [AccountGuid],
							0 as Debit,
							(@Rent - @DiscountValue) - (((@Rent - @DiscountValue) / dbo.fnGetCountDayofYear()) * (dbo.fnDaysBetween(@fromdate, @MaxDate))) as Credit,
							@CurrencyGuid,
							@CurrencyVal,
							Case when @MoveCostWithIncomCredit = 1 then @CostGuid end,
							@CustAccountGuid as [ObverseAcGuid],
							@EntryNote as [Note]
					end
			end
			
			if @InsuranceValue <> 0
			begin
					Set @DetailNum = @DetailNum + 1
					Insert into [DEntry]
	 				([ParentGuid],[Number],[AcGuid],[Debit],[Credit],[CurrencyGuid],[CurrencyVal],[CostGuid],[ObverseAcGuid],[Note])
					Select
						@EnGuid,
						@DetailNum,
						@CustAccountGuid,
						@InsuranceValue,
						0,
						@CurrencyGuid,
						@CurrencyVal,
						Case when @MoveCost = 1 then @CostGuid end,
						@InsuranceAccountGuid,
						@EntryNote

					Set @DetailNum = @DetailNum + 1
					Insert into [DEntry]
	 				([ParentGuid],[Number],[AcGuid],[Debit],[Credit],[CurrencyGuid],[CurrencyVal],[CostGuid],[ObverseAcGuid],[Note])
					Select
						@EnGuid,
						@DetailNum,
						@InsuranceAccountGuid,
						0,
						@InsuranceValue,
						@CurrencyGuid,
						@CurrencyVal,
						Case when @MoveCostWithInsuranceCredit = 1 then @CostGuid end,
						@CustAccountGuid,
						@EntryNote
			end
			
			if @CommissionFromCustValue > 0
			begin
					Set @DetailNum = @DetailNum + 1
					Insert into [DEntry]
	 				([ParentGuid],[Number],[AcGuid],[Debit],[Credit],[CurrencyGuid],[CurrencyVal],[CostGuid],[ObverseAcGuid],[Note])
					Select
						@EnGuid,
						@DetailNum,
						@CustAccountGuid,
						@CommissionFromCustValue as Debit,
						0 as Credit,
						@CurrencyGuid,
						@CurrencyVal,
						Case when @MoveCost = 1 then @CostGuid end,
						@AcCommissionFromCustGuid as [ObverseAcGuid],
						@AcCommissionFromCustNote

					Set @DetailNum = @DetailNum + 1
					Insert into [DEntry]
	 				([ParentGuid],[Number],[AcGuid],[Debit],[Credit],[CurrencyGuid],[CurrencyVal],[CostGuid],[ObverseAcGuid],[Note])
					Select
						@EnGuid,
						@DetailNum,
						@AcCommissionFromCustGuid,
						0 as Debit,
						@CommissionFromCustValue as Credit,
						@CurrencyGuid,
						@CurrencyVal,
						Case when @MoveCostWithclientCommCredit = 1 then @CostGuid end,
						@CustAccountGuid as [ObverseAcGuid],
						@AcCommissionFromCustNote
			end	
			if @CommissionFromOwnerValue > 0
			begin
					Set @DetailNum = @DetailNum + 1
					Insert into [DEntry]
	 				([ParentGuid],[Number],[AcGuid],[Debit],[Credit],[CurrencyGuid],[CurrencyVal],[CostGuid],[ObverseAcGuid],[Note])
					Select
						@EnGuid,
						@DetailNum,
						@AcCustOwnerGuid,
						@CommissionFromOwnerValue as Debit,
						0 as Credit,
						@CurrencyGuid,
						@CurrencyVal,
						Case when @MoveCostWithOwnerComm = 1 then @CostGuid end,
						@AcCommissionFromOwnerGuid as [ObverseAcGuid],
						@EntryNote

					Set @DetailNum = @DetailNum + 1
					Insert into [DEntry]
	 				([ParentGuid],[Number],[AcGuid],[Debit],[Credit],[CurrencyGuid],[CurrencyVal],[CostGuid],[ObverseAcGuid],[Note])
					Select
						@EnGuid,
						@DetailNum,
						@AcCommissionFromOwnerGuid,
						0 as Debit,
						@CommissionFromOwnerValue as Credit,
						@CurrencyGuid,
						@CurrencyVal,
						Case when @MoveCostWithOwnerCommCredit = 1 then @CostGuid end,
						@AcCustOwnerGuid as [ObverseAcGuid],
						@AcCommissionFromOwnerNote
			end
			
				if @CommissionFromSalesManValue > 0
				begin
						Set @DetailNum = @DetailNum + 1
						Insert into [DEntry]
		 				([ParentGuid],[Number],[AcGuid],[Debit],[Credit],[CurrencyGuid],[CurrencyVal],[CostGuid],[ObverseAcGuid],[Note])
						Select
							@EnGuid,
							@DetailNum,
							@AcCommissionExpenseGuid,
							@CommissionFromSalesManValue as Debit,
							0 as Credit,
							@CurrencyGuid,
							@CurrencyVal,
							Case when @MoveCost = 1 then @CostGuid end,
							@AcSalesManCommissionGuid as [ObverseAcGuid],
							Case when @SalesManCommNote <> '' then @SalesManCommNote else @EntryNote end

						Set @DetailNum = @DetailNum + 1
						Insert into [DEntry]
		 				([ParentGuid],[Number],[AcGuid],[Debit],[Credit],[CurrencyGuid],[CurrencyVal],[CostGuid],[ObverseAcGuid],[Note])
						Select
							@EnGuid,
							@DetailNum,
							@AcSalesManCommissionGuid,
							0 as Debit,
							@CommissionFromSalesManValue as Credit,
							@CurrencyGuid,
							@CurrencyVal,
							Case when @MoveCostWithclientCommCredit = 1 then @CostGuid end,
							@AcCommissionExpenseGuid as [ObverseAcGuid],
							Case when @SalesManCommNote <> '' then @SalesManCommNote else @EntryNote end
				end

			if @CertificatValue > 0
			begin
					Set @DetailNum = @DetailNum + 1
					Insert into [DEntry]
	 				([ParentGuid],[Number],[AcGuid],[Debit],[Credit],[CurrencyGuid],[CurrencyVal],[CostGuid],[ObverseAcGuid],[Note])
					Select
						@EnGuid,
						@DetailNum,
						@CustAccountGuid,
						@CertificatValue as Debit,
						0 as Credit,
						@CurrencyGuid,
						@CurrencyVal,
						Case when @MoveCost = 1 then @CostGuid end,
						@AccountCertificatValueGuid as [ObverseAcGuid],
						@EntryNote

					Set @DetailNum = @DetailNum + 1
					Insert into [DEntry]
	 				([ParentGuid],[Number],[AcGuid],[Debit],[Credit],[CurrencyGuid],[CurrencyVal],[CostGuid],[ObverseAcGuid],[Note])
					Select
						@EnGuid,
						@DetailNum,
						@AccountCertificatValueGuid,
						0 as Debit,
						@CertificatValue as Credit,
						@CurrencyGuid,
						@CurrencyVal,
						Case when @MoveCostWithCertificatCredit = 1 then @CostGuid end,
						@CustAccountGuid as [ObverseAcGuid],
						@EntryNote
			end	
			
			if @OtherFee > 0
			begin
					Set @DetailNum = @DetailNum + 1
					Insert into [DEntry]
	 				([ParentGuid],[Number],[AcGuid],[Debit],[Credit],[CurrencyGuid],[CurrencyVal],[CostGuid],[ObverseAcGuid],[Note])
					Select
						@EnGuid,
						@DetailNum,
						@CustAccountGuid,
						@OtherFee as Debit,
						0 as Credit,
						@CurrencyGuid,
						@CurrencyVal,
						Case when @MoveCost = 1 then @CostGuid end,
						@OtherFeeAccountGuid as [ObverseAcGuid],
						@EntryNote

					Set @DetailNum = @DetailNum + 1
					Insert into [DEntry]
	 				([ParentGuid],[Number],[AcGuid],[Debit],[Credit],[CurrencyGuid],[CurrencyVal],[CostGuid],[ObverseAcGuid],[Note])
					Select
						@EnGuid,
						@DetailNum,
						@OtherFeeAccountGuid,
						0 as Debit,
						@OtherFee as Credit,
						@CurrencyGuid,
						@CurrencyVal,
						Case when @MoveCostWithFeeCredit = 1 then @CostGuid end,
						@CustAccountGuid as [ObverseAcGuid],
						@EntryNote
			end	
			
			exec PrcCreateEntryFromParkingContractFee @ContractGuid, @Showresult

			if @ContractPrice > 0
			begin
					Set @DetailNum = @DetailNum + 1
					Insert into [DEntry]
	 				([ParentGuid],[Number],[AcGuid],[Debit],[Credit],[CurrencyGuid],[CurrencyVal],[CostGuid],[ObverseAcGuid],[Note])
					Select
						@EnGuid,
						@DetailNum,
						@CustAccountGuid,
						@ContractPrice as Debit,
						0 as Credit,
						@CurrencyGuid,
						@CurrencyVal,
						Case when @MoveCost = 1 then @CostGuid end,
						@AccountContractPriceGuid as [ObverseAcGuid],
						@EntryNote

					Set @DetailNum = @DetailNum + 1
					Insert into [DEntry]
	 				([ParentGuid],[Number],[AcGuid],[Debit],[Credit],[CurrencyGuid],[CurrencyVal],[CostGuid],[ObverseAcGuid],[Note])
					Select
						@EnGuid,
						@DetailNum,
						@AccountContractPriceGuid,
						0 as Debit,
						@ContractPrice as Credit,
						@CurrencyGuid,
						@CurrencyVal,
						Case when @MoveCostWithFeeCredit = 1 then @CostGuid end,
						@CustAccountGuid as [ObverseAcGuid],
						@EntryNote
			end	
		end
		end
		
		if (@FlatOwner <> 0) and (@FlatOwner <> -1)
		begin
			Insert Into [HEntry]
			([Guid],[SecLvl],[Number],[Date], [CurrencyGuid], [CurrencyVal], [Note], [ParentKind], [BranchGuid], [IsPosted], Mark)
			Select
				@EnGuid,
				@SecLvl,
				@EnNum,
				@EntryDate,
				@CurrencyGuid,
				@CurrencyVal,
				@EntryNote as [Note],
				1000+@ContractKind as [ParentKind], 
				@BranchGuid  as [BranchGuid], 
				@AutoPostedEntry as [IsPosted],
				@Mark
				
			Set @DetailNum = 0
			
			--rent
			Set @DetailNum = @DetailNum + 1
			Insert into [DEntry]
			([ParentGuid],[Number],[AcGuid],[Debit],[Credit],[CurrencyGuid],[CurrencyVal],[CostGuid],[ObverseAcGuid],[Note])
			Select
				@EnGuid,
				@DetailNum,
				@CustAccountGuid,
				@rent,
				0,
				@CurrencyGuid,
				@CurrencyVal,
				Case when @MoveCost = 1 then @CostGuid end,
				@RevenueAccountGuid,
				@EntryNote
				
			Set @DetailNum = @DetailNum + 1
			Insert into [DEntry]
			([ParentGuid],[Number],[AcGuid],[Debit],[Credit],[CurrencyGuid],[CurrencyVal],[CostGuid],[ObverseAcGuid],[Note])
			Select
				@EnGuid,
				@DetailNum,
				@RevenueAccountGuid,
				0,
				@rent,
				@CurrencyGuid,
				@CurrencyVal,
				Case when @MoveCostWithIncomCredit = 1 then @CostGuid end,
				@CustAccountGuid,
				@EntryNote

			--Insurance
			if @InsuranceValue <> 0
			begin
				Set @DetailNum = @DetailNum + 1
				Insert into [DEntry]
				([ParentGuid],[Number],[AcGuid],[Debit],[Credit],[CurrencyGuid],[CurrencyVal],[CostGuid],[ObverseAcGuid],[Note])
				Select
					@EnGuid,
					@DetailNum,
					@CustAccountGuid,
					@InsuranceValue,
					0,
					@CurrencyGuid,
					@CurrencyVal,
					Case when @MoveCost = 1 then @CostGuid end,
					@InsuranceAccountGuid,
					@EntryNote
					
				Set @DetailNum = @DetailNum + 1
				Insert into [DEntry]
				([ParentGuid],[Number],[AcGuid],[Debit],[Credit],[CurrencyGuid],[CurrencyVal],[CostGuid],[ObverseAcGuid],[Note])
				Select
					@EnGuid,
					@DetailNum,
					@InsuranceAccountGuid,
					0,
					@InsuranceValue,
					@CurrencyGuid,
					@CurrencyVal,
					Case when @MoveCostWithInsuranceCredit = 1 then @CostGuid end,
					@CustAccountGuid,
					@EntryNote
			end

			if @CommissionFromCustValue > 0
			begin
					Set @DetailNum = @DetailNum + 1
					Insert into [DEntry]
		 			([ParentGuid],[Number],[AcGuid],[Debit],[Credit],[CurrencyGuid],[CurrencyVal],[CostGuid],[ObverseAcGuid],[Note])
					Select
						@EnGuid,
						@DetailNum,
						@CustAccountGuid,
						@CommissionFromCustValue as Debit,
						0 as Credit,
						@CurrencyGuid,
						@CurrencyVal,
						Case when @MoveCost = 1 then @CostGuid end,
						@AcCommissionFromCustGuid as [ObverseAcGuid],
						@AcCommissionFromCustNote

					Set @DetailNum = @DetailNum + 1
					Insert into [DEntry]
		 			([ParentGuid],[Number],[AcGuid],[Debit],[Credit],[CurrencyGuid],[CurrencyVal],[CostGuid],[ObverseAcGuid],[Note])
					Select
						@EnGuid,
						@DetailNum,
						@AcCommissionFromCustGuid,
						0 as Debit,
						@CommissionFromCustValue as Credit,
						@CurrencyGuid,
						@CurrencyVal,
						Case when @MoveCostWithclientCommCredit = 1 then @CostGuid end,
						@CustAccountGuid as [ObverseAcGuid],
						@AcCommissionFromCustNote
			end

			if @CommissionFromOwnerValue > 0
			begin
					Set @DetailNum = @DetailNum + 1
					Insert into [DEntry]
		 			([ParentGuid],[Number],[AcGuid],[Debit],[Credit],[CurrencyGuid],[CurrencyVal],[CostGuid],[ObverseAcGuid],[Note])
					Select
						@EnGuid,
						@DetailNum,
						@AcCustOwnerGuid,
						@CommissionFromOwnerValue as Debit,
						0 as Credit,
						@CurrencyGuid,
						@CurrencyVal,
						Case when @MoveCostWithOwnerComm = 1 then @CostGuid end,
						@AcCommissionFromOwnerGuid as [ObverseAcGuid],
						@EntryNote

					Set @DetailNum = @DetailNum + 1
					Insert into [DEntry]
		 			([ParentGuid],[Number],[AcGuid],[Debit],[Credit],[CurrencyGuid],[CurrencyVal],[CostGuid],[ObverseAcGuid],[Note])
					Select
						@EnGuid,
						@DetailNum,
						@AcCommissionFromOwnerGuid,
						0 as Debit,
						@CommissionFromOwnerValue as Credit,
						@CurrencyGuid,
						@CurrencyVal,
						Case when @MoveCostWithclientCommCredit = 1 then @CostGuid end,
						@AcCustOwnerGuid as [ObverseAcGuid],
						@AcCommissionFromOwnerNote
			end
			
				if @CommissionFromSalesManValue > 0
				begin
						Set @DetailNum = @DetailNum + 1
						Insert into [DEntry]
		 				([ParentGuid],[Number],[AcGuid],[Debit],[Credit],[CurrencyGuid],[CurrencyVal],[CostGuid],[ObverseAcGuid],[Note])
						Select
							@EnGuid,
							@DetailNum,
							@AcCommissionExpenseGuid,
							@CommissionFromSalesManValue as Debit,
							0 as Credit,
							@CurrencyGuid,
							@CurrencyVal,
							Case when @MoveCost = 1 then @CostGuid end,
							@AcSalesManCommissionGuid as [ObverseAcGuid],
							Case when @SalesManCommNote <> '' then @SalesManCommNote else @EntryNote end

						Set @DetailNum = @DetailNum + 1
						Insert into [DEntry]
		 				([ParentGuid],[Number],[AcGuid],[Debit],[Credit],[CurrencyGuid],[CurrencyVal],[CostGuid],[ObverseAcGuid],[Note])
						Select
							@EnGuid,
							@DetailNum,
							@AcSalesManCommissionGuid,
							0 as Debit,
							@CommissionFromSalesManValue as Credit,
							@CurrencyGuid,
							@CurrencyVal,
							Case when @MoveCostWithclientCommCredit = 1 then @CostGuid end,
							@AcCommissionExpenseGuid as [ObverseAcGuid],
							Case when @SalesManCommNote <> '' then @SalesManCommNote else @EntryNote end
				end

			if @CertificatValue > 0
			begin
					Set @DetailNum = @DetailNum + 1
					Insert into [DEntry]
					([ParentGuid],[Number],[AcGuid],[Debit],[Credit],[CurrencyGuid],[CurrencyVal],[CostGuid],[ObverseAcGuid],[Note])
					Select
						@EnGuid,
						@DetailNum,
						@CustAccountGuid,
						@CertificatValue,
						0,
						@CurrencyGuid,
						@CurrencyVal,
						Case when @MoveCost = 1 then @CostGuid end,
						@AccountCertificatValueGuid,
						@EntryNote

					Set @DetailNum = @DetailNum + 1
					Insert into [DEntry]
					([ParentGuid],[Number],[AcGuid],[Debit],[Credit],[CurrencyGuid],[CurrencyVal],[CostGuid],[ObverseAcGuid],[Note])
					Select
						@EnGuid,
						@DetailNum,
						@AccountCertificatValueGuid,
						0 as Debit,
						@CertificatValue as Credit,
						@CurrencyGuid,
						@CurrencyVal,
						Case when @MoveCostWithCertificatCredit = 1 then @CostGuid end,
						@CustAccountGuid as [ObverseAcGuid],
						@EntryNote
			end	
			if @OtherFee > 0
			begin
					Set @DetailNum = @DetailNum + 1
					Insert into [DEntry]
					([ParentGuid],[Number],[AcGuid],[Debit],[Credit],[CurrencyGuid],[CurrencyVal],[CostGuid],[ObverseAcGuid],[Note])
					Select
						@EnGuid,
						@DetailNum,
						@CustAccountGuid,
						@OtherFee as Debit,
						0 as Credit,
						@CurrencyGuid,
						@CurrencyVal,
						Case when @MoveCost = 1 then @CostGuid end,
						@OtherFeeAccountGuid as [ObverseAcGuid],
						@EntryNote

					Set @DetailNum = @DetailNum + 1
					Insert into [DEntry]
					([ParentGuid],[Number],[AcGuid],[Debit],[Credit],[CurrencyGuid],[CurrencyVal],[CostGuid],[ObverseAcGuid],[Note])
					Select
						@EnGuid,
						@DetailNum,
						@OtherFeeAccountGuid,
						0 as Debit,
						@OtherFee as Credit,
						@CurrencyGuid,
						@CurrencyVal,
						Case when @MoveCostWithFeeCredit = 1 then @CostGuid end,
						@CustAccountGuid as [ObverseAcGuid],
						@EntryNote
			end	
			
			exec PrcCreateEntryFromParkingContractFee @ContractGuid
		end	

		if (@DiscountValue > 0) and (@UnearnedrRevenue = 0)
		begin
				Set @DetailNum = @DetailNum + 1
					Insert into [DEntry]
					([ParentGuid],[Number],[AcGuid],[Debit],[Credit],[CurrencyGuid],[CurrencyVal],[CostGuid],[ObverseAcGuid],[Note])
					Select
					@EnGuid,
					@DetailNum,
					@DiscountAccountGuid,
					@DiscountValue as Debit,
					0 as Credit,
					@CurrencyGuid,
					@CurrencyVal,
					Case when @MoveCostWithDiscount = 1 then @CostGuid end,
					@custAccountGuid,
					dbo.SC('  ') + @EntryNote

				Set @DetailNum = @DetailNum + 1
				Insert into [DEntry]
				([ParentGuid],[Number],[AcGuid],[Debit],[Credit],[CurrencyGuid],[CurrencyVal],[CostGuid],[ObverseAcGuid],[Note])
				Select
					@EnGuid,
					@DetailNum,
					@custAccountGuid,
					0,
					@DiscountValue,
					@CurrencyGuid,
					@CurrencyVal,
					Case when @MoveCostWithDiscountCredit = 1 then @CostGuid end,
					@DiscountAccountGuid as [ObverseAcGuid],
					dbo.SC('  ') + @EntryNote
		end	

		exec PrcDoDistributiveEntry @EnGuid
		
		
		Delete Dentry where ParentGuid = @EnGuid and (Debit + Credit) = 0
		
		Delete [Hentry] 
		From
			[Hentry] H
			left join DEntry D on D.ParentGuid = H.Guid
		where 
			(H.Guid = @EnGuid )
			and D.ParentGuid is Null
			
		--Update [Hentry] Set IsPosted = 1 where Guid = @EnGuid
		

GO

SET ANSI_NULLS, QUOTED_IDENTIFIER ON
GO

Create Procedure [PrcTrailBalance]
(
	@AccountGuid [uniqueidentifier]= 0x0
	,@BranchGuid uniqueidentifier = 0x0
	,@CostGuid [uniqueidentifier]= 0x0
	,@Level int = 0
	,@ShowEmptyBal Bit = 0
	,@ShowBalancedAc Bit = 0
	,@ShowMainAccount Bit = 1
	,@ShowAcCust Bit = 1
	,@CurrencyGuid [uniqueidentifier] = 0x0
	,@CurrencyVal Float = 1
	,@IsPosted Bit = 1
	,@IsNotPosted Bit = 1
	,@Date1 DateTime = '1/1/2011'
	,@Date2 DateTime = '12/30/2011'
	,@ShowOldBalance Bit = 0
    ,@ShowwithSum Bit = 0
    ,@ShowWithBalance Bit = 1
	,@ShowDebit Bit = 0
    ,@ShowCredit Bit = 1
	,@CheckDate Bit = 0
)
 
as
	Set Nocount on 
	if @CurrencyVal = 0
	Set @CurrencyVal = 1
	
	--
	Select * Into [dbo].#ListAccount From [dbo].[fnGetAccountList](@AccountGuid) [Ac] 
	Select * Into [dbo].#ListCost From [dbo].[fnGetCostList](@CostGuid)
	
	--  
	Select 
		[Ac2].[Name] as [AccountName],
		[Ac2].[Code] as [AccountCode]
		,[Ac].[Level]
		,[Ac].[Path]
		,[Ac2].[Guid]
		,[Ac2].[ParentGuid]
		,Cast(0 as int) as [AcNSons]--Isnull([SAc].[AcNSons],0) as [AcNSons]
		into #Ac
	From
		[dbo].#ListAccount [Ac] 
		inner join [vwAccount] [Ac2] on [Ac2].[Guid] = [Ac].[Guid]
	where
		[Type] = 0
		
	Select 
		Count(Number) as [Sons] 
		,[ParentGuid] 
	Into #AcSons
	From 
		[Account] [SAc] 
	Group By
		[ParentGuid]
							
	update #Ac Set [AcNSons] = S.[Sons]
	From
		#ac ac
		inner join #AcSons S on S.ParentGUID = ac.Guid

--	Select * from #Ac Order by [Path]
	--return

	--  
	Select 
		[Ac].[Guid] as [AcGuid]
		,Sum([En].[Debit]*
			Case when [En].[CurrencyGuid] = @CurrencyGuid then 1 
			else [En].[CurrencyVal] / @CurrencyVal end
			) as [Debit]
		,Sum([En].[Credit]*
			Case when [En].[CurrencyGuid] = @CurrencyGuid then 1 
			else [En].[CurrencyVal] / @CurrencyVal end
			) as [Credit]
	into #Entry
	from 
		[DEntry] [En]
		inner Join [vwEntry] [M] on [M].[Guid] = [En].[ParentGuid]
		inner Join [dbo].#ListAccount  [Ac] on [Ac].[Guid] = [En].[AcGuid]
		left Join  [dbo].#ListCost [Co] on [Co].[Guid] = [En].[CostGuid]
	where 
		([M].[Date] between @Date1 And @Date2 or @CheckDate = 0)
		and ( [Co].[Guid] Is Not Null or @CostGuid = 0x0)
		and ([M].[BranchGuid] = @BranchGuid or @BranchGuid = 0x0)
		and ([En].[IsVisible] = 1 or [En].[CurrencyGuid] = @CurrencyGuid)
		and (
				([M].[IsPosted] = 1 and @IsPosted = 1)
				or ([M].[IsPosted] = 0  and @IsNotPosted = 1)
			)
	Group By
		[Ac].[Guid]
		
	Create Index IDX_TEntry_AcGuid on #Entry ([AcGuid])
	
--	Select * from #Entry	
	--

	--  
	Select 
		[Ac].[Guid] as [AcGuid]
		,Sum([En].[Debit]*
			Case when [En].[CurrencyGuid] = @CurrencyGuid then 1 
			else [En].[CurrencyVal] / @CurrencyVal end
			) as [Debit]
		,Sum([En].[Credit]*
			Case when [En].[CurrencyGuid] = @CurrencyGuid then 1 
			else [En].[CurrencyVal] / @CurrencyVal end
			) as [Credit]
	into #OldBalance
	from 
		[DEntry] [En]
		inner Join [vwEntry] [M] on [M].[Guid] = [En].[ParentGuid]
		inner Join [dbo].#ListAccount [Ac] on [Ac].[Guid] = [En].[AcGuid]
		left Join [dbo].#ListCost [Co] on [Co].[Guid] = [En].[CostGuid]
	where 
		([M].[Date] < @Date1 and  @CheckDate = 1)
		and ( [Co].[Guid] Is Not Null or @CostGuid = 0x0)
		and ([M].[BranchGuid] = @BranchGuid or @BranchGuid = 0x0)
		and ([En].[IsVisible] = 1 or [En].[CurrencyGuid] = @CurrencyGuid)
		and (
				([M].[IsPosted] = 1 and @IsPosted = 1)
				or ([M].[IsPosted] = 0  and @IsNotPosted = 1)
			)
	Group By 
		[Ac].[Guid]
 	Having
 		(Sum([En].[Debit]) <> 0)
 		or (Sum([En].[Credit]) <> 0)
	
	Create Index IDX_OldBalance_AcGuid on #OldBalance ([AcGuid])

--	Select * from #OldBalance	
	--	

	Select 
		[Ac].[AccountName],
		[Ac].[AccountCode]
		,[Ac].[Level]
		,[E].[Debit]
		,[E].[Credit]
		,[B].[Debit] as [OldDebit]
		,[B].[Credit] as [OldCredit]
		,[Ac].[Path]
		,[Ac].[Guid] as [AcGuid]
		,[Ac].[ParentGuid]
		,[Ac].[AcNSons]
	Into #Res1
	From
		#Ac	[Ac]
		left join #Entry [E] on [E].[AcGuid] = [Ac].[Guid]
		left join #OldBalance [B] on [B].[AcGuid] = [Ac].[Guid]

	

	Create Index IDX_TRes1_AcGuid on #Res1 ([AcGuid])
	
--	update #Res1 Set [Debit] = 0 where [Debit] is null

	Declare @AcLevel int
	SET @acLevel = (SELECT MAX([Level]) FROM [#Res1]) 
	WHILE @acLevel >= 0  
	BEGIN  
		print '@acLevel'
		print @acLevel
		UPDATE [#Res1] SET  
			[Debit] 		= isnull([SumDebit],0)
			,[Credit]	 	= isnull([SumCredit],0)
			,[OldDebit]		= isnull([SumOldDebit],0) 
			,[OldCredit]	= isnull([SumOldCredit],0)
			FROM  
				[#Res1] AS [Father] INNER JOIN (  
					SELECT 
						[ParentGuid] 
						,isnull(Sum([Debit]),0)			as  [SumDebit]
						,isnull(Sum([Credit]),0)		as  [SumCredit]
						,isnull(Sum([OldDebit]),0)		as  [SumOldDebit]
						,isnull(Sum([OldCredit]),0)		as  [SumOldCredit]
					FROM 
						[#Res1]  
					WHERE  
						[Level] = @acLevel 
					GROUP BY 
						[ParentGuid] 
					) AS [Sons] 
				ON [Father].[acGUID] = [Sons].[ParentGuid] 
		Print '@@Rowcount'
		Print @@Rowcount
		SET @acLevel = @acLevel - 1 
	End
	
--	Select * from #Res1

	Create Table #EndRes
	(
		[AccountName] Varchar(256),
		[AccountCode] Varchar(256),
		[SumOldDebit] Float,
		[SumOldCredit] Float,
		[OldBalanceDebit] Float,
		[OldBalanceCredit] Float,
		[SumPeriodDebit]Float,
		[SumPeriodCredit]Float,
		[BalancePeriodDebit]Float,
		[BalancePeriodCredit]Float,
		[AcGuid] uniqueidentifier,
		[ParentGuid]uniqueidentifier,
		[Path] Varchar(256),
		[ACNSons] int,
		[Level] Varchar(256)
	)

	insert into #EndRes
	Select 
		[AccountName],
		[AccountCode],
		isNull([OldDebit],0) as [SumOldDebit],
		isNull([OldCredit],0) as [SumOldCredit],
		Case when Isnull([OldDebit],0) > isnull([OldCredit],0) then Isnull([OldDebit],0) - isnull([OldCredit],0) else 0 end as [OldBalanceDebit],
		Case when Isnull([OldDebit],0) < isnull([OldCredit],0) then Isnull([OldCredit],0) - isnull([OldDebit],0) else 0 end as [OldBalanceCredit],
		isNull([Debit],0) as [SumPeriodDebit],
		isNull([Credit],0) as [SumPeriodCredit],
		Case when Isnull([Debit],0) > isnull([Credit],0) then Isnull([Debit],0) - isnull([Credit],0)  else 0 end as [BalancePeriodDebit],
		Case when Isnull([Debit],0) < isnull([Credit],0) then isnull([Credit],0) - Isnull([Debit],0)  else 0 end as [BalancePeriodCredit],
		[AcGuid],
		[ParentGuid],
		[Path],
		[ACNSons],
		[Level]
	from 
		#Res1
	Order By
		[Path]
	
	Insert Into #EndRes
	Select 
		dbo.sc('') as [AccountName],
		'' as AccountCode,
		Sum([SumOldDebit]),
		Sum([SumOldCredit]),
		Sum([OldBalanceDebit]),
		Sum([OldBalanceCredit]),
		Sum([SumPeriodDebit]),
		Sum([SumPeriodCredit]),
		Sum([BalancePeriodDebit]),
		Sum([BalancePeriodCredit]),
		0x0 as [AcGuid],
		0x0 as [ParentGuid],
		Max([Path]) + 'Z',
		-1 as [ACNSons],
		0 as [Level]
	From
		#EndRes
	where
		[AcNSons] = 0

	--Select Level, * from #EndRes

	--  
 	if @ShowMainAccount = 0 
 	delete from #EndRes
 	where (AcNSons > 0 )

	-- 
	if @ShowEmptyBal = 0 
	delete from #EndRes
	where (isnull([SumOldDebit],0) = 0  and isnull([SumOldCredit],0) = 0) and(isnull([SumPeriodDebit],0) = 0  and isnull([SumPeriodCredit],0) = 0)
	and Level >= 1

	--  
 	if @ShowBalancedAc = 0 
 	delete from #EndRes
 	where 
 			Round((isnull([SumOldDebit],0) + isnull([SumPeriodDebit],0) ),3) = Round(( isnull([SumOldCredit],0) + isnull([SumPeriodCredit],0) ),3)
 			and 
 			Round((isnull([SumOldDebit],0) + isnull([SumPeriodDebit],0) ),3)> 0	
 			
 	and (AcNSons = 0 )

	if @ShowAcCust = 0
 	begin
 		Declare @AcCust uniqueidentifier
 		Set @AcCust = (Select Value From [DMD_Const] where VName = 'CuAccountParent')
		
		--Select * from  #EndRes where [AcGuid] = @AcCust

 		if isnull(@AcCust,0x0) <> 0x0
 		begin
 			Select * into #fnGetAccountList1 from [dbo].[fnGetAccountList](@AcCust)
 			
 			Delete #EndRes
 			From
 				#EndRes R
 				inner join [dbo].[#fnGetAccountList1] [Ac] on [Ac].[Guid] = [R].[AcGuid]
 			where
				[R].[AcGuid] <> @AcCust
				
			update #EndRes set ACNSons = 0 where [AcGuid] = @AcCust
			
		end
 	end
 
 	if @ShowAcCust = 0
 	begin
 		Declare @AcCust2 uniqueidentifier
 		Set @AcCust2 = (Select Value From [DMD_Const] where VName = 'ImporterAccountParent')
 
 		if isnull(@AcCust2,0x0) <> 0x0
 		begin
			Select * into #fnGetAccountList2 from [dbo].[fnGetAccountList](@AcCust2)

 			Delete #EndRes
 			From
 				#EndRes R
 				inner join [dbo].[#fnGetAccountList2] [Ac] on [Ac].[Guid] = [R].[AcGuid]
 			where
 				[R].[AcGuid] <> @AcCust2
	 			
 			update #EndRes set ACNSons = 0 where [AcGuid] = @AcCust2
 		end
 		
 	end
 
 	if @ShowAcCust = 0
 	begin
 		Declare @AcCust3 uniqueidentifier
 		Set @AcCust3 = (Select Value From [DMD_Const] where VName = 'InsuranceAccountParent')
 
		
		
 		if isnull(@AcCust3,0x0) <> 0x0
 		begin
 			Select * into #fnGetAccountList3 from [dbo].[fnGetAccountList](@AcCust3)
 			
 			Delete #EndRes
 			From
 				#EndRes R
 				inner join [dbo].[#fnGetAccountList3] [Ac] on [Ac].[Guid] = [R].[AcGuid]
 			where
 				[R].[AcGuid] <> @AcCust3
 				
 			update #EndRes set ACNSons = 0 where [AcGuid] = @AcCust3
 		end
 	end
 
	Select 
		[AccountName],
		[AccountCode],
		[SumOldDebit],
		[SumOldCredit],
		[OldBalanceDebit],
		[OldBalanceCredit],
		[SumPeriodDebit],
		[SumPeriodCredit],
		[BalancePeriodDebit],
		[BalancePeriodCredit],
		isnull([SumOldDebit],0) + isnull([SumPeriodDebit], 0) as [SumEndDebit],
		isnull([SumOldCredit],0) + isnull([SumPeriodCredit], 0) as [SumEndCredit],
		
		Case when ACNSons <> -1 then 
			Case when (isnull([SumOldDebit],0) + isnull([SumPeriodDebit], 0)) > (isnull([SumOldCredit],0) + isnull([SumPeriodCredit], 0)) then
					  (isnull([SumOldDebit],0) + isnull([SumPeriodDebit], 0)) - (isnull([SumOldCredit],0) + isnull([SumPeriodCredit], 0))
			else 0
			end 
		else
			0
		end
		as [BalanceEndDebit],
		
		Case when ACNSons <> -1 then 
			Case when (isnull([SumOldDebit],0) + isnull([SumPeriodDebit], 0)) < isnull([SumOldCredit],0) + isnull([SumPeriodCredit], 0) then
					  (isnull([SumOldCredit],0) + isnull([SumPeriodCredit], 0)) - (isnull([SumOldDebit],0) + isnull([SumPeriodDebit], 0))
			else 0
			end 
		else
			0
		end
		as [BalanceEndCredit],
		
		[AcGuid],
		[ParentGuid],
		[Path],
		[ACNSons],
		[Level]
	Into #R
	from 
		#EndRes
	
	update #r Set 
	[BalanceEndDebit] = IsNull((Select Sum([BalanceEndDebit]) From #R where ACNSons = 0), 0),
	[BalanceEndCredit] = IsNull((Select Sum([BalanceEndCredit]) From #R where ACNSons = 0), 0)
	where
		ACNSons = -1
		
 	--
 	delete from #R
 	where ([level] >= @Level and @Level <> 0)

	Select 
		* 
	from 
		#R
  	where	
 		(IsNull([BalancePeriodDebit],0) <> 0 and @ShowWithBalance = 1 and @ShowDebit = 1 or @ShowEmptyBal = 1)
 		Or
 		(isNull([BalancePeriodCredit],0) <> 0 and @ShowWithBalance = 1 and @ShowCredit = 1 or @ShowEmptyBal = 1)
 		or 
 		IsNull([Level],0) = 0
 		or @ShowWithBalance = 0
		or @ShowBalancedAc = 1
	Order By
		[Path]


GO

SET ANSI_NULLS, QUOTED_IDENTIFIER ON
GO

Create Trigger [TRG_TraceContract_LeaseApartment]
on [LeaseApartment]
 
for update
As
	SET NOCOUNT ON;
	if Not exists(Select Value from DMD_const where vName = 'ActiveLogCardUpdate' and Value = '1' ) return
	
	Declare @UserGuid uniqueidentifier, @Guid uniqueidentifier
	Set @Guid = NEWID()
	
	Select Top 1 @UserGuid = userGuid From CurrentUsers where Spid = @@SPID
			
	insert into [Trace]([Guid],[ParentGuid],[Date],[userGuid],[HostName],[ParentTbl])
	Select top 1
		@Guid,
		N.Guid,
		GETDATE(),
		@UserGuid,
		Host_Name(),
		'LeaseApartment'
	From
		[inserted] n 
		
	insert into [TraceDetail]
	([ParentGuid],[Caption],[Old],[New])
	Select Top 1
		@Guid,
		' ' as [Caption],
		D.[SecLvl] as [old],
		N.[SecLvl] as [New]
	From
		[deleted] d
		inner join [inserted] n on D.Guid = N.Guid
	where
		N.[SecLvl] <> D.[SecLvl]

	insert into [TraceDetail]
	([ParentGuid],[Caption],[Old],[New])
	Select Top 1
		@Guid,
		' ' as [Caption],
		dbo.fnDate(D.[EditDate]) as [old],
		dbo.fnDate(N.[EditDate]) as [New]
	From
		[deleted] d
		inner join [inserted] n on D.Guid = N.Guid
	where
		N.[EditDate] <> D.[EditDate]

	insert into [TraceDetail]
	([ParentGuid],[Caption],[Old],[New])
	Select Top 1
		@Guid,
		'' as [Caption],
		D.[Mark] as [old],
		N.[Mark] as [New]
	From
		[deleted] d
		inner join [inserted] n on D.Guid = N.Guid
	where
		N.[Mark] <> D.[Mark]

	insert into [TraceDetail]
	([ParentGuid],[Caption],[Old],[New],[Tbl])
	Select Top 1
		@Guid,
		' ' as [Caption],
		D.[TypeGuid] as [old],
		N.[TypeGuid] as [New],
		'[ContractType]'
	From
		[deleted] d
		inner join [inserted] n on D.Guid = N.Guid
	where
		N.[TypeGuid] <> D.[TypeGuid]

	insert into [TraceDetail]
	([ParentGuid],[Caption],[Old],[New])
	Select Top 1
		@Guid,
		' ' as [Caption],
		D.[ContractNo] as [old],
		N.[ContractNo] as [New]
	From
		[deleted] d
		inner join [inserted] n on D.Guid = N.Guid
	where
		N.[ContractNo] <> D.[ContractNo]

	insert into [TraceDetail]
	([ParentGuid],[Caption],[Old],[New],[Tbl])
	Select Top 1
		@Guid,
		'' as [Caption],
		D.[CustomerGuid] as [old],
		N.[CustomerGuid] as [New],
		'[Customer]'
	From
		[deleted] d
		inner join [inserted] n on D.Guid = N.Guid
	where
		N.[CustomerGuid] <> D.[CustomerGuid]

	insert into [TraceDetail]
	([ParentGuid],[Caption],[Old],[New],[Tbl])
	Select Top 1
		@Guid,
		'' as [Caption],
		D.[RentInfoGuid] as [old],
		N.[RentInfoGuid] as [New],
		'[RentInfo]'
	From
		[deleted] d
		inner join [inserted] n on D.Guid = N.Guid
	where
		N.[RentInfoGuid] <> D.[RentInfoGuid]

	insert into [TraceDetail]
	([ParentGuid],[Caption],[Old],[New],[Tbl])
	Select Top 1
		@Guid,
		'' as [Caption],
		D.[SalesManGuid] as [old],
		N.[SalesManGuid] as [New],
		'[SalesMan]'
	From
		[deleted] d
		inner join [inserted] n on D.Guid = N.Guid
	where
		N.[SalesManGuid] <> D.[SalesManGuid]

	insert into [TraceDetail]
	([ParentGuid],[Caption],[Old],[New],[Tbl])
	Select Top 1
		@Guid,
		'' as [Caption],
		D.[BuildingGuid] as [old],
		N.[BuildingGuid] as [New],
		'[Building]'
	From
		[deleted] d
		inner join [inserted] n on D.Guid = N.Guid
	where
		N.[BuildingGuid] <> D.[BuildingGuid]

	insert into [TraceDetail]
	([ParentGuid],[Caption],[Old],[New],[Tbl])
	Select Top 1
		@Guid,
		'' as [Caption],
		D.[ApartmentGuid] as [old],
		N.[ApartmentGuid] as [New],
		'[Apartment]'
	From
		[deleted] d
		inner join [inserted] n on D.Guid = N.Guid
	where
		N.[ApartmentGuid] <> D.[ApartmentGuid]

	insert into [TraceDetail]
	([ParentGuid],[Caption],[Old],[New])
	Select Top 1
		@Guid,
		'' as [Caption],
		D.[ApartmentType] as [old],
		N.[ApartmentType] as [New]
	From
		[deleted] d
		inner join [inserted] n on D.Guid = N.Guid
	where
		N.[ApartmentType] <> D.[ApartmentType]

	insert into [TraceDetail]
	([ParentGuid],[Caption],[Old],[New],[Tbl])
	Select Top 1
		@Guid,
		' ' as [Caption],
		D.[CostGuid] as [old],
		N.[CostGuid] as [New],
		'[Cost]'
	From
		[deleted] d
		inner join [inserted] n on D.Guid = N.Guid
	where
		N.[CostGuid] <> D.[CostGuid]

	insert into [TraceDetail]
	([ParentGuid],[Caption],[Old],[New])
	Select Top 1
		@Guid,
		' ' as [Caption],
		dbo.fnDate(D.[FromDate]) as [old],
		dbo.fnDate(N.[FromDate]) as [New]
	From
		[deleted] d
		inner join [inserted] n on D.Guid = N.Guid
	where
		N.[FromDate] <> D.[FromDate]

	insert into [TraceDetail]
	([ParentGuid],[Caption],[Old],[New])
	Select Top 1
		@Guid,
		' ' as [Caption],
		dbo.fnDate(D.[ToDate]) as [old],
		dbo.fnDate(N.[ToDate]) as [New]
	From
		[deleted] d
		inner join [inserted] n on D.Guid = N.Guid
	where
		N.[ToDate] <> D.[ToDate]

	insert into [TraceDetail]
	([ParentGuid],[Caption],[Old],[New])
	Select Top 1
		@Guid,
		'' as [Caption],
		D.[Period] as [old],
		N.[Period] as [New]
	From
		[deleted] d
		inner join [inserted] n on D.Guid = N.Guid
	where
		N.[Period] <> D.[Period]

	insert into [TraceDetail]
	([ParentGuid],[Caption],[Old],[New])
	Select Top 1
		@Guid,
		' ' as [Caption],
		D.[RentContractType] as [old],
		N.[RentContractType] as [New]
	From
		[deleted] d
		inner join [inserted] n on D.Guid = N.Guid
	where
		N.[RentContractType] <> D.[RentContractType]

	insert into [TraceDetail]
	([ParentGuid],[Caption],[Old],[New])
	Select Top 1
		@Guid,
		' ' as [Caption],
		D.[Rent] as [old],
		N.[Rent] as [New]
	From
		[deleted] d
		inner join [inserted] n on D.Guid = N.Guid
	where
		N.[Rent] <> D.[Rent]

	insert into [TraceDetail]
	([ParentGuid],[Caption],[Old],[New])
	Select Top 1
		@Guid,
		' ' as [Caption],
		D.[MonthlyValue] as [old],
		N.[MonthlyValue] as [New]
	From
		[deleted] d
		inner join [inserted] n on D.Guid = N.Guid
	where
		N.[MonthlyValue] <> D.[MonthlyValue]

	insert into [TraceDetail]
	([ParentGuid],[Caption],[Old],[New],[Tbl])
	Select Top 1
		@Guid,
		'' as [Caption],
		D.[CurrencyGuid] as [old],
		N.[CurrencyGuid] as [New],
		'[Currency]'
	From
		[deleted] d
		inner join [inserted] n on D.Guid = N.Guid
	where
		N.[CurrencyGuid] <> D.[CurrencyGuid]

	insert into [TraceDetail]
	([ParentGuid],[Caption],[Old],[New])
	Select Top 1
		@Guid,
		' ' as [Caption],
		D.[CurrencyVal] as [old],
		N.[CurrencyVal] as [New]
	From
		[deleted] d
		inner join [inserted] n on D.Guid = N.Guid
	where
		N.[CurrencyVal] <> D.[CurrencyVal]

	insert into [TraceDetail]
	([ParentGuid],[Caption],[Old],[New])
	Select Top 1
		@Guid,
		' ' as [Caption],
		D.[PayType] as [old],
		N.[PayType] as [New]
	From
		[deleted] d
		inner join [inserted] n on D.Guid = N.Guid
	where
		N.[PayType] <> D.[PayType]

	insert into [TraceDetail]
	([ParentGuid],[Caption],[Old],[New])
	Select Top 1
		@Guid,
		'' as [Caption],
		LEFT(D.[Note], 255) as [old],
		LEFT(N.[Note], 255) as [New]
	From
		[deleted] d
		inner join [inserted] n on D.Guid = N.Guid
	where
		N.[Note] <> D.[Note]

	insert into [TraceDetail]
	([ParentGuid],[Caption],[Old],[New])
	Select Top 1
		@Guid,
		' 2' as [Caption],
		LEFT(D.[Note2], 255) as [old],
		LEFT(N.[Note2], 255) as [New]
	From
		[deleted] d
		inner join [inserted] n on D.Guid = N.Guid
	where
		N.[Note2] <> D.[Note2]

	insert into [TraceDetail]
	([ParentGuid],[Caption],[Old],[New])
	Select Top 1
		@Guid,
		' ' as [Caption],
		D.[Trademark] as [old],
		N.[Trademark] as [New]
	From
		[deleted] d
		inner join [inserted] n on D.Guid = N.Guid
	where
		N.[Trademark] <> D.[Trademark]

	insert into [TraceDetail]
	([ParentGuid],[Caption],[Old],[New])
	Select Top 1
		@Guid,
		'  ' as [Caption],
		D.[Purpose] as [old],
		N.[Purpose] as [New]
	From
		[deleted] d
		inner join [inserted] n on D.Guid = N.Guid
	where
		N.[Purpose] <> D.[Purpose]

	insert into [TraceDetail]
	([ParentGuid],[Caption],[Old],[New])
	Select Top 1
		@Guid,
		' ' as [Caption],
		D.[Whereabouts] as [old],
		N.[Whereabouts] as [New]
	From
		[deleted] d
		inner join [inserted] n on D.Guid = N.Guid
	where
		N.[Whereabouts] <> D.[Whereabouts]

	insert into [TraceDetail]
	([ParentGuid],[Caption],[Old],[New],[Tbl])
	Select Top 1
		@Guid,
		' ' as [Caption],
		D.[RevenueAccountGuid] as [old],
		N.[RevenueAccountGuid] as [New],
		'[Account]'
	From
		[deleted] d
		inner join [inserted] n on D.Guid = N.Guid
	where
		N.[RevenueAccountGuid] <> D.[RevenueAccountGuid]

	insert into [TraceDetail]
	([ParentGuid],[Caption],[Old],[New],[Tbl])
	Select Top 1
		@Guid,
		' ' as [Caption],
		D.[CustAccountGuid] as [old],
		N.[CustAccountGuid] as [New],
		'[Account]'
	From
		[deleted] d
		inner join [inserted] n on D.Guid = N.Guid
	where
		N.[CustAccountGuid] <> D.[CustAccountGuid]

	insert into [TraceDetail]
	([ParentGuid],[Caption],[Old],[New])
	Select Top 1
		@Guid,
		'   ' as [Caption],
		D.[CommissionFromCustPercent] as [old],
		N.[CommissionFromCustPercent] as [New]
	From
		[deleted] d
		inner join [inserted] n on D.Guid = N.Guid
	where
		N.[CommissionFromCustPercent] <> D.[CommissionFromCustPercent]

	insert into [TraceDetail]
	([ParentGuid],[Caption],[Old],[New])
	Select Top 1
		@Guid,
		'   ' as [Caption],
		D.[CommissionFromCustValue] as [old],
		N.[CommissionFromCustValue] as [New]
	From
		[deleted] d
		inner join [inserted] n on D.Guid = N.Guid
	where
		N.[CommissionFromCustValue] <> D.[CommissionFromCustValue]

	insert into [TraceDetail]
	([ParentGuid],[Caption],[Old],[New],[Tbl])
	Select Top 1
		@Guid,
		'   ' as [Caption],
		D.[AcCommissionFromCustGuid] as [old],
		N.[AcCommissionFromCustGuid] as [New],
		'[Account]'
	From
		[deleted] d
		inner join [inserted] n on D.Guid = N.Guid
	where
		N.[AcCommissionFromCustGuid] <> D.[AcCommissionFromCustGuid]

	insert into [TraceDetail]
	([ParentGuid],[Caption],[Old],[New])
	Select Top 1
		@Guid,
		'    ' as [Caption],
		D.[AcCommissionFromCustNote] as [old],
		N.[AcCommissionFromCustNote] as [New]
	From
		[deleted] d
		inner join [inserted] n on D.Guid = N.Guid
	where
		N.[AcCommissionFromCustNote] <> D.[AcCommissionFromCustNote]

	insert into [TraceDetail]
	([ParentGuid],[Caption],[Old],[New])
	Select Top 1
		@Guid,
		'    ' as [Caption],
		D.[CommissionFromOwnerPercent] as [old],
		N.[CommissionFromOwnerPercent] as [New]
	From
		[deleted] d
		inner join [inserted] n on D.Guid = N.Guid
	where
		N.[CommissionFromOwnerPercent] <> D.[CommissionFromOwnerPercent]

	insert into [TraceDetail]
	([ParentGuid],[Caption],[Old],[New])
	Select Top 1
		@Guid,
		'    ' as [Caption],
		D.[CommissionFromOwnerValue] as [old],
		N.[CommissionFromOwnerValue] as [New]
	From
		[deleted] d
		inner join [inserted] n on D.Guid = N.Guid
	where
		N.[CommissionFromOwnerValue] <> D.[CommissionFromOwnerValue]

	insert into [TraceDetail]
	([ParentGuid],[Caption],[Old],[New],[Tbl])
	Select Top 1
		@Guid,
		'    ' as [Caption],
		D.[AcCommissionFromOwnerGuid] as [old],
		N.[AcCommissionFromOwnerGuid] as [New],
		'[Account]'
	From
		[deleted] d
		inner join [inserted] n on D.Guid = N.Guid
	where
		N.[AcCommissionFromOwnerGuid] <> D.[AcCommissionFromOwnerGuid]

	insert into [TraceDetail]
	([ParentGuid],[Caption],[Old],[New])
	Select Top 1
		@Guid,
		'     ' as [Caption],
		D.[AcCommissionFromOwnerNote] as [old],
		N.[AcCommissionFromOwnerNote] as [New]
	From
		[deleted] d
		inner join [inserted] n on D.Guid = N.Guid
	where
		N.[AcCommissionFromOwnerNote] <> D.[AcCommissionFromOwnerNote]

	insert into [TraceDetail]
	([ParentGuid],[Caption],[Old],[New])
	Select Top 1
		@Guid,
		' ' as [Caption],
		D.[CreateContractEntry] as [old],
		N.[CreateContractEntry] as [New]
	From
		[deleted] d
		inner join [inserted] n on D.Guid = N.Guid
	where
		N.[CreateContractEntry] <> D.[CreateContractEntry]

	insert into [TraceDetail]
	([ParentGuid],[Caption],[Old],[New])
	Select Top 1
		@Guid,
		' ' as [Caption],
		D.[ContractFinish] as [old],
		N.[ContractFinish] as [New]
	From
		[deleted] d
		inner join [inserted] n on D.Guid = N.Guid
	where
		N.[ContractFinish] <> D.[ContractFinish]

	insert into [TraceDetail]
	([ParentGuid],[Caption],[Old],[New])
	Select Top 1
		@Guid,
		' ' as [Caption],
		dbo.fnDate(D.[ContractFinishDate]) as [old],
		dbo.fnDate(N.[ContractFinishDate]) as [New]
	From
		[deleted] d
		inner join [inserted] n on D.Guid = N.Guid
	where
		N.[ContractFinishDate] <> D.[ContractFinishDate]

	insert into [TraceDetail]
	([ParentGuid],[Caption],[Old],[New])
	Select Top 1
		@Guid,
		'    / ' as [Caption],
		D.[ResultingAmount] as [old],
		N.[ResultingAmount] as [New]
	From
		[deleted] d
		inner join [inserted] n on D.Guid = N.Guid
	where
		N.[ResultingAmount] <> D.[ResultingAmount]

	insert into [TraceDetail]
	([ParentGuid],[Caption],[Old],[New])
	Select Top 1
		@Guid,
		'   ' as [Caption],
		D.[ResultingAmount2] as [old],
		N.[ResultingAmount2] as [New]
	From
		[deleted] d
		inner join [inserted] n on D.Guid = N.Guid
	where
		N.[ResultingAmount2] <> D.[ResultingAmount2]

	insert into [TraceDetail]
	([ParentGuid],[Caption],[Old],[New])
	Select Top 1
		@Guid,
		' ' as [Caption],
		D.[RoundKind] as [old],
		N.[RoundKind] as [New]
	From
		[deleted] d
		inner join [inserted] n on D.Guid = N.Guid
	where
		N.[RoundKind] <> D.[RoundKind]

	insert into [TraceDetail]
	([ParentGuid],[Caption],[Old],[New])
	Select Top 1
		@Guid,
		' ' as [Caption],
		D.[ResultingNote] as [old],
		N.[ResultingNote] as [New]
	From
		[deleted] d
		inner join [inserted] n on D.Guid = N.Guid
	where
		N.[ResultingNote] <> D.[ResultingNote]

	insert into [TraceDetail]
	([ParentGuid],[Caption],[Old],[New])
	Select Top 1
		@Guid,
		'' as [Caption],
		D.[Fine] as [old],
		N.[Fine] as [New]
	From
		[deleted] d
		inner join [inserted] n on D.Guid = N.Guid
	where
		N.[Fine] <> D.[Fine]

	insert into [TraceDetail]
	([ParentGuid],[Caption],[Old],[New],[Tbl])
	Select Top 1
		@Guid,
		'  ' as [Caption],
		D.[FineAccount] as [old],
		N.[FineAccount] as [New],
		'[Account]'
	From
		[deleted] d
		inner join [inserted] n on D.Guid = N.Guid
	where
		N.[FineAccount] <> D.[FineAccount]

	insert into [TraceDetail]
	([ParentGuid],[Caption],[Old],[New])
	Select Top 1
		@Guid,
		'  ' as [Caption],
		D.[CreateResultingEntry] as [old],
		N.[CreateResultingEntry] as [New]
	From
		[deleted] d
		inner join [inserted] n on D.Guid = N.Guid
	where
		N.[CreateResultingEntry] <> D.[CreateResultingEntry]

	insert into [TraceDetail]
	([ParentGuid],[Caption],[Old],[New])
	Select Top 1
		@Guid,
		' ' as [Caption],
		D.[FineNote] as [old],
		N.[FineNote] as [New]
	From
		[deleted] d
		inner join [inserted] n on D.Guid = N.Guid
	where
		N.[FineNote] <> D.[FineNote]

	insert into [TraceDetail]
	([ParentGuid],[Caption],[Old],[New])
	Select Top 1
		@Guid,
		'  ' as [Caption],
		D.[InsuranceValuePercent] as [old],
		N.[InsuranceValuePercent] as [New]
	From
		[deleted] d
		inner join [inserted] n on D.Guid = N.Guid
	where
		N.[InsuranceValuePercent] <> D.[InsuranceValuePercent]

	insert into [TraceDetail]
	([ParentGuid],[Caption],[Old],[New])
	Select Top 1
		@Guid,
		'  ' as [Caption],
		D.[InsuranceValue] as [old],
		N.[InsuranceValue] as [New]
	From
		[deleted] d
		inner join [inserted] n on D.Guid = N.Guid
	where
		N.[InsuranceValue] <> D.[InsuranceValue]

	insert into [TraceDetail]
	([ParentGuid],[Caption],[Old],[New])
	Select Top 1
		@Guid,
		'  ' as [Caption],
		D.[InsuranceValueOld] as [old],
		N.[InsuranceValueOld] as [New]
	From
		[deleted] d
		inner join [inserted] n on D.Guid = N.Guid
	where
		N.[InsuranceValueOld] <> D.[InsuranceValueOld]

	insert into [TraceDetail]
	([ParentGuid],[Caption],[Old],[New])
	Select Top 1
		@Guid,
		' ' as [Caption],
		D.[ContractPrice] as [old],
		N.[ContractPrice] as [New]
	From
		[deleted] d
		inner join [inserted] n on D.Guid = N.Guid
	where
		N.[ContractPrice] <> D.[ContractPrice]

	insert into [TraceDetail]
	([ParentGuid],[Caption],[Old],[New])
	Select Top 1
		@Guid,
		'   ' as [Caption],
		D.[AccountContractPrice] as [old],
		N.[AccountContractPrice] as [New]
	From
		[deleted] d
		inner join [inserted] n on D.Guid = N.Guid
	where
		N.[AccountContractPrice] <> D.[AccountContractPrice]

	insert into [TraceDetail]
	([ParentGuid],[Caption],[Old],[New])
	Select Top 1
		@Guid,
		' ' as [Caption],
		D.[CertificatValue] as [old],
		N.[CertificatValue] as [New]
	From
		[deleted] d
		inner join [inserted] n on D.Guid = N.Guid
	where
		N.[CertificatValue] <> D.[CertificatValue]

	insert into [TraceDetail]
	([ParentGuid],[Caption],[Old],[New])
	Select Top 1
		@Guid,
		'   ' as [Caption],
		D.[AccountCertificatValue] as [old],
		N.[AccountCertificatValue] as [New]
	From
		[deleted] d
		inner join [inserted] n on D.Guid = N.Guid
	where
		N.[AccountCertificatValue] <> D.[AccountCertificatValue]

	insert into [TraceDetail]
	([ParentGuid],[Caption],[Old],[New])
	Select Top 1
		@Guid,
		'  ' as [Caption],
		D.[RentDuration] as [old],
		N.[RentDuration] as [New]
	From
		[deleted] d
		inner join [inserted] n on D.Guid = N.Guid
	where
		N.[RentDuration] <> D.[RentDuration]

	insert into [TraceDetail]
	([ParentGuid],[Caption],[Old],[New])
	Select Top 1
		@Guid,
		'   / ' as [Caption],
		D.[Rentype] as [old],
		N.[Rentype] as [New]
	From
		[deleted] d
		inner join [inserted] n on D.Guid = N.Guid
	where
		N.[Rentype] <> D.[Rentype]

	insert into [TraceDetail]
	([ParentGuid],[Caption],[Old],[New])
	Select Top 1
		@Guid,
		'  ' as [Caption],
		D.[TermsOfPayment] as [old],
		N.[TermsOfPayment] as [New]
	From
		[deleted] d
		inner join [inserted] n on D.Guid = N.Guid
	where
		N.[TermsOfPayment] <> D.[TermsOfPayment]

	insert into [TraceDetail]
	([ParentGuid],[Caption],[Old],[New])
	Select Top 1
		@Guid,
		' ' as [Caption],
		D.[ResidentCount] as [old],
		N.[ResidentCount] as [New]
	From
		[deleted] d
		inner join [inserted] n on D.Guid = N.Guid
	where
		N.[ResidentCount] <> D.[ResidentCount]

	insert into [TraceDetail]
	([ParentGuid],[Caption],[Old],[New])
	Select Top 1
		@Guid,
		' ' as [Caption],
		D.[ElectricityInsurance] as [old],
		N.[ElectricityInsurance] as [New]
	From
		[deleted] d
		inner join [inserted] n on D.Guid = N.Guid
	where
		N.[ElectricityInsurance] <> D.[ElectricityInsurance]

	insert into [TraceDetail]
	([ParentGuid],[Caption],[Old],[New])
	Select Top 1
		@Guid,
		'    ' as [Caption],
		D.[Step1Complete] as [old],
		N.[Step1Complete] as [New]
	From
		[deleted] d
		inner join [inserted] n on D.Guid = N.Guid
	where
		N.[Step1Complete] <> D.[Step1Complete]

	insert into [TraceDetail]
	([ParentGuid],[Caption],[Old],[New])
	Select Top 1
		@Guid,
		'    ' as [Caption],
		D.[Step2Complete] as [old],
		N.[Step2Complete] as [New]
	From
		[deleted] d
		inner join [inserted] n on D.Guid = N.Guid
	where
		N.[Step2Complete] <> D.[Step2Complete]

	insert into [TraceDetail]
	([ParentGuid],[Caption],[Old],[New])
	Select Top 1
		@Guid,
		'    ' as [Caption],
		D.[Step3Complete] as [old],
		N.[Step3Complete] as [New]
	From
		[deleted] d
		inner join [inserted] n on D.Guid = N.Guid
	where
		N.[Step3Complete] <> D.[Step3Complete]

	insert into [TraceDetail]
	([ParentGuid],[Caption],[Old],[New])
	Select Top 1
		@Guid,
		'    ' as [Caption],
		D.[Step4Complete] as [old],
		N.[Step4Complete] as [New]
	From
		[deleted] d
		inner join [inserted] n on D.Guid = N.Guid
	where
		N.[Step4Complete] <> D.[Step4Complete]

	insert into [TraceDetail]
	([ParentGuid],[Caption],[Old],[New])
	Select Top 1
		@Guid,
		' ' as [Caption],
		D.[Certification] as [old],
		N.[Certification] as [New]
	From
		[deleted] d
		inner join [inserted] n on D.Guid = N.Guid
	where
		N.[Certification] <> D.[Certification]

	insert into [TraceDetail]
	([ParentGuid],[Caption],[Old],[New])
	Select Top 1
		@Guid,
		' ' as [Caption],
		D.[DiscountPercent] as [old],
		N.[DiscountPercent] as [New]
	From
		[deleted] d
		inner join [inserted] n on D.Guid = N.Guid
	where
		N.[DiscountPercent] <> D.[DiscountPercent]

	insert into [TraceDetail]
	([ParentGuid],[Caption],[Old],[New])
	Select Top 1
		@Guid,
		' ' as [Caption],
		D.[DiscountValue] as [old],
		N.[DiscountValue] as [New]
	From
		[deleted] d
		inner join [inserted] n on D.Guid = N.Guid
	where
		N.[DiscountValue] <> D.[DiscountValue]

	insert into [TraceDetail]
	([ParentGuid],[Caption],[Old],[New],[Tbl])
	Select Top 1
		@Guid,
		' ' as [Caption],
		D.[DiscountAccountGuid] as [old],
		N.[DiscountAccountGuid] as [New],
		'[Account]'
	From
		[deleted] d
		inner join [inserted] n on D.Guid = N.Guid
	where
		N.[DiscountAccountGuid] <> D.[DiscountAccountGuid]

	insert into [TraceDetail]
	([ParentGuid],[Caption],[Old],[New],[Tbl])
	Select Top 1
		@Guid,
		'' as [Caption],
		D.[UserGuid] as [old],
		N.[UserGuid] as [New],
		'[Realty_Users]'
	From
		[deleted] d
		inner join [inserted] n on D.Guid = N.Guid
	where
		N.[UserGuid] <> D.[UserGuid]

	insert into [TraceDetail]
	([ParentGuid],[Caption],[Old],[New],[Tbl])
	Select Top 1
		@Guid,
		'' as [Caption],
		D.[BranchGuid] as [old],
		N.[BranchGuid] as [New],
		'[Branch]'
	From
		[deleted] d
		inner join [inserted] n on D.Guid = N.Guid
	where
		N.[BranchGuid] <> D.[BranchGuid]

	insert into [TraceDetail]
	([ParentGuid],[Caption],[Old],[New])
	Select Top 1
		@Guid,
		'  ' as [Caption],
		D.[ElectricityCounter] as [old],
		N.[ElectricityCounter] as [New]
	From
		[deleted] d
		inner join [inserted] n on D.Guid = N.Guid
	where
		N.[ElectricityCounter] <> D.[ElectricityCounter]

	insert into [TraceDetail]
	([ParentGuid],[Caption],[Old],[New],[Tbl])
	Select Top 1
		@Guid,
		' ' as [Caption],
		D.[FineRevenueAccountGUID] as [old],
		N.[FineRevenueAccountGUID] as [New],
		'[Account]'
	From
		[deleted] d
		inner join [inserted] n on D.Guid = N.Guid
	where
		N.[FineRevenueAccountGUID] <> D.[FineRevenueAccountGUID]

	insert into [TraceDetail]
	([ParentGuid],[Caption],[Old],[New])
	Select Top 1
		@Guid,
		'' as [Caption],
		D.[NewState] as [old],
		N.[NewState] as [New]
	From
		[deleted] d
		inner join [inserted] n on D.Guid = N.Guid
	where
		N.[NewState] <> D.[NewState]

	insert into [TraceDetail]
	([ParentGuid],[Caption],[Old],[New])
	Select Top 1
		@Guid,
		' ' as [Caption],
		D.[OtherFee] as [old],
		N.[OtherFee] as [New]
	From
		[deleted] d
		inner join [inserted] n on D.Guid = N.Guid
	where
		N.[OtherFee] <> D.[OtherFee]

	insert into [TraceDetail]
	([ParentGuid],[Caption],[Old],[New],[Tbl])
	Select Top 1
		@Guid,
		'  ' as [Caption],
		D.[OtherFeeAccountGUID] as [old],
		N.[OtherFeeAccountGUID] as [New],
		'Account'
	From
		[deleted] d
		inner join [inserted] n on D.Guid = N.Guid
	where
		N.[OtherFeeAccountGUID] <> D.[OtherFeeAccountGUID]

	insert into [TraceDetail]
	([ParentGuid],[Caption],[Old],[New])
	Select Top 1
		@Guid,
		'  ' as [Caption],
		D.[License1No] as [old],
		N.[License1No] as [New]
	From
		[deleted] d
		inner join [inserted] n on D.Guid = N.Guid
	where
		N.[License1No] <> D.[License1No]

	insert into [TraceDetail]
	([ParentGuid],[Caption],[Old],[New])
	Select Top 1
		@Guid,
		' ' as [Caption],
		D.[License2No] as [old],
		N.[License2No] as [New]
	From
		[deleted] d
		inner join [inserted] n on D.Guid = N.Guid
	where
		N.[License2No] <> D.[License2No]

	insert into [TraceDetail]
	([ParentGuid],[Caption],[Old],[New])
	Select Top 1
		@Guid,
		'   ' as [Caption],
		D.[License3No] as [old],
		N.[License3No] as [New]
	From
		[deleted] d
		inner join [inserted] n on D.Guid = N.Guid
	where
		N.[License3No] <> D.[License3No]

	insert into [TraceDetail]
	([ParentGuid],[Caption],[Old],[New])
	Select Top 1
		@Guid,
		dbo.SC('License1Date1') as [Caption],
		dbo.fnDate(D.[License1Date1]) as [old],
		dbo.fnDate(N.[License1Date1]) as [New]
	From
		[deleted] d
		inner join [inserted] n on D.Guid = N.Guid
	where
		N.[License1Date1] <> D.[License1Date1]

	insert into [TraceDetail]
	([ParentGuid],[Caption],[Old],[New])
	Select Top 1
		@Guid,
		dbo.SC('License2Date1') as [Caption],
		dbo.fnDate(D.[License2Date1]) as [old],
		dbo.fnDate(N.[License2Date1]) as [New]
	From
		[deleted] d
		inner join [inserted] n on D.Guid = N.Guid
	where
		N.[License2Date1] <> D.[License2Date1]

	insert into [TraceDetail]
	([ParentGuid],[Caption],[Old],[New])
	Select Top 1
		@Guid,
		dbo.SC('License3Date1') as [Caption],
		dbo.fnDate(D.[License3Date1]) as [old],
		dbo.fnDate(N.[License3Date1]) as [New]
	From
		[deleted] d
		inner join [inserted] n on D.Guid = N.Guid
	where
		N.[License3Date1] <> D.[License3Date1]

	insert into [TraceDetail]
	([ParentGuid],[Caption],[Old],[New])
	Select Top 1
		@Guid,
		dbo.SC('License1Date2') as [Caption],
		dbo.fnDate(D.[License1Date2]) as [old],
		dbo.fnDate(N.[License1Date2]) as [New]
	From
		[deleted] d
		inner join [inserted] n on D.Guid = N.Guid
	where
		N.[License1Date2] <> D.[License1Date2]

	insert into [TraceDetail]
	([ParentGuid],[Caption],[Old],[New])
	Select Top 1
		@Guid,
		dbo.SC('License2Date2') as [Caption],
		dbo.fnDate(D.[License2Date2]) as [old],
		dbo.fnDate(N.[License2Date2]) as [New]
	From
		[deleted] d
		inner join [inserted] n on D.Guid = N.Guid
	where
		N.[License2Date2] <> D.[License2Date2]

	insert into [TraceDetail]
	([ParentGuid],[Caption],[Old],[New])
	Select Top 1
		@Guid,
		dbo.SC('License3Date2') as [Caption],
		dbo.fnDate(D.[License3Date2]) as [old],
		dbo.fnDate(N.[License3Date2]) as [New]
	From
		[deleted] d
		inner join [inserted] n on D.Guid = N.Guid
	where
		N.[License3Date2] <> D.[License3Date2]

	insert into [TraceDetail]
	([ParentGuid],[Caption],[Old],[New])
	Select Top 1
		@Guid,
		'  ' as [Caption],
		D.[Ltnwhereabouts] as [old],
		N.[Ltnwhereabouts] as [New]
	From
		[deleted] d
		inner join [inserted] n on D.Guid = N.Guid
	where
		N.[Ltnwhereabouts] <> D.[Ltnwhereabouts]

	insert into [TraceDetail]
	([ParentGuid],[Caption],[Old],[New])
	Select Top 1
		@Guid,
		'   ' as [Caption],
		D.[LtnPurpose] as [old],
		N.[LtnPurpose] as [New]
	From
		[deleted] d
		inner join [inserted] n on D.Guid = N.Guid
	where
		N.[LtnPurpose] <> D.[LtnPurpose]

	insert into [TraceDetail]
	([ParentGuid],[Caption],[Old],[New])
	Select Top 1
		@Guid,
		'   ' as [Caption],
		D.[LtnRentDuration] as [old],
		N.[LtnRentDuration] as [New]
	From
		[deleted] d
		inner join [inserted] n on D.Guid = N.Guid
	where
		N.[LtnRentDuration] <> D.[LtnRentDuration]

	insert into [TraceDetail]
	([ParentGuid],[Caption],[Old],[New])
	Select Top 1
		@Guid,
		'   /  ' as [Caption],
		D.[LtnRentype] as [old],
		N.[LtnRentype] as [New]
	From
		[deleted] d
		inner join [inserted] n on D.Guid = N.Guid
	where
		N.[LtnRentype] <> D.[LtnRentype]

	insert into [TraceDetail]
	([ParentGuid],[Caption],[Old],[New])
	Select Top 1
		@Guid,
		'   ' as [Caption],
		D.[LtnTermsOfPayment] as [old],
		N.[LtnTermsOfPayment] as [New]
	From
		[deleted] d
		inner join [inserted] n on D.Guid = N.Guid
	where
		N.[LtnTermsOfPayment] <> D.[LtnTermsOfPayment]

	insert into [TraceDetail]
	([ParentGuid],[Caption],[Old],[New])
	Select Top 1
		@Guid,
		' ' as [Caption],
		D.[IsRounded] as [old],
		N.[IsRounded] as [New]
	From
		[deleted] d
		inner join [inserted] n on D.Guid = N.Guid
	where
		N.[IsRounded] <> D.[IsRounded]

	insert into [TraceDetail]
	([ParentGuid],[Caption],[Old],[New])
	Select Top 1
		@Guid,
		' ' as [Caption],
		D.[Leave] as [old],
		N.[Leave] as [New]
	From
		[deleted] d
		inner join [inserted] n on D.Guid = N.Guid
	where
		N.[Leave] <> D.[Leave]

	insert into [TraceDetail]
	([ParentGuid],[Caption],[Old],[New])
	Select Top 1
		@Guid,
		' ' as [Caption],
		dbo.fnDate(D.[LeaveDate]) as [old],
		dbo.fnDate(N.[LeaveDate]) as [New]
	From
		[deleted] d
		inner join [inserted] n on D.Guid = N.Guid
	where
		N.[LeaveDate] <> D.[LeaveDate]

	insert into [TraceDetail]
	([ParentGuid],[Caption],[Old],[New])
	Select Top 1
		@Guid,
		'      ' as [Caption],
		D.[Step5Complete] as [old],
		N.[Step5Complete] as [New]
	From
		[deleted] d
		inner join [inserted] n on D.Guid = N.Guid
	where
		N.[Step5Complete] <> D.[Step5Complete]

	insert into [TraceDetail]
	([ParentGuid],[Caption],[Old],[New])
	Select Top 1
		@Guid,
		'  ' as [Caption],
		D.[CountOldContract] as [old],
		N.[CountOldContract] as [New]
	From
		[deleted] d
		inner join [inserted] n on D.Guid = N.Guid
	where
		N.[CountOldContract] <> D.[CountOldContract]

	insert into [TraceDetail]
	([ParentGuid],[Caption],[Old],[New],[Tbl])
	Select Top 1
		@Guid,
		' ' as [Caption],
		D.[InsuranceAccountGuid] as [old],
		N.[InsuranceAccountGuid] as [New],
		'Account'
	From
		[deleted] d
		inner join [inserted] n on D.Guid = N.Guid
	where
		N.[InsuranceAccountGuid] <> D.[InsuranceAccountGuid]

	insert into [TraceDetail]
	([ParentGuid],[Caption],[Old],[New])
	Select Top 1
		@Guid,
		'   ' as [Caption],
		D.[AcquittancePrinted] as [old],
		N.[AcquittancePrinted] as [New]
	From
		[deleted] d
		inner join [inserted] n on D.Guid = N.Guid
	where
		N.[AcquittancePrinted] <> D.[AcquittancePrinted]

	insert into [TraceDetail]
	([ParentGuid],[Caption],[Old],[New])
	Select Top 1
		@Guid,
		'' as [Caption],
		D.[Judicial] as [old],
		N.[Judicial] as [New]
	From
		[deleted] d
		inner join [inserted] n on D.Guid = N.Guid
	where
		N.[Judicial] <> D.[Judicial]

	insert into [TraceDetail]
	([ParentGuid],[Caption],[Old],[New])
	Select Top 1
		@Guid,
		'   ' as [Caption],
		dbo.fnDate(D.[AcquittancePrintDate]) as [old],
		dbo.fnDate(N.[AcquittancePrintDate]) as [New]
	From
		[deleted] d
		inner join [inserted] n on D.Guid = N.Guid
	where
		N.[AcquittancePrintDate] <> D.[AcquittancePrintDate]


	insert into [TraceDetail]
	([ParentGuid],[Caption],[Old],[New])
	Select Top 1
		@Guid,
		'   ' as [Caption],
		D.[AddValue] as [old],
		N.[AddValue] as [New]
	From
		[deleted] d
		inner join [inserted] n on D.Guid = N.Guid
	where
		N.[AddValue] <> D.[AddValue]

	
	delete Trace From Trace t left join [TraceDetail] D on T.guid = D.ParentGuid
	where
		d.ParentGuid is Null and t.Guid = @Guid
		

GO

SET ANSI_NULLS, QUOTED_IDENTIFIER ON
GO

Create Procedure [PrcBuildingIdentityCreateAccounts]
(
	@Guid uniqueidentifier = '696C763B-9272-49AB-BB72-41BB43E1B063'
)
 
as

	Declare @ParentRentAccountGuid uniqueidentifier,
			@ParentRentInsuranceAccountGuid uniqueidentifier
			--  
			,@RevenueRentAccountFlatGuid uniqueidentifier

	Select @RevenueRentAccountFlatGuid = [Value] From [DMD_Const] where [VName] = 'RevenueRentAccountFlat'

	if (isnull(@RevenueRentAccountFlatGuid , 0x0) = 0x0)
	BEGIN
	   RAISERROR ('         ', 16, 1)
	   ROLLBACK TRANSACTION
	END
	
	
	Select
		@ParentRentAccountGuid = [ParentRentAccountGuid],
		@ParentRentInsuranceAccountGuid = [ParentRentInsuranceAccountGuid]
	From 
		[Building]
	where
		[Guid] = @Guid


	DECLARE @RentName Varchar(256)
			,@Mobile  Varchar(256)
			,@ContractNo Varchar(256)
			,@FlatGuid uniqueidentifier
			,@Code Varchar(256)
			,@CurrencyGUID uniqueidentifier
			,@CurrencyVal Float
			,@Type int
			,@FinalGUID uniqueidentifier
			,@RentAccountGUID uniqueidentifier
			,@InsuranceAccountGUID uniqueidentifier
			,@RentContractGuid uniqueidentifier
			,@CustomerGuid uniqueidentifier
		
			,@Count Int

	--          
	Create Table #TmAccountName
	(
		[RentName] Varchar(256)
	)

	DECLARE cursor_Name CURSOR FAST_FORWARD FOR 
	Select Distinct
		[RentName],[Mobile],[ContractNo],[FlatGuid]
	From 
		[BuildingIdentityDetail] [D]
	where
		[BuildingGuid] = @Guid
	
	OPEN cursor_Name
	FETCH NEXT FROM cursor_Name INTO @RentName, @Mobile, @ContractNo, @FlatGuid
	
	Set @Count = 0
	WHILE @@FETCH_STATUS = 0
	BEGIN
		--  
		Set @RentAccountGUID = Newid()
		Set @InsuranceAccountGUID = Newid()

		Set @Count = @Count + 1
		
		-- Rent Account

		--   		
		Select 
			@Code = [Code]				
			,@CurrencyGUID = [CurrencyGUID]
			,@CurrencyVal = [CurrencyVal]
			,@Type = [Type]
			,@FinalGUID = [FinalGUID]
		from 
			[Account] where [Guid] = @ParentRentAccountGuid

		if (not exists(Select Top 1 * from #TmAccountName where [RentName] = @RentName)) 
			and (not exists(Select Top 1 * from [vwCustomer] where [Name] = @RentName))
		begin
				insert into [Account]
				([Number],[Guid],[Name],[LtnName],[Code],[CDate],[NSons],[Note],[CurrencyGUID],[CurrencyVal],[Type],[ParentGUID],[FinalGUID])
				Select
				(Select isnull(Max([Number]),0)+ 1 from [Account]) as [Number]
				,@RentAccountGUID as [Guid]
				,@RentName as [Name]
				,'' as [LtnName]
				,@Code + dbo.FnFormatNumber (@Count, 4) as [Code]
				,GetDate() as [CDate]
				,0 as [NSons]
				,'' as [Note]
				,@CurrencyGUID as [CurrencyGUID]
				,@CurrencyVal as [CurrencyVal]
				,@Type as [Type]
				,@ParentRentAccountGuid as [ParentGUID]
				,@FinalGUID as [FinalGUID]
			  
				-- Insurance Account
				Select 
					@Code = [Code]				
					,@CurrencyGUID = [CurrencyGUID]
					,@CurrencyVal = [CurrencyVal]
					,@Type = [Type]
					,@FinalGUID = [FinalGUID]
				from 
					[Account] where [Guid] = @ParentRentInsuranceAccountGuid
		
				insert into [Account]
				([Number],[Guid],[Name],[LtnName],[Code],[CDate],[NSons],[Note],[CurrencyGUID],[CurrencyVal],[Type],[ParentGUID],[FinalGUID])
				Select
				(Select isnull(Max([Number]),0)+ 1 from [Account]) as [Number]
				,@InsuranceAccountGUID as [Guid]
				,@RentName as [Name]
				,'' as [LtnName]
				,@Code + dbo.FnFormatNumber (@Count, 4) as [Code]
				,GetDate() as [CDate]
				,0 as [NSons]
				,'' as [Note]
				,@CurrencyGUID as [CurrencyGUID]
				,@CurrencyVal as [CurrencyVal]
				,@Type as [Type]
				,@ParentRentInsuranceAccountGuid as [ParentGUID]
				,@FinalGUID as [FinalGUID]
		
				-- Customer
				Set @CustomerGuid = Newid()
		
				insert into [Customer]
				([Number],[Guid],[Name],[LtnName],[Nationality],[Profession],[PassportNO],[Domicile],[Security],[PhoneJob],[Mobile],[Note],[AcGuid],[InsuranceAccountGuid])
				Select
				(Select isnull(Max([Number]),0)+ 1 from [Customer]) as [Number]
				,@CustomerGuid as [Guid]
				,@RentName as [Name]
				,'' as [LtnName]
				,'' as [Nationality]
				,'' as [Profession]
				,'' as [PassportNO]
				,'' as [Domicile]
				,'' as [Security]
				,'' as [PhoneJob]
				,@Mobile as [Mobile]
				,'' as [Note]
				,@RentAccountGUID as [AcGuid]
				,@InsuranceAccountGUID as [InsuranceAccountGuid]

				insert into #TmAccountName
				Select @RentName
		end
		else
		begin
			Set @CustomerGuid = (Select Top 1 [Guid] From [Customer] where [Name] = @RentName)
			Set @RentAccountGUID = (Select Top 1 [AcGuid] From [Customer] where [Guid] = @CustomerGuid)
			Set @InsuranceAccountGUID = (Select Top 1 [InsuranceAccountGuid] From [Customer] where [Guid] = @CustomerGuid)
		end


		-- Rent Contract
		Set @RentContractGuid = Newid()
		

		Print 'Contract'
		--      
		if (not exists(Select Top 1 * from [LeaseApartment] where [ApartmentGuid] = @FlatGuid and [CustomerGuid] = @CustomerGuid and [LeaseKind] = 0)) 
		insert into [LeaseApartment]
		([Number],[Guid],[ContractNo],[CustomerGuid],[BuildingGuid],[ApartmentGuid],[ApartmentType],[FromDate],[ToDate],[Rent],[CurrencyGuid],[CurrencyVal],[PayType],[Note],[Purpose],[LeaseKind],[RevenueAccountGuid],[CustAccountGuid],[CommissionFromCustPercent],[CommissionFromCustValue],[AcCommissionFromCustGuid],[CommissionFromOwnerPercent],[CommissionFromOwnerValue],[AcCommissionFromOwnerGuid])
		Select
		(Select isnull(Max([Number]),0)+ 1 from [LeaseApartment]) as [Number]
		,@RentContractGuid as [Guid]
		,@ContractNo
		,@CustomerGuid as [CustomerGuid]
		,@Guid as [BuildingGuid]
		,@FlatGuid as [ApartmentGuid]
		,'' as [ApartmentType]
		,(Select Top 1 [BeginContractDate] From [BuildingIdentityDetail] where [FlatGuid] = @FlatGuid and [RentName] = @RentName) as [FromDate]
		,(Select Top 1 [EndContractDate] From [BuildingIdentityDetail] where [FlatGuid] = @FlatGuid and [RentName] = @RentName) as [ToDate]
		,(Select Top 1 [ContractValue] From [BuildingIdentityDetail] where [FlatGuid] = @FlatGuid and [RentName] = @RentName) as [Rent]
		,(Select Top 1 [CurrencyGuid] From [BuildingIdentity] where [BuildingGuid] = @Guid) as [CurrencyGuid]
		,(Select Top 1 [CurrencyVal] From [Currency] where [Guid] = (Select Top 1 [CurrencyGuid] From [BuildingIdentity] where [BuildingGuid] = @Guid)) as [CurrencyVal]
		,3 as [PayType]
		,'' as [Note]
		,''as [Purpose]
		,0 as [LeaseKind]
		,@RevenueRentAccountFlatGuid as [RevenueAccountGuid]
		,@RentAccountGUID as [CustAccountGuid]
		,0 as [CommissionFromCustPercent]
		,0 as [CommissionFromCustValue]
		,Null as [AcCommissionFromCustGuid]
		,0 as [CommissionFromOwnerPercent]
		,0 as [CommissionFromOwnerValue]
		,Null as [AcCommissionFromOwnerGuid]
		
	  	FETCH NEXT FROM cursor_Name INTO @RentName, @Mobile, @ContractNo, @FlatGuid
	
	END
	
	CLOSE cursor_Name
	DEALLOCATE cursor_Name


GO

SET ANSI_NULLS, QUOTED_IDENTIFIER ON
GO

Create Trigger [TRG_Trace_Mat]
on [Mat]
 
for update
As
	SET NOCOUNT ON;
	if Not exists(Select Value from DMD_const where vName = 'ActiveLogCardUpdate' and Value = '1' ) return
	
	Declare @UserGuid uniqueidentifier, @Guid uniqueidentifier
	Set @Guid = NEWID()
	
	Select Top 1 @UserGuid = userGuid From CurrentUsers where Spid = @@SPID
			
	insert into [Trace]
	([Guid],[ParentGuid],[Date],[userGuid],[HostName],[ParentTbl]) 
	Select Top 1
		@Guid,
		N.Guid,
		GETDATE(),
		@UserGuid,
		Host_Name(),
		'Mat'
	From
		[inserted] n 
		
	insert into [TraceDetail]
	([ParentGuid],[Caption],[Old],[New],[Tbl])
	Select Top 1
		@Guid,
		' ' as [Caption],
		D.[SecLvl] as [old],
		N.[SecLvl] as [New],
		''
	From
		[deleted] d
		inner join [inserted] n on D.Guid = N.Guid
	where
		N.[SecLvl] <> D.[SecLvl]
		
	insert into [TraceDetail]
	([ParentGuid],[Caption],[Old],[New],[Tbl])
	Select Top 1
		@Guid,
		'' as [Caption],
		D.[Code] as [old],
		N.[Code] as [New],
		''
	From
		[deleted] d
		inner join [inserted] n on D.Guid = N.Guid
	where
		N.[Code] <> D.[Code]
		
	insert into [TraceDetail]
	([ParentGuid],[Caption],[Old],[New],[Tbl])
	Select Top 1
		@Guid,
		'' as [Caption],
		D.[Name] as [old],
		N.[Name] as [New],
		''
	From
		[deleted] d
		inner join [inserted] n on D.Guid = N.Guid
	where
		N.[Name] <> D.[Name]
		
	insert into [TraceDetail]
	([ParentGuid],[Caption],[Old],[New],[Tbl])
	Select Top 1
		@Guid,
		' ' as [Caption],
		D.[LtnName] as [old],
		N.[LtnName] as [New],
		''
	From
		[deleted] d
		inner join [inserted] n on D.Guid = N.Guid
	where
		N.[LtnName] <> D.[LtnName]
		
	insert into [TraceDetail]
	([ParentGuid],[Caption],[Old],[New],[Tbl])
	Select Top 1
		@Guid,
		' ' as [Caption],
		D.[Unity1] as [old],
		N.[Unity1] as [New],
		''
	From
		[deleted] d
		inner join [inserted] n on D.Guid = N.Guid
	where
		N.[Unity1] <> D.[Unity1]
		
	insert into [TraceDetail]
	([ParentGuid],[Caption],[Old],[New],[Tbl])
	Select Top 1
		@Guid,
		' ' as [Caption],
		D.[Unity2] as [old],
		N.[Unity2] as [New],
		''
	From
		[deleted] d
		inner join [inserted] n on D.Guid = N.Guid
	where
		N.[Unity2] <> D.[Unity2]
		
	insert into [TraceDetail]
	([ParentGuid],[Caption],[Old],[New],[Tbl])
	Select Top 1
		@Guid,
		' ' as [Caption],
		D.[Unity3] as [old],
		N.[Unity3] as [New],
		''
	From
		[deleted] d
		inner join [inserted] n on D.Guid = N.Guid
	where
		N.[Unity3] <> D.[Unity3]
		
	insert into [TraceDetail]
	([ParentGuid],[Caption],[Old],[New],[Tbl])
	Select Top 1
		@Guid,
		' ' as [Caption],
		D.[Barcode1] as [old],
		N.[Barcode1] as [New],
		''
	From
		[deleted] d
		inner join [inserted] n on D.Guid = N.Guid
	where
		N.[Barcode1] <> D.[Barcode1]
		
	insert into [TraceDetail]
	([ParentGuid],[Caption],[Old],[New],[Tbl])
	Select Top 1
		@Guid,
		' ' as [Caption],
		D.[Barcode2] as [old],
		N.[Barcode2] as [New],
		''
	From
		[deleted] d
		inner join [inserted] n on D.Guid = N.Guid
	where
		N.[Barcode2] <> D.[Barcode2]
		
	insert into [TraceDetail]
	([ParentGuid],[Caption],[Old],[New],[Tbl])
	Select Top 1
		@Guid,
		' ' as [Caption],
		D.[Barcode3] as [old],
		N.[Barcode3] as [New],
		''
	From
		[deleted] d
		inner join [inserted] n on D.Guid = N.Guid
	where
		N.[Barcode3] <> D.[Barcode3]
		
	insert into [TraceDetail]
	([ParentGuid],[Caption],[Old],[New],[Tbl])
	Select Top 1
		@Guid,
		'' as [Caption],
		D.[DefUnity] as [old],
		N.[DefUnity] as [New],
		''
	From
		[deleted] d
		inner join [inserted] n on D.Guid = N.Guid
	where
		N.[DefUnity] <> D.[DefUnity]
		
	insert into [TraceDetail]
	([ParentGuid],[Caption],[Old],[New],[Tbl])
	Select Top 1
		@Guid,
		' ' as [Caption],
		D.[unityFact2] as [old],
		N.[unityFact2] as [New],
		''
	From
		[deleted] d
		inner join [inserted] n on D.Guid = N.Guid
	where
		N.[unityFact2] <> D.[unityFact2]
		
	insert into [TraceDetail]
	([ParentGuid],[Caption],[Old],[New],[Tbl])
	Select Top 1
		@Guid,
		' ' as [Caption],
		D.[unityFact3] as [old],
		N.[unityFact3] as [New],
		''
	From
		[deleted] d
		inner join [inserted] n on D.Guid = N.Guid
	where
		N.[unityFact3] <> D.[unityFact3]
		
	insert into [TraceDetail]
	([ParentGuid],[Caption],[Old],[New],[Tbl])
	Select Top 1
		@Guid,
		'' as [Caption],
		D.[unityfix2] as [old],
		N.[unityfix2] as [New],
		''
	From
		[deleted] d
		inner join [inserted] n on D.Guid = N.Guid
	where
		N.[unityfix2] <> D.[unityfix2]
		
	insert into [TraceDetail]
	([ParentGuid],[Caption],[Old],[New],[Tbl])
	Select Top 1
		@Guid,
		'' as [Caption],
		D.[unityfix3] as [old],
		N.[unityfix3] as [New],
		''
	From
		[deleted] d
		inner join [inserted] n on D.Guid = N.Guid
	where
		N.[unityfix3] <> D.[unityfix3]
		
	insert into [TraceDetail]
	([ParentGuid],[Caption],[Old],[New],[Tbl])
	Select Top 1
		@Guid,
		'' as [Caption],
		D.[Note] as [old],
		N.[Note] as [New],
		''
	From
		[deleted] d
		inner join [inserted] n on D.Guid = N.Guid
	where
		N.[Note] <> D.[Note]
		
	insert into [TraceDetail]
	([ParentGuid],[Caption],[Old],[New],[Tbl])
	Select Top 1
		@Guid,
		' ' as [Caption],
		D.[GroupGuid] as [old],
		N.[GroupGuid] as [New],
		'MatGroup'
	From
		[deleted] d
		inner join [inserted] n on D.Guid = N.Guid
	where
		N.[GroupGuid] <> D.[GroupGuid]
		
	insert into [TraceDetail]
	([ParentGuid],[Caption],[Old],[New],[Tbl])
	Select Top 1
		@Guid,
		' ' as [Caption],
		D.[MatType] as [old],
		N.[MatType] as [New],
		''
	From
		[deleted] d
		inner join [inserted] n on D.Guid = N.Guid
	where
		N.[MatType] <> D.[MatType]
		
	insert into [TraceDetail]
	([ParentGuid],[Caption],[Old],[New],[Tbl])
	Select Top 1
		@Guid,
		'' as [Caption],
		D.[CurrencyGuid] as [old],
		N.[CurrencyGuid] as [New],
		'vwCurrency'
	From
		[deleted] d
		inner join [inserted] n on D.Guid = N.Guid
	where
		N.[CurrencyGuid] <> D.[CurrencyGuid]
		
	insert into [TraceDetail]
	([ParentGuid],[Caption],[Old],[New],[Tbl])
	Select Top 1
		@Guid,
		'' as [Caption],
		D.[CurrencyVal] as [old],
		N.[CurrencyVal] as [New],
		''
	From
		[deleted] d
		inner join [inserted] n on D.Guid = N.Guid
	where
		N.[CurrencyVal] <> D.[CurrencyVal]
		
	insert into [TraceDetail]
	([ParentGuid],[Caption],[Old],[New],[Tbl])
	Select Top 1
		@Guid,
		' ' as [Caption],
		D.[AvgPrice] as [old],
		N.[AvgPrice] as [New],
		''
	From
		[deleted] d
		inner join [inserted] n on D.Guid = N.Guid
	where
		N.[AvgPrice] <> D.[AvgPrice]
		
	insert into [TraceDetail]
	([ParentGuid],[Caption],[Old],[New],[Tbl])
	Select Top 1
		@Guid,
		'  ' as [Caption],
		dbo.fnDate(D.[LastPriceDate]) as [old],
		dbo.fnDate(N.[LastPriceDate]) as [New],
		''
	From
		[deleted] d
		inner join [inserted] n on D.Guid = N.Guid
	where
		N.[LastPriceDate] <> D.[LastPriceDate]
		
	insert into [TraceDetail]
	([ParentGuid],[Caption],[Old],[New],[Tbl])
	Select Top 1
		@Guid,
		' ' as [Caption],
		D.[LastPrice] as [old],
		N.[LastPrice] as [New],
		''
	From
		[deleted] d
		inner join [inserted] n on D.Guid = N.Guid
	where
		N.[LastPrice] <> D.[LastPrice]
		
	insert into [TraceDetail]
	([ParentGuid],[Caption],[Old],[New],[Tbl])
	Select Top 1
		@Guid,
		' ' as [Caption],
		D.[MaxPrice] as [old],
		N.[MaxPrice] as [New],
		''
	From
		[deleted] d
		inner join [inserted] n on D.Guid = N.Guid
	where
		N.[MaxPrice] <> D.[MaxPrice]
		
	delete Trace From Trace t left join [TraceDetail] D on T.guid = D.ParentGuid
	where
		d.ParentGuid is Null and t.Guid = @Guid


GO

SET ANSI_NULLS, QUOTED_IDENTIFIER ON
GO

Create Trigger [TRG_Trace_HEntry]
on [HEntry]
 
for update
As
	SET NOCOUNT ON;
	if Not exists(Select Value from DMD_const where vName = 'ActiveLogCardUpdate' and Value = '1' ) return
	
	Declare @UserGuid uniqueidentifier, @Guid uniqueidentifier
	Set @Guid = NEWID()
	
	Select Top 1 @UserGuid = userGuid From CurrentUsers where Spid = @@SPID
			
	insert into [Trace]
	([Guid],[ParentGuid],[Date],[userGuid],[HostName],[ParentTbl])
	Select Top 1
		@Guid,
		N.Guid,
		GETDATE(),
		@UserGuid,
		Host_Name(),
		'HEntry'
	From
		[inserted] n 
		
		
	insert into [TraceDetail]
	([ParentGuid],[Caption],[Old],[New],[Tbl])
	Select  Top 1
		@Guid,
		' ' as [Caption],
		D.[SecLvl] as [old],
		N.[SecLvl] as [New],
		''
	From
		[deleted] d
		inner join [inserted] n on D.Guid = N.Guid
	where
		N.[SecLvl] <> D.[SecLvl]
		
	insert into [TraceDetail]
	([ParentGuid],[Caption],[Old],[New],[Tbl])
	Select  Top 1
		@Guid,
		'' as [Caption],
		dbo.fndate(D.[Date]) as [old],
		dbo.fndate(N.[Date]) as [New],
		''
	From
		[deleted] d
		inner join [inserted] n on D.Guid = N.Guid
	where
		N.[Date] <> D.[Date]
		
	insert into [TraceDetail]
	([ParentGuid],[Caption],[Old],[New],[Tbl])
	Select  Top 1
		@Guid,
		'' as [Caption],
		D.[CurrencyGuid] as [old],
		N.[CurrencyGuid] as [New],
		'Currency'
	From
		[deleted] d
		inner join [inserted] n on D.Guid = N.Guid
	where
		N.[CurrencyGuid] <> D.[CurrencyGuid]
		
	insert into [TraceDetail]
	([ParentGuid],[Caption],[Old],[New],[Tbl])
	Select  Top 1
		@Guid,
		' ' as [Caption],
		D.[CurrencyVal] as [old],
		N.[CurrencyVal] as [New],
		''
	From
		[deleted] d
		inner join [inserted] n on D.Guid = N.Guid
	where
		N.[CurrencyVal] <> D.[CurrencyVal]
		
	insert into [TraceDetail]
	([ParentGuid],[Caption],[Old],[New],[Tbl])
	Select  Top 1
		@Guid,
		'' as [Caption],
		D.[Note] as [old],
		N.[Note] as [New],
		''
	From
		[deleted] d
		inner join [inserted] n on D.Guid = N.Guid
	where
		N.[Note] <> D.[Note]
		
	insert into [TraceDetail]
	([ParentGuid],[Caption],[Old],[New],[Tbl])
	Select  Top 1
		@Guid,
		'' as [Caption],
		D.[ParentKind] as [old],
		N.[ParentKind] as [New],
		''
	From
		[deleted] d
		inner join [inserted] n on D.Guid = N.Guid
	where
		N.[ParentKind] <> D.[ParentKind]
		
	insert into [TraceDetail]
	([ParentGuid],[Caption],[Old],[New],[Tbl])
	Select  Top 1
		@Guid,
		'' as [Caption],
		D.[UserGuid] as [old],
		N.[UserGuid] as [New],
		'[Realty_Users]'
	From
		[deleted] d
		inner join [inserted] n on D.Guid = N.Guid
	where
		N.[UserGuid] <> D.[UserGuid]
		
	insert into [TraceDetail]
	([ParentGuid],[Caption],[Old],[New],[Tbl])
	Select  Top 1
		@Guid,
		'' as [Caption],
		D.[BranchGuid] as [old],
		N.[BranchGuid] as [New],
		'Branch'
	From
		[deleted] d
		inner join [inserted] n on D.Guid = N.Guid
	where
		N.[BranchGuid] <> D.[BranchGuid]
		
	insert into [TraceDetail]
	([ParentGuid],[Caption],[Old],[New],[Tbl])
	Select  Top 1
		@Guid,
		'' as [Caption],
		D.[IsPosted] as [old],
		N.[IsPosted] as [New],
		''
	From
		[deleted] d
		inner join [inserted] n on D.Guid = N.Guid
	where
		N.[IsPosted] <> D.[IsPosted]
		
	insert into [TraceDetail]
	([ParentGuid],[Caption],[Old],[New],[Tbl])
	Select  Top 1
		@Guid,
		' ' as [Caption],
		D.[Debit] as [old],
		N.[Debit] as [New],
		''
	From
		[deleted] d
		inner join [inserted] n on D.Guid = N.Guid
	where
		N.[Debit] <> D.[Debit]

	insert into [TraceDetail]
	([ParentGuid],[Caption],[Old],[New],[Tbl])
	Select  Top 1
		@Guid,
		' ' as [Caption],
		D.[Credit] as [old],
		N.[Credit] as [New],
		''
	From
		[deleted] d
		inner join [inserted] n on D.Guid = N.Guid
	where
		N.[Credit] <> D.[Credit]
		
	insert into [TraceDetail]
	([ParentGuid],[Caption],[Old],[New],[Tbl])
	Select  Top 1
		@Guid,
		' ' as [Caption],
		D.[Itemcount] as [old],
		N.[Itemcount] as [New],
		''
	From
		[deleted] d
		inner join [inserted] n on D.Guid = N.Guid
	where
		N.[Itemcount] <> D.[Itemcount]
		
	delete Trace From Trace t left join [TraceDetail] D on T.guid = D.ParentGuid
	where
		d.ParentGuid is Null and t.Guid = @Guid


GO

SET ANSI_NULLS, QUOTED_IDENTIFIER ON
GO

Create Procedure [PrcCreateEntryTypeChecksCollection]
(
	@CheckGuid uniqueidentifier = '4134E164-2A09-4AA7-A64E-938500EB7573',
	@CollectedEntryTypeGuid uniqueidentifier = '250AAEAD-FEAD-4C3E-911B-94FBEB70A6F8',
	@Kind INT = 1,
	@immediate bit = 0
)
 
as
	Set NoCount on 
	
	Declare 
			@EnNum int,
			@EnGuid [uniqueidentifier]

	--  
	Select 
		@EnNum = isnull(S.[Number],0)
		,@EnGuid = isnull([EntryGuid],0x0)
	From
		[LinkEntryType_Checks] L
		left join Secondary_Entry S on S.Guid = L.EntryGuid
	where
		L.[CheckGuid] = @CheckGuid
		and L.[Kind] = 1660+@Kind		

	if isnull(@EnNum,0) = 0
	begin	
		Select @EnNum = ISNULL(MAX(Number), 0) + 1 From [Secondary_Entry] where TypeGuid = @CollectedEntryTypeGuid
		Set @EnGuid = Newid()
	END


	--Select @EnNum	return
	--   
	Delete
		[LinkEntryType_Checks]
	where
		[CheckGuid] = @CheckGuid
		AND [kind] = 1660 + @Kind

	DECLARE 
		@CreateEntry BIT,
		@AutoPostedEntry Bit,
		@checkPayKind int

	SELECT	TOP 1
		@CreateEntry = CASE WHEN @Kind = 0 THEN 
								Case when ([PosdetCreatedEntry] = 1 and ([PosdetAutoCreatedEntry] = 1 OR @immediate = 1)) 
								then 1 else 0 
								end
							WHEN @Kind = 1 THEN 
								Case when ([collectedCreatedEntry] = 1 and ([collectedAutoCreatedEntry] = 1 OR @immediate = 1)) 
								then 1 else 0 
								end
							WHEN @Kind = 2 THEN 
								Case when ([EndorsementCreatedEntry] = 1 and ([EndorsementAutoCreatedEntry] = 1 OR @immediate = 1)) 
								then 1 else 0 
								end
							WHEN @Kind = 3 THEN 
								Case when ([ReturnedCreatedEntry] = 1 and ([ReturnedAutoCreatedEntry] = 1 OR @immediate = 1)) 
								then 1 else 0 
								end
						END,
		@AutoPostedEntry = CASE WHEN @Kind = 0 THEN [PosdetAutoPostedEntry]
							WHEN @Kind = 1 THEN [collectedAutoPostedEntry]
							WHEN @Kind = 2 THEN [EndorsementAutoPostedEntry]
							WHEN @Kind = 3 THEN [ReturnedAutoPostedEntry]
						END,
		@checkPayKind = [CheckKind]
	FROM
		[CheckType]
	WHERE
		Guid = (		
				Select 
					[TypeGuid] 
				From 
					[Checks]
				WHERE
					[Guid] =@CheckGuid
				)

	DECLARE
		@CheckKind INT,
		@CheckNumber Int,
		@SecLvl Int,
		@Value Float,
		@CurrencyGUID [uniqueidentifier],
		@CurrencyVal [float],
		@Date DateTime,

		@DebitAccountGuid [uniqueidentifier]  ,
		@DebitCostGuid [uniqueidentifier]  ,
		@CreditAccountGuid [uniqueidentifier]  ,
		@CreditCostGuid [uniqueidentifier]  ,
		@Commission Float,
		@CommCostGuid [uniqueidentifier],
		@CommCostCreditGuid [uniqueidentifier],
		@CommNote Varchar(256),
		@LossComm Bit,
		@CommType int,
		@CommAccountGuid [uniqueidentifier],
		@CommAccountCreditGuid [uniqueidentifier],
		@Note Varchar(256),
		@Delay FLOAT,
		@DelayNote Varchar(256),
		@DelayAccountDebitGuid [uniqueidentifier]  ,
		@DelayAccountCreditGuid [uniqueidentifier] ,
		@BranchGuid [uniqueidentifier],
		@ContractGuid uniqueidentifier,

		@OperationCreateEntry bit,

		@IsRounded bit

	SELECT
		@CheckKind				= [T].[CheckKind],
		@SecLvl					= [L].[SecLvl],
		@CheckNumber			= [C].[number],
		@Value					= [C].[Value],
		@CurrencyGUID			= [C].[CurrencyGUID],
		@CurrencyVal			= [C].[CurrencyVal],
		@Date					= [L].[Date],

		@DebitAccountGuid		= [L].[DebitAccountGuid],
		@DebitCostGuid			= [L].[DebitCostGuid],
		@CreditAccountGuid		= [L].[CreditAccountGuid],
		@CreditCostGuid			= [L].[CreditCostGuid],
		@Commission				= [L].[Commission],
		@CommCostGuid			= Case when T.CommMoveCost = 1 then L.[CommCostGuid] end,
		@CommCostCreditGuid			= Case when T.CommMoveCostCredit = 1 then L.[CommCostGuid] end,
		@CommNote 				= [L].[CommNote],
		@LossComm				= [L].[LossComm],
		@CommType				= [T].[CommType],
		@CommAccountGuid		= [L].[CommAccountGuid],
		@CommAccountCreditGuid	= [L].[CommAccountCreditGuid],
		@Note					= [L].[Note],
		@Delay					= [L].[Delay],
		@DelayNote 				= [L].[DelayNote],
		@DelayAccountDebitGuid	= [L].[DelayAccountDebitGuid],
		@DelayAccountCreditGuid = [L].[DelayAccountCreditGuid],
		@BranchGuid				= [C].[BranchGuid],
		@ContractGuid			= [C].[ContractGuid],

		@OperationCreateEntry	= L.OperationCreateEntry,

		@IsRounded				= IsNull(l.IsRounded,0)
	FROM 
		[Checks] [C]
		INNER JOIN [ChecksCollection] [L] ON [L].[CheckGuid] = [C].[Guid]
		INNER JOIN [CheckType] [T] ON [T].[Guid] = [C].[TypeGuid]
	WHERE
		[C].[Guid] = @CheckGuid
		AND [L].[Kind] = @Kind



	if (@CreateEntry = 1) and ( @IsRounded = 0) and (@OperationCreateEntry = 1)
	BEGIN
			insert into [Secondary_Entry]
			([Guid],[Number],[Seclvl],[Mark],[Date],[ReceiptNo],[AccountGuid],[Kind],[CurrencyGuid],[CurrencyVal],[Note],[BranchGuid],[TypeGuid],[ContractGuid],[CheckCreateEntry],[SalesManGuid])
			Select
				@EnGuid,
				@EnNum,
				@SecLvl as [Seclvl],
				0 as [Mark],
				@Date as [Date],
				@CheckNumber as [ReceiptNo],
				Case when @checkPayKind = 0 then @DebitAccountGuid else @CreditAccountGuid end as [AccountGuid],
				0 as [Kind],
				@CurrencyGuid as [CurrencyGuid],
				@CurrencyVal as [CurrencyVal],
				@Note as [Note],
				@BranchGuid as [BranchGuid],
				@CollectedEntryTypeGuid as [TypeGuid],
				@ContractGuid as [ContractGuid],
				1 as [CheckCreateEntry],
				Null as [SalesManGuid]
				
			Declare @DetailNum Int
			Set @DetailNum = 0

			Declare @CheckValue Float,
					@CommValue Float

			Set @CheckValue = Case when @LossComm = 1 then
														Case
															when @CommType = 0 then @Value - @Commission
															else @Value
														end
									else
									@Value
							  end

			Set @CommValue = @Commission
				
			insert into [Secondary_EntryDetail]
			([ParentGuid],[Number],[AcGuid],[Debit],[Credit],[CurrencyGuid],[CurrencyVal],[Note],[ObverseAcGuid],[CostGuid])
			Select
				@EnGuid,
				@DetailNum as [Number],
				Case when @checkPayKind = 0 then @CreditAccountGuid else @DebitAccountGuid end as [AcGuid],
				Case when @checkPayKind = 0 then 0 else @CheckValue end as [Debit],
				Case when @checkPayKind = 0 then @CheckValue else 0 end as [Credit],
				@CurrencyGuid,
				@CurrencyVal,
				@Note,
				Case when @checkPayKind = 0 then @DebitAccountGuid else @CreditAccountGuid end as [ObverseAcGuid],
				@CreditCostGuid [CostGuid]


			IF @LossComm = 1  and 1 = 2 --      
			BEGIN
				Set @DetailNum = @DetailNum + 1

				insert into [Secondary_EntryDetail]
				([ParentGuid],[Number],[AcGuid],[Debit],[Credit],[CurrencyGuid],[CurrencyVal],[Note],[ObverseAcGuid],[CostGuid])
				Select
					@EnGuid,
					@DetailNum as [Number],
					Case when @checkPayKind = 0 then @CommAccountCreditGuid else @DebitAccountGuid end as [AcGuid],
					Case when @checkPayKind = 0 then 0 else @CommValue end as [Debit],
					Case when @checkPayKind = 0 then @CommValue else 0 end as [Credit],
					@CurrencyGuid,
					@CurrencyVal,
					@CommNote,
					Case when @checkPayKind = 0 then @DebitAccountGuid else @CommAccountCreditGuid end as [ObverseAcGuid],
					@CreditCostGuid [CostGuid]				
			END

			INSERT INTO [LinkEntryType_Checks]
			(
				[CheckGuid],
				[EntryGuid],
				[EntryNum],
				[Kind]
			)
			SELECT	
				@CheckGuid,
				@EnGuid,
				@EnNum,
				1660+@Kind
				
			exec [PrcCreateEntryFromEntryType] @EnGuid, @ContractGuid

	end


GO

SET ANSI_NULLS, QUOTED_IDENTIFIER ON
GO

Create Proc [PrcIncomList2]
(
	@AccountGuid [uniqueidentifier]= 0X0
	,@BranchGuid [uniqueidentifier] = 0x0
	,@CostGuid [uniqueidentifier] = 0x0
	,@CurrencyGuid [uniqueidentifier] = '11111111-C748-4B13-8B91-1E9B299DF1C1'
	,@CurrencyVal Float = 1
	,@IsPosted Bit = 1
	,@IsNotPosted Bit = 1
	,@Date1 DateTime = '1/2/2007'
	,@Date2 DateTime = '12/30/2018'
    ,@ContainOldEntry Bit = 0
	,@PriceMode int = 1
	,@SpecificPrice int = -1
)
 
as
	set nocount on 
	
	
	
	Select * Into dbo.#fnGetAccountList_BS from [dbo].[fnGetAccountList](@AccountGuid)
	Select * Into dbo.#fnGetAccountList from [dbo].[fnGetAccountList](0x0)
	
	Select O.* Into #fnGetCostList_BS 
	from 
		[dbo].[fnGetCostList](@CostGuid) C
		inner join [Cost] O on O.Guid = C.GUID
	
	Set noCount on
	--  
	Select
		[Ac2].[Code] COLLATE database_default as [Code]
		,[Ac2].[Code]+'-'+[Ac2].[Name] COLLATE database_default as [AccountName]
		,[Ac].[Level]
		,isnull([Ac].[Path],'') as [Path]
		,[Ac2].[Guid]
		,[Ac2].[ParentGuid]
		,Case when Type = 0 then [Ac2].[FinalGuid] 
			  when Type = 1 then [Ac2].[ParentGuid] 
		end as [FinalGuid]
		,[Ac2].[Type]
		,Cast('' as Varchar(256)) COLLATE database_default as [Sort]
		,Isnull([SAc].[AcNSons],0) as [AcNSons]
	into #Ac
	From
		#fnGetAccountList [Ac] 
		inner join [vwAccount] [Ac2] on [Ac2].[Guid] = [Ac].[Guid]
		left join [dbo].#fnGetAccountList_BS [AcF] on [AcF].[Guid] = [Ac2].[FinalGuid]   
		left join (Select 
						Count(Number)as [AcNSons] 
						,[ParentGuid] 
					From 
						[Account] [SAc] 
					Group By
						[ParentGuid]					
				)[SAc] on [SAc].[ParentGuid] = [Ac2].[Guid]
--	Select * from #Ac
--	return


	--  
	Select 
		[Ac].[Guid] as [AcGuid]
		,Sum([En].[D_Debit]*
			Case when [En].[D_CurrencyGuid] = @CurrencyGuid then 1 
			else [En].[D_CurrencyVal] / @CurrencyVal end
			) as [Debit]
		,Sum([En].[D_Credit]*
			Case when [En].[D_CurrencyGuid] = @CurrencyGuid then 1 
			else [En].[D_CurrencyVal] / @CurrencyVal end
			) as [Credit]
	into #Entry
	from 
		--[DEntry] [En]
		--inner Join [VwEntry] [M] on [M].[Guid] = [En].[ParentGuid]
		[vwOldYearEntry] En
		inner Join [dbo].#fnGetAccountList [Ac] on [Ac].[Guid] = [En].[D_AcGuid]
		left Join #fnGetCostList_BS [Co2] on [Co2].[Guid] = [En].[D_CostGuid]
	where 
		([En].[H_Date] between @Date1 And @Date2)
		and ([En].[H_BranchGuid] = @BranchGuid or @BranchGuid = 0x0)
		and ([Co2].[Guid] Is Not Null or @CostGuid = 0x0)
		and ([En].[D_IsVisible] = 1 or [En].[D_CurrencyGuid] = @CurrencyGuid)
		and (
				([En].[H_IsPosted] = 1 and @IsPosted = 1)
				or ([En].[H_IsPosted] = 0  and @IsNotPosted = 1)
			)
		and (En.isOldEntry = 0 or @ContainOldEntry = 1)
	Group By
		[Ac].[Guid]
		
	Create Table #IncList
	(
		[Name] varchar(255),
		[Balance] Float,
		[Band] float,
		[Code] varchar(255),
		[Sort] int,
		[Guid] uniqueidentifier,
		[Level] int
	)
	
	--  
	Declare @IncAcGuid uniqueidentifier
	Set @IncAcGuid = (Select Guid From incAccount where Code = 05)
	insert into #IncList	
	([Name],[Balance], [Band],[Code],[Sort],[Guid])
	Select 
		A.Name,
		SUM([Debit] - [Credit]) as Balance,
		1 as Band,
		A.[Code],
		1,
		A.[Guid]
	from
		dbo.[fnGetIncAccountList](@IncAcGuid) A 
		inner join incAccount AI on AI.Guid = A.GUID 
		left join IncAccountListDetail i on  A.Guid = I.ParentGuid
		left join #Entry E on I.AccountGuid = E.AcGuid
	where
		(A.Band = 4)
		and (AI.ShowBalanceInListFinCenter = 0)
	Group by
		A.Name,A.Code, A.Band, A.[Guid]
		
	Select
		AI.ParentGuid ,
		SUM([Debit] - [Credit]) as Balance
	into #ShowBalanceInListFinCenter
	from
		dbo.[fnGetIncAccountList](@IncAcGuid) A 
		inner join incAccount AI on AI.Guid = A.GUID 
		left join IncAccountListDetail i on  A.Guid = I.ParentGuid
		left join #Entry E on I.AccountGuid = E.AcGuid
	where
		(A.Band = 4)
		and (AI.ShowBalanceInListFinCenter = 1)
	Group by
		AI.ParentGuid
		
	update #IncList Set Balance = B.Balance
	From
		#IncList L
		inner join #ShowBalanceInListFinCenter B on b.ParentGuid = L.Guid
	--Select * from #IncList
	
	--  
	insert into #IncList	
	([Name],[Balance], [Band],[Code],[Sort])
	Select 
		dbo.SC('  '),
		Sum([Balance]), 
		[Band],
		'',
		2 [Sort] 
	from 
		#IncList	
	where
		Band = 1
	group by
		[Band]
	
	
	--
	insert into #IncList	
	([Name],[Balance], [Band],[Code],[Sort],[Guid])
	Select 
		A.Name,
		SUM(Debit - Credit) as Balance,
		2 as Band,
		A.[Code],
		1,
		A.[Guid]
	from 
		IncAccount A
		left join IncAccountListDetail i on  A.Guid = I.ParentGuid
		left join #Entry E on I.AccountGuid = E.AcGuid
	where
		Band = 9
	Group by
		A.Name,A.Code, A.Band,A.[Guid]
		
	-- 
	insert into #IncList	
	([Name],[Balance], [Band],[Code],[Sort])
	Select 
		dbo.SC(' '),
		-Sum([Balance]), 
		2 as [Band],
		'',
		2 [Sort] 
	from 
		#IncList	
	where
		Band = 2
	group by
		[Band]
	having 
		Count(*) > 1
	
	
	--   
	insert into #IncList	
	([Name],[Balance], [Band],[Code],[Sort],[Guid])
	Select 
		A.Name,
		SUM(Debit - Credit) as Balance,
		3 as Band,
		A.[Code],
		1,
		A.[Guid]
	from 
		IncAccount A
		left join IncAccountListDetail i on  A.Guid = I.ParentGuid
		left join #Entry E on I.AccountGuid = E.AcGuid
	where
		Band = 6
	Group by
		A.Name,A.Code, A.Band,A.[Guid]
		
	--    
	insert into #IncList	
	([Name],[Balance], [Band],[Code],[Sort])
	Select 
		dbo.SC('   '),
		-Sum([Balance]), 
		3 as [Band],
		'',
		2 [Sort] 
	from 
		#IncList	
	where
		Band = 3
	group by
		[Band]
	having 
		Count(*) > 1
	
	--     
	insert into #IncList	
	([Name],[Balance], [Band],[Code],[Sort],[Guid])
	Select 
		A.Name,
		SUM(Debit - Credit) as Balance,
		4 as Band,
		A.[Code],
		1,
		A.[Guid]
	from 
		IncAccount A
		left join IncAccountListDetail i on  A.Guid = I.ParentGuid
		left join #Entry E on I.AccountGuid = E.AcGuid
	where
		Band = 7
	Group by
		A.Name,A.Code, A.Band,A.[Guid]
		
	--      
	insert into #IncList	
	([Name],[Balance], [Band],[Code],[Sort])
	Select 
		dbo.SC('    '),
		Sum([Balance]), 
		4 as [Band],
		'',
		2 [Sort] 
	from 
		#IncList	
	where
		Band = 4
	group by
		[Band]
	having 
		Count(*) > 1

	--  
	insert into #IncList	
	([Name],[Balance], [Band],[Code],[Sort],[Guid])
	Select 
		A.Name,
		SUM(Debit - Credit) as Balance,
		5 as Band,
		A.[Code],
		1,
		A.[Guid]
	from 
		IncAccount A
		left join IncAccountListDetail i on  A.Guid = I.ParentGuid
		left join #Entry E on I.AccountGuid = E.AcGuid
	where
		Band = 8
	Group by
		A.Name,A.Code, A.Band,A.[Guid]
		
	--  
	insert into #IncList	
	([Name],[Balance], [Band],[Code],[Sort])
	Select 
		dbo.SC('  '),
		-Sum([Balance]), 
		5 as [Band],
		'',
		2 [Sort] 
	from 
		#IncList	
	where
		Band = 5
	group by
		[Band]
	having 
		Count(*) > 1

	-- 
	insert into #IncList	
	([Name],[Balance], [Band],[Code],[Sort])
	Select 
		dbo.SC(' '),
		Sum([Balance]), 
		5.1 as [Band],
		'',
		3 [Sort] 
	from 
		#IncList	
	where
		(Band between 1 and 5)
		and Sort = 1


	-- 
	Set @IncAcGuid = (Select Guid From incAccount where Code = '10')
	insert into #IncList	
	([Name],[Balance], [Band],[Code],[Sort],[Guid])
	Select 
		A.Name,
		-SUM(Debit - Credit) as Balance,
		6 as Band,
		A.[Code],
		1,
		A.[Guid]
	from 
		dbo.[fnGetIncAccountList](@IncAcGuid) A
		left join IncAccountListDetail i on  A.Guid = I.ParentGuid
		left join #Entry E on I.AccountGuid = E.AcGuid
	where
		Band = 5
	Group by
		A.Name,A.Code, A.Band,A.[Guid]
		
	-- 
	insert into #IncList	
	([Name],[Balance], [Band],[Code],[Sort])
	Select 
		dbo.SC('  '),
		Sum([Balance]), 
		6 as [Band],
		'',
		2 [Sort] 
	from 
		#IncList	
	where
		Band = 6
	group by
		[Band]
	having 
		Count(*) > 1

	--  
	insert into #IncList	
	([Name],[Balance], [Band],[Code],[Sort],[Guid])
	Select 
		A.Name,
		-SUM(Debit - Credit) as Balance,
		7 as Band,
		A.[Code],
		1,
		A.[Guid]
	from 
		IncAccount A
		left join IncAccountListDetail i on  A.Guid = I.ParentGuid
		left join #Entry E on I.AccountGuid = E.AcGuid
	where
		Band = 10
	Group by
		A.Name,A.Code, A.Band,A.[Guid]
		
	--  
	insert into #IncList	
	([Name],[Balance], [Band],[Code],[Sort])
	Select 
		dbo.SC('   '),
		Sum([Balance]), 
		7 as [Band],
		'',
		2 [Sort] 
	from 
		#IncList	
	where
		Band = 7
	group by
		[Band]
	having 
		Count(*) > 1


	Set @IncAcGuid = (Select Guid From incAccount where Code = 12)
	-- 
	insert into #IncList	
	([Name],[Balance], [Band],[Code],[Sort],[Guid])
	Select 
		A.Name,
		-SUM(Debit - Credit) as Balance,
		8 as Band,
		A.[Code],
		1,
		A.[Guid]
	from 
		dbo.[fnGetIncAccountList](@IncAcGuid) A
		left join IncAccountListDetail i on  A.Guid = I.ParentGuid
		left join #Entry E on I.AccountGuid = E.AcGuid
	where
		Band = 11
	Group by
		A.Name,A.Code, A.Band,A.[Guid]
		

	-- 
	Create Table #YearRes
	(
		Name varchar(255),
		balance float,
		Band Float,
		Code varchar(255),
		[Sort] Float,
		Guid uniqueidentifier,
		level int
	)
	
	insert into #YearRes
	exec [PrcIncomList]	@AccountGuid ,@BranchGuid ,@CostGuid ,@CurrencyGuid ,@CurrencyVal ,@IsPosted ,@IsNotPosted ,@Date1 ,@Date2 ,@ContainOldEntry ,@PriceMode ,@SpecificPrice 
	
	insert into #IncList	
	([Name],[Balance], [Band],[Code],[Sort],[level])
	Select 
		dbo.SC(' '),
		[Balance], 
		8 as [Band],
		'1204',
		1 [Sort],
		1 
	from 
		#YearRes	
	where
		Band= 3.1

	-- 
	insert into #IncList	
	([Name],[Balance], [Band],[Code],[Sort])
	Select 
		dbo.SC('  '),
		-Sum([Balance]), 
		8 as [Band],
		'',
		2 [Sort] 
	from 
		#IncList	
	where
		Band = 7
	group by
		[Band]
	having 
		Count(*) > 1


	
	
	--  
	insert into #IncList	
	([Name],[Balance], [Band],[Code],[Sort])
	Select 
		dbo.SC('  '),
		Sum([Balance]), 
		8.1 as [Band],
		'',
		3 [Sort] 
	from 
		#IncList	
	where
		(Band between 6 and 8)
		and Sort <> 2

	upDate #IncList	Set [Level] = G.[Level]
	From
		#IncList L
		inner join dbo.fnGetIncAccountList(0x0) G on G.GUID= L.Guid
	

	Select * from #IncList	
	order by
		[Band],[Sort],[Level],Code

GO

SET ANSI_NULLS, QUOTED_IDENTIFIER ON
GO
Create Procedure [dbo].[prcAddJob]  
(
	@JobName		[VARCHAR]( 256), --name of job 
	@JobType		[INT], -- type of job 4_ d, 8_ w, 16_ m 
	@JobTime		[INT],  
	@Jobday			[INT],  
	@JobStartDate	[INT],  
	@DBName			[VARCHAR]( 256),  
	@Command		[VARCHAR]( 8000), 
	@Occurance		[INT] = 2, --1 Once Only, 2 Every  
	@HoursNumber [INT]  = 250--Number of hours  
)
 
AS 
	/* 
		this procedure Add Job To database 
		this job Execute the Command 
	*/ 
		SET NOCOUNT ON 
		 
		SET XACT_ABORT ON  
		BEGIN TRANSACTION  
		DECLARE @JobID [BINARY](16)  
		DECLARE @ReturnCode [INT]  
		DECLARE @RetryNum [INT]  
		DECLARE @RetryInter [INT]  
		IF(@JobType = 4)  
		BEGIN 
			SELECT @RetryNum = 23  
			SELECT @RetryInter = 60  
		END ELSE BEGIN  
			SELECT @RetryNum = 4  
			SELECT @RetryInter = 1440  
		END  
		SET @ReturnCode = 0 
	--	IF (SELECT COUNT(*) FROM msdb.dbo.syscategories WHERE name = N'[Uncategorized (Local)]') < 1  
		IF NOT EXISTS(SELECT * FROM [msdb].[dbo].[syscategories] WHERE [name] = N'[Uncategorized (Local)]') 
			EXECUTE [msdb].[dbo].[sp_add_category] @name = N'[Uncategorized (Local)]' 
		-- Delete the job with the same name (if it exists)  
		SELECT @JobID = [job_id] FROM [msdb].[dbo].[sysjobs] WHERE ([name] = @JobName) 
		IF (@JobID IS NOT NULL)  
		BEGIN -- Check if the job is a multi-server job  
			IF (EXISTS (SELECT * FROM [msdb].[dbo].[sysjobservers] WHERE ([job_id] = @JobID) AND ([server_id] <> 0)))  
			BEGIN -- There is, so abort the script  
				RAISERROR (N'Unable to import job _ '' since there is already a multi-server job with this name.', 16, 1)  
				IF (@@TRANCOUNT > 0) 
					ROLLBACK TRANSACTION 
				return
			END  
			ELSE -- Delete the [local] job  
				EXECUTE [msdb].[dbo].[sp_delete_job] @job_name = @JobName  
			SELECT @JobID = NULL  
		END 
		-- Add the job  
		EXECUTE @ReturnCode = [msdb].[dbo].[sp_add_job] @job_id = @JobID OUTPUT , @job_name = @JobName , @owner_login_name = NULL, @description = N'No description available.', @category_name = N'[Uncategorized (Local)]', @enabled = 1, @notify_level_email = 0, @notify_level_page = 0, @notify_level_netsend = 0, @notify_level_eventlog = 2, @delete_level= 0  
		IF (@@ERROR <> 0 OR @ReturnCode <> 0) 
		--GOTO QuitWithRollback 
		begin
			IF (@@TRANCOUNT > 0) 
			ROLLBACK TRANSACTION 
			return
		end

		-- Add the job steps  
		EXECUTE @ReturnCode = [msdb].[dbo].[sp_add_jobstep] @job_id = @JobID, @step_id = 1, @step_name = N'Step 1', @command = @Command, @database_name = @DBName, @server = N'', @database_user_name = N'', @subsystem = N'TSQL', @cmdexec_success_code = 0, @flags = 0, @retry_attempts = @RetryNum, @retry_interval = @RetryInter, @output_file_name = N'', @on_success_step_id = 0, @on_success_action = 1, @on_fail_step_id = 0, @on_fail_action = 2  
		IF (@@ERROR <> 0 OR @ReturnCode <> 0) 
		--GOTO QuitWithRollback 
		begin
			IF (@@TRANCOUNT > 0) 
			ROLLBACK TRANSACTION 
			return
		end

		EXECUTE @ReturnCode = [msdb].[dbo].[sp_update_job] @job_id = @JobID, @start_step_id = 1 
		IF (@@ERROR <> 0 OR @ReturnCode <> 0) --GOTO QuitWithRollback 
		begin
			IF (@@TRANCOUNT > 0) 
			ROLLBACK TRANSACTION 
			return
		end
		-- Add the job schedules  
		IF (@Occurance = 1 ) 
		BEGIN  
		EXECUTE @ReturnCode = [msdb].[dbo].[sp_add_jobschedule] @job_id = @JobID, @name = N'Schedule 1', @enabled = 1, @freq_type = @JobType , @active_start_date = @JobStartDate, @active_start_time = @JobTime, @freq_interval = @Jobday, @freq_subday_type = 1, @freq_subday_interval = 0, @freq_relative_interval = 0, @freq_recurrence_factor = 1, @active_end_date = 99991231, @active_end_time = 235959 
		IF (@@ERROR <> 0 OR @ReturnCode <> 0) --GOTO QuitWithRollback 
		begin
			IF (@@TRANCOUNT > 0) 
			ROLLBACK TRANSACTION 
			return
		end
		END  
		 
		IF (@Occurance = 2) 
		BEGIN 
		EXECUTE @ReturnCode = [msdb].[dbo].[sp_add_jobschedule] @job_id = @JobID, @name = N'Schedule 1', @enabled = 1, @freq_type = @JobType , @active_start_date = @JobStartDate, @active_start_time = @JobTime, @freq_interval = @Jobday, @freq_subday_type = 8, @freq_subday_interval = @HoursNumber, @freq_relative_interval = 0, @freq_recurrence_factor = 1, @active_end_date = 99991231, @active_end_time = 235959  
		IF (@@ERROR <> 0 OR @ReturnCode <> 0) --GOTO QuitWithRollback  
		begin
			IF (@@TRANCOUNT > 0) 
			ROLLBACK TRANSACTION 
			return
		end
		END  
		-- Add the Target Servers  
		EXECUTE @ReturnCode = [msdb].[dbo].[sp_add_jobserver] @job_id = @JobID, @server_name = N'(local)' 
		IF (@@ERROR <> 0 OR @ReturnCode <> 0) --GOTO QuitWithRollback 
		begin
			IF (@@TRANCOUNT > 0) 
			ROLLBACK TRANSACTION 
			return
		end
		COMMIT TRANSACTION  
		RETURN 
		


GO

SET ANSI_NULLS, QUOTED_IDENTIFIER ON
GO

Create View [vwAllContract]
 , VIEW_METADATA
as
	Select 
		[L].[Number],
		[L].[EditDate],
		[L].[FromDate],
		[L].[ToDate],
		[T].[Name] +' '+[L].[FlatNo]as [TypeName],
		[T].[Name] as [TypeNameAr],
		[T].[Name] as [TypeNameLtn],
		[T].[Guid] as [TypeGuid],
		[L].[ContractNo], 
		[C].[Name] as [CustName],
		[C].[arName] as [CustarName],
		[C].[LtnName] as [CustLtnName],
		[C].[Mobile] as [CustMobile],
		[L].[Rent] - isNull([L].[DiscountValue],0) as [Value],
		[L].[CurrencyGuid],
		[L].[CurrencyVal],
		[C].[Guid] as [CustGuid],
		[C].[AcGuid] as [CustAcGuid],
		[L].[BuildingGuid],
		Case when [L].[ApartmentGuid] <> 0x0 then [L].[ApartmentGuid]
		else [L].[ShopGuid] end as [RealtyGuid],
		[L].[FloorNo],
		[L].[FlatNo],
		[L].[BuildingName],
		[L].[BuildingArName],
		[L].[BuildingLtnName],
		IsNull([L].[NewState],0) as [NewState],
		[L].[Guid],
		[T].[Name] +'/'+ [L].[FlatNo] as [TypeNameAndFlatNo],
		[L].[Note2],
		[L].[CostGuid] as [UnitCostGuid],
		[L].[SalesManGuid],
		T.Code as [TypeCode],
		L.ContractFinish,
		0 as [Kind]
	From 
		[vwLeaseApartment] [L]
		inner join [vwCustomer] [C] on [L].[CustomerGuid] = [C].[Guid]
		inner join [vwContractType] [T] On [T].[Guid] = [L].[TypeGuid]
	union all
	Select 
		[L].[Number],
		[L].[EditDate],
		[L].[FromDate],
		[L].[ToDate],
		[T].[Name]+' '+[L].[No] as [TypeName],
		[T].[Name] as [TypeNameAr],
		[T].[Name] as [TypeNameLtn],
		[T].[Guid] as [TypeGuid],
		[L].[ContractNo],
		[C].[Name] as [CustName],
		[C].[arName] as [CustarName],
		[C].[LtnName] as [CustLtnName]
		,[C].[Mobile] as [CustMobile]
		,[L].[Rent] as [Value]
		,[L].[CurrencyGuid]
		,[L].[CurrencyVal]
		,[C].[Guid] as [CustGuid]
		,[C].[AcGuid] as [CustAcGuid]
		,[L].[BuildingGuid]
		,[L].[ParkingGuid]
		,Null as [FloorNo]
		,[L].[No] as [FlatNo]
		,[L].[BuildingName]
		,[L].[BuildingArName]
		,[L].[BuildingLtnName]
		,IsNull([L].[NewState],0) as [NewState]
		,[L].[Guid]
		,[T].[Name] +'/'+ [L].[No]as [TypeNameAndFlatNo]
		,[L].[Note2]
		,[L].[CostGuid]
		,[L].[SalesManGuid]
		,T.Code as [TypeCode]
		,l.ContractFinish
		,1 as [kind]
	From 
		[vwParkingContract] [L]
		inner join [vwCustomer] [C] on [L].[CustomerGuid] = [C].[Guid]
		inner join [vwContractType] [T] On [T].[Guid] = [L].[TypeGuid]
	union all
	Select
		[L].[Number],
		[L].[EditDate],
		[L].[FromDate],
		[L].[ToDate],
		[T].[Name] as [TypeName],
		[T].[Name] as [TypeNameAr],
		[T].[Name] as [TypeNameLtn],
		[T].[Guid] as [TypeGuid],
		[L].[ContractNo],
		[C].[Name] as [CustName],
		[C].[arName] as [CustarName],
		[C].[LtnName] as [CustLtnName]
		,[C].[Mobile] as [CustMobile]
		,[L].[Rent] as [Value]
		,[L].[CurrencyGuid]
		,[L].[CurrencyVal]
		,[C].[Guid] as [CustGuid]
		,[C].[AcGuid] as [CustAcGuid]
		,LandGuid as [BuildingGuid]
		,L.LandGuid
		,Null as [FloorNo]
		,Null as [FlatNo]
		,LandName as [BuildingName]
		,LandName as [BuildingArName]
		,LandName as [BuildingLtnName]
		,-1 as [NewState]
		,[L].[Guid]
		,[T].[Name] as [TypeNameAndFlatNo]
		,[L].[Note2]
		,[L].[CostGuid]
		,[L].[SalesManGuid]
		,T.Code as [TypeCode]
		,l.ContractFinish
		,2 as [Kind]
	From 
		[vwLandContract] [L]
		inner join [vwCustomer] [C] on [L].[CustomerGuid] = [C].[Guid]
		inner join [vwContractType] [T] On [T].[Guid] = [L].[TypeGuid]

	union all
	Select
		[L].[Number],
		[L].[EditDate],
		[L].[FromDate],
		[L].[ToDate],
		[T].[Name] as [TypeName],
		[T].[Name] as [TypeNameAr],
		[T].[Name] as [TypeNameLtn],
		[T].[Guid] as [TypeGuid],
		[L].[ContractNo],
		[C].[Name] as [CustName],
		[C].[arName] as [CustarName],
		[C].[LtnName] as [CustLtnName]
		,[C].[Mobile] as [CustMobile]
		,[L].[Rent] as [Value]
		,[L].[CurrencyGuid]
		,[L].[CurrencyVal]
		,[C].[Guid] as [CustGuid]
		,[C].[AcGuid] as [CustAcGuid]
		,[BuildingGuid] as [BuildingGuid]
		,0x0
		,Null as [FloorNo]
		,Null as [FlatNo]
		,[BuildingName] as [BuildingName]
		,[BuildingArName] as [BuildingArName]
		,[BuildingLtnName] as [BuildingLtnName]
		,-1 as [NewState]
		,[L].[Guid]
		,[T].[Name] as [TypeNameAndFlatNo]
		,[L].[Note2]
		,[L].[CostGuid]
		,0x0 as [SalesManGuid]
		,T.Code as [TypeCode]
		,l.ContractFinish
		,4 as [Kind]
	From 
		[vwServicesContract] [L]
		inner join [vwCustomer] [C] on [L].[CustomerGuid] = [C].[Guid]
		inner join [vwServicesContractType] [T] On [T].[Guid] = [L].[TypeGuid]
	union all
	Select
		[L].[Number],
		[L].[EditDate],
		[L].[FromDate],
		[L].[ToDate],
		[T].[Name] as [TypeName],
		[T].[Name] as [TypeNameAr],
		[T].[Name] as [TypeNameLtn],
		[T].[Guid] as [TypeGuid],
		[L].[ContractNo],
		[C].[Name] as [CustName],
		[C].[arName] as [CustarName],
		[C].[LtnName] as [CustLtnName]
		,[C].[Mobile] as [CustMobile]
		,[L].[Rent] as [Value]
		,[L].[CurrencyGuid]
		,[L].[CurrencyVal]
		,[C].[Guid] as [CustGuid]
		,[C].[AcGuid] as [CustAcGuid]
		,[BuildingGuid] as [BuildingGuid]
		,0x0
		,Null as [FloorNo]
		,Null as [FlatNo]
		,Null as [BuildingName]
		,Null as [BuildingArName]
		,Null as [BuildingLtnName]
		,-1 as [NewState]
		,[L].[Guid]
		,[T].[Name] as [TypeNameAndFlatNo]
		,[L].[Note2]
		,[L].[CostGuid]
		,0x0 as [SalesManGuid]
		,T.Code as [TypeCode]
		,l.ContractFinish
		,5 as [Kind]
	From 
		[vbMaintenanceContract] [L]
		inner join [vwCustomer] [C] on [L].[CustomerGuid] = [C].[Guid]
		inner join [vbMaintenanceContractType] [T] On [T].[Guid] = [L].[TypeGuid]


GO

SET ANSI_NULLS, QUOTED_IDENTIFIER ON
GO

Create Procedure [PrcCreateEntryTypeReceiptOrderRow]
(
	@RowGuid uniqueidentifier = '29AC5624-DE50-47A1-BE1A-1B0E7E56E3DB'
)
 
as
	Declare 
			@EntryTypeGuid uniqueidentifier,
			@ContractGuid uniqueidentifier,
			@CreateEntry BIT,
			@AutoPostedEntry Bit,
			@Mark bit,
			@SecLvl Int,
			@Value Float,
			@CurrencyGUID [uniqueidentifier],
			@CurrencyVal [float],
			@Date DateTime,
			@DebitAccountGuid [uniqueidentifier]  ,
			@DebitCostGuid [uniqueidentifier]  ,
			@CreditAccountGuid [uniqueidentifier]  ,
			@CreditCostGuid [uniqueidentifier]  ,
			@Note Varchar(256),
			@DetailNote Varchar(256),
			@TypeDetailNote Varchar(256),
			@BranchGuid [uniqueidentifier],
			
			@BuildingName Varchar(256),
			@BuildingLtnName Varchar(256),
			@FlatNo Varchar(256),
			@CustName Varchar(256),
			@CustltnName Varchar(256),
			@ContractNo Varchar(256),
			@ContractNumber Varchar(256)


	Select
		@EntryTypeGuid = T.EntryTypeGuid,
		@CreateEntry = D.IsReceipt,
		@ContractGuid = O.ContractGuid,
		@SecLvl = O.SecLvl,
		@Value = D.CashValue,
		@CurrencyGUID = C.CurrencyGUID,
		@CurrencyVal = C.CurrencyVal,
		@Date = D.Date,
		@DebitAccountGuid = D.AccountGuid,
		@DebitCostGuid = Case when T.[OpMoveCostwithDefAccount] = 1 then C.[UnitCostGuid] end,
		@CreditAccountGuid = C.CustAcGuid,
		@CreditCostGuid = Case when T.[NeedCostItem] = 1 then C.[UnitCostGuid] end,
		@Note = O.Note,
		@DetailNote = D.Note,
		@TypeDetailNote = (Select Top 1 Case when (dbo.FnGetLangauge(@@spid) = 1) and (Isnull([dt].[enNote],'') <> '') then [dt].[enNote] else [dt].[ArNote]  end From ReceiptOrderTypeDetail dt where dt.Number = D.Number and dt.parentGuid = T.Guid),
		@Mark = O.Mark,
		@BranchGuid = Null,
		
		@BuildingName = C.BuildingarName,
		@BuildingLtnName = C.[BuildingLtnName],
		@FlatNo = C.FlatNo,
		@CustName = C.CustarName,
		@CustLtnName = C.CustltnName,
		@ContractNo = C.ContractNo,
		@ContractNumber = C.number
	From
		ReceiptOrder O
		inner join vwReceiptOrderType T on T.Guid = O.TypeGuid
		inner join ReceiptOrderDetail D on D.parentGuid = O.Guid
		inner join vwallcontract C on C.Guid = O.ContractGuid
	where
		D.Guid = @RowGuid


	if ISNULL(@DetailNote, '') = ''
	begin
		Set @TypeDetailNote = REPLACE(@TypeDetailNote, '[A]', ISNULL(@BuildingName,''))
		Set @TypeDetailNote = REPLACE(@TypeDetailNote, '[F]', ISNULL(@BuildingltnName,''))
		Set @TypeDetailNote = REPLACE(@TypeDetailNote, '[B]', ISNULL(@FlatNo,''))
		Set @TypeDetailNote = REPLACE(@TypeDetailNote, '[C]', ISNULL(@CustName,''))
		Set @TypeDetailNote = REPLACE(@TypeDetailNote, '[H]', ISNULL(@CustltnName,''))
		Set @TypeDetailNote = REPLACE(@TypeDetailNote, '[D]', ISNULL(@ContractNo,''))
		Set @TypeDetailNote = REPLACE(@TypeDetailNote, '[E]', ISNULL(@ContractNumber,''))
		
		Set @DetailNote = @TypeDetailNote
	end
	
	Set @AutoPostedEntry = 1

	Declare @EnNum int

	--  
	Select 
		@EnNum = isnull([Number],0)
	From
		[Secondary_Entry]
	where
		[Guid] = @RowGuid
		and TypeGuid = @EntryTypeGuid

	if isnull(@EnNum,0) = 0
	begin	
		Select @EnNum = ISNULL(MAX(Number), 0) + 1 From [Secondary_Entry] where TypeGuid = @EntryTypeGuid
	END

	--   
	Delete
		[Secondary_Entry]
	where
		[Guid] = @RowGuid



	if (@CreateEntry = 1) and (IsNull(@Value,0) <> 0)
	BEGIN
			insert into [Secondary_Entry]
			([Guid],[Number],[Seclvl],[Mark],[Date],[AccountGuid],[Kind],[CurrencyGuid],[CurrencyVal],[Note],[BranchGuid],[TypeGuid],[ContractGuid],[CheckCreateEntry],[SalesManGuid])
			Select
				@RowGuid,
				@EnNum,
				@SecLvl as [Seclvl],
				@Mark as [Mark],
				@Date as [Date],
				@DebitAccountGuid ,
				0 as [Kind],
				@CurrencyGuid as [CurrencyGuid],
				@CurrencyVal as [CurrencyVal],
				@DetailNote as [Note],
				@BranchGuid as [BranchGuid],
				@EntryTypeGuid as [TypeGuid],
				@ContractGuid,
				1 as [CheckCreateEntry],
				Null as [SalesManGuid]
				

			insert into [Secondary_EntryDetail]
			([ParentGuid],[Number],[AcGuid],[Debit],[Credit],[CurrencyGuid],[CurrencyVal],[Note],[ObverseAcGuid],[CostGuid])
			Select
				@RowGuid,
				1 as [Number],
				@CreditAccountGuid as [AcGuid],
				0 as [Debit],
				@Value as [Credit],
				@CurrencyGuid,
				@CurrencyVal,
				@DetailNote,
				@DebitAccountGuid as [ObverseAcGuid],
				@CreditCostGuid [CostGuid]
				
			exec [PrcCreateEntryFromEntryType] @RowGuid, @ContractGuid
			
	end

	

GO

SET ANSI_NULLS, QUOTED_IDENTIFIER ON
GO

Create Procedure [PrcCreateEntryFromLandContractFee]
(
	@Guid uniqueidentifier = '3ABCD433-FBC1-443A-9B16-4FEC32D137AB'
)
 
as
	--Return
	Set noCount on
	
	exec [PrcDeleteEntryContractFee] @Guid
	
	Declare @CreateContractEntry bit
	Select
		@CreateContractEntry = C.CreateContractEntry
	From
		LandContract C 
	where
		C.Guid = @Guid
		
	if @CreateContractEntry = 0
	return

	Declare	
		@CustAccountGuid uniqueidentifier, 
		@CostGuid  uniqueidentifier,
		@SecLvl int,
		@Mark bit,
		@CurrencyGuid uniqueidentifier, 
		@CurrencyVal Float, 
		@UserGuid uniqueidentifier, 
		@BranchGuid uniqueidentifier, 
		@AutoPostedEntry bit,
		@MoveCost bit,
		@MoveCostWithFeeCredit bit,
		@FeeEntryNote varchar(255)
	
	Select
		@CustAccountGuid = CustAccountGuid,
		@SecLvl = C.SecLvl,
		@Mark = C.Mark,
		@CurrencyGuid = C.CurrencyGuid, 
		@CurrencyVal = C.CurrencyVal,
		@UserGuid = C.UserGuid,
		@BranchGuid = C.BranchGuid,
		@AutoPostedEntry = T.AutoPostedEntry,
		@MoveCost = T.MoveCost,
		@MoveCostWithFeeCredit = T.MoveCostWithFeeCredit,
		@CostGuid = C.CostGuid,
		@FeeEntryNote = T.FeeEntryNote
	From
		LandContract C 
		inner join ContractType t on t.Guid = C.TypeGuid
	where
		C.Guid = @Guid

	Select 
		@FeeEntryNote  =				REPLACE(REPLACE(REPLACE(REPLACE(REPLACE(REPLACE(
									REPLACE(REPLACE(REPLACE(REPLACE(REPLACE(REPLACE(
									@FeeEntryNote, '[N]', TypeNameAr),
									'[M]', TypeNameLtn),
									'[A]', CustArName),
									'[B]', CustltnName),
									'[C]', FlatNo),
									'[D]', BuildingArName),
									'[E]', BuildingLtnName),
									'[F]', dbo.fndate(EditDate)),
									'[G]', dbo.fndate(Fromdate)),
									'[H]', dbo.fndate(Todate)),
									'[K]', ContractNo),
									'[L]', Cast(Value as varchar(50)))
									
	from 
		[vwAllContract]
	where
		Guid = @Guid

	Declare 
		@EntryGuid uniqueidentifier,
		@EntryDate Datetime,
		@FeeAccountGuid uniqueidentifier,
		@EntryNumber int,
		@Value float,
		@Note varchar(255)
		
	DECLARE @cursor_Name CURSOR 
	Set @cursor_Name = CURSOR FAST_FORWARD FOR 
	SELECT 
		[Guid],
		[Date],
		[AccountGuid],
		[EntryNumber],
		[Value],
		[Note]
	FROM 
		LandContractFee
	where
		(ParentGuid = @Guid) and Value <> 0  and [CreateEntry] = 1
	order By
		Number
	
	OPEN @cursor_Name
	FETCH NEXT FROM @cursor_Name INTO @EntryGuid ,@EntryDate ,@FeeAccountGuid ,@EntryNumber ,@Value ,@Note 
	
	WHILE @@FETCH_STATUS = 0
	BEGIN
		--Select @EntryNumber
		if exists(Select * from HEntry where Number = @EntryNumber)
		Set @EntryNumber = 0
		
		if IsNull(@EntryNumber,0) = 0 
		Select @EntryNumber = IsNull(Max([Number]),0)+1 from [Hentry]	

		update LandContractFee set EntryNumber = @EntryNumber where Guid = @EntryGuid
		
		--
		Insert into [HEntry]	
		([Guid],[Number],[SecLvl],[Mark],[Date],[CurrencyGuid],[CurrencyVal],[Note],[ParentKind],[UserGuid],[BranchGuid],[IsPosted])
		Select
			@EntryGuid,
			@EntryNumber,
			@SecLvl,
			@Mark,
			@EntryDate,
			@CurrencyGuid, 
			@CurrencyVal, 
			@Note + ISNULL(@FeeEntryNote,''), 
			25 as [ParentKind], 
			@UserGuid, 
			@BranchGuid, 
			@AutoPostedEntry as [IsPosted]

		Insert into [DEntry]
		([ParentGuid],[Number],[AcGuid],[Debit],[Credit],[CurrencyGuid],[CurrencyVal],[CostGuid],[ObverseAcGuid],[Note])
		Select
			@EntryGuid,
			[Number],
			@CustAccountGuid,
			[Value] as Debit,
			0 as Credit,
			@CurrencyGuid,
			@CurrencyVal,
			Case when @MoveCost = 1 then @CostGuid end,
			[AccountGuid] as [ObverseAcGuid],
			[Note] + ISNULL(@FeeEntryNote,'')
		from
			[LandContractFee]
		where
			Guid = @EntryGuid
		
		Insert into [DEntry]
		([ParentGuid],[Number],[AcGuid],[Debit],[Credit],[CurrencyGuid],[CurrencyVal],[CostGuid],[ObverseAcGuid],[Note])
		Select
			@EntryGuid,
			[Number],
			[AccountGuid],
			0 as Debit,
			[Value] as Credit,
			@CurrencyGuid,
			@CurrencyVal,
			Case when @MoveCostWithFeeCredit = 1 then @CostGuid end,
			@CustAccountGuid as [ObverseAcGuid],
			[Note] + ISNULL(@FeeEntryNote,'')
		from
			[LandContractFee]
		where
			Guid = @EntryGuid

		FETCH NEXT FROM @cursor_Name INTO @EntryGuid ,@EntryDate ,@FeeAccountGuid ,@EntryNumber ,@Value ,@Note 
	
	END
	
	CLOSE @cursor_Name
	DEALLOCATE @cursor_Name

	Select
		*
	FROM 
		LandContractFee
	where
		ParentGuid = @Guid
	order By
		Number


GO

SET ANSI_NULLS, QUOTED_IDENTIFIER ON
GO

Create Procedure [dbo].[PrcApproachLeaveContract]
(	
	@CustGuid uniqueidentifier = 0x0,
	@FlatNo Varchar(256) = '',
	@FloorNo Varchar(256) = '',	
	@FlatKind Varchar(256) = '',	
	@ApartmentType Varchar(256) = '',	
	@Class Varchar(256) = '',	
	@Day Int = 730,
	@All bit = 1,
	@ActiveDate Bit = 0,
	@Date1 DateTime = '2009-1-1',
	@Date2 DateTime = '2010-1-1'

	,@ActiveNote Bit = 0
	,@OperationNote int = 0
	,@RealtyNote  Varchar(256) = '' 
	,@ContractActiveNote Bit = 0
	,@ContractOpNote int = 0
	,@ContractNote  Varchar(256) = '' 

	,@SMS int = 2
)
 
as
	Set NoCount on
	Declare @Check Bit,
			@NotCheck Bit
	Set @Check = 1
	Set @NotCheck = 0

	--  
	if @OperationNote = 0 --
	Set @RealtyNote = '%'+@RealtyNote+'%'
	
	--  
	if @ContractOpNote = 0 --
	Set @ContractNote = '%'+@ContractNote+'%'

	CREATE TABLE #R
	(
		[ContractNo] [varchar](256),
		[BuildingName] [varchar](256),
		[BuildingltnName] [varchar](256),
		[BuildingArName] [varchar](256),
		[No] [varchar](256),
		[FlatKind] [varchar](256),
		[Floor] [varchar](256),
		[CustomerName] [varchar](256),
		[CustomerltnName] [varchar](256),
		[CustomerArName] [varchar](256),
		[CustomerMobile] [varchar](256),
		[FromDate] [datetime],
		[ToDate] [datetime],
		[LeaveDate] [datetime],
		[Datediff] Float,
		[RentAfterDiscount] [float],
		[LeaseKind] [int],
		[Note2] [varchar](1000),
		[AlertPrinted] [bit],
		[AlertPrintedDate] [datetime],
		[AlertPrintedCount] [int],
		[SMSSended] [bit],
		[SMSCount] [int],
		[AlertPrint] [int],
		[Guid] [uniqueidentifier],
		[FlatNote] [varchar](256),
		[ContractNote] [varchar](1000),
		[Bulding_Emirate] [varchar](256),
		[Bulding_Area] [varchar](256),
		[Bulding_Street] [varchar](256),
		[Bulding_BuildingNo] [varchar](256),
		[Bulding_PieceNo] [varchar](256),
		[Bulding_BasinNo] [varchar](256),
		[Bulding_BondType] [varchar](256),
		[Bulding_BondNo] [varchar](256),
		[Bulding_BondDate] [datetime]
	)

	
	--  
	Insert into #R
	Select 
		[ContractNo],
		[B].[Name] as [BuildingName],
		[B].[ltnName] as [BuildingltnName],
		[B].[ArName] as [BuildingArName],
		Case when Isnull([A].[No], '') <> '' then [A].[No] else [S].[No] end as [No],
		Case when Isnull([A].[No], '') <> '' then dbo.SC('') else dbo.SC('') end as [FlatKind],
		Case when Isnull([A].[No], '') <> '' then [A].[FloorNo] else Null end as [Floor],
		[cu].[Name] as [CustomerName],
		[cu].[ltnName] as [CustomerltnName],
		[cu].[arName] as [CustomerArName],
		[cu].[Mobile] as [CustomerMobile],
		[FromDate],
		[ToDate],
		[LeaveDate],
		DateDiff(Day, GetDate(), [LeaveDate]) as [Datediff],
		[L].[Rent] - [L].[DiscountValue] as [RentAfterDiscount],
		[LeaseKind],
		[L].[Note2],
		Case when [R2].[ObjGuid] is null then ( @NotCheck )
			 when [R2].[ObjGuid] is not null  then @Check end as [AlertPrinted],
		[R2].[Date] as [AlertPrintedDate],
		[R3].[Count] as [AlertPrintedCount],

		Case when [SMS2].[ObjGuid] is null then ( @NotCheck )
			 when [SMS2].[ObjGuid] is not null  then @Check end as [SMSSended],
		[SMS3].[Count] as [SMSCount],

		Null as [AlertPrint],
		[L].[Guid]
		,[A].[Note] as [FlatNote]
		,[L].[Note2] as [ContractNote]
		,[B].[Emirate] as [Bulding_Emirate]
		,[B].[Area] as [Bulding_Area]
		,[B].[Street] as [Bulding_Street]
		,[B].[BuildingNo] as [Bulding_BuildingNo]
		,[B].[PieceNo] as [Bulding_PieceNo]
		,[B].[BasinNo] as [Bulding_BasinNo]
		,[B].[BondType] as [Bulding_BondType]
		,[B].[BondNo] as [Bulding_BondNo]
		,[B].[BondDate] as [Bulding_BondDate]
	From
		[vbLeaseApartment] [L]
		inner join [vwBuilding] [B] On [L].[BuildingGuid] = [B].[Guid]
		inner join [Resource] [RS] on [RS].[Guid] = [B].[Guid] and [RS].[Spid] = @@Spid and [RS].[Kind] = 3001
		inner join [Resource] [RS2] on [RS2].[Guid] = [L].[TypeGuid] and [RS2].[Spid] = @@Spid and [RS2].[Kind] = 3002
		inner join [vwCustomer] [cu] on [cu].[Guid] = [L].[CustomerGuid]
		left join [vwApartment] [A] On [A].[Guid] = [L].[ApartmentGuid]
		left join [vwShop] [S] On [S].[Guid] = [L].[ApartmentGuid]
		left join [RepCheck] [R] on [R].[ObjGuid] = [L].[Guid] and [R].[IdReport] = 2
		left join [RepCheck] [R2] on [R2].[ObjGuid] = [L].[Guid] and [R2].[IdReport] = 1
		left join (Select 
						[ObjGuid],
						[IdReport],
						Count(*) as [Count]
					From
						[RepCheckCount] 
					Group By
						[ObjGuid],
						[IdReport]
					)[R3] on [R3].[ObjGuid] = [L].[Guid] and [R3].[IdReport] = 1

		left join [RepSMS] [SMS2] on [SMS2].[ObjGuid] = [L].[Guid] and [SMS2].[IdReport] = 1
		left join (Select 
						[ObjGuid],
						[IdReport],
						Count(*) as [Count]
					From
						[RepSMSCount] 
					Group By
						[ObjGuid],
						[IdReport]
					)[SMS3] on [SMS3].[ObjGuid] = [L].[Guid] and [SMS3].[IdReport] = 1
 	where
 		(Leave = 1)
 		and (DateDiff(Day, GetDate(), [LeaveDate] ) <= @Day or @Day = 0)
 		and (DateDiff(Day, GetDate(), [LeaveDate] ) >= 0 or @ActiveDate = 0)
		and ([L].[LeaveDate] Between @Date1 And @Date2 or @ActiveDate = 0)
 		and ([LeaseKind] = 0 or [LeaseKind] = 1)
 		and ([R].[ObjGuid] is Not Null or @All = 1)
 
 		and (
 				([SMS2].[ObjGuid] is Not Null and @SMS = 0)
 				or ([SMS2].[ObjGuid] is Null and @SMS = 1)
 				or @SMS = 2
 			)
 
  		and ([L].[CustomerGuid] = @CustGuid or @CustGuid = 0x0)
  		and ([A].[No] = @FlatNo or @FlatNo = '')
  		and ([A].[FloorNo] = @FloorNo or @FloorNo = '')
  		and ([A].[FlatKind] = @FlatKind or @FlatKind = '')
  		and ([A].[ApartmentType] = @ApartmentType or @ApartmentType = '')
  		and ([A].[Class] = @Class or @Class = '')
 		and 
 			(
 				[A].[Note] Like @RealtyNote 
 				or @ActiveNote = 0
 			)
 
 		and 
 			(
 				[L].[Note2] Like @ContractNote 
 				or @ContractActiveNote = 0
			)

	Order By 
		[B].[Name],
		DateDiff(Day, GetDate(), [LeaveDate]) desc,
		[ContractNo],
		[LeaveDate]
		
/*
	-- 
	Insert into #R
	Select 
		[ContractNo],
		[B].[Name] as [BuildingName],
		[B].[ltnName] as [BuildingltnName],
		[B].[ArName] as [BuildingArName],
		[A].[No]as [No],
		dbo.SC('') as [FlatKind],
		'' as [Floor],
		[cu].[Name] as [CustomerName],
		[cu].[ltnName] as [CustomerltnName],
		[cu].[arName] as [CustomerArName],
		[cu].[Mobile] as [CustomerMobile],
		[FromDate],
		[ToDate],
		DateDiff(Day, GetDate(), [ToDate]) as [Datediff],
		[L].[Rent] as [RentAfterDiscount],
		[ContractKind],
		[L].[Note2],
		Case when [R2].[ObjGuid] is null then ( @NotCheck )
			 when [R2].[ObjGuid] is not null  then @Check end as [AlertPrinted],
		[R2].[Date] as [AlertPrintedDate],
		[R3].[Count] as [AlertPrintedCount],

		Case when [SMS2].[ObjGuid] is null then ( @NotCheck )
			 when [SMS2].[ObjGuid] is not null  then @Check end as [SMSSended],
		[SMS3].[Count] as [SMSCount],

		Null as [AlertPrint],
		[L].[Guid]
		,[A].[Note] as [FlatNote]
		,[L].[Note2] as [ContractNote]
		,[B].[Emirate] as [Bulding_Emirate]
		,[B].[Area] as [Bulding_Area]
		,[B].[Street] as [Bulding_Street]
		,[B].[BuildingNo] as [Bulding_BuildingNo]
		,[B].[PieceNo] as [Bulding_PieceNo]
		,[B].[BasinNo] as [Bulding_BasinNo]
		,[B].[BondType] as [Bulding_BondType]
		,[B].[BondNo] as [Bulding_BondNo]
		,[B].[BondDate] as [Bulding_BondDate]
	From
		[vbParkingContract] [L]
		inner join [vwBuilding] [B] On [L].[BuildingGuid] = [B].[Guid]
		inner join [Resource] [RS] on [RS].[Guid] = [B].[Guid] and [RS].[Spid] = @@Spid and [RS].[Kind] = 3001
		inner join [Resource] [RS2] on [RS2].[Guid] = [L].[TypeGuid] and [RS2].[Spid] = @@Spid and [RS2].[Kind] = 3002
		inner join [vwCustomer] [cu] on [cu].[Guid] = [L].[CustomerGuid]
		left join [vwParking] [A] On [A].[Guid] = [L].[ParkingGuid]
		left join [RepCheck] [R] on [R].[ObjGuid] = [L].[Guid] and [R].[IdReport] = 2
		left join [RepCheck] [R2] on [R2].[ObjGuid] = [L].[Guid] and [R2].[IdReport] = 1
		left join (Select 
						[ObjGuid],
						[IdReport],
						Count(*) as [Count]
					From
						[RepCheckCount] 
					Group By
						[ObjGuid],
						[IdReport]
					)[R3] on [R3].[ObjGuid] = [L].[Guid] and [R3].[IdReport] = 1

		left join [RepSMS] [SMS2] on [SMS2].[ObjGuid] = [L].[Guid] and [SMS2].[IdReport] = 1
		left join (Select 
						[ObjGuid],
						[IdReport],
						Count(*) as [Count]
					From
						[RepSMSCount] 
					Group By
						[ObjGuid],
						[IdReport]
					)[SMS3] on [SMS3].[ObjGuid] = [L].[Guid] and [SMS3].[IdReport] = 1
 	where
 		(DateDiff(Day, GetDate(), [ToDate]) <= @Day)
 		and (DateDiff(Day, GetDate(), [ToDate]) > 0)
 		and ([ContractKind] = 4)
 		and ([Contractfinish] = 0)
 		and ([R].[ObjGuid] is Not Null or @All = 1)
 
 		and (
 				([SMS2].[ObjGuid] is Not Null and @SMS = 0)
 				or ([SMS2].[ObjGuid] is Null and @SMS = 1)
 				or @SMS = 2
 			)
 
  		and ([L].[CustomerGuid] = @CustGuid or @CustGuid = 0x0)
  		and ([A].[No] = @FlatNo or @FlatNo = '')
  		and ([A].[FloorNo] = @FloorNo or @FloorNo = '')
  		and ([A].[ParkingKind] = @FlatKind or @FlatKind = '')
  		and ([A].[Description] = @ApartmentType or @ApartmentType = '')
  		--and ([A].[Class] = @Class or @Class = '')
 		and 
 			(
 				[A].[Note] Like @RealtyNote 
 				or @ActiveNote = 0
 			)
 
 		and 
 			(
 				[L].[Note2] Like @ContractNote 
 				or @ContractActiveNote = 0
			)

	Order By 
		[B].[Name],
		DateDiff(Day, GetDate(), [ToDate]) desc,
		[ContractNo],
		[ToDate]
*/		
	


	--  
	Insert into #R
	Select 
		[ContractNo],
		'' as [BuildingName],
		'' as [BuildingltnName],
		'' as [BuildingArName],
		[L].[Name]as [No],
		Case when [ContractKind] = 6 or [ContractKind] = 7 then dbo.SC('')
		 when [ContractKind] = 8 or [ContractKind] = 9 then dbo.SC('')
		end 
		as [FlatKind],
		'' as [Floor],
		[cu].[Name] as [CustomerName],
		[cu].[ltnName] as [CustomerltnName],
		[cu].[arName] as [CustomerArName],
		[cu].[Mobile] as [CustomerMobile],
		[FromDate],
		[ToDate],
		[LeaveDate],
		DateDiff(Day, GetDate(), [LeaveDate]) as [Datediff],
		[L].[Rent] as [RentAfterDiscount],
		[ContractKind],
		[L].[Note2],
		Case when [R2].[ObjGuid] is null then ( @NotCheck )
			 when [R2].[ObjGuid] is not null  then @Check end as [AlertPrinted],
		[R2].[Date] as [AlertPrintedDate],
		[R3].[Count] as [AlertPrintedCount],

		Case when [SMS2].[ObjGuid] is null then ( @NotCheck )
			 when [SMS2].[ObjGuid] is not null  then @Check end as [SMSSended],
		[SMS3].[Count] as [SMSCount],

		Null as [AlertPrint],
		[L].[Guid]
		,[L].UnitNote as [FlatNote]
		,[L].[Note2] as [ContractNote]
		,'' as [Bulding_Emirate]
		,'' as [Bulding_Area]
		,'' as [Bulding_Street]
		,'' as [Bulding_BuildingNo]
		,'' as [Bulding_PieceNo]
		,'' as [Bulding_BasinNo]
		,'' as [Bulding_BondType]
		,'' as [Bulding_BondNo]
		,Null as [Bulding_BondDate]
	From
		[vwLandContract] [L]
		inner join [Resource] [RS2] on [RS2].[Guid] = [L].[TypeGuid] and [RS2].[Spid] = @@Spid and [RS2].[Kind] = 3002
		inner join [vwCustomer] [cu] on [cu].[Guid] = [L].[CustomerGuid]
		left join [RepCheck] [R] on [R].[ObjGuid] = [L].[Guid] and [R].[IdReport] = 2
		left join [RepCheck] [R2] on [R2].[ObjGuid] = [L].[Guid] and [R2].[IdReport] = 1
		left join (Select 
						[ObjGuid],
						[IdReport],
						Count(*) as [Count]
					From
						[RepCheckCount] 
					Group By
						[ObjGuid],
						[IdReport]
					)[R3] on [R3].[ObjGuid] = [L].[Guid] and [R3].[IdReport] = 1

		left join [RepSMS] [SMS2] on [SMS2].[ObjGuid] = [L].[Guid] and [SMS2].[IdReport] = 1
		left join (Select 
						[ObjGuid],
						[IdReport],
						Count(*) as [Count]
					From
						[RepSMSCount] 
					Group By
						[ObjGuid],
						[IdReport]
					)[SMS3] on [SMS3].[ObjGuid] = [L].[Guid] and [SMS3].[IdReport] = 1
 	where
 		(Leave = 1)
 		and (DateDiff(Day, GetDate(), [LeaveDate] ) <= @Day or @Day = 0)
 		and (DateDiff(Day, GetDate(), [LeaveDate] ) >= 0 or @ActiveDate = 0)
		and ([L].[LeaveDate] Between @Date1 And @Date2 or @ActiveDate = 0)
 		and ([ContractKind] = 7 or [ContractKind] = 9)
 		and ([Contractfinish] = 0)
 		and ([R].[ObjGuid] is Not Null or @All = 1)
 
 		and (
 				([SMS2].[ObjGuid] is Not Null and @SMS = 0)
 				or ([SMS2].[ObjGuid] is Null and @SMS = 1)
 				or @SMS = 2
 			)
 
  		and ([L].[CustomerGuid] = @CustGuid or @CustGuid = 0x0)
  		and ([L].[Name] = @FlatNo or @FlatNo = '')
 		and 
 			(
 				[L].[UnitNote] Like @RealtyNote 
 				or @ActiveNote = 0
 			)
 
 		and 
 			(
 				[L].[Note2] Like @ContractNote 
 				or @ContractActiveNote = 0
			)

	Order By 
		DateDiff(Day, GetDate(), [LeaveDate]) desc,
		[ContractNo],
		[LeaveDate]

	Select 
		COUNT(*) as [Count],
		SUM([RentAfterDiscount]) as [RentAfterDiscount]
	From
		#R

	Select
		*,
		0 as Operation,
		0 as SMS,
		0 as msgSend
	From
		#R
	Order By
		[BuildingName], 
		[Datediff],
		[ContractNo],
		[LeaveDate]
		

GO

SET ANSI_NULLS, QUOTED_IDENTIFIER ON
GO

Create Procedure [PrcPrintChecksCollection]
(
	@Guid uniqueidentifier = '{75346B1E-EB43-4E30-A7BE-7236F6EC2F5B}',
	@Kind int = 1,
	@Only Varchar(256) = '',
	@OnlyAr Varchar(256) = '',
	@OnlyEn Varchar(256) = ''
)
 
as

	Select
		L.CheckGuid,
		T.Name as [EntryTypeName],
		T.ltnName as [EntryTypeLtnName],
		S.Number as EntryNumber,
		H.Number as MainEntryNumber
	into #LinkEntryType_Checks
	From
		LinkEntryType_Checks L
		inner join Secondary_Entry S on S.Guid = L.EntryGuid
		left join HEntry H on H.Guid = S.Guid
		inner join [EntryType] T on T.Guid = S.TypeGuid
	where
		L.CheckGuid = @Guid
	
	insert into #LinkEntryType_Checks	
	Select Distinct
		L.CheckGuid,
		dbo.SC(' '),
		dbo.SC(' ') as [EntryTypeLtnName],
		H.Number as EntryNumber,
		H.Number as MainEntryNumber	
	From
		LinkEntry_Checks L
		inner join HEntry H on H.Guid = L.EntryGuid
	where
		L.CheckGuid = @Guid
		and L.Kind = 1660+@Kind

	--Select * from #LinkEntryType_Checks
		
	Select 
			[T].[Code] as [TypeCode],
			[T].[Code] as [TypeCode_Number],
			[T].[Code]+CAST(C.Number as Varchar(256)) as [Check_TypeCode_Number],
			[C].[No] as [CheckNo],
			C.Number as [CheckNumber],
			[C].[DueDate] as [CheckDueDate],
			[BuildingName],
			[BuildingArName],
			[BuildingLtnName],
			[C1].[Code] as [DebitAccountCode],
			[C1].[ArName] as [DebitAccountArName],
			[C1].[LtnName] as [DebitAccountLtnName],
			[C2].[Code] as [CreditAccountCode],
			[C2].[ArName] as [CreditAccountArName],
			[C2].[LtnName] as [CreditAccountLtnName],

			[C11].[Code] as [Note_DebitAccountCode],
			[C11].[ArName] as [Note_DebitAccountArName],
			[C11].[LtnName] as [Note_DebitAccountLtnName],
			[C22].[Code] as [Note_CreditAccountCode],
			[C22].[ArName] as [Note_CreditAccountArName],
			[C22].[LtnName] as [Note_CreditAccountLtnName],

			[M].[Code] as [CurrencyArCode],
			[M].[LtnCode] as [CurrencyltnCode],
			[M].[ArName] as [CurrencyArName],
			[M].[LtnName] as [CurrencyltnName],
			@Only as [Only],
			@OnlyAr as [OnlyAr],
			@OnlyEn as [OnlyEn],
			[FlatNo],
			[ContractNo],
			[L].[Rent] as [ContractValue],
			[P].[Date] as [OpDate],
			[P].FinishDate as [FinishDate],
			[C].[Value] as [CheckValue],

			[P].[Finished],
			[P].[ReturnCause],
			[P].FixReturn,
			[P].FixReturnNote,

			[P].[Note] as [OpNote],
			[P].[Commission],
			Case when [p].[Value] <> 0 then ([Commission] * 100) / [p].[Value] end as [CommissionPercent],
			
			[p].[CommNote],
			[C3].[ArName] as [DebitCommissionAccountArName],
			[C3].[LtnName] as [DebitCommissionAccountLtnName],
			[C4].[ArName] as [CreditCommissionAccountArName],
			[C4].[LtnName] as [CreditCommissionAccountLtnName],
			[Emirate],
			[L].[BuildingArea],
			[Suburb],
			[Street],
			[BasinNo],
			[PieceNo],
			[BuildingNo],
			[BondType],
			[BondNo],
			[L].[FlatKind],
			[L].[ApartmentType],
			[Class],
			[FlatArea],
			[FlatAreaunity],
			[C].[beneficiary],
			[C].[BankName],
			[Co1].[Name] as [CostDebit],
			[Co2].[Name] as [CostCredit],
			
			[Delay],
			[DelayNote],
			[DC1].[Code] as [DelayAccountDebitCode],
			[DC1].[ArName] as [DelayAccountDebitArName],
			[DC1].[LtnName] as [DelayAccountDebitLtnName],
			
			[DC2].[Code] as [DelayAccountCreditCode],
			[DC2].[ArName] as [DelayAccountCreditArName],
			[DC2].[LtnName] as [DelayAccountCreditLtnName],
				
			LK.*

	From 
		[ChecksCollection] [P]
		inner join [Checks] [C] on [C].[Guid] = [P].[CheckGuid]
		inner join CheckType T on T.Guid = C.TypeGuid
		left join [vwLeaseApartment] [L] on [C].[ContractGuid] = [L].[Guid]
		inner join [vwaccount] [C1] on [C1].[Guid] = [P].[DebitAccountGuid]
		inner join [vwaccount] [C2] on [C2].[Guid] = [P].[CreditAccountGuid]
		inner join [vwCurrency] [M] on [M].[Guid] = [P].[CurrencyGuid]
		
		left join [vwaccount] [C3] on [C3].[Guid] = [P].[CommAccountGuid]
		left join [vwaccount] [C4] on [C4].[Guid] = [P].[CommAccountCreditGuid]

		left join [vwCost] [Co1] on [Co1].[Guid] = [P].[DebitCostGuid]
		left join [vwCost] [Co2] on [Co2].[Guid] = [P].[CreditCostGuid]
		
		left join [vwaccount] [DC1] on [DC1].[Guid] = [P].[DelayAccountDebitGuid]
		left join [vwaccount] [DC2] on [DC2].[Guid] = [P].[DelayAccountCreditGuid]
		
		inner join [vwaccount] [C11] on [C11].[Guid] = [C].[Account]
		inner join [vwaccount] [C22] on [C22].[Guid] = [C].[ObverseAccount]
		left join #LinkEntryType_Checks LK on Lk.CheckGuid = P.CheckGuid		
		
	where
		[P].[CheckGuid] = @Guid
		and P.Kind = @Kind

GO

SET ANSI_NULLS, QUOTED_IDENTIFIER ON
GO

Create Procedure [dbo].[PrcMatTotalMove]
(
	@GroupGuid uniqueidentifier = 0x0,
	@MatGuid uniqueidentifier = 0x0,
 	@StoreGuid uniqueidentifier = 0x0,
	@CostGuid uniqueidentifier = 0x0,
	@Class Varchar(256) = '',
	@Unit int = 0,
	@BillPost int = 2,
	@ActiveNote Bit = 0,
	@OperationNote int = 0,
	@Note Varchar(256) = '',

	@CurrencyGuid uniqueidentifier = 0x0,
	@CurrencyVal Float = 1,

	@CkDate Bit = 0,
	@Date1 DateTime = '1/1/2007',
	@Date2 DateTime = '1/1/2017'
)
 
as
	if [dbo].[fnIsSQL2005]() = 0 
	begin
		Declare @Ms varchar(255)
		Set @Ms = dbo.SC('    sql 2008  ')
		RAISERROR (@Ms, 16, 1)
		return
	end
	
	Set nocount on

	exec PrcCalcAvgPrice @GroupGuid,
						 @MatGuid,
 						 @StoreGuid,
						 @CostGuid,
						 @Class,
						 @Unit,
						 @BillPost,
						 @CurrencyGuid,
						 @CurrencyVal,
						 @CkDate,
						 @Date1,
						 @Date2,
						 0 --@ShowResult

	exec [dbo].[PrcMatBillsDetail] @GroupGuid ,@MatGuid ,@StoreGuid,@CostGuid,@Class,@Unit,@BillPost,@CurrencyGuid, @Currencyval, @CkDate,@Date1,@Date2	

	--Select * from MatBillsDetail
	
	
	--  
	if @OperationNote = 0 --
	Set @Note = '%'+@Note+'%'
	
	Select 
		[Bu].MatCode,		[Bu].[MatName],		[Bu].[MatLtnName],		[Bu].[GroupName],		[Bu].Unit,		[Bu].unity2,		[Bu].unity3,		Sum(Case when BtInOut = 1 then  [Bu].[Qty] else 0 end) AS QtyIn,
		Sum(Case when BtInOut = 1 then  [Bu].[Qty2] else 0 end) AS QtyIn2,
		Sum(Case when BtInOut = 1 then  [Bu].[Qty3] else 0 end) AS QtyIn3,
		Sum(Case when BtInOut = 1 then  [Bu].[TotalPrice] else 0 end) AS [TotalPriceIn],
		Sum(Case when BtInOut = 1 then  [Bu].[Bonus] else 0 end) AS [BonusIn],
		Sum(Case when BtInOut = 1 then  [Bu].[Discount] else 0 end) AS [DiscountIn],
		Sum(Case when BtInOut = 1 then  [Bu].[Extra] else 0 end) AS [ExtraIn],

		Sum(Case when BtInOut = -1 then  [Bu].[Qty] else 0 end) AS QtyOut,
		Sum(Case when BtInOut = -1 then  [Bu].[Qty2] else 0 end) AS QtyOut2,
		Sum(Case when BtInOut = -1 then  [Bu].[Qty3] else 0 end) AS QtyOut3,
		Sum(Case when BtInOut = -1 then  [Bu].[TotalPrice] else 0 end) AS [TotalPriceOut],
		Sum(Case when BtInOut = -1 then  [Bu].[Bonus] else 0 end) AS [BonusOut],
		Sum(Case when BtInOut = -1 then  [Bu].[Discount] else 0 end) AS [DiscountOut],
		Sum(Case when BtInOut = -1 then  [Bu].[Extra] else 0 end) AS [ExtraOut],

		[Bu].matGuid
	into #MatTotalMove
	From
		MatBillsDetail Bu		
		inner join vwMat mt on mt.Guid = bu.MatGuid
		inner join [Resource] [R] on R.Guid = Bu.TypeGuid and R.Spid = @@Spid and (btInOut = isNull(R.Tag, 0) or isNull(R.Tag, 0) = 0)
	where
 		(
 				([Bu].[BuNote] Like @Note)
 				or ([Bu].[Note] Like @Note)
 				or @ActiveNote = 0
 			)
	Group By
		[Bu].MatCode,		[Bu].[MatName],		[Bu].[MatLtnName],		[Bu].[GroupName],		[Bu].Unit,		[Bu].unity2,		[Bu].unity3,		[Bu].matGuid	
	Select 
		* 
		,
		isNull(QtyIn,0) - isNull(QtyOut,0) as QtyDiff,
		isNull(QtyIn2,0) - isNull(QtyOut2,0) as Qty2Diff,
		isNull(QtyIn3,0) - isNull(QtyOut3,0) as Qty3Diff,
		isNull([TotalPriceIn],0) - isNull([TotalPriceOut],0) as [TotalPriceDiff],
		isNull(BonusIn,0) - isNull(BonusOut,0) as [BonusDiff],
		isNull(DiscountIn,0) - isNull(DiscountOut,0) as [DiscountDiff],
		isNull(ExtraIn,0) - isNull(ExtraOut,0) as [ExtraDiff]
	
	from 
		#MatTotalMove
	order by 
		MatCode
	
	
	--Res2
	Select
		Bu.btName,
		Sum(TotalPrice) as TotalPrice,
		Sum(Case when BuPayType = 1 then TotalPrice else 0 end) as TotalPricePay1,
		Sum(Case when BuPayType = 0 then TotalPrice else 0 end) as TotalPricePay0,
		Sum(Qty) as Qty,
		Sum(Qty2) as Qty2,
		Sum(Qty3) as Qty3,
		Sum(Bonus) as Bonus,
		Sum(Discount) as Discount,
		Sum(Extra) as Extra,
		BtInOut,
		0 as Kind
		into #MatTotalMoveSum
	From
		MatBillsDetail Bu		
		inner join vwMat mt on mt.Guid = bu.MatGuid
		inner join [Resource] [R] on R.Guid = Bu.TypeGuid and R.Spid = @@Spid and (btInOut = isNull(R.Tag, 0) or isNull(R.Tag, 0) = 0)
	where
 		(
 				([Bu].[BuNote] Like @Note)
 				or ([Bu].[Note] Like @Note)
 				or @ActiveNote = 0
 			)
	Group By
		BtInOut,
		Bu.btName
		
	insert into #MatTotalMoveSum
	Select
		dbo.SC(''),
		Sum(TotalPrice * BtInOut) as TotalPrice,
		Sum(TotalPricePay1 * BtInOut),
		Sum(TotalPricePay0 * BtInOut),
		Sum(Qty * BtInOut) as Qty,
		Sum(Qty2 * BtInOut) as Qty2,
		Sum(Qty3 * BtInOut) as Qty3,
		Sum(Bonus * BtInOut) as Bonus,
		Sum(Discount) as Discount,
		Sum(Extra) as Extra,
		0 as  BtInOut,
		1 as Kind
	From
		#MatTotalMoveSum
		
	Select * from #MatTotalMoveSum
	Order by Kind
		
		

GO

SET ANSI_NULLS, QUOTED_IDENTIFIER ON
GO

Create Procedure [PrcReNumberCard]
(
	@Entry Bit = 0,
	@FirstEntryNum int = 0,
	@EntryType Bit = 0,
	@EntryTypeGuid uniqueidentifier = 0x0,
	@FirstEntryTypeNum int = 0,

	@ContractType Bit = 0,
	@ContractTypeGuid uniqueidentifier = 0x0,
	@FirstContractTypeNum int = 0,

	@CheckType Bit = 0,
	@CheckTypeGuid uniqueidentifier = 0x0,
	@FirstCheckTypeNum int = 0,

	@Flat Bit = 0,
	@Shop Bit = 0,
	@Parking Bit = 0,
	@Land Bit = 0,
	@Villa Bit = 0,
	@Account Bit = 1,
	
	@ElectricityBillType Bit = 1,
    @ElectricityBillTypeGuid uniqueidentifier = 0x0,
    @FirstElectricityBillTypeNum int = 0,
    
    @Cust Bit = 1
)
 
as
	Create Table #T
	(
		[Id] int Identity(1,1),
		[Guid] Uniqueidentifier
	)
	Declare @TypeGuid Uniqueidentifier



	-- 
	if @Entry = 1
	exec PrcReNumberHEntry @FirstEntryNum

	--  
	if @EntryType = 1
	begin
			if IsNull(@FirstEntryTypeNum,0) <= 0
			Set @FirstEntryTypeNum = 1
			
			DECLARE cursor_Name CURSOR FAST_FORWARD FOR 
			SELECT [Guid] 
			FROM [EntryType]
			where
				[Guid] = @EntryTypeGuid or @EntryTypeGuid = 0x0
			
			OPEN cursor_Name
			FETCH NEXT FROM cursor_Name INTO @TypeGuid
			
			WHILE @@FETCH_STATUS = 0
			BEGIN
				Truncate Table #T
		
				insert into #T
				([Guid])	
				Select 
					[Guid]
				From
					[Secondary_Entry]
				where 
					[TypeGuid] = @TypeGuid
				Order By
					[Date],[Number]
		
				begin Tran Tr1
				Alter Table [Secondary_Entry] Disable Trigger All

				update 	[Secondary_Entry]
				Set [Number] = [T].[Id] + IsNull(@FirstEntryTypeNum,0) -1
				From
					[Secondary_Entry] [C]
					inner join #T [T] On [T].[Guid] = [C].[Guid]
		
				Alter Table [Secondary_Entry] Enable Trigger All
				commit Tran Tr1
		
			  FETCH NEXT FROM cursor_Name INTO @TypeGuid
			
			END
			
			CLOSE cursor_Name
			DEALLOCATE cursor_Name
	end
	----------------------



	--  
	if @ContractType = 1
	begin
			if IsNull(@FirstContractTypeNum,0) <= 0
			Set @FirstContractTypeNum = 1
			
			DECLARE cursor_Name CURSOR FAST_FORWARD FOR 
			SELECT [Guid] 
			FROM [ContractType]
			where
				[Guid] = @ContractTypeGuid or @ContractTypeGuid = 0x0
			
			OPEN cursor_Name
			FETCH NEXT FROM cursor_Name INTO @TypeGuid
			
			WHILE @@FETCH_STATUS = 0
			BEGIN
				Truncate Table #T
		
				insert into #T
				([Guid])	
				Select 
					[Guid]
				From
					[LeaseApartment]
				where 
					[TypeGuid] = @TypeGuid
				Order By
					[EditDate],[Number]
		
				begin Tran Tr1
				Alter Table [LeaseApartment] Disable Trigger All

				update 	[LeaseApartment]
				Set [Number] = [T].[Id] + IsNull(@FirstContractTypeNum, 0) -1
				From
					[LeaseApartment] [C]
					inner join #T [T] On [T].[Guid] = [C].[Guid]

				Alter Table [LeaseApartment] Enable Trigger All
				commit Tran Tr1
		
		
				Truncate Table #T
		
				insert into #T
				([Guid])	
				Select 
					[Guid]
				From
					[ParkingContract]
				where 
					[TypeGuid] = @TypeGuid
				Order By
					[EditDate],[Number]
		
				begin Tran Tr1
				Alter Table [ParkingContract] Disable Trigger All
				update 	[ParkingContract]
				Set [Number] = [T].[Id]
				From
					[ParkingContract] [C]
					inner join #T [T] On [T].[Guid] = [C].[Guid]
				Alter Table [ParkingContract] Enable Trigger All
				commit Tran Tr1
		
		
				Truncate Table #T
		
				insert into #T
				([Guid])	
				Select 
					[Guid]
				From
					[LandContract]
				where 
					[TypeGuid] = @TypeGuid
				Order By
					[EditDate],[Number]
		
				begin Tran Tr1
				Alter Table [LandContract] Disable Trigger All
				update 	[LandContract]
				Set [Number] = [T].[Id]
				From
					[LandContract] [C]
					inner join #T [T] On [T].[Guid] = [C].[Guid]
				Alter Table [LandContract] Enable Trigger All
				commit Tran Tr1
		
			  FETCH NEXT FROM cursor_Name INTO @TypeGuid
			
			END
			
			CLOSE cursor_Name
			DEALLOCATE cursor_Name
	end
	----------------------

	--   
	if @CheckType = 1
	begin
			DECLARE cursor_Name CURSOR FAST_FORWARD FOR 
			SELECT  [Guid] 
			FROM [CheckType]
			where
				[Guid] = @CheckTypeGuid or @CheckTypeGuid = 0x0
			
			OPEN cursor_Name
			FETCH NEXT FROM cursor_Name INTO @TypeGuid
			
			WHILE @@FETCH_STATUS = 0
			BEGIN
				Truncate Table #T
		
				insert into #T
				([Guid])	
				Select 
					[Guid]
				From
					[Checks]
				where 
					[TypeGuid] = @TypeGuid
				Order By
					[Number]
		
				begin Tran Tr1
				Alter Table [Checks] Disable Trigger All
				update 	[Checks]
				Set [Number] = [T].[Id] +ISNULL(@FirstCheckTypeNum,0) -1
				From
					[Checks] [C]
					inner join #T [T] On [T].[Guid] = [C].[Guid]
				Alter Table [Checks] Enable Trigger All
				commit Tran Tr1
		
		
			  FETCH NEXT FROM cursor_Name INTO @TypeGuid
			
			END
			
			CLOSE cursor_Name
			DEALLOCATE cursor_Name
	end
	----------------------


	-- 
	if @Flat = 1
	begin
			Truncate Table #T
	
			insert into #T
			([Guid])	
			Select 
				[Guid]
			From
				[Apartment]
			Order By
				[Number]
	
			begin Tran Tr1
			Alter Table [Apartment] Disable Trigger All
			update 	[Apartment]
			Set [Number] = [T].[Id]
			From
				[Apartment] [C]
				inner join #T [T] On [T].[Guid] = [C].[Guid]
			Alter Table [Apartment] Enable Trigger All
			commit Tran Tr1
	
	end
	----------------------

	-- 
	if @Shop = 1
	begin
			Truncate Table #T
	
			insert into #T
			([Guid])	
			Select 
				[Guid]
			From
				[Shop]
			Order By
				[Number]
	
			begin Tran Tr1
			Alter Table [Shop] Disable Trigger All
			update 	[Shop]
			Set [Number] = [T].[Id]
			From
				[Shop] [C]
				inner join #T [T] On [T].[Guid] = [C].[Guid]
			Alter Table [Shop] Enable Trigger All
			commit Tran Tr1
	
	end

	-- 
	if @Parking = 1
	begin
			Truncate Table #T
	
			insert into #T
			([Guid])	
			Select 
				[Guid]
			From
				[Parking]
			Order By
				[Number]
	
			begin Tran Tr1
			Alter Table [Parking] Disable Trigger All
			update 	[Parking]
			Set [Number] = [T].[Id]
			From
				[Parking] [C]
				inner join #T [T] On [T].[Guid] = [C].[Guid]
			Alter Table [Parking] Enable Trigger All
			commit Tran Tr1
	
	end


	-- 
	if @Land = 1
	begin
			Truncate Table #T
	
			insert into #T
			([Guid])	
			Select 
				[Guid]
			From
				[Earth]
			Order By
				[Number]
	
			begin Tran Tr1
			Alter Table [Earth] Disable Trigger All
			update 	[Earth]
			Set [Number] = [T].[Id]
			From
				[Earth] [C]
				inner join #T [T] On [T].[Guid] = [C].[Guid]
			Alter Table [Earth] Enable Trigger All
			commit Tran Tr1
	
	end


	-- 
	if @Villa = 1
	begin
			Truncate Table #T
	
			insert into #T
			([Guid])	
			Select 
				[Guid]
			From
				[Villa]
			Order By
				[Number]
	
			begin Tran Tr1
			Alter Table [Villa] Disable Trigger All
			update 	[Villa]
			Set [Number] = [T].[Id]
			From
				[Villa] [C]
				inner join #T [T] On [T].[Guid] = [C].[Guid]
			Alter Table [Villa] Enable Trigger All
			commit Tran Tr1
	
	end

	-- 
	if @Account = 1
	begin
			Truncate Table #T
	
			insert into #T
			([Guid])	
			Select 
				[Guid]
			From
				[Account]
			Order By
				[Code], [Number]
	
			begin Tran Tr1
			Alter Table [Account] Disable Trigger All
			update 	[Account]
			Set [Number] = [T].[Id]
			From
				[Account] [C]
				inner join #T [T] On [T].[Guid] = [C].[Guid]
			Alter Table [Account] Enable Trigger All
			commit Tran Tr1
	
	end

	-- 
	if @Cust = 1
	begin
			Truncate Table #T
	
			insert into #T
			([Guid])	
			Select 
				[Guid]
			From
				[Customer] 
			Order By
				[Number]
	
			begin Tran Tr1
			Alter Table [Customer]  Disable Trigger All
			update 	[Customer] 
			Set [Number] = [T].[Id]
			From
				[Customer]  [C]
				inner join #T [T] On [T].[Guid] = [C].[Guid]
			Alter Table [Account] Enable Trigger All
			commit Tran Tr1
	
	end
	--   
	if @ElectricityBillType = 1
	begin
			if IsNull(@FirstElectricityBillTypeNum,0) <= 0
			Set @FirstElectricityBillTypeNum = 1

			DECLARE cursor_Name CURSOR FAST_FORWARD FOR 
			SELECT  [Guid] 
			FROM ElectricityType
			where
				[Guid] = @ElectricityBillTypeGuid or @ElectricityBillTypeGuid = 0x0
			
			OPEN cursor_Name
			FETCH NEXT FROM cursor_Name INTO @TypeGuid
			
			WHILE @@FETCH_STATUS = 0
			BEGIN
				Truncate Table #T
		
				insert into #T
				([Guid])	
				Select 
					[Guid]
				From
					ElectricityBill
				where 
					[TypeGuid] = @TypeGuid
				Order By
					[Number]
		
				begin Tran Tr1
				Alter Table [ElectricityBill] Disable Trigger All
				update 	[ElectricityBill]
				Set [Number] = [T].[Id] + ISNULL(@FirstElectricityBillTypeNum,0) -1
				From
					[ElectricityBill] [C]
					inner join #T [T] On [T].[Guid] = [C].[Guid]
				Alter Table [ElectricityBill] Enable Trigger All
				commit Tran Tr1
		
			  FETCH NEXT FROM cursor_Name INTO @TypeGuid
			END

			CLOSE cursor_Name
			DEALLOCATE cursor_Name
	end


GO

SET ANSI_NULLS, QUOTED_IDENTIFIER ON
GO

Create Procedure [PrcCreateServicesContractEntry]
(
	@ContractGuid uniqueidentifier = '40CE1320-4AA3-4E22-A225-11FD91C0D15B'
)
 
AS
	Set NoCount on 
	Declare 
			@EnNum int,
			@EnGuid [uniqueidentifier]

	--  
	Select 
		@EnNum = isnull([Number],0)
		,@EnGuid = isnull([Guid],0x0)
	From
		[HEntry]
	where
		[Guid] = @ContractGuid

	if isnull(@EnNum,0) = 0
	begin	
		Select @EnNum = IsNull(Max([Number]),0) + 1 from [HEntry]
	END
	
	if isnull(@EnGuid,0x0) = 0x0
	Set @EnGuid = @ContractGuid

	if Exists(Select Number From HEntry where Number = @EnNum and [Guid] <> @EnGuid)
	Select @EnNum = IsNull(Max([Number]),0) + 1 from [HEntry]

	--   
	Delete
		[HEntry]
	where
		[Guid] = @EnGuid

		
	--return
	DECLARE 
		@EntryDate Datetime,
		@CreateEntry bit,

		@MoveCostWithExpenceDebit bit,
		@MoveCostWithExpenceCredit bit,

		@MoveCostWithDiscountDebit bit,
		@MoveCostWithDiscountCredit bit,

		@SecLvl int,
		@CurrencyGuid uniqueidentifier,
		@CurrencyVal Float,
		@TypeName varchar(256),
		@ContractNumber int,
		@AutoPostedEntry bit,
		@Mark bit,
		@EntryNote Varchar(255),
		@DetailNum Int,

		@Value fLoat,

		@CostGuid uniqueidentifier,
		@CustAccountGuid uniqueidentifier,
		@ExpenceAccountGuid uniqueidentifier,

		@Fromdate datetime,
		@Todate datetime,

		@OtherFeeAccountGuid uniqueidentifier,
		@OtherFee Float,

		@DiscountValue fLoat,
		@DiscountAccountGuid uniqueidentifier,
		@BranchGuid uniqueidentifier
		
	
	SELECT	TOP 1
		@EntryDate = Case when T.EntryDate = 0 then C.FromDate else C.EditDate end,
		@AutoPostedEntry = T.AutoPostedEntry,
		@CreateEntry = T.CreateEntry,
		@MoveCostWithExpenceDebit = T.MoveCostWithExpenceDebit,
		@MoveCostWithExpenceCredit = T.MoveCostWithExpenceCredit,

		@MoveCostWithDiscountDebit = T.MoveCostWithDiscountDebit,
		@MoveCostWithDiscountCredit = T.MoveCostWithDiscountCredit,
		
		@SecLvl = C.SecLvl,
		@CurrencyGuid = C.CurrencyGuid,
		@CurrencyVal = C.CurrencyVal,
		@TypeName = T.Name,
		@ContractNumber = C.Number ,

		@AutoPostedEntry = T.AutoPostedEntry,
		@Mark = C.Mark,

		@CostGuid = C.CostGuid,
		@CustAccountGuid = C.CustAccountGuid,
		@ExpenceAccountGuid = C.ExpenceAccountGuid,
		
		@Fromdate = C.FromDate,
		@Todate = C.ToDate,

		@OtherFee = C.OtherFee,
		@OtherFeeAccountGuid = C.OtherFeeAccountGUID,

		@Value = C.Value,
		@DiscountValue = C.DiscountValue,
		@DiscountAccountGuid = C.DiscountAccountGuid,
		@BranchGuid = C.BranchGuid,
		@EntryNote = [T].[ContractNote]
	FROM
		[vwServicesContract]  C
		inner join [vwServicesContractType] T on T.Guid = C.TypeGuid
	WHERE
		C.Guid = @ContractGuid

	Select 
		@EntryNote  =				REPLACE(REPLACE(REPLACE(REPLACE(REPLACE(
									REPLACE(REPLACE(REPLACE(REPLACE(REPLACE(REPLACE(
									@EntryNote, '[N]', TypeNameAr),
									'[M]', TypeNameLtn),
									'[A]', CustArName),
									'[B]', CustltnName),
									'[D]', BuildingArName),
									'[E]', BuildingLtnName),
									'[F]', dbo.fndate(EditDate)),
									'[G]', dbo.fndate(Fromdate)),
									'[H]', dbo.fndate(Todate)),
									'[K]', ContractNo),
									'[L]', Cast(Value as varchar(50)))
									
	from 
		[vwServicesContract]
	where
		Guid = @ContractGuid
	
	Insert Into [HEntry]
	([Guid],[SecLvl],[Number],[Date], [CurrencyGuid], [CurrencyVal], [Note], [ParentKind], [BranchGuid], [IsPosted], Mark)
	Select
		@EnGuid,
		@SecLvl,
		@EnNum,
		@EntryDate,
		@CurrencyGuid,
		@CurrencyVal,
		@EntryNote as [Note],
		26 as [ParentKind], 
		@BranchGuid as [BranchGuid], 
		@AutoPostedEntry as [IsPosted],
		@Mark

	--				
	if isNull(@Value,0) <> 0
	begin
		Set @DetailNum = 0
		Insert into [DEntry]
 		([ParentGuid],[Number],[AcGuid],[Debit],[Credit],[CurrencyGuid],[CurrencyVal],[CostGuid],[ObverseAcGuid],[Note])
		Select
			@EnGuid,
			@DetailNum,
			@ExpenceAccountGuid,
			@Value as Debit,
			0 as Credit,
			@CurrencyGuid,
			@CurrencyVal,
			Case when @MoveCostWithExpenceDebit = 1 then @CostGuid end,
			@CustAccountGuid,
			@EntryNote

		Set @DetailNum = 1
		Insert into [DEntry]
 		([ParentGuid],[Number],[AcGuid],[Debit],[Credit],[CurrencyGuid],[CurrencyVal],[CostGuid],[ObverseAcGuid],[Note])
		Select
			@EnGuid,
			@DetailNum,
			@CustAccountGuid,
			0 as Debit,
			@Value as Credit,
			@CurrencyGuid,
			@CurrencyVal,
			Case when @MoveCostWithExpenceCredit = 1 then @CostGuid end,
			@ExpenceAccountGuid,
			@EntryNote
	end

	--
	if isNull(@DiscountValue,0) <> 0
	begin
		Set @DetailNum = 3
		Insert into [DEntry]
 		([ParentGuid],[Number],[AcGuid],[Debit],[Credit],[CurrencyGuid],[CurrencyVal],[CostGuid],[ObverseAcGuid],[Note])
		Select
			@EnGuid,
			@DetailNum,
			@CustAccountGuid,
			@DiscountValue as Debit,
			0 as Credit,
			@CurrencyGuid,
			@CurrencyVal,
			Case when @MoveCostWithDiscountDebit = 1 then @CostGuid end,
			@DiscountAccountGuid,
			@EntryNote

		Set @DetailNum = 4
		Insert into [DEntry]
 		([ParentGuid],[Number],[AcGuid],[Debit],[Credit],[CurrencyGuid],[CurrencyVal],[CostGuid],[ObverseAcGuid],[Note])
		Select
			@EnGuid,
			@DetailNum,
			@DiscountAccountGuid,
			0 as Debit,
			@DiscountValue as Credit,
			@CurrencyGuid,
			@CurrencyVal,
			Case when @MoveCostWithDiscountCredit = 1 then @CostGuid end,
			@CustAccountGuid,
			@EntryNote
	end
	exec PrcDoDistributiveEntry @EnGuid
	
	if @AutoPostedEntry = 1
	Update [Hentry] Set IsPosted = 1 where Guid = @EnGuid
	
	--Select * from [Hentry] where Guid = @EnGuid 
	--Select * from [Dentry] where parentGuid = @EnGuid order by number


GO

SET ANSI_NULLS, QUOTED_IDENTIFIER ON
GO
Create Procedure [dbo].[PrcBill_GetMatInventorySummary]
(
	@MatGuid uniqueidentifier = 0x0,
	@StoreGuid uniqueidentifier = 0x0,
	@Unit int = 0,
	@BillPost int = 2,
	@CkDate Bit = 1,
	@Date1 DateTime = '1/1/2007',
	@Date2 DateTime = '1/1/2015'
)
 
as

	CREATE TABLE #MatInventorySummary
	(
		[MatCode] [varchar](256) COLLATE database_default,
		[MatName] [varchar](256) COLLATE database_default,
		[MatltnName] [varchar](256) COLLATE database_default,
		[StCode] [varchar](256) COLLATE database_default,
		[StName] [varchar](256) COLLATE database_default,
		[Qty] [float],
		[Unit] [varchar](256) COLLATE database_default,
		[Qty2] [float],
		[Unity2] [varchar](256) COLLATE database_default,
		[Qty3] [float],
		[Unity3] [varchar](256) COLLATE database_default,
		[BtInOut] [int],
		[MatGuid] [uniqueidentifier],
		[StoreGuid] [uniqueidentifier]
	)

	insert into #MatInventorySummary
	Select 
		[mt].[Code] as MatCode,		[mt].[Name] as [MatName],		[mt].[LtnName] as [MatltnName],				[St].[Code] as [StCode],		[St].[Name] as [StName],		Case when @Unit = 1 then [d].[Qty]
			 when @Unit = 2 then [d].[Qty2]
			 when @Unit = 3 then [d].[Qty3]
			 when @Unit = 0 then 
								Case when mt.[DefUnity] = 1 then [d].[Qty]
									 when mt.[DefUnity] = 2 then [d].[Qty2]
									 when mt.[DefUnity] = 3 then [d].[Qty3]
								end
		end as [Qty],
		Case when @Unit = 1 then mt.[Unity1]
			 when @Unit = 2 then mt.[Unity2]
			 when @Unit = 3 then mt.[Unity3]
			 when @Unit = 0 then 
								Case when mt.[DefUnity] = 1 then mt.[Unity1]
									 when mt.[DefUnity] = 2 then mt.[Unity2]
									 when mt.[DefUnity] = 3 then mt.[Unity3]
								end	
		end as [Unit],
		[d].[Qty2],		mt.[Unity2],		[d].[Qty3],		mt.[Unity3],		BtInOut,		[D].[MatGuid],		[D].[StoreGuid]	From 
		[vwbill] Bu
		inner join [BillDetail] D on d.ParentGuid = buGuid
		inner join [vwMat] mt on mt.Guid = d.MatGuid
		inner join dbo.[fnGetStoreList](@StoreGuid) Sl on Sl.Guid = D.StoreGuid
		inner join [vwStore] [St] on St.Guid = D.StoreGuid
	where
		(d.matGuid = @MatGuid or @MatGuid = 0x0)
		and (
				(BuisPosted = 0 and @BillPost = 0)
				or (BuisPosted = 1 and @BillPost = 1)
				or @BillPost = 2
			)
		and ([BuDate] Between @Date1 And @Date2 or @CkDate = 0)

	-- 
	insert into #MatInventorySummary
	Select 
		[mt].[Code] as MatCode,		[mt].[Name] as [MatName],		[mt].[LtnName] as [MatltnName],				[StCodeIn],		[StNameIn],		Case when @Unit = 1 then [d].[Qty]
			 when @Unit = 2 then [d].[Qty2]
			 when @Unit = 3 then [d].[Qty3]
			 when @Unit = 0 then 
								Case when mt.[DefUnity] = 1 then [d].[Qty]
									 when mt.[DefUnity] = 2 then [d].[Qty2]
									 when mt.[DefUnity] = 3 then [d].[Qty3]
								end
		end as [Qty],
		Case when @Unit = 1 then mt.[Unity1]
			 when @Unit = 2 then mt.[Unity2]
			 when @Unit = 3 then mt.[Unity3]
			 when @Unit = 0 then 
								Case when mt.[DefUnity] = 1 then mt.[Unity1]
									 when mt.[DefUnity] = 2 then mt.[Unity2]
									 when mt.[DefUnity] = 3 then mt.[Unity3]
								end	
		end as [Unit],
		[d].[Qty2],		mt.[Unity2],		[d].[Qty3],		mt.[Unity3],
		1,		[D].[MatGuid],		[BuStoreInGuid]	From 
		[vwTrans] [Bu]
		inner join [TransDetail] [D] on [d].ParentGuid = buGuid
		inner join [vwMat] [mt] on [mt].Guid = [d].[MatGuid]
		inner join dbo.[fnGetStoreList](@StoreGuid) [Sl] on [Sl].Guid = [BuStoreInGuid]
	where
		(d.matGuid = @MatGuid or @MatGuid = 0x0)
		and (
				(BuisPosted = 0 and @BillPost = 0)
				or (BuisPosted = 1 and @BillPost = 1)
				or @BillPost = 2
			)
		and ([BuDate] Between @Date1 And @Date2 or @CkDate = 0)

		
	-- 
	insert into #MatInventorySummary
	Select 
		[mt].[Code] as MatCode,		[mt].[Name] as [MatName],		[mt].[LtnName] as [MatltnName],				[StCodeOut],		[StNameOut],		Case when @Unit = 1 then [d].[Qty]
			 when @Unit = 2 then [d].[Qty2]
			 when @Unit = 3 then [d].[Qty3]
			 when @Unit = 0 then 
								Case when mt.[DefUnity] = 1 then [d].[Qty]
									 when mt.[DefUnity] = 2 then [d].[Qty2]
									 when mt.[DefUnity] = 3 then [d].[Qty3]
								end
		end as [Qty],
		Case when @Unit = 1 then mt.[Unity1]
			 when @Unit = 2 then mt.[Unity2]
			 when @Unit = 3 then mt.[Unity3]
			 when @Unit = 0 then 
								Case when mt.[DefUnity] = 1 then mt.[Unity1]
									 when mt.[DefUnity] = 2 then mt.[Unity2]
									 when mt.[DefUnity] = 3 then mt.[Unity3]
								end	
		end as [Unit],
		[d].[Qty2],		mt.[Unity2],		[d].[Qty3],		mt.[Unity3],		-1,		[D].[MatGuid],		BuStoreOutGuid	From 
		[vwTrans] Bu
		inner join TransDetail D on d.ParentGuid = buGuid
		inner join vwMat mt on mt.Guid = d.MatGuid
		inner join dbo.fnGetStoreList(@StoreGuid) Sl on Sl.Guid = BuStoreOutGuid
	where
		(d.matGuid = @MatGuid or @MatGuid = 0x0)
		and (
				(BuisPosted = 0 and @BillPost = 0)
				or (BuisPosted = 1 and @BillPost = 1)
				or @BillPost = 2
			)
		and ([BuDate] Between @Date1 And @Date2 or @CkDate = 0)

	Select 
		[MatCode],		[MatName],		[MatltnName],		Sum([Qty] * [BtInOut]) as [Qty],
		[Unit],
		Sum([Qty2] * BtInOut) as [Qty2],		[Unity2],		Sum([Qty3] * BtInOut) as [Qty3],		[Unity3],		[MatGuid],		[StoreGuid]	from 
		#MatInventorySummary Mt
	Group By
		[MatCode],
		[matname],
		[unit],
		[unity2],
		[unity3],
		[MatGuid],
		[StoreGuid]

GO

SET ANSI_NULLS, QUOTED_IDENTIFIER ON
GO
Create Procedure [PrcTransferCardDData]
(
	@RoKind int = 2,
	@ToDataBaseName Varchar(256) = 'Q17',
	@UntilDate Datetime = '2016-12-31',
	@BeginDate Datetime = '2017-1-1',
	@RoundContractWithCheckNotCollection bit = 0,
	@RdReNumberSEntry bit = 1
)
 
as
	Set NoCount on
	Declare @V Varchar(8000) 

	insert into DMD_const Select 'InRoundProcess', 'InRoundProcess'
	Set @V = 'insert into '+@ToDataBaseName+'..DMD_const Select ''InRoundProcess'', ''InRoundProcess'''
	exec(@V)
	
	exec PrcSetProgrss '', 100, 0
	
	EXEC PrcDeleteTable 'LogFile',@ToDataBaseName
	EXEC PrcDeleteTable 'Photos',@ToDataBaseName
	EXEC PrcDeleteTable 'Checks',@ToDataBaseName
	EXEC PrcDeleteTable 'ElectricityType',@ToDataBaseName
	EXEC PrcDeleteTable 'CheckType',@ToDataBaseName
	EXEC PrcDeleteTable 'Secondary_EntryDetail',@ToDataBaseName
	EXEC PrcDeleteTable 'Secondary_Entry',@ToDataBaseName
	EXEC PrcDeleteTable 'ReceiptOrderType',@ToDataBaseName
	EXEC PrcDeleteTable 'EntryType',@ToDataBaseName
	EXEC PrcDeleteTable 'EntryDateType',@ToDataBaseName
	EXEC PrcDeleteTable 'HEntry',@ToDataBaseName
	EXEC PrcDeleteTable 'ParkingContract',@ToDataBaseName
	EXEC PrcDeleteTable 'LeaseApartment',@ToDataBaseName
	EXEC PrcDeleteTable 'LandContract',@ToDataBaseName
	EXEC PrcDeleteTable 'ContractType',@ToDataBaseName
	EXEC PrcDeleteTable 'RealtyRestrained',@ToDataBaseName
	EXEC PrcDeleteTable 'wallet',@ToDataBaseName
	EXEC PrcDeleteTable 'Earth',@ToDataBaseName
	EXEC PrcDeleteTable 'Shop',@ToDataBaseName
	EXEC PrcDeleteTable 'parking',@ToDataBaseName
	EXEC PrcDeleteTable 'Apartment',@ToDataBaseName
	EXEC PrcDeleteTable 'MaintenanceOrder',@ToDataBaseName
	EXEC PrcDeleteTable 'Complaint',@ToDataBaseName
	EXEC PrcDeleteTable 'Building',@ToDataBaseName
	EXEC PrcDeleteTable 'Customer',@ToDataBaseName
	EXEC PrcDeleteTable 'LawsuitExpense',@ToDataBaseName
	EXEC PrcDeleteTable 'Lawsuit',@ToDataBaseName
	EXEC PrcDeleteTable 'BillType',@ToDataBaseName
	EXEC PrcDeleteTable 'TransType',@ToDataBaseName
	EXEC PrcDeleteTable 'Store',@ToDataBaseName
	EXEC PrcDeleteTable 'ElectricityType',@ToDataBaseName
	EXEC PrcDeleteTable 'ChangeFlatRent',@ToDataBaseName

	EXEC PrcDeleteTable 'ServicesContract',@ToDataBaseName
	EXEC PrcDeleteTable 'ServicesContractType',@ToDataBaseName

	EXEC PrcDeleteTable 'MaintenanceContract',@ToDataBaseName
	EXEC PrcDeleteTable 'MaintenanceContractType',@ToDataBaseName

	
	--insert into [LogFile] ([Opration]) Select '1'
	
	--EXEC PrcDeleteTable '',@ToDataBaseName
	EXEC PrcDeleteTable 'Account',@ToDataBaseName
	EXEC PrcDeleteTable 'ChangeCurrencyRate',@ToDataBaseName
	
	EXEC PrcDeleteTable 'Mat',@ToDataBaseName
	EXEC PrcDeleteTable 'Currency',@ToDataBaseName
	

	exec PrcSetProgrss ' ', 100, 5

	EXEC PrcTransferTable  'Currency',@ToDataBaseName
	
	EXEC PrcTransferTable  'TableDescription',@ToDataBaseName
	
	EXEC PrcTransferTable  'HjrConfig',@ToDataBaseName
	EXEC PrcTransferTable  'DefaultMenuBank',@ToDataBaseName
	EXEC PrcTransferTable  'DefaultMenuNationality',@ToDataBaseName
	
	EXEC PrcTransferTable  'Branch',@ToDataBaseName

	EXEC PrcTransferTable  'Realty_Users',@ToDataBaseName, '',1
	
	Set @v = 'exec '+@ToDataBaseName+'..prcadduser'
	exec(@V)

	EXEC PrcTransferTable  'Realty_Detail_users',@ToDataBaseName

	EXEC PrcTransferTable  'StrSource',@ToDataBaseName

	EXEC PrcTransferTable  'DMD_const',@ToDataBaseName
	
	--insert into [LogFile] ([Opration]) Select '10'
	
	--  
	Set @V = 'delete '+@ToDataBaseName+'..DMD_const where vName = ''ActiveLogCardUpdate'''
	print @V 
	--exec(@V)

	--  
	Set @V = '
	if Not exists(Select * from '+@ToDataBaseName+'..HEntry where Guid = ''111C583B-8377-1118-111C-111AAE645086'')
	insert into '+@ToDataBaseName+'..[Hentry]
		([Guid], [Number], [SecLvl], [Date], [CurrencyGuid], [CurrencyVal], [Note], [ParentKind], [UserGuid], [BranchGuid], [IsPosted])
	Select
		''111C583B-8377-1118-111C-111AAE645086'', 
		1 as [Number], 
		0 as [SecLvl], 
		0 as [date], 
		(Select Top 1 [Guid] From Currency ) As [CurrencyGuid], 
		1 as [CurrencyVal], 
		'' '' as [Note], 
		0 as [ParentKind], 
		Null as [UserGuid], 
		Null as [BranchGuid],
		1'
	exec(@V)
	
	EXEC PrcTransferTable  'SMSSetup',@ToDataBaseName
	EXEC PrcTransferTable  'SMSInfo',@ToDataBaseName

	EXEC PrcTransferTable  'ExternalTools',@ToDataBaseName

	EXEC PrcTransferTable  'TblShortCut',@ToDataBaseName

	if @RoKind = 0
	EXEC PrcTransferTable  'ChangeCurrencyRate',@ToDataBaseName

	EXEC PrcTransferTable  'Account',@ToDataBaseName
	Set @V = 'exec '+@ToDataBaseName+'..[PrcSetMovingAccount]'
	exec (@V)

	EXEC PrcTransferTable  'AccountDistributive',@ToDataBaseName

	EXEC PrcTransferTable  'AccountAccumulate',@ToDataBaseName

	EXEC PrcTransferTable  'Cost',@ToDataBaseName

	EXEC PrcTransferTable  'EntryType',@ToDataBaseName

	EXEC PrcTransferTable  'EntryTypePrivilege',@ToDataBaseName

	EXEC PrcTransferTable  'EntryDateType',@ToDataBaseName
	EXEC PrcTransferTable  'EntryDateTypePrivilege',@ToDataBaseName

	--insert into [LogFile] ([Opration]) Select '20'

	EXEC PrcTransferTable  'Customer',@ToDataBaseName

	EXEC PrcTransferTable  'RentInfo',@ToDataBaseName

	EXEC PrcTransferTable  'Owner',@ToDataBaseName
	
	EXEC PrcTransferTable  'Building',@ToDataBaseName

	EXEC PrcTransferTable  'Apartment',@ToDataBaseName

	EXEC PrcTransferTable  'AccumulateFlat',@ToDataBaseName

	if @RoKind <> 1
	EXEC PrcTransferTable  'ChangeFlatPrice',@ToDataBaseName

	if @RoKind <> 1
	EXEC PrcTransferTable  'ChangeFlatRent',@ToDataBaseName

	EXEC PrcTransferTable  'Shop',@ToDataBaseName
	if @RoKind <> 1 --    
	EXEC PrcTransferTable  'ChangeShopPrice',@ToDataBaseName

	if @RoKind <> 1 --    
	EXEC PrcTransferTable  'ChangeShopRent',@ToDataBaseName

	EXEC PrcTransferTable  'AccumulateShop',@ToDataBaseName

	EXEC PrcTransferTable  'parking',@ToDataBaseName
	EXEC PrcTransferTable  'Accumulateparking',@ToDataBaseName

	if @RoKind <> 1 --    	--insert into [LogFile] ([Opration]) Select '10'
	EXEC PrcTransferTable  'ChangeParkingPrice',@ToDataBaseName

	if @RoKind <> 1 --    
	EXEC PrcTransferTable  'ChangeParkingRent',@ToDataBaseName

	EXEC PrcTransferTable  'Salesman',@ToDataBaseName
	
	EXEC PrcTransferTable  'ContractType',@ToDataBaseName

	EXEC PrcTransferTable  'ContractTypePrivilege',@ToDataBaseName
	EXEC PrcTransferTable  'ContractTypeFeeAccount',@ToDataBaseName

	--insert into [LogFile] ([Opration]) Select '30'

	exec PrcSetProgrss ' ', 100, 15
	exec [PrcTransfer_LeaseApartment] @RoKind , @ToDataBaseName, @UntilDate, @BeginDate, @RoundContractWithCheckNotCollection

	--insert into [LogFile] ([Opration]) Select '31'
	exec PrcSetProgrss '  ', 100, 20
	exec [PrcTransfer_ParkingContract] @RoKind , @ToDataBaseName, @UntilDate, @BeginDate, @RoundContractWithCheckNotCollection

	--insert into [LogFile] ([Opration]) Select '32'

	EXEC PrcTransferTable  'Earth',@ToDataBaseName
	EXEC PrcTransferTable  'AccumulateLand',@ToDataBaseName

	--insert into [LogFile] ([Opration]) Select '33'
	exec PrcSetProgrss '  ', 100, 25
	exec [PrcTransfer_LandContract] @RoKind , @ToDataBaseName, @UntilDate, @BeginDate, @RoundContractWithCheckNotCollection


	EXEC PrcTransferTable  'CheckType',@ToDataBaseName

	EXEC PrcTransferTable  'CheckTypePrivilege',@ToDataBaseName

	EXEC PrcTransferTable  'AlarmCheckTypeSource',@ToDataBaseName

	--insert into [LogFile] ([Opration]) Select '34'
	exec PrcSetProgrss ' ', 100, 35
	exec [PrcTransfer_Checks] @RoKind , @ToDataBaseName, @UntilDate, @BeginDate, @RoundContractWithCheckNotCollection

	
	exec PrcSetProgrss ' ', 100, 45
	EXEC PrcTransferTable  'Photos',@ToDataBaseName


	exec PrcSetProgrss ' ', 100, 45
	EXEC PrcTransferTable  'ProjectCost',@ToDataBaseName

	EXEC PrcTransferTable  'ProjectCostDetail',@ToDataBaseName

	EXEC PrcTransferTable  'FlatBuilding',@ToDataBaseName

	EXEC PrcTransferTable  'FlatBuildingDetails',@ToDataBaseName

	EXEC PrcTransferTable  'FlatBuildingDetails_2',@ToDataBaseName

	EXEC PrcTransferTable  'FlatBuildingDetails_Office',@ToDataBaseName

	EXEC PrcTransferTable  'FlatBuildingDetails_MBalance',@ToDataBaseName

	EXEC PrcTransferTable  'FlatBuildingDetails_BHouse',@ToDataBaseName

	EXEC PrcTransferTable  'FlatBuildingDetails_Shop',@ToDataBaseName

	EXEC PrcTransferTable  'FlatBuildingDetails_Parking',@ToDataBaseName

	EXEC PrcTransferTable  'BuildingPayType',@ToDataBaseName

	EXEC PrcTransferTable  'BuildingIdentity',@ToDataBaseName

	EXEC PrcTransferTable  'BuildingIdentityDetail',@ToDataBaseName

	EXEC PrcTransferTable  'Term',@ToDataBaseName

	EXEC PrcTransferTable  'RepCheck',@ToDataBaseName

	EXEC PrcTransferTable  'RepCheckCount',@ToDataBaseName

	EXEC PrcTransferTable  'wallet',@ToDataBaseName

	EXEC PrcTransferTable  'Flatwallet',@ToDataBaseName

	EXEC PrcTransferTable  'ShopWallet',@ToDataBaseName

	EXEC PrcTransferTable  'ParkingWallet',@ToDataBaseName

	EXEC PrcTransferTable  'Partnerwallet',@ToDataBaseName

	EXEC PrcTransferTable  'QueryFeature',@ToDataBaseName

	EXEC PrcTransferTable  'PathCustomPrint',@ToDataBaseName

	
	EXEC PrcTransferTable  'ElectricityType',@ToDataBaseName
	
	EXEC PrcTransferTable  'ElectricityTypePrivilege',@ToDataBaseName


	exec PrcSetProgrss '  ', 100, 40
	EXEC PrcTransferTable  'MaintenanceContractType',@ToDataBaseName
	EXEC PrcTransferTable  'MaintenanceContractTypePrivilege',@ToDataBaseName
	exec [PrcTransfer_MaintenanceContract] @RoKind , @ToDataBaseName, @UntilDate, @BeginDate, @RoundContractWithCheckNotCollection


	exec PrcSetProgrss '  ', 100, 55
	EXEC PrcTransferTable  'ServicesContractType',@ToDataBaseName
	EXEC PrcTransferTable  'ServicesContractTypePrivilege',@ToDataBaseName
	exec [PrcTransfer_ServicesContract] @RoKind , @ToDataBaseName, @UntilDate, @BeginDate, @RoundContractWithCheckNotCollection


	exec PrcSetProgrss '  ', 100, 60
	if @RoKind = 0 --    
	EXEC PrcTransferTable  'ElectricityBill',@ToDataBaseName

	EXEC PrcTransferTable  'Villa',@ToDataBaseName

	if @RoKind = 0 --    
	EXEC PrcTransferTable  'ChangeVillaRent',@ToDataBaseName

	if @RoKind = 0 --    
	EXEC PrcTransferTable  'ChangeVillaPrice',@ToDataBaseName

	if @RoKind = 0 --    
	EXEC PrcTransferTable  'Reminder',@ToDataBaseName, 'where Finished = 0'

	if @RoKind = 0 --    
	EXEC PrcTransferTable  'RealtyRestrained',@ToDataBaseName

	--insert into [LogFile] ([Opration]) Select '60'


	exec PrcSetProgrss '  ', 100, 65
	exec [PrcTransfer_Secondary_Entry] @RoKind , @ToDataBaseName, @UntilDate, @BeginDate, @RdReNumberSEntry

	exec PrcSetProgrss ' ', 100, 55
	exec [PrcTransfer_Entry] @RoKind , @ToDataBaseName, @UntilDate, @BeginDate

	-- 
	EXEC PrcTransferTable  'MaintenanceWorker',@ToDataBaseName
	
		--
	Set @V = '
	inner Join '+@ToDataBaseName+'..[Customer] Cu on Cu.Guid = [Tb].[CustGuid]
	inner Join '+@ToDataBaseName+'..[Apartment] P on P.Guid = [Tb].[FlatGuid]
	where
		[ComplaintState] = 0	
	'
	EXEC PrcTransferTable  'Complaint',@ToDataBaseName, @V
	
	Set @V = '
	inner Join '+@ToDataBaseName+'..[Customer] Cu on Cu.Guid = [Tb].[CustGuid]
	inner Join '+@ToDataBaseName+'..[Shop] P on P.Guid = [Tb].[ShopGuid]
	where
		[ComplaintState] = 0	
	'
	EXEC PrcTransferTable  'Complaint',@ToDataBaseName, @V

	Set @V = '
	inner Join '+@ToDataBaseName+'..[Customer] Cu on Cu.Guid = [Tb].[CustGuid]
	inner Join '+@ToDataBaseName+'..[Parking] P on P.Guid = [Tb].[ParkingGuid]
	where
		[ComplaintState] = 0	
	'
	EXEC PrcTransferTable  'Complaint',@ToDataBaseName, @V

	Set @V = '
	inner Join '+@ToDataBaseName+'..[Customer] Cu on Cu.Guid = [Tb].[CustGuid]
	inner Join '+@ToDataBaseName+'..[Villa] P on P.Guid = [Tb].[VillaGuid]
	where
		[ComplaintState] = 0	
	'
	EXEC PrcTransferTable  'Complaint',@ToDataBaseName, @V

	Set @V = '
	inner Join '+@ToDataBaseName+'..[Customer] Cu on Cu.Guid = [Tb].[CustGuid]
	inner Join '+@ToDataBaseName+'..[Earth] P on P.Guid = [Tb].[LandGuid]
	where
		[ComplaintState] = 0
	'
	EXEC PrcTransferTable  'Complaint',@ToDataBaseName, @V


	Set @V = '
	inner Join '+@ToDataBaseName+'..[Customer] Cu on Cu.Guid = [Tb].[CustGuid]
	inner Join '+@ToDataBaseName+'..[Building] P on P.Guid = [Tb].[BuildingGuid]
	where
		[ComplaintState] = 0 and [RealtyKind] = 5
	'
	EXEC PrcTransferTable  'Complaint',@ToDataBaseName, @V
	Set @V = 'exec ReNumberTable '''+@ToDataBaseName+'.dbo.Complaint'''+','+''''+'Number'+''''
	exec(@V)

	Set @V = '
	inner Join '+@ToDataBaseName+'..[Complaint] C on C.Guid = [Tb].[ComplaintGuid]
	'

	Set @V = @V + '
	where [OrderState] = 0'
	if (@RoKind = 2) --    
	Set @V = @V + '
	or StartDate >'+''''+CAST(@UntilDate as varchar(255))+''''
	
	EXEC PrcTransferTable  'MaintenanceOrder',@ToDataBaseName, @V

	Set @V = 'exec ReNumberTable '''+@ToDataBaseName+'.dbo.MaintenanceOrder'''+','+''''+'Number'+''''
	exec(@V)

	--
	Set @V = '
	where [IsEnded] = 0'
	if (@RoKind = 2) --    
	Set @V = @V + '
	or OpenDate >'+''''+CAST(@UntilDate as varchar(255))+''''

	EXEC PrcTransferTable  'lawsuit',@ToDataBaseName, @v
	Set @V = 'exec ReNumberTable '''+@ToDataBaseName+'.dbo.lawsuit'''+','+''''+'Number'+''''
	exec(@V)
	
	Set @V = '
	inner Join '+@ToDataBaseName+'..[Lawsuit] L on L.Guid = [Tb].[ParentGuid]
	'
	EXEC PrcTransferTable  'LawsuitExpense',@ToDataBaseName, @V
	Set @V = 'Update '+@ToDataBaseName+'..[LawsuitExpense] Set IsRounded = 1'
	exec(@V)

	Set @V = '
	inner Join '+@ToDataBaseName+'..[Lawsuit] L on L.Guid = [Tb].[ParentGuid]
	'
	EXEC PrcTransferTable  'LawsuitState',@ToDataBaseName, @V

	exec PrcSetProgrss ' ', 100, 75
	EXEC PrcTransferTable  'MatGroup',@ToDataBaseName
	EXEC PrcTransferTable  'Store',@ToDataBaseName
	
	EXEC PrcTransferTable  'Mat',@ToDataBaseName
	EXEC PrcTransferTable  'MatMinMax',@ToDataBaseName
	EXEC PrcTransferTable  'MatDescription',@ToDataBaseName
	EXEC PrcTransferTable  'MatDescriptionConfig',@ToDataBaseName
	EXEC PrcTransferTable  'MatUnitsPrice',@ToDataBaseName
	
	EXEC PrcTransferTable  'BillType',@ToDataBaseName
	EXEC PrcTransferTable  'BillTypeField',@ToDataBaseName
	EXEC PrcTransferTable  'BillTypePrivilege',@ToDataBaseName
	
	EXEC PrcTransferTable  'TransType',@ToDataBaseName
	EXEC PrcTransferTable  'TransTypeField',@ToDataBaseName
	EXEC PrcTransferTable  'TransTypePrivilege',@ToDataBaseName
	
	EXEC PrcTransferTable  'CalcQty',@ToDataBaseName
	EXEC PrcTransferTable  'QtyGroup',@ToDataBaseName

	EXEC PrcDeleteTable 'ReceiptOrderType',@ToDataBaseName
	
	exec PrcSetProgrss ' ', 100, 85
	Set @V = '
	inner Join '+@ToDataBaseName+'..[EntryType] L on L.Guid = [Tb].[EntryTypeGuid]
	'
	EXEC PrcTransferTable  'ReceiptOrderType',@ToDataBaseName, @V

	Set @V = '
	inner Join '+@ToDataBaseName+'..[ReceiptOrderType] T on T.Guid = [Tb].[ParentGuid]
	inner Join '+@ToDataBaseName+'..[Account] Ac on Ac.Guid = [Tb].[AccountGuid]
	'
	EXEC PrcTransferTable  'ReceiptOrderTypeDetail',@ToDataBaseName, @V
	
	Set @V = '
	inner Join '+@ToDataBaseName+'..[ReceiptOrderType] L on L.Guid = [Tb].[TypeGuid]
	'
	EXEC PrcTransferTable 'ReceiptOrderTypePrivilege',@ToDataBaseName, @V
	
	-- 
	Set @V = '
	inner Join '+@ToDataBaseName+'..[Building] L on L.Guid = [Tb].BuildingGuid
	'
	EXEC PrcTransferTable  'BuildingPrivilege',@ToDataBaseName, @V
	
	exec PrcSetProgrss ' ', 100, 90
	----
	exec PrcTransferCardAsstes 
		@RoKind ,
		@ToDataBaseName ,
		@UntilDate ,
		@BeginDate
	---------

	--   	
	if (@RoKind = 2) --    
	begin
		Set @V = 'delete '+@ToDataBaseName+'..[Resource]'
		exec(@V)
		
		Set @V = '
		insert into '+@ToDataBaseName+'..[Resource]
		([Guid], [Kind])
		Select Guid, 1 from '+@ToDataBaseName+'..[CheckType]'
		exec (@v)

		Set @V = '
		exec '+@ToDataBaseName+'..PrcReCreateCheckEntry 
			@Date1 = 0,
			@Date2 = 0,
			@ActiveDate = 0,
			@Op_Check = 1,
			@Op_Post = 1,
			@Op_Collection = 1,
			@Op_PartCollection = 1,
			@Op_Endorsement = 1,
			@Op_Returned = 1,
			@UpdateCheckwithdefaultaccount = 0
			'
		
		print @v
		exec(@V) 
	end	
	
	exec ('Truncate Table '+@ToDataBaseName+'..'+'[TableNumber]')
	
	exec [PrcReNumberCard]
			1, --@Entry
			0,--FirstEntryNum
			0, --@EntryType
			0x0, --@EntryTypeGuid
			0, --@FirstEntryTypeNum
			0, --@ContractType
			0x0, --@ContractTypeGuid
			0, --@FirstContractTypeNum
			0, --@CheckType
			0x0, --@CheckTypeGuid
			0, --@FirstCheckTypeNum
			1, --@Flat
			1, --@Shop
			1, --@Parking
			1, --@Land
			1, --@Villa
			1, --@Account
			0x0, --@ElectricityBillType
			0x0, --@ElectricityBillTypeGuid
			1 --@Cus
	
	exec PrcSetProgrss '  ', 100, 100
	
	
	Delete DMD_const where Vname = 'InRoundProcess'

	Set @V = 'Delete '+@ToDataBaseName+'..DMD_const where Vname = ''InRoundProcess'''
	exec(@V)
	
	Select 'End' as EndPros
	

GO

SET ANSI_NULLS, QUOTED_IDENTIFIER ON
GO

Create view [vwFlatContractBrief]
 
as
	Select 
		[TypeGuid],
		[EditDate],
		[Mark],
		[ContractNo],
		[T].[Name] as [TypeName],
		[T].[Name]+ ' / ' + Cast([A].[Number] as Varchar(10)) as [ArLeaseKind],
		[B].[Name] as [BuildingName],
		[B].[ArName] as [BuildingArName],
		[B].[LtnName] as [BuildingLtnName],

		[B].[Name] +' '+
		Case when [T].[ContractKind] = 0 then ' '
			 when [T].[ContractKind] = 1 then ' '
			 when [T].[ContractKind] = 2 then ' '
			 when [T].[ContractKind] = 3 then ' ' end
		+' /'+
		Case when Isnull([P].[Guid],0x0) <> 0x0 then isNull([B].[BuildingCode],'') + Isnull([P].[No],P.Number ) 
			 when Isnull([S].[Guid],0x0) <> 0x0 then Isnull([S].[No],S.Number ) 
		 end +'/' 
		as [ApartmentNo],
		[B].[BuildingCode],
		Case when Isnull([P].[No],'') <> '' then [B].[BuildingCode]+[P].[No]
			 when Isnull([S].[No],'') <> '' then [S].[No]
		 end as [FlatNo],
		[P].[FlatKind],
		[T].[ContractKind],
		[T].[ContractKind] as [Leasekind],
		[T].[Name] + Cast([A].[Number] as Varchar(10))  as [Contract], 

		isnull([P].[Guid],0x0) as [ApartmentGuid],
		isnull([S].[Guid],0x0) as [ShopGuid],
		Case when isnull([P].[Guid],0x0) <> 0x0 then [P].[FlatOwner] else [S].[FlatOwner] end as [FlatOwner],
		[Cu].[Name] as [CustName],
		[Cu].[ArName] as [CustArName],
		[Cu].[LtnName] as [CustLtnName],
		[Cu].[Phonejob] as [CustomerPhonejob],
		[Cu].[Mobile] as [CustomerMobile],
		[A].[BuildingGuid],
		[A].[SalesManGuid],
		[A].[Guid],
		[A].[Number],
		[A].[CustomerGuid],
		[A].[ApartmentType],
		[A].[FromDate],
		[A].[ToDate],
		[A].[Rent],
		[A].[RentContractType],
		[A].[MonthlyValue],
		[A].[CurrencyGuid],
		[A].[CurrencyVal],
		[A].[PayType],
		[A].[Note],
		[A].[Note2],
		[A].[Purpose],
		[A].[RevenueAccountGuid],
		[A].[CustAccountGuid],
		[A].[CommissionFromCustPercent],
		[A].[CommissionFromCustValue],
		[A].[AcCommissionFromCustGuid],
		[A].[CommissionFromOwnerPercent],
		[A].[CommissionFromOwnerValue],
		[A].[AcCommissionFromOwnerGuid],
		[A].[ContractFinish],
		[A].[ContractFinishDate],
		[A].[ResultingAmount],
		[A].[Fine],
		[A].[FineAccount],
		[A].[CreateResultingEntry],
		[A].[InsuranceValue],
		[A].[InsuranceValueOld],
		[A].[ContractPrice],
		[A].[AccountContractPrice],
		[A].[CertificatValue],
		[A].[AccountCertificatValue],
		[A].[RentDuration],
		[A].[Rentype],
		[A].[TermsOfPayment],
		[A].[Seclvl],
		[A].[RentInfoGuid],
		[A].[Step1Complete],
		[A].[Step2Complete],
		[A].[Step3Complete],
		[A].[Step4Complete],
		[A].[Step5Complete],
		[A].[Certification],
		[A].[ElectricityInsurance],
		[A].[ResidentCount],
		[A].[CreateContractEntry],
		[A].[Whereabouts],		
		[A].[DiscountPercent],
		[A].[DiscountValue],
		[A].[Rent] - [A].[DiscountValue] as [RentAfterDiscount],	
		[A].[DiscountAccountGuid],
		[Cr].[Code] as [CurrencyName],
		[A].[BranchGuid],
		[A].[ResultingAmount2],
		[A].[RoundKind],

		Case 
			when ([T].[ContractKind] = 0) or ([T].[ContractKind] = 1) then 
				Case 
					when 
						Case when [ContractFinish] = 0 then [ToDate] else [ContractFinishDate] end 
						<= GetDate() then -- 
											Case when [ContractFinish] = 0 then dbo.SC('     ') 
											else
											dbo.SC('    ') end
					when 
						Case when [ContractFinish] = 0 then [ToDate] else [ContractFinishDate] end 
						> GetDate() then dbo.SC(' ') 
				end
			when ([T].[ContractKind] = 2) or ([T].[ContractKind] = 3) then dbo.SC('')
				
		end as [ContractState],

		Case 
			when ([T].[ContractKind] = 0) or ([T].[ContractKind] = 1) then 
				Case 
					when [ContractFinish] = 0 then dbo.SC('') 
					else
					Case 
							when 
								exists(Select 
									Guid
								From 
										LeaseApartment [Q] 
								where 
									[T].[ContractKind] = [T].[ContractKind]
									and [Q].[CustomerGuid] = [A].[CustomerGuid]
									and [Q].[ApartmentGuid] = [A].[ApartmentGuid]
									and [Q].[FromDate] >= [A].[ContractFinishDate]
									and [Q].[Guid] <> [A].[Guid]
								)  then dbo.SC(' ') 
					else
						dbo.SC(' ') 
					end
				end
			when ([T].[ContractKind] = 2) or ([T].[ContractKind] = 3) then ''
		end as [FlatState],
		[A].[Period],
		[p].[FloorNo],

		[B].[Emirate],
		[B].[Area] as [BuildingArea],
		[B].[Suburb],
		[B].[Street],
		[B].[BasinNo],
		[B].[PieceNo],
		[B].[BuildingNo],
		[B].[BondType],
		[B].[BondNo],

		[B].[BankName] as [BuildingBankName],
		[B].[BankAccCode] as [BuildingBankAccCode],

		[P].[Class],
		[P].[Area] as [FlatArea],
		[P].[unity] as [FlatAreaunity],
		[A].[ElectricityCounter],
		[A].[FineRevenueAccountGUID],
		Case when [ContractFinish] = 0 then [ToDate] else [ContractFinishDate]  end as [EndDate],
		[A].[ResultingNote],
		[A].[FineNote],
		[A].[NewState],
		[A].[InsuranceValuePercent],
		[A].[OtherFee],
		[A].[OtherFeeAccountGUID],

		[A].[License1No],
		[A].[License2No],
		[A].[License3No],
		[A].[License1Date1],
		[A].[License2Date1],
		[A].[License3Date1],
		[A].[License1Date2],
		[A].[License2Date2],
		[A].[License3Date2],
		[A].[Ltnwhereabouts],
		[A].[LtnPurpose],
		[A].[LtnRentDuration],
		[A].[LtnRentype],
		[A].[LtnTermsOfPayment],
		[A].[Trademark],

		Case when Isnull([P].[Guid],0x0) <> 0x0 then [P].[CostGuid]
			 when Isnull([S].[Guid],0x0) <> 0x0 then [S].[CostGuid]
		 end as [UnitCostGuid],
		 
		Case when Isnull([P].[Guid],0x0) <> 0x0 then [P].[Judicial]
			 when Isnull([S].[Guid],0x0) <> 0x0 then [S].[Judicial]
		 end as [Judicial],
		[A].[CostGuid],
		[AcCommissionFromCustNote],
		[AcCommissionFromOwnerNote],
		A.[IsRounded],
		[Leave],
		[LeaveDate],
		[CountOldContract],
		A.[InsuranceAccountGuid],
		[A].[AcquittancePrinted],
		[A].[AcquittancePrintDate],
		[A].[Judicial] as [ContractJudicial]
	from 
		[vbLeaseApartment] [A]
		inner join [vwContractType] [T] on [T].[Guid] = [A].[TypeGuid]
		inner join [vwBuilding] [B] On [A].[BuildingGuid] = [B].[Guid]
		left join [Apartment] [P] on [P].[Guid] = [A].[ApartmentGuid]
		left join [Shop] [S] on [S].[Guid] = [A].[ApartmentGuid]
		inner join [vwcustomer] [Cu] On [Cu].[Guid] = [A].[CustomerGuid]
		left join [Currency] [Cr] On [Cr].[Guid] = [A].[CurrencyGuid]


GO

SET ANSI_NULLS, QUOTED_IDENTIFIER ON
GO

Create Procedure [PrcCreateEntryFromParkingContractFee]
(
	@Guid uniqueidentifier = '3ABCD433-FBC1-443A-9B16-4FEC32D137AB',
	@ShoeResult bit = 1
)
 
as
	--Return
	Set noCount on
	
	exec [PrcDeleteEntryContractFee] @Guid
	
	Declare @CreateContractEntry bit
	Select
		@CreateContractEntry = C.CreateContractEntry
	From
		ParkingContract C 
	where
		C.Guid = @Guid
		
	if @CreateContractEntry = 0
	return

	Declare	
		@CustAccountGuid uniqueidentifier, 
		@CostGuid  uniqueidentifier,
		@SecLvl int,
		@Mark bit,
		@CurrencyGuid uniqueidentifier, 
		@CurrencyVal Float, 
		@UserGuid uniqueidentifier, 
		@BranchGuid uniqueidentifier, 
		@AutoPostedEntry bit,
		@MoveCost bit,
		@MoveCostWithFeeCredit bit,
		@FeeEntryNote varchar(255)
	
	Select
		@CustAccountGuid = CustAccountGuid,
		@SecLvl = C.SecLvl,
		@Mark = C.Mark,
		@CurrencyGuid = C.CurrencyGuid, 
		@CurrencyVal = C.CurrencyVal,
		@UserGuid = Null,
		@BranchGuid = C.BranchGuid,
		@AutoPostedEntry = T.AutoPostedEntry,
		@MoveCost = T.MoveCost,
		@MoveCostWithFeeCredit = T.MoveCostWithFeeCredit,
		@CostGuid = C.CostGuid,
		@FeeEntryNote = T.FeeEntryNote
	From
		ParkingContract C 
		inner join ContractType t on t.Guid = C.TypeGuid
	where
		C.Guid = @Guid

	Select 
		@FeeEntryNote  =				REPLACE(REPLACE(REPLACE(REPLACE(REPLACE(REPLACE(
									REPLACE(REPLACE(REPLACE(REPLACE(REPLACE(REPLACE(
									@FeeEntryNote, '[N]', TypeNameAr),
									'[M]', TypeNameLtn),
									'[A]', CustArName),
									'[B]', CustltnName),
									'[C]', FlatNo),
									'[D]', BuildingArName),
									'[E]', BuildingLtnName),
									'[F]', dbo.fndate(EditDate)),
									'[G]', dbo.fndate(Fromdate)),
									'[H]', dbo.fndate(Todate)),
									'[K]', ContractNo),
									'[L]', Cast(Value as varchar(50)))
									
	from 
		[vwAllContract]
	where
		Guid = @Guid

	Declare 
		@EntryGuid uniqueidentifier,
		@EntryDate Datetime,
		@FeeAccountGuid uniqueidentifier,
		@EntryNumber int,
		@Value float,
		@Note varchar(255)
		
	DECLARE @cursor_Name CURSOR 
	Set @cursor_Name = CURSOR FAST_FORWARD FOR 
	SELECT 
		[Guid],
		[Date],
		[AccountGuid],
		[EntryNumber],
		[Value],
		[Note]
	FROM 
		ParkingContractFee
	where
		(ParentGuid = @Guid) and Value <> 0 and [CreateEntry] = 1
	order By
		Number
	
	OPEN @cursor_Name
	FETCH NEXT FROM @cursor_Name INTO @EntryGuid ,@EntryDate ,@FeeAccountGuid ,@EntryNumber ,@Value ,@Note 
	
	WHILE @@FETCH_STATUS = 0
	BEGIN
		--Select @EntryNumber
		if exists(Select * from HEntry where Number = @EntryNumber)
		Set @EntryNumber = 0
		
		if IsNull(@EntryNumber,0) = 0 
		Select @EntryNumber = IsNull(Max([Number]),0)+1 from [Hentry]	

		update ParkingContractFee set EntryNumber = @EntryNumber where Guid = @EntryGuid
		
		--
		Insert into [HEntry]	
		([Guid],[Number],[SecLvl],[Mark],[Date],[CurrencyGuid],[CurrencyVal],[Note],[ParentKind],[UserGuid],[BranchGuid],[IsPosted])
		Select
			@EntryGuid,
			@EntryNumber,
			@SecLvl,
			@Mark,
			@EntryDate,
			@CurrencyGuid, 
			@CurrencyVal, 
			@Note + ISNULL(@FeeEntryNote,''), 
			24 as [ParentKind], 
			@UserGuid, 
			@BranchGuid, 
			@AutoPostedEntry as [IsPosted]

		Insert into [DEntry]
		([ParentGuid],[Number],[AcGuid],[Debit],[Credit],[CurrencyGuid],[CurrencyVal],[CostGuid],[ObverseAcGuid],[Note])
		Select
			@EntryGuid,
			[Number],
			@CustAccountGuid,
			[Value] as Debit,
			0 as Credit,
			@CurrencyGuid,
			@CurrencyVal,
			Case when @MoveCost = 1 then @CostGuid end,
			[AccountGuid] as [ObverseAcGuid],
			[Note] + ISNULL(@FeeEntryNote,'')
		from
			[ParkingContractFee]
		where
			Guid = @EntryGuid
		
		Insert into [DEntry]
		([ParentGuid],[Number],[AcGuid],[Debit],[Credit],[CurrencyGuid],[CurrencyVal],[CostGuid],[ObverseAcGuid],[Note])
		Select
			@EntryGuid,
			[Number],
			[AccountGuid],
			0 as Debit,
			[Value] as Credit,
			@CurrencyGuid,
			@CurrencyVal,
			Case when @MoveCostWithFeeCredit = 1 then @CostGuid end,
			@CustAccountGuid as [ObverseAcGuid],
			[Note] + ISNULL(@FeeEntryNote,'')
		from
			[ParkingContractFee]
		where
			Guid = @EntryGuid

		FETCH NEXT FROM @cursor_Name INTO @EntryGuid ,@EntryDate ,@FeeAccountGuid ,@EntryNumber ,@Value ,@Note 
	
	END
	
	CLOSE @cursor_Name
	DEALLOCATE @cursor_Name

	if @ShoeResult = 1
	Select
		*
	FROM 
		ParkingContractFee
	where
		ParentGuid = @Guid
	order By
		Number


GO

SET ANSI_NULLS, QUOTED_IDENTIFIER ON
GO

Create Procedure [PrcPrintReceiptLawsuit]
(
	@Guid uniqueidentifier = '{FFFD76C1-BE2F-4DF9-8C55-0E0F8BB29DCB}',
	@Only Varchar(256) = '',
	@OnlyAr Varchar(256) = '',
	@OnlyEn Varchar(256) = ''
)
 
as
	Set NoCount On
	--  
	Declare @SumCheck Float, @SumCach Float, @SumPay Float
	
	Select
		@SumCheck = Sum([Value])
	From
		[LinkCheckContract] [C]
		inner join (Select Distinct Guid From [Resource] where [Spid] = @@Spid) [R] on [R].[Guid] = [C].ParentGuid
	where
		[ContractGuid] = @Guid

	Select
		@SumCach = isnull(Sum([Value] * [CurrencyVal]),0)
	From
		vwLawsuitCachPayment [C]
		inner join (Select Distinct Guid From [Resource] where [Spid] = @@Spid) [R] on [R].[Guid] = [C].[Guid]
	where
		[ContractGuid] = @Guid

	Set @SumPay = ISNULL(@SumCheck,0) + ISNULL(@SumCach,0)
	
	Select
		[A].[Number],
		[A].[ContractNo],
		[A].[CustName],
		[A].[CustArName],
		[A].[CustLtnName],
		
		[cu].[Barcode] as [Cust_Barcode], 		[cu].[Name] as [Cust_Name], 		[cu].[LtnName] as [Cust_LtnName], 		[cu].[CardKind] as [Cust_CardKind], 		[cu].[CardKind2] as [Cust_CardKind2], 		[cu].[Nationality] as [Cust_Nationality], 		[cu].[LtnNationality] as [Cust_LtnNationality], 		[cu].[Profession] as [Cust_Profession], 		[cu].[LtnProfession] as [Cust_LtnProfession], 		[cu].[PassportNO] as [Cust_PassportNO], 		[cu].[PassportExpireDate] as [Cust_PassportExpireDate], 		[cu].[Domicile] as [Cust_Domicile], 		[cu].[Security] as [Cust_Security], 		[cu].[LtnSecurity] as [Cust_LtnSecurity], 		[cu].[PhoneJob] as [Cust_PhoneJob], 		[cu].[Mobile] as [Cust_Mobile], 		[cu].[Note] as [Cust_Note], 		[cu].[Trademark] as [Cust_Trademark], 		[cu].[LtnTrademark] as [Cust_LtnTrademark], 		[cu].[MemoSecurity] as [Cust_MemoSecurity], 		[cu].[LtnMemoSecurity] as [Cust_LtnMemoSecurity], 		[cu].[Address] as [Cust_Address], 		[cu].[LtnAddress] as [Cust_LtnAddress], 		[cu].[BoxNo] as [Cust_BoxNo], 		[cu].[PersonalityNo1] as [Cust_PersonalityNo1], 		[cu].[PersonalityNo2] as [Cust_PersonalityNo2], 		[cu].[Fax] as [Cust_Fax], 		[cu].[EMail] as [Cust_EMail], 		[cu].[Adjective] as [Cust_Adjective], 		[cu].[LtnAdjective] as [Cust_LtnAdjective], 		[cu].[CkHideInSearch] as [Cust_CkHideInSearch], 		[cu].[ban] as [Cust_ban], 		[cu].[BankName] as [Cust_BankName], 		[cu].[BankAccCode] as [Cust_BankAccCode], 		[cu].[Birthday] as [Cust_Birthday], 		[cu].[DomicileEndDate] as [Cust_DomicileEndDate], 		[cu].[PersonalityEndDate] as [Cust_PersonalityEndDate], 		[cu].[CustNote1] as [Cust_CustNote1], 		[cu].[CustNote2] as [Cust_CustNote2], 		[cu].[CustNote3] as [Cust_CustNote3], 		[cu].[CustNote4] as [Cust_CustNote4], 		[cu].[CustNote5] as [Cust_CustNote5], 		[cu].[CustNote6] as [Cust_CustNote6], 		[cu].[CustNote7] as [Cust_CustNote7], 		[cu].[banContract] as [Cust_banContract], 
		@SumCheck as [SumCheck],
		@SumCach as [SumCach],
		@SumPay as [SumPay], 
		@Only as [OnlySumCheck], 
		@OnlyAr as [OnlySumCheckAr], 
		@OnlyEn as [OnlySumCheckEn], 
		[A].[EditDate],
		[A].[FromDate],
		[A].[ToDate],
		[A].[BuildingName],
		[A].[BuildingArName],
		[A].[BuildingLtnName],
		[A].[FlatNo],
		[A].[Note2],
		[A].[Rent] as [ContractValue],
		[A].[CurrencyName],
		[A].[DiscountPercent],
		[A].[DiscountValue],
		[A].[InsuranceValueOld],
		[A].[InsuranceValue],
		[A].[InsuranceValuePercent],
		[A].[CommissionFromCustValue],
		[A].[CommissionFromOwnerValue],
		[A].[ElectricityInsurance],
		[A].[ElectricityCounter],
		[A].[ContractPrice],
		[A].[CertificatValue],
		[A].[OtherFee],
		Case when isnull([A].NewState,0) = 0 then dbo.sc('') else dbo.sc('') end as [NewSate],
		Case when isnull([A].NewState,0) = 0 then '' else '' end as [ArNewSate],
		Case when isnull([A].NewState,0) = 0 then 'New' else 'Renewal' end as [LtnNewSate],
		S.Name as [SalesMan]
	From 
		[vwLeaseApartment] A
		left join Salesman S on S.Guid = [A].[SalesManGuid]
		inner join Lawsuit L on L.ContractGuid = A.Guid
		inner join Customer Cu on Cu.Guid = A.CustomerGuid
	where 
		([L].[Guid] = @Guid or @Guid = 0x0)

	Create Table [#Tbl]
	(
		[BankName] Varchar(256),
		[Value] Float,
		[Currency] Varchar(256),
		[No]  Varchar(256),
		[DueDate] DateTime,
		[State] Varchar(256),
		[Note] Varchar(256)
	)

	Insert Into [#Tbl]
	Select
		[BankName],
		Cast([LL].[Value] as Varchar(20)) as [Value],
		[CurrencyName]  as [Currency],
		[No],
		[DueDate],
		Case 		
			when  [C3].[CheckGuid] is not null then dbo.SC('')
			when  [C1].[CheckGuid] is not null then dbo.SC('') 
			when  [C4].[CheckGuid] is not null then dbo.SC(' ') 
			when  [C].[CheckGuid] is not null then dbo.SC('') 
			when  [C2].[CheckGuid] is not null then dbo.SC('') 
		end as [State],
		[P].[Note3]
	From
		[vwChecks] [P]
		inner join [LinkCheckContract] LL on LL.ParentGuid = P.Guid
 		left join [vwChecksCollection] [C] on [C].[CheckGuid] = [P].[Guid] and [C].[Kind] = 0
 		left join [vwChecksCollection] [C1] on [C1].[CheckGuid] = [P].[Guid] and [C1].[Kind] = 1
 		left join [vwChecksCollection] [C2] on [C2].[CheckGuid] = [P].[Guid] and [C2].[Kind] = 2
 		left join [vwChecksCollection] [C3] on [C3].[CheckGuid] = [P].[Guid] and [C3].[Kind] = 3
 		left join [ChecksPartialCollection]  [C4] on [C4].[CheckGuid] = [P].[Guid] and [C3].[Kind] = 3
		inner join (Select Distinct Guid From [Resource] where [Spid] = @@Spid) [R] on [R].[Guid] = [P].[Guid]
	where
		LL.[ContractGuid] = @Guid

	Select * from [#Tbl]
	Order By
		[DueDate], [No]

	Select
		dbo.sc('') as [BankName],
		Cast([Value] as Varchar(20)) as [Value],
		[Currency]  as [Currency],
		'' as [No],
		[Date],
		'' as State,
		[C].[HNote],
		[C].[DNote]
	From
		[vwLawsuitCachPayment] [C]
		inner join (Select Distinct Guid From [Resource] where [Spid] = @@Spid) [R] on [R].[Guid] = [C].[Guid] 
	where
		[ContractGuid] = @Guid
	Order By
		[Number],[DNumber]



GO

SET ANSI_NULLS, QUOTED_IDENTIFIER ON
GO

Create Trigger [TRG_Trace_LandContract]
on [LandContract]
 
for update
As
	SET NOCOUNT ON;
	if Not exists(Select Value from DMD_const where vName = 'ActiveLogCardUpdate' and Value = '1' ) return
	
	Declare @UserGuid uniqueidentifier, @Guid uniqueidentifier
	Set @Guid = NEWID()
	
	Select Top 1 @UserGuid = userGuid From CurrentUsers where Spid = @@SPID
	
		
	insert into [Trace]
	([Guid],[ParentGuid],[Date],[userGuid],[HostName],[ParentTbl])
	Select Top 1
		@Guid,
		N.Guid,
		GETDATE(),
		@UserGuid,
		Host_Name(),
		'LandContract'
	From
		[inserted] n 
		
	insert into [TraceDetail]
	([ParentGuid],[Caption],[Old],[New])
	Select Top 1
		@Guid,
		' ' as [Caption],
		dbo.fndate(D.[EditDate]) as [old],
		dbo.fndate(N.[EditDate]) as [New]
	From
		[deleted] d
		inner join [inserted] n on D.Guid = N.Guid
	where
		N.[EditDate] <> D.[EditDate]


	insert into [TraceDetail]
	([ParentGuid],[Caption],[Old],[New])
	Select Top 1
		@Guid,
		' ' as [Caption],
		D.[SecLvl] as [old],
		N.[SecLvl] as [New]
	From
		[deleted] d
		inner join [inserted] n on D.Guid = N.Guid
	where
		N.[SecLvl] <> D.[SecLvl]

	insert into [TraceDetail]
	([ParentGuid],[Caption],[Old],[New])
	Select Top 1
		@Guid,
		'' as [Caption],
		D.[Mark] as [old],
		N.[Mark] as [New]
	From
		[deleted] d
		inner join [inserted] n on D.Guid = N.Guid
	where
		N.[Mark] <> D.[Mark]

	insert into [TraceDetail]
	([ParentGuid],[Caption],[Old],[New])
	Select Top 1
		@Guid,
		' ' as [Caption],
		D.[TypeGuid] as [old],
		N.[TypeGuid] as [New]
	From
		[deleted] d
		inner join [inserted] n on D.Guid = N.Guid
	where
		N.[TypeGuid] <> D.[TypeGuid]

	insert into [TraceDetail]
	([ParentGuid],[Caption],[Old],[New])
	Select Top 1
		@Guid,
		' ' as [Caption],
		D.[ContractNo] as [old],
		N.[ContractNo] as [New]
	From
		[deleted] d
		inner join [inserted] n on D.Guid = N.Guid
	where
		N.[ContractNo] <> D.[ContractNo]

	insert into [TraceDetail]
	([ParentGuid],[Caption],[Old],[New])
	Select Top 1
		@Guid,
		'' as [Caption],
		D.[CustomerGuid] as [old],
		N.[CustomerGuid] as [New]
	From
		[deleted] d
		inner join [inserted] n on D.Guid = N.Guid
	where
		N.[CustomerGuid] <> D.[CustomerGuid]

	insert into [TraceDetail]
	([ParentGuid],[Caption],[Old],[New])
	Select Top 1
		@Guid,
		'' as [Caption],
		D.[SalesManGuid] as [old],
		N.[SalesManGuid] as [New]
	From
		[deleted] d
		inner join [inserted] n on D.Guid = N.Guid
	where
		N.[SalesManGuid] <> D.[SalesManGuid]

	insert into [TraceDetail]
	([ParentGuid],[Caption],[Old],[New])
	Select Top 1
		@Guid,
		'' as [Caption],
		D.[RentInfoGuid] as [old],
		N.[RentInfoGuid] as [New]
	From
		[deleted] d
		inner join [inserted] n on D.Guid = N.Guid
	where
		N.[RentInfoGuid] <> D.[RentInfoGuid]

	insert into [TraceDetail]
	([ParentGuid],[Caption],[Old],[New])
	Select Top 1
		@Guid,
		'' as [Caption],
		D.[LandGuid] as [old],
		N.[LandGuid] as [New]
	From
		[deleted] d
		inner join [inserted] n on D.Guid = N.Guid
	where
		N.[LandGuid] <> D.[LandGuid]

	insert into [TraceDetail]
	([ParentGuid],[Caption],[Old],[New])
	Select Top 1
		@Guid,
		'' as [Caption],
		D.[VillaGuid] as [old],
		N.[VillaGuid] as [New]
	From
		[deleted] d
		inner join [inserted] n on D.Guid = N.Guid
	where
		N.[VillaGuid] <> D.[VillaGuid]

	insert into [TraceDetail]
	([ParentGuid],[Caption],[Old],[New])
	Select Top 1
		@Guid,
		' ' as [Caption],
		D.[CostGuid] as [old],
		N.[CostGuid] as [New]
	From
		[deleted] d
		inner join [inserted] n on D.Guid = N.Guid
	where
		N.[CostGuid] <> D.[CostGuid]

	insert into [TraceDetail]
	([ParentGuid],[Caption],[Old],[New])
	Select Top 1
		@Guid,
		' ' as [Caption],
		D.[Rent] as [old],
		N.[Rent] as [New]
	From
		[deleted] d
		inner join [inserted] n on D.Guid = N.Guid
	where
		N.[Rent] <> D.[Rent]

	insert into [TraceDetail]
	([ParentGuid],[Caption],[Old],[New])
	Select Top 1
		@Guid,
		'' as [Caption],
		D.[CurrencyGuid] as [old],
		N.[CurrencyGuid] as [New]
	From
		[deleted] d
		inner join [inserted] n on D.Guid = N.Guid
	where
		N.[CurrencyGuid] <> D.[CurrencyGuid]

	insert into [TraceDetail]
	([ParentGuid],[Caption],[Old],[New])
	Select Top 1
		@Guid,
		' ' as [Caption],
		D.[CurrencyVal] as [old],
		N.[CurrencyVal] as [New]
	From
		[deleted] d
		inner join [inserted] n on D.Guid = N.Guid
	where
		N.[CurrencyVal] <> D.[CurrencyVal]

	insert into [TraceDetail]
	([ParentGuid],[Caption],[Old],[New])
	Select Top 1
		@Guid,
		' ' as [Caption],
		D.[PayType] as [old],
		N.[PayType] as [New]
	From
		[deleted] d
		inner join [inserted] n on D.Guid = N.Guid
	where
		N.[PayType] <> D.[PayType]

	insert into [TraceDetail]
	([ParentGuid],[Caption],[Old],[New])
	Select Top 1
		@Guid,
		'' as [Caption],
		LEFT(D.[Note], 255) as [old],
		LEFT(N.[Note], 255) as [New]
	From
		[deleted] d
		inner join [inserted] n on D.Guid = N.Guid
	where
		N.[Note] <> D.[Note]

	insert into [TraceDetail]
	([ParentGuid],[Caption],[Old],[New])
	Select Top 1
		@Guid,
		' 2' as [Caption],
		LEFT(D.[Note2], 255) as [old],
		LEFT(N.[Note2], 255) as [New]
	From
		[deleted] d
		inner join [inserted] n on D.Guid = N.Guid
	where
		N.[Note2] <> D.[Note2]

	insert into [TraceDetail]
	([ParentGuid],[Caption],[Old],[New])
	Select Top 1
		@Guid,
		'  ' as [Caption],
		D.[Purpose] as [old],
		N.[Purpose] as [New]
	From
		[deleted] d
		inner join [inserted] n on D.Guid = N.Guid
	where
		N.[Purpose] <> D.[Purpose]

	insert into [TraceDetail]
	([ParentGuid],[Caption],[Old],[New])
	Select Top 1
		@Guid,
		'' as [Caption],
		D.[NewState] as [old],
		N.[NewState] as [New]
	From
		[deleted] d
		inner join [inserted] n on D.Guid = N.Guid
	where
		N.[NewState] <> D.[NewState]

	insert into [TraceDetail]
	([ParentGuid],[Caption],[Old],[New])
	Select Top 1
		@Guid,
		' ' as [Caption],
		D.[Whereabouts] as [old],
		N.[Whereabouts] as [New]
	From
		[deleted] d
		inner join [inserted] n on D.Guid = N.Guid
	where
		N.[Whereabouts] <> D.[Whereabouts]

	insert into [TraceDetail]
	([ParentGuid],[Caption],[Old],[New])
	Select Top 1
		@Guid,
		' ' as [Caption],
		D.[RevenueAccountGuid] as [old],
		N.[RevenueAccountGuid] as [New]
	From
		[deleted] d
		inner join [inserted] n on D.Guid = N.Guid
	where
		N.[RevenueAccountGuid] <> D.[RevenueAccountGuid]

	insert into [TraceDetail]
	([ParentGuid],[Caption],[Old],[New])
	Select Top 1
		@Guid,
		' ' as [Caption],
		D.[CustAccountGuid] as [old],
		N.[CustAccountGuid] as [New]
	From
		[deleted] d
		inner join [inserted] n on D.Guid = N.Guid
	where
		N.[CustAccountGuid] <> D.[CustAccountGuid]

	insert into [TraceDetail]
	([ParentGuid],[Caption],[Old],[New])
	Select Top 1
		@Guid,
		'   ' as [Caption],
		D.[CommissionFromCustPercent] as [old],
		N.[CommissionFromCustPercent] as [New]
	From
		[deleted] d
		inner join [inserted] n on D.Guid = N.Guid
	where
		N.[CommissionFromCustPercent] <> D.[CommissionFromCustPercent]

	insert into [TraceDetail]
	([ParentGuid],[Caption],[Old],[New])
	Select Top 1
		@Guid,
		'   ' as [Caption],
		D.[CommissionFromCustValue] as [old],
		N.[CommissionFromCustValue] as [New]
	From
		[deleted] d
		inner join [inserted] n on D.Guid = N.Guid
	where
		N.[CommissionFromCustValue] <> D.[CommissionFromCustValue]

	insert into [TraceDetail]
	([ParentGuid],[Caption],[Old],[New])
	Select Top 1
		@Guid,
		'   ' as [Caption],
		D.[AcCommissionFromCustGuid] as [old],
		N.[AcCommissionFromCustGuid] as [New]
	From
		[deleted] d
		inner join [inserted] n on D.Guid = N.Guid
	where
		N.[AcCommissionFromCustGuid] <> D.[AcCommissionFromCustGuid]

	insert into [TraceDetail]
	([ParentGuid],[Caption],[Old],[New])
	Select Top 1
		@Guid,
		'    ' as [Caption],
		D.[CommissionFromOwnerPercent] as [old],
		N.[CommissionFromOwnerPercent] as [New]
	From
		[deleted] d
		inner join [inserted] n on D.Guid = N.Guid
	where
		N.[CommissionFromOwnerPercent] <> D.[CommissionFromOwnerPercent]

	insert into [TraceDetail]
	([ParentGuid],[Caption],[Old],[New])
	Select Top 1
		@Guid,
		'    ' as [Caption],
		D.[CommissionFromOwnerValue] as [old],
		N.[CommissionFromOwnerValue] as [New]
	From
		[deleted] d
		inner join [inserted] n on D.Guid = N.Guid
	where
		N.[CommissionFromOwnerValue] <> D.[CommissionFromOwnerValue]

	insert into [TraceDetail]
	([ParentGuid],[Caption],[Old],[New])
	Select Top 1
		@Guid,
		'    ' as [Caption],
		D.[AcCommissionFromOwnerGuid] as [old],
		N.[AcCommissionFromOwnerGuid] as [New]
	From
		[deleted] d
		inner join [inserted] n on D.Guid = N.Guid
	where
		N.[AcCommissionFromOwnerGuid] <> D.[AcCommissionFromOwnerGuid]

	insert into [TraceDetail]
	([ParentGuid],[Caption],[Old],[New])
	Select Top 1
		@Guid,
		' ' as [Caption],
		D.[CreateContractEntry] as [old],
		N.[CreateContractEntry] as [New]
	From
		[deleted] d
		inner join [inserted] n on D.Guid = N.Guid
	where
		N.[CreateContractEntry] <> D.[CreateContractEntry]

	insert into [TraceDetail]
	([ParentGuid],[Caption],[Old],[New])
	Select Top 1
		@Guid,
		'    ' as [Caption],
		D.[Step1Complete] as [old],
		N.[Step1Complete] as [New]
	From
		[deleted] d
		inner join [inserted] n on D.Guid = N.Guid
	where
		N.[Step1Complete] <> D.[Step1Complete]

	insert into [TraceDetail]
	([ParentGuid],[Caption],[Old],[New])
	Select Top 1
		@Guid,
		'    ' as [Caption],
		D.[Step2Complete] as [old],
		N.[Step2Complete] as [New]
	From
		[deleted] d
		inner join [inserted] n on D.Guid = N.Guid
	where
		N.[Step2Complete] <> D.[Step2Complete]

	insert into [TraceDetail]
	([ParentGuid],[Caption],[Old],[New])
	Select Top 1
		@Guid,
		'    ' as [Caption],
		D.[Step3Complete] as [old],
		N.[Step3Complete] as [New]
	From
		[deleted] d
		inner join [inserted] n on D.Guid = N.Guid
	where
		N.[Step3Complete] <> D.[Step3Complete]

	insert into [TraceDetail]
	([ParentGuid],[Caption],[Old],[New])
	Select Top 1
		@Guid,
		'    ' as [Caption],
		D.[Step4Complete] as [old],
		N.[Step4Complete] as [New]
	From
		[deleted] d
		inner join [inserted] n on D.Guid = N.Guid
	where
		N.[Step4Complete] <> D.[Step4Complete]

	insert into [TraceDetail]
	([ParentGuid],[Caption],[Old],[New])
	Select Top 1
		@Guid,
		' ' as [Caption],
		D.[Certification] as [old],
		N.[Certification] as [New]
	From
		[deleted] d
		inner join [inserted] n on D.Guid = N.Guid
	where
		N.[Certification] <> D.[Certification]

	insert into [TraceDetail]
	([ParentGuid],[Caption],[Old],[New])
	Select Top 1
		@Guid,
		' ' as [Caption],
		D.[DiscountPercent] as [old],
		N.[DiscountPercent] as [New]
	From
		[deleted] d
		inner join [inserted] n on D.Guid = N.Guid
	where
		N.[DiscountPercent] <> D.[DiscountPercent]

	insert into [TraceDetail]
	([ParentGuid],[Caption],[Old],[New])
	Select Top 1
		@Guid,
		' ' as [Caption],
		D.[DiscountValue] as [old],
		N.[DiscountValue] as [New]
	From
		[deleted] d
		inner join [inserted] n on D.Guid = N.Guid
	where
		N.[DiscountValue] <> D.[DiscountValue]

	insert into [TraceDetail]
	([ParentGuid],[Caption],[Old],[New])
	Select Top 1
		@Guid,
		' ' as [Caption],
		D.[DiscountAccountGuid] as [old],
		N.[DiscountAccountGuid] as [New]
	From
		[deleted] d
		inner join [inserted] n on D.Guid = N.Guid
	where
		N.[DiscountAccountGuid] <> D.[DiscountAccountGuid]

	insert into [TraceDetail]
	([ParentGuid],[Caption],[Old],[New])
	Select Top 1
		@Guid,
		'' as [Caption],
		D.[UserGuid] as [old],
		N.[UserGuid] as [New]
	From
		[deleted] d
		inner join [inserted] n on D.Guid = N.Guid
	where
		N.[UserGuid] <> D.[UserGuid]

	insert into [TraceDetail]
	([ParentGuid],[Caption],[Old],[New])
	Select Top 1
		@Guid,
		'' as [Caption],
		D.[BranchGuid] as [old],
		N.[BranchGuid] as [New]
	From
		[deleted] d
		inner join [inserted] n on D.Guid = N.Guid
	where
		N.[BranchGuid] <> D.[BranchGuid]

	insert into [TraceDetail]
	([ParentGuid],[Caption],[Old],[New])
	Select Top 1
		@Guid,
		'  ' as [Caption],
		D.[RentDuration] as [old],
		N.[RentDuration] as [New]
	From
		[deleted] d
		inner join [inserted] n on D.Guid = N.Guid
	where
		N.[RentDuration] <> D.[RentDuration]

	insert into [TraceDetail]
	([ParentGuid],[Caption],[Old],[New])
	Select Top 1
		@Guid,
		'   / ' as [Caption],
		D.[Rentype] as [old],
		N.[Rentype] as [New]
	From
		[deleted] d
		inner join [inserted] n on D.Guid = N.Guid
	where
		N.[Rentype] <> D.[Rentype]

	insert into [TraceDetail]
	([ParentGuid],[Caption],[Old],[New])
	Select Top 1
		@Guid,
		'  ' as [Caption],
		D.[TermsOfPayment] as [old],
		N.[TermsOfPayment] as [New]
	From
		[deleted] d
		inner join [inserted] n on D.Guid = N.Guid
	where
		N.[TermsOfPayment] <> D.[TermsOfPayment]

	insert into [TraceDetail]
	([ParentGuid],[Caption],[Old],[New])
	Select Top 1
		@Guid,
		'  ' as [Caption],
		D.[InsuranceValuePercent] as [old],
		N.[InsuranceValuePercent] as [New]
	From
		[deleted] d
		inner join [inserted] n on D.Guid = N.Guid
	where
		N.[InsuranceValuePercent] <> D.[InsuranceValuePercent]

	insert into [TraceDetail]
	([ParentGuid],[Caption],[Old],[New])
	Select Top 1
		@Guid,
		'  ' as [Caption],
		D.[InsuranceValue] as [old],
		N.[InsuranceValue] as [New]
	From
		[deleted] d
		inner join [inserted] n on D.Guid = N.Guid
	where
		N.[InsuranceValue] <> D.[InsuranceValue]

	insert into [TraceDetail]
	([ParentGuid],[Caption],[Old],[New])
	Select Top 1
		@Guid,
		'  ' as [Caption],
		D.[InsuranceValueOld] as [old],
		N.[InsuranceValueOld] as [New]
	From
		[deleted] d
		inner join [inserted] n on D.Guid = N.Guid
	where
		N.[InsuranceValueOld] <> D.[InsuranceValueOld]

	insert into [TraceDetail]
	([ParentGuid],[Caption],[Old],[New])
	Select Top 1
		@Guid,
		' ' as [Caption],
		D.[ContractPrice] as [old],
		N.[ContractPrice] as [New]
	From
		[deleted] d
		inner join [inserted] n on D.Guid = N.Guid
	where
		N.[ContractPrice] <> D.[ContractPrice]

	insert into [TraceDetail]
	([ParentGuid],[Caption],[Old],[New])
	Select Top 1
		@Guid,
		' ' as [Caption],
		D.[CertificatValue] as [old],
		N.[CertificatValue] as [New]
	From
		[deleted] d
		inner join [inserted] n on D.Guid = N.Guid
	where
		N.[CertificatValue] <> D.[CertificatValue]

	insert into [TraceDetail]
	([ParentGuid],[Caption],[Old],[New])
	Select Top 1
		@Guid,
		' ' as [Caption],
		D.[ElectricityInsurance] as [old],
		N.[ElectricityInsurance] as [New]
	From
		[deleted] d
		inner join [inserted] n on D.Guid = N.Guid
	where
		N.[ElectricityInsurance] <> D.[ElectricityInsurance]

	insert into [TraceDetail]
	([ParentGuid],[Caption],[Old],[New])
	Select Top 1
		@Guid,
		'  ' as [Caption],
		D.[ElectricityCounter] as [old],
		N.[ElectricityCounter] as [New]
	From
		[deleted] d
		inner join [inserted] n on D.Guid = N.Guid
	where
		N.[ElectricityCounter] <> D.[ElectricityCounter]

	insert into [TraceDetail]
	([ParentGuid],[Caption],[Old],[New])
	Select Top 1
		@Guid,
		' ' as [Caption],
		dbo.fndate(D.[FromDate]) as [old],
		dbo.fndate(N.[FromDate]) as [New]
	From
		[deleted] d
		inner join [inserted] n on D.Guid = N.Guid
	where
		N.[FromDate] <> D.[FromDate]

	insert into [TraceDetail]
	([ParentGuid],[Caption],[Old],[New])
	Select Top 1
		@Guid,
		' ' as [Caption],
		dbo.fndate(D.[ToDate]) as [old],
		dbo.fndate(N.[ToDate]) as [New]
	From
		[deleted] d
		inner join [inserted] n on D.Guid = N.Guid
	where
		N.[ToDate] <> D.[ToDate]

	insert into [TraceDetail]
	([ParentGuid],[Caption],[Old],[New])
	Select Top 1
		@Guid,
		'' as [Caption],
		D.[Period] as [old],
		N.[Period] as [New]
	From
		[deleted] d
		inner join [inserted] n on D.Guid = N.Guid
	where
		N.[Period] <> D.[Period]

	insert into [TraceDetail]
	([ParentGuid],[Caption],[Old],[New])
	Select Top 1
		@Guid,
		' ' as [Caption],
		D.[OtherFee] as [old],
		N.[OtherFee] as [New]
	From
		[deleted] d
		inner join [inserted] n on D.Guid = N.Guid
	where
		N.[OtherFee] <> D.[OtherFee]

	insert into [TraceDetail]
	([ParentGuid],[Caption],[Old],[New])
	Select Top 1
		@Guid,
		'  ' as [Caption],
		D.[OtherFeeAccountGUID] as [old],
		N.[OtherFeeAccountGUID] as [New]
	From
		[deleted] d
		inner join [inserted] n on D.Guid = N.Guid
	where
		N.[OtherFeeAccountGUID] <> D.[OtherFeeAccountGUID]

	insert into [TraceDetail]
	([ParentGuid],[Caption],[Old],[New])
	Select Top 1
		@Guid,
		' ' as [Caption],
		D.[ContractFinish] as [old],
		N.[ContractFinish] as [New]
	From
		[deleted] d
		inner join [inserted] n on D.Guid = N.Guid
	where
		N.[ContractFinish] <> D.[ContractFinish]

	insert into [TraceDetail]
	([ParentGuid],[Caption],[Old],[New])
	Select Top 1
		@Guid,
		' ' as [Caption],
		dbo.fndate(D.[ContractFinishDate]) as [old],
		dbo.fndate(N.[ContractFinishDate]) as [New]
	From
		[deleted] d
		inner join [inserted] n on D.Guid = N.Guid
	where
		N.[ContractFinishDate] <> D.[ContractFinishDate]

	insert into [TraceDetail]
	([ParentGuid],[Caption],[Old],[New])
	Select Top 1
		@Guid,
		'   ' as [Caption],
		D.[ResultingAmount2] as [old],
		N.[ResultingAmount2] as [New]
	From
		[deleted] d
		inner join [inserted] n on D.Guid = N.Guid
	where
		N.[ResultingAmount2] <> D.[ResultingAmount2]

	insert into [TraceDetail]
	([ParentGuid],[Caption],[Old],[New])
	Select Top 1
		@Guid,
		'    / ' as [Caption],
		D.[ResultingAmount] as [old],
		N.[ResultingAmount] as [New]
	From
		[deleted] d
		inner join [inserted] n on D.Guid = N.Guid
	where
		N.[ResultingAmount] <> D.[ResultingAmount]

	insert into [TraceDetail]
	([ParentGuid],[Caption],[Old],[New])
	Select Top 1
		@Guid,
		' ' as [Caption],
		D.[FineRevenueAccountGUID] as [old],
		N.[FineRevenueAccountGUID] as [New]
	From
		[deleted] d
		inner join [inserted] n on D.Guid = N.Guid
	where
		N.[FineRevenueAccountGUID] <> D.[FineRevenueAccountGUID]

	insert into [TraceDetail]
	([ParentGuid],[Caption],[Old],[New])
	Select Top 1
		@Guid,
		' ' as [Caption],
		D.[ResultingNote] as [old],
		N.[ResultingNote] as [New]
	From
		[deleted] d
		inner join [inserted] n on D.Guid = N.Guid
	where
		N.[ResultingNote] <> D.[ResultingNote]

	insert into [TraceDetail]
	([ParentGuid],[Caption],[Old],[New])
	Select Top 1
		@Guid,
		'' as [Caption],
		D.[Fine] as [old],
		N.[Fine] as [New]
	From
		[deleted] d
		inner join [inserted] n on D.Guid = N.Guid
	where
		N.[Fine] <> D.[Fine]

	insert into [TraceDetail]
	([ParentGuid],[Caption],[Old],[New])
	Select Top 1
		@Guid,
		'  ' as [Caption],
		D.[FineAccount] as [old],
		N.[FineAccount] as [New]
	From
		[deleted] d
		inner join [inserted] n on D.Guid = N.Guid
	where
		N.[FineAccount] <> D.[FineAccount]

	insert into [TraceDetail]
	([ParentGuid],[Caption],[Old],[New])
	Select Top 1
		@Guid,
		' ' as [Caption],
		D.[FineNote] as [old],
		N.[FineNote] as [New]
	From
		[deleted] d
		inner join [inserted] n on D.Guid = N.Guid
	where
		N.[FineNote] <> D.[FineNote]

	insert into [TraceDetail]
	([ParentGuid],[Caption],[Old],[New])
	Select Top 1
		@Guid,
		'  ' as [Caption],
		D.[CreateResultingEntry] as [old],
		N.[CreateResultingEntry] as [New]
	From
		[deleted] d
		inner join [inserted] n on D.Guid = N.Guid
	where
		N.[CreateResultingEntry] <> D.[CreateResultingEntry]

	insert into [TraceDetail]
	([ParentGuid],[Caption],[Old],[New])
	Select Top 1
		@Guid,
		'   ' as [Caption],
		D.[AccountContractPrice] as [old],
		N.[AccountContractPrice] as [New]
	From
		[deleted] d
		inner join [inserted] n on D.Guid = N.Guid
	where
		N.[AccountContractPrice] <> D.[AccountContractPrice]

	insert into [TraceDetail]
	([ParentGuid],[Caption],[Old],[New])
	Select Top 1
		@Guid,
		'   ' as [Caption],
		D.[AccountCertificatValue] as [old],
		N.[AccountCertificatValue] as [New]
	From
		[deleted] d
		inner join [inserted] n on D.Guid = N.Guid
	where
		N.[AccountCertificatValue] <> D.[AccountCertificatValue]

	insert into [TraceDetail]
	([ParentGuid],[Caption],[Old],[New])
	Select Top 1
		@Guid,
		'  ' as [Caption],
		D.[License1No] as [old],
		N.[License1No] as [New]
	From
		[deleted] d
		inner join [inserted] n on D.Guid = N.Guid
	where
		N.[License1No] <> D.[License1No]

	insert into [TraceDetail]
	([ParentGuid],[Caption],[Old],[New])
	Select Top 1
		@Guid,
		' ' as [Caption],
		D.[License2No] as [old],
		N.[License2No] as [New]
	From
		[deleted] d
		inner join [inserted] n on D.Guid = N.Guid
	where
		N.[License2No] <> D.[License2No]

	insert into [TraceDetail]
	([ParentGuid],[Caption],[Old],[New])
	Select Top 1
		@Guid,
		'   ' as [Caption],
		D.[License3No] as [old],
		N.[License3No] as [New]
	From
		[deleted] d
		inner join [inserted] n on D.Guid = N.Guid
	where
		N.[License3No] <> D.[License3No]

	insert into [TraceDetail]
	([ParentGuid],[Caption],[Old],[New])
	Select Top 1
		@Guid,
		'License1Date1' as [Caption],
		dbo.fndate(D.[License1Date1]) as [old],
		dbo.fndate(N.[License1Date1]) as [New]
	From
		[deleted] d
		inner join [inserted] n on D.Guid = N.Guid
	where
		N.[License1Date1] <> D.[License1Date1]

	insert into [TraceDetail]
	([ParentGuid],[Caption],[Old],[New])
	Select Top 1
		@Guid,
		'License2Date1' as [Caption],
		dbo.fndate(D.[License2Date1]) as [old],
		dbo.fndate(N.[License2Date1]) as [New]
	From
		[deleted] d
		inner join [inserted] n on D.Guid = N.Guid
	where
		N.[License2Date1] <> D.[License2Date1]

	insert into [TraceDetail]
	([ParentGuid],[Caption],[Old],[New])
	Select Top 1
		@Guid,
		'License3Date1' as [Caption],
		dbo.fndate(D.[License3Date1]) as [old],
		dbo.fndate(N.[License3Date1]) as [New]
	From
		[deleted] d
		inner join [inserted] n on D.Guid = N.Guid
	where
		N.[License3Date1] <> D.[License3Date1]

	insert into [TraceDetail]
	([ParentGuid],[Caption],[Old],[New])
	Select Top 1
		@Guid,
		'License1Date2' as [Caption],
		dbo.fndate(D.[License1Date2]) as [old],
		dbo.fndate(N.[License1Date2]) as [New]
	From
		[deleted] d
		inner join [inserted] n on D.Guid = N.Guid
	where
		N.[License1Date2] <> D.[License1Date2]

	insert into [TraceDetail]
	([ParentGuid],[Caption],[Old],[New])
	Select Top 1
		@Guid,
		'License2Date2' as [Caption],
		dbo.fndate(D.[License2Date2]) as [old],
		dbo.fndate(N.[License2Date2]) as [New]
	From
		[deleted] d
		inner join [inserted] n on D.Guid = N.Guid
	where
		N.[License2Date2] <> D.[License2Date2]

	insert into [TraceDetail]
	([ParentGuid],[Caption],[Old],[New])
	Select Top 1
		@Guid,
		'License3Date2' as [Caption],
		dbo.fndate(D.[License3Date2]) as [old],
		dbo.fndate(N.[License3Date2]) as [New]
	From
		[deleted] d
		inner join [inserted] n on D.Guid = N.Guid
	where
		N.[License3Date2] <> D.[License3Date2]

	insert into [TraceDetail]
	([ParentGuid],[Caption],[Old],[New])
	Select Top 1
		@Guid,
		'Ltnwhereabouts' as [Caption],
		D.[Ltnwhereabouts] as [old],
		N.[Ltnwhereabouts] as [New]
	From
		[deleted] d
		inner join [inserted] n on D.Guid = N.Guid
	where
		N.[Ltnwhereabouts] <> D.[Ltnwhereabouts]

	insert into [TraceDetail]
	([ParentGuid],[Caption],[Old],[New])
	Select Top 1
		@Guid,
		'   ' as [Caption],
		D.[LtnPurpose] as [old],
		N.[LtnPurpose] as [New]
	From
		[deleted] d
		inner join [inserted] n on D.Guid = N.Guid
	where
		N.[LtnPurpose] <> D.[LtnPurpose]

	insert into [TraceDetail]
	([ParentGuid],[Caption],[Old],[New])
	Select Top 1
		@Guid,
		'   ' as [Caption],
		D.[LtnRentDuration] as [old],
		N.[LtnRentDuration] as [New]
	From
		[deleted] d
		inner join [inserted] n on D.Guid = N.Guid
	where
		N.[LtnRentDuration] <> D.[LtnRentDuration]

	insert into [TraceDetail]
	([ParentGuid],[Caption],[Old],[New])
	Select Top 1
		@Guid,
		'   /  ' as [Caption],
		D.[LtnRentype] as [old],
		N.[LtnRentype] as [New]
	From
		[deleted] d
		inner join [inserted] n on D.Guid = N.Guid
	where
		N.[LtnRentype] <> D.[LtnRentype]

	insert into [TraceDetail]
	([ParentGuid],[Caption],[Old],[New])
	Select Top 1
		@Guid,
		'   ' as [Caption],
		D.[LtnTermsOfPayment] as [old],
		N.[LtnTermsOfPayment] as [New]
	From
		[deleted] d
		inner join [inserted] n on D.Guid = N.Guid
	where
		N.[LtnTermsOfPayment] <> D.[LtnTermsOfPayment]

	insert into [TraceDetail]
	([ParentGuid],[Caption],[Old],[New])
	Select Top 1
		@Guid,
		' ' as [Caption],
		D.[IsRounded] as [old],
		N.[IsRounded] as [New]
	From
		[deleted] d
		inner join [inserted] n on D.Guid = N.Guid
	where
		N.[IsRounded] <> D.[IsRounded]

	insert into [TraceDetail]
	([ParentGuid],[Caption],[Old],[New])
	Select Top 1
		@Guid,
		' ' as [Caption],
		D.[Leave] as [old],
		N.[Leave] as [New]
	From
		[deleted] d
		inner join [inserted] n on D.Guid = N.Guid
	where
		N.[Leave] <> D.[Leave]

	insert into [TraceDetail]
	([ParentGuid],[Caption],[Old],[New])
	Select Top 1
		@Guid,
		' ' as [Caption],
		dbo.fndate(D.[LeaveDate]) as [old],
		dbo.fndate(N.[LeaveDate]) as [New]
	From
		[deleted] d
		inner join [inserted] n on D.Guid = N.Guid
	where
		N.[LeaveDate] <> D.[LeaveDate]

	insert into [TraceDetail]
	([ParentGuid],[Caption],[Old],[New])
	Select Top 1
		@Guid,
		'      ' as [Caption],
		D.[Step5Complete] as [old],
		N.[Step5Complete] as [New]
	From
		[deleted] d
		inner join [inserted] n on D.Guid = N.Guid
	where
		N.[Step5Complete] <> D.[Step5Complete]

	insert into [TraceDetail]
	([ParentGuid],[Caption],[Old],[New])
	Select Top 1
		@Guid,
		'   ' as [Caption],
		D.[AcquittancePrinted] as [old],
		N.[AcquittancePrinted] as [New]
	From
		[deleted] d
		inner join [inserted] n on D.Guid = N.Guid
	where
		N.[AcquittancePrinted] <> D.[AcquittancePrinted]

	insert into [TraceDetail]
	([ParentGuid],[Caption],[Old],[New])
	Select Top 1
		@Guid,
		'' as [Caption],
		D.[Judicial] as [old],
		N.[Judicial] as [New]
	From
		[deleted] d
		inner join [inserted] n on D.Guid = N.Guid
	where
		N.[Judicial] <> D.[Judicial]

	insert into [TraceDetail]
	([ParentGuid],[Caption],[Old],[New])
	Select Top 1
		@Guid,
		'   ' as [Caption],
		dbo.fndate(D.[AcquittancePrintDate]) as [old],
		dbo.fndate(N.[AcquittancePrintDate]) as [New]
	From
		[deleted] d
		inner join [inserted] n on D.Guid = N.Guid
	where
		N.[AcquittancePrintDate] <> D.[AcquittancePrintDate]

	insert into [TraceDetail]
	([ParentGuid],[Caption],[Old],[New])
	Select Top 1
		@Guid,
		' ' as [Caption],
		D.[Trademark] as [old],
		N.[Trademark] as [New]
	From
		[deleted] d
		inner join [inserted] n on D.Guid = N.Guid
	where
		N.[Trademark] <> D.[Trademark]

	insert into [TraceDetail]
	([ParentGuid],[Caption],[Old],[New])
	Select Top 1
		@Guid,
		'AcquittancePrintedByGuid' as [Caption],
		D.[AcquittancePrintedByGuid] as [old],
		N.[AcquittancePrintedByGuid] as [New]
	From
		[deleted] d
		inner join [inserted] n on D.Guid = N.Guid
	where
		N.[AcquittancePrintedByGuid] <> D.[AcquittancePrintedByGuid]

	insert into [TraceDetail]
	([ParentGuid],[Caption],[Old],[New])
	Select Top 1
		@Guid,
		'   ' as [Caption],
		D.[AddValue] as [old],
		N.[AddValue] as [New]
	From
		[deleted] d
		inner join [inserted] n on D.Guid = N.Guid
	where
		N.[AddValue] <> D.[AddValue]

	delete Trace From Trace t left join [TraceDetail] D on T.guid = D.ParentGuid
	where
		d.ParentGuid is Null and t.Guid = @Guid


GO

SET ANSI_NULLS, QUOTED_IDENTIFIER ON
GO

Create Procedure [dbo].[PrcElectricityBill]
(
	@CustGuid uniqueidentifier = 0x0,
	@FlatGuid uniqueidentifier = 0x0,
	@ShopGuid uniqueidentifier = 0x0,
	@Value1 Float = 0,
	@Value2 Float = 0,
	@Mark Bit = 1,
	@NotMark Bit = 1,
	@ShowBalancedBill bit = 1,
	@Collect int = 2,
	@LastOnly bit = 1,
	@activeDate bit = 0,
	@Date1 DateTime = '1/1/2007',
	@Date2 DateTime = '1/1/2008'
)

as

	Select 
		T.Name as [TypeName],
		B.Name as [BuildingName],
		Cu.Name as CustName,
		E.[ElecCounterNo],
		A.FlatNo,
		E.Date,
		E.[OldCounter],
		E.[Counter],
		E.[Counter] - E.[OldCounter] as [Qty],
		E.[Consumption],		

		E.[WOldCounter],
		E.[WCounter],
		E.[WCounter] - E.[WOldCounter] as [WQty],
		E.[WaterValue],
		
		E.[DrainageValue],
		E.[FineValue],
		E.[FeeValue],
		E.[Discount],
		E.[Extra],
		E.[Overdue],
		E.[TotalValue],
		
		CAST(0 as Float) AS CheckValue,
		CAST(0 as Float) AS CachValue,
		CAST(0 as Float) AS CollectValue,
		CAST(0 as Float) AS RestValue,
		
		E.isCollect,
		
		E.[Guid],
		E.[ContractGuid],

		[cu].[Barcode] as [Cust_Barcode], 		[cu].[LtnName] as [Cust_LtnName], 		[cu].[CardKind] as [Cust_CardKind], 		[cu].[CardKind2] as [Cust_CardKind2], 		[cu].[Nationality] as [Cust_Nationality], 		[cu].[LtnNationality] as [Cust_LtnNationality], 		[cu].[Profession] as [Cust_Profession], 		[cu].[LtnProfession] as [Cust_LtnProfession], 		[cu].[PassportNO] as [Cust_PassportNO], 		[cu].[PassportExpireDate] as [Cust_PassportExpireDate], 		[cu].[Domicile] as [Cust_Domicile], 		[cu].[Security] as [Cust_Security], 		[cu].[LtnSecurity] as [Cust_LtnSecurity], 		[cu].[PhoneJob] as [Cust_PhoneJob], 		[cu].[Mobile] as [Cust_Mobile], 		[cu].[Note] as [Cust_Note], 		[cu].[Trademark] as [Cust_Trademark], 		[cu].[LtnTrademark] as [Cust_LtnTrademark], 		[cu].[MemoSecurity] as [Cust_MemoSecurity], 		[cu].[LtnMemoSecurity] as [Cust_LtnMemoSecurity], 		[cu].[Address] as [Cust_Address], 		[cu].[LtnAddress] as [Cust_LtnAddress], 		[cu].[BoxNo] as [Cust_BoxNo], 		[cu].[PersonalityNo1] as [Cust_PersonalityNo1], 		[cu].[PersonalityNo2] as [Cust_PersonalityNo2], 		[cu].[Fax] as [Cust_Fax], 		[cu].[EMail] as [Cust_EMail], 		[cu].[Adjective] as [Cust_Adjective], 		[cu].[LtnAdjective] as [Cust_LtnAdjective], 		[cu].[CkHideInSearch] as [Cust_CkHideInSearch], 		[cu].[ban] as [Cust_ban], 		[cu].[BankName] as [Cust_BankName], 		[cu].[BankAccCode] as [Cust_BankAccCode], 		[cu].[Birthday] as [Cust_Birthday], 		[cu].[DomicileEndDate] as [Cust_DomicileEndDate], 		[cu].[PersonalityEndDate] as [Cust_PersonalityEndDate], 		[cu].[CustNote1] as [Cust_CustNote1], 		[cu].[CustNote2] as [Cust_CustNote2], 		[cu].[CustNote3] as [Cust_CustNote3], 		[cu].[CustNote4] as [Cust_CustNote4], 		[cu].[CustNote5] as [Cust_CustNote5], 		[cu].[CustNote6] as [Cust_CustNote6], 		[cu].[CustNote7] as [Cust_CustNote7], 		[cu].[banContract] as [Cust_banContract], 
		[Cu].[AccountBalance] as [Cust_AccountBalance],

		[A].[Number] as [Contract_Number],
		[A].[ContractNo]  as [Contract_ContractNo],
		[A].[EditDate]  as [Contract_EditDate],
		[A].[FromDate]  as [Contract_FromDate],
		[A].[ToDate]  as [Contract_ToDate],
		[A].[ContractDays]  as [Contract_ContractDays],
		[A].[ContractDaysDifference]  as [Contract_ContractDaysDifference],
		[A].[BuildingArName]  as [Contract_BuildingArName],
		[A].[BuildingLtnName]  as [Contract_BuildingLtnName],
		[A].[FlatNo]  as [Contract_FlatNo],
		[A].[Note2]  as [Contract_Note2],
		[A].[Rent] as [ContractValue],
		[A].[DiscountPercent] As [Contract_DiscountPercent],
		[A].[DiscountValue] As [Contract_DiscountValue],
		[A].[Rent] - [A].[DiscountValue] as [RentAfterDiscount],
		[A].[MonthlyValue]   as [Contract_MonthlyValue],
		[A].[MonthlyValue] * 12.00 as [Contract_YearValue],
		[A].[CurrencyName]  as [Contract_CurrencyName],
		[A].[InsuranceValueOld]  as [Contract_InsuranceValueOld],
		[A].[InsuranceValue]  as [Contract_InsuranceValue],
		[A].[InsuranceValuePercent]  as [Contract_InsuranceValuePercent],
		[A].[CommissionFromCustValue]  as [Contract_CommissionFromCustValue],
		[A].[CommissionFromOwnerValue]  as [Contract_CommissionFromOwnerValue],
		[A].[ElectricityInsurance]  as [Contract_ElectricityInsurance],
		[A].[ElectricityCounter]  as [Contract_ElectricityCounter],
		[A].[ContractPrice]  as [Contract_ContractPrice],
		[A].[CertificatValue]  as [Contract_CertificatValue],
		[A].[OtherFee]  as [Contract_OtherFee],
		[A].[FlatKind] as [Contract_FlatKin],
		[A].[ApartmentType]  as [Contract_ApartmentType],
		[A].[NewStateStr]  as [Contract_NewStateStr],
		Case when isnull([A].FlatOwner,0) = 0 then dbo.sc('') else dbo.sc(' ') end  as [Contract_FlatOwnerStr],
		[A].[Purpose]  as [Contract_Purpose],
		[A].[ResidentCount]  as [Contract_ResidentCount],
		[A].[Trademark]  as [Contract_Trademark],
		[A].[whereabouts]  as [Contract_whereabouts],
		[A].[RentDuration]  as [Contract_RentDuration],
		[A].[LtnRentDuration]  as [Contract_LtnRentDuration],
		[A].[Rentype]  as [Contract_Rentype],
		[A].[LtnRentype]  as [Contract_LtnRentype],
		[A].[TermsOfPayment]  as [Contract_TermsOfPayment],
		[A].[LtnTermsOfPayment]  as [Contract_LtnTermsOfPayment],

		0 as [Sort]
	into #Elc
	From 
		[ElectricityBill] E
		inner join [ElectricityType] T on T.Guid = E.TypeGuid
		inner join vwBuilding B on B.Guid = E.BuildingGuid
		inner join vwCustomer Cu on Cu.Guid = E.CustGuid
		inner join [vwLeaseApartment] A on A.Guid = E.contractGuid
		inner join [Resource] R on R.Guid = B.Guid and R.kind = 1 and Spid = @@spid
	where
		(E.CustGuid = @CustGuid or @CustGuid = 0x0)
		and (E.FlatGuid = @FlatGuid or @FlatGuid = 0x0)
		and (E.ShopGuid = @ShopGuid or @ShopGuid = 0x0)
		and (E.TotalValue between @Value1 and @Value2 or @Value2 = 0) 
		and (E.TotalValue = @Value1 or @Value2 <> 0 or @Value1 = 0) 
		and (
				([E].[Mark] = 1 and @Mark = 1)
				or ([E].[Mark] = 0 and @NotMark = 1)
			)
		and (E.date Between @Date1 and 	@Date2 or @activeDate = 0)
		and (
				isNull(E.isCollect,0) = @Collect or @Collect = 2
			)
		
	-- -----------------

	Select 
		LL.ContractGuid,
		SUM(LL.Value) as Value 
	into #Elc_Check
	from 
		Checks S
		inner join [LinkCheckContract] LL on LL.ParentGuid = S.Guid
		inner join #elc E on LL.ContractGuid = E.Guid
	Group by 
		LL.ContractGuid
			
	update 
		#elc
	Set 
		Checkvalue = C.Value
	From
		#elc E
		inner join #Elc_Check C on C.ContractGuid = E.Guid
		
	------------------------------------------ 
	Select 
		C.ContractGuid, 
		SUM(C.Value) as Value 
	into #Elc_Cach
	from 
		#elc E
		inner join vwElectricityCachPayment C on C.ContractGuid = E.Guid
	Group by 
		C.ContractGuid
		
	update 
		#elc
	Set 
		Cachvalue = C.Value
	From
		#elc E
		inner join #Elc_Cach C on C.ContractGuid = E.Guid

	----- ----------------------------------
	---------- 
	update 
		#elc
	Set 
		CollectValue = Cachvalue + CheckValue,
		RestValue = Totalvalue - (Cachvalue + CheckValue) 
	-------------------------------------	

	--if @ShowBalancedBill = 0
	--Delete #Elc where RestValue = 0
	
	CREATE INDEX IX_ElcRep_Sort ON #Elc (TypeName, buildingName, CustName, FlatNo,Date)
	
	Alter Table #Elc add id int identity(1,1)
	
	Select 
		Max(id) as id
	into #LastID
	From
		#Elc
	Group By
		ContractGuid
	Order By
		id
		
	
	insert into #Elc
	([TypeName],[Qty],[Consumption],[WaterValue],[DrainageValue],[FineValue],[FeeValue],[Discount],[Extra],[Overdue],[TotalValue],
		CheckValue,CachValue,CollectValue,RestValue,[Sort],[Guid],[ContractGuid])
	Select 
		dbo.SC('') as [TypeName],
		Sum([Qty]),
		Sum([Consumption]),
		Sum([WaterValue]),
		Sum([DrainageValue]),
		Sum([FineValue]),
		Sum([FeeValue]),
		Sum([Discount]),
		Sum([Extra]),
		Sum([Overdue]),
		Sum([TotalValue]),

		Sum(CheckValue),
		Sum(CachValue),
		Sum(CollectValue),
		Sum(RestValue),

		1 as [Sort],
		0x0,
		0x0
	From 
		#Elc E
		inner join #LastID L on L.id = E.id
		
	Select 
		E.*,
		Case when L.id is Not Null then 1 else 0 end as [IsLast]
	from 
		#Elc E
		left join #LastID L on L.id = E.id
	where
		(L.id is Not Null or @LastOnly = 0 or Sort = 1)
	Order By
		Sort, id
		
	

GO

SET ANSI_NULLS, QUOTED_IDENTIFIER ON
GO

Create Trigger [TRG_Trace_ParkingContract]
on [ParkingContract]
 
for update
As
	SET NOCOUNT ON;

	if Not exists(Select Value from DMD_const where vName = 'ActiveLogCardUpdate' and Value = '1' ) return
	
	Declare @UserGuid uniqueidentifier, @Guid uniqueidentifier
	Set @Guid = NEWID()
	
	Select Top 1 @UserGuid = userGuid From CurrentUsers where Spid = @@SPID
			
	insert into [Trace]
	([Guid],[ParentGuid],[Date],[userGuid],[HostName],[ParentTbl])
	Select Top 1
		@Guid,
		N.Guid,
		GETDATE(),
		@UserGuid,
		Host_Name(),
		'ParkingContract'
	From
		[inserted] n 
		
		
	insert into [TraceDetail]
	([ParentGuid],[Caption],[Old],[New])
	Select Top 1
		@Guid,
		' ' as [Caption],
		D.[SecLvl] as [old],
		N.[SecLvl] as [New]
	From
		[deleted] d
		inner join [inserted] n on D.Guid = N.Guid
	where
		N.[SecLvl] <> D.[SecLvl]
		
	insert into [TraceDetail]
	([ParentGuid],[Caption],[Old],[New])
	Select Top 1
		@Guid,
		'' as [Caption],
		D.[Mark] as [old],
		N.[Mark] as [New]
	From
		[deleted] d
		inner join [inserted] n on D.Guid = N.Guid
	where
		N.[Mark] <> D.[Mark]
		
	insert into [TraceDetail]
	([ParentGuid],[Caption],[Old],[New])
	Select Top 1
		@Guid,
		' ' as [Caption],
		dbo.fndate(D.[EditDate]) as [old],
		dbo.fndate(N.[EditDate]) as [New]
	From
		[deleted] d
		inner join [inserted] n on D.Guid = N.Guid
	where
		N.[EditDate] <> D.[EditDate]
		
	insert into [TraceDetail]
	([ParentGuid],[Caption],[Old],[New])
	Select Top 1
		@Guid,
		' ' as [Caption],
		D.[TypeGuid] as [old],
		N.[TypeGuid] as [New]
	From
		[deleted] d
		inner join [inserted] n on D.Guid = N.Guid
	where
		N.[TypeGuid] <> D.[TypeGuid]
		
		
	insert into [TraceDetail]
	([ParentGuid],[Caption],[Old],[New])
	Select Top 1
		@Guid,
		' ' as [Caption],
		D.[ContractNo] as [old],
		N.[ContractNo] as [New]
	From
		[deleted] d
		inner join [inserted] n on D.Guid = N.Guid
	where
		N.[ContractNo] <> D.[ContractNo]
		
	insert into [TraceDetail]
	([ParentGuid],[Caption],[Old],[New])
	Select Top 1
		@Guid,
		'' as [Caption],
		D.[CustomerGuid] as [old],
		N.[CustomerGuid] as [New]
	From
		[deleted] d
		inner join [inserted] n on D.Guid = N.Guid
	where
		N.[CustomerGuid] <> D.[CustomerGuid]
		
	insert into [TraceDetail]
	([ParentGuid],[Caption],[Old],[New])
	Select Top 1
		@Guid,
		'' as [Caption],
		D.[BuildingGuid] as [old],
		N.[BuildingGuid] as [New]
	From
		[deleted] d
		inner join [inserted] n on D.Guid = N.Guid
	where
		N.[BuildingGuid] <> D.[BuildingGuid]
		
	insert into [TraceDetail]
	([ParentGuid],[Caption],[Old],[New])
	Select Top 1
		@Guid,
		'' as [Caption],
		D.[ParkingGuid] as [old],
		N.[ParkingGuid] as [New]
	From
		[deleted] d
		inner join [inserted] n on D.Guid = N.Guid
	where
		N.[ParkingGuid] <> D.[ParkingGuid]
		
	insert into [TraceDetail]
	([ParentGuid],[Caption],[Old],[New])
	Select Top 1
		@Guid,
		' ' as [Caption],
		D.[CostGuid] as [old],
		N.[CostGuid] as [New]
	From
		[deleted] d
		inner join [inserted] n on D.Guid = N.Guid
	where
		N.[CostGuid] <> D.[CostGuid]
		
	insert into [TraceDetail]
	([ParentGuid],[Caption],[Old],[New])
	Select Top 1
		@Guid,
		'' as [Caption],
		D.[RentInfoGuid] as [old],
		N.[RentInfoGuid] as [New]
	From
		[deleted] d
		inner join [inserted] n on D.Guid = N.Guid
	where
		N.[RentInfoGuid] <> D.[RentInfoGuid]
		
	insert into [TraceDetail]
	([ParentGuid],[Caption],[Old],[New])
	Select Top 1
		@Guid,
		'' as [Caption],
		D.[SalesManGuid] as [old],
		N.[SalesManGuid] as [New]
	From
		[deleted] d
		inner join [inserted] n on D.Guid = N.Guid
	where
		N.[SalesManGuid] <> D.[SalesManGuid]
		
	insert into [TraceDetail]
	([ParentGuid],[Caption],[Old],[New])
	Select Top 1
		@Guid,
		' ' as [Caption],
		D.[FlatContractGuid] as [old],
		N.[FlatContractGuid] as [New]
	From
		[deleted] d
		inner join [inserted] n on D.Guid = N.Guid
	where
		N.[FlatContractGuid] <> D.[FlatContractGuid]
		
	insert into [TraceDetail]
	([ParentGuid],[Caption],[Old],[New])
	Select Top 1
		@Guid,
		' ' as [Caption],
		dbo.fndate(D.[FromDate]) as [old],
		dbo.fndate(N.[FromDate]) as [New]
	From
		[deleted] d
		inner join [inserted] n on D.Guid = N.Guid
	where
		N.[FromDate] <> D.[FromDate]
		
	insert into [TraceDetail]
	([ParentGuid],[Caption],[Old],[New])
	Select Top 1
		@Guid,
		' ' as [Caption],
		dbo.fndate(D.[ToDate]) as [old],
		dbo.fndate(N.[ToDate]) as [New]
	From
		[deleted] d
		inner join [inserted] n on D.Guid = N.Guid
	where
		N.[ToDate] <> D.[ToDate]
		
	insert into [TraceDetail]
	([ParentGuid],[Caption],[Old],[New])
	Select Top 1
		@Guid,
		'' as [Caption],
		D.[Period] as [old],
		N.[Period] as [New]
	From
		[deleted] d
		inner join [inserted] n on D.Guid = N.Guid
	where
		N.[Period] <> D.[Period]
		
	insert into [TraceDetail]
	([ParentGuid],[Caption],[Old],[New])
	Select Top 1
		@Guid,
		' ' as [Caption],
		D.[Rent] as [old],
		N.[Rent] as [New]
	From
		[deleted] d
		inner join [inserted] n on D.Guid = N.Guid
	where
		N.[Rent] <> D.[Rent]
		
	insert into [TraceDetail]
	([ParentGuid],[Caption],[Old],[New])
	Select Top 1
		@Guid,
		'' as [Caption],
		D.[CurrencyGuid] as [old],
		N.[CurrencyGuid] as [New]
	From
		[deleted] d
		inner join [inserted] n on D.Guid = N.Guid
	where
		N.[CurrencyGuid] <> D.[CurrencyGuid]
		
	insert into [TraceDetail]
	([ParentGuid],[Caption],[Old],[New])
	Select Top 1
		@Guid,
		' ' as [Caption],
		D.[CurrencyVal] as [old],
		N.[CurrencyVal] as [New]
	From
		[deleted] d
		inner join [inserted] n on D.Guid = N.Guid
	where
		N.[CurrencyVal] <> D.[CurrencyVal]
		
	insert into [TraceDetail]
	([ParentGuid],[Caption],[Old],[New])
	Select Top 1
		@Guid,
		' ' as [Caption],
		D.[PayType] as [old],
		N.[PayType] as [New]
	From
		[deleted] d
		inner join [inserted] n on D.Guid = N.Guid
	where
		N.[PayType] <> D.[PayType]
		
	insert into [TraceDetail]
	([ParentGuid],[Caption],[Old],[New])
	Select Top 1
		@Guid,
		'' as [Caption],
		LEFT(D.[Note], 255) as [old],
		LEFT(N.[Note], 255) as [New]
	From
		[deleted] d
		inner join [inserted] n on D.Guid = N.Guid
	where
		N.[Note] <> D.[Note]
		
	insert into [TraceDetail]
	([ParentGuid],[Caption],[Old],[New])
	Select Top 1
		@Guid,
		' 2' as [Caption],
		LEFT(D.[Note2], 255) as [old],
		LEFT(N.[Note2], 255) as [New]
	From
		[deleted] d
		inner join [inserted] n on D.Guid = N.Guid
	where
		N.[Note2] <> D.[Note2]
		
	insert into [TraceDetail]
	([ParentGuid],[Caption],[Old],[New])
	Select Top 1
		@Guid,
		' ' as [Caption],
		D.[RevenueAccountGuid] as [old],
		N.[RevenueAccountGuid] as [New]
	From
		[deleted] d
		inner join [inserted] n on D.Guid = N.Guid
	where
		N.[RevenueAccountGuid] <> D.[RevenueAccountGuid]
		
	insert into [TraceDetail]
	([ParentGuid],[Caption],[Old],[New])
	Select Top 1
		@Guid,
		' ' as [Caption],
		D.[CustAccountGuid] as [old],
		N.[CustAccountGuid] as [New]
	From
		[deleted] d
		inner join [inserted] n on D.Guid = N.Guid
	where
		N.[CustAccountGuid] <> D.[CustAccountGuid]
		
	insert into [TraceDetail]
	([ParentGuid],[Caption],[Old],[New])
	Select Top 1
		@Guid,
		'   ' as [Caption],
		D.[CommissionFromCustPercent] as [old],
		N.[CommissionFromCustPercent] as [New]
	From
		[deleted] d
		inner join [inserted] n on D.Guid = N.Guid
	where
		N.[CommissionFromCustPercent] <> D.[CommissionFromCustPercent]
		
	insert into [TraceDetail]
	([ParentGuid],[Caption],[Old],[New])
	Select Top 1
		@Guid,
		'   ' as [Caption],
		D.[CommissionFromCustValue] as [old],
		N.[CommissionFromCustValue] as [New]
	From
		[deleted] d
		inner join [inserted] n on D.Guid = N.Guid
	where
		N.[CommissionFromCustValue] <> D.[CommissionFromCustValue]
		
	insert into [TraceDetail]
	([ParentGuid],[Caption],[Old],[New])
	Select Top 1
		@Guid,
		'   ' as [Caption],
		D.[AcCommissionFromCustGuid] as [old],
		N.[AcCommissionFromCustGuid] as [New]
	From
		[deleted] d
		inner join [inserted] n on D.Guid = N.Guid
	where
		N.[AcCommissionFromCustGuid] <> D.[AcCommissionFromCustGuid]
		
	insert into [TraceDetail]
	([ParentGuid],[Caption],[Old],[New])
	Select Top 1
		@Guid,
		'    ' as [Caption],
		D.[CommissionFromOwnerPercent] as [old],
		N.[CommissionFromOwnerPercent] as [New]
	From
		[deleted] d
		inner join [inserted] n on D.Guid = N.Guid
	where
		N.[CommissionFromOwnerPercent] <> D.[CommissionFromOwnerPercent]
		
	insert into [TraceDetail]
	([ParentGuid],[Caption],[Old],[New])
	Select Top 1
		@Guid,
		'    ' as [Caption],
		D.[CommissionFromOwnerValue] as [old],
		N.[CommissionFromOwnerValue] as [New]
	From
		[deleted] d
		inner join [inserted] n on D.Guid = N.Guid
	where
		N.[CommissionFromOwnerValue] <> D.[CommissionFromOwnerValue]
		
	insert into [TraceDetail]
	([ParentGuid],[Caption],[Old],[New])
	Select Top 1
		@Guid,
		'    ' as [Caption],
		D.[AcCommissionFromOwnerGuid] as [old],
		N.[AcCommissionFromOwnerGuid] as [New]
	From
		[deleted] d
		inner join [inserted] n on D.Guid = N.Guid
	where
		N.[AcCommissionFromOwnerGuid] <> D.[AcCommissionFromOwnerGuid]
		
	insert into [TraceDetail]
	([ParentGuid],[Caption],[Old],[New])
	Select Top 1
		@Guid,
		' ' as [Caption],
		D.[ContractFinish] as [old],
		N.[ContractFinish] as [New]
	From
		[deleted] d
		inner join [inserted] n on D.Guid = N.Guid
	where
		N.[ContractFinish] <> D.[ContractFinish]
		
	insert into [TraceDetail]
	([ParentGuid],[Caption],[Old],[New])
	Select Top 1
		@Guid,
		' ' as [Caption],
		dbo.fndate(D.[ContractFinishDate]) as [old],
		dbo.fndate(N.[ContractFinishDate]) as [New]
	From
		[deleted] d
		inner join [inserted] n on D.Guid = N.Guid
	where
		N.[ContractFinishDate] <> D.[ContractFinishDate]
		
	insert into [TraceDetail]
	([ParentGuid],[Caption],[Old],[New])
	Select Top 1
		@Guid,
		'    / ' as [Caption],
		D.[ResultingAmount] as [old],
		N.[ResultingAmount] as [New]
	From
		[deleted] d
		inner join [inserted] n on D.Guid = N.Guid
	where
		N.[ResultingAmount] <> D.[ResultingAmount]
		
	insert into [TraceDetail]
	([ParentGuid],[Caption],[Old],[New])
	Select Top 1
		@Guid,
		'   ' as [Caption],
		D.[ResultingAmount2] as [old],
		N.[ResultingAmount2] as [New]
	From
		[deleted] d
		inner join [inserted] n on D.Guid = N.Guid
	where
		N.[ResultingAmount2] <> D.[ResultingAmount2]
		
	insert into [TraceDetail]
	([ParentGuid],[Caption],[Old],[New])
	Select Top 1
		@Guid,
		' ' as [Caption],
		D.[ResultingNote] as [old],
		N.[ResultingNote] as [New]
	From
		[deleted] d
		inner join [inserted] n on D.Guid = N.Guid
	where
		N.[ResultingNote] <> D.[ResultingNote]
		
	insert into [TraceDetail]
	([ParentGuid],[Caption],[Old],[New])
	Select Top 1
		@Guid,
		'' as [Caption],
		D.[Fine] as [old],
		N.[Fine] as [New]
	From
		[deleted] d
		inner join [inserted] n on D.Guid = N.Guid
	where
		N.[Fine] <> D.[Fine]
		
	insert into [TraceDetail]
	([ParentGuid],[Caption],[Old],[New])
	Select Top 1
		@Guid,
		'  ' as [Caption],
		D.[FineAccount] as [old],
		N.[FineAccount] as [New]
	From
		[deleted] d
		inner join [inserted] n on D.Guid = N.Guid
	where
		N.[FineAccount] <> D.[FineAccount]
		
	insert into [TraceDetail]
	([ParentGuid],[Caption],[Old],[New])
	Select Top 1
		@Guid,
		' ' as [Caption],
		D.[FineNote] as [old],
		N.[FineNote] as [New]
	From
		[deleted] d
		inner join [inserted] n on D.Guid = N.Guid
	where
		N.[FineNote] <> D.[FineNote]
		
	insert into [TraceDetail]
	([ParentGuid],[Caption],[Old],[New])
	Select Top 1
		@Guid,
		'  ' as [Caption],
		D.[CreateResultingEntry] as [old],
		N.[CreateResultingEntry] as [New]
	From
		[deleted] d
		inner join [inserted] n on D.Guid = N.Guid
	where
		N.[CreateResultingEntry] <> D.[CreateResultingEntry]
		
	insert into [TraceDetail]
	([ParentGuid],[Caption],[Old],[New])
	Select Top 1
		@Guid,
		'  ' as [Caption],
		D.[InsuranceValue] as [old],
		N.[InsuranceValue] as [New]
	From
		[deleted] d
		inner join [inserted] n on D.Guid = N.Guid
	where
		N.[InsuranceValue] <> D.[InsuranceValue]
		
	insert into [TraceDetail]
	([ParentGuid],[Caption],[Old],[New])
	Select Top 1
		@Guid,
		'  ' as [Caption],
		D.[InsuranceValueOld] as [old],
		N.[InsuranceValueOld] as [New]
	From
		[deleted] d
		inner join [inserted] n on D.Guid = N.Guid
	where
		N.[InsuranceValueOld] <> D.[InsuranceValueOld]
		
	insert into [TraceDetail]
	([ParentGuid],[Caption],[Old],[New])
	Select Top 1
		@Guid,
		' ' as [Caption],
		D.[ContractPrice] as [old],
		N.[ContractPrice] as [New]
	From
		[deleted] d
		inner join [inserted] n on D.Guid = N.Guid
	where
		N.[ContractPrice] <> D.[ContractPrice]
		
	insert into [TraceDetail]
	([ParentGuid],[Caption],[Old],[New])
	Select Top 1
		@Guid,
		'   ' as [Caption],
		D.[AccountContractPrice] as [old],
		N.[AccountContractPrice] as [New]
	From
		[deleted] d
		inner join [inserted] n on D.Guid = N.Guid
	where
		N.[AccountContractPrice] <> D.[AccountContractPrice]
		
	insert into [TraceDetail]
	([ParentGuid],[Caption],[Old],[New])
	Select Top 1
		@Guid,
		' ' as [Caption],
		D.[CertificatValue] as [old],
		N.[CertificatValue] as [New]
	From
		[deleted] d
		inner join [inserted] n on D.Guid = N.Guid
	where
		N.[CertificatValue] <> D.[CertificatValue]
		
	insert into [TraceDetail]
	([ParentGuid],[Caption],[Old],[New])
	Select Top 1
		@Guid,
		'   ' as [Caption],
		D.[AccountCertificatValue] as [old],
		N.[AccountCertificatValue] as [New]
	From
		[deleted] d
		inner join [inserted] n on D.Guid = N.Guid
	where
		N.[AccountCertificatValue] <> D.[AccountCertificatValue]
		
	insert into [TraceDetail]
	([ParentGuid],[Caption],[Old],[New])
	Select Top 1
		@Guid,
		'  ' as [Caption],
		D.[RentDuration] as [old],
		N.[RentDuration] as [New]
	From
		[deleted] d
		inner join [inserted] n on D.Guid = N.Guid
	where
		N.[RentDuration] <> D.[RentDuration]
		
	insert into [TraceDetail]
	([ParentGuid],[Caption],[Old],[New])
	Select Top 1
		@Guid,
		'   / ' as [Caption],
		D.[Rentype] as [old],
		N.[Rentype] as [New]
	From
		[deleted] d
		inner join [inserted] n on D.Guid = N.Guid
	where
		N.[Rentype] <> D.[Rentype]
		
	insert into [TraceDetail]
	([ParentGuid],[Caption],[Old],[New])
	Select Top 1
		@Guid,
		'  ' as [Caption],
		D.[TermsOfPayment] as [old],
		N.[TermsOfPayment] as [New]
	From
		[deleted] d
		inner join [inserted] n on D.Guid = N.Guid
	where
		N.[TermsOfPayment] <> D.[TermsOfPayment]
		
	insert into [TraceDetail]
	([ParentGuid],[Caption],[Old],[New])
	Select Top 1
		@Guid,
		'    ' as [Caption],
		D.[Step1Complete] as [old],
		N.[Step1Complete] as [New]
	From
		[deleted] d
		inner join [inserted] n on D.Guid = N.Guid
	where
		N.[Step1Complete] <> D.[Step1Complete]
		
	insert into [TraceDetail]
	([ParentGuid],[Caption],[Old],[New])
	Select Top 1
		@Guid,
		'    ' as [Caption],
		D.[Step2Complete] as [old],
		N.[Step2Complete] as [New]
	From
		[deleted] d
		inner join [inserted] n on D.Guid = N.Guid
	where
		N.[Step2Complete] <> D.[Step2Complete]
		
	insert into [TraceDetail]
	([ParentGuid],[Caption],[Old],[New])
	Select Top 1
		@Guid,
		'    ' as [Caption],
		D.[Step3Complete] as [old],
		N.[Step3Complete] as [New]
	From
		[deleted] d
		inner join [inserted] n on D.Guid = N.Guid
	where
		N.[Step3Complete] <> D.[Step3Complete]
		
	insert into [TraceDetail]
	([ParentGuid],[Caption],[Old],[New])
	Select Top 1
		@Guid,
		'    ' as [Caption],
		D.[Step4Complete] as [old],
		N.[Step4Complete] as [New]
	From
		[deleted] d
		inner join [inserted] n on D.Guid = N.Guid
	where
		N.[Step4Complete] <> D.[Step4Complete]
		
	insert into [TraceDetail]
	([ParentGuid],[Caption],[Old],[New])
	Select Top 1
		@Guid,
		' ' as [Caption],
		D.[Certification] as [old],
		N.[Certification] as [New]
	From
		[deleted] d
		inner join [inserted] n on D.Guid = N.Guid
	where
		N.[Certification] <> D.[Certification]
		
	insert into [TraceDetail]
	([ParentGuid],[Caption],[Old],[New])
	Select Top 1
		@Guid,
		'' as [Caption],
		D.[BranchGuid] as [old],
		N.[BranchGuid] as [New]
	From
		[deleted] d
		inner join [inserted] n on D.Guid = N.Guid
	where
		N.[BranchGuid] <> D.[BranchGuid]
		
	insert into [TraceDetail]
	([ParentGuid],[Caption],[Old],[New])
	Select Top 1
		@Guid,
		' ' as [Caption],
		D.[CardNo] as [old],
		N.[CardNo] as [New]
	From
		[deleted] d
		inner join [inserted] n on D.Guid = N.Guid
	where
		N.[CardNo] <> D.[CardNo]
		
	insert into [TraceDetail]
	([ParentGuid],[Caption],[Old],[New])
	Select Top 1
		@Guid,
		' ' as [Caption],
		D.[CarNo] as [old],
		N.[CarNo] as [New]
	From
		[deleted] d
		inner join [inserted] n on D.Guid = N.Guid
	where
		N.[CarNo] <> D.[CarNo]
		
	insert into [TraceDetail]
	([ParentGuid],[Caption],[Old],[New])
	Select Top 1
		@Guid,
		' ' as [Caption],
		D.[CarType] as [old],
		N.[CarType] as [New]
	From
		[deleted] d
		inner join [inserted] n on D.Guid = N.Guid
	where
		N.[CarType] <> D.[CarType]
		
	insert into [TraceDetail]
	([ParentGuid],[Caption],[Old],[New])
	Select Top 1
		@Guid,
		' ' as [Caption],
		D.[CarColor] as [old],
		N.[CarColor] as [New]
	From
		[deleted] d
		inner join [inserted] n on D.Guid = N.Guid
	where
		N.[CarColor] <> D.[CarColor]
		
	insert into [TraceDetail]
	([ParentGuid],[Caption],[Old],[New])
	Select Top 1
		@Guid,
		'' as [Caption],
		D.[Emirate] as [old],
		N.[Emirate] as [New]
	From
		[deleted] d
		inner join [inserted] n on D.Guid = N.Guid
	where
		N.[Emirate] <> D.[Emirate]
		
	insert into [TraceDetail]
	([ParentGuid],[Caption],[Old],[New])
	Select Top 1
		@Guid,
		' ' as [Caption],
		D.[CreateContractEntry] as [old],
		N.[CreateContractEntry] as [New]
	From
		[deleted] d
		inner join [inserted] n on D.Guid = N.Guid
	where
		N.[CreateContractEntry] <> D.[CreateContractEntry]
		
	insert into [TraceDetail]
	([ParentGuid],[Caption],[Old],[New])
	Select Top 1
		@Guid,
		' ' as [Caption],
		D.[FineRevenueAccountGUID] as [old],
		N.[FineRevenueAccountGUID] as [New]
	From
		[deleted] d
		inner join [inserted] n on D.Guid = N.Guid
	where
		N.[FineRevenueAccountGUID] <> D.[FineRevenueAccountGUID]
		
	insert into [TraceDetail]
	([ParentGuid],[Caption],[Old],[New])
	Select Top 1
		@Guid,
		'' as [Caption],
		D.[NewState] as [old],
		N.[NewState] as [New]
	From
		[deleted] d
		inner join [inserted] n on D.Guid = N.Guid
	where
		N.[NewState] <> D.[NewState]
		
	insert into [TraceDetail]
	([ParentGuid],[Caption],[Old],[New])
	Select Top 1
		@Guid,
		'  ' as [Caption],
		D.[License1No] as [old],
		N.[License1No] as [New]
	From
		[deleted] d
		inner join [inserted] n on D.Guid = N.Guid
	where
		N.[License1No] <> D.[License1No]
		
	insert into [TraceDetail]
	([ParentGuid],[Caption],[Old],[New])
	Select Top 1
		@Guid,
		' ' as [Caption],
		D.[License2No] as [old],
		N.[License2No] as [New]
	From
		[deleted] d
		inner join [inserted] n on D.Guid = N.Guid
	where
		N.[License2No] <> D.[License2No]
		
	insert into [TraceDetail]
	([ParentGuid],[Caption],[Old],[New])
	Select Top 1
		@Guid,
		'   ' as [Caption],
		D.[License3No] as [old],
		N.[License3No] as [New]
	From
		[deleted] d
		inner join [inserted] n on D.Guid = N.Guid
	where
		N.[License3No] <> D.[License3No]
		
	insert into [TraceDetail]
	([ParentGuid],[Caption],[Old],[New])
	Select Top 1
		@Guid,
		'License1Date1' as [Caption],
		dbo.fndate(D.[License1Date1]) as [old],
		dbo.fndate(N.[License1Date1]) as [New]
	From
		[deleted] d
		inner join [inserted] n on D.Guid = N.Guid
	where
		N.[License1Date1] <> D.[License1Date1]
		
	insert into [TraceDetail]
	([ParentGuid],[Caption],[Old],[New])
	Select Top 1
		@Guid,
		'License2Date1' as [Caption],
		dbo.fndate(D.[License2Date1]) as [old],
		dbo.fndate(N.[License2Date1]) as [New]
	From
		[deleted] d
		inner join [inserted] n on D.Guid = N.Guid
	where
		N.[License2Date1] <> D.[License2Date1]
		
	insert into [TraceDetail]
	([ParentGuid],[Caption],[Old],[New])
	Select Top 1
		@Guid,
		'License3Date1' as [Caption],
		dbo.fndate(D.[License3Date1]) as [old],
		dbo.fndate(N.[License3Date1]) as [New]
	From
		[deleted] d
		inner join [inserted] n on D.Guid = N.Guid
	where
		N.[License3Date1] <> D.[License3Date1]
		
	insert into [TraceDetail]
	([ParentGuid],[Caption],[Old],[New])
	Select Top 1
		@Guid,
		'License1Date2' as [Caption],
		dbo.fndate(D.[License1Date2]) as [old],
		dbo.fndate(N.[License1Date2]) as [New]
	From
		[deleted] d
		inner join [inserted] n on D.Guid = N.Guid
	where
		N.[License1Date2] <> D.[License1Date2]
		
	insert into [TraceDetail]
	([ParentGuid],[Caption],[Old],[New])
	Select Top 1
		@Guid,
		'License2Date2' as [Caption],
		dbo.fndate(D.[License2Date2]) as [old],
		dbo.fndate(N.[License2Date2]) as [New]
	From
		[deleted] d
		inner join [inserted] n on D.Guid = N.Guid
	where
		N.[License2Date2] <> D.[License2Date2]
		
	insert into [TraceDetail]
	([ParentGuid],[Caption],[Old],[New])
	Select Top 1
		@Guid,
		'License3Date2' as [Caption],
		dbo.fndate(D.[License3Date2]) as [old],
		dbo.fndate(N.[License3Date2]) as [New]
	From
		[deleted] d
		inner join [inserted] n on D.Guid = N.Guid
	where
		N.[License3Date2] <> D.[License3Date2]
		
	insert into [TraceDetail]
	([ParentGuid],[Caption],[Old],[New])
	Select Top 1
		@Guid,
		'   ' as [Caption],
		D.[LtnRentDuration] as [old],
		N.[LtnRentDuration] as [New]
	From
		[deleted] d
		inner join [inserted] n on D.Guid = N.Guid
	where
		N.[LtnRentDuration] <> D.[LtnRentDuration]
		
	insert into [TraceDetail]
	([ParentGuid],[Caption],[Old],[New])
	Select Top 1
		@Guid,
		'   /  ' as [Caption],
		D.[LtnRentype] as [old],
		N.[LtnRentype] as [New]
	From
		[deleted] d
		inner join [inserted] n on D.Guid = N.Guid
	where
		N.[LtnRentype] <> D.[LtnRentype]
		
	insert into [TraceDetail]
	([ParentGuid],[Caption],[Old],[New])
	Select Top 1
		@Guid,
		'   ' as [Caption],
		D.[LtnTermsOfPayment] as [old],
		N.[LtnTermsOfPayment] as [New]
	From
		[deleted] d
		inner join [inserted] n on D.Guid = N.Guid
	where
		N.[LtnTermsOfPayment] <> D.[LtnTermsOfPayment]
		
	insert into [TraceDetail]
	([ParentGuid],[Caption],[Old],[New])
	Select Top 1
		@Guid,
		' ' as [Caption],
		D.[IsRounded] as [old],
		N.[IsRounded] as [New]
	From
		[deleted] d
		inner join [inserted] n on D.Guid = N.Guid
	where
		N.[IsRounded] <> D.[IsRounded]
		
	insert into [TraceDetail]
	([ParentGuid],[Caption],[Old],[New])
	Select Top 1
		@Guid,
		'      ' as [Caption],
		D.[Step5Complete] as [old],
		N.[Step5Complete] as [New]
	From
		[deleted] d
		inner join [inserted] n on D.Guid = N.Guid
	where
		N.[Step5Complete] <> D.[Step5Complete]
		
	insert into [TraceDetail]
	([ParentGuid],[Caption],[Old],[New])
	Select Top 1
		@Guid,
		'' as [Caption],
		D.[Judicial] as [old],
		N.[Judicial] as [New]
	From
		[deleted] d
		inner join [inserted] n on D.Guid = N.Guid
	where
		N.[Judicial] <> D.[Judicial]
		
	insert into [TraceDetail]
	([ParentGuid],[Caption],[Old],[New])
	Select Top 1
		@Guid,
		'   ' as [Caption],
		D.[AddValue] as [old],
		N.[AddValue] as [New]
	From
		[deleted] d
		inner join [inserted] n on D.Guid = N.Guid
	where
		N.[AddValue] <> D.[AddValue]
		
	delete Trace From Trace t left join [TraceDetail] D on T.guid = D.ParentGuid
	where
		d.ParentGuid is Null and t.Guid = @Guid


GO

SET ANSI_NULLS, QUOTED_IDENTIFIER ON
GO

Create Procedure [RepVillaRent]
(
	@CustGuid uniqueidentifier = 0x0
	,@Nationality Varchar(256) = ''
	,@VillaNo Varchar(256) = ''
	,@ComplexName Varchar(256) = ''
	,@Emirate Varchar(256) = ''
	,@Area Varchar(256) = ''
	,@BasinNo Varchar(256) = ''
	,@DocType Varchar(256) = ''
	,@FlatArea1 Float = 0
	,@FlatArea2 Float = 0
	,@RentState int = 2
	,@ContractState int = 2
	,@Datewith int = 0
	,@Date1 DateTime = '2009-7-1'
	,@Date2 DateTime = '2022-1-2'
	,@RentInfoGuid uniqueidentifier = 0x0
	,@SalesManGuid uniqueidentifier = 0x0
	,@ShowIsCheck Bit = 1
	,@ShowIsNotCheck Bit = 1
	,@Rent1 Float = 0
	,@Rent2 Float = 0
	,@CheckDate Bit = 0

	,@ActiveNote Bit = 0
	,@OperationNote int = 0
	,@RealtyNote  Varchar(256) = '' 
	,@ContractActiveNote Bit = 0
	,@ContractOpNote int = 0
	,@ContractNote  Varchar(256) = '' 
)
 
as
	Set NoCount On 
	--  
	if @OperationNote <> 2 --
	Set @RealtyNote = '%'+@RealtyNote+'%'
	
	--  
	if @ContractOpNote <> 2 --
	Set @ContractNote = '%'+@ContractNote+'%'

	--    
	Select
		[VillaGuid],
		Max([FromDate]) as [FromDate]
	Into #LastContract	
	From
		[vwLandContract]
	Group By
		[VillaGuid]


	Select 
		Case 
			when [ContractFinish] = 0 and [ToDate] >= GetDate() then [ToDate]
			when [ContractFinish] = 0 and [ToDate] < GetDate() then GetDate()
			when [ContractFinish] = 1  then [ContractFinishDate]
		end as [EndContractDate],
		[C].*
	Into #vwLandContract
	From
		[vwLandContract] [C]
		inner join #LastContract [L] on [L].[VillaGuid] = [C].[VillaGuid] and [L].[FromDate] = [C].[FromDate]

--	where [ContractFinish] = 0     

	Declare @Tbl Table
	(
		[VillaNo] Varchar(256)
		,[ComplexName] Varchar(256)
		,[Emirate] Varchar(256)
		,[Region] Varchar(256)
		,[BasinNo] Varchar(256)
		,[license] Varchar(256)
		,[Area]  Varchar(256)
		,[State]  Varchar(256)
		,[ContractState] Varchar(256)
		,[CustName] Varchar(256)
		,[CustPhone] Varchar(256)
		,[CustNationality] Varchar(256)
		,[ContractDateBegin] Datetime
		,[ContractDateEnd] Datetime
		,[ContractGuid] uniqueidentifier
		,[Rent] Float
		,[RentAfterDiscount] Float
		,[FlatGuid]uniqueidentifier
		,[ContractNote] Varchar(1000)
		,[WaterCounter]  Varchar(256)
		,[ElectricityCounter]  Varchar(256)
	)
	
	Insert into @Tbl 
	Select 
		[A].[Name] as [VillaNo]
		,[A].[ComplexName]
		,[A].[Emirate]
		,[A].[Area]
		,[A].[BasinNo]
		,[A].[DocType]
		,[A].[LandArea]
		,Case when [L].[ContractFinish] = 0 then  dbo.sc('') 
			  else dbo.SC(' ') 
		end as [State]
		,Case when [L].[ContractFinish] = 0 then
			 Case when (([L].[ToDate] <= GetDate()) or ([L].[ContractFinish] = 1)) or (@Date2 > [L].[ToDate]) then dbo.sc(' ')  
				  when ([L].[ToDate] > GetDate()) and ([L].[ContractFinish] = 0) then dbo.sc('  ')  end 
		 end as [ContractState]

		,[Cu].[Name] as [CustName]
		,[Cu].[Mobile] as [CustPhone]
		,[Cu].[Nationality]
		,Case when [L].[ContractFinish] = 0 then [L].[FromDate] end as [ContractDateBegin]
		,Case when [L].[ContractFinish] = 0 then [L].[ToDate] end as [ContractDateEnd]
		,Case when [L].[ContractFinish] = 0 then [L].[Guid] end as [ContractGuid]
		,Case when [L].[ContractFinish] = 0 then [L].[Rent] end 
		,Case when [L].[ContractFinish] = 0 then [L].[Rent] - [L].[DiscountValue] end
		,[A].[Guid]
		,[A].[Details] as [Note]
		,[A].[WaterCounter]
		,[A].[ElectricityCounter]
	from 
		[vwVilla] [A]
		left join [#vwLandContract] [L] On [A].[Guid] = [L].[LandGuid] 
										and [L].[Contractkind]  = 9

		left join [vwCustomer] [Cu] on [Cu].[Guid] = [L].[CustomerGuid] 
		left join (
					Select
						Max(Number) as [Number],
						[LandGuid]
					From
						[vwLandContract]
					where 
						[Contractkind]  = 9
					Group By 
						[LandGuid]
					) [LastLease] On [LastLease].[Number] = [L].[Number] and [LastLease].[LandGuid] = [L].[LandGuid]
		left join (
					Select
						Max(Number) as [Number],
						[LandGuid]
					From
						[vwLandContract]
					where 
						[Contractkind]  = 8
					Group By 
						[LandGuid]
					) [Sales] On [Sales].[LandGuid] = [A].[Guid]

 	where
		([Cu].[Guid] = @CustGuid or @CustGuid = 0x0)
		and (Cu.Nationality = @Nationality or @Nationality = '')
		and ([A].[VillaNo] Like '%'+@VillaNo+'%')
		and ([A].[Emirate] Like '%'+@Emirate+'%')
		and ([A].[Area] Like '%'+@Area+'%')
		and ([A].[BasinNo] Like '%'+@BasinNo+'%')
		and ([A].[DocType] Like '%'+@DocType+'%')

   		and ([A].[LandArea] between @FlatArea1 and @FlatArea2 or @FlatArea2 = 0) 

   		and (
   				([L].[ContractFinish] = 0 and @RentState = 0)
   				or ( ([L].[Guid] is null or [L].[ContractFinish] = 1) and @RentState = 1)
   				or @RentState = 2
   			)
   		and 
   			(
   				(
   					(([L].[ToDate] <= GetDate()) or ([L].[ContractFinish] = 1) ) and @ContractState = 0
  				)
   			  	or ( 
   					(
   						(([L].[ToDate] > GetDate()) and ([L].[ContractFinish] = 0) ) and @ContractState = 1
   					)
   					)
   				or @ContractState = 2
   			)
   
 
   		and ([L].[RentInfoGuid] = @RentInfoGuid or @RentInfoGuid = 0x0)
   		and ([L].[SalesManGuid] = @SalesManGuid or @SalesManGuid = 0x0)
   		and ([Sales].[LandGuid] is null)
   		and ([L].[Rent] Between @Rent1 and @Rent2 or @Rent2 = 0)
   		and 
   			(
   				
   				Case  when (@OperationNote = 0) and ([A].[Details] Like @RealtyNote) then 1
    					  when (@OperationNote = 1) and ([A].[Details] Not Like @RealtyNote) then 1
   					  when (@OperationNote = 2) and ([A].[Details] = @RealtyNote) then 1
   				else 
   					0 end = 1
   					
   				or @ActiveNote = 0
   			)
   
   		and 
   			(
   				Case  when (@ContractOpNote = 0) and ([L].[Note2] Like @ContractNote) then 1
    					  when (@ContractOpNote = 1) and ([L].[Note2] Not Like @ContractNote) then 1
   					  when (@ContractOpNote = 2) and ([L].[Note2] = @ContractNote) then 1
   				else 
   					0 end = 1
   
   				or @ContractActiveNote = 0
  			)


	Select 
		*,
		Case when [R].[ObjGuid] is null then 0 
			 when [R].[ObjGuid] is not null  then 1 end as [Check]
	into #EndRes
	From
		@Tbl [L]
		left join [RepCheck] [R] on [R].[ObjGuid] = [L].[FlatGuid] and [R].[IdReport] = 5002
	where
		([R].[ObjGuid] is not null and @ShowIsCheck = 1)
		or
		([R].[ObjGuid] is null and @ShowIsNotCheck = 1)
	Order By 
		[VillaNo]


	Select 
		* 
	from 
		#EndRes
	Order By 
		[VillaNo]

	Select 
		(Select Count(*) From @Tbl where [State] = dbo.sc('')) as [StateRent],
		(Select Count(*) From @Tbl where [State] = dbo.sc(' ')) as [StateNotRent],
		(Select Sum([Rent]) From @Tbl ) as [Rent],
		(Select Sum([RentAfterDiscount]) From @Tbl ) as [RentAfterDiscount]


GO

SET ANSI_NULLS, QUOTED_IDENTIFIER ON
GO

Create Procedure [PrcTrailBalanceCost]
(
	@AccountGuid [uniqueidentifier]= '3D2B933E-C93D-49E8-A9C0-8DC4FAA91850'
	,@BranchGuid uniqueidentifier = 0x0
	,@CostGuid [uniqueidentifier]= '85B8AA6F-40B0-4949-807A-B70A5B4C41C7'
	,@Level int = 5
	,@ShowEmptyBal Bit = 1
	,@CurrencyGuid [uniqueidentifier] = 0x0
	,@CurrencyVal Float = 1
	,@IsPosted Bit = 1
	,@IsNotPosted Bit = 1
	,@Date1 DateTime = '4/1/2008'
	,@Date2 DateTime = '12/30/2012'

)
 
as
	if @CurrencyVal = 0
	Set @CurrencyVal = 1

	Select * into #fnGetAccountList from [dbo].[fnGetAccountList](@AccountGuid)
	Select * into #fnGetCostList from [dbo].[fnGetCostList](@CostGuid)

	--   
	Select 
		[Co2].[Code]+'-'+[Co2].[Name] as [CostName]
		,[Co].[Level]
		,[Co].[Path]
		,[Co2].[Guid]
		,[Co2].[ParentGuid]
		,Isnull([SCo].[CoNSons],0) as [CoNSons]
		into #Co
	From
		[dbo].[#fnGetCostList] [Co] 
		inner join [vwCost] [Co2] on [Co2].[Guid] = [Co].[Guid]
		left join (Select 
						Count(Number)as [CoNSons] 
						,[ParentGuid] 
					From 
						[Cost] [SCo] 
					Group By
						[ParentGuid]					
				)[SCo] on [SCo].[ParentGuid] = [Co2].[Guid]

	--  
	
	Select 
		[Ac2].[Code]+'-'+[Ac2].[Name] as [AccountName]
		,[Ac].[Level]
		,[Ac].[Path]
		,[Ac2].[Guid]
		,[Ac2].[ParentGuid]
		,Isnull([SAc].[AcNSons],0) as [AcNSons]
		into #Ac
	From
		[dbo].[#fnGetAccountList] [Ac] 
		inner join [vwAccount] [Ac2] on [Ac2].[Guid] = [Ac].[Guid]
		left join (Select 
						Count(Number)as [AcNSons] 
						,[ParentGuid] 
					From 
						[Account] [SAc] 
					Group By
						[ParentGuid]					
				)[SAc] on [SAc].[ParentGuid] = [Ac2].[Guid]
	where
		[Type] = 0

--	Select * from #Ac Order by [Path]
	--

	--  
	Select 
		[Co].[Guid] as [CoGuid],
		[Ac].[Guid]	as AcGuid
		,Sum([En].[Debit]*
			Case when [En].[CurrencyGuid] = @CurrencyGuid then 1 
			else [En].[CurrencyVal] / @CurrencyVal end
			) as [Debit]
		,Sum([En].[Credit]*
			Case when [En].[CurrencyGuid] = @CurrencyGuid then 1 
			else [En].[CurrencyVal] / @CurrencyVal end
			) as [Credit]
	into #Entry
	from 
		[DEntry] [En]
		inner Join [vwEntry] [M] on [M].[Guid] = [En].[ParentGuid]
		inner Join [dbo].[#fnGetAccountList] [Ac] on [Ac].[Guid] = [En].[AcGuid]
		inner Join [dbo].[#fnGetCostList] [Co] on [Co].[Guid] = [En].[CostGuid]
	where 
		([M].[Date] between @Date1 And @Date2)
		and ( [Co].[Guid] Is Not Null)
		and ([M].[BranchGuid] = @BranchGuid or @BranchGuid = 0x0)
		and (
				([M].[IsPosted] = 1 and @IsPosted = 1)
				or ([M].[IsPosted] = 0  and @IsNotPosted = 1)
			)
	Group By
		[Co].[Guid], [Ac].[Guid]
	
	--Select E.* from #Entry E	inner join #Co C on C.Guid = e.CoGuid
	
	--

	--  
	Select 
		[Co].[Guid] as [CoGuid]
		,Sum([En].[Debit]*
			Case when [En].[CurrencyGuid] = @CurrencyGuid then 1 
			else [En].[CurrencyVal] / @CurrencyVal end
			) as [Debit]
		,Sum([En].[Credit]*
			Case when [En].[CurrencyGuid] = @CurrencyGuid then 1 
			else [En].[CurrencyVal] / @CurrencyVal end
			) as [Credit]
	into #OldBalance
	from 
		[DEntry] [En]
		inner Join [vwEntry] [M] on [M].[Guid] = [En].[ParentGuid]
		inner Join [dbo].[#fnGetAccountList] [Ac] on [Ac].[Guid] = [En].[AcGuid]
		inner Join [dbo].[#fnGetCostList] [Co] on [Co].[Guid] = [En].[CostGuid]
	where 
		([M].[Date] < @Date1)
		and ([M].[BranchGuid] = @BranchGuid or @BranchGuid = 0x0)
		and (
				([M].[IsPosted] = 1 and @IsPosted = 1)
				or ([M].[IsPosted] = 0  and @IsNotPosted = 1)
			)
	Group By [Co].[Guid]
	Having
		(Sum([En].[Debit]) <> 0)
		or (Sum([En].[Credit]) <> 0)
	
--	Select * from #OldBalance	

	Select 
		[Co].[CostName]
		,[Co].[Level]
		,[E].[Debit]
		,[E].[Credit]
		,[B].[Debit] as [OldDebit]
		,[B].[Credit] as [OldCredit]
		,[Co].[Path]
		,[Co].[Guid] as [CoGuid]
		,[Co].[ParentGuid]
		,[Co].[CoNSons]
	Into #Res1
	From
		#Co	[Co]
		left join #Entry [E] on [E].[CoGuid] = [Co].[Guid]
		left join #OldBalance [B] on [B].[CoGuid] = [Co].[Guid]
	
--	Select * from #Res1

	Declare @AcLevel int
	SET @acLevel = (SELECT MAX([Level]) FROM [#Res1]) 
	WHILE @acLevel >= 0  
	BEGIN  
		print '@acLevel'
		print @acLevel
		UPDATE [#Res1] SET  
			[Debit] 		= [Debit] + isnull([SumDebit],0)
			,[Credit]	 	= [Credit] + isnull([SumCredit],0)
			,[OldDebit]		= [OldDebit] + isnull([SumOldDebit],0) 
			,[OldCredit]	= [OldCredit] + isnull([SumOldCredit],0)
			FROM  
				[#Res1] AS [Father] INNER JOIN (  
					SELECT 
						[ParentGuid] 
						,isnull(Sum([Debit]),0)			as  [SumDebit]
						,isnull(Sum([Credit]),0)		as  [SumCredit]
						,isnull(Sum([OldDebit]),0)		as  [SumOldDebit]
						,isnull(Sum([OldCredit]),0)		as  [SumOldCredit]
					FROM 
						[#Res1]  
					WHERE  
						[Level] = @acLevel 
					GROUP BY 
						[ParentGuid] 
					) AS [Sons] 
				ON [Father].[CoGUID] = [Sons].[ParentGuid] 
		Print '@@Rowcount'
		Print @@Rowcount
		SET @acLevel = @acLevel - 1 
	End

	--Select * from #Res1
	-- 
	if @ShowEmptyBal = 0 
	delete from #Res1
	where ([Debit] is null and [Credit] is null)


	Insert Into #Res1
	Select 
		dbo.SC('') as [AccountName]
		,0 as [Level]
		,Sum([Debit])
		,Sum([Credit])
		,Sum([OldDebit])
		,Sum([OldCredit])
		,Max([Path]) + 'Z'
		,0x0 as [AcGuid]
		,0x0 as [ParentGuid]
		,1 as [AcNSons]
	From
		#Res1
	where
		Level = 0

	--
	delete from #Res1
	where ([level] >= @Level and @Level <> 0)

	Select 
		*,
		Case when Isnull([Debit],0) >  Isnull([Credit],0) then (Isnull([Debit],0) -  Isnull([Credit],0)) end as [BalanceDebit],
		Case when Isnull([Debit],0) <  Isnull([Credit],0) then (Isnull([Credit],0))- (Isnull([Debit],0))  end as [BalanceCredit]
	from 
		#Res1 
	Order by [Path]

	

GO

SET ANSI_NULLS, QUOTED_IDENTIFIER ON
GO

Create Trigger [TRG_Trace_Account]
on [Account]
 
for update
As
	SET NOCOUNT ON;
	if Not exists(Select Value from DMD_const where vName = 'ActiveLogCardUpdate' and Value = '1' ) return
	
	Declare @UserGuid uniqueidentifier, @Guid uniqueidentifier
	Set @Guid = NEWID()
	
	Select Top 1 @UserGuid = userGuid From CurrentUsers where Spid = @@SPID
			
	insert into [Trace]
	([Guid],[ParentGuid],[Date],[userGuid],[HostName],ParentTbl)
	Select Top 1
		@Guid,
		N.Guid,
		GETDATE(),
		@UserGuid,
		Host_Name(),
		'Account'
	From
		[inserted] n 
		
	insert into [TraceDetail]
	([ParentGuid],[Caption],[Old],[New],[Tbl])
	Select Top 1
		@Guid,
		' ' as [Caption],
		D.[SecLvl] as [old],
		N.[SecLvl] as [New],
		''
	From
		[deleted] d
		inner join [inserted] n on D.Guid = N.Guid
	where
		N.[SecLvl] <> D.[SecLvl]
		
	insert into [TraceDetail]
	([ParentGuid],[Caption],[Old],[New],[Tbl])
	Select Top 1
		@Guid,
		'' as [Caption],
		D.[Name] as [old],
		N.[Name] as [New],
		''
	From
		[deleted] d
		inner join [inserted] n on D.Guid = N.Guid
	where
		N.[Name] <> D.[Name]
		
	insert into [TraceDetail]
	([ParentGuid],[Caption],[Old],[New],[Tbl])
	Select Top 1
		@Guid,
		' ' as [Caption],
		D.[LtnName] as [old],
		N.[LtnName] as [New],
		''
	From
		[deleted] d
		inner join [inserted] n on D.Guid = N.Guid
	where
		N.[LtnName] <> D.[LtnName]
		
	insert into [TraceDetail]
	([ParentGuid],[Caption],[Old],[New],[Tbl])
	Select Top 1
		@Guid,
		'' as [Caption],
		D.[Code] as [old],
		N.[Code] as [New],
		''
	From
		[deleted] d
		inner join [inserted] n on D.Guid = N.Guid
	where
		N.[Code] <> D.[Code]
		
	insert into [TraceDetail]
	([ParentGuid],[Caption],[Old],[New],[Tbl])
	Select Top 1
		@Guid,
		' ' as [Caption],
		dbo.fnDate(D.[CDate]) as [old],
		dbo.fnDate(N.[CDate]) as [New],
		''
	From
		[deleted] d
		inner join [inserted] n on D.Guid = N.Guid
	where
		N.[CDate] <> D.[CDate]
		
	insert into [TraceDetail]
	([ParentGuid],[Caption],[Old],[New],[Tbl])
	Select Top 1
		@Guid,
		' ' as [Caption],
		D.[NSons] as [old],
		N.[NSons] as [New],
		''
	From
		[deleted] d
		inner join [inserted] n on D.Guid = N.Guid
	where
		N.[NSons] <> D.[NSons]
		
	insert into [TraceDetail]
	([ParentGuid],[Caption],[Old],[New],[Tbl])
	Select Top 1
		@Guid,
		'' as [Caption],
		D.[Note] as [old],
		N.[Note] as [New],
		''
	From
		[deleted] d
		inner join [inserted] n on D.Guid = N.Guid
	where
		N.[Note] <> D.[Note]
		
	insert into [TraceDetail]
	([ParentGuid],[Caption],[Old],[New],[Tbl])
	Select Top 1
		@Guid,
		'' as [Caption],
		D.[CurrencyGUID] as [old],
		N.[CurrencyGUID] as [New],
		'Currency'
	From
		[deleted] d
		inner join [inserted] n on D.Guid = N.Guid
	where
		N.[CurrencyGUID] <> D.[CurrencyGUID]
		
	insert into [TraceDetail]
	([ParentGuid],[Caption],[Old],[New],[Tbl])
	Select Top 1
		@Guid,
		' ' as [Caption],
		D.[CurrencyVal] as [old],
		N.[CurrencyVal] as [New],
		''
	From
		[deleted] d
		inner join [inserted] n on D.Guid = N.Guid
	where
		N.[CurrencyVal] <> D.[CurrencyVal]
		
	insert into [TraceDetail]
	([ParentGuid],[Caption],[Old],[New],[Tbl])
	Select Top 1
		@Guid,
		'' as [Caption],
		D.[Type] as [old],
		N.[Type] as [New],
		''
	From
		[deleted] d
		inner join [inserted] n on D.Guid = N.Guid
	where
		N.[Type] <> D.[Type]
		
	insert into [TraceDetail]
	([ParentGuid],[Caption],[Old],[New],[Tbl])
	Select Top 1
		@Guid,
		' ' as [Caption],
		D.[ParentGUID] as [old],
		N.[ParentGUID] as [New],
		'Account'
	From
		[deleted] d
		inner join [inserted] n on D.Guid = N.Guid
	where
		N.[ParentGUID] <> D.[ParentGUID]
		
	insert into [TraceDetail]
	([ParentGuid],[Caption],[Old],[New],[Tbl])
	Select Top 1
		@Guid,
		' ' as [Caption],
		D.[FinalGUID] as [old],
		N.[FinalGUID] as [New],
		'Account'
	From
		[deleted] d
		inner join [inserted] n on D.Guid = N.Guid
	where
		N.[FinalGUID] <> D.[FinalGUID]
		
	delete Trace From Trace t left join [TraceDetail] D on T.guid = D.ParentGuid
	where
		d.ParentGuid is Null and t.Guid = @Guid


GO

SET ANSI_NULLS, QUOTED_IDENTIFIER ON
GO

Create Procedure [RepVillaSales]
(
    @CustGuid uniqueidentifier = 0x0,
    @VillaNo Varchar(256) = '',
    @ComplexName Varchar(256) = '',
    @City Varchar(256) = '',
    @Region Varchar(256) = '',
    @Space Varchar(256) = '',
    @license Varchar(256) = '',
    @FlatArea1 Float = 0,
    @FlatArea2 Float = 0,
    @Date1 Datetime = '1/1/2010',
    @Date2 Datetime = '1/1/2011',
    @SalesManGuid uniqueidentifier = 0x0,
    @ShowIsCheck Bit = 1,
    @ShowIsNotCheck Bit = 1,
    @CheckDate Bit = 1,
    @ActiveNote Bit = 1,
    @OperationNote Varchar(256) = '',
    @RealtyNote Varchar(256) = '',
    @ContractActiveNote bit = 0,
    @ContractOpNote Varchar(256) = '',
    @ContractNote Varchar(256) = '',
    @SalesState int = 0
)
 
as
	
	Set NoCount On 
	--  
	if @OperationNote <> 2 --
	Set @RealtyNote = '%'+@RealtyNote+'%'
	
	--  
	if @ContractOpNote <> 2 --
	Set @ContractNote = '%'+@ContractNote+'%'

	Declare @Tbl Table
	(
		[VillaNo] Varchar(256)
		,[ComplexName] Varchar(256)
		,[City] Varchar(256)
		,[Region] Varchar(256)
		,[Space] Varchar(256)
		,[license] Varchar(256)
		,[Area]  Float
		,[State]  Varchar(256)
		,[CustName] Varchar(256)
		,[CustPhone] Varchar(256)
		,[ContractDateBegin] Datetime
		,[ContractValue] Float
		,[VillaNote] Varchar(1000)
		,[ContractNote] Varchar(1000)
		,[ContractGuid] uniqueidentifier
		,[VillaGuid] uniqueidentifier
	)
	
	insert Into @Tbl
	Select 
		[A].[Name] as [LandName]
		,[A].[ComplexName]
		,[A].[Emirate]
		,[A].[Area]
		,[A].[BasinNo]
		,[A].[DocType]
		,[A].[Area]
		,Case when [L].[Guid] is null then dbo.sc(' ') else dbo.sc('') end as [State]
		,[Cu].[Name] as [CustName]
		,[Cu].[Mobile] as [CustPhone]
		,[L].[FromDate] as [ContractDateBegin]
		,([L].[Rent] - [L].[DiscountValue]) * [L].[CurrencyVal] as [ContractValue]
		,[A].[Details] as [Note]
		,[L].[Note2]
		,[L].[Guid] as [ContractGuid]
		,[A].[Guid]
	from 
		[vwVilla] [A]
		left join [vwLandContract] [L] On [A].[Guid] = [L].[LandGuid] and [ContractKind]  = 8
		left join [vwCustomer] [Cu] on [Cu].[Guid] = [L].[CustomerGuid] 
 	where
 		([Cu].[Guid] = @CustGuid or @CustGuid = 0x0)
		and (
				([L].[Guid] is not null and @SalesState = 0)
				or ([L].[Guid] is null and @SalesState = 1)
				or @SalesState = 2
			)
		and 
			(
				([L].[FromDate] between @Date1 and @Date2)
				or @SalesState <> 0
			)

		and ([L].[SalesManGuid] = @SalesManGuid or @SalesManGuid = 0x0)

		and ([A].[Name] Like '%'+@VillaNo+'%')
		and ([A].[Emirate] Like '%'+@City+'%')
		and ([A].[Area] Like '%'+@Region+'%')
		and ([A].[BasinNo] Like '%'+@Space+'%')
		and ([A].[DocType] Like '%'+@license+'%')

   		and ([A].[Area] between @FlatArea1 and @FlatArea2 or @FlatArea2 = 0) 
   		and 
   			(
   				
   				Case  when (@OperationNote = 0) and ([A].[Details] Like @RealtyNote) then 1
    					  when (@OperationNote = 1) and ([A].[Details] Not Like @RealtyNote) then 1
   					  when (@OperationNote = 2) and ([A].[Details] = @RealtyNote) then 1
   				else 
   					0 end = 1
   					
   				or @ActiveNote = 0
   			)
   
   		and 
   			(
   				Case  when (@ContractOpNote = 0) and ([L].[Note2] Like @ContractNote) then 1
    					  when (@ContractOpNote = 1) and ([L].[Note2] Not Like @ContractNote) then 1
   					  when (@ContractOpNote = 2) and ([L].[Note2] = @ContractNote) then 1
   				else 
   					0 end = 1
   
   				or @ContractActiveNote = 0
  			)


	-- 
	Select
		[P].[ContractGuid],
		Sum(IsNull([C1].[Value] * [C1].[CurrencyVal],0)) as [Collection]
--		+  IsNull([pc].[Value] * [pc].[CurrencyVal],0)) 
	Into #Collection
	From
		[vwChecks] [P]
		left join [vwChecksCollection] [C1] on [C1].[CheckGuid] = [P].[Guid] and [C1].[Kind] = 1
--		left join [ChecksPartialCollection] [pc] on [pc].[CheckGuid] = [P].[Guid]
		inner join @Tbl [t] on [t].[ContractGuid] = [P].[ContractGuid]
	Group By
		[P].[ContractGuid]

	-- 
	Select
		[P].[ContractGuid],
		Sum(IsNull([P].[Value] * [P].[CurrencyVal],0)) as [Cash]
	Into #Cash
	From
		[vwContractCachPayment] [P]
		inner join @Tbl [t] on [t].[ContractGuid] = [P].[ContractGuid]
	Group By
		[P].[ContractGuid]

	Select 
		[T].*,
		[C].[Collection],
		[h].[Cash],
		IsNull([C].[Collection],0) + IsNull([h].[Cash],0) as [TotalPays],
		[ContractValue] - IsNull([C].[Collection],0) - IsNull([h].[Cash],0) as [ContractRest]
	Into #EndTbl
	From
		@Tbl [t] 
		left join #Collection [C] on [t].[ContractGuid] = [C].[ContractGuid]
		left join #Cash [h] on [t].[ContractGuid] = [h].[ContractGuid]
	Order By 
		[VillaNo]

	Select 
		*,
		Case when [R].[ObjGuid] is null then 0 
			 when [R].[ObjGuid] is not null  then 1 end as [Check]
	into #EndRes
	From
		#EndTbl [L]
		left join [RepCheck] [R] on [R].[ObjGuid] = [L].[VillaGuid] and [R].[IdReport] = 5004
	where
		([R].[ObjGuid] is not null and @ShowIsCheck = 1)
		or
		([R].[ObjGuid] is null and @ShowIsNotCheck = 1)
	Order By 
		[VillaNo]


	Select 
		* 
	from 
		#EndRes
	Order By 
		[VillaNo]


GO

SET ANSI_NULLS, QUOTED_IDENTIFIER ON
GO

Create Trigger [TRG_Trace_parking]
on [parking]
 
for update
As
	SET NOCOUNT ON;
	if Not exists(Select Value from DMD_const where vName = 'ActiveLogCardUpdate' and Value = '1' ) return
	
	Declare @UserGuid uniqueidentifier, @Guid uniqueidentifier
	Set @Guid = NEWID()
	
	Select Top 1 @UserGuid = userGuid From CurrentUsers where Spid = @@SPID
			
	insert into [Trace]
	([Guid],[ParentGuid],[Date],[userGuid],[HostName])
	Select Top 1
		@Guid,
		N.Guid,
		GETDATE(),
		@UserGuid,
		Host_Name()
	From
		[inserted] n 
		
	insert into [TraceDetail]
	([ParentGuid],[Caption],[Old],[New],[Tbl])
	Select Top 1
		@Guid,
		' ' as [Caption],
		D.[SecLvl] as [old],
		N.[SecLvl] as [New],
		''
	From
		[deleted] d
		inner join [inserted] n on D.Guid = N.Guid
	where
		N.[SecLvl] <> D.[SecLvl]
		
	insert into [TraceDetail]
	([ParentGuid],[Caption],[Old],[New],[Tbl])
	Select Top 1
		@Guid,
		'' as [Caption],
		D.[Ban] as [old],
		N.[Ban] as [New],
		''
	From
		[deleted] d
		inner join [inserted] n on D.Guid = N.Guid
	where
		N.[Ban] <> D.[Ban]

	insert into [TraceDetail]
	([ParentGuid],[Caption],[Old],[New],[Tbl])
	Select Top 1
		@Guid,
		'' as [Caption],
		D.[NO] as [old],
		N.[NO] as [New],
		''
	From
		[deleted] d
		inner join [inserted] n on D.Guid = N.Guid
	where
		N.[NO] <> D.[NO]
		
	insert into [TraceDetail]
	([ParentGuid],[Caption],[Old],[New],[Tbl])
	Select Top 1
		@Guid,
		'  ' as [Caption],
		D.[Judicial] as [old],
		N.[Judicial] as [New],
		''
	From
		[deleted] d
		inner join [inserted] n on D.Guid = N.Guid
	where
		N.[Judicial] <> D.[Judicial]
		
	insert into [TraceDetail]
	([ParentGuid],[Caption],[Old],[New],[Tbl])
	Select Top 1
		@Guid,
		'' as [Caption],
		D.[BuildingGuid] as [old],
		N.[BuildingGuid] as [New],
		'[Building]'
	From
		[deleted] d
		inner join [inserted] n on D.Guid = N.Guid
	where
		N.[BuildingGuid] <> D.[BuildingGuid]
		
	insert into [TraceDetail]
	([ParentGuid],[Caption],[Old],[New],[Tbl])
	Select Top 1
		@Guid,
		'' as [Caption],
		D.[FloorNo] as [old],
		N.[FloorNo] as [New],
		''
	From
		[deleted] d
		inner join [inserted] n on D.Guid = N.Guid
	where
		N.[FloorNo] <> D.[FloorNo]
		
	insert into [TraceDetail]
	([ParentGuid],[Caption],[Old],[New],[Tbl])
	Select Top 1
		@Guid,
		'' as [Caption],
		D.[Area] as [old],
		N.[Area] as [New],
		''
	From
		[deleted] d
		inner join [inserted] n on D.Guid = N.Guid
	where
		N.[Area] <> D.[Area]
		
	insert into [TraceDetail]
	([ParentGuid],[Caption],[Old],[New],[Tbl])
	Select Top 1
		@Guid,
		'' as [Caption],
		D.[unity] as [old],
		N.[unity] as [New],
		''
	From
		[deleted] d
		inner join [inserted] n on D.Guid = N.Guid
	where
		N.[unity] <> D.[unity]
		
	insert into [TraceDetail]
	([ParentGuid],[Caption],[Old],[New],[Tbl])
	Select Top 1
		@Guid,
		'' as [Caption],
		D.[Note] as [old],
		N.[Note] as [New],
		''
	From
		[deleted] d
		inner join [inserted] n on D.Guid = N.Guid
	where
		N.[Note] <> D.[Note]
		
	insert into [TraceDetail]
	([ParentGuid],[Caption],[Old],[New],[Tbl])
	Select Top 1
		@Guid,
		' ' as [Caption],
		D.[ParkingKind] as [old],
		N.[ParkingKind] as [New],
		''
	From
		[deleted] d
		inner join [inserted] n on D.Guid = N.Guid
	where
		N.[ParkingKind] <> D.[ParkingKind]
		
	insert into [TraceDetail]
	([ParentGuid],[Caption],[Old],[New],[Tbl])
	Select Top 1
		@Guid,
		'' as [Caption],
		D.[Description] as [old],
		N.[Description] as [New],
		''
	From
		[deleted] d
		inner join [inserted] n on D.Guid = N.Guid
	where
		N.[Description] <> D.[Description]
		
	insert into [TraceDetail]
	([ParentGuid],[Caption],[Old],[New],[Tbl])
	Select Top 1
		@Guid,
		'' as [Caption],
		D.[Overlooking] as [old],
		N.[Overlooking] as [New],
		''
	From
		[deleted] d
		inner join [inserted] n on D.Guid = N.Guid
	where
		N.[Overlooking] <> D.[Overlooking]
		
	insert into [TraceDetail]
	([ParentGuid],[Caption],[Old],[New],[Tbl])
	Select Top 1
		@Guid,
		' ' as [Caption],
		D.[CostPrice] as [old],
		N.[CostPrice] as [New],
		''
	From
		[deleted] d
		inner join [inserted] n on D.Guid = N.Guid
	where
		N.[CostPrice] <> D.[CostPrice]
		
	insert into [TraceDetail]
	([ParentGuid],[Caption],[Old],[New],[Tbl])
	Select Top 1
		@Guid,
		'' as [Caption],
		D.[CostCurrencyGUID] as [old],
		N.[CostCurrencyGUID] as [New],
		''
	From
		[deleted] d
		inner join [inserted] n on D.Guid = N.Guid
	where
		N.[CostCurrencyGUID] <> D.[CostCurrencyGUID]
		
	insert into [TraceDetail]
	([ParentGuid],[Caption],[Old],[New],[Tbl])
	Select Top 1
		@Guid,
		' ' as [Caption],
		D.[CostGuid] as [old],
		N.[CostGuid] as [New],
		'[Cost]'
	From
		[deleted] d
		inner join [inserted] n on D.Guid = N.Guid
	where
		N.[CostGuid] <> D.[CostGuid]
		
	insert into [TraceDetail]
	([ParentGuid],[Caption],[Old],[New],[Tbl])
	Select Top 1
		@Guid,
		'' as [Caption],
		D.[FlatOwner] as [old],
		N.[FlatOwner] as [New],
		''
	From
		[deleted] d
		inner join [inserted] n on D.Guid = N.Guid
	where
		N.[FlatOwner] <> D.[FlatOwner]
		
	insert into [TraceDetail]
	([ParentGuid],[Caption],[Old],[New],[Tbl])
	Select Top 1
		@Guid,
		'' as [Caption],
		D.[CustGuid] as [old],
		N.[CustGuid] as [New],
		''
	From
		[deleted] d
		inner join [inserted] n on D.Guid = N.Guid
	where
		N.[CustGuid] <> D.[CustGuid]
		
	insert into [TraceDetail]
	([ParentGuid],[Caption],[Old],[New],[Tbl])
	Select Top 1
		@Guid,
		'' as [Caption],
		D.[Details] as [old],
		N.[Details] as [New],
		''
	From
		[deleted] d
		inner join [inserted] n on D.Guid = N.Guid
	where
		N.[Details] <> D.[Details]
		
	insert into [TraceDetail]
	([ParentGuid],[Caption],[Old],[New],[Tbl])
	Select Top 1
		@Guid,
		'' as [Caption],
		D.[OfferState] as [old],
		N.[OfferState] as [New],
		''
	From
		[deleted] d
		inner join [inserted] n on D.Guid = N.Guid
	where
		N.[OfferState] <> D.[OfferState]
		
	insert into [TraceDetail]
	([ParentGuid],[Caption],[Old],[New],[Tbl])
	Select Top 1
		@Guid,
		' ' as [Caption],
		D.[OfferType] as [old],
		N.[OfferType] as [New],
		''
	From
		[deleted] d
		inner join [inserted] n on D.Guid = N.Guid
	where
		N.[OfferType] <> D.[OfferType]
		
	insert into [TraceDetail]
	([ParentGuid],[Caption],[Old],[New],[Tbl])
	Select Top 1
		@Guid,
		'' as [Caption],
		D.[CustomerName] as [old],
		N.[CustomerName] as [New],
		''
	From
		[deleted] d
		inner join [inserted] n on D.Guid = N.Guid
	where
		N.[CustomerName] <> D.[CustomerName]
		
	insert into [TraceDetail]
	([ParentGuid],[Caption],[Old],[New],[Tbl])
	Select Top 1
		@Guid,
		' ' as [Caption],
		D.[CustomerPhone] as [old],
		N.[CustomerPhone] as [New],
		''
	From
		[deleted] d
		inner join [inserted] n on D.Guid = N.Guid
	where
		N.[CustomerPhone] <> D.[CustomerPhone]
		
	insert into [TraceDetail]
	([ParentGuid],[Caption],[Old],[New],[Tbl])
	Select Top 1
		@Guid,
		'' as [Caption],
		D.[Restrained] as [old],
		N.[Restrained] as [New],
		''
	From
		[deleted] d
		inner join [inserted] n on D.Guid = N.Guid
	where
		N.[Restrained] <> D.[Restrained]
		
	insert into [TraceDetail]
	([ParentGuid],[Caption],[Old],[New],[Tbl])
	Select Top 1
		@Guid,
		' ' as [Caption],
		dbo.fnDate(D.[PurchaseDate]) as [old],
		dbo.fnDate(N.[PurchaseDate]) as [New],
		''
	From
		[deleted] d
		inner join [inserted] n on D.Guid = N.Guid
	where
		N.[PurchaseDate] <> D.[PurchaseDate]
		
	insert into [TraceDetail]
	([ParentGuid],[Caption],[Old],[New],[Tbl])
	Select Top 1
		@Guid,
		' ' as [Caption],
		D.[PayValue] as [old],
		N.[PayValue] as [New],
		''
	From
		[deleted] d
		inner join [inserted] n on D.Guid = N.Guid
	where
		N.[PayValue] <> D.[PayValue]
		
	insert into [TraceDetail]
	([ParentGuid],[Caption],[Old],[New],[Tbl])
	Select Top 1
		@Guid,
		' ' as [Caption],
		D.[RestrainedUserGuid] as [old],
		N.[RestrainedUserGuid] as [New],
		''
	From
		[deleted] d
		inner join [inserted] n on D.Guid = N.Guid
	where
		N.[RestrainedUserGuid] <> D.[RestrainedUserGuid]
		
	insert into [TraceDetail]
	([ParentGuid],[Caption],[Old],[New],[Tbl])
	Select Top 1
		@Guid,
		' ' as [Caption],
		D.[Rent] as [old],
		N.[Rent] as [New],
		''
	From
		[deleted] d
		inner join [inserted] n on D.Guid = N.Guid
	where
		N.[Rent] <> D.[Rent]
		
	insert into [TraceDetail]
	([ParentGuid],[Caption],[Old],[New],[Tbl])
	Select Top 1
		@Guid,
		' ' as [Caption],
		D.[RentCurrencyGUID] as [old],
		N.[RentCurrencyGUID] as [New],
		'Currency'
	From
		[deleted] d
		inner join [inserted] n on D.Guid = N.Guid
	where
		N.[RentCurrencyGUID] <> D.[RentCurrencyGUID]
		
	insert into [TraceDetail]
	([ParentGuid],[Caption],[Old],[New],[Tbl])
	Select Top 1
		@Guid,
		' ' as [Caption],
		D.[Sale] as [old],
		N.[Sale] as [New],
		''
	From
		[deleted] d
		inner join [inserted] n on D.Guid = N.Guid
	where
		N.[Sale] <> D.[Sale]
		
	insert into [TraceDetail]
	([ParentGuid],[Caption],[Old],[New],[Tbl])
	Select Top 1
		@Guid,
		' ' as [Caption],
		D.[SaleCurrencyGUID] as [old],
		N.[SaleCurrencyGUID] as [New],
		'Currency'
	From
		[deleted] d
		inner join [inserted] n on D.Guid = N.Guid
	where
		N.[SaleCurrencyGUID] <> D.[SaleCurrencyGUID]
		
	delete Trace From Trace t left join [TraceDetail] D on T.guid = D.ParentGuid
	where
		d.ParentGuid is Null and t.Guid = @Guid


GO

SET ANSI_NULLS, QUOTED_IDENTIFIER ON
GO

Create Procedure [PrcChangeFlatRent]
(
	@BuildingGuid uniqueidentifier = 0x0,
	@FlatGuid uniqueidentifier = 0x0,
	@RentState int = 2,
	@ApartmentType Varchar(256) = '',
	@FlatKind Varchar(256) = '',
	@Area Float = 0,
	@NewDate Datetime = '1/1/2007',
	
	@Option Int = 2,
	
	@Rent Float = 1485,
	@NewRent  Float = 20,
	
	@RoundKind int  = 0
	,@Note Varchar(256) = ''
	,@Overlooking Varchar(256) = ''
)
 
as
	--   
	if 	@Option  = 0
	begin
		insert into [ChangeFlatRent]
		([Number],[ParentGuid],[Date],[Price],[CurrencyGuid])
		Select Distinct
			isNull([M].[MaxNumber],1),
			[F].[Guid],
			@NewDate,
			dbo.FnMyRound(@Rent, @RoundKind),
			[F].[CostCurrencyGUID]
		From
			[vbApartment][F]
			left join (
							Select
								[ParentGuid],
								isnull(Max([Number]),0) + 1 as [MaxNumber]
							From
								[ChangeFlatRent] [C]
							Group By
								[ParentGuid]
						) [M] on [M].[ParentGuid] = [F].[Guid]
			left join [LeaseApartment] [L] On [L].[ApartmentGuid] = [F].[Guid]
		where 
			([F].[BuildingGuid] = @BuildingGuid or @BuildingGuid = 0x0) 
			and ([F].[ApartmentType] = @ApartmentType or @ApartmentType = '')
			and ([FlatKind] = @FlatKind or @FlatKind = '')
			and ([Area] = @Area Or @Area = 0)
			and (Case when [L].[Guid] is Not null then 0 
					  when [L].[Guid] is null then 1 end = @RentState or @RentState = 2
				)
			and ([F].[Note] = @Note or @Note = '')
			and ([F].[Overlooking] = @Overlooking or @Overlooking	 = '')
			and (F.Guid = @FlatGuid or @FlatGuid = 0x0)

		Select @@RowCount as [RowCount]
	end


	if 	@Option  = 1
	begin
		insert into [ChangeFlatRent]
		([Number],[ParentGuid],[Date],[Price],[CurrencyGuid])
		Select Distinct
			isNull([M].[MaxNumber],1),
			[F].[Guid],
			@NewDate,
			dbo.FnMyRound([R].[Rent]+@Rent, @RoundKind),
			R.[RentCurrencyGuid]
		From
			[Apartment][F]
			left join (
							Select
								[ParentGuid],
								isnull(Max([Number]),0) + 1 as [MaxNumber]
							From
								[ChangeFlatRent] [C]
							Group By
								[ParentGuid]
						) [M] on [M].[ParentGuid] = [F].[Guid]
			left join (
							Select
								[ParentGuid],
								[Price] as [Rent],
								[CurrencyGuid] as [RentCurrencyGuid]
							From
								[ChangeFlatRent] [C]
							where
								[Number] = (Select Max([Number]) From [ChangeFlatRent] [C2] where [C].[ParentGuid] = [C2].[ParentGuid])									
						) [R] on [R].[ParentGuid] = [F].[Guid]
	
			left join [LeaseApartment] [L] On [L].[ApartmentGuid] = [F].[Guid]
		where 
			([F].[BuildingGuid] = @BuildingGuid or @BuildingGuid = 0x0) 
			and ([F].[ApartmentType] = @ApartmentType or @ApartmentType = '')
			and ([FlatKind] = @FlatKind or @FlatKind = '')
			and ([Area] = @Area Or @Area = 0)
			and (Case when [L].[Guid] is Not null then 0 
					  when [L].[Guid] is null then 1 end = @RentState or @RentState = 2
				)
			and ([F].[Note] = @Note or @Note = '')
			and ([F].[Overlooking] = @Overlooking or @Overlooking	 = '')
			and (F.Guid = @FlatGuid or @FlatGuid = 0x0)
	
		Select @@RowCount as [RowCount]
	end


	--   
	if 	@Option  = 2
	begin
		insert into [ChangeFlatRent]
		([Number],[ParentGuid],[Date],[Price],[CurrencyGuid])
		Select Distinct
			isNull([M].[MaxNumber],1),
			[F].[Guid],
			@NewDate,
			dbo.FnMyRound([R].[Rent]*@Rent, @RoundKind),
			R.[RentCurrencyGuid]
		From
			[Apartment][F]
			left join (
							Select
								[ParentGuid],
								isnull(Max([Number]),0) + 1 as [MaxNumber]
							From
								[ChangeFlatRent] [C]
							Group By
								[ParentGuid]
						) [M] on [M].[ParentGuid] = [F].[Guid]
			left join (
							Select
								[ParentGuid],
								[Price] as [Rent],
								[CurrencyGuid] as [RentCurrencyGuid]
							From
								[ChangeFlatRent] [C]
							where
								[Number] = (Select Max([Number]) From [ChangeFlatRent] [C2] where [C].[ParentGuid] = [C2].[ParentGuid])									
						) [R] on [R].[ParentGuid] = [F].[Guid]
	
			left join [LeaseApartment] [L] On [L].[ApartmentGuid] = [F].[Guid]
		where 
			([F].[BuildingGuid] = @BuildingGuid or @BuildingGuid = 0x0) 
			and ([F].[ApartmentType] = @ApartmentType or @ApartmentType = '')
			and ([FlatKind] = @FlatKind or @FlatKind = '')
			and ([Area] = @Area Or @Area = 0)
			and (Case when [L].[Guid] is Not null then 0 
					  when [L].[Guid] is null then 1 end = @RentState or @RentState = 2
				)
			and ([F].[Note] = @Note or @Note = '')
			and ([F].[Overlooking] = @Overlooking or @Overlooking	 = '')
			and (F.Guid = @FlatGuid or @FlatGuid = 0x0)
	
		Select @@RowCount as [RowCount]
	end
	

	--   
	if 	@Option  = 3
	begin
		insert into [ChangeFlatRent]
		([Number],[ParentGuid],[Date],[Price],[CurrencyGuid])
		Select Distinct
			isNull([M].[MaxNumber],1),
			[F].[Guid],
			@NewDate,
			dbo.FnMyRound([R].[Rent]+([R].[Rent]*@Rent /100), @RoundKind),
			R.[RentCurrencyGuid]
		From
			[Apartment][F]
			left join (
							Select
								[ParentGuid],
								isnull(Max([Number]),0) + 1 as [MaxNumber]
							From
								[ChangeFlatRent] [C]
							Group By
								[ParentGuid]
						) [M] on [M].[ParentGuid] = [F].[Guid]
			left join (
							Select
								[ParentGuid],
								[Price] as [Rent],
								[CurrencyGuid] as [RentCurrencyGuid]
							From
								[ChangeFlatRent] [C]
							where
								[Number] = (Select Max([Number]) From [ChangeFlatRent] [C2] where [C].[ParentGuid] = [C2].[ParentGuid])									
						) [R] on [R].[ParentGuid] = [F].[Guid]
	
			left join [LeaseApartment] [L] On [L].[ApartmentGuid] = [F].[Guid]
		where 
			([F].[BuildingGuid] = @BuildingGuid or @BuildingGuid = 0x0) 
			and ([F].[ApartmentType] = @ApartmentType or @ApartmentType = '')
			and ([FlatKind] = @FlatKind or @FlatKind = '')
			and ([Area] = @Area Or @Area = 0)
			and (Case when [L].[Guid] is Not null then 0 
					  when [L].[Guid] is null then 1 end = @RentState or @RentState = 2
				)
			and ([F].[Note] = @Note or @Note = '')
			and ([F].[Overlooking] = @Overlooking or @Overlooking	 = '')
			and (F.Guid = @FlatGuid or @FlatGuid = 0x0)

		Select @@RowCount as [RowCount]
	end

	--    
	if 	@Option  = 4
	begin
		insert into [ChangeFlatRent]
		([Number],[ParentGuid],[Date],[Price],[CurrencyGuid])
		Select Distinct
			isNull([M].[MaxNumber],1),
			[F].[Guid],
			@NewDate,
			dbo.FnMyRound(@NewRent, @RoundKind),
			R.[RentCurrencyGuid]
		From
			[Apartment][F]
			left join (
							Select
								[ParentGuid],
								isnull(Max([Number]),0) + 1 as [MaxNumber]
							From
								[ChangeFlatRent] [C]
							Group By
								[ParentGuid]
						) [M] on [M].[ParentGuid] = [F].[Guid]
			left join (
							Select
								[ParentGuid],
								[Price] as [Rent],
								[CurrencyGuid] as [RentCurrencyGuid]
							From
								[ChangeFlatRent] [C]
							where
								[Number] = (Select Max([Number]) From [ChangeFlatRent] [C2] where [C].[ParentGuid] = [C2].[ParentGuid])									
						) [R] on [R].[ParentGuid] = [F].[Guid]
	
			left join [LeaseApartment] [L] On [L].[ApartmentGuid] = [F].[Guid]
		where 
			([F].[BuildingGuid] = @BuildingGuid or @BuildingGuid = 0x0) 
			and ([F].[ApartmentType] = @ApartmentType or @ApartmentType = '')
			and ([FlatKind] = @FlatKind or @FlatKind = '')
			and ([Area] = @Area Or @Area = 0)
			and [R].[Rent] = @Rent
			and (Case when [L].[Guid] is Not null then 0 
					  when [L].[Guid] is null then 1 end = @RentState or @RentState = 2
				)
			and ([F].[Note] = @Note or @Note = '')
			and ([F].[Overlooking] = @Overlooking or @Overlooking	 = '')
			and (F.Guid = @FlatGuid or @FlatGuid = 0x0)
	
		Select @@RowCount as [RowCount]
	end

	exec PrcSetLastFlatRentPrice 0x0

GO

SET ANSI_NULLS, QUOTED_IDENTIFIER ON
GO
Create Procedure [PrcCrossTrailBalanceCost]
(
	@AccountGuid [uniqueidentifier]= 0x0
	,@BranchGuid uniqueidentifier = 0x0
	,@CostGuid [uniqueidentifier]= 0x0

	,@Level int = 0
	,@ShowEmptyCost Bit = 1

	,@CurrencyGuid [uniqueidentifier] = 0x0
	,@CurrencyVal Float = 1
	,@IsPosted Bit = 1
	,@IsNotPosted Bit = 1
	
	,@CostCode bit = 0
	,@CostName bit = 0

	,@ActiveDate bit = 0
	,@Date1 DateTime = '4/1/2008'
	,@Date2 DateTime = '12/30/2017'
)
 
as
	Set Nocount on
		
	if @CurrencyVal = 0
	Set @CurrencyVal = 1

	if (@CostCode = 0) and (@CostName = 0)
	Set @CostCode = 1

	Declare @Debit_Str varchar(255)
	Set @Debit_Str = dbo.SC('')

	Declare @Credit_Str varchar(255)
	Set @Credit_Str = dbo.SC('')

	Declare @Balance_Str varchar(255)
	Set @Balance_Str = dbo.SC('')

	Declare @Total_Balance_Str varchar(255)
	Set @Total_Balance_Str = dbo.SC(' ')

	Select * into #fnGetAccountList from [dbo].[fnGetAccountList](@AccountGuid)
	Select * into #fnGetCostList from [dbo].[fnGetCostList](@CostGuid)
	
	--Select * from #fnGetCostList

	Declare @CodeNameState int
	if @CostCode = 1 Set @CodeNameState = 1
	if @CostName = 1 Set @CodeNameState = 2
	if @CostCode = 1 and @CostName = 1 Set @CodeNameState = 3
	--   
	Select 
		Case
			when @CodeNameState = 1 then [Co2].[Code]
			when @CodeNameState = 2 then [Co2].[Name]
			when @CodeNameState = 3 then [Co2].[Code]+'-'+[Co2].[Name]
		end  as [CostName]
		,[Co].[Level]
		,[Co].[Path]
		,[Co2].[Guid]
		,[Co2].[ParentGuid]
		,Isnull([SCo].[CoNSons],0) as [CoNSons]
		into #Co
	From
		[dbo].[#fnGetCostList] [Co] 
		inner join [vwCost] [Co2] on [Co2].[Guid] = [Co].[Guid]
		left join (Select 
						Count(Number)as [CoNSons] 
						,[ParentGuid] 
					From 
						[Cost] [SCo] 
					Group By
						[ParentGuid]					
				)[SCo] on [SCo].[ParentGuid] = [Co2].[Guid]

	--  
	
	Select 
		[Ac2].[Code] as [AccountCode]
		,[Ac2].[Name] as [AccountName]
		,[Ac].[Level]
		,[Ac].[Path]
		,[Ac2].[Guid]
		,[Ac2].[ParentGuid]
		,Isnull([SAc].[AcNSons],0) as [AcNSons]
		into #Ac
	From
		[dbo].[#fnGetAccountList] [Ac] 
		inner join [vwAccount] [Ac2] on [Ac2].[Guid] = [Ac].[Guid]
		left join (Select 
						Count(Number)as [AcNSons] 
						,[ParentGuid] 
					From 
						[Account] [SAc] 
					Group By
						[ParentGuid]					
				)[SAc] on [SAc].[ParentGuid] = [Ac2].[Guid]
	where
		[Type] = 0

--	Select * from #Ac Order by [Path]
	--
	
	Create Table ##Entry
	(
		[CostName] varchar(255)
		,[AccountCode] varchar(255)
		,[AccountName] varchar(255)
		,[Debit] Float
		,[Credit] Float
		,[CostGuid] uniqueidentifier
		,[CostParentGuid] uniqueidentifier
		,[Level] int
		,[AccountGuid] uniqueidentifier
		)

	--  
	insert into ##Entry
	Select --Top 50
		[Co].[CostName] as [CostName]
		,[Ac].[AccountCode]	
		,[Ac].[AccountName]	
		,Sum([En].[Debit]*
			Case when [En].[CurrencyGuid] = @CurrencyGuid then 1 
			else [En].[CurrencyVal] / @CurrencyVal end
			) as [Debit]
		,Sum([En].[Credit]*
			Case when [En].[CurrencyGuid] = @CurrencyGuid then 1 
			else [En].[CurrencyVal] / @CurrencyVal end
			) as [Credit]
		,Co.Guid as CostGuid 
		,Co.ParentGuid as CostParentGuid
		,Co.Level
		,Ac.Guid as AccountGuid 
	from 
		[DEntry] [En]
		inner Join [vwEntry] [M] on [M].[Guid] = [En].[ParentGuid]
		inner Join #Ac [Ac] on [Ac].[Guid] = [En].[AcGuid]
		inner Join #Co Co on [Co].[Guid] = [En].[CostGuid]
	where 
		([M].[Date] between @Date1 And @Date2)
		and ([M].[BranchGuid] = @BranchGuid or @BranchGuid = 0x0)
		and (
				([M].[IsPosted] = 1 and @IsPosted = 1)
				or ([M].[IsPosted] = 0  and @IsNotPosted = 1)
			)
	Group By
		[Co].[CostName],
		[Ac].[AccountCode],
		[Ac].[AccountName],
		Co.Guid,
		Co.ParentGuid,
		Co.Level,
		Ac.Guid

	
	Declare @cnt int, @Colevel int
	Set @Colevel = (Select MAX(level) From ##Entry)
	SET @cnt  =1
	WHILE @cnt > 0
	BEGIN
		

		insert into ##Entry
		([CostName] ,[AccountCode],[AccountName] ,[Debit],[Credit],[CostGuid],[CostParentGuid],[Level],[AccountGuid])
		Select
			Co.CostName [CostName] ,
			En.[AccountCode],
			En.[AccountName] ,
			Sum([Debit]),
			Sum([Credit]),
			Co.Guid [CostGuid],
			Co.ParentGUID  [CostParentGuid],
			Co.[Level],
			[AccountGuid]
		From
			#Co Co
			inner join ##Entry En on En.CostParentGuid = Co.Guid
		where
			en.Level = @Colevel
		Group By
			Co.CostName,
			En.[AccountCode],
			En.[AccountName] ,
			Co.Guid,
			Co.ParentGUID,
			Co.[Level],
			[AccountGuid]
			
			
		SET @cnt = @@ROWCOUNT
		
		SET @Colevel = @Colevel - 1
		Print @cnt
	END
	
	Delete ##Entry where Level <> @Level
	
	IF  EXISTS (SELECT * FROM tempdb.dbo.sysobjects WHERE Name = '##Pvt_Cost')
	Drop Table ##Pvt_Cost
	
	IF  EXISTS (SELECT * FROM tempdb.dbo.sysobjects WHERE Name = '##TmpSql_Account_Cost')
	Drop Table ##TmpSql_Account_Cost
	
	
	Create Table ##TmpSql_Account_Cost
	(
		[id] int identity,
		[Sqltext] varchar(8000)
	)
	
	DECLARE @sql varchar(8000)
	SET NOCOUNT ON
	SET ANSI_WARNINGS OFF
	
	Create Table ##Pvt_Cost
	(
		id int identity(1,1),
		CostName varchar(255)
	)
	
	insert into ##Pvt_Cost (CostName)
	Select DISTINCT CostName from ##Entry order By CostName
	
	-----Debit
	insert into ##TmpSql_Account_Cost (Sqltext)
	Select
	'Select
		[AccountCode],
		[AccountName],
		Cast('''+@Debit_Str+''' as varchar(50)) as [Kind],'

	Declare @Cost Varchar(255), @id int
	
	DECLARE @cursor_Debit CURSOR 
	Set @cursor_Debit = CURSOR FAST_FORWARD FOR 

	SELECT id, CostName
	FROM ##Pvt_Cost
	order By
		CostName
	
	OPEN @cursor_Debit
	FETCH NEXT FROM @cursor_Debit INTO @id, @Cost
	
	WHILE @@FETCH_STATUS = 0
	BEGIN
	  
	insert into ##TmpSql_Account_Cost (Sqltext)
	Select
		'
		'''+@Cost+''' = Sum( CASE [CostName] WHEN '+''''+@Cost+''' THEN [Debit] END),'

	  FETCH NEXT FROM @cursor_Debit INTO @id, @Cost
	
	END
	
	CLOSE @cursor_Debit
	DEALLOCATE @cursor_Debit
	
	
	insert into ##TmpSql_Account_Cost (Sqltext)
	Select
		'
		(Select Sum([Debit]) From [##Entry] where AccountGuid = E.AccountGuid) as [Total],
		[AccountGuid],
		2 as Sort
	into ##TblAssem
	from 
		[##Entry] [E]
	Group By 
		[AccountGuid],[AccountCode], [AccountName]'


	--Credit
	insert into ##TmpSql_Account_Cost (Sqltext)
	Select
	'
	insert into ##TblAssem
	Select
		[AccountCode],
		'''',
		Cast('''+@Credit_Str+''' as varchar(50)) as [_],'

	DECLARE @cursor_Credit CURSOR 
	Set @cursor_Credit = CURSOR FAST_FORWARD FOR 

	SELECT id, CostName
	FROM ##Pvt_Cost
	order By
		CostName
	
	OPEN @cursor_Credit
	FETCH NEXT FROM @cursor_Credit INTO @id, @Cost
	
	WHILE @@FETCH_STATUS = 0
	BEGIN
	  
	insert into ##TmpSql_Account_Cost (Sqltext)
	Select
		'
		'''+@Cost+''' = Sum( CASE [CostName] WHEN '+''''+@Cost+''' THEN [Credit] END),'

	  FETCH NEXT FROM @cursor_Credit INTO @id, @Cost
	
	END
	
	CLOSE @cursor_Credit
	DEALLOCATE @cursor_Credit
	
	
	insert into ##TmpSql_Account_Cost (Sqltext)
	Select
		'
		(Select Sum([Credit]) From [##Entry] where AccountGuid = E.AccountGuid) as [Total],
		[AccountGuid],
		3
	from 
		[##Entry] [E]
	Group By 
		[AccountGuid], [AccountCode]'
	
	---------------------------
	--Balance
	insert into ##TmpSql_Account_Cost (Sqltext)
	Select
	'
	insert into ##TblAssem
	Select
		[AccountCode],
		'''',
		Cast('''+@Balance_Str+''' as varchar(50)) as [_],'

	DECLARE @cursor_Balance CURSOR 
	Set @cursor_Balance = CURSOR FAST_FORWARD FOR 

	SELECT id, CostName
	FROM ##Pvt_Cost
	order By
		CostName
	
	OPEN @cursor_Balance
	FETCH NEXT FROM @cursor_Balance INTO @id, @Cost
	
	WHILE @@FETCH_STATUS = 0
	BEGIN
	  
	insert into ##TmpSql_Account_Cost (Sqltext)
	Select
		'
		'''+@Cost+''' = Sum( CASE [CostName] WHEN '+''''+@Cost+''' THEN [Debit]-[Credit] END),'

	  FETCH NEXT FROM @cursor_Balance INTO @id, @Cost
	
	END
	
	CLOSE @cursor_Balance
	DEALLOCATE @cursor_Balance
	
	insert into ##TmpSql_Account_Cost (Sqltext)
	Select
		'
		(Select Sum([Debit]-[Credit]) From [##Entry] where AccountGuid = E.AccountGuid) as [Total],
		[AccountGuid],
		4
	from 
		[##Entry] [E]
	Group By 
		[AccountGuid], [AccountCode]'
	
	---------------------------
	-- 
	insert into ##TmpSql_Account_Cost (Sqltext)
	Select
	'
	
	insert into ##TblAssem
	Select
		Cast('''+@Total_Balance_Str+''' as varchar(50)) as [AccountCode],
		'''',
		Cast('''+@Total_Balance_Str+''' as varchar(50)) as [_],'

	DECLARE @cursor_endBalance CURSOR 
	Set @cursor_endBalance = CURSOR FAST_FORWARD FOR 

	SELECT id, CostName
	FROM ##Pvt_Cost
	order By
		CostName
	
	OPEN @cursor_endBalance
	FETCH NEXT FROM @cursor_endBalance INTO @id, @Cost
	
	WHILE @@FETCH_STATUS = 0
	BEGIN
	  
	insert into ##TmpSql_Account_Cost (Sqltext)
	Select
		'
		'''+@Cost+''' = Sum( CASE [CostName] WHEN '+''''+@Cost+''' THEN [Debit]-[Credit] END),'

	  FETCH NEXT FROM @cursor_endBalance INTO @id, @Cost
	
	END
	
	CLOSE @cursor_endBalance
	DEALLOCATE @cursor_endBalance
	-----
	
	insert into ##TmpSql_Account_Cost (Sqltext)
	Select
		'
		(Select Sum([Debit]-[Credit]) From [##Entry] ) as [Total],
		0x0 as [AccountGuid],
		5
	from 
		[##Entry] [E]'
	-----------------------------
	
	exec DropObject '##TblAssem'


	Select * from ##TmpSql_Account_Cost order By id
	return --  
	
	
	IF  EXISTS (SELECT * FROM tempdb.dbo.sysobjects WHERE Name = '##TblAssem')
	Drop Table ##TblAssem
	Declare @R int, @MaxR int
	Set @MaxR = (Select MAX(id) from ##TmpSql_Account_Cost)
	Set @sql = ''
	
	Set @R = 0
	while @R < @MaxR+1
	begin
		--Select @R
		Set @sql = @sql + IsNull((Select sqltext from ##TmpSql_Account_Cost where id = @R) ,'')
		Set @R = @R + 1
	end
	Print @sql
	exec(@sql)
	
	Select * from ##TblAssem order by AccountCode, Sort
	
	/*
	--Prc_Tar_GetBudgetCostCustDetail_2
	Select 
		B.GroupCode,
		B.GroupName,B.MatCode ,
		B.MatName ,
		B.CostQty  as [Qty],
		'' as TotalCustQty,
		'' as TotalCustPercent,
		R.*,
		B.path,
		B.Flag
	from
		##BudgetMatCustDetail_loadDetail B
		left join ##TblAssem R  on (B.MatGuid = R.matGuid) or (B.GroupGuid = R.GroupGuid and R.MatGuid is null and B.Flag = 1)
	order by
		B.path,
		B.MatCode
		
	Select DISTINCT CustName, CustGuid from ##Entry
	Order By
		CustName
	*/
	
	SET ANSI_WARNINGS ON

GO

SET ANSI_NULLS, QUOTED_IDENTIFIER ON
GO

Create Trigger [TRG_Trace_ContractWorkFlow]
on [ContractWorkFlow]
 for update
As
	SET NOCOUNT ON;
	if Not exists(Select Value from DMD_const where vName = 'ActiveLogCardUpdate' and Value = '1' ) return
	
	Declare @UserGuid uniqueidentifier, @Guid uniqueidentifier
	Set @Guid = NEWID()
	
	Select Top 1 @UserGuid = userGuid From CurrentUsers where Spid = @@SPID
			
	insert into [Trace]
	([Guid],[ParentGuid],[Date],[userGuid],[HostName])
	Select Top 1
		@Guid,
		N.Guid,
		GETDATE(),
		@UserGuid,
		Host_Name()
	From
		[inserted] n 
		
	insert into [TraceDetail]
	([ParentGuid],[Caption],[Old],[New],[Tbl])
	Select Top 1
		@Guid,
		' ' as [Caption],
		D.[SecLvl] as [old],
		N.[SecLvl] as [New],
		''
	From
		[deleted] d
		inner join [inserted] n on D.Guid = N.Guid
	where
		N.[SecLvl] <> D.[SecLvl]
		
	insert into [TraceDetail]
	([ParentGuid],[Caption],[Old],[New],[Tbl])
	Select Top 1
		@Guid,
		'' as [Caption],
		D.[ContractGuid] as [old],
		N.[ContractGuid] as [New],
		'vwAllContract'
	From
		[deleted] d
		inner join [inserted] n on D.Guid = N.Guid
	where
		N.[ContractGuid] <> D.[ContractGuid]
		
	insert into [TraceDetail]
	([ParentGuid],[Caption],[Old],[New],[Tbl])
	Select Top 1
		@Guid,
		'' as [Caption],
		Case 
			when d.[Printed] = 1 then dbo.sc('  ')  
			when d.[Printed] = 2 then dbo.sc('    ')  
			when d.[Printed] = 3 then dbo.sc(' ')  
			when isNull(d.[Printed],-1) = -1 then dbo.sc(' ')  
		end as [old],
		Case 
			when N.[Printed] = 1 then dbo.sc('  ')  
			when N.[Printed] = 2 then dbo.sc('    ')  
			when N.[Printed] = 3 then dbo.sc(' ')  
			when isNull(N.[Printed],-1) = -1 then dbo.sc(' ')  
		end as [New],
		''
	From
		[deleted] d
		inner join [inserted] n on D.Guid = N.Guid
	where
		N.[Printed] <> D.[Printed]
		
	insert into [TraceDetail]
	([ParentGuid],[Caption],[Old],[New],[Tbl])
	Select Top 1
		@Guid,
		' ' as [Caption],
		Case when [D].[Certification] = 1 then dbo.SC('') when [D].[Certification] = 1 then dbo.SC('') end as [old],
		Case when [N].[Certification] = 1 then dbo.SC('') when [N].[Certification] = 1 then dbo.SC('') end as [New],
		''
	From
		[deleted] d
		inner join [inserted] n on D.Guid = N.Guid
	where
		N.[Certification] <> D.[Certification]
		
	insert into [TraceDetail]
	([ParentGuid],[Caption],[Old],[New],[Tbl])
	Select Top 1
		@Guid,
		'   ' as [Caption],
		D.[CustStep1] as [old],
		N.[CustStep1] as [New],
		''
	From
		[deleted] d
		inner join [inserted] n on D.Guid = N.Guid
	where
		N.[CustStep1] <> D.[CustStep1]
		
	insert into [TraceDetail]
	([ParentGuid],[Caption],[Old],[New],[Tbl])
	Select Top 1
		@Guid,
		'   ' as [Caption],
		dbo.fnDate(D.[CustStepDate1]) as [old],
		dbo.fnDate(N.[CustStepDate1]) as [New],
		''
	From
		[deleted] d
		inner join [inserted] n on D.Guid = N.Guid
	where
		N.[CustStepDate1] <> D.[CustStepDate1]
		
	insert into [TraceDetail]
	([ParentGuid],[Caption],[Old],[New],[Tbl])
	Select Top 1
		@Guid,
		'     ' as [Caption],
		D.[CustStep2] as [old],
		N.[CustStep2] as [New],
		''
	From
		[deleted] d
		inner join [inserted] n on D.Guid = N.Guid
	where
		N.[CustStep2] <> D.[CustStep2]
		
	insert into [TraceDetail]
	([ParentGuid],[Caption],[Old],[New],[Tbl])
	Select Top 1
		@Guid,
		'     ' as [Caption],
		dbo.fnDate(D.[CustStepDate2]) as [old],
		dbo.fnDate(N.[CustStepDate2]) as [New],
		''
	From
		[deleted] d
		inner join [inserted] n on D.Guid = N.Guid
	where
		N.[CustStepDate2] <> D.[CustStepDate2]
		
	insert into [TraceDetail]
	([ParentGuid],[Caption],[Old],[New],[Tbl])
	Select Top 1
		@Guid,
		'    ' as [Caption],
		D.[CompStep1] as [old],
		N.[CompStep1] as [New],
		''
	From
		[deleted] d
		inner join [inserted] n on D.Guid = N.Guid
	where
		N.[CompStep1] <> D.[CompStep1]
		
	insert into [TraceDetail]
	([ParentGuid],[Caption],[Old],[New],[Tbl])
	Select Top 1
		@Guid,
		'    ' as [Caption],
		dbo.fnDate(D.[CompStepDate1]) as [old],
		dbo.fnDate(N.[CompStepDate1]) as [New],
		''
	From
		[deleted] d
		inner join [inserted] n on D.Guid = N.Guid
	where
		N.[CompStepDate1] <> D.[CompStepDate1]
		
	insert into [TraceDetail]
	([ParentGuid],[Caption],[Old],[New],[Tbl])
	Select Top 1
		@Guid,
		'    ' as [Caption],
		D.[CompStep2] as [old],
		N.[CompStep2] as [New],
		''
	From
		[deleted] d
		inner join [inserted] n on D.Guid = N.Guid
	where
		N.[CompStep2] <> D.[CompStep2]
		
	insert into [TraceDetail]
	([ParentGuid],[Caption],[Old],[New],[Tbl])
	Select Top 1
		@Guid,
		'    ' as [Caption],
		dbo.fnDate(D.[CompStepDate2]) as [old],
		dbo.fnDate(N.[CompStepDate2]) as [New],
		''
	From
		[deleted] d
		inner join [inserted] n on D.Guid = N.Guid
	where
		N.[CompStepDate2] <> D.[CompStepDate2]
		
	insert into [TraceDetail]
	([ParentGuid],[Caption],[Old],[New],[Tbl])
	Select Top 1
		@Guid,
		'    ' as [Caption],
		D.[CompStep3] as [old],
		N.[CompStep3] as [New],
		''
	From
		[deleted] d
		inner join [inserted] n on D.Guid = N.Guid
	where
		N.[CompStep3] <> D.[CompStep3]
		
	insert into [TraceDetail]
	([ParentGuid],[Caption],[Old],[New],[Tbl])
	Select Top 1
		@Guid,
		'    ' as [Caption],
		dbo.fnDate(D.[CompStepDate3]) as [old],
		dbo.fnDate(N.[CompStepDate3]) as [New],
		''
	From
		[deleted] d
		inner join [inserted] n on D.Guid = N.Guid
	where
		N.[CompStepDate3] <> D.[CompStepDate3]
		
	insert into [TraceDetail]
	([ParentGuid],[Caption],[Old],[New],[Tbl])
	Select Top 1
		@Guid,
		'    ' as [Caption],
		D.[CompStep4] as [old],
		N.[CompStep4] as [New],
		''
	From
		[deleted] d
		inner join [inserted] n on D.Guid = N.Guid
	where
		N.[CompStep4] <> D.[CompStep4]
		
	insert into [TraceDetail]
	([ParentGuid],[Caption],[Old],[New],[Tbl])
	Select Top 1
		@Guid,
		'    ' as [Caption],
		dbo.fnDate(D.[CompStepDate4]) as [old],
		dbo.fnDate(N.[CompStepDate4]) as [New],
		''
	From
		[deleted] d
		inner join [inserted] n on D.Guid = N.Guid
	where
		N.[CompStepDate4] <> D.[CompStepDate4]
		
	insert into [TraceDetail]
	([ParentGuid],[Caption],[Old],[New],[Tbl])
	Select Top 1
		@Guid,
		'' as [Caption],
		D.[Note] as [old],
		N.[Note] as [New],
		''
	From
		[deleted] d
		inner join [inserted] n on D.Guid = N.Guid
	where
		N.[Note] <> D.[Note]
		
	delete Trace From Trace t left join [TraceDetail] D on T.guid = D.ParentGuid
	where
		d.ParentGuid is Null and t.Guid = @Guid


GO

SET ANSI_NULLS, QUOTED_IDENTIFIER ON
GO

Create Trigger [TRG_Trace_TransType]
on [TransType]
 
for update
As
	SET NOCOUNT ON;
	if Not exists(Select Value from DMD_const where vName = 'ActiveLogCardUpdate' and Value = '1' ) return
	
	Declare @UserGuid uniqueidentifier, @Guid uniqueidentifier
	Set @Guid = NEWID()
	
	Select Top 1 @UserGuid = userGuid From CurrentUsers where Spid = @@SPID
			
	insert into [Trace]
	([Guid],[ParentGuid],[Date],[userGuid],[HostName],ParentTbl)
	Select Top 1
		@Guid,
		N.Guid,
		GETDATE(),
		@UserGuid,
		Host_Name(),
		'TransType'
	From
		[inserted] n 
		
	insert into [TraceDetail]
	([ParentGuid],[Caption],[Old],[New],[Tbl])
	Select Top 1
		@Guid,
		' ' as [Caption],
		D.[SecLvl] as [old],
		N.[SecLvl] as [New],
		''
	From
		[deleted] d
		inner join [inserted] n on D.Guid = N.Guid
	where
		N.[SecLvl] <> D.[SecLvl]
		
	insert into [TraceDetail]
	([ParentGuid],[Caption],[Old],[New],[Tbl])
	Select Top 1
		@Guid,
		'' as [Caption],
		D.[Code] as [old],
		N.[Code] as [New],
		''
	From
		[deleted] d
		inner join [inserted] n on D.Guid = N.Guid
	where
		N.[Code] <> D.[Code]
		
	insert into [TraceDetail]
	([ParentGuid],[Caption],[Old],[New],[Tbl])
	Select Top 1
		@Guid,
		'' as [Caption],
		D.[Name] as [old],
		N.[Name] as [New],
		''
	From
		[deleted] d
		inner join [inserted] n on D.Guid = N.Guid
	where
		N.[Name] <> D.[Name]
		
	insert into [TraceDetail]
	([ParentGuid],[Caption],[Old],[New],[Tbl])
	Select Top 1
		@Guid,
		' ' as [Caption],
		D.[LtnName] as [old],
		N.[LtnName] as [New],
		''
	From
		[deleted] d
		inner join [inserted] n on D.Guid = N.Guid
	where
		N.[LtnName] <> D.[LtnName]
		
	insert into [TraceDetail]
	([ParentGuid],[Caption],[Old],[New],[Tbl])
	Select Top 1
		@Guid,
		' ' as [Caption],
		D.[Menu] as [old],
		N.[Menu] as [New],
		''
	From
		[deleted] d
		inner join [inserted] n on D.Guid = N.Guid
	where
		N.[Menu] <> D.[Menu]
		
	insert into [TraceDetail]
	([ParentGuid],[Caption],[Old],[New],[Tbl])
	Select Top 1
		@Guid,
		'  ' as [Caption],
		D.[LtnMenu] as [old],
		N.[LtnMenu] as [New],
		''
	From
		[deleted] d
		inner join [inserted] n on D.Guid = N.Guid
	where
		N.[LtnMenu] <> D.[LtnMenu]
		
	insert into [TraceDetail]
	([ParentGuid],[Caption],[Old],[New],[Tbl])
	Select Top 1
		@Guid,
		' ' as [Caption],
		D.[ShortCut] as [old],
		N.[ShortCut] as [New],
		''
	From
		[deleted] d
		inner join [inserted] n on D.Guid = N.Guid
	where
		N.[ShortCut] <> D.[ShortCut]
		
	insert into [TraceDetail]
	([ParentGuid],[Caption],[Old],[New],[Tbl])
	Select Top 1
		@Guid,
		'  ' as [Caption],
		D.[DefPrintPath] as [old],
		N.[DefPrintPath] as [New],
		''
	From
		[deleted] d
		inner join [inserted] n on D.Guid = N.Guid
	where
		N.[DefPrintPath] <> D.[DefPrintPath]
		
	insert into [TraceDetail]
	([ParentGuid],[Caption],[Old],[New],[Tbl])
	Select Top 1
		@Guid,
		'' as [Caption],
		D.[Note] as [old],
		N.[Note] as [New],
		''
	From
		[deleted] d
		inner join [inserted] n on D.Guid = N.Guid
	where
		N.[Note] <> D.[Note]
		
	insert into [TraceDetail]
	([ParentGuid],[Caption],[Old],[New],[Tbl])
	Select Top 1
		@Guid,
		'  1' as [Caption],
		D.[Color1] as [old],
		N.[Color1] as [New],
		''
	From
		[deleted] d
		inner join [inserted] n on D.Guid = N.Guid
	where
		N.[Color1] <> D.[Color1]
		
	insert into [TraceDetail]
	([ParentGuid],[Caption],[Old],[New],[Tbl])
	Select Top 1
		@Guid,
		'  2' as [Caption],
		D.[Color2] as [old],
		N.[Color2] as [New],
		''
	From
		[deleted] d
		inner join [inserted] n on D.Guid = N.Guid
	where
		N.[Color2] <> D.[Color2]
		
	insert into [TraceDetail]
	([ParentGuid],[Caption],[Old],[New],[Tbl])
	Select Top 1
		@Guid,
		'  ' as [Caption],
		D.[DefCostinGuid] as [old],
		N.[DefCostinGuid] as [New],
		'[Cost]'
	From
		[deleted] d
		inner join [inserted] n on D.Guid = N.Guid
	where
		N.[DefCostinGuid] <> D.[DefCostinGuid]
		
	insert into [TraceDetail]
	([ParentGuid],[Caption],[Old],[New],[Tbl])
	Select Top 1
		@Guid,
		' ' as [Caption],
		D.[DefStoreInGuid] as [old],
		N.[DefStoreInGuid] as [New],
		'[Store]'
	From
		[deleted] d
		inner join [inserted] n on D.Guid = N.Guid
	where
		N.[DefStoreInGuid] <> D.[DefStoreInGuid]
		
	insert into [TraceDetail]
	([ParentGuid],[Caption],[Old],[New],[Tbl])
	Select Top 1
		@Guid,
		'  ' as [Caption],
		D.[DefCostOutGuid] as [old],
		N.[DefCostOutGuid] as [New],
		'[Cost]'
	From
		[deleted] d
		inner join [inserted] n on D.Guid = N.Guid
	where
		N.[DefCostOutGuid] <> D.[DefCostOutGuid]
		
	insert into [TraceDetail]
	([ParentGuid],[Caption],[Old],[New],[Tbl])
	Select Top 1
		@Guid,
		' ' as [Caption],
		D.[DefStoreOutGuid] as [old],
		N.[DefStoreOutGuid] as [New],
		'[Store]'
	From
		[deleted] d
		inner join [inserted] n on D.Guid = N.Guid
	where
		N.[DefStoreOutGuid] <> D.[DefStoreOutGuid]
		
	insert into [TraceDetail]
	([ParentGuid],[Caption],[Old],[New],[Tbl])
	Select Top 1
		@Guid,
		'  ' as [Caption],
		D.[PostToStores] as [old],
		N.[PostToStores] as [New],
		''
	From
		[deleted] d
		inner join [inserted] n on D.Guid = N.Guid
	where
		N.[PostToStores] <> D.[PostToStores]
		
	insert into [TraceDetail]
	([ParentGuid],[Caption],[Old],[New],[Tbl])
	Select Top 1
		@Guid,
		'   ' as [Caption],
		D.[PostToStoresAuto] as [old],
		N.[PostToStoresAuto] as [New],
		''
	From
		[deleted] d
		inner join [inserted] n on D.Guid = N.Guid
	where
		N.[PostToStoresAuto] <> D.[PostToStoresAuto]
		
	delete Trace From Trace t left join [TraceDetail] D on T.guid = D.ParentGuid
	where
		d.ParentGuid is Null and t.Guid = @Guid


GO

SET ANSI_NULLS, QUOTED_IDENTIFIER ON
GO

Create Trigger [TRG_Trace_AssetsOperation]
on [AssetsOperation]
 
for update
As
	SET NOCOUNT ON;
	if Not exists(Select Value from DMD_const where vName = 'ActiveLogCardUpdate' and Value = '1' ) return
	
	Declare @UserGuid uniqueidentifier, @Guid uniqueidentifier
	Set @Guid = NEWID()
	
	Select Top 1 @UserGuid = userGuid From CurrentUsers where Spid = @@SPID
			
	insert into [Trace]
	([Guid],[ParentGuid],[Date],[userGuid],[HostName],parenttbl)
	Select Top 1
		@Guid,
		N.Guid,
		GETDATE(),
		@UserGuid,
		Host_Name(),
		'AssetsOperation'
	From
		[inserted] n 
		
	insert into [TraceDetail]
	([ParentGuid],[Caption],[Old],[New],[Tbl])
	Select Top 1
		@Guid,
		' ' as [Caption],
		D.[SecLvl] as [old],
		N.[SecLvl] as [New],
		''
	From
		[deleted] d
		inner join [inserted] n on D.Guid = N.Guid
	where
		N.[SecLvl] <> D.[SecLvl]
		
	insert into [TraceDetail]
	([ParentGuid],[Caption],[Old],[New],[Tbl])
	Select Top 1
		@Guid,
		'Flag' as [Caption],
		D.[Flag] as [old],
		N.[Flag] as [New],
		''
	From
		[deleted] d
		inner join [inserted] n on D.Guid = N.Guid
	where
		N.[Flag] <> D.[Flag]
		
	insert into [TraceDetail]
	([ParentGuid],[Caption],[Old],[New],[Tbl])
	Select Top 1
		@Guid,
		'' as [Caption],
		D.[AssetsGuid] as [old],
		N.[AssetsGuid] as [New],
		'[Assets]'
	From
		[deleted] d
		inner join [inserted] n on D.Guid = N.Guid
	where
		N.[AssetsGuid] <> D.[AssetsGuid]
		
	insert into [TraceDetail]
	([ParentGuid],[Caption],[Old],[New],[Tbl])
	Select Top 1
		@Guid,
		'' as [Caption],
		dbo.fnDate(D.[Date]) as [old],
		dbo.fnDate(N.[Date]) as [New],
		''
	From
		[deleted] d
		inner join [inserted] n on D.Guid = N.Guid
	where
		N.[Date] <> D.[Date]
		
	insert into [TraceDetail]
	([ParentGuid],[Caption],[Old],[New],[Tbl])
	Select Top 1
		@Guid,
		'' as [Caption],
		D.[AccountGuid] as [old],
		N.[AccountGuid] as [New],
		'[Account]'
	From
		[deleted] d
		inner join [inserted] n on D.Guid = N.Guid
	where
		N.[AccountGuid] <> D.[AccountGuid]
		
	insert into [TraceDetail]
	([ParentGuid],[Caption],[Old],[New],[Tbl])
	Select Top 1
		@Guid,
		'' as [Caption],
		D.[Value] as [old],
		N.[Value] as [New],
		''
	From
		[deleted] d
		inner join [inserted] n on D.Guid = N.Guid
	where
		N.[Value] <> D.[Value]
		
	insert into [TraceDetail]
	([ParentGuid],[Caption],[Old],[New],[Tbl])
	Select Top 1
		@Guid,
		'' as [Caption],
		D.[CurrencyGUID] as [old],
		N.[CurrencyGUID] as [New],
		'[Currency]'
	From
		[deleted] d
		inner join [inserted] n on D.Guid = N.Guid
	where
		N.[CurrencyGUID] <> D.[CurrencyGUID]
		
	insert into [TraceDetail]
	([ParentGuid],[Caption],[Old],[New],[Tbl])
	Select Top 1
		@Guid,
		' ' as [Caption],
		D.[CurrencyVal] as [old],
		N.[CurrencyVal] as [New],
		''
	From
		[deleted] d
		inner join [inserted] n on D.Guid = N.Guid
	where
		N.[CurrencyVal] <> D.[CurrencyVal]
		
	insert into [TraceDetail]
	([ParentGuid],[Caption],[Old],[New],[Tbl])
	Select Top 1
		@Guid,
		' ' as [Caption],
		D.[Age] as [old],
		N.[Age] as [New],
		''
	From
		[deleted] d
		inner join [inserted] n on D.Guid = N.Guid
	where
		N.[Age] <> D.[Age]
		
	insert into [TraceDetail]
	([ParentGuid],[Caption],[Old],[New],[Tbl])
	Select Top 1
		@Guid,
		'  ' as [Caption],
		D.[ScrapValue] as [old],
		N.[ScrapValue] as [New],
		''
	From
		[deleted] d
		inner join [inserted] n on D.Guid = N.Guid
	where
		N.[ScrapValue] <> D.[ScrapValue]
		
	insert into [TraceDetail]
	([ParentGuid],[Caption],[Old],[New],[Tbl])
	Select Top 1
		@Guid,
		'  ' as [Caption],
		D.[DebitCostGuid] as [old],
		N.[DebitCostGuid] as [New],
		'[Cost]'
	From
		[deleted] d
		inner join [inserted] n on D.Guid = N.Guid
	where
		N.[DebitCostGuid] <> D.[DebitCostGuid]
		
	insert into [TraceDetail]
	([ParentGuid],[Caption],[Old],[New],[Tbl])
	Select Top 1
		@Guid,
		'  ' as [Caption],
		D.[CreditCostGuid] as [old],
		N.[CreditCostGuid] as [New],
		'[Cost]'
	From
		[deleted] d
		inner join [inserted] n on D.Guid = N.Guid
	where
		N.[CreditCostGuid] <> D.[CreditCostGuid]
		
	insert into [TraceDetail]
	([ParentGuid],[Caption],[Old],[New],[Tbl])
	Select Top 1
		@Guid,
		'' as [Caption],
		D.[Note] as [old],
		N.[Note] as [New],
		''
	From
		[deleted] d
		inner join [inserted] n on D.Guid = N.Guid
	where
		N.[Note] <> D.[Note]
		
	delete Trace From Trace t left join [TraceDetail] D on T.guid = D.ParentGuid
	where
		d.ParentGuid is Null and t.Guid = @Guid


GO

SET ANSI_NULLS, QUOTED_IDENTIFIER ON
GO

Create Procedure [PrcContractCheckPayment]
(
	@CustGuid uniqueidentifier = 0x0
	,@Nationality Varchar(256) = ''
	,@Purpose Varchar(256) = ''
	,@Emirate Varchar(256) = ''
	,@Suburb Varchar(256) = ''
	,@Area Varchar(256) = ''
	,@Street Varchar(256) = ''
	,@FlatKind Varchar(256) = ''
	,@ApartmentType Varchar(256) = ''
	,@ContractState int = 1
	,@Judicial int = 2
	,@PayType int = 4
	,@Datewith int = 0
	,@Date1 DateTime = '12/30/1899'
	,@Date2 DateTime = '12/30/2016'
	,@RentInfoGuid uniqueidentifier = 0x0
	,@SalesManGuid uniqueidentifier = 0x0
	,@ShowIsCheck Bit = 1
	,@ShowIsNotCheck Bit = 1
	,@CKDate Bit = 0
	,@EndState int = 2
	,@NewState int = 2
	,@Mark Bit = 1
	,@NotMark Bit = 1
	,@AutoRenewal int = 2
	,@AcquittancePrinted int = 2
	,@AcquittancePrintedByUserGuid uniqueidentifier = 0x0
	,@LinkCheck int = 2
	,@FldCurrentContract bit = 1
	,@BanRealty int = 0
	,@whereabouts varchar(255) = ''
	,@Trademark varchar(255) = ''
	,@FinishDate int = 3
)
 
as
	Set noCount on
	Declare @Tbl Table
	(
		[ContractNo] Varchar(256)
		,[FlatNo] Varchar(256)
		,[BuildingName] Varchar(256)
		,[Value] Float
		,[Discount] Float
		,[ValueAfterDiscount] Float
		,[FlatKind] Varchar(256)
		,[FlatType] Varchar(256)
		,[FlatArea] Varchar(256)
		,[ContractState] Varchar(256)
		,[Emirate] Varchar(256)
		,[Suburb] Varchar(256)
		,[Area] Varchar(256)
		,[Street] Varchar(256)
		,[FloorNo] Varchar(256)
		,[CustName] Varchar(256)
		,[CustPhone] Varchar(256)
		,[CustNationality] Varchar(256)
		,[CustEMail] Varchar(256)
		,[ContractDateEdit] Datetime
		,[ContractDeliverDate] Datetime
		,[ContractDateBegin] Datetime
		,[ContractDateEnd] Datetime
		,[ContractType] Varchar(256)
		,[ContractFinish] Bit
		,[ContractGuid] uniqueidentifier
		,[NewState] int

		,[RentMan] Varchar(256)
		,[SalesMan] Varchar(256)
		,[ContractFinishDate] Datetime
		,[ResultingAmount] Float
		,[ResultingAmount2] Float
		,[Fine] Float
		,[TotalIncom] Float
		,[TotalInsuranse] Float
		,[RentCleanValue] Float
		,[Note2] Varchar(1000)
		,[Purpose] Varchar(256)
		,Trademark Varchar(256)
		
		,[CountOldContract] int
		,[CountCurrentContract] int
		
		,[AcquittancePrinted] Bit
		,[AcquittancePrintdate] Datetime
		,[AcquittancePrintedBy] Varchar(256)
		,[CostGuid] uniqueidentifier
		,[AccountGuid] uniqueidentifier
		,[Judicial] Bit
		,[Mark] Bit
		,[isAutoRenewal] Bit
		,[PrvContractFinishDate] Datetime
		,[PrvContractEndDate] Datetime
		,[Kind] Int
		,[Sort] int
	)

	Declare  @Now_Date Datetime
	Set @Now_Date = GetDate()
	
	--  
	Create Table #CurrentContract
	(
		CustomerGuid uniqueidentifier,
		ApartmentGuid uniqueidentifier,
		[ContractCount] int
	)
	
	if @FldCurrentContract = 1
	begin
		insert into #CurrentContract
		Select 
			CustomerGuid,
			ApartmentGuid,
			IsNull(COUNT(*),0) as [ContractCount]
		From 
			[LeaseApartment]
		Group By
			CustomerGuid,
			ApartmentGuid
	end
	
	--Building
	Select
		*
	Into #Building_CL
	From
		[vwBuilding] B
	where
		([B].[Emirate] = @Emirate or @Emirate = '')
		and ([B].[Suburb] = @Suburb or @Suburb = '')
		and ([B].[Area] = @Area or @Area = '')
		and ([B].[Street] = @Street or @Street = '')
		
	
	
    select Distinct
		ContractKind
	into #Resource_Type
	From
		ContractType T
		inner join [Resource] [R2] on [R2].[Guid] = [T].[Guid]  and [R2].[Kind] = 100 and [R2].[spid] = @@Spid 
		
	
	--return
		

	--Select * from #Building_CL
		
	--[vwLeaseApartment]
	Declare @p_RentFlat bit,
			@p_RentShop bit,
			@p_SaleFlat bit,
			@p_SaleShop bit,
			@p_RentParking bit,
			@p_SaleParking bit,
			@p_SaleLand bit,
			@p_RentLand bit,
			@p_SaleVilla bit,
			@p_RentVilla bit
			
	if exists(Select * From #Resource_Type where ContractKind = 0)
	Set @p_RentFlat = 1 else Set @p_RentFlat = 0
	
	if exists(Select * From #Resource_Type where ContractKind = 1)
	Set @p_RentShop = 1 else Set @p_RentShop = 0 

	if exists(Select * From #Resource_Type where ContractKind = 2)
	Set @p_SaleFlat = 1 else Set @p_SaleFlat = 0 

	if exists(Select * From #Resource_Type where ContractKind = 3)
	Set @p_SaleShop = 1 else Set @p_SaleShop = 0 

	if exists(Select * From #Resource_Type where ContractKind = 4)
	Set @p_RentParking = 1 else Set @p_RentParking = 0 

	if exists(Select * From #Resource_Type where ContractKind = 5)
	Set @p_SaleParking = 1 else Set @p_SaleParking = 0 

	if exists(Select * From #Resource_Type where ContractKind = 6)
	Set @p_SaleLand = 1 else Set @p_SaleLand = 0 

	if exists(Select * From #Resource_Type where ContractKind = 7)
	Set @p_RentLand = 1 else Set @p_RentLand = 0 

	if exists(Select * From #Resource_Type where ContractKind = 8)
	Set @p_SaleVilla = 1 else Set @p_SaleVilla = 0 

	if exists(Select * From #Resource_Type where ContractKind = 9)
	Set @p_RentVilla = 1 else Set @p_RentVilla = 0 
	
	Select
		L.*
		,T.Name as ContractName
		,[L].[Judicial] as [ContractJudicial]
		,(Select [ContractFinishDate] from [LeaseApartment] where Guid = L.[PrvContractGuid]) as [PrvContractFinishDate]
		,(Select [ToDate] from [LeaseApartment] where Guid = L.[PrvContractGuid]) as [PrvContractEndDate]
		,U.LoginName as [AcquittancePrintedBy]
		,S.Name as [SalesMan]
	into #LeaseApartment_CL
	From
		[LeaseApartment] L
		inner join ContractType T on T.Guid = L.TypeGuid
		inner join [Resource] [R2] on [R2].[Guid] = [L].[TypeGuid]  and [R2].[Kind] = 100 and [R2].[spid] = @@Spid 
		left join [Realty_Users] U on U.[Guid] = L.AcquittancePrintedByGuid
		left join Salesman S on S.Guid = L.SalesManGuid
	where
		([L].[CustomerGuid] = @CustGuid or @CustGuid = 0x0)
		and ([L].[RentInfoGuid] = @RentInfoGuid or @RentInfoGuid = 0x0)
		and ([L].[SalesManGuid] = @SalesManGuid or @SalesManGuid = 0x0)
		and ([L].[ContractFinish] = @EndState or @EndState = 2)
		and (
				([l].[Mark] = 1 and @Mark = 1)
				or ([l].[Mark] = 0 and @NotMark = 1)
			)
		and (L.PayType = @PayType or @PayType  = 4)
		and (isNull([L].[Judicial],0) = @Judicial or @Judicial = 2)
		and (L.Purpose = @Purpose or @Purpose = '')
		and (L.Trademark = @Trademark or @Trademark = '')
		and (L.AcquittancePrintedByGuid = @AcquittancePrintedByUserGuid or @AcquittancePrintedByUserGuid = 0x0)
		
		and (@p_RentFlat = 1 or @p_RentShop = 1 or @p_SaleFlat = 1 or @p_SaleShop = 1)
		and (isNull(L.isAutoRenewal,0) = @AutoRenewal or @AutoRenewal = 2)
		and (L.whereabouts = @whereabouts or @whereabouts = '')
		and (
				(
					(
					([ContractFinishDate] < [ToDate] and @FinishDate = 0) or
					([ContractFinishDate] > [ToDate] and @FinishDate = 1) or
					([ContractFinishDate] = [ToDate] and @FinishDate = 2) 
					)
				and [ContractFinish] = 1
				)
				or @FinishDate = 3
			)
	
	--Select * from #LeaseApartment_CL
	
	Select * into #LeaseApartment_Rent from #LeaseApartment_CL L
	where
			(
				((([L].[ToDate] <= @Now_Date) or ([L].[ContractFinish] = 1)) and @ContractState = 0)
			  	or ([L].[ToDate] > @Now_Date and @ContractState = 1)
				or @ContractState = 2
			)		
			and (
				(
					([L].[FromDate] >= @Date1 and @Datewith  = 0)
					and ([L].[FromDate] <= @Date2 and @Datewith  = 0 or @Date2 = '12/30/1899')
				)
				or
				(
					([L].[ToDate] >= @Date1 and @Datewith  = 1)
					and ([L].[ToDate] <= @Date2 and @Datewith  = 1 or @Date2 = '12/30/1899')
				)

				or
				(
					([L].[ContractFinishDate] >= @Date1 and @Datewith  = 2)
					and ([L].[ContractFinishDate] <= @Date2 and @Datewith  = 2 or @Date2 = '12/30/1899')
					and ([L].[ContractFinish] = 1)
				)

				or
				(
					([L].[EditDate] >= @Date1 and @Datewith  = 3)
					and ([L].[EditDate] <= @Date2 and @Datewith  = 3 or @Date2 = '12/30/1899')
				)
				or
				(
					([L].[AcquittancePrintdate] >= @Date1 and @Datewith  = 4)
					and ([L].[AcquittancePrintdate] <= @Date2 and @Datewith  = 4 or @Date2 = '12/30/1899')
				)

				or
				(
					([L].LeaveDate >= @Date1 and @Datewith  = 5)
					and ([L].LeaveDate <= @Date2 and @Datewith  = 5 or @Date2 = '12/30/1899')
				)

				or
				(
					([L].DeliverDate >= @Date1 and @Datewith  = 6)
					and ([L].DeliverDate <= @Date2 and @Datewith  = 6 or @Date2 = '12/30/1899')
				)

				or @CKDate = 0
			) 
		and (L.AcquittancePrinted = @AcquittancePrinted or @AcquittancePrinted = 2)			

	--Select * from #LeaseApartment_Rent return	
	-- 	
	Select * into #RentInfo_CL from [RentInfo] where Guid = @RentInfoGuid or @RentInfoGuid = 0x0
	
	--Customer 
	Select
		*
	into #Customer
	From
		vwCustomer
	where
		([Guid] = @CustGuid or @CustGuid = 0x0)
		and ([Nationality] = @Nationality or @Nationality = '')
		
    
   --Select * from #LeaseApartment_CL where [ContractJudicial] = 1
    
	-- 	
	if @p_RentFlat = 1
	Insert into @Tbl 
	Select 
		[L].[ContractNo]
		,[A].[No] as [FlatNo]
		,[B].[Name] as [BuildingName]
		,[L].[Rent]
		,[L].[DiscountValue]
		,[L].[Rent] - [L].[DiscountValue]
		,[A].[FlatKind] as [FlatKind]
		,[A].[ApartmentType] as [FlatType]
		,[A].[Area] as [FlatArea]
		,Case when ([L].[ToDate] <= @Now_Date) or ([L].[ContractFinish] = 1) then dbo.sc(' ')  
			  when [L].[ToDate] > @Now_Date then dbo.sc('  ') end as [ContractState]
		,[B].[Emirate] as [Emirate]
		,[B].[Suburb] as [Suburb]
		,[B].[Area] as [Area]
		,[B].[Street] as [Street]
		,[A].[FloorNo]
		,[Cu].[Name] as [CustName]
		,[Cu].[Mobile] as [CustPhone]
		,[Cu].Nationality
		,Cu.EMail as CustEMail
		,[L].[EditDate] as [ContractDateEdit]
		,[L].[DeliverDate] as [ContractDeliverDate]
		,[L].[FromDate] as [ContractDateBegin]
		,[L].[ToDate] as [ContractDateEnd]
		,[L].[ContractName]
		,[L].[ContractFinish]
		,[L].[Guid] as [ContractGuid]
		,[L].[NewState] 

		,[I].[Name]	
		,L.[SalesMan]
		,[ContractFinishDate]
		,[ResultingAmount]
		,[ResultingAmount2]
		,[Fine]
		,[ResultingAmount2] + [Fine] + [OtherFee]
		,[InsuranceValueOld] + [InsuranceValue]
		,[ResultingAmount] + [InsuranceValueOld] + [InsuranceValue] - [Fine] as [RentCleanValue]
		,[Note2] 
		,L.[Purpose]
		,L.Trademark
		,l.[CountOldContract]
		,(Select [ContractCount] From #CurrentContract where L.CustomerGuid = CustomerGuid and [L].ApartmentGuid = ApartmentGuid)as [CurrentContract]
		,l.AcquittancePrinted
		,L.AcquittancePrintDate
		,L.[AcquittancePrintedBy]
		,[L].[CostGuid]
		,L.[CustAccountGuid]
		,L.[ContractJudicial]
		,[L].[Mark]
		,[L].[isAutoRenewal]
		,L.[PrvContractFinishDate]
		,L.[PrvContractEndDate]

		,0 as [Kind]
		,0 as [Sort]
	from 
		#Building_CL [B]
		Inner join [vbApartment] [A] On [A].[BuildingGuid] = [B].[Guid]
		Inner join #LeaseApartment_Rent [L] On [A].[Guid] = [L].[ApartmentGuid] and [LeaseKind]  = 0
		inner join [Resource] [R] on [R].[Guid] = [B].[Guid]  and [R].[Kind] = 101 and [R].[spid] = @@Spid 
		--inner join [vwContractType] [T] on [T].[Guid] = [L].[TypeGuid]  
		--inner join [Resource] [R2] on [R2].[Guid] = [T].[Guid]  and [R2].[Kind] = 100 and [R2].[spid] = @@Spid 
		Inner join [#Customer] [Cu] on [Cu].[Guid] = [L].[CustomerGuid] 
		left join #RentInfo_CL [I] on [I].[Guid] = [L].[RentInfoGuid]
	where
		([A].[FlatKind] = @FlatKind or @FlatKind = '')
		and ([A].[ApartmentType] = @ApartmentType or @ApartmentType = '')
		and (A.Ban = @banRealty or @banRealty = 2)
		
	-- 	
	if @p_RentShop = 1
	Insert into @Tbl 
	Select 
		[L].[ContractNo]
		,[A].[No] as [FlatNo]
		,[B].[Name] as [BuildingName]
		,[L].[Rent]
		,[L].[DiscountValue]
		,[L].[Rent] - [L].[DiscountValue]
		,[ShopKind] as [FlatKind]
		,A.[Description] as [FlatType]
		,[A].[Area] as [FlatArea]
		,Case when ([L].[ToDate] <= GetDate()) or ([L].[ContractFinish] = 1) then dbo.sc(' ')  
			  when [L].[ToDate] > GetDate() then dbo.sc('  ') end as [ContractState]
		,[B].[Emirate] as [Emirate]
		,[B].[Suburb] as [Suburb]
		,[B].[Area] as [Area]
		,[B].[Street] as [Street]
		,'' as [FloorNo]
		,[Cu].[Name] as [CustName]
		,[Cu].[Mobile] as [CustPhone]
		,[Cu].Nationality
		,Cu.EMail as CustEMail
		,[L].[EditDate] as [ContractDateEdit]
		,[L].[DeliverDate] as [ContractDeliverDate]
		,[L].[FromDate] as [ContractDateBegin]
		,[L].[ToDate]as [ContractDateEnd]
		,[L].[ContractName]
		,[L].[ContractFinish]
		,[L].[Guid] as [ContractGuid]
		,[L].[NewState] 

		,[I].[Name]	
		,L.[SalesMan]
		,[ContractFinishDate]
		,[ResultingAmount]
		,[ResultingAmount2]
		,[Fine]
		,[ResultingAmount2] + [Fine] + [OtherFee]
		,[InsuranceValueOld] + [InsuranceValue]
		,[ResultingAmount] + [InsuranceValueOld] + [InsuranceValue] - [Fine]
		,Left([L].[Note2],255)
		,L.[Purpose]
		,L.Trademark
		,L.[CountOldContract]
		,(Select [ContractCount] From #CurrentContract where L.CustomerGuid = CustomerGuid and [L].ApartmentGuid = ApartmentGuid)as [CurrentContract]
		,l.[AcquittancePrinted]
		,L.AcquittancePrintDate
		,L.[AcquittancePrintedBy]
		,[L].[CostGuid]
		,L.[CustAccountGuid]
		,L.[ContractJudicial]
		,[L].[mark]
		,[L].[isAutoRenewal]
		,L.[PrvContractFinishDate]
		,l.[PrvContractEndDate]
		,1 as [Kind]
		,0 as [Sort]
	from 
		#Building_CL [B]
		Inner join [vwShopall] [A] On [A].[BuildingGuid] = [B].[Guid]
		inner join #LeaseApartment_Rent [L] On [A].[Guid] = [L].[ApartmentGuid] and [LeaseKind]  = 1
		Inner join [Resource] [R] on [R].[Guid] = [B].[Guid]  and [R].[Kind] = 101 and [R].[spid] = @@Spid 
		--inner  join [vwContractType] [T] on [T].[Guid] = [L].[TypeGuid]  
		--Inner join [Resource] [R2] on [R2].[Guid] = [T].[Guid]  and [R2].[Kind] = 100 and [R2].[spid] = @@Spid 
		inner  join [#Customer] [Cu] on [Cu].[Guid] = [L].[CustomerGuid] 
		left  join #RentInfo_CL [I] on [I].[Guid] = [L].[RentInfoGuid]
		and (A.Ban = @banRealty or @banRealty = 2)

	-- 
	if @p_SaleFlat = 1
	Insert into @Tbl 
	Select 
		[L].[ContractNo]
		,[A].[No] as [FlatNo]
		,[B].[Name] as [BuildingName]
		,[L].[Rent]
		,[L].[DiscountValue]
		,[L].[Rent] - [L].[DiscountValue]
		,[A].[FlatKind] as [FlatKind]
		,[A].[ApartmentType] as [FlatType]
		,[A].[Area] as [FlatArea]
		,Case when ([L].[ToDate] <= GetDate()) or ([L].[ContractFinish] = 1) then dbo.sc(' ')  
			  when [L].[ToDate] > GetDate() then dbo.sc('  ') end as [ContractState]
		,[B].[Emirate] as [Emirate]
		,[B].[Suburb] as [Suburb]
		,[B].[Area] as [Area]
		,[B].[Street] as [Street]
		,[A].[FloorNo]
		,[Cu].[Name] as [CustName]
		,[Cu].[Mobile] as [CustPhone]
		,[Cu].[Nationality]
		,Cu.EMail as CustEMail
		,[L].[EditDate] as [ContractDateEdit]
		,[L].[DeliverDate] as [ContractDeliverDate]
		,[L].[FromDate] as [ContractDateBegin]
		,[L].[ToDate]as [ContractDateEnd]
		,[L].[ContractName]
		,Null as [ContractFinish]
		,[L].[Guid] as [ContractGuid]
		,-1 as [NewState] 

		,[I].[Name]	
		,L.[SalesMan]
		,[ContractFinishDate]
		,[ResultingAmount]
		,[ResultingAmount2]
		,[Fine]
		,[ResultingAmount2] + [Fine] + [OtherFee]
		,[InsuranceValueOld] + [InsuranceValue]
		,[ResultingAmount] + [InsuranceValueOld] + [InsuranceValue] - [Fine]
		,[Note2] 
		,L.[Purpose]
		,L.Trademark
		,L.[CountOldContract]
		,(Select [ContractCount] From #CurrentContract where L.CustomerGuid = CustomerGuid and [L].ApartmentGuid = ApartmentGuid)as [CurrentContract]
		,l.[AcquittancePrinted]
		,L.AcquittancePrintDate
		,L.[AcquittancePrintedBy]
		,[L].[CostGuid]
		,L.[CustAccountGuid]
		,L.[ContractJudicial]
		,[L].[Mark]
		,[L].[isAutoRenewal]
		,L.[PrvContractFinishDate]
		,L.[PrvContractEndDate]
		,2 as [Kind]
		,0 as [Sort]
	from 
		#Building_CL [B]
		Inner join [vwApartmentall] [A] On [A].[BuildingGuid] = [B].[Guid]
		Inner join #LeaseApartment_CL [L] On [A].[Guid] = [L].[ApartmentGuid] and [LeaseKind]  = 2
		Inner join [Resource] [R] on [R].[Guid] = [B].[Guid]  and [R].[Kind] = 101 and [R].[spid] = @@Spid 
		--inner join [vwContractType] [T] on [T].[Guid] = [L].[TypeGuid]  
		--Inner join [Resource] [R2] on [R2].[Guid] = [T].[Guid]  and [R2].[Kind] = 100 and [R2].[spid] = @@Spid 
		Inner join [#Customer] [Cu] on [Cu].[Guid] = [L].[CustomerGuid] 
		left join #RentInfo_CL [I] on [I].[Guid] = [L].[RentInfoGuid]
	where
		([A].[FlatKind] = @FlatKind or @FlatKind = '')
		and ([A].[ApartmentType] = @ApartmentType or @ApartmentType = '')
		and (
				(
					([L].[FromDate] >= @Date1 and @Datewith  = 0)
					and ([L].[FromDate] <= @Date2 and @Datewith  = 0 or @Date2 = '12/30/1899')
					
				)
				
				or
				(
					([L].[EditDate] >= @Date1 and @Datewith  = 3)
					and ([L].[EditDate] <= @Date2 and @Datewith  = 3 or @Date2 = '12/30/1899')
				)
				or
				(
					([L].[AcquittancePrintdate] >= @Date1 and @Datewith  = 4)
					and ([L].[AcquittancePrintdate] <= @Date2 and @Datewith  = 4 or @Date2 = '12/30/1899')
				)
				
				or
				(
					([L].LeaveDate >= @Date1 and @Datewith  = 5)
					and ([L].LeaveDate <= @Date2 and @Datewith  = 5 or @Date2 = '12/30/1899')
				)

				or
				(
					([L].DeliverDate >= @Date1 and @Datewith  = 6)
					and ([L].DeliverDate <= @Date2 and @Datewith  = 6 or @Date2 = '12/30/1899')
				)

				or @CKDate = 0
			) 
		and (@EndState = 2)
		and (L.AcquittancePrinted = @AcquittancePrinted or @AcquittancePrinted = 2)
		and (A.Ban = @banRealty or @banRealty = 2)

	
	-- 
	if @p_SaleShop = 1
	Insert into @Tbl 
	Select 
		[L].[ContractNo]
		,[A].[No] as [FlatNo]
		,[B].[Name] as [BuildingName]
		,[L].[Rent]
		,[L].[DiscountValue]
		,[L].[Rent] - [L].[DiscountValue]
		,[ShopKind] as [FlatKind]
		,A.[Description] as [FlatType]
		,[A].[Area] as [FlatArea]
		,Case when ([L].[ToDate] <= GetDate()) or ([L].[ContractFinish] = 1) then dbo.sc(' ')  
			  when [L].[ToDate] > GetDate() then dbo.sc('  ') end as [ContractState]
		,[B].[Emirate] as [Emirate]
		,[B].[Suburb] as [Suburb]
		,[B].[Area] as [Area]
		,[B].[Street] as [Street]
		,'' as [FloorNo]
		,[Cu].[Name] as [CustName]
		,[Cu].[Mobile] as [CustPhone]
		,[Cu].[Nationality]
		,Cu.EMail as CustEMail
		,[L].[EditDate] as [ContractDateEdit]
		,[L].[DeliverDate] as [ContractDeliverDate]
		,[L].[FromDate] as [ContractDateBegin]
		,[L].[ToDate]as [ContractDateEnd]
		,[L].[ContractName]
		,Null as [ContractFinish]
		,[L].[Guid] as [ContractGuid]
		,-1 as [NewState] 

		,[I].[Name]	
		,L.[SalesMan]
		,[ContractFinishDate]
		,[ResultingAmount]
		,[ResultingAmount2]
		,[Fine]
		,[ResultingAmount2] + [Fine] + [OtherFee]
		,[InsuranceValueOld] + [InsuranceValue]
		,[ResultingAmount] + [InsuranceValueOld] + [InsuranceValue] - [Fine]
		,[Note2] 
		,L.[Purpose]
		,L.Trademark
		,L.[CountOldContract]
		,(Select [ContractCount] From #CurrentContract where L.CustomerGuid = CustomerGuid and [L].ApartmentGuid = ApartmentGuid)as [CurrentContract]
		,l.[AcquittancePrinted]
		,L.AcquittancePrintDate
		,l.[AcquittancePrintedBy]
		,[L].[CostGuid]
		,L.[CustAccountGuid]
		,L.[ContractJudicial]
		,[L].[Mark]
		,[L].[isAutoRenewal]
		,L.[PrvContractFinishDate]
		,L.[PrvContractEndDate]
		,3 as [Kind]
		,0 as [Sort]
	from 
		#Building_CL [B]
		Inner join [vwShopAll] [A] On [A].[BuildingGuid] = [B].[Guid]
		Inner join #LeaseApartment_CL [L] On [A].[Guid] = [L].[ApartmentGuid] and [LeaseKind]  = 3
		Inner join [Resource] [R] on [R].[Guid] = [B].[Guid]  and [R].[Kind] = 101 and [R].[spid] = @@Spid 
		--inner join [vwContractType] [T] on [T].[Guid] = [L].[TypeGuid]  
		--Inner join [Resource] [R2] on [R2].[Guid] = [T].[Guid]  and [R2].[Kind] = 100 and [R2].[spid] = @@Spid 
		Inner join [#Customer] [Cu] on [Cu].[Guid] = [L].[CustomerGuid] 
		left join #RentInfo_CL [I] on [I].[Guid] = [L].[RentInfoGuid]
	where
		(
				(
					([L].[FromDate] >= @Date1 and @Datewith  = 0)
					and ([L].[FromDate] <= @Date2 and @Datewith  = 0 or @Date2 = '12/30/1899')
				)
				or
				(
					([L].[EditDate] >= @Date1 and @Datewith  = 3)
					and ([L].[EditDate] <= @Date2 and @Datewith  = 3 or @Date2 = '12/30/1899')
				)
				
				or
				(
					([L].[AcquittancePrintdate] >= @Date1 and @Datewith  = 4)
					and ([L].[AcquittancePrintdate] <= @Date2 and @Datewith  = 4 or @Date2 = '12/30/1899')
				)
				
				or
				(
					([L].LeaveDate >= @Date1 and @Datewith  = 5)
					and ([L].LeaveDate <= @Date2 and @Datewith  = 5 or @Date2 = '12/30/1899')
				)

				or
				(
					([L].DeliverDate >= @Date1 and @Datewith  = 6)
					and ([L].DeliverDate <= @Date2 and @Datewith  = 6 or @Date2 = '12/30/1899')
				)
				or @CKDate = 0
			) 

		and (@EndState = 2)
		and (L.AcquittancePrinted = @AcquittancePrinted or @AcquittancePrinted = 2)
		and (A.Ban = @banRealty or @banRealty = 2)


	--
	if (@AcquittancePrinted = 2) and (@Purpose = '') and (@p_RentParking = 1) and ( @Trademark = '')
	Insert into @Tbl 
	Select 
		[L].[ContractNo]
		,[A].[No] as [FlatNo]
		,[B].[Name] as [BuildingName]
		,[L].[Rent]
		,0 as [DiscountValue]
		,[L].[Rent] - 0
		,[ParkingKind] as [FlatKind]
		,A.[Description] as [FlatType]
		,[A].[Area] as [FlatArea]
		,Case when ([L].[ToDate] <= GetDate()) or ([L].[ContractFinish] = 1) then dbo.sc(' ')  
			  when [L].[ToDate] > GetDate() then dbo.sc('  ') end as [ContractState]
		,[B].[Emirate] as [Emirate]
		,[B].[Suburb] as [Suburb]
		,[B].[Area] as [Area]
		,[B].[Street] as [Street]
		,[A].[FloorNo]
		,[Cu].[Name] as [CustName]
		,[Cu].[Mobile] as [CustPhone]
		,[Cu].[Nationality]
		,Cu.EMail as CustEMail
		,[L].[EditDate] as [ContractDateEdit]
		,[L].[DeliverDate] as [ContractDeliverDate]
		,[L].[FromDate] as [ContractDateBegin]
		,[L].[ToDate]as [ContractDateEnd]
		,[T].[Name]
		,[L].[ContractFinish]
		,[L].[Guid] as [ContractGuid]
		,[L].[NewState] 

		,[I].[Name]	
		,S.Name as [SalesMan]	
		,[ContractFinishDate]
		,[ResultingAmount]
		,0 as [ResultingAmount2]
		,[Fine]
		,[Fine]
		,[InsuranceValueOld] + [InsuranceValue]
		,[ResultingAmount] + [InsuranceValueOld] + [InsuranceValue] - [Fine]
		,[Note2] 
		,''
		,''
		,0 as [CountOldContract]
		,0
		,0 as [AcquittancePrinted]
		,Null as AcquittancePrintDate
		,Null as [AcquittancePrintedBy]
		,[L].[CostGuid]
		,L.[CustAccountGuid]
		,L.[Judicial]
		,[L].[Mark]
		,[L].[isAutoRenewal]
		,(Select [ContractFinishDate] from ParkingContract where Guid = L.[PrvContractGuid]) as [PrvContractFinishDate]
		,(Select [ToDate] from ParkingContract where Guid = L.[PrvContractGuid]) as [PrvContractEndDate]

		,[R2].[spid]
		,0 as [Sort]
	from 
		#Building_CL [B]
		Inner join [vwParkingAll] [A] On [A].[BuildingGuid] = [B].[Guid]
		Inner join [vwParkingContract] [L] On [A].[Guid] = [L].[ParkingGuid]
		Inner join [Resource] [R] on [R].[Guid] = [B].[Guid]  and [R].[Kind] = 101 and [R].[spid] = @@Spid 
		inner join [vwContractType] [T] on [T].[Guid] = [L].[TypeGuid]  
		Inner join [Resource] [R2] on [R2].[Guid] = [T].[Guid]  and [R2].[Kind] = 100 and [R2].[spid] = @@Spid 
		Inner join [#Customer] [Cu] on [Cu].[Guid] = [L].[CustomerGuid] 
		left join #RentInfo_CL [I] on [I].[Guid] = [L].[RentInfoGuid]
		left join Salesman S on S.Guid = L.SalesManGuid
	where
		([L].[CustomerGuid] = @CustGuid or @CustGuid = 0x0)
		and 
			(
				((([L].[ToDate] <= GetDate()) or ([L].[ContractFinish] = 1)) and @ContractState = 0)
			  	or ([L].[ToDate] > GetDate() and @ContractState = 1)
				or @ContractState = 2
			)

		and (
				(
					([L].[FromDate] >= @Date1 and @Datewith  = 0)
					and ([L].[FromDate] <= @Date2 and @Datewith  = 0 or @Date2 = '12/30/1899')
				)
				or
				(
					([L].[ToDate] >= @Date1 and @Datewith  = 1)
					and ([L].[ToDate] <= @Date2 and @Datewith  = 1 or @Date2 = '12/30/1899')
				)

				or
				(
					([L].[ContractFinishDate] >= @Date1 and @Datewith  = 2)
					and ([L].[ContractFinishDate] <= @Date2 and @Datewith  = 2 or @Date2 = '12/30/1899')
					and ([L].[ContractFinish] = 1)
				)

				or
				(
					([L].[EditDate] >= @Date1 and @Datewith  = 3)
					and ([L].[EditDate] <= @Date2 and @Datewith  = 3 or @Date2 = '12/30/1899')
				)
				and @Datewith  <> 4 and @Datewith  <> 5

				or
				(
					([L].DeliverDate >= @Date1 and @Datewith  = 6)
					and ([L].DeliverDate <= @Date2 and @Datewith  = 6 or @Date2 = '12/30/1899')
				)

				or @CKDate = 0
			)

		and ([L].[RentInfoGuid] = @RentInfoGuid or @RentInfoGuid = 0x0)
		and ([L].[SalesManGuid] = @SalesManGuid or @SalesManGuid = 0x0)

		and ([L].[ContractFinish] = @EndState or @EndState = 2)
		and (
				([l].[Mark] = 1 and @Mark = 1)
				or ([l].[Mark] = 0 and @NotMark = 1)
			)
		and (L.PayType = @PayType or @PayType  = 4)
		and ([L].[Judicial] = @Judicial or @Judicial = 2)
		and (L.isAutoRenewal = @AutoRenewal or @AutoRenewal = 2)
		and (A.Ban = @banRealty or @banRealty = 2)
		and (
				(
					(
					([ContractFinishDate] < [ToDate] and @FinishDate = 0) or
					([ContractFinishDate] > [ToDate] and @FinishDate = 1) or
					([ContractFinishDate] = [ToDate] and @FinishDate = 2) 
					)
				and [ContractFinish] = 1
				)
				or @FinishDate = 3
			)

	--
	if (@p_RentLand = 1 or @p_SaleLand = 1)
	Insert into @Tbl 
	Select 
		[L].[ContractNo]
		,[A].[Name] as [FlatNo]
		,'' as [BuildingName]
		,[L].[Rent]
		,[L].[DiscountValue]
		,[L].[Rent] - [L].[DiscountValue]
		,'' as [FlatKind]
		,'' as [FlatType]
		,[A].[Area] as [FlatArea]
		,Case when ([L].[ToDate] <= GetDate()) or ([L].[ContractFinish] = 1) then dbo.sc(' ')  
			  when [L].[ToDate] > GetDate() then dbo.sc('  ') end as [ContractState]
		,'' as [Emirate]
		,'' as [Suburb]
		,'' as [Area]
		,'' as [Street]
		,'' as [FloorNo]
		,[Cu].[Name] as [CustName]
		,[Cu].[Mobile] as [CustPhone]
		,[Cu].[Nationality] 
		,Cu.EMail as CustEMail
		,[L].[EditDate] as [ContractDateEdit]
		,[L].[DeliverDate] as [ContractDeliverDate]
		,[L].[FromDate] as [ContractDateBegin]
		,[L].[ToDate] as [ContractDateEnd]
		,[T].[Name]
		,[ContractFinish]
		,[L].[Guid] as [ContractGuid]
		,[L].[NewState]
		,[I].[Name]
		,S.Name as [SalesMan]
		,[ContractFinishDate]
		,[ResultingAmount]
		,[ResultingAmount2]
		,[Fine]
		,[ResultingAmount2] + [Fine] + [OtherFee]
		,[InsuranceValueOld] + [InsuranceValue]
		,[ResultingAmount] + [InsuranceValueOld] + [InsuranceValue] - [Fine]
		,[Note2] 
		,L.[Purpose]
		,'' as Trademark 
		,0 as [CountOldContract]
		,0
		,l.[AcquittancePrinted]
		,L.AcquittancePrintDate
		,u.LoginName as [AcquittancePrintedBy]
		,[L].[CostGuid]
		,L.[CustAccountGuid]
		,L.[Judicial]
		,[L].[Mark]
		,[L].[isAutoRenewal]
		,(Select [ContractFinishDate] from [LandContract] where Guid = L.[PrvContractGuid]) as [PrvContractFinishDate]
		,(Select [ToDate] from [LandContract] where Guid = L.[PrvContractGuid]) as [PrvContractEndDate]
		,[R2].[spid]
		,0 as [Sort]
	from 
		[vwEarthAll] [A] 
		Inner join [vwLandContract] [L] On [A].[Guid] = [L].[LandGuid]
		inner join [vwContractType] [T] on [T].[Guid] = [L].[TypeGuid]  
		Inner join [Resource] [R2] on [R2].[Guid] = [T].[Guid]  and [R2].[Kind] = 100 and [R2].[spid] = @@Spid 
		Inner join [#Customer] [Cu] on [Cu].[Guid] = [L].[CustomerGuid] 
		left join #RentInfo_CL [I] on [I].[Guid] = [L].[RentInfoGuid]
		left join [Realty_Users] U on U.[Guid] = L.AcquittancePrintedByGuid
		left join Salesman S on S.Guid = L.SalesManGuid
	where
		([L].[CustomerGuid] = @CustGuid or @CustGuid = 0x0)
		and	([L].[SalesManGuid] = @SalesManGuid or @SalesManGuid = 0x0)
		and 
			(
				((([L].[ToDate] <= GetDate()) or ([L].[ContractFinish] = 1)) and @ContractState = 0)
			  	or ([L].[ToDate] > GetDate() and @ContractState = 1)
				or @ContractState = 2
			)
		and (
				(
					([L].[FromDate] >= @Date1 and @Datewith  = 0)
					and ([L].[FromDate] <= @Date2 and @Datewith  = 0 or @Date2 = '12/30/1899')
				)
				or
				(
					([L].[ToDate] >= @Date1 and @Datewith  = 1)
					and ([L].[ToDate] <= @Date2 and @Datewith  = 1 or @Date2 = '12/30/1899')
				)

				or
				(
					([L].[ContractFinishDate] >= @Date1 and @Datewith  = 2)
					and ([L].[ContractFinishDate] <= @Date2 and @Datewith  = 2 or @Date2 = '12/30/1899')
					and ([L].[ContractFinish] = 1)
				)

				or
				(
					([L].[EditDate] >= @Date1 and @Datewith  = 3)
					and ([L].[EditDate] <= @Date2 and @Datewith  = 3 or @Date2 = '12/30/1899')
				)
				or
				(
					([L].[AcquittancePrintdate] >= @Date1 and @Datewith  = 4)
					and ([L].[AcquittancePrintdate] <= @Date2 and @Datewith  = 4 or @Date2 = '12/30/1899')
				)

				or
				(
					([L].LeaveDate >= @Date1 and @Datewith  = 5)
					and ([L].LeaveDate <= @Date2 and @Datewith  = 5 or @Date2 = '12/30/1899')
				)
				
				or
				(
					([L].DeliverDate >= @Date1 and @Datewith  = 6)
					and ([L].DeliverDate <= @Date2 and @Datewith  = 6 or @Date2 = '12/30/1899')
				)

				or @CKDate = 0
			) 

		and ([L].[ContractFinish] = @EndState or @EndState = 2)
		and (
				([l].[Mark] = 1 and @Mark = 1)
				or ([l].[Mark] = 0 and @NotMark = 1)
			)
		and (L.PayType = @PayType or @PayType  = 4)
		and (L.AcquittancePrinted = @AcquittancePrinted or @AcquittancePrinted = 2)
		and ([L].[Judicial] = @Judicial or @Judicial = 2)
		and (L.Purpose = @Purpose or @Purpose = '') 
		and (L.Trademark = @Trademark or @Trademark = '')
		and (L.AcquittancePrintedByGuid = @AcquittancePrintedByUserGuid or @AcquittancePrintedByUserGuid = 0x0)
		and (l.isAutoRenewal = @AutoRenewal or @AutoRenewal = 2)
		and (A.Ban = @banRealty or @banRealty = 2)
		and (
				(
					(
					([ContractFinishDate] < [ToDate] and @FinishDate = 0) or
					([ContractFinishDate] > [ToDate] and @FinishDate = 1) or
					([ContractFinishDate] = [ToDate] and @FinishDate = 2) 
					)
				and [ContractFinish] = 1
				)
				or @FinishDate = 3
			)
		
	--
	if (@p_RentVilla = 1 or @p_SaleVilla = 1)
	Insert into @Tbl 
	Select 
		[L].[ContractNo]
		,[A].[Name] as [FlatNo]
		,'' as [BuildingName]
		,[L].[Rent]
		,[L].[DiscountValue]
		,[L].[Rent] - [L].[DiscountValue]
		,'' as [FlatKind]
		,'' as [FlatType]
		,[A].LandArea as [FlatArea]
		,Case when ([L].[ToDate] <= GetDate()) or ([L].[ContractFinish] = 1) then dbo.sc(' ')  
			  when [L].[ToDate] > GetDate() then dbo.sc('  ') end as [ContractState]
		,'' as [Emirate]
		,'' as [Suburb]
		,'' as [Area]
		,'' as [Street]
		,'' as [FloorNo]
		,[Cu].[Name] as [CustName]
		,[Cu].[Mobile] as [CustPhone]
		,[Cu].[Nationality]
		,Cu.EMail as CustEMail
		,[L].[EditDate] as [ContractDateEdit]
		,[L].[DeliverDate] as [ContractDeliverDate]
		,[L].[FromDate] as [ContractDateBegin]
		,[L].[ToDate] as [ContractDateEnd]
		,[T].[Name]
		,[ContractFinish]
		,[L].[Guid] as [ContractGuid]
		,[L].[NewState]  

		,[I].[Name]
		,S.name 
		,[ContractFinishDate]
		,[ResultingAmount]
		,[ResultingAmount2]
		,[Fine]
		,[ResultingAmount2] + [Fine] + [OtherFee]
		,[InsuranceValueOld] + [InsuranceValue]
		,[ResultingAmount] + [InsuranceValueOld] + [InsuranceValue] - [Fine]
		,[Note2] 
		,L.[Purpose]
		,L.Trademark
		,0 as [CountOldContract]
		,0
		,l.[AcquittancePrinted]
		,L.AcquittancePrintDate
		,u.LoginName as [AcquittancePrintedBy]
		,[L].[CostGuid]
		,L.[CustAccountGuid]
		,L.[Judicial]
		,[L].[Mark]
		,[L].[isAutoRenewal]
		,(Select [ContractFinishDate] from [LandContract] where Guid = L.[PrvContractGuid]) as [PrvContractFinishDate]
		,(Select [ToDate] from [LandContract] where Guid = L.[PrvContractGuid]) as [PrvContractEndDate]
		,[R2].[spid]
		,0 as [Sort]
	from 
		[vwVillaAll] [A] 
		Inner join [vwLandContract] [L] On [A].[Guid] = [L].[LandGuid]
		inner join [vwContractType] [T] on [T].[Guid] = [L].[TypeGuid]  
		Inner join [Resource] [R2] on [R2].[Guid] = [T].[Guid]  and [R2].[Kind] = 100 and [R2].[spid] = @@Spid 
		Inner join [#Customer] [Cu] on [Cu].[Guid] = [L].[CustomerGuid] 
		left join #RentInfo_CL [I] on [I].[Guid] = [L].[RentInfoGuid]
		left join [Realty_Users] U on U.[Guid] = L.AcquittancePrintedByGuid
		left join Salesman S on S.Guid = L.SalesManGuid
	where
		([L].[CustomerGuid] = @CustGuid or @CustGuid = 0x0)
		and	([L].[SalesManGuid] = @SalesManGuid or @SalesManGuid = 0x0)
		and 
			(
				((([L].[ToDate] <= GetDate()) or ([L].[ContractFinish] = 1)) and @ContractState = 0)
			  	or ([L].[ToDate] > GetDate() and @ContractState = 1)
				or @ContractState = 2
			)
		and (
				(
					([L].[FromDate] >= @Date1 and @Datewith  = 0)
					and ([L].[FromDate] <= @Date2 and @Datewith  = 0 or @Date2 = '12/30/1899')
				)
				or
				(
					([L].[ToDate] >= @Date1 and @Datewith  = 1)
					and ([L].[ToDate] <= @Date2 and @Datewith  = 1 or @Date2 = '12/30/1899')
				)

				or
				(
					([L].[ContractFinishDate] >= @Date1 and @Datewith  = 2)
					and ([L].[ContractFinishDate] <= @Date2 and @Datewith  = 2 or @Date2 = '12/30/1899')
					and ([L].[ContractFinish] = 1)
				)

				or
				(
					([L].[EditDate] >= @Date1 and @Datewith  = 3)
					and ([L].[EditDate] <= @Date2 and @Datewith  = 3 or @Date2 = '12/30/1899')
				)
				or
				(
					([L].[AcquittancePrintdate] >= @Date1 and @Datewith  = 4)
					and ([L].[AcquittancePrintdate] <= @Date2 and @Datewith  = 4 or @Date2 = '12/30/1899')
				)
				or
				(
					([L].LeaveDate >= @Date1 and @Datewith  = 5)
					and ([L].LeaveDate <= @Date2 and @Datewith  = 5 or @Date2 = '12/30/1899')
				)

				or
				(
					([L].DeliverDate >= @Date1 and @Datewith  = 6)
					and ([L].DeliverDate <= @Date2 and @Datewith  = 6 or @Date2 = '12/30/1899')
				)

				or @CKDate = 0
			) 

		and ([L].[ContractFinish] = @EndState or @EndState = 2)
		and (
				([l].[Mark] = 1 and @Mark = 1)
				or ([l].[Mark] = 0 and @NotMark = 1)
			)
		and (L.PayType = @PayType or @PayType  = 4)
		and (L.AcquittancePrinted = @AcquittancePrinted or @AcquittancePrinted = 2)
		and ([L].[Judicial] = @Judicial or @Judicial = 2)
		and (L.Purpose = @Purpose or @Purpose = '') 
		and (L.Trademark = @Trademark or @Trademark = '')
		and (L.AcquittancePrintedByGuid = @AcquittancePrintedByUserGuid or @AcquittancePrintedByUserGuid = 0x0)
		and (l.isAutoRenewal = @AutoRenewal or @AutoRenewal = 2)
		and (A.Ban = @banRealty or @banRealty = 2)
		and (
				(
					(
					([ContractFinishDate] < [ToDate] and @FinishDate = 0) or
					([ContractFinishDate] > [ToDate] and @FinishDate = 1) or
					([ContractFinishDate] = [ToDate] and @FinishDate = 2) 
					)
				and [ContractFinish] = 1
				)
				or @FinishDate = 3
			)

	Declare @PCheck Bit 
	Set @PCheck = 1	
	Declare @PNotCheck Bit 
	Set @PNotCheck = 0

	if @LinkCheck = 0 --  
	Delete @Tbl
	From
		@Tbl T
		inner join [Checks] C on C.ContractGuid = T.ContractGuid
	
	if @LinkCheck = 1 --  
	Delete @Tbl
	From
		@Tbl T
		left join [Checks] C on C.ContractGuid = T.ContractGuid
	where
		C.Guid is Null
		

	--End 
	
	-- 
	Select
		[P].[ContractGuid],
		Sum(IsNull([P].[Value] * [P].[CurrencyVal],0)) as [Total],
		Sum(IsNull([C1].[Value] * [C1].[CurrencyVal],0)) as [Collection]
	Into #Collection_CL
	From
		[vwChecks] [P]
		left join [vwChecksCollection] [C1] on [C1].[CheckGuid] = [P].[Guid] and [C1].[Kind] = 1
		inner join @Tbl [t] on [t].[ContractGuid] = [P].[ContractGuid]
	Group By
		[P].[ContractGuid]

	-- 
	Select
		[P].[ContractGuid],
		Sum(IsNull([P].[Value] * [P].[CurrencyVal],0)) as [Cash]
	Into #Cash
	From
		[vwContractCachPayment] [P]
		inner join @Tbl [t] on [t].[ContractGuid] = [P].[ContractGuid] and P.AcGuid = t.AccountGuid
	Group By
		[P].[ContractGuid]	


	Select
		En.AcGuid,
		SUM(En.debit - en.Credit) as [Balance]
	into #CustBalance
	From
		(Select distinct AccountGuid from @Tbl ) T
		inner join DEntry En on En.AcGuid = T.AccountGuid
	Group By
		En.AcGuid

	
	Select 
		[E].*,
		
		Case when isnUll([ContractFinish],0) = 0 then dbo.sc('') else dbo.sc('') end As [ContractFinishStr],
		Case when isnUll([NewState],0) = 0 then dbo.sc('') 
			 when isnUll([NewState],0) = 1 then dbo.sc('') 
		else 
			''
		end As [NewStateStr],
		
		isNull([C].[Collection],0) as [Collection],
		isNull([C].[Total],0) - isNull([C].[Collection],0) as [CheckNotCollection],
		isNull([h].[Cash],0) as [Cash],
		IsNull([C].[Collection],0) + IsNull([h].[Cash],0) as [TotalPays],
		isNull(E.ValueAfterDiscount ,0) - IsNull([C].[Collection],0) - IsNull([h].[Cash],0) as [ContractRest],
		--isNull(E.[RentCleanValue],0)  as [ContractRest],
		CAST(0 as Float) as [CustBalance],
				
		Case when [R].[ObjGuid] is null then @PNotCheck
			 when [R].[ObjGuid] is not null  then @PCheck end as [Check],
		1 as [DoOperation]
	into #ContractList_4
	From
		@Tbl [E]
		left join #Collection_CL [C] on [E].[ContractGuid] = [C].[ContractGuid]
		left join #Cash [h] on [E].[ContractGuid] = [h].[ContractGuid]
		left join [RepCheck] [R] on [R].[ObjGuid] = [E].[ContractGuid] and [R].[IdReport] = 2000
	where
		(
			([R].[ObjGuid] is not null and @ShowIsCheck = 1)
			or
			([R].[ObjGuid] is null and @ShowIsNotCheck = 1)
		)
		and (Isnull([E].[NewState],0) = @NewState or @NewState = 2)
		
	
	update	
		#ContractList_4
	Set
		custBalance = C.Balance
	From
		#ContractList_4 E
		inner join #CustBalance C on C.AcGuid = E.AccountGuid 
	
	--
	Delete [Resource] where [SPID] = @@SPID and Kind = 50
	
	insert into [Resource]
	([Guid], [Kind])
	Select Distinct
		ContractGuid,
		50
	From
		#ContractList_4
		
	exec [PrcCrossTrailContractMonthCheck]
	
	Select
		C.*,
		p.*
	from
		#ContractList_4 C
		left join ##TblAssem_Check_Contract P on p.contractGuid = C.contractGuid
	Order By 
		[Sort],
		[BuildingName],
		[FlatNo]
		
		
	Select
		SUM(Value) as [Value],
		SUM(ValueAfterDiscount) as ValueAfterDiscount,
		SUM(ResultingAmount) as ResultingAmount,
		SUM(Fine) as Fine,
		SUM(TotalIncom) as TotalIncom,
		SUM(TotalInsuranse) as TotalInsuranse,
		SUM(RentCleanValue) as RentCleanValue
	From
		#ContractList_4
	where
		[Sort] = 0

		

GO

SET ANSI_NULLS, QUOTED_IDENTIFIER ON
GO

Create Proc [PrcIncomList]
(
	@AccountGuid [uniqueidentifier]= 0X0
	,@BranchGuid [uniqueidentifier] = 0x0
	,@CostGuid [uniqueidentifier] = 0x0
	,@CurrencyGuid [uniqueidentifier] = '11111111-C748-4B13-8B91-1E9B299DF1C1'
	,@CurrencyVal Float = 1
	,@IsPosted Bit = 1
	,@IsNotPosted Bit = 1
	,@Date1 DateTime = '1/2/2007'
	,@Date2 DateTime = '12/30/2018'
    ,@ContainOldEntry Bit = 0
	,@PriceMode int = 1
	,@SpecificPrice int = -1
)
 
as
	set nocount on 
	
	--   
	exec [dbo].[PrcMatInventory]
		@GroupGuid = 0x0,
		@MatGuid = 0x0,
		@StoreGuid = 0x0,
		@CostGuid = @CostGuid,
		@Class  = '',
		@ClassGrouping = 0,
		@Unit = 0,
		@BillPost = 2,
		@CkDate = 0,
		@PriceMode = @PriceMode,
		@SpecificPrice = @SpecificPrice,
		@CurrencyGuid = @CurrencyGuid,
		@CurrencyVal = @CurrencyVal,
		@ShowEmpltyMat = 0,
		@ShowDetailStore = 0,
		@ShowMatTypeStore = 1,
		@ShowMatTypeService = 0,
		@Date1 = '1/1/2007',
		@Date2 = '1/1/2015',		
		@RepKind = 1 --0 Normal		1 Total

	--Select * from Dentry where ParentGuid = '{19191919-8282-7373-6464-656565656566}'
	
	
	Select * Into dbo.#fnGetAccountList_BS from [dbo].[fnGetAccountList](@AccountGuid)
	Select * Into dbo.#fnGetAccountList from [dbo].[fnGetAccountList](0x0)
	
	Select O.* Into #fnGetCostList_BS 
	from 
		[dbo].[fnGetCostList](@CostGuid) C
		inner join [Cost] O on O.Guid = C.GUID
	
	Set noCount on
	--  
	Select
		[Ac2].[Code] COLLATE database_default as [Code]
		,[Ac2].[Code]+'-'+[Ac2].[Name] COLLATE database_default as [AccountName]
		,[Ac].[Level]
		,isnull([Ac].[Path],'') as [Path]
		,[Ac2].[Guid]
		,[Ac2].[ParentGuid]
		,Case when Type = 0 then [Ac2].[FinalGuid] 
			  when Type = 1 then [Ac2].[ParentGuid] 
		end as [FinalGuid]
		,[Ac2].[Type]
		,Cast('' as Varchar(256)) COLLATE database_default as [Sort]
		,Isnull([SAc].[AcNSons],0) as [AcNSons]
	into #Ac
	From
		#fnGetAccountList [Ac] 
		inner join [vwAccount] [Ac2] on [Ac2].[Guid] = [Ac].[Guid]
		left join [dbo].#fnGetAccountList_BS [AcF] on [AcF].[Guid] = [Ac2].[FinalGuid]   
		left join (Select 
						Count(Number)as [AcNSons] 
						,[ParentGuid] 
					From 
						[Account] [SAc] 
					Group By
						[ParentGuid]					
				)[SAc] on [SAc].[ParentGuid] = [Ac2].[Guid]
--	Select * from #Ac
--	return


	--  
	Select 
		[Ac].[Guid] as [AcGuid]
		,Sum([En].[D_Debit]*
			Case when [En].[D_CurrencyGuid] = @CurrencyGuid then 1 
			else [En].[D_CurrencyVal] / @CurrencyVal end
			) as [Debit]
		,Sum([En].[D_Credit]*
			Case when [En].[D_CurrencyGuid] = @CurrencyGuid then 1 
			else [En].[D_CurrencyVal] / @CurrencyVal end
			) as [Credit]
	into #Entry
	from 
		--[DEntry] [En]
		--inner Join [VwEntry] [M] on [M].[Guid] = [En].[ParentGuid]
		[vwOldYearEntry] En
		inner Join [dbo].#fnGetAccountList [Ac] on [Ac].[Guid] = [En].[D_AcGuid]
		left Join #fnGetCostList_BS [Co2] on [Co2].[Guid] = [En].[D_CostGuid]
	where 
		([En].[H_Date] between @Date1 And @Date2)
		and ([En].[H_BranchGuid] = @BranchGuid or @BranchGuid = 0x0)
		and ([Co2].[Guid] Is Not Null or @CostGuid = 0x0)
		and ([En].[D_IsVisible] = 1 or [En].[D_CurrencyGuid] = @CurrencyGuid)
		and (
				([En].[H_IsPosted] = 1 and @IsPosted = 1)
				or ([En].[H_IsPosted] = 0  and @IsNotPosted = 1)
			)
		and (En.isOldEntry = 0 or @ContainOldEntry = 1)
	Group By
		[Ac].[Guid]
		
	Create Table #IncList
	(
		[Name] varchar(255),
		[Balance] Float,
		[Band] float,
		[Code] varchar(255),
		[Sort] int,
		[Guid] uniqueidentifier,
		[Level] int
	)
	
	--
	insert into #IncList	
	([Name],[Balance], [Band],[Code],[Sort],[Guid])
	Select 
		A.Name,
		-SUM([Debit] - [Credit]) as Balance,
		Band,
		A.[Code],
		1,
		A.[Guid]
	from
		IncAccount A
		left join IncAccountListDetail i on  A.Guid = I.ParentGuid
		left join #Entry E on I.AccountGuid = E.AcGuid
	where
		Band = 0
	Group by
		A.Name,A.Code, A.Band, A.[Guid]
		
	-- 
	insert into #IncList	
	([Name],[Balance], [Band],[Code],[Sort])
	Select 
		dbo.SC(' '),
		Sum([Balance]), 
		[Band],
		'',
		2 [Sort] 
	from 
		#IncList	
	where
		Band = 0
	group by
		[Band]
	
	-- 
	insert into #IncList	
	([Name],[Balance], [Band],[Code],[Sort],[Guid])
	Select 
		A.Name,
		SUM(Debit - Credit) as Balance,
		Band,
		A.[Code],
		1,
		A.[Guid]
	from 
		IncAccount A
		left join IncAccountListDetail i on  A.Guid = I.ParentGuid
		left join #Entry E on I.AccountGuid = E.AcGuid
	where
		Band = 1
	Group by
		A.Name,A.Code, A.Band,A.[Guid]
		
	--  
	insert into #IncList	
	([Name],[Balance], [Band],[Code],[Sort])
	Select 
		dbo.SC('  '),
		-Sum([Balance]), 
		[Band],
		'',
		2 [Sort] 
	from 
		#IncList	
	where
		Band = 1
	group by
		[Band]
	
	
	-- 
	insert into #IncList	
	([Name],[Balance], [Band],[Code],[Sort])
	Select 
		dbo.SC(' '),
		Sum([Balance]), 
		1.1 as [Band],
		'',
		3 [Sort] 
	from 
		#IncList	
	where
		((Band = 1) or (Band = 0))
		and Sort = 2


	--
	insert into #IncList	
	([Name],[Balance], [Band],[Code],[Sort],[Guid])
	Select 
		A.Name,
		SUM(Debit - Credit) as Balance,
		Band,
		A.[Code],
		1,
		A.[Guid]
	from 
		IncAccount A
		left join IncAccountListDetail i on  A.Guid = I.ParentGuid
		left join #Entry E on I.AccountGuid = E.AcGuid
	where
		Band = 2
	Group by
		A.Name,A.Code, A.Band,A.[Guid]
		
	-- 
	insert into #IncList	
	([Name],[Balance], [Band],[Code],[Sort])
	Select 
		dbo.SC(' '),
		-Sum([Balance]), 
		[Band],
		'',
		2 [Sort] 
	from 
		#IncList	
	where
		Band = 2
	group by
		[Band]


	-- 
	insert into #IncList	
	([Name],[Balance], [Band],[Code],[Sort],[Guid])
	Select 
		A.Name,
		-SUM(Debit - Credit) as Balance,
		Band,
		A.[Code],
		1,
		A.[Guid]
	from 
		IncAccount A
		left join IncAccountListDetail i on  A.Guid = I.ParentGuid
		left join #Entry E on I.AccountGuid = E.AcGuid
	where
		Band = 3
	Group by
		A.Name,A.Code, A.Band,A.[Guid]
		
	--  
	insert into #IncList	
	([Name],[Balance], [Band],[Code],[Sort])
	Select 
		dbo.SC('  '),
		Sum([Balance]), 
		[Band],
		'',
		2 [Sort] 
	from 
		#IncList	
	where
		Band = 3
	group by
		[Band]


	-- 
	insert into #IncList	
	([Name],[Balance], [Band],[Code],[Sort])
	Select 
		dbo.SC('  ()'),
		Sum([Balance]), 
		3.1 as [Band],
		'',
		3 [Sort] 
	from 
		#IncList	
	where
		((Band = 0) or (Band = 1) or (Band = 2) or (Band = 3))
		and Sort = 2

	upDate #IncList	Set [Level] = G.[Level]
	From
		#IncList L
		inner join dbo.fnGetIncAccountList(0x0) G on G.GUID= L.Guid
	

	Select * from #IncList	
	order by
		Band,Sort,[Level],Code

GO

SET ANSI_NULLS, QUOTED_IDENTIFIER ON
GO

Create Trigger [TRG_Trace_Land]
on [Earth]
 for 
update
As
	SET NOCOUNT ON;
	if Not exists(Select Value from DMD_const where vName = 'ActiveLogCardUpdate' and Value = '1' ) return
	
	Declare @UserGuid uniqueidentifier, @Guid uniqueidentifier
	Set @Guid = NEWID()
	
	Select Top 1 @UserGuid = userGuid From CurrentUsers where Spid = @@SPID
			
	insert into [Trace]
	([Guid],[ParentGuid],[Date],[userGuid],[HostName])
	Select Top 1
		@Guid,
		N.Guid,
		GETDATE(),
		@UserGuid,
		Host_Name()
	From
		[inserted] n 
		
	insert into [TraceDetail]
	([ParentGuid],[Caption],[Old],[New],[Tbl])
	Select Top 1
		@Guid,
		' ' as [Caption],
		D.[SecLvl] as [old],
		N.[SecLvl] as [New],
		''
	From
		[deleted] d
		inner join [inserted] n on D.Guid = N.Guid
	where
		N.[SecLvl] <> D.[SecLvl]
		
	insert into [TraceDetail]
	([ParentGuid],[Caption],[Old],[New],[Tbl])
	Select Top 1
		@Guid,
		'' as [Caption],
		D.[No] as [old],
		N.[No] as [New],
		''
	From
		[deleted] d
		inner join [inserted] n on D.Guid = N.Guid
	where
		N.[No] <> D.[No]
		
	insert into [TraceDetail]
	([ParentGuid],[Caption],[Old],[New],[Tbl])
	Select Top 1
		@Guid,
		'' as [Caption],
		D.[Ban] as [old],
		N.[Ban] as [New],
		''
	From
		[deleted] d
		inner join [inserted] n on D.Guid = N.Guid
	where
		N.[Ban] <> D.[Ban]

	insert into [TraceDetail]
	([ParentGuid],[Caption],[Old],[New],[Tbl])
	Select Top 1
		@Guid,
		' ' as [Caption],
		D.[EarthNo] as [old],
		N.[EarthNo] as [New],
		''
	From
		[deleted] d
		inner join [inserted] n on D.Guid = N.Guid
	where
		N.[EarthNo] <> D.[EarthNo]
		
	insert into [TraceDetail]
	([ParentGuid],[Caption],[Old],[New],[Tbl])
	Select Top 1
		@Guid,
		'' as [Caption],
		D.[Name] as [old],
		N.[Name] as [New],
		''
	From
		[deleted] d
		inner join [inserted] n on D.Guid = N.Guid
	where
		N.[Name] <> D.[Name]
		
	insert into [TraceDetail]
	([ParentGuid],[Caption],[Old],[New],[Tbl])
	Select Top 1
		@Guid,
		' ' as [Caption],
		D.[ltnName] as [old],
		N.[ltnName] as [New],
		''
	From
		[deleted] d
		inner join [inserted] n on D.Guid = N.Guid
	where
		N.[ltnName] <> D.[ltnName]
		
	insert into [TraceDetail]
	([ParentGuid],[Caption],[Old],[New],[Tbl])
	Select Top 1
		@Guid,
		'' as [Caption],
		D.[CustomerGuid] as [old],
		N.[CustomerGuid] as [New],
		'customer'
	From
		[deleted] d
		inner join [inserted] n on D.Guid = N.Guid
	where
		N.[CustomerGuid] <> D.[CustomerGuid]
		
	insert into [TraceDetail]
	([ParentGuid],[Caption],[Old],[New],[Tbl])
	Select Top 1
		@Guid,
		'' as [Caption],
		dbo.fnDate(D.[Date]) as [old],
		dbo.fnDate(N.[Date]) as [New],
		''
	From
		[deleted] d
		inner join [inserted] n on D.Guid = N.Guid
	where
		N.[Date] <> D.[Date]
		
	insert into [TraceDetail]
	([ParentGuid],[Caption],[Old],[New],[Tbl])
	Select Top 1
		@Guid,
		'' as [Caption],
		D.[City] as [old],
		N.[City] as [New],
		''
	From
		[deleted] d
		inner join [inserted] n on D.Guid = N.Guid
	where
		N.[City] <> D.[City]
		
	insert into [TraceDetail]
	([ParentGuid],[Caption],[Old],[New],[Tbl])
	Select Top 1
		@Guid,
		'' as [Caption],
		D.[Region] as [old],
		N.[Region] as [New],
		''
	From
		[deleted] d
		inner join [inserted] n on D.Guid = N.Guid
	where
		N.[Region] <> D.[Region]
		
	insert into [TraceDetail]
	([ParentGuid],[Caption],[Old],[New],[Tbl])
	Select Top 1
		@Guid,
		'' as [Caption],
		D.[Space] as [old],
		N.[Space] as [New],
		''
	From
		[deleted] d
		inner join [inserted] n on D.Guid = N.Guid
	where
		N.[Space] <> D.[Space]
		
	insert into [TraceDetail]
	([ParentGuid],[Caption],[Old],[New],[Tbl])
	Select Top 1
		@Guid,
		'' as [Caption],
		D.[Area] as [old],
		N.[Area] as [New],
		''
	From
		[deleted] d
		inner join [inserted] n on D.Guid = N.Guid
	where
		N.[Area] <> D.[Area]
		
	insert into [TraceDetail]
	([ParentGuid],[Caption],[Old],[New],[Tbl])
	Select Top 1
		@Guid,
		'' as [Caption],
		D.[Unity] as [old],
		N.[Unity] as [New],
		''
	From
		[deleted] d
		inner join [inserted] n on D.Guid = N.Guid
	where
		N.[Unity] <> D.[Unity]
		
	insert into [TraceDetail]
	([ParentGuid],[Caption],[Old],[New],[Tbl])
	Select Top 1
		@Guid,
		'' as [Caption],
		D.[Price] as [old],
		N.[Price] as [New],
		''
	From
		[deleted] d
		inner join [inserted] n on D.Guid = N.Guid
	where
		N.[Price] <> D.[Price]
		
	insert into [TraceDetail]
	([ParentGuid],[Caption],[Old],[New],[Tbl])
	Select Top 1
		@Guid,
		' ' as [Caption],
		D.[licenseNo] as [old],
		N.[licenseNo] as [New],
		''
	From
		[deleted] d
		inner join [inserted] n on D.Guid = N.Guid
	where
		N.[licenseNo] <> D.[licenseNo]
		
	insert into [TraceDetail]
	([ParentGuid],[Caption],[Old],[New],[Tbl])
	Select Top 1
		@Guid,
		' ' as [Caption],
		D.[license] as [old],
		N.[license] as [New],
		''
	From
		[deleted] d
		inner join [inserted] n on D.Guid = N.Guid
	where
		N.[license] <> D.[license]
		
	insert into [TraceDetail]
	([ParentGuid],[Caption],[Old],[New],[Tbl])
	Select Top 1
		@Guid,
		' ' as [Caption],
		dbo.fnDate(D.[licenseDate]) as [old],
		dbo.fnDate(N.[licenseDate]) as [New],
		''
	From
		[deleted] d
		inner join [inserted] n on D.Guid = N.Guid
	where
		N.[licenseDate] <> D.[licenseDate]
		
	insert into [TraceDetail]
	([ParentGuid],[Caption],[Old],[New],[Tbl])
	Select Top 1
		@Guid,
		'' as [Caption],
		D.[Details] as [old],
		N.[Details] as [New],
		''
	From
		[deleted] d
		inner join [inserted] n on D.Guid = N.Guid
	where
		N.[Details] <> D.[Details]
		
	insert into [TraceDetail]
	([ParentGuid],[Caption],[Old],[New],[Tbl])
	Select Top 1
		@Guid,
		' ' as [Caption],
		D.[LandType] as [old],
		N.[LandType] as [New],
		''
	From
		[deleted] d
		inner join [inserted] n on D.Guid = N.Guid
	where
		N.[LandType] <> D.[LandType]
		
	insert into [TraceDetail]
	([ParentGuid],[Caption],[Old],[New],[Tbl])
	Select Top 1
		@Guid,
		'' as [Caption],
		D.[Side] as [old],
		N.[Side] as [New],
		''
	From
		[deleted] d
		inner join [inserted] n on D.Guid = N.Guid
	where
		N.[Side] <> D.[Side]
		
	insert into [TraceDetail]
	([ParentGuid],[Caption],[Old],[New],[Tbl])
	Select Top 1
		@Guid,
		' ' as [Caption],
		D.[StreetName] as [old],
		N.[StreetName] as [New],
		''
	From
		[deleted] d
		inner join [inserted] n on D.Guid = N.Guid
	where
		N.[StreetName] <> D.[StreetName]
		
	insert into [TraceDetail]
	([ParentGuid],[Caption],[Old],[New],[Tbl])
	Select Top 1
		@Guid,
		' ' as [Caption],
		D.[StreetCount] as [old],
		N.[StreetCount] as [New],
		''
	From
		[deleted] d
		inner join [inserted] n on D.Guid = N.Guid
	where
		N.[StreetCount] <> D.[StreetCount]
		
	insert into [TraceDetail]
	([ParentGuid],[Caption],[Old],[New],[Tbl])
	Select Top 1
		@Guid,
		' ' as [Caption],
		D.[Buildble] as [old],
		N.[Buildble] as [New],
		''
	From
		[deleted] d
		inner join [inserted] n on D.Guid = N.Guid
	where
		N.[Buildble] <> D.[Buildble]
		
	insert into [TraceDetail]
	([ParentGuid],[Caption],[Old],[New],[Tbl])
	Select Top 1
		@Guid,
		' ' as [Caption],
		D.[LandOwner] as [old],
		N.[LandOwner] as [New],
		''
	From
		[deleted] d
		inner join [inserted] n on D.Guid = N.Guid
	where
		N.[LandOwner] <> D.[LandOwner]
		
			
		
	insert into [TraceDetail]
	([ParentGuid],[Caption],[Old],[New],[Tbl])
	Select Top 1
		@Guid,
		'' as [Caption],
		D.[AccountGuid] as [old],
		N.[AccountGuid] as [New],
		'[Account]'
	From
		[deleted] d
		inner join [inserted] n on D.Guid = N.Guid
	where
		N.[AccountGuid] <> D.[AccountGuid]
		
	insert into [TraceDetail]
	([ParentGuid],[Caption],[Old],[New],[Tbl])
	Select Top 1
		@Guid,
		' ' as [Caption],
		D.[CostGuid] as [old],
		N.[CostGuid] as [New],
		'[Cost]'
	From
		[deleted] d
		inner join [inserted] n on D.Guid = N.Guid
	where
		N.[CostGuid] <> D.[CostGuid]
		
	insert into [TraceDetail]
	([ParentGuid],[Caption],[Old],[New],[Tbl])
	Select Top 1
		@Guid,
		'' as [Caption],
		D.[BankAccountGuid] as [old],
		N.[BankAccountGuid] as [New],
		'[Account]'
	From
		[deleted] d
		inner join [inserted] n on D.Guid = N.Guid
	where
		N.[BankAccountGuid] <> D.[BankAccountGuid]
		
	insert into [TraceDetail]
	([ParentGuid],[Caption],[Old],[New],[Tbl])
	Select Top 1
		@Guid,
		' ' as [Caption],
		D.[CommissionPercent] as [old],
		N.[CommissionPercent] as [New],
		''
	From
		[deleted] d
		inner join [inserted] n on D.Guid = N.Guid
	where
		N.[CommissionPercent] <> D.[CommissionPercent]
		
	insert into [TraceDetail]
	([ParentGuid],[Caption],[Old],[New],[Tbl])
	Select Top 1
		@Guid,
		' ' as [Caption],
		D.[AccountCommIncomeGuid] as [old],
		N.[AccountCommIncomeGuid] as [New],
		'Account'
	From
		[deleted] d
		inner join [inserted] n on D.Guid = N.Guid
	where
		N.[AccountCommIncomeGuid] <> D.[AccountCommIncomeGuid]
		
	insert into [TraceDetail]
	([ParentGuid],[Caption],[Old],[New],[Tbl])
	Select Top 1
		@Guid,
		'       ' as [Caption],
		dbo.fnDate(D.[UsedEndDate]) as [old],
		dbo.fnDate(N.[UsedEndDate]) as [New],
		''
	From
		[deleted] d
		inner join [inserted] n on D.Guid = N.Guid
	where
		N.[UsedEndDate] <> D.[UsedEndDate]
		
	insert into [TraceDetail]
	([ParentGuid],[Caption],[Old],[New],[Tbl])
	Select Top 1
		@Guid,
		'  ' as [Caption],
		D.[CustomerOwnerGuid] as [old],
		N.[CustomerOwnerGuid] as [New],
		'Customer'
	From
		[deleted] d
		inner join [inserted] n on D.Guid = N.Guid
	where
		N.[CustomerOwnerGuid] <> D.[CustomerOwnerGuid]
		
	insert into [TraceDetail]
	([ParentGuid],[Caption],[Old],[New],[Tbl])
	Select Top 1
		@Guid,
		'' as [Caption],
		D.[OwnerAccountGuid] as [old],
		N.[OwnerAccountGuid] as [New],
		'[Account]'
	From
		[deleted] d
		inner join [inserted] n on D.Guid = N.Guid
	where
		N.[OwnerAccountGuid] <> D.[OwnerAccountGuid]
		
	insert into [TraceDetail]
	([ParentGuid],[Caption],[Old],[New],[Tbl])
	Select Top 1
		@Guid,
		' ' as [Caption],
		D.[IdentityValue] as [old],
		N.[IdentityValue] as [New],
		''
	From
		[deleted] d
		inner join [inserted] n on D.Guid = N.Guid
	where
		N.[IdentityValue] <> D.[IdentityValue]
		
	insert into [TraceDetail]
	([ParentGuid],[Caption],[Old],[New],[Tbl])
	Select Top 1
		@Guid,
		'' as [Caption],
		D.[CurrencyIdentityGUID] as [old],
		N.[CurrencyIdentityGUID] as [New],
		'Currency'
	From
		[deleted] d
		inner join [inserted] n on D.Guid = N.Guid
	where
		N.[CurrencyIdentityGUID] <> D.[CurrencyIdentityGUID]
		
	insert into [TraceDetail]
	([ParentGuid],[Caption],[Old],[New],[Tbl])
	Select Top 1
		@Guid,
		' ' as [Caption],
		D.[CurrencyValIdentity] as [old],
		N.[CurrencyValIdentity] as [New],
		''
	From
		[deleted] d
		inner join [inserted] n on D.Guid = N.Guid
	where
		N.[CurrencyValIdentity] <> D.[CurrencyValIdentity]
		
	insert into [TraceDetail]
	([ParentGuid],[Caption],[Old],[New],[Tbl])
	Select Top 1
		@Guid,
		'  ' as [Caption],
		dbo.fnDate(D.[IdentityBeginDate]) as [old],
		dbo.fnDate(N.[IdentityBeginDate]) as [New],
		''
	From
		[deleted] d
		inner join [inserted] n on D.Guid = N.Guid
	where
		N.[IdentityBeginDate] <> D.[IdentityBeginDate]
		
	insert into [TraceDetail]
	([ParentGuid],[Caption],[Old],[New],[Tbl])
	Select Top 1
		@Guid,
		'  ' as [Caption],
		dbo.fnDate(D.[IdentityEndDate]) as [old],
		dbo.fnDate(N.[IdentityEndDate]) as [New],
		''
	From
		[deleted] d
		inner join [inserted] n on D.Guid = N.Guid
	where
		N.[IdentityEndDate] <> D.[IdentityEndDate]
		
	insert into [TraceDetail]
	([ParentGuid],[Caption],[Old],[New],[Tbl])
	Select Top 1
		@Guid,
		' ' as [Caption],
		D.[CrearteEntryInvestment] as [old],
		N.[CrearteEntryInvestment] as [New],
		''
	From
		[deleted] d
		inner join [inserted] n on D.Guid = N.Guid
	where
		N.[CrearteEntryInvestment] <> D.[CrearteEntryInvestment]
				
	insert into [TraceDetail]
	([ParentGuid],[Caption],[Old],[New],[Tbl])
	Select Top 1
		@Guid,
		' ' as [Caption],
		D.[IdentityNote] as [old],
		N.[IdentityNote] as [New],
		''
	From
		[deleted] d
		inner join [inserted] n on D.Guid = N.Guid
	where
		N.[IdentityNote] <> D.[IdentityNote]
		
	insert into [TraceDetail]
	([ParentGuid],[Caption],[Old],[New],[Tbl])
	Select Top 1
		@Guid,
		' ' as [Caption],
		D.[LtnLandType] as [old],
		N.[LtnLandType] as [New],
		''
	From
		[deleted] d
		inner join [inserted] n on D.Guid = N.Guid
	where
		N.[LtnLandType] <> D.[LtnLandType]
		
	insert into [TraceDetail]
	([ParentGuid],[Caption],[Old],[New],[Tbl])
	Select Top 1
		@Guid,
		'' as [Caption],
		D.[LtnCity] as [old],
		N.[LtnCity] as [New],
		''
	From
		[deleted] d
		inner join [inserted] n on D.Guid = N.Guid
	where
		N.[LtnCity] <> D.[LtnCity]
		
	insert into [TraceDetail]
	([ParentGuid],[Caption],[Old],[New],[Tbl])
	Select Top 1
		@Guid,
		'' as [Caption],
		D.[LtnRegion] as [old],
		N.[LtnRegion] as [New],
		''
	From
		[deleted] d
		inner join [inserted] n on D.Guid = N.Guid
	where
		N.[LtnRegion] <> D.[LtnRegion]
		
	insert into [TraceDetail]
	([ParentGuid],[Caption],[Old],[New],[Tbl])
	Select Top 1
		@Guid,
		'' as [Caption],
		D.[LtnSpace] as [old],
		N.[LtnSpace] as [New],
		''
	From
		[deleted] d
		inner join [inserted] n on D.Guid = N.Guid
	where
		N.[LtnSpace] <> D.[LtnSpace]
		
	insert into [TraceDetail]
	([ParentGuid],[Caption],[Old],[New],[Tbl])
	Select Top 1
		@Guid,
		' ' as [Caption],
		D.[Ltnlicense] as [old],
		N.[Ltnlicense] as [New],
		''
	From
		[deleted] d
		inner join [inserted] n on D.Guid = N.Guid
	where
		N.[Ltnlicense] <> D.[Ltnlicense]
		
	insert into [TraceDetail]
	([ParentGuid],[Caption],[Old],[New],[Tbl])
	Select Top 1
		@Guid,
		'' as [Caption],
		D.[Ltnside] as [old],
		N.[Ltnside] as [New],
		''
	From
		[deleted] d
		inner join [inserted] n on D.Guid = N.Guid
	where
		N.[Ltnside] <> D.[Ltnside]
		
	insert into [TraceDetail]
	([ParentGuid],[Caption],[Old],[New],[Tbl])
	Select Top 1
		@Guid,
		' ' as [Caption],
		D.[CuOwnerGuid] as [old],
		N.[CuOwnerGuid] as [New],
		'customer'
	From
		[deleted] d
		inner join [inserted] n on D.Guid = N.Guid
	where
		N.[CuOwnerGuid] <> D.[CuOwnerGuid]
		
	delete Trace From Trace t left join [TraceDetail] D on T.guid = D.ParentGuid
	where
		d.ParentGuid is Null and t.Guid = @Guid


GO

SET ANSI_NULLS, QUOTED_IDENTIFIER ON
GO

Create Procedure [PrcMaintenanceContractList]
(
	@CustGuid uniqueidentifier = 0x0
	,@Emirate Varchar(256) = ''
	,@Suburb Varchar(256) = ''
	,@Area Varchar(256) = ''
	,@Street Varchar(256) = ''
	,@ContractState int = 1
	,@PayType int = 4
	,@Datewith int = 0
	,@Date1 DateTime = '12/30/1899'
	,@Date2 DateTime = '12/30/2018'
	,@ShowIsCheck Bit = 1
	,@ShowIsNotCheck Bit = 1
	,@CKDate Bit = 0
	,@EndState int = 2
	,@NewState int = 2
	,@Mark Bit = 1
	,@NotMark Bit = 1
	,@AcquittancePrinted int = 2
	,@AcquittancePrintedByUserGuid uniqueidentifier = 0x0
	,@LinkCheck int = 2
	,@whereabouts varchar(255) = ''
	,@Trademark varchar(255) = ''
	,@FinishDate int = 3
	,@ContractValue int = 2
	,@MaintinanceItemGuid uniqueidentifier = 0x0
)
 
as
	Set noCount on

	Declare @Msg varchar(255),
			@MsgConst varchar(255)
	Set @MsgConst = dbo.SC('  ')
			
	Set @Msg = @MsgConst
	exec PrcSetProgrss @Msg, 100, 0

	Declare @Tbl Table
	(
		[ContractNo] Varchar(256)
		,[BuildingName] Varchar(256)
		,[Value] Float
		,[Discount] Float
		,[ValueAfterDiscount] Float
		,[ContractState] Varchar(256)
		,[Emirate] Varchar(256)
		,[Suburb] Varchar(256)
		,[Area] Varchar(256)
		,[Street] Varchar(256)
		,[CustName] Varchar(256)
		,[CustPhone] Varchar(256)
		,[CustNationality] Varchar(256)
		,[CustEMail] Varchar(256)
		,[ContractDateEdit] Datetime
		,[ContractDateBegin] Datetime
		,[ContractDateEnd] Datetime
		,[MaintenanceContractType] Varchar(256)
		,[ContractFinish] Bit
		,[ContractGuid] uniqueidentifier
		,[NewState] int

		,[ContractFinishDate] Datetime
		,[ResultingAmount] Float
		,[ResultingAmount2] Float
		,[Note2] Varchar(1000)
		,[Purpose] Varchar(256)
		,Trademark Varchar(256)
		
		,[CountOldContract] int
		
		,[AcquittancePrinted] Bit
		,[AcquittancePrintdate] Datetime
		,[AcquittancePrintedBy] Varchar(256)
		,[CostGuid] uniqueidentifier
		,[AccountGuid] uniqueidentifier
		,[Mark] Bit

		--,[PrvContractFinishDate] Datetime
		--,[PrvContractEndDate] Datetime

		,[Kind] Int
		,[Sort] int
	)

	Declare  @Now_Date Datetime
	Set @Now_Date = GetDate()
	

	Set @Msg = @MsgConst
	exec PrcSetProgrss @Msg, 100, 5
	
	--Building
	Select
		*
	Into #Building_CL
	From
		[vwBuilding] B
	where
		([B].[Emirate] = @Emirate or @Emirate = '')
		and ([B].[Suburb] = @Suburb or @Suburb = '')
		and ([B].[Area] = @Area or @Area = '')
		and ([B].[Street] = @Street or @Street = '')
		
	Set @Msg = @MsgConst
	exec PrcSetProgrss @Msg, 100, 7
		

	--Select * from #Building_CL
		
	
	Select
		L.*
		--,(Select [ContractFinishDate] from [MaintenanceContract] where Guid = L.[PrvContractGuid]) as [PrvContractFinishDate]
		--,(Select [ToDate] from [MaintenanceContract] where Guid = L.[PrvContractGuid]) as [PrvContractEndDate]
		,T.Name as ContractName
		,U.LoginName as [AcquittancePrintedBy]
	into #MaintenanceContract_CL
	From
		[MaintenanceContract] L
		inner join MaintenanceContractType T on T.Guid = L.TypeGuid
		inner join [Resource] [R2] on [R2].[Guid] = [L].[TypeGuid]  and [R2].[Kind] = 100 and [R2].[spid] = @@Spid 
		left join [Realty_Users] U on U.[Guid] = L.AcquittancePrintedByGuid
	where
		([L].[CustomerGuid] = @CustGuid or @CustGuid = 0x0)
		and ([L].[ContractFinish] = @EndState or @EndState = 2)
		and (
				([l].[Mark] = 1 and @Mark = 1)
				or ([l].[Mark] = 0 and @NotMark = 1)
			)
		and (L.PayType = @PayType or @PayType  = 4)
		and (L.Trademark = @Trademark or @Trademark = '')
		and (L.AcquittancePrintedByGuid = @AcquittancePrintedByUserGuid or @AcquittancePrintedByUserGuid = 0x0)
		
		and (L.whereabouts = @whereabouts or @whereabouts = '')
		and (
				(
					(
					([ContractFinishDate] < [ToDate] and @FinishDate = 0) or
					([ContractFinishDate] > [ToDate] and @FinishDate = 1) or
					([ContractFinishDate] = [ToDate] and @FinishDate = 2) 
					)
				and [ContractFinish] = 1
				)
				or @FinishDate = 3
			)
		and (
				(([L].Rent - [L].DiscountValue) <> 0 and @ContractValue = 0) or
				(([L].Rent - [L].DiscountValue) = 0 and @ContractValue = 1) or
				@ContractValue = 2
			)
	
		and	(
				((([L].[ToDate] <= @Now_Date) or ([L].[ContractFinish] = 1)) and @ContractState = 0)
			  	or ([L].[ToDate] > @Now_Date and @ContractState = 1)
				or @ContractState = 2
			)		
			and (
				(
					([L].[FromDate] >= @Date1 and @Datewith  = 0)
					and ([L].[FromDate] <= @Date2 and @Datewith  = 0 or @Date2 = '12/30/1899')
				)
				or
				(
					([L].[ToDate] >= @Date1 and @Datewith  = 1)
					and ([L].[ToDate] <= @Date2 and @Datewith  = 1 or @Date2 = '12/30/1899')
				)

				or
				(
					([L].[ContractFinishDate] >= @Date1 and @Datewith  = 2)
					and ([L].[ContractFinishDate] <= @Date2 and @Datewith  = 2 or @Date2 = '12/30/1899')
					and ([L].[ContractFinish] = 1)
				)

				or
				(
					([L].[EditDate] >= @Date1 and @Datewith  = 3)
					and ([L].[EditDate] <= @Date2 and @Datewith  = 3 or @Date2 = '12/30/1899')
				)
				or
				(
					([L].[AcquittancePrintdate] >= @Date1 and @Datewith  = 4)
					and ([L].[AcquittancePrintdate] <= @Date2 and @Datewith  = 4 or @Date2 = '12/30/1899')
				)

				or @CKDate = 0
			) 
		and (L.AcquittancePrinted = @AcquittancePrinted or @AcquittancePrinted = 2)			

	Set @Msg = @MsgConst
	exec PrcSetProgrss @Msg, 100, 12

	if @MaintinanceItemGuid <> 0x0
	begin
		Delete #MaintenanceContract_CL
		From
			#MaintenanceContract_CL M
			inner join MaintenanceContractMaintenanceItem mi on mi.ContractGuid = M.Guid
		where
			mi.MaintenanceItemGuid <> @MaintinanceItemGuid
	end
	
	--Customer 
	Select
		*
	into #Customer
	From
		vwCustomer
	where
		([Guid] = @CustGuid or @CustGuid = 0x0)
		
    
	Insert into @Tbl 
	Select distinct
		[L].[ContractNo]
		,'' as [BuildingName]
		--,[B].[Name] as [BuildingName]
		,L.Rent
		,[L].[DiscountValue] 
		,L.Rent - [L].[DiscountValue] 
		,Case when ([L].[ToDate] <= @Now_Date) or ([L].[ContractFinish] = 1) then dbo.sc(' ')  
			  when [L].[ToDate] > @Now_Date then dbo.sc('  ') end as [ContractState]
		,'' as [Emirate]
		,'' as [Suburb]
		,'' as [Area]
		,'' as [Street]
		,[Cu].[Name] as [CustName]
		,[Cu].[Mobile] as [CustPhone]
		,[Cu].Nationality
		,Cu.EMail as CustEMail
		,[L].[EditDate] as [ContractDateEdit]
		,[L].[FromDate] as [ContractDateBegin]
		,[L].[ToDate] as [ContractDateEnd]
		,[L].[ContractName]
		,[L].[ContractFinish]
		,[L].[Guid] as [ContractGuid]
		,[L].[NewState] 

		,[ContractFinishDate]
		,[ResultingAmount]
		,[ResultingAmount2]
		,[Note2] 
		,L.[Purpose]
		,L.Trademark
		,l.[CountOldContract]
		,l.AcquittancePrinted
		,L.AcquittancePrintDate
		,L.[AcquittancePrintedBy]
		,[L].[CostGuid]
		,L.[CustAccountGuid]
		,[L].[Mark]

		--,[PrvContractFinishDate]
		--,[PrvContractEndDate]

		,0 as [Kind]
		,0 as [Sort]
	from 
		#MaintenanceContract_CL [L] 
		inner join RealtyMaintenanceContract Rl on Rl.ParentGuid = L.Guid
		inner join vwAllRealty Ar on Ar.Guid = Rl.RealtyGuid
		Inner join #Building_CL [B] On [B].[Guid] = [Ar].[BuildingGuid] 
		inner join [Resource] [R] on [R].[Guid] = [B].[Guid]  and [R].[Kind] = 101 and [R].[spid] = @@Spid 
		Inner join [#Customer] [Cu] on [Cu].[Guid] = [L].[CustomerGuid] 
		
	/*
	-- 
	Insert into @Tbl 
	Select 
		[L].[ContractNo]
		,[ar].[Name] as [BuildingName]
		,Rl.Value
		,[L].[DiscountValue] * (Rl.[Percent] / 100)
		,Rl.Value - ([L].[DiscountValue] * (Rl.[Percent] / 100))
		,Case when ([L].[ToDate] <= @Now_Date) or ([L].[ContractFinish] = 1) then dbo.sc(' ')  
			  when [L].[ToDate] > @Now_Date then dbo.sc('  ') end as [ContractState]
		,[ar].[City] as [Emirate]
		,[ar].Region as [Suburb]
		,[ar].[Area] as [Area]
		,[ar].StreetName as [Street]
		,[Cu].[Name] as [CustName]
		,[Cu].[Mobile] as [CustPhone]
		,[Cu].Nationality
		,Cu.EMail as CustEMail
		,[L].[EditDate] as [ContractDateEdit]
		,[L].[FromDate] as [ContractDateBegin]
		,[L].[ToDate] as [ContractDateEnd]
		,[L].[ContractName]
		,[L].[ContractFinish]
		,[L].[Guid] as [ContractGuid]
		,[L].[NewState] 

		,[ContractFinishDate]
		,[ResultingAmount]
		,[ResultingAmount2]
		,[Note2] 
		,L.[Purpose]
		,L.Trademark
		,l.[CountOldContract]
		,l.AcquittancePrinted
		,L.AcquittancePrintDate
		,L.[AcquittancePrintedBy]
		,[L].[CostGuid]
		,L.[CustAccountGuid]
		,[L].[Mark]

		--,[PrvContractFinishDate]
		--,[PrvContractEndDate]

		,0 as [Kind]
		,0 as [Sort]
	from 
		#MaintenanceContract_CL [L] 
		inner join RealtyMaintenanceContract Rl on Rl.ParentGuid = L.Guid
		inner join vwEarth Ar on Ar.Guid = Rl.RealtyGuid
		--inner join [Resource] [R] on [R].[Guid] = [B].[Guid]  and [R].[Kind] = 101 and [R].[spid] = @@Spid 
		Inner join [#Customer] [Cu] on [Cu].[Guid] = [L].[CustomerGuid] 


	-- 
	Insert into @Tbl 
	Select 
		[L].[ContractNo]
		,[ar].[Name] as [BuildingName]
		,Rl.Value
		,[L].[DiscountValue] * (Rl.[Percent] / 100)
		,Rl.Value - ([L].[DiscountValue] * (Rl.[Percent] / 100))
		,Case when ([L].[ToDate] <= @Now_Date) or ([L].[ContractFinish] = 1) then dbo.sc(' ')  
			  when [L].[ToDate] > @Now_Date then dbo.sc('  ') end as [ContractState]
		,[ar].Emirate as [Emirate]
		,[ar].Suburb as [Suburb]
		,[ar].[Area] as [Area]
		,[ar].Street as [Street]
		,[Cu].[Name] as [CustName]
		,[Cu].[Mobile] as [CustPhone]
		,[Cu].Nationality
		,Cu.EMail as CustEMail
		,[L].[EditDate] as [ContractDateEdit]
		,[L].[FromDate] as [ContractDateBegin]
		,[L].[ToDate] as [ContractDateEnd]
		,[L].[ContractName]
		,[L].[ContractFinish]
		,[L].[Guid] as [ContractGuid]
		,[L].[NewState] 

		,[ContractFinishDate]
		,[ResultingAmount]
		,[ResultingAmount2]
		,[Note2] 
		,L.[Purpose]
		,L.Trademark
		,l.[CountOldContract]
		,l.AcquittancePrinted
		,L.AcquittancePrintDate
		,L.[AcquittancePrintedBy]
		,[L].[CostGuid]
		,L.[CustAccountGuid]
		,[L].[Mark]

		--,[PrvContractFinishDate]
		--,[PrvContractEndDate]

		,0 as [Kind]
		,0 as [Sort]
	from 
		#MaintenanceContract_CL [L] 
		inner join RealtyMaintenanceContract Rl on Rl.ParentGuid = L.Guid
		inner join vwVilla Ar on Ar.Guid = Rl.RealtyGuid
		--inner join [Resource] [R] on [R].[Guid] = [B].[Guid]  and [R].[Kind] = 101 and [R].[spid] = @@Spid 
		Inner join [#Customer] [Cu] on [Cu].[Guid] = [L].[CustomerGuid] 
		*/

	Set @Msg = @MsgConst +' '+ dbo.SC('')
	exec PrcSetProgrss @Msg, 100, 60

	Declare @PCheck Bit 
	Set @PCheck = 1	
	Declare @PNotCheck Bit 
	Set @PNotCheck = 0

	if @LinkCheck = 0 --  
	Delete @Tbl
	From
		@Tbl T
		inner join [Checks] C on C.ContractGuid = T.ContractGuid
	
	if @LinkCheck = 1 --  
	Delete @Tbl
	From
		@Tbl T
		left join [Checks] C on C.ContractGuid = T.ContractGuid
	where
		C.Guid is Null
		
	Set @Msg = @MsgConst +' '+ dbo.SC(' ')
	exec PrcSetProgrss @Msg, 100, 70

	-- 
	Create Table #Collection_CL
	(
		[ContractGuid] uniqueidentifier,
		[Total] Float,
		[Collection] Float
	)
	
	Select
		p.Guid as [CheckGuid],
		[P].[ContractGuid],
		IsNull([P].[Value] * [P].[CurrencyVal],0) as [checkValue]
	into #Collection_Contract_Checks
	From
		[vbChecks] [P]
		inner join @Tbl [t] on [t].[ContractGuid] = [P].[ContractGuid]

	Select
		[CC].[ContractGuid],
		Sum(IsNull([C1].[Value] * [C1].[CurrencyVal],0)) as [Collection]
	Into #Collection_Sum_CL
	From
		#Collection_Contract_Checks CC
		inner join [ChecksCollection] [C1] on [C1].[CheckGuid] = [CC].[CheckGuid] and [C1].[Kind] = 1
	Group By
		[CC].[ContractGuid]
		
	insert into #Collection_CL
	([ContractGuid] ,[Total],[Collection])
	Select
		[ContractGuid],
		Sum(IsNull([CC].[checkValue],0)) as [Total],
		0
	From
		#Collection_Contract_Checks CC
	Group by
		[ContractGuid]
		
	update #Collection_CL Set [Collection] = S.[Collection]
	From
		#Collection_CL C
		inner join #Collection_Sum_CL S on C.ContractGuid = S.ContractGuid

	Set @Msg = @MsgConst +' '+ dbo.SC(' ')
	exec PrcSetProgrss @Msg, 100, 75

	-- 
	Select
		[P].[ContractGuid],
		Sum(IsNull([P].[Value] * [P].[CurrencyVal],0)) as [Cash]
	Into #Cash
	From
		[vwMaintenanceContractCachPayment] [P]
		inner join @Tbl [t] on [t].[ContractGuid] = [P].[ContractGuid] and P.AcGuid = t.AccountGuid
	Group By
		[P].[ContractGuid]	

	Set @Msg = @MsgConst +' '+ dbo.SC(' ')
	exec PrcSetProgrss @Msg, 100, 80

	Select
		En.AcGuid,
		SUM(En.debit - en.Credit) as [Balance]
	into #CustBalance
	From
		(Select distinct AccountGuid from @Tbl ) T
		inner join DEntry En on En.AcGuid = T.AccountGuid
	Group By
		En.AcGuid

	
	
	Set @Msg = ''
	exec PrcSetProgrss @Msg, 100, 90

	Select 
		[E].*,
		
		Case when isnUll([ContractFinish],0) = 0 then dbo.sc('') else dbo.sc('') end As [ContractFinishStr],
		Case when isnUll([NewState],0) = 0 then dbo.sc('') 
			 when isnUll([NewState],0) = 1 then dbo.sc('') 
		else 
			''
		end As [NewStateStr],
		
		
		isNull([C].[Collection],0) as [Collection],
		isNull([C].[Total],0) - isNull([C].[Collection],0) as [CheckNotCollection],
		isNull([h].[Cash],0) as [Cash],
		IsNull([C].[Collection],0) + IsNull([h].[Cash],0) as [TotalPays],
		isNull(E.ValueAfterDiscount ,0) - IsNull([C].[Collection],0) - IsNull([h].[Cash],0) as [ContractRest],
		CAST(0 as Float) as [CustBalance],
				
		Case when [R].[ObjGuid] is null then @PNotCheck
			 when [R].[ObjGuid] is not null  then @PCheck end as [Check],
		1 as [DoOperation]
	into #MaintenanceContractList_4
	From
		@Tbl [E]
		left join #Collection_CL [C] on [E].[ContractGuid] = [C].[ContractGuid]
		left join #Cash [h] on [E].[ContractGuid] = [h].[ContractGuid]
		left join [RepCheck] [R] on [R].[ObjGuid] = [E].[ContractGuid] and [R].[IdReport] = 2000
	where
		(
			([R].[ObjGuid] is not null and @ShowIsCheck = 1)
			or
			([R].[ObjGuid] is null and @ShowIsNotCheck = 1)
		)
		and (Isnull([E].[NewState],0) = @NewState or @NewState = 2)
		
	Set @Msg = ''
	exec PrcSetProgrss @Msg, 100, 95
	
	update	
		#MaintenanceContractList_4
	set
		custBalance = C.Balance
	From
		#MaintenanceContractList_4 E
		inner join #CustBalance C on C.AcGuid = E.AccountGuid 
	
	Set @Msg = ''
	exec PrcSetProgrss @Msg, 0, 0
	
	Select
		*
	from
		#MaintenanceContractList_4
	Order By 
		[Sort],
		[BuildingName]
		
	
	Select
		SUM(Value) as [Value],
		SUM(ValueAfterDiscount) as ValueAfterDiscount,
		SUM(ResultingAmount) as ResultingAmount
	From
		#MaintenanceContractList_4
	where
		[Sort] = 0
		

GO

SET ANSI_NULLS, QUOTED_IDENTIFIER ON
GO

Create view [vwParkingContract]
 
as
	Select 
		[ContractNo],
		[t].[Name] as [TypeName],
		[A].[TypeGuid],
		[Mark],
		Case when [A].[ContractKind] = 4 then dbo.SC('  ')+ ' / ' + Cast([A].[Number] as Varchar(10)) 
			 when [A].[ContractKind] = 5 then dbo.SC('  ')+ ' / ' + Cast([A].[Number] as Varchar(10)) 
		end as [ArContractKind],
		[A].[EditDate],
		A.[DeliverDate],
		[B].[Name] as [BuildingName],
		[B].[ArName] as [BuildingArName],
		[B].[LtnName] as [BuildingLtnName],
		Case when [A].[ContractKind] = 4 then ' '
			 when [A].[ContractKind] = 5 then ' '
		end
		+' /'+ [S].[No] +'/' 
		+' '+[B].[Name] 
		as [parkingNo],
		[S].[No] as [PNo],
		[A].[ContractKind],
		[S].[No],
		Case when [A].[ContractKind] = 4 then dbo.SC('  ')+ ' / ' + Cast([A].[Number] as Varchar(10)) 
			 when [A].[ContractKind] = 5 then dbo.SC('  ')+ ' / ' + Cast([A].[Number] as Varchar(10)) 
		end as [Contract], 

		isnull([S].[Guid],0x0) as [ParkingGuid],
		[S].[FlatOwner] as [FlatOwner],
		[Cu].[Name] as [CustName],
		[Cu].[ArName] as [CustArName],
		[Cu].[LtnName] as [CustLtnName],
		[Cu].[Phonejob] as [CustomerPhonejob],
		[Cu].[Mobile] as [CustomerMobile],
		[Cu].[Nationality] as [CustomerNationality],
		[Cu].InsuranceAccountGuid,
		Cu.AccountBalance,
		[A].[BuildingGuid],
		[A].[SalesManGuid],
		[A].[Guid],
		[A].[Number],
		[A].[CustomerGuid],
		[A].[FromDate],
		dbo.fnDate([A].[FromDate]) as [FromDateHG],
		[A].[ToDate],
		dbo.fnDate([A].[ToDate]) as [ToDateHG],

		DATEDIFF(DAY, A.ToDate, A.FromDate) as ContractDays,
		Case when A.ContractFinish = 1 then 
		DATEDIFF(DAY, A.ToDate, A.ContractFinishDate) 
		end as ContractDaysDifference,

		Case when [ContractFinish] = 0 then [ToDate] else [ContractFinishDate]  end as [EndDate],
		[A].[Rent],
		
		[A].[DiscountPercent],
		[A].[DiscountValue],
		[A].[DiscountAccountGuid],
		
		[A].[Rent] - isNull([A].[DiscountValue],0) as [RentAfterDiscount],
		
		Case 
			when ([T].[ContractKind] = 4) then 
				Case 
					when 
						Case when [ContractFinish] = 0 then [ToDate] else [ContractFinishDate] end 
						<= GetDate() then -- 
											Case when [ContractFinish] = 0 then dbo.SC('     ') 
											else
											dbo.SC('    ') end
					when 
						Case when [ContractFinish] = 0 then [ToDate] else [ContractFinishDate] end 
						> GetDate() then dbo.SC(' ') 
				end
			when ([T].[ContractKind] = 5)  then dbo.SC('')
				
		end as [ContractState],		

		Case 
			when ([T].[ContractKind] = 4) then 
				Case 
					when [ContractFinish] = 0 then dbo.SC('') 
					else
					Case 
							when 
								exists(Select 
									Guid
								From 
										ParkingContract [Q] 
								where 
									[T].[ContractKind] = [T].[ContractKind]
									and [Q].[CustomerGuid] = [A].[CustomerGuid]
									and [Q].[ParkingGuid] = [A].[ParkingGuid]
									and [Q].[FromDate] >= [A].[ContractFinishDate]
									and [Q].[Guid] <> [A].[Guid]
								)  then dbo.SC(' ') 
					else
						dbo.SC(' ') 
					end
				end
			when ([T].[ContractKind] = 5) then ''
		end as [ParkingState],
		
		[A].[RentContractType],
		[A].[MonthlyValue],
		[A].[MonthlyValue] * 12.00 as [YearValue],

		[A].[CurrencyGuid],
		[A].[CurrencyVal],
		[A].[PayType],
		[A].[Note],
		[A].[Note2],
		[A].[RevenueAccountGuid],
		[A].[CustAccountGuid],
		[A].[CommissionFromCustPercent],
		[A].[CommissionFromCustValue],
		[A].[AcCommissionFromCustGuid],
		[A].[CommissionFromOwnerPercent],
		[A].[CommissionFromOwnerValue],
		[A].[AcCommissionFromOwnerGuid],
		[A].[ContractFinish],
		[A].[ContractFinishDate],
		[A].[EditContractFinishDate],
		[A].[ResultingAmount],
		[A].[Fine],
		[A].[FineAccount],
		[A].[CreateResultingEntry],
		[A].[InsuranceValue],
		[A].[InsuranceValueOld],
		[A].[ContractPrice],
		[A].[AccountContractPrice],
		[A].[CertificatValue],
		[A].[AccountCertificatValue],
		[A].[RentDuration],
		[A].[Rentype],
		[A].[TermsOfPayment],
		[A].[Seclvl],
		[A].[RentInfoGuid],
		[A].[Step1Complete],
		[A].[Step2Complete],
		[A].[Step3Complete],
		[A].[Step4Complete],
		[A].[Step5Complete],
		[A].[Certification],
		isnull([L].[ParentGuid],0x0) as [LinkFlatContract],

		[A].[CardNo],
		[A].[CarNo],
		[A].[CarType],
		[A].[CarColor],
		[A].[Emirate],
		[Cr].[Code] as [CurrencyName],
		[A].[BranchGuid],
		[A].[Period],
		[A].[CreateContractEntry],
		[A].[FineRevenueAccountGUID],
		[A].[NewState],

		[A].[License1No],
		[A].[License2No],
		[A].[License3No],
		[A].[License1Date1],
		[A].[License2Date1],
		[A].[License3Date1],
		[A].[License1Date2],
		[A].[License2Date2],
		[A].[License3Date2],

		[A].[ResultingAmount2],
		[A].[ResultingNote],
		[A].[FineNote],

		[A].[LtnRentDuration],
		[A].[LtnRentype],
		[A].[LtnTermsOfPayment],
		[S].[CostGuid] as [UnitCostGuid],
		A.[CostGuid],
		[A].[FlatContractGuid],
		A.[IsRounded],
		[A].[Judicial],
		[A].[Description],
		[A].[PrvContractGuid],

		A.AcCommissionFromOwnerNote,
		A.AcCommissionFromCustNote,
		A.IsAutoRenewal,
		A.AcIncomNextYearGuid,
		A.IsReturnInsurance,
		A.ReturnInsuranceDate,
		A.[AddPercent],
		A.[AddValue],
		T.OpNewContract,
		A.[CommissionFromSalesManrPercent],
		A.[CommissionFromSalesManValue],
		A.[AcSalesManCommissionGuid],
		A.[AcCommissionExpenseGuid],
		A.[SalesManCommNote]
	from 
		[ParkingContract] [A]
		inner join [vwContractType] [T] on [T].[Guid] = [A].[TypeGuid]
		inner join [vwBuilding] [B] On [A].[BuildingGuid] = [B].[Guid]
		inner join [Parking] [S] on [S].[Guid] = [A].[ParkingGuid]
		inner join [vwcustomer] [Cu] On [Cu].[Guid] = [A].[CustomerGuid]
		left join [LinkParkingContract] [L] on [L].[ParkingContractGuid] = [A].[Guid]
		left join [Currency] [Cr] On [Cr].[Guid] = [A].[CurrencyGuid]
		


GO

SET ANSI_NULLS, QUOTED_IDENTIFIER ON
GO

Create Procedure [dbo].[PrcAssetsInventory]
(
	@AssetsGruopGuid uniqueidentifier = 0x0,
	@AssetsGuid uniqueidentifier = 0x0,
	@AssetsAreaGuid uniqueidentifier = 0x0,
	@CurrencyGuid [uniqueidentifier] = '11111111-C748-4B13-8B91-1E9B299DF1C1',
	@CurrencyVal Float = 1,
	@TotalOnly bit = 1,
	@AssetsDepreciation bit = 1,
	@Date1 DateTime = '1/1/2007',
	@Date2 DateTime = '1/1/2016'
)  
as
	if @CurrencyVal = 0 
	Set @CurrencyVal = 1

	Select
		A.AssetsGuid,
		Sum(
			Case when A.Flag = 1 then A.value *
			Case when [A].[CurrencyGuid] = @CurrencyGuid then 1 
					else [A].[CurrencyVal] / @CurrencyVal 
			end 
			end
			)as Addition,
		Sum(
			Case when A.Flag = 2 then A.value *
			Case when [A].[CurrencyGuid] = @CurrencyGuid then 1 
					else [A].[CurrencyVal] / @CurrencyVal 
			end 
			end
			) as [Decrease],
		Sum(
			Case when A.Flag = 3 then A.value *
			Case when [A].[CurrencyGuid] = @CurrencyGuid then 1 
					else [A].[CurrencyVal] / @CurrencyVal 
			end 
			end
			) as [Maintenance]
	into #InvAssetsOperation
	From
		[AssetsOperation] A
	Group By
		A.AssetsGuid
		
	-- 
	Select
		D.AssetsGuid,
		Sum(
			D.DepreciationValue *
			Case when [A].[CurrencyGuid] = @CurrencyGuid then 1 
					else [A].[CurrencyVal] / @CurrencyVal 
			end 
			)as Depreciation
	into #InvAssetsDepreciation
	From
		[AssetsDepreciation] A
		inner join [AssetsDepreciationDetail] D on D.ParentGuid = A.Guid
	Group By
		D.AssetsGuid
		
	Select 
		S.Code,
		S.name,
		s.ltnName,
		S.BarCode,
		S.[AssetsGroup],
		S.CurrentArea,
		S.Age,
		S.OldYearDepreciation,
		S.EnterValue,
		S.ScrapValue,
		Cast(0 as Float) as [NewAssetsValue],
		Cast(0 as Float) as [Addition],
		Cast(0 as Float) as [Decrease],
		Cast(0 as Float) as [Maintenance],
		Cast(0 as Float) as [Depreciation],
		Cast(0 as Float) as [Total],
		
		S.Note,
		S.Guid as AssetsGuid,
		0 as [Sort]
	into #RPrcAssetsInventory
	From 
		[vwAssets] S
	where
		 (S.[AssetsGroupGuid] = @AssetsGruopGuid or @AssetsGruopGuid = 0x0)
		and (S.Guid = @AssetsGuid or @AssetsGuid = 0x0)
		and (S.CurrentAssetsAreaGuid = @AssetsAreaGuid or @AssetsAreaGuid = 0x0)
		
	--------- 
	Select 
		Max(beginDate) as [MaxDate],
		D.AssetsGuid
	into #NewAssetsValue1
	from 
		AssetsDepreciationDetail D
		inner join #RPrcAssetsInventory S on S.AssetsGuid = D.AssetsGuid
	Group By
		D.AssetsGuid
		
	Select 
		D.AssetsGuid,
		NewAssetsValue
	into #NewAssetsValue
	from 
		AssetsDepreciationDetail D
		inner join #NewAssetsValue1 S on S.AssetsGuid = D.AssetsGuid and MaxDate = D.BeginDate
		
	Update #RPrcAssetsInventory
	Set
		[NewAssetsValue] = O.[NewAssetsValue]
	From
		#RPrcAssetsInventory R
		inner join #NewAssetsValue O on O.AssetsGuid = R.AssetsGuid
	--------------		
	Update #RPrcAssetsInventory
	Set
		[Addition] = O.[Addition],
		[Decrease] = O.[Decrease],
		[Maintenance] = O.[Maintenance]
	From
		#RPrcAssetsInventory R
		inner join #InvAssetsOperation O on O.AssetsGuid = R.AssetsGuid
		
	Update #RPrcAssetsInventory
	Set
		[Depreciation] = O.[Depreciation]
	From
		#RPrcAssetsInventory R
		inner join #InvAssetsDepreciation O on O.AssetsGuid = R.AssetsGuid

	Update #RPrcAssetsInventory
	Set
		[Total] = ISNULL(EnterValue,0) - ISNULL(ScrapValue,0) + ISNULL([Addition],0) - ISNULL([Decrease],0) - ISNULL([Depreciation],0)
		
	insert into #RPrcAssetsInventory
	Select 
		'' as Code,
		'' as name,
		'' as ltnName,
		'' as BarCode,
		[AssetsGroup] as [AssetsGroup],
		'' as CurrentArea,
		Null as [Age],
		Sum(OldYearDepreciation),
		
		Sum(EnterValue),
		Sum(ScrapValue),
		Sum([NewAssetsValue]),
		Sum([Addition]),
		Sum([Decrease]),
		Sum([Maintenance]),		
		Sum([Depreciation]),
		Sum([Total]),
		
		'' as Note,
		0x0 as AssetsGuid,
		1 as [Sort]
	From
		#RPrcAssetsInventory
	group By
		[AssetsGroup]

	insert into #RPrcAssetsInventory
	Select 
		'' as Code,
		'' as name,
		'' as ltnName,
		'' as BarCode,
		dbo.SC('') as [AssetsGroup],
		'' as CurrentArea,
		Null as [Age] ,
		Sum(OldYearDepreciation),
		Sum(EnterValue),
		Sum(ScrapValue),
		Sum([NewAssetsValue]),
		Sum([Addition]),
		Sum([Decrease]),
		Sum([Maintenance]),		
		Sum([Depreciation]),
		Sum([Total]),
		
		'' as Note,
		0x0 as AssetsGuid,
		2 as [Sort]
	From
		#RPrcAssetsInventory
	where
		Sort = 1

	Select
		*
	From
		#RPrcAssetsInventory
	where
		(Sort <> 0 or @TotalOnly = 0)
		and ( IsNull(Depreciation,0) <> 0 or @AssetsDepreciation = 1 or Sort = 2)
	Order By
		Case when sort = 2 then 1 else 0 end ,  [AssetsGroup], Sort, Code

	

GO

SET ANSI_NULLS, QUOTED_IDENTIFIER ON
GO

Create Procedure [dbo].[PrcCalcAssetsDepreciation]
(
	@AssetsGruopGuid uniqueidentifier = 0x0,
	@AssetsGuid uniqueidentifier = 0x0,
	@CurrentAreaGuid uniqueidentifier = 0x0,
	@ToDate DateTime = '12/31/2016',
	@RoundKind int = 0
)
 
as
	Select 
		S.Code,
		S.name,

		[DepreciationKind],
		IsDepreciationMonthly,
		
		[DepreciationBeginDate] as [BeginDate],
		@ToDate as [EndDate],
		
		CAST(0 as Float) as [Period],
		[EnterValue] as [AssetsValue],
		S.ScrapValue,
		
		CAST(0 as Float) as DepreciationYear,
		
		CAST(0 as Float) as [Add],
		CAST(0 as Float) as [Decrease],
		
		CAST(0 as Float) as [AssetsCalcValue],
		
		S.[Age],
		CAST(0 as Float) as [DepreciationPercentYear],
		
		CAST(0 as Float) as [DepreciationValue],
		
		CAST(0 as Float) as [OldDepreciation],
		
		CAST(0 as Float) as [NewDepreciation],
		CAST(0 as Float) as [NewAssetsValue],

		S.CurrencyGUID,
		S.CurrencyVal,
		S.Guid as AssetsGuid
	into #AssetsDepreciation_Tmp
	From 
		[vwAssets] S 
		inner join [AssetsArea] F on F.Guid = S.[CurrentAssetsAreaGuid]
	where
		 (S.[AssetsGroupGuid] = @AssetsGruopGuid or @AssetsGruopGuid = 0x0)
		and (S.Guid = @AssetsGuid or @AssetsGuid = 0x0)
		and (S.CurrentAssetsAreaGuid = @CurrentAreaGuid or @CurrentAreaGuid = 0x0)
		and (S.DepreciationMode = 1)
	
	-- 
	Select
		O.AssetsGuid,
		MAX(O.EndDate) as [EndDate]
	Into #AssetsendDate_Tmp
	From
		#AssetsDepreciation_Tmp T
		inner join [AssetsDepreciationDetail] O on o.AssetsGuid = T.AssetsGuid
	where
		(O.EndDate <= @ToDate)
	Group By
		O.[AssetsGuid]
	
	update #AssetsDepreciation_Tmp 
	Set
		[BeginDate] = O.endDate + 1
	From
		#AssetsDepreciation_Tmp T
		inner join #AssetsendDate_Tmp O on O.AssetsGuid = T.AssetsGuid

	-- 
	
	Select
		O.AssetsGuid,
		SUM(Case when Flag = 1 then 1 
				 when Flag = 2 then -1 
			End 
			* O.Value
			) as AssetsValue
	Into #AssetsValue_Tmp
	From
		#AssetsDepreciation_Tmp T
		inner join AssetsOperation O on o.AssetsGuid = T.AssetsGuid
	where
		(o.Flag = 1 or o.Flag = 2)
		and (O.Date <= T.beginDate)
		--and (O.Date between T.beginDate and @ToDate)
	Group By
		O.[AssetsGuid]
	

	update #AssetsDepreciation_Tmp 
	Set
		[AssetsValue] = T.[AssetsValue] + O.AssetsValue
	From
		#AssetsDepreciation_Tmp T
		inner join #AssetsValue_Tmp O on O.AssetsGuid = T.AssetsGuid
	
	--   
	Select
		AssetsGuid,
		MAX(Date) as Date
	Into #LastAssetsOperation
	From
		AssetsOperation O
	where
		(o.Flag = 1 or o.Flag = 2)
		and (O.Date <= @ToDate)		
	Group By
		AssetsGuid		
	
	--Select * from #LastAssetsOperation
	--return
	
	Select
		O.[AssetsGuid],
		Min(O.[ScrapValue]) as [ScrapValue]
	Into #AssetsScrapValue_Tmp
	From
		#AssetsDepreciation_Tmp T
		inner join AssetsOperation O on o.AssetsGuid = T.AssetsGuid
		inner join #LastAssetsOperation L on L.AssetsGuid = T.AssetsGuid and L.Date = O.Date
	where
		(o.Flag = 1 or o.Flag = 2)
		and (O.Date <= @ToDate)
	Group By
		O.[AssetsGuid]
		
	--Select * from #AssetsScrapValue_Tmp
	--return

	update #AssetsDepreciation_Tmp 
	Set
		[ScrapValue] = O.[ScrapValue]
	From
		#AssetsDepreciation_Tmp T
		inner join #AssetsScrapValue_Tmp O on O.AssetsGuid = T.AssetsGuid
	

	-- 
	Select
		O.[AssetsGuid],
		Sum([Value]) as [Value]
	Into #AssetsAdd_Tmp
	From
		#AssetsDepreciation_Tmp T
		inner join AssetsOperation O on o.AssetsGuid = T.AssetsGuid
	where
		(o.Flag = 1) 
		and (O.Date between T.beginDate and @ToDate)
	Group By
		O.[AssetsGuid]
	
	update #AssetsDepreciation_Tmp 
	Set
		[Add] = O.[Value]
	From
		#AssetsDepreciation_Tmp T
		inner join #AssetsAdd_Tmp O on O.AssetsGuid = T.AssetsGuid

	-- 
	Select
		O.[AssetsGuid],
		Sum([Value]) as [Value]
	Into #AssetsDecrease_Tmp
	From
		#AssetsDepreciation_Tmp T
		inner join AssetsOperation O on o.AssetsGuid = T.AssetsGuid
	where
		(o.Flag = 2) 
		and (O.Date between T.beginDate and @ToDate)
	Group By
		O.[AssetsGuid]
	
	update #AssetsDepreciation_Tmp 
	Set
		[Decrease] = O.[Value]
	From
		#AssetsDepreciation_Tmp T
		inner join #AssetsDecrease_Tmp O on O.AssetsGuid = T.AssetsGuid

	--
	update #AssetsDepreciation_Tmp 
	Set
		[AssetsCalcValue] = [AssetsValue] - [ScrapValue] + isNull([Add],0) - isNull([Decrease],0)



	-- 	
	Select
		O.AssetsGuid,
		SUM(Case when Flag = 1 then 1 
				 when Flag = 2 then -1 
			End 
			* O.Age
			) as AssetsAge
	Into #AssetsAge_Tmp
	From
		#AssetsDepreciation_Tmp T
		inner join AssetsOperation O on o.AssetsGuid = T.AssetsGuid
	where
		(o.Flag = 1 or o.Flag = 2)
		and (O.Date <= @ToDate)
		--and (O.Date between T.beginDate and @ToDate)
	Group By
		O.[AssetsGuid]

	update #AssetsDepreciation_Tmp 
	Set
		[Age]  = T.[Age] + O.AssetsAge
	From
		#AssetsDepreciation_Tmp T
		inner join #AssetsAge_Tmp O on O.AssetsGuid = T.AssetsGuid


	--  
	update #AssetsDepreciation_Tmp 
	Set
		[DepreciationPercentYear] = ([AssetsValue] - [ScrapValue]) / Age / ([AssetsValue] - [ScrapValue]) * 100


	update #AssetsDepreciation_Tmp 
	Set
		[Period] = Case 
						when [IsDepreciationMonthly] = 0 then 
						(DATEDIFF(DAY , BeginDate , EndDate ) )+1
					else
						(DATEDIFF(Month, BeginDate , EndDate )) +1
					end

	Set Dateformat mdy
	
	Declare @TmpDate1 datetime,
			@TmpDate2 datetime
	Set @TmpDate1 = Cast(
						'1/1/'+CAST(DATEPART(Year, @ToDate) as varchar(4)) 
						AS Datetime)

	Set @TmpDate2 = Cast(
						'12/31/'+CAST(DATEPART(Year, @ToDate) as varchar(4)) 
						AS Datetime)
	
	--Select @TmpDate1, @TmpDate2, DATEDIFF(Day,@TmpDate1, @TmpDate2) 
	
	update #AssetsDepreciation_Tmp 
	Set
		DepreciationYear = Case when IsDepreciationMonthly = 0 then 
								Case when dbo.fnWorkHijridate() = 0 then DATEDIFF(Day,@TmpDate1, @TmpDate2) +1
								else 355 end
							else 12 end
	
	
	-- 	
	update #AssetsDepreciation_Tmp 
	Set
		[DepreciationValue] = dbo.FnMyRound(
											([AssetsCalcValue] * ([DepreciationPercentYear] / 100) )* 
											([Period] / DepreciationYear)
											, @RoundKind)

	--  	
	Select
		O.AssetsGuid,
		Sum(O.[DepreciationValue]) as [DepreciationValue]
	Into #AssetsDepreciationValue_Tmp
	From
		#AssetsDepreciation_Tmp T
		inner join [AssetsDepreciationDetail] O on o.AssetsGuid = T.AssetsGuid
	where
		(O.EndDate <= @ToDate)
	Group By
		O.[AssetsGuid]

	update #AssetsDepreciation_Tmp 
	Set
		[OldDepreciation] = dbo.FnMyRound(O.DepreciationValue, @RoundKind)
	From
		#AssetsDepreciation_Tmp T
		inner join #AssetsDepreciationValue_Tmp O on O.AssetsGuid = T.AssetsGuid

	--  		
	update #AssetsDepreciation_Tmp 
	Set
		[NewDepreciation] = dbo.FnMyRound(OldDepreciation + DepreciationValue
										 , @RoundKind)

	--  
	update #AssetsDepreciation_Tmp 
	Set
		[NewAssetsValue] = dbo.FnMyRound(AssetsCalcValue + ScrapValue  - [NewDepreciation]
										, @RoundKind)
										
		
	
	Select * from #AssetsDepreciation_Tmp
	

GO

SET ANSI_NULLS, QUOTED_IDENTIFIER ON
GO

Create Proc [Prc_GeneralLedger]
(
	@AccountGuid [uniqueidentifier]= 'E93E2BEF-0FFF-425F-BF90-DFCCC9E3D958'
	,@MultiAccount Bit = 0
	,@CostGuid [uniqueidentifier]= 0x0
	,@ObverseAcGuid [uniqueidentifier] = 0x0
	,@CurrencyGuid [uniqueidentifier] = '11111111-C748-4B13-8B91-1E9B299DF1C1'
	,@CurrencyVal Float = 1
	,@Date1 DateTime = '2010-1-2'
	,@Date2 DateTime = '2016-12-31'
	,@BranchGuid [uniqueidentifier] = 0x0
	,@ShowIsCheck Bit = 1
	,@ShowIsNotCheck Bit = 1
	,@LikeNote varchar(256) = ''
	,@NotLikeNote varchar(256) = ''
	,@IsPosted Bit = 1
	,@IsNotPosted Bit = 1

	,@IsMark Bit = 1
	,@IsNotMark Bit = 1

	,@CkDate Bit = 1
	,@ShowEmptyBranchAccount Bit = 0
	,@ShowMainAccount bit = 0
	,@level int = 0
	,@ShowDebit Bit = 1
    ,@ShowCredit Bit = 1
    ,@ContainOldEntry Bit = 0
    ,@BeginEntryNo varchar(256) = ''
)
 
as
	Set nocount on

	Set @AccountGuid = IsNull(@AccountGuid,0x0)
	Set @MultiAccount = IsNull(@MultiAccount ,0)
	Set @CostGuid = ISNULL(@CostGuid,0x0)
	Set @ObverseAcGuid  = ISNULL(@ObverseAcGuid ,0x0)
	
	if ISNULL(@CurrencyGuid,0x0) = 0x0
	begin
		Select
			@CurrencyGuid = CurrencyGUID,
			@CurrencyVal = CurrencyVal
		From
			Account
		where
			Guid = @AccountGuid
	end
	
	Set @CurrencyVal = IsNull(@CurrencyVal ,1)
	
	if @Date1 is Null
	begin
		Set @Date1 = dbo.fnEncodeDate(DatePart(Year, GetDate()), 1, 1)
	end

	if @Date2 is Null
	begin
		Set @Date1 = dbo.fnEncodeDate(DatePart(Year, GetDate()), 12, 31)
	end

	Set @BranchGuid  = ISNULL(@BranchGuid,0x0)
	
	Set @ShowIsCheck = ISNULL(@ShowIsCheck, 1)
	
	Set @ShowIsNotCheck = ISNULL(@ShowIsNotCheck, 1)
	Set @LikeNote = ISNULL(@LikeNote, '')
	Set @NotLikeNote = ISNULL(@NotLikeNote, '')
	Set @IsPosted = ISNULL(@IsPosted,1)
	Set @IsNotPosted = ISNULL(@IsNotPosted,1)
	Set @IsMark  = ISNULL(@IsMark ,1)
	Set @IsNotMark  = ISNULL(@IsNotMark,1)
	Set @CkDate = ISNULL(@CkDate,1)
	Set @ShowEmptyBranchAccount  = ISNULL(@ShowEmptyBranchAccount,0)
	Set @ShowMainAccount = ISNULL(@ShowMainAccount,0)
	Set @level = ISNULL(@level,0)
	Set @ShowDebit = ISNULL(@ShowDebit,1)
    Set @ShowCredit = ISNULL(@ShowCredit,1)
    Set @ContainOldEntry = ISNULL(@ContainOldEntry,0)
    Set @BeginEntryNo = ISNULL(@BeginEntryNo,'')

	Declare @AccountCardNote varchar(255)
	
	Select @AccountCardNote = Note From Account where Guid = @AccountGuid
	
	Declare @Msg varchar(255)
	Set @Msg = dbo.SC(' ')
	exec PrcSetProgrss @Msg, 100, 0

	Select * Into #fnGetAccountList_GL from [dbo].[fnGetAccountList](@AccountGuid)
	
	Set @Msg = dbo.SC(' ')
	exec PrcSetProgrss @Msg, 100, 5

	Select O.* 
	Into #fnGetCostList_GL 
	from 
		[dbo].[fnGetCostList](@CostGuid) C
		inner join [Cost] O on O.Guid = C.GUID
		
	
	
	Select Top 1
		@level = @level + IsNull([Level],0)
	From
		#fnGetAccountList_GL

	if @CurrencyVal = 0 
	Set @CurrencyVal = 1

	CREATE TABLE #Res
	(
		[Date] DATETIME
		,[AcCode] [varchar] (256) COLLATE Arabic_CI_AI
		,[AcName] [varchar] (256) COLLATE Arabic_CI_AI
		,[AcPath] [varchar] (256) COLLATE Arabic_CI_AI
		,[Note] [varchar] (256) COLLATE Arabic_CI_AI
		,[Debit] FLOAT
		,[Credit] FLOAT
		,[Cost] [varchar] (256) COLLATE Arabic_CI_AI
		,[CostCode] [varchar] (256) COLLATE Arabic_CI_AI
		,[Posted] bit
		,[Mark] bit
		,[Kind] INT
		,[Name] [varchar] (256) COLLATE Arabic_CI_AI
		,[ObverseAc] [varchar] (256) COLLATE Arabic_CI_AI
		,[EntryNo] int
		,[ParentKind] int
		,[OrgNumber] varchar(256)
		,[OrgName] varchar(256)
		,[Sort] INT
		,[SortNum] INT
		,[Guid] [uniqueidentifier]
		,[ItemGuid] [uniqueidentifier]
		,[AcGuid] [uniqueidentifier]
		,[ObverseAcGuid]  [uniqueidentifier]
		,[CostGuid]  [uniqueidentifier]
		,[AcNSons] int
		,[level] int
		,[Id] int identity(1,1)
	)


	Set @Msg = dbo.SC(' ')
	exec PrcSetProgrss @Msg, 100, 10
	INSERT INTO #Res
	(
		[Date]
		,[AcCode]
		,[AcName]
		,[AcPath]
		,[Note]
		,[Debit]
		,[Credit]
		,[Cost]
		,[CostCode]
		,[Kind]
		,[Name]
		,[ObverseAc]
		,[EntryNo]
		,[Sort]
		,[SortNum]
		,[Guid]
		,[ItemGuid]
		,[AcGuid]
		,[ObverseAcGuid]
		,[CostGuid]
		,[level]
	)
	Select 
		Null as [Date]
		,'' as [AcountName]
		,''
		,'0'
		,dbo.sc(' ') as [Note]
		,Isnull(Sum(case when [En].[D_Debit] <> 0 then [En].[D_Debit] * 
			Case when [En].[D_CurrencyGuid] = @CurrencyGuid then 1 
			else [En].[D_CurrencyVal] / @CurrencyVal end
		end),0) as [Debit]
		,Isnull(Sum(case when [En].[D_Credit] <> 0 then [En].[D_Credit] * 
			Case when [En].[D_CurrencyGuid] = @CurrencyGuid then 1 
			else [En].[D_CurrencyVal] / @CurrencyVal end
		end),0) as [Credit]
		,'' as [Cost]
		,'' as [CostCode]
		,0 as [Kind]
		,''
		,'' as [ObverseAc]
		,Null as [EntryNo]
		,0
		,0
		,0x0
		,0x0
		,0x0
		,0x0
		,0x0
		,0
	from 
		[vwOldYearEntry] En
		--[DEntry] [En]
		--inner Join [vwEntry] [M] on [En].[H_Guid] = [En].[ParentGuid]
		inner Join #fnGetAccountList_GL [Ac] on [Ac].[Guid] = [En].[D_AcGuid]
		inner join [vwAccount] [Ac2] on [Ac2].[Guid] = [En].[D_AcGuid]
		left Join #fnGetCostList_GL [Co2] on [Co2].[Guid] = [En].[D_CostGuid]
	where 
		([En].[H_Date] < @Date1 and @CkDate = 1)
		and ([en].[D_ObverseAcGuid] = @ObverseAcGuid or @ObverseAcGuid = 0x0)
		and ([Co2].[Guid] Is Not Null or @CostGuid = 0x0)
		and ([En].[H_BranchGuid] = @BranchGuid or @BranchGuid = 0x0)
		and ([En].[D_IsVisible] = 1 or [En].[D_CurrencyGuid] = @CurrencyGuid)
		and (isNull([En].[D_Note],'') Not Like '%'+@NotLikeNote+'%' or @NotLikeNote = '')
		and (isNull([En].[D_Note],'') Like '%'+@LikeNote+'%' )
		and (En.isOldEntry = 0 or @ContainOldEntry = 1)
		and (
				H_Number Not in (SELECT str from dbo.FnStrToTable (@BeginEntryNo) )
				or en.dbname <> DB_NAME()
			)
		and (
				(isNull([En].[H_IsPosted],0) = 1 and @IsPosted = 1)
				or (isNull([En].[H_IsPosted],0) = 0  and @IsNotPosted = 1)
			)
		and (
				(isNull([En].[Mark],0) = 1 and @IsMark = 1)
				or (isNull([En].[Mark],0) = 0  and @IsNotMark = 1)
			)
	

	--Select * from #res
	
	--      
	if Not Exists(Select Top 1 * from #Res)
	INSERT INTO #Res
	(
		[Date]
		,[AcCode]
		,[AcName]
		,[AcPath]
		,[Note]
		,[Debit]
		,[Credit]
		,[Cost]
		,[CostCode]
		,[Kind]
		,[Name]
		,[ObverseAc]
		,[EntryNo]
		,[Sort]
		,[SortNum]
		,[Guid]
		,[ItemGuid]
		,[AcGuid]
		,[ObverseAcGuid]
		,[level]
	)
	Select 
		Null as [Date]
		,'' as [AcountName]
		,''
		,'0'
		,dbo.sc(' ') as [Note]
		,0 as [Debit]
		,0 as [Credit]
		,'' as [Cost]
		,'' as [CostCode]
		,0 as [Kind]
		,''
		,'' as [ObverseAc]
		,Null as [EntryNo]
		,0
		,0
		,0x0
		,0x0
		,0x0
		,0x0
		,0


	Set @Msg = dbo.SC('')
	exec PrcSetProgrss @Msg, 100, 20

	INSERT INTO #Res
	(
		[Date]
		,[AcCode]
		,[AcName]
		,[AcPath]
		,[Note]
		,[Debit]
		,[Credit]
		,[Cost]
		,[CostCode]
		,[Posted]
		,[Mark]
		,[Kind]
		,[Name]
		,[ObverseAc]
		,[EntryNo]
		,[ParentKind]
		,[Sort]
		,[SortNum]
		,[Guid]
		,[ItemGuid]
		,[AcGuid]
		,[ObverseAcGuid]
		,[AcNSons]
		,[level]
	)
	Select 
		[En].[H_Date]
		,[Ac2].[Code]
		,[Ac2].[Name] as [AcountName]
		,[Ac].[Path]
		,[En].[D_Note] as [Note]
		,Isnull(case when [En].[D_Debit] <> 0 then [En].[D_Debit] * 
			Case when [En].[D_CurrencyGuid] = @CurrencyGuid then 1 
			else [En].[D_CurrencyVal] / @CurrencyVal end
		end,0) as [Debit]
		,Isnull(case when [En].[D_Credit] <> 0 then [En].[D_Credit] * 
			Case when [En].[D_CurrencyGuid] = @CurrencyGuid then 1 
			else [En].[D_CurrencyVal] / @CurrencyVal end
		end,0) as [Credit]
		,[Co2].[Name] as [Cost]
		,[Co2].[Code] as [CostCode]
		,[En].[H_IsPosted]
		,[En].[Mark]
		,1 as [Kind]
		,[En].[H_Name]
		,'' as [ObverseAc]
		,[En].[H_Number] as [EntryNo]
		,H_ParentKind
		,1
		,[En].[H_Number]
		,[En].[H_Guid]
		,[En].[D_Guid] as [ItemGuid]
		,[Ac2].[Guid]
		,[En].[D_ObverseAcGuid]
		,0 as [AcNSons]
		,ac.[Level]
	from 
		--[DEntry] [En]
		--inner Join [vwEntry] [m] on [En].[H_Guid] = [En].[ParentGuid]
		[vwOldYearEntry] En
		inner Join #fnGetAccountList_GL [Ac] on [Ac].[Guid] = [En].[D_AcGuid]
		inner join [vwAccount] [Ac2] on [Ac2].[Guid] = [En].[D_AcGuid]
		left Join #fnGetCostList_GL [Co2] on [Co2].[Guid] = [En].[D_CostGuid]
	where 
		([En].[H_Date] Between @Date1 and @Date2 or @CkDate = 0)
		and ([en].[D_ObverseAcGuid] = @ObverseAcGuid or @ObverseAcGuid = 0x0)
		and ([Co2].[Guid] Is Not Null or @CostGuid = 0x0)
		and (isnull([En].[H_BranchGuid],0x0) = @BranchGuid or @BranchGuid = 0x0)
		and ([En].[D_IsVisible] = 1 or [En].[D_CurrencyGuid] = @CurrencyGuid)
		and (isNull([En].[D_Note],'') Not Like '%'+@NotLikeNote+'%' or @NotLikeNote = '')
		and (isNull([En].[D_Note],'') Like '%'+@LikeNote+'%' )
		and (
				([En].[H_IsPosted] = 1 and @IsPosted = 1)
				or ([En].[H_IsPosted] = 0  and @IsNotPosted = 1)
			)
		and (
				([En].[Mark] = 1 and @IsMark = 1)
				or (isNull([En].[Mark],0) = 0  and @IsNotMark = 1)
			)
		and (En.isOldEntry = 0 or @ContainOldEntry = 1)
		and (
				H_Number Not in (SELECT str from dbo.FnStrToTable (@BeginEntryNo) )
				or en.dbname <> DB_NAME()
			)
		and (
				([En].[H_IsPosted] = 1 and @IsPosted = 1)
				or ([En].[H_IsPosted] = 0  and @IsNotPosted = 1)
			)
			
	update #Res 
	Set 
		[ObverseAc] = [Ac3].[Code]+'-'+[Ac3].[Name]
	From
		#res R
		inner join [vwAccount] [Ac3] on [Ac3].[Guid] = [R].[ObverseAcGuid]

	--Select '3', GetDate()
	--Select * from #Res
	--return
	
	-- 
	-- 
	update #res 
	Set 
		OrgName = T.Name,
		OrgNumber = S.Number
	From
		#res R
		inner join Secondary_Entry S on R.Guid = S.Guid
		inner join EntryType T on T.Guid = S.TypeGuid
	where
		R.ParentKind = 8000

	-- 
	-- 
	update #res 
	Set 
		OrgName = T.Name,
		OrgNumber = E.Number
	From
		#res R
		inner join EntryDateDetail S on R.Guid = S.Guid
		inner join [EntryDate] [E] On [E].[Guid] = [S].[ParentGuid]
		inner join EntryDateType T on T.Guid = E.TypeGuid
	where
		R.ParentKind = 1


	-- 
	--
	update #res 
	Set 
		OrgName = T.typeName +' / '+ t.NO,
		OrgNumber = T.Number
	From
		#res R
		inner join LinkEntry_Checks F on F.[EntryGuid] = R.Guid
		inner join vwChecks T on T.Guid = F.[CheckGuid]
	where
		R.ParentKind in (1600, 1660, 1661, 1662, 1663, 1664)


	-- 
	-- 
	update #res 
	Set 
		OrgName = T.typeName,
		OrgNumber = T.Number
	From
		#res R
		inner join ChecksPartialCollection F on F.[Guid] = R.Guid
		inner join vwChecks T on T.Guid = F.[CheckGuid]
	where
		R.ParentKind = 1670

	-- 
	--
	update #res 
	Set 
		OrgName = T.Name,
		OrgNumber = T.ContractNumber
	From
		#res R
		inner join vwAllContractGuid T on R.Guid = T.Guid
	where
		R.ParentKind in (2000, 1000, 1001, 1002, 1003,1004, 1005, 1006, 1007, 1008, 1009, 11004, 11005, 1800)
	
	-- 
	--
	update #res 
	Set 
		OrgName = T.[BtName],
		OrgNumber = T.[BuNumber]
	From
		#res R
		inner join vwBill T on R.Guid = T.BuGuid
	where
		R.ParentKind = 22

	-- 
	--
	update #res 
	Set 
		OrgName = T.Name,
		OrgNumber = T.ContractNumber
	From
		#res R
		inner join LinkCe F on F.CeGuid = R.Guid
		inner join vwAllContractGuid T on R.Guid = T.Guid
	where
		R.ParentKind in (1100, 1101, 1102, 1103, 1104, 110004, 110005)

	-- 
	-- 
	update #res 
	Set 
		OrgName = T.Name,
		OrgNumber = T.ContractNumber
	From
		#res R
		inner join FlatContractFee F on F.Guid = R.Guid
		inner join vwAllContractGuid T on F.ParentGuid = T.Guid
	where
		R.ParentKind = 23

	-- 
	-- 
	update #res 
	Set 
		OrgName = T.Name,
		OrgNumber = T.ContractNumber
	From
		#res R
		inner join ParkingContractFee F on F.Guid = R.Guid
		inner join vwAllContractGuid T on F.ParentGuid = T.Guid
	where
		R.ParentKind = 24

	-- 
	-- 
	update #res 
	Set 
		OrgName = T.Name,
		OrgNumber = T.ContractNumber
	From
		#res R
		inner join LandContractFee F on F.Guid = R.Guid
		inner join vwAllContractGuid T on F.ParentGuid = T.Guid
	where
		R.ParentKind = 25

	-- 
	-- 
	update #res 
	Set 
		OrgName = T.TypeName,
		OrgNumber = T.Number
	From
		#res R
		inner join vwServicesContract T on R.Guid = T.Guid
	where
		R.ParentKind = 26

	-- 
	--
	update #res 
	Set 
		OrgName = T.TypeName,
		OrgNumber = T.Number
	From
		#res R
		inner join LinkCe F on F.CeGuid = R.Guid
		inner join vwServicesContract T on R.Guid = T.Guid
	where
		R.ParentKind = 1105


	-- 
	--  
	update #res 
	Set 
		OrgName = dbo.SC('  '),
		OrgNumber = F.Number
	From
		#res R
		inner join OwnerUnionFee F on F.[Guid] = R.Guid
	where
		R.ParentKind = 160

	Set @Msg = dbo.SC('')
	exec PrcSetProgrss @Msg, 100, 30

	Delete #res
	FROM
		#Res [E]
		left join [RepCheck] [R] on [R].[ObjGuid] = [E].[ItemGuid] and [R].[IdReport] = 1000
	where
		(
		Case when [R].[ObjGuid] is null and [E].[Kind] = 1 then 0 
			 when [R].[ObjGuid] is not null and [E].[Kind] = 1 then 1 end  
		= 0 and @ShowIsNotCheck = 0)
		or 
		(
		Case when [R].[ObjGuid] is null and [E].[Kind] = 1 then 0 
			 when [R].[ObjGuid] is not null and [E].[Kind] = 1 then 1 end  
		= 1 and @ShowIsCheck = 0)

	--Select * from #Res
	
	Set @Msg = dbo.SC(' ')
	exec PrcSetProgrss @Msg, 100, 35
	--Select '1', GetDate()
	INSERT INTO #Res
	(
		[Date]
		,[AcCode]
		,[AcName]
		,[AcPath]
		,[Note]
		,[Debit]
		,[Credit]
		,[Cost]
		,[CostCode]
		,[Kind]
		,[Name]
		,[ObverseAc]
		,[Sort]
		,[SortNum]
		,[Guid]
		,[ItemGuid]
	)
	SELECT
		Null
		,''
		,''
		,''
		,dbo.sc(' ')
		,SUM([Debit])
		,SUM([Credit])
		,''
		,''
		,-1
		,''
		,''
		,2
		,0
		,0x0
		,0x0
	FROM
		#Res
	where
		[Sort] = 1

	Set @Msg = dbo.SC(' ')
	exec PrcSetProgrss @Msg, 100, 40
	
	
	
	INSERT INTO #Res
	(
		[Date]
		,[AcCode]
		,[AcName]
		,[AcPath]
		,[Note]
		,[Debit]
		,[Credit]
		,[Cost]
		,[CostCode]
		,[Kind]
		,[Name]
		,[ObverseAc]
		,[Sort]
		,[SortNum]
		,[Guid]
		,[ItemGuid]
	)
	SELECT
		Null
		,''
		,''
		,''
		,dbo.sc(' ')
		,SUM([Debit])
		,SUM([Credit])
		,''
		,''
		,-1
		,''
		,''
		,3
		,0
		,0x0
		,0x0
	FROM
		#Res
	where
		[Sort] <> 2

	Set @Msg = dbo.SC(' ')
	exec PrcSetProgrss @Msg, 100, 50

	if @ShowMainAccount = 1
 	insert into #Res
 	(
 		[AcCode]
 		,[AcName]
 		,[AcPath]
 		,[Debit]
 		,[Credit]
 		,[Sort]
 		,[AcGuid]
		,[AcNSons]
 	)
	Select
		[Ac].[Code]
		,[Ac].[Name]
		,[Ac].[Path]
		,0 as [Debit]
		,0 as [Credit]
		,4
		,[Ac].[Guid]
		,[Acn].[AcNSons]
	From
		#fnGetAccountList_GL [Ac]
 		left join [#Res] [R] on [R].[AcGuid] = [Ac].[Guid]
		left join (Select 
						Count(Number)as [AcNSons] 
						,[ParentGuid] 
					From 
						[Account] [SAc] 
					Group By
						[ParentGuid]					
				)[AcN] on [AcN].[ParentGuid] = [Ac].[Guid]
 	where
 		[R].[Guid] is Null

	--Select * from #Res
		
	Set @Msg = dbo.SC('1 ')
	exec PrcSetProgrss @Msg, 100, 60

	Select 
		[R1].[AcGuid],
		[R1].[AcPath],
		Sum([R1].[Debit]) as [Debit],
		Sum([R1].[Credit]) as [Credit]
	Into #Sum_G1
	From
		#Res [R1]
	Group By
		[R1].[AcGuid],
		[R1].[AcPath]
	--Select '5', GetDate()
	
	--Select * from #Sum_G1
	--return

	Set @Msg = dbo.SC('')
	exec PrcSetProgrss @Msg, 100, 60

	CREATE INDEX IX_Sum_G1_AcPath ON #Sum_G1 (AcPath)
	CREATE INDEX IX_Res_AcPath ON #Res (AcPath)
	
	Set @Msg = dbo.SC('')
	exec PrcSetProgrss @Msg, 100, 65
	
	CREATE CLUSTERED INDEX #IXResacPath ON #Res([AcPath])	
	CREATE CLUSTERED INDEX #IXSum_GPath ON #Sum_G1([AcPath])	
	CREATE INDEX #IXSum_GAcGuid ON #Sum_G1([AcGuid])	
	CREATE INDEX #IXRescGuid ON #Res([AcGuid])	
	
	Select 
		[R2].[AcGuid],
		Sum([R1].[Debit]) as [Debit],
		Sum([R1].[Credit]) as [Credit]
	Into #Sum
	From
		#Res [R1]
		inner join #Sum_G1 [R2] on [R1].[AcPath] Like [R2].[AcPath] + '%'
	where 
		[R2].[AcPath] <> '' and [R2].[AcPath] <> '0'		
		and [R1].[AcPath] <> [R2].[AcPath]	
	Group By
		[R2].[AcGuid]

	Set @Msg = dbo.SC(' 2')
	exec PrcSetProgrss @Msg, 100, 70

	Update #Res 
		Set [Debit] = [S].[Debit],
			[Credit] = [S].[Credit]
	From
		#Res [R]
		inner join [#Sum] [S] on [S].[AcGuid]  = [R].[AcGuid]


	if @ShowEmptyBranchAccount = 0
	Delete #Res where Debit = 0 and [Credit] = 0 and IsNull([Kind],1) <> 0


	Set @Msg = dbo.SC('')
	exec PrcSetProgrss @Msg, 100, 75

--	Select id, * from #Res	Order By id
 	--
 	delete from #Res
 	where ([level] >= @Level and @Level <> 0)

	Create TABLE #Res_G1 
	(
		[Date] DATETIME
		,[AcCode] [varchar] (256) COLLATE Arabic_CI_AI
		,[AcName] [varchar] (256) COLLATE Arabic_CI_AI
		,[AcPath] [varchar] (256) COLLATE Arabic_CI_AI
		,[Note] [varchar] (256) COLLATE Arabic_CI_AI
		,[Debit] FLOAT
		,[Credit] FLOAT
		,[RunTotal] FLOAT
		,[Cost] [varchar] (256) COLLATE Arabic_CI_AI
		,[CostCode] [varchar] (256) COLLATE Arabic_CI_AI
		,[Posted] bit
		,[Mark] bit
		,[Kind] INT
		,[Name] [varchar] (256) COLLATE Arabic_CI_AI
		,[ObverseAc] [varchar] (256) COLLATE Arabic_CI_AI
		,[EntryNo] int
		,[OrgNumber] varchar(256)
		,[OrgName] varchar(256)
		,[Sort] INT
		,[SortNum] INT
		,[Guid] [uniqueidentifier]
		,[ItemGuid] [uniqueidentifier]
		,[AcGuid] [uniqueidentifier]
		,[CostGuid] [uniqueidentifier]
		,[AcNSons] int
		,[Id] int identity(1,1)
	)

	Set @Msg = dbo.SC('')
	exec PrcSetProgrss @Msg, 100, 80

	insert into #Res_G1
		([Date],[AcCode],[AcName],[AcPath], [Note], [Debit], [Credit], [Cost],[CostCode], [Posted] ,[Mark],[Kind], [Name], [ObverseAc], [EntryNo],[OrgNumber],[OrgName],[Sort], [SortNum], [Guid], [ItemGuid], [AcGuid], [AcNSons], [CostGuid])
	Select
		[Date], [AcCode], [AcName], [AcPath],[Note], [Debit], [Credit], [Cost],[CostCode],[Posted] ,[Mark],[Kind], [Name], [ObverseAc], [EntryNo],[OrgNumber],[OrgName],[Sort], [SortNum], [Guid], [ItemGuid], [AcGuid], [AcNSons], [CostGuid]
	From
		#Res
	Order By
		Case when Kind is Null then 0
			 when Kind = 1 then 1
			 when Kind = -1 then 2
		end,
		[Date],
		Case when [AcPath] = '' then 'ZZZZZZZZZZZZZZZZZ' else [AcPath]end , [Sort], [EntryNo], [SortNum]

	update #Res_G1 set Debit = 0 where Debit is Null
	update #Res_G1 set Credit = 0 where Credit is Null
	

	Create Index IDX_ResIX on #Res_G1 ([ID])
	
	Set @Msg = dbo.SC('  ')
	exec PrcSetProgrss @Msg, 100, 90

	Declare @I int, @Cnt int, @Rt Float
	Set @Cnt = (Select MAX(Id) From #Res_G1)
	
	Set @Rt = 0
	Set @i = 0
	While @I < @Cnt
	begin
		Set @Rt = (Select [RunTotal] From #Res_G1 where Id = @i - 1)

		update #Res_G1 Set [RunTotal] = [Debit] - [Credit] + isNull(@Rt,0)
		where
			Id = @i
					
		Set @I = @i + 1
	end
	
	SELECT
		[E].*,

		Case when [R].[ObjGuid] is null and [E].[Kind] = 1 then 0 
			 when [R].[ObjGuid] is not null and [E].[Kind] = 1 then 1 end as [Check]
	into #Final
	FROM
		#Res_G1 [E]
		left join [RepCheck] [R] on [R].[ObjGuid] = [E].[ItemGuid] and [R].[IdReport] = 1000 and [R].[ObjGuid] <> 0x0
		

	UpDate #Final set [RunTotal] = [Debit]  - [Credit]
	where
		[Kind] = -1
	
	Set @Msg = dbo.SC('')
	exec PrcSetProgrss @Msg, 0, 0

	Select
		@AccountGuid as RepAccountGuid,
		
		@AccountCardNote as [AccountCardNote], 
		[AcCode]+'-'+[AcName] as [AcountName] ,
		* ,
		0 as Operation
	from 
		#Final
  	where	
 		([Debit] <> 0 and @ShowDebit = 1)
 		Or
 		([Credit] <> 0 and @ShowCredit = 1)
 		or Kind = 0
	Order By 
		[Id]

	if @MultiAccount = 0
	Select
		Ac.Code as AccountCode,
		Ac.Name as AccountName,
		(Select  [Debit] - [Credit] From #res where Sort = 3) as [Balance],
		@Date1 as [Date1],
		@Date2 as [Date2]
	From
		Account Ac
	where
		Guid = @AccountGuid


GO

SET ANSI_NULLS, QUOTED_IDENTIFIER ON
GO

Create Procedure [PrcCreateEntryFromFlatContractFee]
(
	@Guid uniqueidentifier = 'A3D19ED0-88BB-47F6-857F-F1F30830FEAD'
)
 
as
	Set noCount on
	
	--Select * from FlatContractFee where ParentGuid = @Guid
	
	exec [PrcDeleteEntryContractFee] @Guid
	
	Declare @CreateContractEntry bit
	Select
		@CreateContractEntry = C.CreateContractEntry
	From
		LeaseApartment C 
	where
		C.Guid = @Guid
	
	if @CreateContractEntry = 0
	return

	Declare	
		@CustAccountGuid uniqueidentifier, 
		@CostGuid  uniqueidentifier,
		@SecLvl int,
		@Mark bit,
		@CurrencyGuid uniqueidentifier, 
		@CurrencyVal Float, 
		@UserGuid uniqueidentifier, 
		@BranchGuid uniqueidentifier, 
		@AutoPostedEntry bit,
		@MoveCost bit,
		@MoveCostWithFeeCredit bit,
		@FeeEntryNote varchar(255)
	
	Select
		@CustAccountGuid = CustAccountGuid,
		@SecLvl = C.SecLvl,
		@Mark = C.Mark,
		@CurrencyGuid = C.CurrencyGuid, 
		@CurrencyVal = C.CurrencyVal,
		@UserGuid = C.UserGuid,
		@BranchGuid = C.BranchGuid,
		@AutoPostedEntry = T.AutoPostedEntry,
		@MoveCost = T.MoveCost,
		@MoveCostWithFeeCredit = T.MoveCostWithFeeCredit,
		@CostGuid = C.CostGuid,
		@FeeEntryNote = T.FeeEntryNote
	From
		LeaseApartment C 
		inner join ContractType t on t.Guid = C.TypeGuid
	where
		C.Guid = @Guid
	
	
	Select 
		@FeeEntryNote  =			REPLACE(REPLACE(REPLACE(REPLACE(REPLACE(REPLACE(
									REPLACE(REPLACE(REPLACE(REPLACE(REPLACE(REPLACE(
									@FeeEntryNote, '[N]', TypeNameAr),
									'[M]', TypeNameLtn),
									'[A]', CustArName),
									'[B]', CustltnName),
									'[C]', FlatNo),
									'[D]', BuildingArName),
									'[E]', BuildingLtnName),
									'[F]', dbo.fndate(EditDate)),
									'[G]', dbo.fndate(Fromdate)),
									'[H]', dbo.fndate(Todate)),
									'[K]', ContractNo),
									'[L]', Cast(Value as varchar(50)))
									
	from 
		[vwAllContract]
	where
		Guid = @Guid
	

	Declare 
		@EntryGuid uniqueidentifier,
		@EntryDate Datetime,
		@FeeAccountGuid uniqueidentifier,
		@EntryNumber int,
		@Value float,
		@Note varchar(255)
		
	DECLARE @cursor_Name CURSOR 
	Set @cursor_Name = CURSOR FAST_FORWARD FOR 
	SELECT 
		[Guid],
		[Date],
		[AccountGuid],
		[EntryNumber],
		[Value],
		[Note]
	FROM 
		FlatContractFee
	where
		(ParentGuid = @Guid) and Value <> 0 and [CreateEntry] = 1
	order By
		Number
	
	OPEN @cursor_Name
	FETCH NEXT FROM @cursor_Name INTO @EntryGuid ,@EntryDate ,@FeeAccountGuid ,@EntryNumber ,@Value ,@Note 
	
	WHILE @@FETCH_STATUS = 0
	BEGIN
		--Select @EntryNumber
		if exists(Select * from HEntry where Number = @EntryNumber)
		Set @EntryNumber = 0
		
		if IsNull(@EntryNumber,0) = 0 
		Select @EntryNumber = IsNull(Max([Number]),0)+1 from [Hentry]	

		update FlatContractFee set EntryNumber = @EntryNumber where Guid = @EntryGuid
		
		--
		Insert into [HEntry]	
		([Guid],[Number],[SecLvl],[Mark],[Date],[CurrencyGuid],[CurrencyVal],[Note],[ParentKind],[UserGuid],[BranchGuid],[IsPosted])
		Select
			@EntryGuid,
			@EntryNumber,
			@SecLvl,
			@Mark,
			@EntryDate,
			@CurrencyGuid, 
			@CurrencyVal, 
			@Note +' '+ISNULL(@FeeEntryNote,''), 
			23 as [ParentKind], 
			@UserGuid, 
			@BranchGuid, 
			@AutoPostedEntry as [IsPosted]

		Insert into [DEntry]
		([ParentGuid],[Number],[AcGuid],[Debit],[Credit],[CurrencyGuid],[CurrencyVal],[CostGuid],[ObverseAcGuid],[Note])
		Select
			@EntryGuid,
			[Number],
			@CustAccountGuid,
			[Value] as Debit,
			0 as Credit,
			@CurrencyGuid,
			@CurrencyVal,
			Case when @MoveCost = 1 then @CostGuid end,
			[AccountGuid] as [ObverseAcGuid],
			[Note] +' '+ISNULL(@FeeEntryNote,'')
		from
			[FlatContractFee]
		where
			Guid = @EntryGuid
		
		Insert into [DEntry]
		([ParentGuid],[Number],[AcGuid],[Debit],[Credit],[CurrencyGuid],[CurrencyVal],[CostGuid],[ObverseAcGuid],[Note])
		Select
			@EntryGuid,
			[Number],
			[AccountGuid],
			0 as Debit,
			[Value] as Credit,
			@CurrencyGuid,
			@CurrencyVal,
			Case when @MoveCostWithFeeCredit = 1 then @CostGuid end,
			@CustAccountGuid as [ObverseAcGuid],
			[Note] + ' '+ISNULL(@FeeEntryNote,'')
		from
			[FlatContractFee]
		where
			Guid = @EntryGuid

		FETCH NEXT FROM @cursor_Name INTO @EntryGuid ,@EntryDate ,@FeeAccountGuid ,@EntryNumber ,@Value ,@Note 
	
	END
	
	CLOSE @cursor_Name
	DEALLOCATE @cursor_Name
	/*

	if @ReturnResult = 1
	Select
		*
	FROM 
		FlatContractFee
	where
		ParentGuid = @Guid
	order By
		Number

	Select * from HEntry
	where Guid = @EntryGuid

	Select Note, * from DEntry
	where ParentGuid = @EntryGuid
	*/
	

GO

SET ANSI_NULLS, QUOTED_IDENTIFIER ON
GO
Create Procedure [PrcTransfer_Checks]
(
	@RoKind int = 2,
	@ToDataBaseName Varchar(256) = 'Q17',
	@UntilDate Datetime = '2016-12-31',
	@BeginDate Datetime = '2017-1-1',
	@RoundContractWithCheckNotCollection bit = 1
)
 
as
	Set nocount on
	if (@RoKind = 1) Return --  
	
	
	Declare @V NVarchar(Max)
		
		Set @V = 
		'	inner join [vwChecksCollectionState] [s] on [S].[CheckGuid] = [Tb].[Guid] --
		where
			(
				(
				 (
					([S].[IsCollection] = 0 )
					and (
							([S].[IsReturned] = 1) and (IsNull([S].[Finished],0) = 0) 
							or [S].[IsReturned] = 0
						)
				)
				or (
					([S].[IsReturned] = 1) and (IsNull([S].[Finished],0) = 0) 
					)
				)
				and ([S].[IsEndorsement] = 0)
			)' 	
			
		if (@RoKind = 2) --    
		begin
			Set @V = @v + '
			or (Date >='+''''+CAST(@UntilDate as varchar(255))+''')
			or (Guid in (Select [CheckGuid] From vwChecksCollection where Date >='+''''+CAST(@UntilDate as varchar(255))+'''))
			or (Guid in (Select [CheckGuid] From ChecksPartialCollection where [Date] >='+''''+CAST(@UntilDate as varchar(255))+'''))'
		end

		if @RoundContractWithCheckNotCollection = 1 --       
		Set @V = @v + '
		or ([Tb].Guid in (
			Select Distinct
				LC.ParentGuid 
			From
				LinkCheckContract LC
				inner join vwChecksCollectionState  Cs on cs.ContractGuid = lc.ContractGuid
			where
				IsCollection = 0))'


		/*
		Set @V = @v + '
		or ([Tb].ContractGuid in (
			Select 
				Distinct ContractGuid
			From 
					vwChecksCollectionState
			where
				IsCollection = 0))'
		*/

		Print '2'
		EXEC PrcTransferTable  'Checks',@ToDataBaseName,@V
 			
 		--exec('select * from '+@ToDataBaseName+'..Checks')

		Set @V = 'Alter Table '+@ToDataBaseName+'..[Checks] disable Trigger all'
		print @V 
		exec(@V)
		
		--        
		Set @V = '
		UpDate '+@ToDataBaseName+'..[Checks] Set [IsRounded] = 1 where Date <'+''''+CAST(@UntilDate as varchar(255))+''''
		exec(@V)

		Set @V = 'Update '+@ToDataBaseName+'..[Checks] Set Date = '''+CAST(@BeginDate as VARchar(20))+''' where [IsRounded] = 1'
		print @V 
		exec(@V)

		
 		--Set @V = '
 		--Update '+@ToDataBaseName+'..[Checks] Set [ContractGuid] = Null'
 		--exec(@V)

		--   
		Set @V = '
		inner Join '+@ToDataBaseName+'..[Checks] L on L.Guid = [Tb].ParentGuid
		'
		EXEC PrcTransferTable  'LinkCheckContract',@ToDataBaseName, @V
		
		
		--  
		Set @V = '
		inner Join '+@ToDataBaseName+'..[Checks] L on L.Guid = [Tb].ParentGuid
		inner Join '+@ToDataBaseName+'..[Account] ac on ac.Guid = [Tb].AccountGuid
		inner Join '+@ToDataBaseName+'..[Cost] co on Co.Guid = [Tb].CostGuid
		'
		EXEC PrcTransferTable  'ChecksAccountDetail',@ToDataBaseName, @V
		

		--      
 		Set @V = '
 		Update '+@ToDataBaseName+'..[Checks] Set [ContractGuid] = Null
		From
			'+@ToDataBaseName+'..[checks] [C]
			left join '+@ToDataBaseName+'..[vwAllContractGuid] [A] on [C].[ContractGuid] = [A].[Guid]
		where
			[A].[Guid] is Null' 
		exec(@V)

		Set @V = 'Alter Table '+@ToDataBaseName+'..[Checks] Enable Trigger all'
		print @V 
		exec(@V)
	 	
	 	
	 	--
		Set @V = '
		inner join (Select [Guid] as [CKGuid] From '+@ToDataBaseName+'..[Checks]) [C] on [C].[CKGuid] = [Tb].[CheckGuid]' 
		EXEC PrcTransferTable  'ChecksCollection',@ToDataBaseName,@V

		Set @V = '
		UpDate '+@ToDataBaseName+'..[ChecksCollection] Set [IsRounded] = 1 where Date <'+''''+CAST(@UntilDate as varchar(255))+''''
		exec(@V)
		
		--Set @V = 'Update '+@ToDataBaseName+'..[ChecksCollection] Set Date = '''+CAST(@BeginDate as VARchar(20))+'''
		--where Date < '+''''+CAST(@UntilDate as varchar(255))+''''
		--print @V 
		--exec(@V)

		--  
		Set @V = '
		inner join (Select [Guid] as [CKGuid] From '+@ToDataBaseName+'..[Checks]) [C] on [C].[CKGuid] = [Tb].[CheckGuid]' 
		EXEC PrcTransferTable  'ChecksPartialCollection',@ToDataBaseName,@V
		
		Set @V = '
		UpDate '+@ToDataBaseName+'..[ChecksPartialCollection] Set [IsRounded] = 1 where Date <'+''''+CAST(@UntilDate as varchar(255))+''''
		exec(@V)
		
		--Set @V = 'Update '+@ToDataBaseName+'..[ChecksPartialCollection] Set Date = '''+CAST(@BeginDate as VARchar(20))+'''
		--where Date < '+''''+CAST(@UntilDate as varchar(255))+''''
		--print @V 
		--exec(@V)
		
		
		Set @V = 'delete '+@ToDataBaseName+'..[Resource]'
		exec(@V)
		
		Set @V = '
		insert into '+@ToDataBaseName+'..[Resource]
		([Guid], [Kind])
		Select Guid, 1 from '+@ToDataBaseName+'..[CheckType]'
		exec (@v)
		
		
	Set @V = '
	exec '+@ToDataBaseName+'..[PrcReNumberCard]
		0, --@Entry
		0, --@FirstEntryNum
		0, --@EntryType
		0x0, --@EntryTypeGuid
		0, --@FirstEntryTypeNum
		1, --@ContractType
		0x0, --@ContractTypeGuid =
		0, --@FirstContractTypeNum
		1, --@CheckType
		0x0, --@CheckTypeGuid 
		0, --@FirstCheckTypeNum
		0, --@Flat
		0, --@Shop
		0, --@Parking
		0, --@Land
		0, --@Villa
		0, --@Account
		0x0, --@ElectricityBillType
		0x0, --@ElectricityBillTypeGuid =
        0 --@Cus
		'
	exec(@V)

		if (@RoKind = 2) --    
		begin
			Set @V = '
			exec '+@ToDataBaseName+'..PrcReCreateCheckEntry 
				@Date1 = 0,
				@Date2 = 0,
				@ActiveDate = 0,
				@Op_Check = 1,
				@Op_Post = 1,
				@Op_Collection = 1,
				@Op_PartCollection = 1,
				@Op_Endorsement = 1,
				@Op_Returned = 1,
				@UpdateCheckwithdefaultaccount = 0
				'
			
			--print @v
			--exec(@V)      
		end
		
	exec ('Truncate Table '+@ToDataBaseName+'..'+'[TableNumber]')
	

GO

SET ANSI_NULLS, QUOTED_IDENTIFIER ON
GO
Create view [vwLandContract]
 
as
	Select 
		[t].[Name] as [TypeName],
		[C].[Number],
		[C].[Mark],
		Case when [ContractKind] = 6 or [ContractKind] = 7 then [L].[Name]
			 when [ContractKind] = 8 or [ContractKind] = 9 then [V].[VillaNo]
		end As [Name],
		Case when [ContractKind] = 6 or [ContractKind] = 7 then [L].[LtnName]
			 when [ContractKind] = 8 or [ContractKind] = 9 then [V].[VillaNo]
		end As [LtnName],
		[C].[Guid],
		[C].[SecLvl],
		[C].[TypeGuid],
		[C].[ContractNo],
		[C].[CustomerGuid],
		[Cu].[Name] as [CustName],
		[Cu].[ArName] as [CustArName],
		[Cu].[ltnName] as [CustltnName],
		[Cu].[Phonejob] as [CustomerPhonejob],
		[Cu].[Mobile] as [CustomerMobile],
		[Cu].[Nationality] as [CustomerNationality],
		[C].[InsuranceAccountGuid] as InsuranceAccountGuid,
		Cu.accountBalance,
		[C].[SalesManGuid],
		Case when [ContractKind] = 6 or [ContractKind] = 7 then [L].[Guid]
			 when [ContractKind] = 8 or [ContractKind] = 9 then [V].[Guid]
		end As [LandGuid],
		
		Case when [ContractKind] = 6 or [ContractKind] = 7 then [L].[Name]
			 when [ContractKind] = 8 or [ContractKind] = 9 then [V].[VillaNo]
		end As  [LandName],
		
		Case when [ContractKind] = 6 or [ContractKind] = 7 then [L].[Details]
			 when [ContractKind] = 8 or [ContractKind] = 9 then [V].[Details]
		end As  [UnitNote],
		
		[C].[EditDate],
		[C].[DeliverDate],
		[C].[FromDate],
		[C].[ToDate],
		Case when [ContractFinish] = 0 then [ToDate] else [ContractFinishDate]  end as [enddate],
		[C].[Rent],

		[C].[RentContractType],
		[C].[MonthlyValue],
		[C].[MonthlyValue] * 12.00 as [YearValue],

		[Cr].[Code] as [CurrencyName],
		[C].[CurrencyGuid],
		[C].[CurrencyVal],
		[C].[PayType],
		[C].[Note],
		[C].[Note2],
		[C].[Whereabouts],
		[C].[RevenueAccountGuid],
		[C].[CustAccountGuid],
		[C].[CommissionFromCustPercent],
		[C].[CommissionFromCustValue],
		[C].[AcCommissionFromCustGuid],
		[C].[CommissionFromOwnerPercent],
		[C].[CommissionFromOwnerValue],
		[C].[AcCommissionFromOwnerGuid],
		[C].[CreateContractEntry],
		[C].[Step1Complete],
		[C].[Step2Complete],
		[C].[Step3Complete],
		[C].[Certification],
		[C].[DiscountPercent],
		[C].[DiscountValue],
		[C].[DiscountAccountGuid],
		[C].[UserGuid],
		[C].[BranchGuid],

		[C].[OtherFee],


		Case 
			when ([Contractkind] = 7) or ([Contractkind] = 9) then 
				Case 
					when 
						Case when [ContractFinish] = 0 then [ToDate] else [ContractFinishDate] end 
						<= GetDate() then -- 
											Case when [ContractFinish] = 0 then dbo.SC('     ') 
											else
											dbo.SC('    ') end
					when 
						Case when [ContractFinish] = 0 then [ToDate] else [ContractFinishDate] end 
						> GetDate() then dbo.SC(' ') 
				end
			when ([Contractkind] = 6) or ([Contractkind] = 8)  then dbo.SC('')
				
		end as [ContractState],

		Case 
			when ([Contractkind] = 7) or ([Contractkind] = 9) then 
				Case 
					when [ContractFinish] = 0 then dbo.SC('') 
					else
					Case 
							when 
								exists(Select 
											[Q].[Guid]
										From 
												[LandContract] [Q] 
												inner join [vwContractType] [Qt] on [Qt].[Guid] = [Q].[TypeGuid]
										where 
											[Qt].[Contractkind] = [T].[Contractkind]
											and [Q].[CustomerGuid] = [C].[CustomerGuid]
											and [Q].[LandGuid] = [C].[LandGuid]
											and [Q].[FromDate] >= [C].[ContractFinishDate]
											and [Q].[Guid] <> [C].[Guid]
										)  then dbo.SC(' ') 
					else
						dbo.SC(' ') 
					end
				end
			when ([Contractkind] = 6) or ([Contractkind] = 8)  then ''
		end as [LandState],

		[C].[RentInfoGuid],
		[C].[Purpose],
		[C].[NewState], 
		[C].[RentDuration],
		[C].[Rentype],
		[C].[TermsOfPayment],
		[C].[InsuranceValuePercent],
		[C].[InsuranceValue],
		[C].[InsuranceValueOld],
		[C].[ContractPrice],
		[C].[CertificatValue],
		[C].[ElectricityInsurance],
		[C].[ElectricityCounter],
		[C].[Period],
		[C].[Step4Complete],
		[C].[Step5Complete],
		[C].[OtherFeeAccountGUID],
		[C].[ContractFinish],
		[C].[ContractFinishDate],
		[C].[EditContractFinishDate],
		[C].[ResultingAmount2],
		[C].[ResultingAmount],
		[C].[RoundKind],	
		[C].[FineRevenueAccountGUID],
		[C].[ResultingNote],
		[C].[Fine],
		[C].[FineAccount],
		[C].[FineNote],
		[C].[CreateResultingEntry],
		[C].[AccountContractPrice],
		[C].[AccountCertificatValue],
		[T].[Contractkind],
		Case when [ContractKind] = 6 or [ContractKind] = 7 then [L].[LandOwner]
			 when [ContractKind] = 8 or [ContractKind] = 9 then ''
		end As [LandOwner],
		[C].[VillaGuid],
		
		[C].[License1No],
		[C].[License2No],
		[C].[License3No],
		[C].[License1Date1],
		[C].[License2Date1],
		[C].[License3Date1],
		[C].[License1Date2],
		[C].[License2Date2],
		[C].[License3Date2],

		[C].[Ltnwhereabouts],
		[C].[LtnPurpose],
		[C].[LtnRentDuration],
		[C].[LtnRentype],
		[C].[LtnTermsOfPayment],

		[C].[Number] as [CardNo],
		
		Case when [L].[Guid] is Not Null then [L].[CostGuid]
			 when [V].[Guid] is Not Null then [V].[CostGuid]
		end as [UnitCostGuid],
		[L].[LandType],
		[C].CostGuid,
		[C].[IsRounded],
		[Leave],
		[LeaveDate],
		[C].[AcquittancePrinted],
		[C].[AcquittancePrintDate],
		[C].[Judicial],
		[C].[Trademark],
		[C].[AcquittancePrintedByGuid],
		C.[PrvContractGuid],
		C.IsAutoRenewal,
		C.AcIncomNextYearGuid,
		C.[AddPercent],
		C.[AddValue],
		C.[CommissionFromSalesManrPercent],
		C.[CommissionFromSalesManValue],
		C.[AcSalesManCommissionGuid],
		C.[AcCommissionExpenseGuid],
		C.[SalesManCommNote]
	from 
		[vbLandContract] [C]
		inner join [vwContractType] [T] on [T].[Guid] = [C].[TypeGuid]
		left join [vwEarth]	[L] on [C].[LandGuid] = [L].[Guid] and ([ContractKind] = 6 or [ContractKind] = 7)
		left join [vwVilla]	[V] on [C].[VillaGuid] = [V].[Guid]  and ([ContractKind] = 8 or [ContractKind] = 9)
		left join [vwCustomer] [Cu] on [Cu].[Guid] = [C].[CustomerGuid]
		left join [Currency] [Cr] On [Cr].[Guid] = [C].[CurrencyGuid]

GO

SET ANSI_NULLS, QUOTED_IDENTIFIER ON
GO

Create Procedure [PrcPrintReceiptLandContract]
(
	@Guid uniqueidentifier = '3B67418A-7800-4F09-8391-21EC204D040B',
	@Only Varchar(256) = '',
	@OnlyAr Varchar(256) = '',
	@OnlyEn Varchar(256) = ''
)
 
as
	Set NoCount On
		--  
	Declare @SumCheck Float, @SumCach Float, @SumPay Float
	
	Select
		@SumCheck = Sum([Value])
	From
		[LinkCheckContract] [C]
		inner join (Select Distinct Guid From [Resource] where [Spid] = @@Spid) [R] on [R].[Guid] = [C].ParentGuid
	where
		[ContractGuid] = @Guid

	Select
		@SumCach = isnull(Sum([Value] * [CurrencyVal]),0)
	From
		[vwLandContractCachPayment] [C]
		inner join [Resource] [R] on [R].[Guid] = [C].[Guid] and [Spid] = @@Spid
	where
		[ContractGuid] = @Guid

	Set @SumPay = ISNULL(@SumCheck,0) + ISNULL(@SumCach,0)


	Select
		[A].[Number],
		[A].[ContractNo],
		[A].[CustName],
		[A].[CustArName],
		[A].[CustLtnName],
		[cu].[Barcode] as [Cust_Barcode], 		[cu].[Name] as [Cust_Name], 		[cu].[LtnName] as [Cust_LtnName], 		[cu].[CardKind] as [Cust_CardKind], 		[cu].[CardKind2] as [Cust_CardKind2], 		[cu].[Nationality] as [Cust_Nationality], 		[cu].[LtnNationality] as [Cust_LtnNationality], 		[cu].[Profession] as [Cust_Profession], 		[cu].[LtnProfession] as [Cust_LtnProfession], 		[cu].[PassportNO] as [Cust_PassportNO], 		[cu].[PassportExpireDate] as [Cust_PassportExpireDate], 		[cu].[Domicile] as [Cust_Domicile], 		[cu].[Security] as [Cust_Security], 		[cu].[LtnSecurity] as [Cust_LtnSecurity], 		[cu].[PhoneJob] as [Cust_PhoneJob], 		[cu].[Mobile] as [Cust_Mobile], 		[cu].[Note] as [Cust_Note], 		[cu].[Trademark] as [Cust_Trademark], 		[cu].[LtnTrademark] as [Cust_LtnTrademark], 		[cu].[MemoSecurity] as [Cust_MemoSecurity], 		[cu].[LtnMemoSecurity] as [Cust_LtnMemoSecurity], 		[cu].[Address] as [Cust_Address], 		[cu].[LtnAddress] as [Cust_LtnAddress], 		[cu].[BoxNo] as [Cust_BoxNo], 		[cu].[PersonalityNo1] as [Cust_PersonalityNo1], 		[cu].[PersonalityNo2] as [Cust_PersonalityNo2], 		[cu].[Fax] as [Cust_Fax], 		[cu].[EMail] as [Cust_EMail], 		[cu].[Adjective] as [Cust_Adjective], 		[cu].[LtnAdjective] as [Cust_LtnAdjective], 		[cu].[CkHideInSearch] as [Cust_CkHideInSearch], 		[cu].[ban] as [Cust_ban], 		[cu].[BankName] as [Cust_BankName], 		[cu].[BankAccCode] as [Cust_BankAccCode], 		[cu].[Birthday] as [Cust_Birthday], 		[cu].[DomicileEndDate] as [Cust_DomicileEndDate], 		[cu].[PersonalityEndDate] as [Cust_PersonalityEndDate], 		[cu].[CustNote1] as [Cust_CustNote1], 		[cu].[CustNote2] as [Cust_CustNote2], 		[cu].[CustNote3] as [Cust_CustNote3], 		[cu].[CustNote4] as [Cust_CustNote4], 		[cu].[CustNote5] as [Cust_CustNote5], 		[cu].[CustNote6] as [Cust_CustNote6], 		[cu].[CustNote7] as [Cust_CustNote7], 		[cu].[banContract] as [Cust_banContract], 
		A.accountBalance,
		@SumCheck as [SumCheck],
		@SumCach as [SumCach],
		@SumPay as [SumPay], 
		@Only as [OnlySumCheck], 
		@OnlyAr as [OnlySumCheckAr], 
		@OnlyEn as [OnlySumCheckEn], 
		[A].[FromDate],
		[A].[ToDate],
		
		DATEDIFF(DAY, ToDate, FromDate) as ContractDays,
		Case when ContractFinish = 1 then 
		DATEDIFF(DAY, ToDate, ContractFinishDate) 
		end as ContractDaysDifference,
		
		[A].[Name] as [LandName],
		[A].[Note2],
		[A].[Rent] as [ContractValue],
		[A].[CurrencyName],
		[A].[DiscountPercent],
		[A].[DiscountValue],
		[A].[InsuranceValueOld],
		[A].[InsuranceValue],
		[A].[InsuranceValuePercent],
		[A].[CommissionFromCustValue],
		[A].[CommissionFromOwnerValue],
		[A].[ElectricityInsurance],
		[A].[ElectricityCounter],
		[A].[ContractPrice],
		[A].[CertificatValue],
		[A].[OtherFee],
		Case when isnull(NewState,0) = 0 then dbo.sc('') else dbo.sc('') end as [NewSate],
		Case when isnull(NewState,0) = 0 then '' else '' end as [ArNewSate],
		Case when isnull(NewState,0) = 0 then 'New' else 'Renewal' end as [LtnNewSate],
		S.Name as [SalesMan]
	From 
		[vwLandContract] A
		left join Salesman S on S.Guid = [A].[SalesManGuid]
		inner join Customer Cu on Cu.Guid = A.CustomerGuid
	where 
		([A].[Guid] = @Guid or @Guid = 0x0)

	Create Table [#Tbl]
	(
		[BankName] Varchar(256),
		[Value] Float,
		[Currency] Varchar(256),
		[No]  Varchar(256),
		[DueDate] DateTime,
		[State] Varchar(256),
		[Note] Varchar(256)
	)

	Insert Into [#Tbl]
	Select
		[BankName],
		Cast([LL].[Value] as Varchar(20)) as [Value],
		[CurrencyName]  as [Currency],
		[No],
		[DueDate],
		Case 		
			when  [C3].[CheckGuid] is not null then dbo.SC('')
			when  [C1].[CheckGuid] is not null then dbo.SC('') 
			when  [C4].[CheckGuid] is not null then dbo.SC(' ') 
			when  [C].[CheckGuid] is not null then dbo.SC('') 
			when  [C2].[CheckGuid] is not null then dbo.SC('') 
		end as [State],
		[P].[Note3]
	From
		[vwChecks] [P]
		inner join [LinkCheckContract] LL on LL.ParentGuid = P.Guid
 		left join [vwChecksCollection] [C] on [C].[CheckGuid] = [P].[Guid] and [C].[Kind] = 0
 		left join [vwChecksCollection] [C1] on [C1].[CheckGuid] = [P].[Guid] and [C1].[Kind] = 1
 		left join [vwChecksCollection] [C2] on [C2].[CheckGuid] = [P].[Guid] and [C2].[Kind] = 2
 		left join [vwChecksCollection] [C3] on [C3].[CheckGuid] = [P].[Guid] and [C3].[Kind] = 3
 		left join [ChecksPartialCollection]  [C4] on [C4].[CheckGuid] = [P].[Guid] and [C3].[Kind] = 3
		inner join [Resource] [R] on [R].[Guid] = [P].[Guid] and [Spid] = @@Spid
	where
		LL.[ContractGuid] = @Guid

	Select * from [#Tbl]
	Order By
		[DueDate], [No]

	Select
		dbo.sc('') as [BankName],
		Cast([Value] as Varchar(20)) as [Value],
		[Currency]  as [Currency],
		'' as [No],
		[Date],
		'' as State,
		[C].[HNote],
		[C].[DNote]
	From
		[vwLandContractCachPayment] [C]
		inner join [Resource] [R] on [R].[Guid] = [C].[Guid] and [Spid] = @@Spid
	where
		[ContractGuid] = @Guid


GO

SET ANSI_NULLS, QUOTED_IDENTIFIER ON
GO

Create Proc [PrcBalanceSheet]
(
	@AccountGuid [uniqueidentifier]= 'FB389436-59C8-441D-9AD3-75668D64D6F7'
	,@BranchGuid [uniqueidentifier] = 0x0
	,@CostGuid [uniqueidentifier] = 0x0
	,@Level int = 5
	,@ShowEmptyBal Bit = 0
	,@ShowMainAccount Bit = 0
	,@CurrencyGuid [uniqueidentifier] = '11111111-C748-4B13-8B91-1E9B299DF1C1'
	,@CurrencyVal Float = 1
	,@ShowDetails bit = 1 --    
	,@IsPosted Bit = 1
	,@IsNotPosted Bit = 1
	,@Date1 DateTime = '1/2/2007'
	,@Date2 DateTime = '12/30/2015'
    ,@ContainOldEntry Bit = 0
	,@PriceMode int = 1
	,@SpecificPrice int = -1
)
 
as
	set nocount on 
	
	--   
	exec [dbo].[PrcMatInventory]
		@GroupGuid = 0x0,
		@MatGuid = 0x0,
		@StoreGuid = 0x0,
		@CostGuid = @CostGuid,
		@Class  = '',
		@ClassGrouping = 0,
		@Unit = 0,
		@BillPost = 2,
		@CkDate = 0,
		@PriceMode = @PriceMode,
		@SpecificPrice = @SpecificPrice,
		@CurrencyGuid = @CurrencyGuid,
		@CurrencyVal = @CurrencyVal,
		@ShowEmpltyMat = 0,
		@ShowDetailStore = 0,
		@ShowMatTypeStore = 1,
		@ShowMatTypeService = 0,
		@Date1 = '1/1/2007',
		@Date2 = '1/1/2015',		
		@RepKind = 1 --0 Normal		1 Total

	--Select * from Dentry where ParentGuid = '{19191919-8282-7373-6464-656565656566}'
	
	
	Select * Into dbo.#fnGetAccountList_BS from [dbo].[fnGetAccountList](@AccountGuid)
	Select * Into dbo.#fnGetAccountList from [dbo].[fnGetAccountList](0x0)
	
	--Select * from #fnGetAccountList
	
	Select O.* Into #fnGetCostList_BS 
	from 
		[dbo].[fnGetCostList](@CostGuid) C
		inner join [Cost] O on O.Guid = C.GUID
	
	Set noCount on
	--  
	Select
		[Ac2].[Code] COLLATE database_default as [Code]
		,[Ac2].[Code]+'-'+[Ac2].[Name] COLLATE database_default as [AccountName]
		,[Ac].[Level]
		,isnull([Ac].[Path],'') as [Path]
		,[Ac2].[Guid]
		,[Ac2].[ParentGuid]
		,Case when Type = 0 then [Ac2].[FinalGuid] 
			  when Type = 1 then [Ac2].[ParentGuid] 
		end as [FinalGuid]
		,[Ac2].[Type]
		,Cast('' as Varchar(256)) COLLATE database_default as [Sort]
		,Isnull([SAc].[AcNSons],0) as [AcNSons]
	into #Ac
	From
		#fnGetAccountList [Ac] 
		inner join [vwAccount] [Ac2] on [Ac2].[Guid] = [Ac].[Guid]
		left join [dbo].#fnGetAccountList_BS [AcF] on [AcF].[Guid] = [Ac2].[FinalGuid]   
		left join (Select 
						Count(Number)as [AcNSons] 
						,[ParentGuid] 
					From 
						[Account] [SAc] 
					Group By
						[ParentGuid]					
				)[SAc] on [SAc].[ParentGuid] = [Ac2].[Guid]
	--Select * from #Ac order by Path
--	return

	CREATE INDEX IX_AC_Code ON #Ac (Code)
	CREATE INDEX IX_AC_Type ON #Ac ([Type])
	
	--  
	Declare @AcSort Varchar(256)
	Declare @SortCode Varchar(256)
	Set @SortCode = ''

	DECLARE cursor_Name CURSOR FAST_FORWARD FOR 
	SELECT ([Code]) FROM [#Ac] where [Type] = 1	Order By [Code]
	OPEN cursor_Name
	FETCH NEXT FROM cursor_Name INTO @AcSort
	
	WHILE @@FETCH_STATUS = 0
	BEGIN
		
		Set @SortCode = @SortCode + 'Z'
	
		
		UpDate #Ac Set [Sort] = @SortCode
		where [Code] = @AcSort and Type = 1

		
		update Ac1 Set [Sort] = @SortCode + isNull([Ac1].[Code],'')
			From 
				#Ac Ac1 
				inner join #Ac Ac2 On Ac1.[FinalGuid] = [Ac2].[Guid]
		where
			[Ac2].[Code] = @AcSort and [Ac1].[Type] = 0
		
		
		Print '_______________________________'
	  FETCH NEXT FROM cursor_Name INTO @AcSort
	
	END
	
	CLOSE cursor_Name
	DEALLOCATE cursor_Name

	--Select * from #Ac Order by [Sort]
	--Return
	--

	--  
	Select 
		[Ac].[Guid] as [AcGuid]
		,Sum([En].[D_Debit]*
			Case when [En].[D_CurrencyGuid] = @CurrencyGuid then 1 
			else [En].[D_CurrencyVal] / @CurrencyVal end
			) as [Debit]
		,Sum([En].[D_Credit]*
			Case when [En].[D_CurrencyGuid] = @CurrencyGuid then 1 
			else [En].[D_CurrencyVal] / @CurrencyVal end
			) as [Credit]
	into #Entry
	from 
		--[DEntry] [En]
		--inner Join [VwEntry] [M] on [M].[Guid] = [En].[ParentGuid]
		[vwOldYearEntry] En
		inner Join [dbo].#fnGetAccountList [Ac] on [Ac].[Guid] = [En].[D_AcGuid]
		left Join #fnGetCostList_BS [Co2] on [Co2].[Guid] = [En].[D_CostGuid]
	where 
		([En].[H_Date] between @Date1 And @Date2)
		and ([En].[H_BranchGuid] = @BranchGuid or @BranchGuid = 0x0)
		and ([Co2].[Guid] Is Not Null or @CostGuid = 0x0)
		and ([En].[D_IsVisible] = 1 or [En].[D_CurrencyGuid] = @CurrencyGuid)
		and (
				([En].[H_IsPosted] = 1 and @IsPosted = 1)
				or ([En].[H_IsPosted] = 0  and @IsNotPosted = 1)
			)
		and (En.isOldEntry = 0 or @ContainOldEntry = 1)
	Group By
		[Ac].[Guid]
	
	--Select * from #Entry	
	--return
	--

	--  
	Select 
		[Ac].[Guid] as [AcGuid]
		,Sum([En].[D_Debit]) as [Debit]
		,Sum([En].[D_Credit]) as [Credit]
	into #OldBalance
	from 
		--[DEntry] [En]
		--inner Join [vwEntry] [M] on [M].[Guid] = [En].[ParentGuid]
		[vwOldYearEntry] En
		inner Join [dbo].#fnGetAccountList_BS [Ac] on [Ac].[Guid] = [En].[D_AcGuid]
		left Join #fnGetCostList_BS [Co2] on [Co2].[Guid] = [En].[D_CostGuid]
	where 
		([En].[H_Date] < @Date1)
		and ([En].[H_BranchGuid] = @BranchGuid or @BranchGuid = 0x0)
		and ([En].[D_IsVisible] = 1 or [En].[D_CurrencyGuid] = @CurrencyGuid)
		and (
				([En].[H_IsPosted] = 1 and @IsPosted = 1)
				or ([En].[H_IsPosted] = 0  and @IsNotPosted = 1)
			)
		and ([Co2].[Guid] Is Not Null or @CostGuid = 0x0)
	Group By [Ac].[Guid]
	
	
--	Select * from #OldBalance	
	--	

	Select 
		[Ac].[AccountName] COLLATE database_default as [AccountName]
		,[Ac].[Level]
		,[E].[Debit]
		,[E].[Credit]
		,[B].[Debit] as [OldDebit]
		,[B].[Credit] as [OldCredit]
		,[Ac].[Path]
		,[Ac].[Guid] as [AcGuid]
		,[Ac].[ParentGuid]
		,[Ac].[FinalGuid]
		,[Ac].[Type]
		,[Ac].[Sort]
		,[Ac].[AcNSons]
	Into #Tmp_Balance_Res1
	From
		#Ac	[Ac]
		left join #Entry [E] on [E].[AcGuid] = [Ac].[Guid]
		left join #OldBalance [B] on [B].[AcGuid] = [Ac].[Guid]
	
	
	Declare @AcLevel int, @Tmp_FinalGuid uniqueidentifier

	Create Table #Res2
	(
		[FinalGuid] uniqueidentifier
		,[SumDebit] Float
		,[SumCredit] Float
		,[SumOldDebit] Float
		,[SumOldCredit] Float
	)
	--  
	SET @acLevel = (SELECT MAX([Level]) FROM [#Tmp_Balance_Res1] where Type = 1) 
	WHILE @acLevel >= 0  
	BEGIN  

		print '@acLevel'
		print @acLevel
		
		--Select [Level], Guid From #Ac where [Level] = @acLevel and Type = 1

		Set @Tmp_FinalGuid = (Select Top 1 Guid From #Ac where [Level] = @acLevel and Type = 1)
		
		Delete #Res2
		
		insert into #Res2
		SELECT
			[FinalGuid] 
			,isnull(Sum([Debit]),0)			as  [SumDebit]
			,isnull(Sum([Credit]),0)		as  [SumCredit]
			,isnull(Sum([OldDebit]),0)		as  [SumOldDebit]
			,isnull(Sum([OldCredit]),0)		as  [SumOldCredit]
		FROM 
			[#Tmp_Balance_Res1]  
		WHERE  
			[FinalGuid] = @Tmp_FinalGuid
		GROUP BY 
			[FinalGuid]		
	
			
		UPDATE [#Tmp_Balance_Res1] SET  
			[Debit] 		= isnull([Sons].[SumDebit],0)
			,[Credit]	 	= isnull([Sons].[SumCredit],0)
			,[OldDebit]		= isnull([Sons].[SumOldDebit],0) 
			,[OldCredit]	= isnull([Sons].[SumOldCredit],0)
		FROM  
				[#Tmp_Balance_Res1] AS [Father] 
				INNER JOIN #Res2 AS [Sons] ON [Father].[acGUID] = [Sons].[FinalGuid] 
		
		SET @acLevel = @acLevel - 1 
	End

	--Select * from [#Tmp_Balance_Res1]
	--return
	
	SET @acLevel = (SELECT MAX([Level]) FROM [#Tmp_Balance_Res1]) 
	WHILE @acLevel >= 0  
	BEGIN  
		UPDATE [#Tmp_Balance_Res1] SET  
			[Debit] 		= isnull([SumDebit],0)
			,[Credit]	 	= isnull([SumCredit],0)
			,[OldDebit]		= isnull([SumOldDebit],0) 
			,[OldCredit]	= isnull([SumOldCredit],0)
			FROM  
				[#Tmp_Balance_Res1] AS [Father] INNER JOIN (  
					SELECT 
						[ParentGuid] 
						,isnull(Sum([Debit]),0)			as  [SumDebit]
						,isnull(Sum([Credit]),0)		as  [SumCredit]
						,isnull(Sum([OldDebit]),0)		as  [SumOldDebit]
						,isnull(Sum([OldCredit]),0)		as  [SumOldCredit]
					FROM 
						[#Tmp_Balance_Res1]  
					WHERE  
						[Level] = @acLevel and [Type] = 0
					GROUP BY 
						[ParentGuid] 
					) AS [Sons] 
				ON [Father].[acGUID] = [Sons].[ParentGuid] 

		SET @acLevel = @acLevel - 1 
	End

	--return
	--Select * from #Tmp_Balance_Res1
	Create index IX_Path_Tmp_Balance_Res1 On #Tmp_Balance_Res1 ([Path])
	
--	Select 
--		[R].[AccountName] COLLATE database_default as [AccountName] ,
--		--(Select Case when [Debit] > [Credit] then 0 else 1 end From #Tmp_Balance_Res1 where [Path] = left([R].[Path],9))  as [Pa],
--		left([R].[Path],9) ,
--		Case when 
--				(Select Case when isNull([Debit],0) > isNull([Credit],0) then 0 else 1 end From #Tmp_Balance_Res1 where [Path] = left([R].[Path],9)) = 0
--			 then isnull([Debit],0) - isnull([Credit],0) 
--			 else 
--				0 
--		end as [BalanceDebit],

--		Case when 
--				(Select Case when isNull([Debit],0) > isNull([Credit],0) then 0 else 1 end From #Tmp_Balance_Res1 where [Path] = left([R].[Path],9)) = 1
--			 then isnull([Credit],0) - isnull([Debit],0) else 
--				0
--		end as [BalanceCredit],

----		Case when isnull([Debit],0) > isnull([Credit],0) then isnull([Debit],0) - isnull([Credit],0) else 0 end as [BalanceDebit],
----		Case when isnull([Debit],0) < isnull([Credit],0) then isnull([Credit],0) - isnull([Debit],0) else 0 end as [BalanceCredit],
--		Case when isnull([Debit],0) > isnull([Credit],0) And Type = 1 then dbo.sc('')
--			 when isnull([Debit],0) < isnull([Credit],0) And Type = 1 then dbo.sc('') end COLLATE database_default as [Result],
--		Case when [R].[Type] = 1 then 0 else [R].[Level] end as [Level],
--		[R].[Path],
--		[R].[AcGuid],
--		[R].[ParentGuid],
--		[R].[FinalGuid],
--		[R].[Type],
--		[R].[AcnSons],
--		[R].[Sort]
--	from 
--		#Tmp_Balance_Res1 [R]
--		left join [dbo].#fnGetAccountList_BS [Ac] on [R].[FinalGuid] = [Ac].[Guid]
--	where
--		[Ac].[Guid] is Not Null and ([FinalGuid] = @AccountGuid or @ShowDetails = 1)
		
--		and [R].[AccountName] = '01-  '	
--	Order by 
--		[Sort]
	--Select isNull([Debit],0) - isNull([Credit],0)  From #Tmp_Balance_Res1 where [Path] = '0.0000001'
	Select 
		[R].[AccountName] COLLATE database_default as [AccountName] ,
		(Select Case when [Debit] > [Credit] then 0 else 1 end From #Tmp_Balance_Res1 where [Path] = left([R].[Path],9))  as [Pa],
		
		Case when Type = 0 then
			Case when  
					(Select Case when isNull([Debit],0) >= isNull([Credit],0) then 0 else 1 end From #Tmp_Balance_Res1 where [Path] = left([R].[Path],9)) = 0
				 then isnull([Debit],0) - isnull([Credit],0) 
				 else 
					0 
			end 
		else
		Case when isnull([Debit],0) > isnull([Credit],0) then isnull([Debit],0) - isnull([Credit],0) else 0 end
		end
		as [BalanceDebit],

		Case when Type = 0 then
			Case when  
					(Select Case when isNull([Debit],0) < isNull([Credit],0) then 0 else 1 end From #Tmp_Balance_Res1 where [Path] = left([R].[Path],9)) = 0
				 then isnull([Credit],0)  - isnull([Debit],0) 
				 else 
					0 
			end 
		else
		Case when isnull([Debit],0) < isnull([Credit],0) then isnull([Credit],0)  - isnull([Debit],0)  else 0 end
		end
		as [BalanceCredit],

		--Case when isnull([Debit],0) > isnull([Credit],0) then isnull([Debit],0) - isnull([Credit],0) else 0 end as [BalanceDebit],
		--Case when isnull([Debit],0) < isnull([Credit],0) then isnull([Credit],0) - isnull([Debit],0) else 0 end as [BalanceCredit],
		Case when isnull([Debit],0) > isnull([Credit],0) And Type = 1 then dbo.sc('')
			 when isnull([Debit],0) < isnull([Credit],0) And Type = 1 then dbo.sc('') end COLLATE database_default as [Result],
		Case when [R].[Type] = 1 then 0 else [R].[Level] end as [Level],
		[R].[Path],
		[R].[AcGuid],
		[R].[ParentGuid],
		[R].[FinalGuid],
		[R].[Type],
		[R].[AcnSons],
		[R].[Sort]
	Into #FirstRes
	from 
		#Tmp_Balance_Res1 [R]
		left join [dbo].#fnGetAccountList_BS [Ac] on [R].[FinalGuid] = [Ac].[Guid]
	where
		[Ac].[Guid] is Not Null and ([FinalGuid] = @AccountGuid or @ShowDetails = 1)
	Order by 
		[Sort]

	--Select * from #FirstRes 

	-- 
	Create Table #EndRes 
	(
		[SumDebit] Float Default 0,
		[DebitNote] Varchar(256) COLLATE database_default ,
		[SumCredit] Float Default 0,
		[CreditNote] Varchar(256) COLLATE database_default ,
		[Sort] int
	)
	insert into #EndRes
	Select 
		Sum([BalanceDebit]) as [SumDebit],
		dbo.sc(''),
		Sum([BalanceCredit]),
		dbo.sc(''),
		0
	From 
		#FirstRes [R]
	where
		[Level] = 0 and ([Type] <> 1 or @ShowDetails = 0)

	-- 
	if @ShowEmptyBal = 0 
	delete from #FirstRes
	where isnull([BalanceDebit],0) = 0  and isnull([BalanceCredit],0) = 0
			and Level <> 0

	-- 
	if @ShowMainAccount	= 0 
	delete from #FirstRes
	where ([AcnSons] <> 0) and Type = 0


	--
	delete from #FirstRes
	where ([level] >= @Level and @Level <> 0) and [Type] <> 1


	Select * from #FirstRes
	Order by 
		[Sort]


	exec dbo.PrcInsertSC ' '

	Declare @AccountKind int
	Select @AccountKind = COUNT(*) -1 from [dbo].[fnGetAccountParents] (@AccountGuid)
	Declare 
		@EndResTxt1 varchar(255),
		@EndResTxt2 varchar(255)
	Select 
		@EndResTxt1 = 
		Case 
			when @AccountKind = 1 then  
				dbo.sc(' ')
			else
				dbo.sc(' ')
		end,
		@EndResTxt2 = 
		Case 
			when @AccountKind = 1 then  
				dbo.sc(' ')
			else
				dbo.sc(' ')
		end
	
	insert into #EndRes
	Select 
		Case when [SumDebit] < [SumCredit] then [SumCredit] - [SumDebit] end,
		Case when [SumDebit] < [SumCredit] then @EndResTxt1 end ,
		Case when [SumDebit] > [SumCredit] then [SumDebit] - [SumCredit] end,
		Case when [SumDebit] > [SumCredit] then @EndResTxt2 end ,
		1
	From 
		#EndRes [R]
	where
		abs(isnull([SumDebit],0) - isNull([SumCredit],0)) > 0.001

	insert into #EndRes
	Select 
		Sum([SumDebit]),
		dbo.sc(' '),
		Sum([SumCredit]),
		dbo.sc(' '),
		2
	From 
		#EndRes [R]
	
	Select * from #EndRes

	Delete HEntry where Guid = '{19191919-8282-7373-6464-656565656566}'
	

GO

SET ANSI_NULLS, QUOTED_IDENTIFIER ON
GO

Create Procedure [dbo].[PrcUpdateFlatContractWithDefaultType]
(
	@Date1 DateTime = '3/1/2011',
	@Date2 DateTime = '3/1/2012',
	@ActiveDate bit = 0,
	@Datewith int = 0,
	@Num1 int = 1,
	@Num2 int = 100,
	@ActiveNum bit = 1
)
 
as
	Alter Table [LeaseApartment] Disable Trigger All
	
	update [LeaseApartment]
	Set
		RevenueAccountGuid = Case when T.RevenueAccountGuid is Not Null then T.RevenueAccountGuid else L.RevenueAccountGuid end
		,AcCommissionFromCustGuid = Case when T.AcCommissionFromCustGuid is Not Null then T.AcCommissionFromCustGuid else L.AcCommissionFromCustGuid end
		,AcCommissionFromOwnerGuid = Case when T.AcCommissionFromOwnerGuid is Not Null then T.AcCommissionFromOwnerGuid else L.AcCommissionFromOwnerGuid end
		,AccountContractPrice = Case when T.AccountContractPriceGuid is Not Null then T.AccountContractPriceGuid else L.AccountContractPrice end
		,AccountCertificatValue = Case when T.AccountCertificatValueGuid is Not Null then T.AccountCertificatValueGuid else L.AccountCertificatValue end
		,FineAccount = Case when T.FineAccountGuid is Not Null then T.FineAccountGuid else L.FineAccount end
		,DiscountAccountGuid = Case when T.DiscountAccountGuid is Not Null then T.DiscountAccountGuid else L.DiscountAccountGuid end
		,OtherFeeAccountGUID = Case when T.TaxAccount is Not Null then T.TaxAccount else L.OtherFeeAccountGUID end
		,InsuranceAccountGUID = Case when T.InsuranceAccountGuid is Not Null then T.InsuranceAccountGuid else L.InsuranceAccountGUID end
		,AcIncomNextYearGuid = Case when T.AcIncomNextYearGuid is Not Null then T.AcIncomNextYearGuid else L.AcIncomNextYearGuid end
	From
		[LeaseApartment] L
		inner join [ContractType] T on T.Guid = L.TypeGuid
		inner join [Resource] R on R.Guid = L.TypeGuid and R.Spid = @@SPID
	where
		((L.number between @num1 and @Num2) or @ActiveNum = 0)
		and (
			(
				([L].[FromDate] between @Date1 and @Date2 and @Datewith = 0)
			)
			or
			(
				([L].[ToDate] between @Date1 and @Date2 and @Datewith = 1)
			)

			or
			(
				([L].[ContractFinishDate] between @Date1 and @Date2 and @Datewith = 2)
				and ([L].[ContractFinish] = 1)
			)

			or
			(
				([L].[EditDate] between @Date1 and @Date2 and @Datewith = 3)
			)
			or
			(
				([L].[AcquittancePrintdate] between @Date1 and @Date2 and @Datewith = 4)
			)

			or
			(
				([L].LeaveDate between @Date1 and @Date2 and @Datewith = 5)
			)
			or @ActiveDate = 0
		) 
		

	update [LeaseApartment]
	Set
		RevenueAccountGuid = S.AccountCommIncomeGuid,
		AcCommissionFromOwnerGuid = S.AcCommissionFromOwnerGuid
	From
		[LeaseApartment] L
		inner join vwShop S on S.Guid = L.ApartmentGuid
		inner join [ContractType] T on T.Guid = L.TypeGuid
		inner join [Resource] R on R.Guid = L.TypeGuid and R.Spid = @@SPID
	where
		(
			(S.BuildingOpOwner = 4) and (BuildingOwnerName is Not Null)
		)
		and ((L.number between @num1 and @Num2) or @ActiveNum = 0)
		and (
			(
				([L].[FromDate] between @Date1 and @Date2 and @Datewith = 0)
			)
			or
			(
				([L].[ToDate] between @Date1 and @Date2 and @Datewith = 1)
			)

			or
			(
				([L].[ContractFinishDate] between @Date1 and @Date2 and @Datewith = 2)
				and ([L].[ContractFinish] = 1)
			)

			or
			(
				([L].[EditDate] between @Date1 and @Date2 and @Datewith = 3)
			)
			or
			(
				([L].[AcquittancePrintdate] between @Date1 and @Date2 and @Datewith = 4)
			)

			or
			(
				([L].LeaveDate between @Date1 and @Date2 and @Datewith = 5)
			)
			or @ActiveDate = 0
		) 
		

	update [LeaseApartment]
	Set
		RevenueAccountGuid = S.AccountCommIncomeGuid,
		AcCommissionFromOwnerGuid = S.AcCommissionFromOwnerGuid
	From
		[LeaseApartment] L
		inner join vwApartmentFull S on S.Guid = L.ApartmentGuid
		inner join [ContractType] T on T.Guid = L.TypeGuid
		inner join [Resource] R on R.Guid = L.TypeGuid and R.Spid = @@SPID
	where
		(
			(S.BuildingOpOwner = 4) and (BuildingOwnerName is Not Null)
		)
		and ((L.number between @num1 and @Num2) or @ActiveNum = 0)
		and (
			(
				([L].[FromDate] between @Date1 and @Date2 and @Datewith = 0)
			)
			or
			(
				([L].[ToDate] between @Date1 and @Date2 and @Datewith = 1)
			)

			or
			(
				([L].[ContractFinishDate] between @Date1 and @Date2 and @Datewith = 2)
				and ([L].[ContractFinish] = 1)
			)

			or
			(
				([L].[EditDate] between @Date1 and @Date2 and @Datewith = 3)
			)
			or
			(
				([L].[AcquittancePrintdate] between @Date1 and @Date2 and @Datewith = 4)
			)

			or
			(
				([L].LeaveDate between @Date1 and @Date2 and @Datewith = 5)
			)
			or @ActiveDate = 0
		) 

		Alter Table [LeaseApartment] Enable Trigger All


GO

SET ANSI_NULLS, QUOTED_IDENTIFIER ON
GO

Create Procedure [PrcCreateEntryFromEntryType]
(
	@Guid uniqueidentifier = '2DE70F60-33F8-436A-A4CA-B8E91AFBA478',
	@ContractGuid uniqueidentifier = '339C53E9-B65E-4F11-BDAB-F67BE4EDF6E7'
)
 
as
	
	Set noCount on

	--Set @ContractGuid = (Select Guid from vwAllContractGuid where Guid = @ContractGuid)
	
	Declare @ContractKind Int
	Set @ContractKind = -1
	Select @ContractKind = [Kind] From [vwAllContractKind] where ContractGuid = @ContractGuid

	if isNull(@ContractGuid ,0x0) = 0x0
	begin
		if @ContractKind = 0
		Select @ContractGuid = [ContractGuid] from [ContractCachPayment]
		where [EntryGuid] = @Guid

		if @ContractKind = 1
		Select @ContractGuid = [ContractGuid] from [ContractParkingCachPayment]
		where [EntryGuid] = @Guid

		if @ContractKind = 2
		Select @ContractGuid = [ContractGuid] from [LandContractCachPayment]
		where [EntryGuid] = @Guid

		if @ContractKind = 3
		Select @ContractGuid = [ContractGuid] from [ElectricityCachPayment]
		where [EntryGuid] = @Guid
		
		if @ContractKind = 4
		Select @ContractGuid = [ContractGuid] from [ServicesContractCachPayment]
		where [EntryGuid] = @Guid
		
		if @ContractKind = 5
		Select @ContractGuid = [ContractGuid] from [MaintenanceContractCachPayment]
		where [EntryGuid] = @Guid
	end


	--Select @ContractKind, @ContractGuid
	--  
	Declare @EntryNum int
	Select @EntryNum = [Number] from [Hentry]
	where
		[Guid] = @Guid

	if IsNull(@EntryNum,0) = 0 
	Select @EntryNum = IsNull(Max([Number]),0)+1 from [Hentry]	
	
    Delete [Hentry] where [Guid] = @Guid

	Declare @CheckCreateEntry Bit,
			@AutoPostedEntry Bit

	Select 
			@CheckCreateEntry = [S].[CheckCreateEntry],
			@AutoPostedEntry = [t].[AutoPostedEntry]			
	From
		[Secondary_Entry] [S]
		inner join [EntryType] [t] on [t].[Guid] = [s].[TypeGuid]
	where
		[s].[Guid] = @Guid

	if (@CheckCreateEntry = 0)
	return

	--
	Insert into [HEntry]	
	(
		[Guid],
		[Number],
		[SecLvl], 
		[Mark],
		[Date], 
		[CurrencyGuid], 
		[CurrencyVal], 
		[Note], 
		[ParentKind], 
		[UserGuid], 
		[BranchGuid], 
		[IsPosted]
	)
	Select
		[Guid],
		@EntryNum,
		[SecLvl],
		[Mark],
		[Date],
		[CurrencyGuid], 
		[CurrencyVal], 
		[Note], 
		8000 as [ParentKind], 
		[UserGuid], 
		[BranchGuid], 
		@AutoPostedEntry as [IsPosted]
	From
		[Secondary_Entry]
	where
		[Guid] = @Guid


	Declare @CurrencyVal Float,
			@CurrencyGuid uniqueidentifier,
			@Note varchar(256)
	Select 
			@CurrencyVal = [CurrencyVal],
			@CurrencyGuid = [CurrencyGuid],
			@Note = [Note]
	From 
		[Secondary_Entry]
	where 
		[Guid] = @Guid


	

	Declare
		@OpMoveCostwithDefAccount Bit,
		@OpEntryForOneItem Bit,
		@OpObverseNoteItem bit,
		@ObitemNotefromNote Bit
	
	Select
		@OpMoveCostwithDefAccount = [OpMoveCostwithDefAccount],
		@OpEntryForOneItem =  [OpEntryForOneItem],
		@OpObverseNoteItem =  [OpObverseNoteItem],
		@ObitemNotefromNote = [ObitemNotefromNote]
	From
		[EntryType] [T]
		inner join [Secondary_Entry] [S] on [T].[Guid] = [S].[TypeGuid]
	where
		[S].[Guid] = @Guid

	--  
	insert into [DEntry]
		([Number], [ParentGuid], [AcGuid], [Debit], [Credit], [CurrencyGuid], [CurrencyVal], [ObverseAcGuid], [CostGuid], [Note], [IsVisible])
	Select
		[Number], 
		@Guid as [ParentGuid], 
		[AcGuid], 
		[Debit], 
		[Credit], 
		[CurrencyGuid], 
		[CurrencyVal], 
		isNull((Select [AccountGuid] From [Secondary_Entry] where Guid = @Guid), [ObverseAcGuid]) as [ObverseAcGuid], 
		[CostGuid], 
		Case when @ObitemNotefromNote = 1 and [Note] = '' then @Note else [Note] end [Note], 
		--[Note],
		1 as [IsVisible]
	From
		[Secondary_EntryDetail]
	where
		[ParentGuid] = @Guid

	
	--  	
	--
	if IsNull((Select [AccountGuid] From [Secondary_Entry] where Guid = @Guid),0x0) <> 0x0
	insert into [DEntry]
		([Number], [ParentGuid], [AcGuid], [Debit], [Credit], [CurrencyGuid], [CurrencyVal], [ObverseAcGuid], [CostGuid], [Note], [IsVisible])
	Select
		Max([Number])+1, 
		@Guid as [ParentGuid], 
		(Select [AccountGuid] From [Secondary_Entry] where Guid = @Guid) as [AcGuid], 
		Case 
			 when @OpEntryForOneItem = 1 then 
			 Sum([Credit]) 
			 when @OpEntryForOneItem = 0 then 
			 Sum([Credit] * [CurrencyVal] / @CurrencyVal) 
		end as [Debit], --
		0 as [Credit], --
		@CurrencyGuid, 
		@CurrencyVal, 
		--Case when @OpEntryForOneItem = 1 then [AcGuid] else [ObverseAcGuid] end 
		Case when @OpEntryForOneItem = 1 then [AcGuid] end as [ObverseAcGuid], 
		Case when @OpMoveCostwithDefAccount = 1 then [CostGuid] end , 
		Case when @OpObverseNoteItem = 1 then [Note] else @Note end [Note], 
		1 as [IsVisible]
	From
		[Secondary_EntryDetail]
	where
		[ParentGuid] = @Guid
	Group By
		Case when @OpMoveCostwithDefAccount = 1 then [CostGuid] end,
		Case when @OpEntryForOneItem = 1 then [Number] else 0 end,
		Case when @OpEntryForOneItem = 1 then [AcGuid] end,
		Case when @OpEntryForOneItem = 1 then [Note] else '' end ,
		Case when @OpObverseNoteItem = 1 then [Note] else @Note end 
	
	
	--  	
	--
	if IsNull((Select [AccountGuid] From [Secondary_Entry] where Guid = @Guid),0x0) <> 0x0
	insert into [DEntry]
		([Number], [ParentGuid], [AcGuid], [Debit], [Credit], [CurrencyGuid], [CurrencyVal], [ObverseAcGuid], [CostGuid], [Note], [IsVisible])
	Select
		Max([Number])+1, 
		@Guid as [ParentGuid], 
		(Select [AccountGuid] From [Secondary_Entry] where Guid = @Guid) as [AcGuid], 
		0 as [Debit], --
		Case 
			 when @OpEntryForOneItem = 1 then 
			 Sum([Debit]) 
			 when @OpEntryForOneItem = 0 then 
			 Sum([Debit] * [CurrencyVal] / @CurrencyVal) 
		end as [Credit], --
		@CurrencyGuid, 
		@CurrencyVal, 
		--Case when @OpEntryForOneItem = 1 then [AcGuid] else [ObverseAcGuid]  end 
		Case when @OpEntryForOneItem = 1 then [AcGuid] end as [ObverseAcGuid],
		Case when @OpMoveCostwithDefAccount = 1 then [CostGuid] end , 
		Case when @OpObverseNoteItem = 1 then [Note] else @Note end [Note], 
		1 as [IsVisible]
	From
		[Secondary_EntryDetail]
	where
		[ParentGuid] = @Guid
	Group By
		Case when @OpMoveCostwithDefAccount = 1 then [CostGuid] end,
		Case when @OpEntryForOneItem = 1 then [Number] else 0 end,
		Case when @OpEntryForOneItem = 1 then [AcGuid] end,
		Case when @OpEntryForOneItem = 1 then [Note] else '' end ,
		Case when @OpObverseNoteItem = 1 then [Note] else @Note end


	Delete [DEntry] where ParentGuid = @Guid and (ISNULL(Debit, 0) + ISNULL(Credit, 0) = 0)
	Delete [DEntry] where ParentGuid = @Guid and AcGuid Is Null
	
	--  
	Create Table #TNumDEntry
	(
		[ID] int identity(1,1),
		[Guid] uniqueidentifier
	)
	
	Insert into #TNumDEntry
	([Guid])
	Select 
		[Guid]
	From
		[DEntry]
	where
		[ParentGuid] = @Guid
	Order By
		Case when [Debit] <> 0 then 0 else 1 end ,[Number]
	
	update [DEntry]
	Set Number = t.id
	From
		[DEntry] b
		inner join #TNumDEntry t on b.Guid = t.Guid
	where
		[b].[ParentGuid] = @Guid
		

		
	if @AutoPostedEntry = 1
	update HEntry set IsPosted = 1 where Guid = @Guid
	
	
	--   
	if isNull(@ContractGuid ,0x0) <> 0x0
	begin
		declare @Rs bit 
		Set @Rs = 0
		
		if @ContractKind = 0
		begin
			insert into [ContractCachPayment] ([ContractGuid], [EntryGuid])
			Select @ContractGuid, @Guid
		    
		    if exists(Select * from [ContractCachPayment] where [EntryGuid] = @Guid)
		    Set @Rs = 1
		end
		if @ContractKind = 1
		begin
			insert into [ContractParkingCachPayment] ([ContractGuid], [EntryGuid])
			Select @ContractGuid, @Guid

		    if exists(Select * from [ContractParkingCachPayment] where [EntryGuid] = @Guid)
		    Set @Rs = 1
		end
		if @ContractKind = 2
		begin
			insert into [LandContractCachPayment] ([ContractGuid], [EntryGuid])
			Select @ContractGuid, @Guid

		    if exists(Select * from [LandContractCachPayment] where [EntryGuid] = @Guid)
		    Set @Rs = 1
		end
		
		if @ContractKind = 3
		begin
			Insert into [ElectricityCachPayment] ([ContractGuid], [EntryGuid])
			Select @ContractGuid, @Guid

		    if exists(Select * from [ElectricityCachPayment] where [EntryGuid] = @Guid)
		    Set @Rs = 1
		end
		
		if @ContractKind = 4
		begin
			Insert into [ServicesContractCachPayment] ([ContractGuid], [EntryGuid])
			Select @ContractGuid, @Guid

		    if exists(Select * from [ServicesContractCachPayment] where [EntryGuid] = @Guid)
		    Set @Rs = 1
		end

		if @ContractKind = 5
		begin
			Insert into [MaintenanceContractCachPayment] ([ContractGuid], [EntryGuid])
			Select @ContractGuid, @Guid

		    if exists(Select * from [MaintenanceContractCachPayment] where [EntryGuid] = @Guid)
		    Set @Rs = 1
		end

		if @Rs = 0
		begin
			Declare @ENumber int
			Select
				@ENumber = Number
			From
				[Secondary_Entry]
			where
				[Guid] = @Guid
			
			Declare @Msg varchar(255)
			Set @Msg = dbo.SC('         ')+char(13)+dbo.SC(' ')+' : '+CAST(@ENumber AS varchar(15))
			RAISERROR (@Msg, 16, 1)
			
		end
	end
	
	--Select @AutoPostedEntry, IsPosted, * From Hentry where Guid = @Guid
	--Select * From Dentry where ParentGuid = @Guid


GO

SET ANSI_NULLS, QUOTED_IDENTIFIER ON
GO

Create Trigger [TRG_Trace_Shop]
on [Shop]
 
for update
As
	SET NOCOUNT ON;
	if Not exists(Select Value from DMD_const where vName = 'ActiveLogCardUpdate' and Value = '1' ) return
	
	Declare @UserGuid uniqueidentifier, @Guid uniqueidentifier
	Set @Guid = NEWID()
	
	Select Top 1 @UserGuid = userGuid From CurrentUsers where Spid = @@SPID
			
	insert into [Trace]
	([Guid],[ParentGuid],[Date],[userGuid],[HostName])
	Select Top 1
		@Guid,
		N.Guid,
		GETDATE(),
		@UserGuid,
		Host_Name()
	From
		[inserted] n 
		
	insert into [TraceDetail]
	([ParentGuid],[Caption],[Old],[New],[Tbl])
	Select Top 1
		@Guid,
		' ' as [Caption],
		D.[SecLvl] as [old],
		N.[SecLvl] as [New],
		''
	From
		[deleted] d
		inner join [inserted] n on D.Guid = N.Guid
	where
		N.[SecLvl] <> D.[SecLvl]
		
	insert into [TraceDetail]
	([ParentGuid],[Caption],[Old],[New],[Tbl])
	Select Top 1
		@Guid,
		'' as [Caption],
		D.[Ban] as [old],
		N.[Ban] as [New],
		''
	From
		[deleted] d
		inner join [inserted] n on D.Guid = N.Guid
	where
		N.[Ban] <> D.[Ban]

	insert into [TraceDetail]
	([ParentGuid],[Caption],[Old],[New],[Tbl])
	Select Top 1
		@Guid,
		'' as [Caption],
		D.[NO] as [old],
		N.[NO] as [New],
		''
	From
		[deleted] d
		inner join [inserted] n on D.Guid = N.Guid
	where
		N.[NO] <> D.[NO]
		
	insert into [TraceDetail]
	([ParentGuid],[Caption],[Old],[New],[Tbl])
	Select Top 1
		@Guid,
		'  ' as [Caption],
		D.[Judicial] as [old],
		N.[Judicial] as [New],
		''
	From
		[deleted] d
		inner join [inserted] n on D.Guid = N.Guid
	where
		N.[Judicial] <> D.[Judicial]
		
	insert into [TraceDetail]
	([ParentGuid],[Caption],[Old],[New],[Tbl])
	Select Top 1
		@Guid,
		'' as [Caption],
		D.[BuildingGuid] as [old],
		N.[BuildingGuid] as [New],
		'[Building]'
	From
		[deleted] d
		inner join [inserted] n on D.Guid = N.Guid
	where
		N.[BuildingGuid] <> D.[BuildingGuid]
		
	insert into [TraceDetail]
	([ParentGuid],[Caption],[Old],[New],[Tbl])
	Select Top 1
		@Guid,
		'' as [Caption],
		D.[Area] as [old],
		N.[Area] as [New],
		''
	From
		[deleted] d
		inner join [inserted] n on D.Guid = N.Guid
	where
		N.[Area] <> D.[Area]
		
	insert into [TraceDetail]
	([ParentGuid],[Caption],[Old],[New],[Tbl])
	Select Top 1
		@Guid,
		'' as [Caption],
		D.[Unity] as [old],
		N.[Unity] as [New],
		''
	From
		[deleted] d
		inner join [inserted] n on D.Guid = N.Guid
	where
		N.[Unity] <> D.[Unity]
		
	insert into [TraceDetail]
	([ParentGuid],[Caption],[Old],[New],[Tbl])
	Select Top 1
		@Guid,
		' ' as [Caption],
		D.[ShopKind] as [old],
		N.[ShopKind] as [New],
		''
	From
		[deleted] d
		inner join [inserted] n on D.Guid = N.Guid
	where
		N.[ShopKind] <> D.[ShopKind]
		
	insert into [TraceDetail]
	([ParentGuid],[Caption],[Old],[New],[Tbl])
	Select Top 1
		@Guid,
		'' as [Caption],
		D.[Description] as [old],
		N.[Description] as [New],
		''
	From
		[deleted] d
		inner join [inserted] n on D.Guid = N.Guid
	where
		N.[Description] <> D.[Description]
		
	insert into [TraceDetail]
	([ParentGuid],[Caption],[Old],[New],[Tbl])
	Select Top 1
		@Guid,
		'' as [Caption],
		D.[Overlooking] as [old],
		N.[Overlooking] as [New],
		''
	From
		[deleted] d
		inner join [inserted] n on D.Guid = N.Guid
	where
		N.[Overlooking] <> D.[Overlooking]
		
	insert into [TraceDetail]
	([ParentGuid],[Caption],[Old],[New],[Tbl])
	Select Top 1
		@Guid,
		' ' as [Caption],
		D.[CostPrice] as [old],
		N.[CostPrice] as [New],
		''
	From
		[deleted] d
		inner join [inserted] n on D.Guid = N.Guid
	where
		N.[CostPrice] <> D.[CostPrice]
		
	insert into [TraceDetail]
	([ParentGuid],[Caption],[Old],[New],[Tbl])
	Select Top 1
		@Guid,
		'' as [Caption],
		D.[CostCurrencyGUID] as [old],
		N.[CostCurrencyGUID] as [New],
		'Currency'
	From
		[deleted] d
		inner join [inserted] n on D.Guid = N.Guid
	where
		N.[CostCurrencyGUID] <> D.[CostCurrencyGUID]
		
	insert into [TraceDetail]
	([ParentGuid],[Caption],[Old],[New],[Tbl])
	Select Top 1
		@Guid,
		' ' as [Caption],
		D.[Rent] as [old],
		N.[Rent] as [New],
		''
	From
		[deleted] d
		inner join [inserted] n on D.Guid = N.Guid
	where
		N.[Rent] <> D.[Rent]
		
	insert into [TraceDetail]
	([ParentGuid],[Caption],[Old],[New],[Tbl])
	Select Top 1
		@Guid,
		' ' as [Caption],
		D.[RentCurrencyGUID] as [old],
		N.[RentCurrencyGUID] as [New],
		'Currency'
	From
		[deleted] d
		inner join [inserted] n on D.Guid = N.Guid
	where
		N.[RentCurrencyGUID] <> D.[RentCurrencyGUID]
		
	insert into [TraceDetail]
	([ParentGuid],[Caption],[Old],[New],[Tbl])
	Select Top 1
		@Guid,
		' ' as [Caption],
		D.[Sale] as [old],
		N.[Sale] as [New],
		''
	From
		[deleted] d
		inner join [inserted] n on D.Guid = N.Guid
	where
		N.[Sale] <> D.[Sale]
		
	insert into [TraceDetail]
	([ParentGuid],[Caption],[Old],[New],[Tbl])
	Select Top 1
		@Guid,
		'  ' as [Caption],
		D.[SaleCurrencyGUID] as [old],
		N.[SaleCurrencyGUID] as [New],
		''
	From
		[deleted] d
		inner join [inserted] n on D.Guid = N.Guid
	where
		N.[SaleCurrencyGUID] <> D.[SaleCurrencyGUID]
		
	insert into [TraceDetail]
	([ParentGuid],[Caption],[Old],[New],[Tbl])
	Select Top 1
		@Guid,
		'' as [Caption],
		D.[Note] as [old],
		N.[Note] as [New],
		''
	From
		[deleted] d
		inner join [inserted] n on D.Guid = N.Guid
	where
		N.[Note] <> D.[Note]
		
	insert into [TraceDetail]
	([ParentGuid],[Caption],[Old],[New],[Tbl])
	Select Top 1
		@Guid,
		' ' as [Caption],
		D.[CostGuid] as [old],
		N.[CostGuid] as [New],
		'[Cost]'
	From
		[deleted] d
		inner join [inserted] n on D.Guid = N.Guid
	where
		N.[CostGuid] <> D.[CostGuid]
		
	insert into [TraceDetail]
	([ParentGuid],[Caption],[Old],[New],[Tbl])
	Select Top 1
		@Guid,
		'' as [Caption],
		D.[FlatOwner] as [old],
		N.[FlatOwner] as [New],
		''
	From
		[deleted] d
		inner join [inserted] n on D.Guid = N.Guid
	where
		N.[FlatOwner] <> D.[FlatOwner]
		
	insert into [TraceDetail]
	([ParentGuid],[Caption],[Old],[New],[Tbl])
	Select Top 1
		@Guid,
		'' as [Caption],
		D.[CustGuid] as [old],
		N.[CustGuid] as [New],
		'Customer'
	From
		[deleted] d
		inner join [inserted] n on D.Guid = N.Guid
	where
		N.[CustGuid] <> D.[CustGuid]
		
	insert into [TraceDetail]
	([ParentGuid],[Caption],[Old],[New],[Tbl])
	Select Top 1
		@Guid,
		'' as [Caption],
		D.[Details] as [old],
		N.[Details] as [New],
		''
	From
		[deleted] d
		inner join [inserted] n on D.Guid = N.Guid
	where
		N.[Details] <> D.[Details]
		
	insert into [TraceDetail]
	([ParentGuid],[Caption],[Old],[New],[Tbl])
	Select Top 1
		@Guid,
		' ' as [Caption],
		D.[OfferState] as [old],
		N.[OfferState] as [New],
		''
	From
		[deleted] d
		inner join [inserted] n on D.Guid = N.Guid
	where
		N.[OfferState] <> D.[OfferState]
		
	insert into [TraceDetail]
	([ParentGuid],[Caption],[Old],[New],[Tbl])
	Select Top 1
		@Guid,
		' ' as [Caption],
		D.[OfferType] as [old],
		N.[OfferType] as [New],
		''
	From
		[deleted] d
		inner join [inserted] n on D.Guid = N.Guid
	where
		N.[OfferType] <> D.[OfferType]
		
	insert into [TraceDetail]
	([ParentGuid],[Caption],[Old],[New],[Tbl])
	Select Top 1
		@Guid,
		'' as [Caption],
		D.[Restrained] as [old],
		N.[Restrained] as [New],
		''
	From
		[deleted] d
		inner join [inserted] n on D.Guid = N.Guid
	where
		N.[Restrained] <> D.[Restrained]
		
	insert into [TraceDetail]
	([ParentGuid],[Caption],[Old],[New],[Tbl])
	Select Top 1
		@Guid,
		' ' as [Caption],
		D.[RestrainedUserGuid] as [old],
		N.[RestrainedUserGuid] as [New],
		''
	From
		[deleted] d
		inner join [inserted] n on D.Guid = N.Guid
	where
		N.[RestrainedUserGuid] <> D.[RestrainedUserGuid]
		
	insert into [TraceDetail]
	([ParentGuid],[Caption],[Old],[New],[Tbl])
	Select Top 1
		@Guid,
		'  ' as [Caption],
		D.[WaterCounter] as [old],
		N.[WaterCounter] as [New],
		''
	From
		[deleted] d
		inner join [inserted] n on D.Guid = N.Guid
	where
		N.[WaterCounter] <> D.[WaterCounter]
		
	insert into [TraceDetail]
	([ParentGuid],[Caption],[Old],[New],[Tbl])
	Select Top 1
		@Guid,
		'  ' as [Caption],
		D.[ElectricityCounter] as [old],
		N.[ElectricityCounter] as [New],
		''
	From
		[deleted] d
		inner join [inserted] n on D.Guid = N.Guid
	where
		N.[ElectricityCounter] <> D.[ElectricityCounter]
		
	insert into [TraceDetail]
	([ParentGuid],[Caption],[Old],[New],[Tbl])
	Select Top 1
		@Guid,
		' ' as [Caption],
		D.[LtnShopKind] as [old],
		N.[LtnShopKind] as [New],
		''
	From
		[deleted] d
		inner join [inserted] n on D.Guid = N.Guid
	where
		N.[LtnShopKind] <> D.[LtnShopKind]
		
	insert into [TraceDetail]
	([ParentGuid],[Caption],[Old],[New],[Tbl])
	Select Top 1
		@Guid,
		'' as [Caption],
		D.[LtnDescription] as [old],
		N.[LtnDescription] as [New],
		''
	From
		[deleted] d
		inner join [inserted] n on D.Guid = N.Guid
	where
		N.[LtnDescription] <> D.[LtnDescription]
		
	insert into [TraceDetail]
	([ParentGuid],[Caption],[Old],[New],[Tbl])
	Select Top 1
		@Guid,
		'' as [Caption],
		D.[LtnOverlooking] as [old],
		N.[LtnOverlooking] as [New],
		''
	From
		[deleted] d
		inner join [inserted] n on D.Guid = N.Guid
	where
		N.[LtnOverlooking] <> D.[LtnOverlooking]
		
	insert into [TraceDetail]
	([ParentGuid],[Caption],[Old],[New],[Tbl])
	Select Top 1
		@Guid,
		'' as [Caption],
		D.[Class] as [old],
		N.[Class] as [New],
		''
	From
		[deleted] d
		inner join [inserted] n on D.Guid = N.Guid
	where
		N.[Class] <> D.[Class]
		
	delete Trace From Trace t left join [TraceDetail] D on T.guid = D.ParentGuid
	where
		d.ParentGuid is Null and t.Guid = @Guid


GO

SET ANSI_NULLS, QUOTED_IDENTIFIER ON
GO

Create Procedure [PrcContractList]
(
	@CustGuid uniqueidentifier = 0x0
	,@Nationality Varchar(256) = ''
	,@Purpose Varchar(256) = ''
	,@Emirate Varchar(256) = ''
	,@Suburb Varchar(256) = ''
	,@Area Varchar(256) = ''
	,@Street Varchar(256) = ''
	,@FlatKind Varchar(256) = ''
	,@ApartmentType Varchar(256) = ''
	,@ContractState int = 1
	,@Judicial int = 2
	,@LawsuitState int = 2
	,@PayType int = 4
	,@Datewith int = 0
	,@Date1 DateTime = '12/30/1899'
	,@Date2 DateTime = '12/30/2016'
	,@IncomeActiveDate bit = 0
	,@IncomeDate1 datetime = '1/1/2016'
	,@IncomeDate2 datetime = '1/1/2017'
	,@RentInfoGuid uniqueidentifier = 0x0
	,@SalesManGuid uniqueidentifier = 0x0
	,@ShowIsCheck Bit = 1
	,@ShowIsNotCheck Bit = 1
	,@CKDate Bit = 0
	,@EndState int = 2
	,@NewState int = 2
	,@Mark Bit = 1
	,@NotMark Bit = 1
	,@AutoRenewal int = 1
	,@AcquittancePrinted int = 2
	,@AcquittancePrintedByUserGuid uniqueidentifier = 0x0
	,@LinkCheck int = 2
	,@FldCurrentContract bit = 1
	,@BanRealty int = 0
	,@whereabouts varchar(255) = ''
	,@Trademark varchar(255) = ''
	,@FinishDate int = 3
	,@ContractValue int = 2
)
 
as
	Set noCount on

	Declare @Msg varchar(255),
			@MsgConst varchar(255)
	Set @MsgConst = dbo.SC(' ')
			
	Set @Msg = @MsgConst
	exec PrcSetProgrss @Msg, 100, 0

	Declare @Tbl Table
	(
		[ContractNo] Varchar(256)
		,[FlatNo] Varchar(256)
		,[BuildingName] Varchar(256)
		,[Value] Float
		,[Discount] Float
		,[ValueAfterDiscount] Float
		,[FlatKind] Varchar(256)
		,[FlatType] Varchar(256)
		,[FlatArea] Varchar(256)
		,[ContractState] Varchar(256)
		,[Emirate] Varchar(256)
		,[Suburb] Varchar(256)
		,[Area] Varchar(256)
		,[Street] Varchar(256)
		,[FloorNo] Varchar(256)
		,[CustName] Varchar(256)
		,[CustPhone] Varchar(256)
		,[CustNationality] Varchar(256)
		,[CustEMail] Varchar(256)
		,[ContractDateEdit] Datetime
		,[ContractDeliverDate] Datetime
		,[ContractDateBegin] Datetime
		,[ContractDateEnd] Datetime
		,[ContractType] Varchar(256)
		,[ContractFinish] Bit
		,[ContractGuid] uniqueidentifier
		,[NewState] int

		,[RentMan] Varchar(256)
		,[SalesMan] Varchar(256)
		,[ContractFinishDate] Datetime
		,[ResultingAmount] Float
		,[ResultingAmount2] Float
		,[Fine] Float
		,[TotalIncom] Float
		,[InsuranceValueOld] Float
		,[InsuranceValue] Float
		,[TotalInsuranse] Float
		,[RentCleanValue] Float
		,[Note2] Varchar(1000)
		,[Purpose] Varchar(256)
		,Trademark Varchar(256)
		
		,[CountOldContract] int
		,[CountCurrentContract] int
		
		,[AcquittancePrinted] Bit
		,[AcquittancePrintdate] Datetime
		,[AcquittancePrintedBy] Varchar(256)
		,[CostGuid] uniqueidentifier
		,[AccountGuid] uniqueidentifier
		,[Judicial] Bit
		,[Mark] Bit
		,[isAutoRenewal] Bit
		,[PrvContractFinishDate] Datetime
		,[PrvContractEndDate] Datetime
		,[Kind] Int
		,[Sort] int
	)

	Declare  @Now_Date Datetime
	Set @Now_Date = GetDate()
	
	--  
	Create Table #CurrentContract
	(
		CustomerGuid uniqueidentifier,
		ApartmentGuid uniqueidentifier,
		[ContractCount] int
	)
	
	if @FldCurrentContract = 1
	begin
		insert into #CurrentContract
		Select 
			CustomerGuid,
			ApartmentGuid,
			IsNull(COUNT(*),0) as [ContractCount]
		From 
			[LeaseApartment]
		Group By
			CustomerGuid,
			ApartmentGuid
	end

	Set @Msg = @MsgConst
	exec PrcSetProgrss @Msg, 100, 5
	
	--Building
	Select
		*
	Into #Building_CL
	From
		[vwBuilding] B
	where
		([B].[Emirate] = @Emirate or @Emirate = '')
		and ([B].[Suburb] = @Suburb or @Suburb = '')
		and ([B].[Area] = @Area or @Area = '')
		and ([B].[Street] = @Street or @Street = '')
		
	Set @Msg = @MsgConst
	exec PrcSetProgrss @Msg, 100, 7
		
    select Distinct
		ContractKind
	into #Resource_Type
	From
		ContractType T
		inner join [Resource] [R2] on [R2].[Guid] = [T].[Guid]  and [R2].[Kind] = 100 and [R2].[spid] = @@Spid 
		
	--Select * from #Building_CL
	--return
		

	--Select * from #Building_CL
		
	--[vwLeaseApartment]
	Declare @p_RentFlat bit,
			@p_RentShop bit,
			@p_SaleFlat bit,
			@p_SaleShop bit,
			@p_RentParking bit,
			@p_SaleParking bit,
			@p_SaleLand bit,
			@p_RentLand bit,
			@p_SaleVilla bit,
			@p_RentVilla bit
			
	if exists(Select * From #Resource_Type where ContractKind = 0)
	Set @p_RentFlat = 1 else Set @p_RentFlat = 0
	
	if exists(Select * From #Resource_Type where ContractKind = 1)
	Set @p_RentShop = 1 else Set @p_RentShop = 0 

	if exists(Select * From #Resource_Type where ContractKind = 2)
	Set @p_SaleFlat = 1 else Set @p_SaleFlat = 0 

	if exists(Select * From #Resource_Type where ContractKind = 3)
	Set @p_SaleShop = 1 else Set @p_SaleShop = 0 

	if exists(Select * From #Resource_Type where ContractKind = 4)
	Set @p_RentParking = 1 else Set @p_RentParking = 0 

	if exists(Select * From #Resource_Type where ContractKind = 5)
	Set @p_SaleParking = 1 else Set @p_SaleParking = 0 

	if exists(Select * From #Resource_Type where ContractKind = 6)
	Set @p_SaleLand = 1 else Set @p_SaleLand = 0 

	if exists(Select * From #Resource_Type where ContractKind = 7)
	Set @p_RentLand = 1 else Set @p_RentLand = 0 

	if exists(Select * From #Resource_Type where ContractKind = 8)
	Set @p_SaleVilla = 1 else Set @p_SaleVilla = 0 

	if exists(Select * From #Resource_Type where ContractKind = 9)
	Set @p_RentVilla = 1 else Set @p_RentVilla = 0 
	
	Select
		L.*
		,T.Name as ContractName
		,[L].[Judicial] as [ContractJudicial]
		,(Select [ContractFinishDate] from [LeaseApartment] where Guid = L.[PrvContractGuid]) as [PrvContractFinishDate]
		,(Select [ToDate] from [LeaseApartment] where Guid = L.[PrvContractGuid]) as [PrvContractEndDate]
		,U.LoginName as [AcquittancePrintedBy]
		,S.Name as [SalesMan]
	into #LeaseApartment_CL
	From
		[LeaseApartment] L
		inner join ContractType T on T.Guid = L.TypeGuid
		inner join [Resource] [R2] on [R2].[Guid] = [L].[TypeGuid]  and [R2].[Kind] = 100 and [R2].[spid] = @@Spid 
		left join [Realty_Users] U on U.[Guid] = L.AcquittancePrintedByGuid
		left join Salesman S on S.Guid = L.SalesManGuid
		left join [Lawsuit] W on W.ContractGuid = L.Guid
	where
		([L].[CustomerGuid] = @CustGuid or @CustGuid = 0x0)
		and ([L].[RentInfoGuid] = @RentInfoGuid or @RentInfoGuid = 0x0)
		and ([L].[SalesManGuid] = @SalesManGuid or @SalesManGuid = 0x0)
		and ([L].[ContractFinish] = @EndState or @EndState = 2)
		and (
				([l].[Mark] = 1 and @Mark = 1)
				or ([l].[Mark] = 0 and @NotMark = 1)
			)
		and (L.PayType = @PayType or @PayType  = 4)
		
		and (
				(
					Case when ( isNull([L].[Judicial],0) = 1) or (W.Guid is Not Null ) then 1 else 0 end					
					= @Judicial					
				)
				and (
						(W.IsEnded = 1 and @LawsuitState = 0)
						or (W.IsEnded = 0 and @LawsuitState = 1)
						or @LawsuitState = 2
					)
			or @Judicial = 2)

		
		and (L.Purpose = @Purpose or @Purpose = '')
		and (L.Trademark = @Trademark or @Trademark = '')
		and (L.AcquittancePrintedByGuid = @AcquittancePrintedByUserGuid or @AcquittancePrintedByUserGuid = 0x0)
		
		and (@p_RentFlat = 1 or @p_RentShop = 1 or @p_SaleFlat = 1 or @p_SaleShop = 1)
		and (L.isAutoRenewal = @AutoRenewal or @AutoRenewal = 2)
		and (L.whereabouts = @whereabouts or @whereabouts = '')
		and (
				(
					(
					([ContractFinishDate] < [ToDate] and @FinishDate = 0) or
					([ContractFinishDate] > [ToDate] and @FinishDate = 1) or
					([ContractFinishDate] = [ToDate] and @FinishDate = 2) 
					)
				and [ContractFinish] = 1
				)
				or @FinishDate = 3
			)
		and (
				(([L].Rent - [L].DiscountValue) <> 0 and @ContractValue = 0) or
				(([L].Rent - [L].DiscountValue) = 0 and @ContractValue = 1) or
				@ContractValue = 2
			)
	
	Set @Msg = @MsgConst
	exec PrcSetProgrss @Msg, 100, 10

	Select * into #LeaseApartment_Rent from #LeaseApartment_CL L
	where
			(
				((([L].[ToDate] <= @Now_Date) or ([L].[ContractFinish] = 1)) and @ContractState = 0)
			  	or ([L].[ToDate] > @Now_Date and @ContractState = 1)
				or @ContractState = 2
			)		
			and (
				(
					([L].[FromDate] >= @Date1 and @Datewith  = 0)
					and ([L].[FromDate] <= @Date2 and @Datewith  = 0 or @Date2 = '12/30/1899')
				)
				or
				(
					([L].[ToDate] >= @Date1 and @Datewith  = 1)
					and ([L].[ToDate] <= @Date2 and @Datewith  = 1 or @Date2 = '12/30/1899')
				)

				or
				(
					([L].[ContractFinishDate] >= @Date1 and @Datewith  = 2)
					and ([L].[ContractFinishDate] <= @Date2 and @Datewith  = 2 or @Date2 = '12/30/1899')
					and ([L].[ContractFinish] = 1)
				)

				or
				(
					([L].[EditDate] >= @Date1 and @Datewith  = 3)
					and ([L].[EditDate] <= @Date2 and @Datewith  = 3 or @Date2 = '12/30/1899')
				)
				or
				(
					([L].[AcquittancePrintdate] >= @Date1 and @Datewith  = 4)
					and ([L].[AcquittancePrintdate] <= @Date2 and @Datewith  = 4 or @Date2 = '12/30/1899')
				)

				or
				(
					([L].LeaveDate >= @Date1 and @Datewith  = 5)
					and ([L].LeaveDate <= @Date2 and @Datewith  = 5 or @Date2 = '12/30/1899')
				)
				or
				(
					([L].DeliverDate >= @Date1 and @Datewith  = 6)
					and ([L].DeliverDate <= @Date2 and @Datewith  = 6 or @Date2 = '12/30/1899')
				)
				or @CKDate = 0
			) 
		and (L.AcquittancePrinted = @AcquittancePrinted or @AcquittancePrinted = 2)			

	Set @Msg = @MsgConst
	exec PrcSetProgrss @Msg, 100, 12

	--Select * from #LeaseApartment_CL
	-- 	
	Select * into #RentInfo_CL from [RentInfo] where Guid = @RentInfoGuid or @RentInfoGuid = 0x0
	
	Set @Msg = @MsgConst
	exec PrcSetProgrss @Msg, 100, 15

	--Customer 
	Select
		*
	into #Customer
	From
		vwCustomer
	where
		([Guid] = @CustGuid or @CustGuid = 0x0)
		and ([Nationality] = @Nationality or @Nationality = '')
		
	Set @Msg = @MsgConst +' '+ dbo.SC(' ')
	exec PrcSetProgrss @Msg, 100, 35
    
   --Select * from #LeaseApartment_CL where [ContractJudicial] = 1
    
	-- 	
	if @p_RentFlat = 1
	Insert into @Tbl 
	Select 
		[L].[ContractNo]
		,[A].[No] as [FlatNo]
		,[B].[Name] as [BuildingName]
		,[L].[Rent]
		,[L].[DiscountValue]
		,[L].[Rent] - [L].[DiscountValue]
		,[A].[FlatKind] as [FlatKind]
		,[A].[ApartmentType] as [FlatType]
		,[A].[Area] as [FlatArea]
		,Case when ([L].[ToDate] <= @Now_Date) or ([L].[ContractFinish] = 1) then dbo.sc(' ')  
			  when [L].[ToDate] > @Now_Date then dbo.sc('  ') end as [ContractState]
		,[B].[Emirate] as [Emirate]
		,[B].[Suburb] as [Suburb]
		,[B].[Area] as [Area]
		,[B].[Street] as [Street]
		,[A].[FloorNo]
		,[Cu].[Name] as [CustName]
		,[Cu].[Mobile] as [CustPhone]
		,[Cu].Nationality
		,Cu.EMail as CustEMail
		,[L].[EditDate] as [ContractDateEdit]
		,[L].[DeliverDate] as [ContractDeliverDate]
		,[L].[FromDate] as [ContractDateBegin]
		,[L].[ToDate] as [ContractDateEnd]
		,[L].[ContractName]
		,[L].[ContractFinish]
		,[L].[Guid] as [ContractGuid]
		,[L].[NewState] 

		,[I].[Name]	
		,L.[SalesMan]
		,[ContractFinishDate]
		,[ResultingAmount]
		,[ResultingAmount2]
		,[Fine]
		,[ResultingAmount2] + [Fine] + [OtherFee]
		,[InsuranceValueOld]
		,[InsuranceValue]
		,[InsuranceValueOld] + [InsuranceValue]
		,[ResultingAmount] + [InsuranceValueOld] + [InsuranceValue] - [Fine] as [RentCleanValue]
		,[Note2] 
		,L.[Purpose]
		,L.Trademark
		,l.[CountOldContract]
		,(Select [ContractCount] From #CurrentContract where L.CustomerGuid = CustomerGuid and [L].ApartmentGuid = ApartmentGuid)as [CurrentContract]
		,l.AcquittancePrinted
		,L.AcquittancePrintDate
		,L.[AcquittancePrintedBy]
		,[L].[CostGuid]
		,L.[CustAccountGuid]
		,L.[ContractJudicial]
		,[L].[Mark]
		,[L].[isAutoRenewal]
		,L.[PrvContractFinishDate]
		,L.[PrvContractEndDate]

		,0 as [Kind]
		,0 as [Sort]
	from 
		#Building_CL [B]
		Inner join [vbApartment] [A] On [A].[BuildingGuid] = [B].[Guid]
		Inner join #LeaseApartment_Rent [L] On [A].[Guid] = [L].[ApartmentGuid] and [LeaseKind]  = 0
		inner join [Resource] [R] on [R].[Guid] = [B].[Guid]  and [R].[Kind] = 101 and [R].[spid] = @@Spid 
		--inner join [vwContractType] [T] on [T].[Guid] = [L].[TypeGuid]  
		--inner join [Resource] [R2] on [R2].[Guid] = [T].[Guid]  and [R2].[Kind] = 100 and [R2].[spid] = @@Spid 
		Inner join [#Customer] [Cu] on [Cu].[Guid] = [L].[CustomerGuid] 
		left join #RentInfo_CL [I] on [I].[Guid] = [L].[RentInfoGuid]
	where
		([A].[FlatKind] = @FlatKind or @FlatKind = '')
		and ([A].[ApartmentType] = @ApartmentType or @ApartmentType = '')
		and (A.Ban = @banRealty or @banRealty = 2)
		
	Set @Msg = @MsgConst +' '+ dbo.SC(' ')
	exec PrcSetProgrss @Msg, 100, 40

	-- 	
	if @p_RentShop = 1
	Insert into @Tbl 
	Select 
		[L].[ContractNo]
		,[A].[No] as [FlatNo]
		,[B].[Name] as [BuildingName]
		,[L].[Rent]
		,[L].[DiscountValue]
		,[L].[Rent] - [L].[DiscountValue]
		,[ShopKind] as [FlatKind]
		,A.[Description] as [FlatType]
		,[A].[Area] as [FlatArea]
		,Case when ([L].[ToDate] <= GetDate()) or ([L].[ContractFinish] = 1) then dbo.sc(' ')  
			  when [L].[ToDate] > GetDate() then dbo.sc('  ') end as [ContractState]
		,[B].[Emirate] as [Emirate]
		,[B].[Suburb] as [Suburb]
		,[B].[Area] as [Area]
		,[B].[Street] as [Street]
		,'' as [FloorNo]
		,[Cu].[Name] as [CustName]
		,[Cu].[Mobile] as [CustPhone]
		,[Cu].Nationality
		,Cu.EMail as CustEMail
		,[L].[EditDate] as [ContractDateEdit]
		,[L].[DeliverDate] as [ContractDeliverDate]
		,[L].[FromDate] as [ContractDateBegin]
		,[L].[ToDate]as [ContractDateEnd]
		,[L].[ContractName]
		,[L].[ContractFinish]
		,[L].[Guid] as [ContractGuid]
		,[L].[NewState] 

		,[I].[Name]	
		,L.[SalesMan]
		,[ContractFinishDate]
		,[ResultingAmount]
		,[ResultingAmount2]
		,[Fine]
		,[ResultingAmount2] + [Fine] + [OtherFee]
		,[InsuranceValueOld]
		,[InsuranceValue]
		,[InsuranceValueOld] + [InsuranceValue]
		,[ResultingAmount] + [InsuranceValueOld] + [InsuranceValue] - [Fine]
		,Left([L].[Note2],255)
		,L.[Purpose]
		,L.Trademark
		,L.[CountOldContract]
		,(Select [ContractCount] From #CurrentContract where L.CustomerGuid = CustomerGuid and [L].ApartmentGuid = ApartmentGuid)as [CurrentContract]
		,l.[AcquittancePrinted]
		,L.AcquittancePrintDate
		,L.[AcquittancePrintedBy]
		,[L].[CostGuid]
		,L.[CustAccountGuid]
		,L.[ContractJudicial]
		,[L].[mark]
		,[L].[isAutoRenewal]
		,L.[PrvContractFinishDate]
		,l.[PrvContractEndDate]
		,1 as [Kind]
		,0 as [Sort]
	from 
		#Building_CL [B]
		Inner join [vwShopall] [A] On [A].[BuildingGuid] = [B].[Guid]
		inner join #LeaseApartment_Rent [L] On [A].[Guid] = [L].[ApartmentGuid] and [LeaseKind]  = 1
		Inner join [Resource] [R] on [R].[Guid] = [B].[Guid]  and [R].[Kind] = 101 and [R].[spid] = @@Spid 
		--inner  join [vwContractType] [T] on [T].[Guid] = [L].[TypeGuid]  
		--Inner join [Resource] [R2] on [R2].[Guid] = [T].[Guid]  and [R2].[Kind] = 100 and [R2].[spid] = @@Spid 
		inner  join [#Customer] [Cu] on [Cu].[Guid] = [L].[CustomerGuid] 
		left  join #RentInfo_CL [I] on [I].[Guid] = [L].[RentInfoGuid]
		and (A.Ban = @banRealty or @banRealty = 2)

	Set @Msg = @MsgConst +' '+ dbo.SC(' ')
	exec PrcSetProgrss @Msg, 100, 40

	-- 
	if @p_SaleFlat = 1
	Insert into @Tbl 
	Select 
		[L].[ContractNo]
		,[A].[No] as [FlatNo]
		,[B].[Name] as [BuildingName]
		,[L].[Rent]
		,[L].[DiscountValue]
		,[L].[Rent] - [L].[DiscountValue]
		,[A].[FlatKind] as [FlatKind]
		,[A].[ApartmentType] as [FlatType]
		,[A].[Area] as [FlatArea]
		,Case when ([L].[ToDate] <= GetDate()) or ([L].[ContractFinish] = 1) then dbo.sc(' ')  
			  when [L].[ToDate] > GetDate() then dbo.sc('  ') end as [ContractState]
		,[B].[Emirate] as [Emirate]
		,[B].[Suburb] as [Suburb]
		,[B].[Area] as [Area]
		,[B].[Street] as [Street]
		,[A].[FloorNo]
		,[Cu].[Name] as [CustName]
		,[Cu].[Mobile] as [CustPhone]
		,[Cu].[Nationality]
		,Cu.EMail as CustEMail
		,[L].[EditDate] as [ContractDateEdit]
		,[L].[DeliverDate] as [ContractDeliverDate]
		,[L].[FromDate] as [ContractDateBegin]
		,[L].[ToDate]as [ContractDateEnd]
		,[L].[ContractName]
		,Null as [ContractFinish]
		,[L].[Guid] as [ContractGuid]
		,-1 as [NewState] 

		,[I].[Name]	
		,L.[SalesMan]
		,[ContractFinishDate]
		,[ResultingAmount]
		,[ResultingAmount2]
		,[Fine]
		,[ResultingAmount2] + [Fine] + [OtherFee]
		,[InsuranceValueOld]
		,[InsuranceValue]
		,[InsuranceValueOld] + [InsuranceValue]
		,[ResultingAmount] + [InsuranceValueOld] + [InsuranceValue] - [Fine]
		,[Note2] 
		,L.[Purpose]
		,L.Trademark
		,L.[CountOldContract]
		,(Select [ContractCount] From #CurrentContract where L.CustomerGuid = CustomerGuid and [L].ApartmentGuid = ApartmentGuid)as [CurrentContract]
		,l.[AcquittancePrinted]
		,L.AcquittancePrintDate
		,L.[AcquittancePrintedBy]
		,[L].[CostGuid]
		,L.[CustAccountGuid]
		,L.[ContractJudicial]
		,[L].[Mark]
		,[L].[isAutoRenewal]
		,L.[PrvContractFinishDate]
		,L.[PrvContractEndDate]
		,2 as [Kind]
		,0 as [Sort]
	from 
		#Building_CL [B]
		Inner join [vwApartmentall] [A] On [A].[BuildingGuid] = [B].[Guid]
		Inner join #LeaseApartment_CL [L] On [A].[Guid] = [L].[ApartmentGuid] and [LeaseKind]  = 2
		Inner join [Resource] [R] on [R].[Guid] = [B].[Guid]  and [R].[Kind] = 101 and [R].[spid] = @@Spid 
		--inner join [vwContractType] [T] on [T].[Guid] = [L].[TypeGuid]  
		--Inner join [Resource] [R2] on [R2].[Guid] = [T].[Guid]  and [R2].[Kind] = 100 and [R2].[spid] = @@Spid 
		Inner join [#Customer] [Cu] on [Cu].[Guid] = [L].[CustomerGuid] 
		left join #RentInfo_CL [I] on [I].[Guid] = [L].[RentInfoGuid]
	where
		([A].[FlatKind] = @FlatKind or @FlatKind = '')
		and ([A].[ApartmentType] = @ApartmentType or @ApartmentType = '')
		and (
				(
					([L].[FromDate] >= @Date1 and @Datewith  = 0)
					and ([L].[FromDate] <= @Date2 and @Datewith  = 0 or @Date2 = '12/30/1899')
					
				)
				
				or
				(
					([L].[EditDate] >= @Date1 and @Datewith  = 3)
					and ([L].[EditDate] <= @Date2 and @Datewith  = 3 or @Date2 = '12/30/1899')
				)
				or
				(
					([L].[AcquittancePrintdate] >= @Date1 and @Datewith  = 4)
					and ([L].[AcquittancePrintdate] <= @Date2 and @Datewith  = 4 or @Date2 = '12/30/1899')
				)
				
				or
				(
					([L].LeaveDate >= @Date1 and @Datewith  = 5)
					and ([L].LeaveDate <= @Date2 and @Datewith  = 5 or @Date2 = '12/30/1899')
				)

				or
				(
					([L].DeliverDate >= @Date1 and @Datewith  = 6)
					and ([L].DeliverDate <= @Date2 and @Datewith  = 6 or @Date2 = '12/30/1899')
				)

				or @CKDate = 0
			) 
		and (@EndState = 2)
		and (L.AcquittancePrinted = @AcquittancePrinted or @AcquittancePrinted = 2)
		and (A.Ban = @banRealty or @banRealty = 2)

	Set @Msg = @MsgConst +' '+ dbo.SC(' ')
	exec PrcSetProgrss @Msg, 100, 45
	
	-- 
	if @p_SaleShop = 1
	Insert into @Tbl 
	Select 
		[L].[ContractNo]
		,[A].[No] as [FlatNo]
		,[B].[Name] as [BuildingName]
		,[L].[Rent]
		,[L].[DiscountValue]
		,[L].[Rent] - [L].[DiscountValue]
		,[ShopKind] as [FlatKind]
		,A.[Description] as [FlatType]
		,[A].[Area] as [FlatArea]
		,Case when ([L].[ToDate] <= GetDate()) or ([L].[ContractFinish] = 1) then dbo.sc(' ')  
			  when [L].[ToDate] > GetDate() then dbo.sc('  ') end as [ContractState]
		,[B].[Emirate] as [Emirate]
		,[B].[Suburb] as [Suburb]
		,[B].[Area] as [Area]
		,[B].[Street] as [Street]
		,'' as [FloorNo]
		,[Cu].[Name] as [CustName]
		,[Cu].[Mobile] as [CustPhone]
		,[Cu].[Nationality]
		,Cu.EMail as CustEMail
		,[L].[EditDate] as [ContractDateEdit]
		,[L].[DeliverDate] as [ContractDeliverDate]
		,[L].[FromDate] as [ContractDateBegin]
		,[L].[ToDate]as [ContractDateEnd]
		,[L].[ContractName]
		,Null as [ContractFinish]
		,[L].[Guid] as [ContractGuid]
		,-1 as [NewState] 

		,[I].[Name]	
		,L.[SalesMan]
		,[ContractFinishDate]
		,[ResultingAmount]
		,[ResultingAmount2]
		,[Fine]
		,[ResultingAmount2] + [Fine] + [OtherFee]
		,[InsuranceValueOld]
		,[InsuranceValue]
		,[InsuranceValueOld] + [InsuranceValue]
		,[ResultingAmount] + [InsuranceValueOld] + [InsuranceValue] - [Fine]
		,[Note2] 
		,L.[Purpose]
		,L.Trademark
		,L.[CountOldContract]
		,(Select [ContractCount] From #CurrentContract where L.CustomerGuid = CustomerGuid and [L].ApartmentGuid = ApartmentGuid)as [CurrentContract]
		,l.[AcquittancePrinted]
		,L.AcquittancePrintDate
		,l.[AcquittancePrintedBy]
		,[L].[CostGuid]
		,L.[CustAccountGuid]
		,L.[ContractJudicial]
		,[L].[Mark]
		,[L].[isAutoRenewal]
		,L.[PrvContractFinishDate]
		,L.[PrvContractEndDate]
		,3 as [Kind]
		,0 as [Sort]
	from 
		#Building_CL [B]
		Inner join [vwShopAll] [A] On [A].[BuildingGuid] = [B].[Guid]
		Inner join #LeaseApartment_CL [L] On [A].[Guid] = [L].[ApartmentGuid] and [LeaseKind]  = 3
		Inner join [Resource] [R] on [R].[Guid] = [B].[Guid]  and [R].[Kind] = 101 and [R].[spid] = @@Spid 
		--inner join [vwContractType] [T] on [T].[Guid] = [L].[TypeGuid]  
		--Inner join [Resource] [R2] on [R2].[Guid] = [T].[Guid]  and [R2].[Kind] = 100 and [R2].[spid] = @@Spid 
		Inner join [#Customer] [Cu] on [Cu].[Guid] = [L].[CustomerGuid] 
		left join #RentInfo_CL [I] on [I].[Guid] = [L].[RentInfoGuid]
	where
		(
				(
					([L].[FromDate] >= @Date1 and @Datewith  = 0)
					and ([L].[FromDate] <= @Date2 and @Datewith  = 0 or @Date2 = '12/30/1899')
				)
				or
				(
					([L].[EditDate] >= @Date1 and @Datewith  = 3)
					and ([L].[EditDate] <= @Date2 and @Datewith  = 3 or @Date2 = '12/30/1899')
				)
				
				or
				(
					([L].[AcquittancePrintdate] >= @Date1 and @Datewith  = 4)
					and ([L].[AcquittancePrintdate] <= @Date2 and @Datewith  = 4 or @Date2 = '12/30/1899')
				)
				
				or
				(
					([L].LeaveDate >= @Date1 and @Datewith  = 5)
					and ([L].LeaveDate <= @Date2 and @Datewith  = 5 or @Date2 = '12/30/1899')
				)

				or
				(
					([L].DeliverDate >= @Date1 and @Datewith  = 6)
					and ([L].DeliverDate <= @Date2 and @Datewith  = 6 or @Date2 = '12/30/1899')
				)
				or @CKDate = 0
			) 

		and (@EndState = 2)
		and (L.AcquittancePrinted = @AcquittancePrinted or @AcquittancePrinted = 2)
		and (A.Ban = @banRealty or @banRealty = 2)

	Set @Msg = @MsgConst +' '+ dbo.SC(' ')
	exec PrcSetProgrss @Msg, 100, 45

	--
	if (@AcquittancePrinted = 2) and (@Purpose = '') and (@p_RentParking = 1) and ( @Trademark = '')
	Insert into @Tbl 
	Select 
		[L].[ContractNo]
		,[A].[No] as [FlatNo]
		,[B].[Name] as [BuildingName]
		,[L].[Rent]
		,0 as [DiscountValue]
		,[L].[Rent] - 0
		,[ParkingKind] as [FlatKind]
		,A.[Description] as [FlatType]
		,[A].[Area] as [FlatArea]
		,Case when ([L].[ToDate] <= GetDate()) or ([L].[ContractFinish] = 1) then dbo.sc(' ')  
			  when [L].[ToDate] > GetDate() then dbo.sc('  ') end as [ContractState]
		,[B].[Emirate] as [Emirate]
		,[B].[Suburb] as [Suburb]
		,[B].[Area] as [Area]
		,[B].[Street] as [Street]
		,[A].[FloorNo]
		,[Cu].[Name] as [CustName]
		,[Cu].[Mobile] as [CustPhone]
		,[Cu].[Nationality]
		,Cu.EMail as CustEMail
		,[L].[EditDate] as [ContractDateEdit]
		,[L].[DeliverDate] as [ContractDeliverDate]
		,[L].[FromDate] as [ContractDateBegin]
		,[L].[ToDate]as [ContractDateEnd]
		,[T].[Name]
		,[L].[ContractFinish]
		,[L].[Guid] as [ContractGuid]
		,[L].[NewState] 

		,[I].[Name]	
		,S.Name as [SalesMan]	
		,[ContractFinishDate]
		,[ResultingAmount]
		,0 as [ResultingAmount2]
		,[Fine]
		,[Fine]
		,[InsuranceValueOld]
		,[InsuranceValue]
		,[InsuranceValueOld] + [InsuranceValue]
		,[ResultingAmount] + [InsuranceValueOld] + [InsuranceValue] - [Fine]
		,[Note2] 
		,''
		,''
		,0 as [CountOldContract]
		,0
		,0 as [AcquittancePrinted]
		,Null as AcquittancePrintDate
		,Null as [AcquittancePrintedBy]
		,[L].[CostGuid]
		,L.[CustAccountGuid]
		,L.[Judicial]
		,[L].[Mark]
		,[L].[isAutoRenewal]
		,(Select [ContractFinishDate] from ParkingContract where Guid = L.[PrvContractGuid]) as [PrvContractFinishDate]
		,(Select [ToDate] from ParkingContract where Guid = L.[PrvContractGuid]) as [PrvContractEndDate]

		,[R2].[spid]
		,0 as [Sort]
	from 
		#Building_CL [B]
		Inner join [vwParkingAll] [A] On [A].[BuildingGuid] = [B].[Guid]
		Inner join [vwParkingContract] [L] On [A].[Guid] = [L].[ParkingGuid]
		Inner join [Resource] [R] on [R].[Guid] = [B].[Guid]  and [R].[Kind] = 101 and [R].[spid] = @@Spid 
		inner join [vwContractType] [T] on [T].[Guid] = [L].[TypeGuid]  
		Inner join [Resource] [R2] on [R2].[Guid] = [T].[Guid]  and [R2].[Kind] = 100 and [R2].[spid] = @@Spid 
		Inner join [#Customer] [Cu] on [Cu].[Guid] = [L].[CustomerGuid] 
		left join #RentInfo_CL [I] on [I].[Guid] = [L].[RentInfoGuid]
		left join Salesman S on S.Guid = L.SalesManGuid
		left join [Lawsuit] W on W.ContractGuid = L.Guid
	where
		([L].[CustomerGuid] = @CustGuid or @CustGuid = 0x0)
		and 
			(
				((([L].[ToDate] <= GetDate()) or ([L].[ContractFinish] = 1)) and @ContractState = 0)
			  	or ([L].[ToDate] > GetDate() and @ContractState = 1)
				or @ContractState = 2
			)

		and (
				(
					([L].[FromDate] >= @Date1 and @Datewith  = 0)
					and ([L].[FromDate] <= @Date2 and @Datewith  = 0 or @Date2 = '12/30/1899')
				)
				or
				(
					([L].[ToDate] >= @Date1 and @Datewith  = 1)
					and ([L].[ToDate] <= @Date2 and @Datewith  = 1 or @Date2 = '12/30/1899')
				)

				or
				(
					([L].[ContractFinishDate] >= @Date1 and @Datewith  = 2)
					and ([L].[ContractFinishDate] <= @Date2 and @Datewith  = 2 or @Date2 = '12/30/1899')
					and ([L].[ContractFinish] = 1)
				)

				or
				(
					([L].[EditDate] >= @Date1 and @Datewith  = 3)
					and ([L].[EditDate] <= @Date2 and @Datewith  = 3 or @Date2 = '12/30/1899')
				)
				and @Datewith  <> 4 and @Datewith  <> 5

				or
				(
					([L].DeliverDate >= @Date1 and @Datewith  = 6)
					and ([L].DeliverDate <= @Date2 and @Datewith  = 6 or @Date2 = '12/30/1899')
				)

				or @CKDate = 0
			)

		and ([L].[RentInfoGuid] = @RentInfoGuid or @RentInfoGuid = 0x0)
		and ([L].[SalesManGuid] = @SalesManGuid or @SalesManGuid = 0x0)

		and ([L].[ContractFinish] = @EndState or @EndState = 2)
		and (
				([l].[Mark] = 1 and @Mark = 1)
				or ([l].[Mark] = 0 and @NotMark = 1)
			)
		and (L.PayType = @PayType or @PayType  = 4)

		and (
				(
					Case when ( isNull([L].[Judicial],0) = 1) or (W.Guid is Not Null ) then 1 else 0 end					
					= @Judicial					
				)
				and (
						(W.IsEnded = 1 and @LawsuitState = 0)
						or (W.IsEnded = 0 and @LawsuitState = 1)
						or @LawsuitState = 2
					)
			or @Judicial = 2)

		and (L.isAutoRenewal = @AutoRenewal or @AutoRenewal = 2)
		and (A.Ban = @banRealty or @banRealty = 2)
		and (
				(
					(
					([ContractFinishDate] < [ToDate] and @FinishDate = 0) or
					([ContractFinishDate] > [ToDate] and @FinishDate = 1) or
					([ContractFinishDate] = [ToDate] and @FinishDate = 2) 
					)
				and [ContractFinish] = 1
				)
				or @FinishDate = 3
			)
		and (
				(([L].Rent - [L].DiscountValue) <> 0 and @ContractValue = 0) or
				(([L].Rent - [L].DiscountValue) = 0 and @ContractValue = 1) or
				@ContractValue = 2
			)

	Set @Msg = @MsgConst +' '+ dbo.SC(' ')
	exec PrcSetProgrss @Msg, 100, 50

	--
	if (@p_RentLand = 1 or @p_SaleLand = 1)
	Insert into @Tbl 
	Select 
		[L].[ContractNo]
		,[A].[Name] as [FlatNo]
		,'' as [BuildingName]
		,[L].[Rent]
		,[L].[DiscountValue]
		,[L].[Rent] - [L].[DiscountValue]
		,'' as [FlatKind]
		,'' as [FlatType]
		,[A].[Area] as [FlatArea]
		,Case when ([L].[ToDate] <= GetDate()) or ([L].[ContractFinish] = 1) then dbo.sc(' ')  
			  when [L].[ToDate] > GetDate() then dbo.sc('  ') end as [ContractState]
		,'' as [Emirate]
		,'' as [Suburb]
		,'' as [Area]
		,'' as [Street]
		,'' as [FloorNo]
		,[Cu].[Name] as [CustName]
		,[Cu].[Mobile] as [CustPhone]
		,[Cu].[Nationality] 
		,Cu.EMail as CustEMail
		,[L].[EditDate] as [ContractDateEdit]
		,[L].[DeliverDate] as [ContractDeliverDate]
		,[L].[FromDate] as [ContractDateBegin]
		,[L].[ToDate] as [ContractDateEnd]
		,[T].[Name]
		,[ContractFinish]
		,[L].[Guid] as [ContractGuid]
		,[L].[NewState]
		,[I].[Name]
		,S.Name as [SalesMan]
		,[ContractFinishDate]
		,[ResultingAmount]
		,[ResultingAmount2]
		,[Fine]
		,[ResultingAmount2] + [Fine] + [OtherFee]
		,[InsuranceValueOld]
		,[InsuranceValue]
		,[InsuranceValueOld] + [InsuranceValue]
		,[ResultingAmount] + [InsuranceValueOld] + [InsuranceValue] - [Fine]
		,[Note2] 
		,L.[Purpose]
		,'' as Trademark 
		,0 as [CountOldContract]
		,0
		,l.[AcquittancePrinted]
		,L.AcquittancePrintDate
		,u.LoginName as [AcquittancePrintedBy]
		,[L].[CostGuid]
		,L.[CustAccountGuid]
		,L.[Judicial]
		,[L].[Mark]
		,[L].[isAutoRenewal]
		,(Select [ContractFinishDate] from [LandContract] where Guid = L.[PrvContractGuid]) as [PrvContractFinishDate]
		,(Select [ToDate] from [LandContract] where Guid = L.[PrvContractGuid]) as [PrvContractEndDate]
		,[R2].[spid]
		,0 as [Sort]
	from 
		[vwEarthAll] [A] 
		Inner join [vwLandContract] [L] On [A].[Guid] = [L].[LandGuid]
		inner join [vwContractType] [T] on [T].[Guid] = [L].[TypeGuid]  
		Inner join [Resource] [R2] on [R2].[Guid] = [T].[Guid]  and [R2].[Kind] = 100 and [R2].[spid] = @@Spid 
		Inner join [#Customer] [Cu] on [Cu].[Guid] = [L].[CustomerGuid] 
		left join #RentInfo_CL [I] on [I].[Guid] = [L].[RentInfoGuid]
		left join [Realty_Users] U on U.[Guid] = L.AcquittancePrintedByGuid
		left join Salesman S on S.Guid = L.SalesManGuid
		left join [Lawsuit] W on W.ContractGuid = L.Guid
	where
		([L].[CustomerGuid] = @CustGuid or @CustGuid = 0x0)
		and	([L].[SalesManGuid] = @SalesManGuid or @SalesManGuid = 0x0)
		and 
			(
				((([L].[ToDate] <= GetDate()) or ([L].[ContractFinish] = 1)) and @ContractState = 0)
			  	or ([L].[ToDate] > GetDate() and @ContractState = 1)
				or @ContractState = 2
			)
		and (
				(
					([L].[FromDate] >= @Date1 and @Datewith  = 0)
					and ([L].[FromDate] <= @Date2 and @Datewith  = 0 or @Date2 = '12/30/1899')
				)
				or
				(
					([L].[ToDate] >= @Date1 and @Datewith  = 1)
					and ([L].[ToDate] <= @Date2 and @Datewith  = 1 or @Date2 = '12/30/1899')
				)

				or
				(
					([L].[ContractFinishDate] >= @Date1 and @Datewith  = 2)
					and ([L].[ContractFinishDate] <= @Date2 and @Datewith  = 2 or @Date2 = '12/30/1899')
					and ([L].[ContractFinish] = 1)
				)

				or
				(
					([L].[EditDate] >= @Date1 and @Datewith  = 3)
					and ([L].[EditDate] <= @Date2 and @Datewith  = 3 or @Date2 = '12/30/1899')
				)
				or
				(
					([L].[AcquittancePrintdate] >= @Date1 and @Datewith  = 4)
					and ([L].[AcquittancePrintdate] <= @Date2 and @Datewith  = 4 or @Date2 = '12/30/1899')
				)

				or
				(
					([L].LeaveDate >= @Date1 and @Datewith  = 5)
					and ([L].LeaveDate <= @Date2 and @Datewith  = 5 or @Date2 = '12/30/1899')
				)
				
				or
				(
					([L].DeliverDate >= @Date1 and @Datewith  = 6)
					and ([L].DeliverDate <= @Date2 and @Datewith  = 6 or @Date2 = '12/30/1899')
				)

				or @CKDate = 0
			) 

		and ([L].[ContractFinish] = @EndState or @EndState = 2)
		and (
				([l].[Mark] = 1 and @Mark = 1)
				or ([l].[Mark] = 0 and @NotMark = 1)
			)
		and (L.PayType = @PayType or @PayType  = 4)
		and (L.AcquittancePrinted = @AcquittancePrinted or @AcquittancePrinted = 2)

		and (
				(
					Case when ( isNull([L].[Judicial],0) = 1) or (W.Guid is Not Null ) then 1 else 0 end					
					= @Judicial					
				)
				and (
						(W.IsEnded = 1 and @LawsuitState = 0)
						or (W.IsEnded = 0 and @LawsuitState = 1)
						or @LawsuitState = 2
					)
			or @Judicial = 2)

		and (L.Purpose = @Purpose or @Purpose = '') 
		and (L.Trademark = @Trademark or @Trademark = '')
		and (L.AcquittancePrintedByGuid = @AcquittancePrintedByUserGuid or @AcquittancePrintedByUserGuid = 0x0)
		and (l.isAutoRenewal = @AutoRenewal or @AutoRenewal = 2)
		and (A.Ban = @banRealty or @banRealty = 2)
		and (
				(
					(
					([ContractFinishDate] < [ToDate] and @FinishDate = 0) or
					([ContractFinishDate] > [ToDate] and @FinishDate = 1) or
					([ContractFinishDate] = [ToDate] and @FinishDate = 2) 
					)
				and [ContractFinish] = 1
				)
				or @FinishDate = 3
			)
		and (
				(([L].Rent - [L].DiscountValue) <> 0 and @ContractValue = 0) or
				(([L].Rent - [L].DiscountValue) = 0 and @ContractValue = 1) or
				@ContractValue = 2
			)
		
	Set @Msg = @MsgConst +' '+ dbo.SC(' ')
	exec PrcSetProgrss @Msg, 100, 55

	--
	if (@p_RentVilla = 1 or @p_SaleVilla = 1)
	Insert into @Tbl 
	Select 
		[L].[ContractNo]
		,[A].[Name] as [FlatNo]
		,'' as [BuildingName]
		,[L].[Rent]
		,[L].[DiscountValue]
		,[L].[Rent] - [L].[DiscountValue]
		,'' as [FlatKind]
		,'' as [FlatType]
		,[A].LandArea as [FlatArea]
		,Case when ([L].[ToDate] <= GetDate()) or ([L].[ContractFinish] = 1) then dbo.sc(' ')  
			  when [L].[ToDate] > GetDate() then dbo.sc('  ') end as [ContractState]
		,'' as [Emirate]
		,'' as [Suburb]
		,'' as [Area]
		,'' as [Street]
		,'' as [FloorNo]
		,[Cu].[Name] as [CustName]
		,[Cu].[Mobile] as [CustPhone]
		,[Cu].[Nationality]
		,Cu.EMail as CustEMail
		,[L].[EditDate] as [ContractDateEdit]
		,[L].[DeliverDate] as [ContractDeliverDate]
		,[L].[FromDate] as [ContractDateBegin]
		,[L].[ToDate] as [ContractDateEnd]
		,[T].[Name]
		,[ContractFinish]
		,[L].[Guid] as [ContractGuid]
		,[L].[NewState]  

		,[I].[Name]
		,S.name 
		,[ContractFinishDate]
		,[ResultingAmount]
		,[ResultingAmount2]
		,[Fine]
		,[ResultingAmount2] + [Fine] + [OtherFee]
		,[InsuranceValueOld]
		,[InsuranceValue]
		,[InsuranceValueOld] + [InsuranceValue]
		,[ResultingAmount] + [InsuranceValueOld] + [InsuranceValue] - [Fine]
		,[Note2] 
		,L.[Purpose]
		,L.Trademark
		,0 as [CountOldContract]
		,0
		,l.[AcquittancePrinted]
		,L.AcquittancePrintDate
		,u.LoginName as [AcquittancePrintedBy]
		,[L].[CostGuid]
		,L.[CustAccountGuid]
		,L.[Judicial]
		,[L].[Mark]
		,[L].[isAutoRenewal]
		,(Select [ContractFinishDate] from [LandContract] where Guid = L.[PrvContractGuid]) as [PrvContractFinishDate]
		,(Select [ToDate] from [LandContract] where Guid = L.[PrvContractGuid]) as [PrvContractEndDate]
		,[R2].[spid]
		,0 as [Sort]
	from 
		[vwVillaAll] [A] 
		Inner join [vwLandContract] [L] On [A].[Guid] = [L].[LandGuid]
		inner join [vwContractType] [T] on [T].[Guid] = [L].[TypeGuid]  
		Inner join [Resource] [R2] on [R2].[Guid] = [T].[Guid]  and [R2].[Kind] = 100 and [R2].[spid] = @@Spid 
		Inner join [#Customer] [Cu] on [Cu].[Guid] = [L].[CustomerGuid] 
		left join #RentInfo_CL [I] on [I].[Guid] = [L].[RentInfoGuid]
		left join [Realty_Users] U on U.[Guid] = L.AcquittancePrintedByGuid
		left join Salesman S on S.Guid = L.SalesManGuid
		left join [Lawsuit] W on W.ContractGuid = L.Guid
	where
		([L].[CustomerGuid] = @CustGuid or @CustGuid = 0x0)
		and	([L].[SalesManGuid] = @SalesManGuid or @SalesManGuid = 0x0)
		and 
			(
				((([L].[ToDate] <= GetDate()) or ([L].[ContractFinish] = 1)) and @ContractState = 0)
			  	or ([L].[ToDate] > GetDate() and @ContractState = 1)
				or @ContractState = 2
			)
		and (
				(
					([L].[FromDate] >= @Date1 and @Datewith  = 0)
					and ([L].[FromDate] <= @Date2 and @Datewith  = 0 or @Date2 = '12/30/1899')
				)
				or
				(
					([L].[ToDate] >= @Date1 and @Datewith  = 1)
					and ([L].[ToDate] <= @Date2 and @Datewith  = 1 or @Date2 = '12/30/1899')
				)

				or
				(
					([L].[ContractFinishDate] >= @Date1 and @Datewith  = 2)
					and ([L].[ContractFinishDate] <= @Date2 and @Datewith  = 2 or @Date2 = '12/30/1899')
					and ([L].[ContractFinish] = 1)
				)

				or
				(
					([L].[EditDate] >= @Date1 and @Datewith  = 3)
					and ([L].[EditDate] <= @Date2 and @Datewith  = 3 or @Date2 = '12/30/1899')
				)
				or
				(
					([L].[AcquittancePrintdate] >= @Date1 and @Datewith  = 4)
					and ([L].[AcquittancePrintdate] <= @Date2 and @Datewith  = 4 or @Date2 = '12/30/1899')
				)
				or
				(
					([L].LeaveDate >= @Date1 and @Datewith  = 5)
					and ([L].LeaveDate <= @Date2 and @Datewith  = 5 or @Date2 = '12/30/1899')
				)

				or
				(
					([L].DeliverDate >= @Date1 and @Datewith  = 6)
					and ([L].DeliverDate <= @Date2 and @Datewith  = 6 or @Date2 = '12/30/1899')
				)

				or @CKDate = 0
			) 

		and ([L].[ContractFinish] = @EndState or @EndState = 2)
		and (
				([l].[Mark] = 1 and @Mark = 1)
				or ([l].[Mark] = 0 and @NotMark = 1)
			)
		and (L.PayType = @PayType or @PayType  = 4)
		and (L.AcquittancePrinted = @AcquittancePrinted or @AcquittancePrinted = 2)

		and (
				(
					Case when ( isNull([L].[Judicial],0) = 1) or (W.Guid is Not Null ) then 1 else 0 end					
					= @Judicial					
				)
				and (
						(W.IsEnded = 1 and @LawsuitState = 0)
						or (W.IsEnded = 0 and @LawsuitState = 1)
						or @LawsuitState = 2
					)
			or @Judicial = 2)

		and (L.Purpose = @Purpose or @Purpose = '') 
		and (L.Trademark = @Trademark or @Trademark = '')
		and (L.AcquittancePrintedByGuid = @AcquittancePrintedByUserGuid or @AcquittancePrintedByUserGuid = 0x0)
		and (l.isAutoRenewal = @AutoRenewal or @AutoRenewal = 2)
		and (A.Ban = @banRealty or @banRealty = 2)
		and (
				(
					(
					([ContractFinishDate] < [ToDate] and @FinishDate = 0) or
					([ContractFinishDate] > [ToDate] and @FinishDate = 1) or
					([ContractFinishDate] = [ToDate] and @FinishDate = 2) 
					)
				and [ContractFinish] = 1
				)
				or @FinishDate = 3
			)
		and (
				(([L].Rent - [L].DiscountValue) <> 0 and @ContractValue = 0) or
				(([L].Rent - [L].DiscountValue) = 0 and @ContractValue = 1) or
				@ContractValue = 2
			)


	Set @Msg = @MsgConst +' '+ dbo.SC('')
	exec PrcSetProgrss @Msg, 100, 60

	Declare @PCheck Bit 
	Set @PCheck = 1	
	Declare @PNotCheck Bit 
	Set @PNotCheck = 0

	if @LinkCheck = 0 --  
	Delete @Tbl
	From
		@Tbl T
		inner join [Checks] C on C.ContractGuid = T.ContractGuid
	
	if @LinkCheck = 1 --  
	Delete @Tbl
	From
		@Tbl T
		left join [Checks] C on C.ContractGuid = T.ContractGuid
	where
		C.Guid is Null
		
	Set @Msg = @MsgConst +' '+ dbo.SC(' ')
	exec PrcSetProgrss @Msg, 100, 70

	-- 
	Create Table #Collection_CL
	(
		[ContractGuid] uniqueidentifier,
		[Total] Float,
		[PrvCollection] Float,
		[Collection] Float
	)
	
	Select
		p.Guid as [CheckGuid],
		[P].[ContractGuid],
		IsNull([P].[Value] * [P].[CurrencyVal],0) as [checkValue]
	into #Collection_Contract_Checks
	From
		[vbChecks] [P]
		inner join @Tbl [t] on [t].[ContractGuid] = [P].[ContractGuid]

	Select
		[CC].[ContractGuid],
		Sum(IsNull([C1].[Value] * [C1].[CurrencyVal],0)) as [Collection]
	Into #Collection_Sum_CL
	From
		#Collection_Contract_Checks CC
		inner join [ChecksCollection] [C1] on ([C1].[CheckGuid] = [CC].[CheckGuid] and [C1].[Kind] = 1)
		and (	(C1.date between @IncomeDate1 and @IncomeDate2) 
				or isNull(@IncomeActiveDate,0) = 0
			)
	Group By
		[CC].[ContractGuid]
		
	Select
		[CC].[ContractGuid],
		Sum(IsNull([C1].[Value] * [C1].[CurrencyVal],0)) as [Collection]
	Into #Collection_OldSum_CL
	From
		#Collection_Contract_Checks CC
		inner join [ChecksCollection] [C1] on ([C1].[CheckGuid] = [CC].[CheckGuid] and [C1].[Kind] = 1)
		and (C1.date < @IncomeDate1 )
	Group By
		[CC].[ContractGuid]

	insert into #Collection_CL
	([ContractGuid] ,[Total],[Collection])
	Select
		[ContractGuid],
		Sum(IsNull([CC].[checkValue],0)) as [Total],
		0
	From
		#Collection_Contract_Checks CC
	Group by
		[ContractGuid]
		
	update #Collection_CL Set [PrvCollection] = S.[Collection]
	From
		#Collection_CL C
		inner join #Collection_OldSum_CL S on C.ContractGuid = S.ContractGuid

	--update #Collection_CL Set [Collection] = IsNull([PrvCollection],0)

	update #Collection_CL Set [Collection] = S.[Collection] --+ IsNull(C.[PrvCollection],0)
	From
		#Collection_CL C
		inner join #Collection_Sum_CL S on C.ContractGuid = S.ContractGuid


	--update #Collection_CL Set [PrvCollection] = 22


	Set @Msg = @MsgConst +' '+ dbo.SC(' ')
	exec PrcSetProgrss @Msg, 100, 75

	-- 
	Select
		[P].[ContractGuid],
		Sum(IsNull([P].[Value] * [P].[CurrencyVal],0)) as [Cash]
	Into #Cash
	From
		[vwContractCachPayment] [P]
		inner join @Tbl [t] on [t].[ContractGuid] = [P].[ContractGuid] and P.AcGuid = t.AccountGuid
	where
		( ([P].date between @IncomeDate1 and @IncomeDate2) or IsNull(@IncomeActiveDate,0) = 0)
	Group By
		[P].[ContractGuid]	


	-- 
	Select
		[P].[ContractGuid],
		Sum(IsNull([P].[Value] * [P].[CurrencyVal],0)) as [Cash]
	Into #PrvCash
	From
		[vwContractCachPayment] [P]
		inner join @Tbl [t] on [t].[ContractGuid] = [P].[ContractGuid] and P.AcGuid = t.AccountGuid
	where
		( [P].date < @IncomeDate1)
	Group By
		[P].[ContractGuid]	

	Set @Msg = @MsgConst +' '+ dbo.SC(' ')
	exec PrcSetProgrss @Msg, 100, 80

	Select
		En.AcGuid,
		SUM(En.debit - en.Credit) as [Balance]
	into #CustBalance
	From
		(Select distinct AccountGuid from @Tbl ) T
		inner join DEntry En on En.AcGuid = T.AccountGuid
	Group By
		En.AcGuid

	Set @Msg = @MsgConst +' '+ dbo.SC(' ')
	exec PrcSetProgrss @Msg, 100, 85


	--  
	Select
		parentGuid,
		S.No as ParkingNo
	into #LinkParkingContract
	from
		LinkParkingContract L
		inner join ParkingContract p on p.Guid = L.ParkingContractGuid
		inner join [Parking] [S] on [S].[Guid] = [P].[ParkingGuid]
		inner join @Tbl T on t.ContractGuid = L.ParentGuid
		
	Declare @LinkParkingContract Table 
	(
		ParentGuid uniqueidentifier,
		ParkingNo Varchar(8000)
	)
	
	Create Table #LinkParkingContract_1
	(
		ParkingNo Varchar(8000)
	)
	
	
	Declare @P_ContractGuid uniqueidentifier
	DECLARE @cursor_Name CURSOR 
	Set @cursor_Name = CURSOR FAST_FORWARD FOR 

	SELECT Distinct parentGuid
	FROM #LinkParkingContract
	
	OPEN @cursor_Name
	FETCH NEXT FROM @cursor_Name INTO @P_ContractGuid
	
	WHILE @@FETCH_STATUS = 0
	BEGIN
	  
	  Delete #LinkParkingContract_1
	  
	  insert into #LinkParkingContract_1
	  Select ParkingNo from #LinkParkingContract where ParentGuid = @P_ContractGuid
	  
	  insert into @LinkParkingContract
	  exec [PrcTabletoString] @P_ContractGuid, '#LinkParkingContract_1', 'ParkingNo'
		
	  FETCH NEXT FROM @cursor_Name INTO @P_ContractGuid
	
	END
	
	CLOSE @cursor_Name
	DEALLOCATE @cursor_Name
	-----------------
	
	Set @Msg = ''
	exec PrcSetProgrss @Msg, 100, 90

	Select 
		[E].*,
		
		Case when isnUll([ContractFinish],0) = 0 then dbo.sc('') else dbo.sc('') end As [ContractFinishStr],
		Case when isnUll([NewState],0) = 0 then dbo.sc('') 
			 when isnUll([NewState],0) = 1 then dbo.sc('') 
		else 
			''
		end As [NewStateStr],
		
		LC.ParkingNo as LinkParkingNO,
		
		isNull([C].[PrvCollection],0) + isNull(ph.[Cash],0) as [PrvCollection],
		isNull([C].[Collection],0) as [Collection],
		isNull([C].[Total],0) - isNull([C].[Collection],0) - IsNull([PrvCollection],0) as [CheckNotCollection],
		isNull([h].[Cash],0) as [Cash],
		IsNull([C].[Collection],0) + IsNull([h].[Cash],0) + IsNull([ph].[Cash],0) + IsNull([PrvCollection],0) as [TotalPays],
		isNull(E.ValueAfterDiscount ,0) - IsNull([C].[Collection],0) - IsNull([PrvCollection],0) - IsNull([h].[Cash],0) - isNull(ph.[Cash],0) as [ContractRest],
		--isNull(E.[RentCleanValue],0)  as [ContractRest],
		CAST(0 as Float) as [CustBalance],
				
		Case when [R].[ObjGuid] is null then @PNotCheck
			 when [R].[ObjGuid] is not null  then @PCheck end as [Check],
		1 as [DoOperation]
	into #ContractList_4
	From
		@Tbl [E]
		left join #Collection_CL [C] on [E].[ContractGuid] = [C].[ContractGuid]
		left join #Cash [h] on [E].[ContractGuid] = [h].[ContractGuid]
		left join #PrvCash [Ph] on [E].[ContractGuid] = [Ph].[ContractGuid]
		left join [RepCheck] [R] on [R].[ObjGuid] = [E].[ContractGuid] and [R].[IdReport] = 2000
		left join @LinkParkingContract LC on LC.ParentGuid = E.ContractGuid
	where
		(
			([R].[ObjGuid] is not null and @ShowIsCheck = 1)
			or
			([R].[ObjGuid] is null and @ShowIsNotCheck = 1)
		)
		and (Isnull([E].[NewState],0) = @NewState or @NewState = 2)
		
	Set @Msg = ''
	exec PrcSetProgrss @Msg, 100, 95
	
	update	
		#ContractList_4
	set
		custBalance = C.Balance
	From
		#ContractList_4 E
		inner join #CustBalance C on C.AcGuid = E.AccountGuid 
	
	Set @Msg = ''
	exec PrcSetProgrss @Msg, 0, 0
	
	Select
		Collection,*
	from
		#ContractList_4
	Order By 
		[Sort],
		[BuildingName],
		[FlatNo]
		
	
	Select
		SUM(Value) as [Value],
		SUM(ValueAfterDiscount) as ValueAfterDiscount,
		SUM(ResultingAmount) as ResultingAmount,
		SUM(Fine) as Fine,
		SUM(TotalIncom) as TotalIncom,
		SUM(TotalInsuranse) as TotalInsuranse,
		SUM(RentCleanValue) as RentCleanValue
	From
		#ContractList_4
	where
		[Sort] = 0
		

GO

SET ANSI_NULLS, QUOTED_IDENTIFIER ON
GO

Create Procedure [PrcCreateMaintenanceContractEntry]
(
	@ContractGuid uniqueidentifier = '40CE1320-4AA3-4E22-A225-11FD91C0D15B'
)
 
AS
	Set NoCount on 
	Declare 
			@EnNum int,
			@EnGuid [uniqueidentifier]

	--  
	Select 
		@EnNum = isnull([Number],0)
		,@EnGuid = isnull([Guid],0x0)
	From
		[HEntry]
	where
		[Guid] = @ContractGuid

	if isnull(@EnNum,0) = 0
	begin	
		Select @EnNum = IsNull(Max([Number]),0) + 1 from [HEntry]
	END
	
	if isnull(@EnGuid,0x0) = 0x0
	Set @EnGuid = @ContractGuid

	if Exists(Select Number From HEntry where Number = @EnNum and [Guid] <> @EnGuid)
	Select @EnNum = IsNull(Max([Number]),0) + 1 from [HEntry]

	--   
	Delete
		[HEntry]
	where
		[Guid] = @EnGuid

		
	--return
	DECLARE 
		@EntryDate Datetime,
		@CreateEntry bit,

		@MoveCostWithExpenceDebit bit,
		@MoveCostWithExpenceCredit bit,

		@MoveCostWithDiscountDebit bit,
		@MoveCostWithDiscountCredit bit,

		@SecLvl int,
		@CurrencyGuid uniqueidentifier,
		@CurrencyVal Float,
		@TypeName varchar(256),
		@ContractNumber int,
		@AutoPostedEntry bit,
		@Mark bit,
		@EntryNote Varchar(255),
		@DetailNum Int,

		@Value fLoat,

		@CostGuid uniqueidentifier,
		@CustAccountGuid uniqueidentifier,
		@IncomeAccountGuid uniqueidentifier,

		@Fromdate datetime,
		@Todate datetime,

		@OtherFeeAccountGuid uniqueidentifier,
		@OtherFee Float,

		@DiscountValue fLoat,
		@DiscountAccountGuid uniqueidentifier,
		@BranchGuid uniqueidentifier
		
	
	SELECT	TOP 1
		@EntryDate = Case when T.EntryDate = 0 then C.FromDate else C.EditDate end,
		@AutoPostedEntry = T.AutoPostedEntry,
		@CreateEntry = T.CreateEntry,
		@MoveCostWithExpenceDebit = T.MoveCostWithExpenceDebit,
		@MoveCostWithExpenceCredit = T.MoveCostWithExpenceCredit,

		@MoveCostWithDiscountDebit = T.MoveCostWithDiscountDebit,
		@MoveCostWithDiscountCredit = T.MoveCostWithDiscountCredit,
		
		@SecLvl = C.SecLvl,
		@CurrencyGuid = C.CurrencyGuid,
		@CurrencyVal = C.CurrencyVal,
		@TypeName = T.Name,
		@ContractNumber = C.Number ,

		@AutoPostedEntry = T.AutoPostedEntry,
		@Mark = C.Mark,

		@CostGuid = C.CostGuid,
		@CustAccountGuid = C.CustAccountGuid,
		@IncomeAccountGuid = C.IncomeAccountGuid,
		
		@Fromdate = C.FromDate,
		@Todate = C.ToDate,

		@OtherFee = C.OtherFee,
		@OtherFeeAccountGuid = C.OtherFeeAccountGUID,

		@Value = C.Value,
		@DiscountValue = C.DiscountValue,
		@DiscountAccountGuid = C.DiscountAccountGuid,
		@BranchGuid = C.BranchGuid,
		@EntryNote = [T].[ContractNote]
	FROM
		[vwMaintenanceContract]  C
		inner join [vwmaintenanceContractType] T on T.Guid = C.TypeGuid
	WHERE
		C.Guid = @ContractGuid

	Select 
		@EntryNote  =				REPLACE(REPLACE(REPLACE(REPLACE(REPLACE(
									REPLACE(REPLACE(REPLACE(REPLACE(--(REPLACE(--REPLACE(
									@EntryNote, '[N]', TypeNameAr),
									'[M]', TypeNameLtn),
									'[A]', CustArName),
									'[B]', CustltnName),
									--'[D]', BuildingArName),
									--'[E]', BuildingLtnName),
									'[F]', dbo.fndate(EditDate)),
									'[G]', dbo.fndate(Fromdate)),
									'[H]', dbo.fndate(Todate)),
									'[K]', ContractNo),
									'[L]', Cast(Value as varchar(50)))
									
	from 
		[vwMaintenanceContract]
	where
		Guid = @ContractGuid
	
	Insert Into [HEntry]
	([Guid],[SecLvl],[Number],[Date], [CurrencyGuid], [CurrencyVal], [Note], [ParentKind], [BranchGuid], [IsPosted], Mark)
	Select
		@EnGuid,
		@SecLvl,
		@EnNum,
		@EntryDate,
		@CurrencyGuid,
		@CurrencyVal,
		@EntryNote as [Note],
		27 as [ParentKind], 
		@BranchGuid as [BranchGuid], 
		@AutoPostedEntry as [IsPosted],
		@Mark

	--				
	if isNull(@Value,0) <> 0
	begin
		Set @DetailNum = 0
		Insert into [DEntry]
 		([ParentGuid],[Number],[AcGuid],[Debit],[Credit],[CurrencyGuid],[CurrencyVal],[CostGuid],[ObverseAcGuid],[Note])
		Select
			@EnGuid,
			@DetailNum,
			@CustAccountGuid,
			@Value as Debit,
			0 as Credit,
			@CurrencyGuid,
			@CurrencyVal,
			Case when @MoveCostWithExpenceDebit = 1 then @CostGuid end,
			@IncomeAccountGuid,
			@EntryNote

		Set @DetailNum = 1
		Insert into [DEntry]
 		([ParentGuid],[Number],[AcGuid],[Debit],[Credit],[CurrencyGuid],[CurrencyVal],[CostGuid],[ObverseAcGuid],[Note])
		Select
			@EnGuid,
			@DetailNum,
			@IncomeAccountGuid,
			0 as Debit,
			@Value as Credit,
			@CurrencyGuid,
			@CurrencyVal,
			Case when @MoveCostWithExpenceCredit = 1 then @CostGuid end,
			@CustAccountGuid,
			@EntryNote
	end

	--
	if isNull(@DiscountValue,0) <> 0
	begin
		Set @DetailNum = 3
		Insert into [DEntry]
 		([ParentGuid],[Number],[AcGuid],[Debit],[Credit],[CurrencyGuid],[CurrencyVal],[CostGuid],[ObverseAcGuid],[Note])
		Select
			@EnGuid,
			@DetailNum,
			@DiscountAccountGuid,
			@DiscountValue as Debit,
			0 as Credit,
			@CurrencyGuid,
			@CurrencyVal,
			Case when @MoveCostWithDiscountDebit = 1 then @CostGuid end,
			@CustAccountGuid,
			@EntryNote

		Set @DetailNum = 4
		Insert into [DEntry]
 		([ParentGuid],[Number],[AcGuid],[Debit],[Credit],[CurrencyGuid],[CurrencyVal],[CostGuid],[ObverseAcGuid],[Note])
		Select
			@EnGuid,
			@DetailNum,
			@CustAccountGuid,
			0 as Debit,
			@DiscountValue as Credit,
			@CurrencyGuid,
			@CurrencyVal,
			Case when @MoveCostWithDiscountCredit = 1 then @CostGuid end,
			@DiscountAccountGuid,
			@EntryNote
	end
	exec PrcDoDistributiveEntry @EnGuid
	
	if @AutoPostedEntry = 1
	Update [Hentry] Set IsPosted = 1 where Guid = @EnGuid
	
	--Select * from [Hentry] where Guid = @EnGuid 
	--Select * from [Dentry] where parentGuid = @EnGuid order by number


GO

SET ANSI_NULLS, QUOTED_IDENTIFIER ON
GO

Create Trigger [TRG_Trace_Customer]
on [Customer]
 
for update
As
	SET NOCOUNT ON;
	if Not exists(Select Value from DMD_const where vName = 'ActiveLogCardUpdate' and Value = '1' ) return
	
	Declare @UserGuid uniqueidentifier, @Guid uniqueidentifier
	Set @Guid = NEWID()
	
	Select Top 1 @UserGuid = userGuid From CurrentUsers where Spid = @@SPID
			
	insert into [Trace]
	([Guid],[ParentGuid],[Date],[userGuid],[HostName],ParentTbl )
	Select Top 1
		@Guid,
		N.Guid,
		GETDATE(),
		@UserGuid,
		Host_Name(),
		'Customer'
	From
		[inserted] n 
		
	insert into [TraceDetail]
	([ParentGuid],[Caption],[Old],[New],[Tbl])
	Select Top 1
		@Guid,
		' ' as [Caption],
		D.[SecLvl] as [old],
		N.[SecLvl] as [New],
		''
	From
		[deleted] d
		inner join [inserted] n on D.Guid = N.Guid
	where
		N.[SecLvl] <> D.[SecLvl]
		
	insert into [TraceDetail]
	([ParentGuid],[Caption],[Old],[New],[Tbl])
	Select Top 1
		@Guid,
		'' as [Caption],
		D.[Barcode] as [old],
		N.[Barcode] as [New],
		''
	From
		[deleted] d
		inner join [inserted] n on D.Guid = N.Guid
	where
		N.[Barcode] <> D.[Barcode]
		
	insert into [TraceDetail]
	([ParentGuid],[Caption],[Old],[New],[Tbl])
	Select Top 1
		@Guid,
		'' as [Caption],
		D.[Name] as [old],
		N.[Name] as [New],
		''
	From
		[deleted] d
		inner join [inserted] n on D.Guid = N.Guid
	where
		N.[Name] <> D.[Name]
		
	insert into [TraceDetail]
	([ParentGuid],[Caption],[Old],[New],[Tbl])
	Select Top 1
		@Guid,
		' ' as [Caption],
		D.[LtnName] as [old],
		N.[LtnName] as [New],
		''
	From
		[deleted] d
		inner join [inserted] n on D.Guid = N.Guid
	where
		N.[LtnName] <> D.[LtnName]
		
	insert into [TraceDetail]
	([ParentGuid],[Caption],[Old],[New],[Tbl])
	Select Top 1
		@Guid,
		' ' as [Caption],
		D.[CardKind] as [old],
		N.[CardKind] as [New],
		''
	From
		[deleted] d
		inner join [inserted] n on D.Guid = N.Guid
	where
		N.[CardKind] <> D.[CardKind]
		
	insert into [TraceDetail]
	([ParentGuid],[Caption],[Old],[New],[Tbl])
	Select Top 1
		@Guid,
		'' as [Caption],
		D.[Nationality] as [old],
		N.[Nationality] as [New],
		''
	From
		[deleted] d
		inner join [inserted] n on D.Guid = N.Guid
	where
		N.[Nationality] <> D.[Nationality]
		
	insert into [TraceDetail]
	([ParentGuid],[Caption],[Old],[New],[Tbl])
	Select Top 1
		@Guid,
		'' as [Caption],
		D.[Profession] as [old],
		N.[Profession] as [New],
		''
	From
		[deleted] d
		inner join [inserted] n on D.Guid = N.Guid
	where
		N.[Profession] <> D.[Profession]
		
	insert into [TraceDetail]
	([ParentGuid],[Caption],[Old],[New],[Tbl])
	Select Top 1
		@Guid,
		'PassportNO' as [Caption],
		D.[PassportNO] as [old],
		N.[PassportNO] as [New],
		''
	From
		[deleted] d
		inner join [inserted] n on D.Guid = N.Guid
	where
		N.[PassportNO] <> D.[PassportNO]
		
	insert into [TraceDetail]
	([ParentGuid],[Caption],[Old],[New],[Tbl])
	Select Top 1
		@Guid,
		'PassportExpireDate' as [Caption],
		dbo.fnDate(D.[PassportExpireDate]) as [old],
		dbo.fnDate(N.[PassportExpireDate]) as [New],
		''
	From
		[deleted] d
		inner join [inserted] n on D.Guid = N.Guid
	where
		N.[PassportExpireDate] <> D.[PassportExpireDate]
		
	insert into [TraceDetail]
	([ParentGuid],[Caption],[Old],[New],[Tbl])
	Select Top 1
		@Guid,
		'Domicile' as [Caption],
		D.[Domicile] as [old],
		N.[Domicile] as [New],
		''
	From
		[deleted] d
		inner join [inserted] n on D.Guid = N.Guid
	where
		N.[Domicile] <> D.[Domicile]
		
	insert into [TraceDetail]
	([ParentGuid],[Caption],[Old],[New],[Tbl])
	Select Top 1
		@Guid,
		'Security' as [Caption],
		D.[Security] as [old],
		N.[Security] as [New],
		''
	From
		[deleted] d
		inner join [inserted] n on D.Guid = N.Guid
	where
		N.[Security] <> D.[Security]
		
	insert into [TraceDetail]
	([ParentGuid],[Caption],[Old],[New],[Tbl])
	Select Top 1
		@Guid,
		'PhoneJob' as [Caption],
		D.[PhoneJob] as [old],
		N.[PhoneJob] as [New],
		''
	From
		[deleted] d
		inner join [inserted] n on D.Guid = N.Guid
	where
		N.[PhoneJob] <> D.[PhoneJob]
		
	insert into [TraceDetail]
	([ParentGuid],[Caption],[Old],[New],[Tbl])
	Select Top 1
		@Guid,
		'Mobile' as [Caption],
		D.[Mobile] as [old],
		N.[Mobile] as [New],
		''
	From
		[deleted] d
		inner join [inserted] n on D.Guid = N.Guid
	where
		N.[Mobile] <> D.[Mobile]
		
	insert into [TraceDetail]
	([ParentGuid],[Caption],[Old],[New],[Tbl])
	Select Top 1
		@Guid,
		'' as [Caption],
		D.[Note] as [old],
		N.[Note] as [New],
		''
	From
		[deleted] d
		inner join [inserted] n on D.Guid = N.Guid
	where
		N.[Note] <> D.[Note]
		
	insert into [TraceDetail]
	([ParentGuid],[Caption],[Old],[New],[Tbl])
	Select Top 1
		@Guid,
		'' as [Caption],
		D.[AcGuid] as [old],
		N.[AcGuid] as [New],
		'[Account]'
	From
		[deleted] d
		inner join [inserted] n on D.Guid = N.Guid
	where
		N.[AcGuid] <> D.[AcGuid]
		
	insert into [TraceDetail]
	([ParentGuid],[Caption],[Old],[New],[Tbl])
	Select Top 1
		@Guid,
		' ' as [Caption],
		D.[MemoSecurity] as [old],
		N.[MemoSecurity] as [New],
		''
	From
		[deleted] d
		inner join [inserted] n on D.Guid = N.Guid
	where
		N.[MemoSecurity] <> D.[MemoSecurity]
		
	insert into [TraceDetail]
	([ParentGuid],[Caption],[Old],[New],[Tbl])
	Select Top 1
		@Guid,
		'' as [Caption],
		D.[Address] as [old],
		N.[Address] as [New],
		''
	From
		[deleted] d
		inner join [inserted] n on D.Guid = N.Guid
	where
		N.[Address] <> D.[Address]
		
	insert into [TraceDetail]
	([ParentGuid],[Caption],[Old],[New],[Tbl])
	Select Top 1
		@Guid,
		' ' as [Caption],
		D.[BoxNo] as [old],
		N.[BoxNo] as [New],
		''
	From
		[deleted] d
		inner join [inserted] n on D.Guid = N.Guid
	where
		N.[BoxNo] <> D.[BoxNo]
		
	insert into [TraceDetail]
	([ParentGuid],[Caption],[Old],[New],[Tbl])
	Select Top 1
		@Guid,
		' ' as [Caption],
		D.[PersonalityNo1] as [old],
		N.[PersonalityNo1] as [New],
		''
	From
		[deleted] d
		inner join [inserted] n on D.Guid = N.Guid
	where
		N.[PersonalityNo1] <> D.[PersonalityNo1]
		
	insert into [TraceDetail]
	([ParentGuid],[Caption],[Old],[New],[Tbl])
	Select Top 1
		@Guid,
		'  ' as [Caption],
		D.[PersonalityNo2] as [old],
		N.[PersonalityNo2] as [New],
		''
	From
		[deleted] d
		inner join [inserted] n on D.Guid = N.Guid
	where
		N.[PersonalityNo2] <> D.[PersonalityNo2]
		
	insert into [TraceDetail]
	([ParentGuid],[Caption],[Old],[New],[Tbl])
	Select Top 1
		@Guid,
		'' as [Caption],
		D.[Fax] as [old],
		N.[Fax] as [New],
		''
	From
		[deleted] d
		inner join [inserted] n on D.Guid = N.Guid
	where
		N.[Fax] <> D.[Fax]
		
	insert into [TraceDetail]
	([ParentGuid],[Caption],[Old],[New],[Tbl])
	Select Top 1
		@Guid,
		' ' as [Caption],
		D.[EMail] as [old],
		N.[EMail] as [New],
		''
	From
		[deleted] d
		inner join [inserted] n on D.Guid = N.Guid
	where
		N.[EMail] <> D.[EMail]
		
	insert into [TraceDetail]
	([ParentGuid],[Caption],[Old],[New],[Tbl])
	Select Top 1
		@Guid,
		'' as [Caption],
		D.[Adjective] as [old],
		N.[Adjective] as [New],
		''
	From
		[deleted] d
		inner join [inserted] n on D.Guid = N.Guid
	where
		N.[Adjective] <> D.[Adjective]
		
	insert into [TraceDetail]
	([ParentGuid],[Caption],[Old],[New],[Tbl])
	Select Top 1
		@Guid,
		' ' as [Caption],
		D.[CkHideInSearch] as [old],
		N.[CkHideInSearch] as [New],
		''
	From
		[deleted] d
		inner join [inserted] n on D.Guid = N.Guid
	where
		N.[CkHideInSearch] <> D.[CkHideInSearch]
		
	insert into [TraceDetail]
	([ParentGuid],[Caption],[Old],[New],[Tbl])
	Select Top 1
		@Guid,
		'   ' as [Caption],
		D.[ban] as [old],
		N.[ban] as [New],
		''
	From
		[deleted] d
		inner join [inserted] n on D.Guid = N.Guid
	where
		N.[ban] <> D.[ban]
		
	insert into [TraceDetail]
	([ParentGuid],[Caption],[Old],[New],[Tbl])
	Select Top 1
		@Guid,
		'  ' as [Caption],
		D.BanContract as [old],
		N.BanContract as [New],
		''
	From
		[deleted] d
		inner join [inserted] n on D.Guid = N.Guid
	where
		N.BanContract <> D.BanContract
		
		
		
	insert into [TraceDetail]
	([ParentGuid],[Caption],[Old],[New],[Tbl])
	Select Top 1
		@Guid,
		' ' as [Caption],
		D.[BankName] as [old],
		N.[BankName] as [New],
		''
	From
		[deleted] d
		inner join [inserted] n on D.Guid = N.Guid
	where
		N.[BankName] <> D.[BankName]
		
	insert into [TraceDetail]
	([ParentGuid],[Caption],[Old],[New],[Tbl])
	Select Top 1
		@Guid,
		' ' as [Caption],
		D.[BankAccCode] as [old],
		N.[BankAccCode] as [New],
		''
	From
		[deleted] d
		inner join [inserted] n on D.Guid = N.Guid
	where
		N.[BankAccCode] <> D.[BankAccCode]
		
	insert into [TraceDetail]
	([ParentGuid],[Caption],[Old],[New],[Tbl])
	Select Top 1
		@Guid,
		' ' as [Caption],
		D.[Trademark] as [old],
		N.[Trademark] as [New],
		''
	From
		[deleted] d
		inner join [inserted] n on D.Guid = N.Guid
	where
		N.[Trademark] <> D.[Trademark]
		
	insert into [TraceDetail]
	([ParentGuid],[Caption],[Old],[New],[Tbl])
	Select Top 1
		@Guid,
		'' as [Caption],
		D.[CardKind2] as [old],
		N.[CardKind2] as [New],
		''
	From
		[deleted] d
		inner join [inserted] n on D.Guid = N.Guid
	where
		N.[CardKind2] <> D.[CardKind2]
		
	insert into [TraceDetail]
	([ParentGuid],[Caption],[Old],[New],[Tbl])
	Select Top 1
		@Guid,
		' ' as [Caption],
		D.[Birthday] as [old],
		N.[Birthday] as [New],
		''
	From
		[deleted] d
		inner join [inserted] n on D.Guid = N.Guid
	where
		N.[Birthday] <> D.[Birthday]
		
	insert into [TraceDetail]
	([ParentGuid],[Caption],[Old],[New],[Tbl])
	Select Top 1
		@Guid,
		'   ' as [Caption],
		dbo.fnDate(D.[DomicileEndDate]) as [old],
		dbo.fnDate(N.[DomicileEndDate]) as [New],
		''
	From
		[deleted] d
		inner join [inserted] n on D.Guid = N.Guid
	where
		N.[DomicileEndDate] <> D.[DomicileEndDate]
		
	insert into [TraceDetail]
	([ParentGuid],[Caption],[Old],[New],[Tbl])
	Select Top 1
		@Guid,
		'  ' as [Caption],
		dbo.fnDate(D.[PersonalityEndDate]) as [old],
		dbo.fnDate(N.[PersonalityEndDate]) as [New],
		''
	From
		[deleted] d
		inner join [inserted] n on D.Guid = N.Guid
	where
		N.[PersonalityEndDate] <> D.[PersonalityEndDate]
		
	delete Trace From Trace t left join [TraceDetail] D on T.guid = D.ParentGuid
	where
		d.ParentGuid is Null and t.Guid = @Guid


GO

SET ANSI_NULLS, QUOTED_IDENTIFIER ON
GO

Create Trigger [TRG_Trace_EntryDateType]
on [EntryDateType]
 
for update
As
	SET NOCOUNT ON;
	if Not exists(Select Value from DMD_const where vName = 'ActiveLogCardUpdate' and Value = '1' ) return
	
	Declare @UserGuid uniqueidentifier, @Guid uniqueidentifier
	Set @Guid = NEWID()
	
	Select Top 1 @UserGuid = userGuid From CurrentUsers where Spid = @@SPID
			
	insert into [Trace]
	([Guid],[ParentGuid],[Date],[userGuid],[HostName],ParentTbl )
	Select Top 1
		@Guid,
		N.Guid,
		GETDATE(),
		@UserGuid,
		Host_Name(),
		'EntryDateType'
	From
		[inserted] n 
		
	insert into [TraceDetail]
	([ParentGuid],[Caption],[Old],[New],[Tbl])
	Select Top 1
		@Guid,
		' ' as [Caption],
		D.[SecLvl] as [old],
		N.[SecLvl] as [New],
		''
	From
		[deleted] d
		inner join [inserted] n on D.Guid = N.Guid
	where
		N.[SecLvl] <> D.[SecLvl]
		
	insert into [TraceDetail]
	([ParentGuid],[Caption],[Old],[New],[Tbl])
	Select Top 1
		@Guid,
		'' as [Caption],
		D.[Code] as [old],
		N.[Code] as [New],
		''
	From
		[deleted] d
		inner join [inserted] n on D.Guid = N.Guid
	where
		N.[Code] <> D.[Code]
		
	insert into [TraceDetail]
	([ParentGuid],[Caption],[Old],[New],[Tbl])
	Select Top 1
		@Guid,
		'' as [Caption],
		D.[Name] as [old],
		N.[Name] as [New],
		''
	From
		[deleted] d
		inner join [inserted] n on D.Guid = N.Guid
	where
		N.[Name] <> D.[Name]
		
	insert into [TraceDetail]
	([ParentGuid],[Caption],[Old],[New],[Tbl])
	Select Top 1
		@Guid,
		' ' as [Caption],
		D.[ltnName] as [old],
		N.[ltnName] as [New],
		''
	From
		[deleted] d
		inner join [inserted] n on D.Guid = N.Guid
	where
		N.[ltnName] <> D.[ltnName]
		
	insert into [TraceDetail]
	([ParentGuid],[Caption],[Old],[New],[Tbl])
	Select Top 1
		@Guid,
		' ' as [Caption],
		D.[Menu] as [old],
		N.[Menu] as [New],
		''
	From
		[deleted] d
		inner join [inserted] n on D.Guid = N.Guid
	where
		N.[Menu] <> D.[Menu]
		
	insert into [TraceDetail]
	([ParentGuid],[Caption],[Old],[New],[Tbl])
	Select Top 1
		@Guid,
		'  ' as [Caption],
		D.[LtnMenu] as [old],
		N.[LtnMenu] as [New],
		''
	From
		[deleted] d
		inner join [inserted] n on D.Guid = N.Guid
	where
		N.[LtnMenu] <> D.[LtnMenu]
		
	insert into [TraceDetail]
	([ParentGuid],[Caption],[Old],[New],[Tbl])
	Select Top 1
		@Guid,
		' ' as [Caption],
		D.[ShortCut] as [old],
		N.[ShortCut] as [New],
		''
	From
		[deleted] d
		inner join [inserted] n on D.Guid = N.Guid
	where
		N.[ShortCut] <> D.[ShortCut]
		
	insert into [TraceDetail]
	([ParentGuid],[Caption],[Old],[New],[Tbl])
	Select Top 1
		@Guid,
		'' as [Caption],
		D.[DefAccountGuid] as [old],
		N.[DefAccountGuid] as [New],
		'[Account]'
	From
		[deleted] d
		inner join [inserted] n on D.Guid = N.Guid
	where
		N.[DefAccountGuid] <> D.[DefAccountGuid]
		
	insert into [TraceDetail]
	([ParentGuid],[Caption],[Old],[New],[Tbl])
	Select Top 1
		@Guid,
		'  ' as [Caption],
		D.[DebitField] as [old],
		N.[DebitField] as [New],
		''
	From
		[deleted] d
		inner join [inserted] n on D.Guid = N.Guid
	where
		N.[DebitField] <> D.[DebitField]
		
	insert into [TraceDetail]
	([ParentGuid],[Caption],[Old],[New],[Tbl])
	Select Top 1
		@Guid,
		'  ' as [Caption],
		D.[CreditField] as [old],
		N.[CreditField] as [New],
		''
	From
		[deleted] d
		inner join [inserted] n on D.Guid = N.Guid
	where
		N.[CreditField] <> D.[CreditField]
		
	insert into [TraceDetail]
	([ParentGuid],[Caption],[Old],[New],[Tbl])
	Select Top 1
		@Guid,
		'  ' as [Caption],
		D.[DebitCaption] as [old],
		N.[DebitCaption] as [New],
		''
	From
		[deleted] d
		inner join [inserted] n on D.Guid = N.Guid
	where
		N.[DebitCaption] <> D.[DebitCaption]
		
	insert into [TraceDetail]
	([ParentGuid],[Caption],[Old],[New],[Tbl])
	Select Top 1
		@Guid,
		'  ' as [Caption],
		D.[CreditCaption] as [old],
		N.[CreditCaption] as [New],
		''
	From
		[deleted] d
		inner join [inserted] n on D.Guid = N.Guid
	where
		N.[CreditCaption] <> D.[CreditCaption]
		
	insert into [TraceDetail]
	([ParentGuid],[Caption],[Old],[New],[Tbl])
	Select Top 1
		@Guid,
		'   ' as [Caption],
		D.[LtnDebitCaption] as [old],
		N.[LtnDebitCaption] as [New],
		''
	From
		[deleted] d
		inner join [inserted] n on D.Guid = N.Guid
	where
		N.[LtnDebitCaption] <> D.[LtnDebitCaption]
		
	insert into [TraceDetail]
	([ParentGuid],[Caption],[Old],[New],[Tbl])
	Select Top 1
		@Guid,
		'   ' as [Caption],
		D.[LtnCreditCaption] as [old],
		N.[LtnCreditCaption] as [New],
		''
	From
		[deleted] d
		inner join [inserted] n on D.Guid = N.Guid
	where
		N.[LtnCreditCaption] <> D.[LtnCreditCaption]
		
	insert into [TraceDetail]
	([ParentGuid],[Caption],[Old],[New],[Tbl])
	Select Top 1
		@Guid,
		' ' as [Caption],
		D.[CkCurrency] as [old],
		N.[CkCurrency] as [New],
		''
	From
		[deleted] d
		inner join [inserted] n on D.Guid = N.Guid
	where
		N.[CkCurrency] <> D.[CkCurrency]
		
	insert into [TraceDetail]
	([ParentGuid],[Caption],[Old],[New],[Tbl])
	Select Top 1
		@Guid,
		'  ' as [Caption],
		D.[CkCost] as [old],
		N.[CkCost] as [New],
		''
	From
		[deleted] d
		inner join [inserted] n on D.Guid = N.Guid
	where
		N.[CkCost] <> D.[CkCost]
		
	insert into [TraceDetail]
	([ParentGuid],[Caption],[Old],[New],[Tbl])
	Select Top 1
		@Guid,
		' ' as [Caption],
		D.[CkNote] as [old],
		N.[CkNote] as [New],
		''
	From
		[deleted] d
		inner join [inserted] n on D.Guid = N.Guid
	where
		N.[CkNote] <> D.[CkNote]
		
	insert into [TraceDetail]
	([ParentGuid],[Caption],[Old],[New],[Tbl])
	Select Top 1
		@Guid,
		'  1' as [Caption],
		D.[Color1] as [old],
		N.[Color1] as [New],
		''
	From
		[deleted] d
		inner join [inserted] n on D.Guid = N.Guid
	where
		N.[Color1] <> D.[Color1]
		
	insert into [TraceDetail]
	([ParentGuid],[Caption],[Old],[New],[Tbl])
	Select Top 1
		@Guid,
		'  2' as [Caption],
		D.[Color2] as [old],
		N.[Color2] as [New],
		''
	From
		[deleted] d
		inner join [inserted] n on D.Guid = N.Guid
	where
		N.[Color2] <> D.[Color2]
		
	insert into [TraceDetail]
	([ParentGuid],[Caption],[Old],[New],[Tbl])
	Select Top 1
		@Guid,
		'   ' as [Caption],
		D.[AutoPostedEntry] as [old],
		N.[AutoPostedEntry] as [New],
		''
	From
		[deleted] d
		inner join [inserted] n on D.Guid = N.Guid
	where
		N.[AutoPostedEntry] <> D.[AutoPostedEntry]
		
	insert into [TraceDetail]
	([ParentGuid],[Caption],[Old],[New],[Tbl])
	Select Top 1
		@Guid,
		'     ' as [Caption],
		D.[OpMoveCostwithDefAccount] as [old],
		N.[OpMoveCostwithDefAccount] as [New],
		''
	From
		[deleted] d
		inner join [inserted] n on D.Guid = N.Guid
	where
		N.[OpMoveCostwithDefAccount] <> D.[OpMoveCostwithDefAccount]
		
	insert into [TraceDetail]
	([ParentGuid],[Caption],[Old],[New],[Tbl])
	Select Top 1
		@Guid,
		'     ' as [Caption],
		D.[NeedCostItem] as [old],
		N.[NeedCostItem] as [New],
		''
	From
		[deleted] d
		inner join [inserted] n on D.Guid = N.Guid
	where
		N.[NeedCostItem] <> D.[NeedCostItem]
		
	insert into [TraceDetail]
	([ParentGuid],[Caption],[Old],[New],[Tbl])
	Select Top 1
		@Guid,
		'    ' as [Caption],
		D.[NeedNoteItem] as [old],
		N.[NeedNoteItem] as [New],
		''
	From
		[deleted] d
		inner join [inserted] n on D.Guid = N.Guid
	where
		N.[NeedNoteItem] <> D.[NeedNoteItem]
		
	insert into [TraceDetail]
	([ParentGuid],[Caption],[Old],[New],[Tbl])
	Select Top 1
		@Guid,
		'   ' as [Caption],
		D.[AutoSMSAfterAdd] as [old],
		N.[AutoSMSAfterAdd] as [New],
		''
	From
		[deleted] d
		inner join [inserted] n on D.Guid = N.Guid
	where
		N.[AutoSMSAfterAdd] <> D.[AutoSMSAfterAdd]
		
	insert into [TraceDetail]
	([ParentGuid],[Caption],[Old],[New],[Tbl])
	Select Top 1
		@Guid,
		'  ' as [Caption],
		D.[SMSMsg] as [old],
		N.[SMSMsg] as [New],
		''
	From
		[deleted] d
		inner join [inserted] n on D.Guid = N.Guid
	where
		N.[SMSMsg] <> D.[SMSMsg]
		
	insert into [TraceDetail]
	([ParentGuid],[Caption],[Old],[New],[Tbl])
	Select Top 1
		@Guid,
		'  ' as [Caption],
		D.[SMSMsgEn] as [old],
		N.[SMSMsgEn] as [New],
		''
	From
		[deleted] d
		inner join [inserted] n on D.Guid = N.Guid
	where
		N.[SMSMsgEn] <> D.[SMSMsgEn]
		
	insert into [TraceDetail]
	([ParentGuid],[Caption],[Old],[New],[Tbl])
	Select Top 1
		@Guid,
		'  ' as [Caption],
		D.[DefPrintPath] as [old],
		N.[DefPrintPath] as [New],
		''
	From
		[deleted] d
		inner join [inserted] n on D.Guid = N.Guid
	where
		N.[DefPrintPath] <> D.[DefPrintPath]
		
	delete Trace From Trace t left join [TraceDetail] D on T.guid = D.ParentGuid
	where
		d.ParentGuid is Null and t.Guid = @Guid


GO

SET ANSI_NULLS, QUOTED_IDENTIFIER ON
GO

Create Procedure [PrcCreateChecksEntry]
(
	@CheckGuid uniqueidentifier = '{B20CA0BC-65D0-48B7-B43A-7B94678DB245}'
)
 
AS
	--return
	Set NoCount on 
	Declare 
			@EnNum int,
			@EnGuid [uniqueidentifier]

	--  
	Select 
		@EnNum = isnull(H.Number ,0)
		,@EnGuid = isnull([EntryGuid],0x0)
	From
		[LinkEntry_Checks] L
		inner join HEntry H on H.Guid = L.EntryGuid
	where
		[CheckGuid] = @CheckGuid
		and [Kind] = 1600		
	
	if isnull(@EnNum,0) = 0
	begin	
		Select @EnNum = IsNull(Max([Number]),0) + 1 from [HEntry]
		Set @EnGuid = Newid()
	END

	--return
	--   
	Delete 
		HEntry 
	From
		HEntry E 
		inner join [LinkEntry_Checks] L on L.EntryGuid = E.Guid
	where
		[kind] = 1600
		and L.[CheckGuid] = @CheckGuid

	Delete
		[LinkEntry_Checks]
	where
		[CheckGuid] = @CheckGuid
		AND [kind] = 1600

		
	DECLARE 
		@CreateEntry BIT,
		@AutoPostedEntry Bit,
		@Kind int

	SELECT	TOP 1
		@CreateEntry = [CreatedEntry],
		@AutoPostedEntry = [AutoPostedEntry],
		@Kind = [CheckKind]
	FROM
		[CheckType]
	WHERE
		Guid = (		
				Select 
					[TypeGuid] 
				From 
					[Checks]
				WHERE
					[Guid] =@CheckGuid
				)


	DECLARE
		@SecLvl Int,
		@mark Bit,
		@TypeGuid [uniqueidentifier],
		@NO Varchar(256),
		@InternalNO Varchar(256),
		@Value Float,
		@CurrencyGUID [uniqueidentifier],
		@CurrencyVal [float],
		@Date DateTime,
		@DueDate DateTime,
		@NoneDueDate bit,
		@BankName Varchar(256),
		@Account [uniqueidentifier],
		@CostGuid [uniqueidentifier],
		@ObverseAccount [uniqueidentifier],
		@CostObverseGuid [uniqueidentifier],
		@Beneficiary Varchar(256),
		@Note Varchar(256),
		@Note2 Varchar(256),
		@ContractGuid [uniqueidentifier],
		@UserGuid [uniqueidentifier],
		@BranchGuid [uniqueidentifier],
		@CheckCreateEntry bit

	SELECT 
		@SecLvl = [SecLvl],
		@Mark = [Mark],
		@TypeGuid = [TypeGuid],
		@NO = [NO],
		@InternalNO = [InternalNO],
		@Value = [Value],
		@CurrencyGUID = [CurrencyGUID],
		@CurrencyVal = [CurrencyVal],
		@Date = [Date],
		@DueDate = [DueDate],
		@BankName = [BankName],
		@Account = [Account],
		@CostGuid = [CostGuid],
		@ObverseAccount = [ObverseAccount],
		@CostObverseGuid = [CostObverseGuid],
		@Beneficiary = [Beneficiary],
		@Note = [Note],
		@Note2 = [Note2],
		@ContractGuid  = [ContractGuid],
		@UserGuid = [UserGuid],
		@BranchGuid = [BranchGuid],
		@CheckCreateEntry = [CheckCreateEntry]
	FROM 
		[Checks]
	WHERE
		[Guid] = @CheckGuid
		

	if Not ((@CreateEntry = 1) and (@CheckCreateEntry = 1) )
	return
	

	Insert Into [HEntry]
	([Guid],[SecLvl],[Mark],[Number],[Date], [CurrencyGuid], [CurrencyVal], [Note], [ParentKind], [BranchGuid], [IsPosted])
	Select
		@EnGuid,
		@SecLvl,
		@Mark,
		@EnNum,
		@Date,
		@CurrencyGuid,
		@CurrencyVal,
		'',
		1600,
		@BranchGuid,
		@AutoPostedEntry
				
	Declare @DetailNum Int
	Set @DetailNum = 0
			
	Create Table [#ChecksAccountDetail]
	(
		[Number] int,
		[Kind] int,
		[AccountGuid] [uniqueidentifier] ,
		[ObverseAccountGuid] [uniqueidentifier] ,
		[CostGuid] [uniqueidentifier] ,
		[Value] float,
		[Note] varchar(255)
	)

	insert into #ChecksAccountDetail
	([Number] ,[Kind] ,[AccountGuid] ,[CostGuid] ,[Value] ,[Note])
	Select
		[Number] ,[Kind] ,[AccountGuid] ,[CostGuid] ,[Value] ,[Note]
	From
		ChecksAccountDetail
	where
		ParentGuid = @CheckGuid
		and Kind = 1
		
	if Not exists(Select Top 1 * from #ChecksAccountDetail where Kind = 1)
	insert into #ChecksAccountDetail
	([Number] ,[Kind] ,[AccountGuid] ,[CostGuid] ,[Value] ,[Note])
	Select
		[Number] ,1 ,@Account ,[CostGuid] ,[Value]  ,@Note
	From
		ChecksCostDetail
	where
		ParentGuid = @CheckGuid
		and Kind = 1

	--Select * from #ChecksAccountDetail

	if Not exists(Select Top 1 * from #ChecksAccountDetail where Kind = 1)
	insert into #ChecksAccountDetail
	([Number] ,[Kind] ,[AccountGuid] ,[CostGuid] ,[Value] ,[Note])
	Select
		1 ,1 ,@Account ,@CostGuid ,@Value  ,@Note


	--Kind 2
	insert into #ChecksAccountDetail
	([Number] ,[Kind] ,[AccountGuid] ,[CostGuid] ,[Value] ,[Note])
	Select
		[Number] ,[Kind] ,[AccountGuid] ,[CostGuid] ,[Value] ,[Note]
	From
		ChecksAccountDetail
	where
		ParentGuid = @CheckGuid
		and Kind = 2
		
	if Not exists(Select Top 1 * from #ChecksAccountDetail where Kind = 2)
	insert into #ChecksAccountDetail
	([Number] ,[Kind] ,[AccountGuid] ,[CostGuid] ,[Value] ,[Note])
	Select
		[Number] ,2 ,@ObverseAccount ,[CostGuid] ,[Value]  ,@Note
	From
		ChecksCostDetail
	where
		ParentGuid = @CheckGuid
		and Kind = 2

	if Not exists(Select Top 1 * from #ChecksAccountDetail where Kind = 2)
	insert into #ChecksAccountDetail
	([Number] ,[Kind] ,[AccountGuid] ,[CostGuid] ,[Value] ,[Note])
	Select
		1 ,2 ,@ObverseAccount ,@CostObverseGuid ,@Value  ,@Note2
	---------------			
		
	Declare @RC int
	
	-- 
	Select Distinct AccountGuid into #RK2 From #ChecksAccountDetail where Kind = 2
	Select @RC = Count(*) From #RK2
	
	Set @ObverseAccount = Null
	if @RC = 1
	Set @ObverseAccount = (Select Top 1 AccountGuid From #ChecksAccountDetail where Kind = 2)
	
	Update #ChecksAccountDetail Set ObverseAccountGuid = @ObverseAccount where Kind = 1
	-----------------
	

	-- 
	Select Distinct AccountGuid into #RK1 From #ChecksAccountDetail where Kind = 1
	Select @RC = Count(*) From #RK1
	
	Set @ObverseAccount = Null
	if @RC = 1
	Set @ObverseAccount = (Select Top 1 AccountGuid From #ChecksAccountDetail where Kind = 1)
	
	Update #ChecksAccountDetail Set ObverseAccountGuid = @ObverseAccount where Kind = 2
	-----------------

	--Select * from #ChecksAccountDetail
		
	-- 
	Insert into [DEntry]
	([ParentGuid],[Number],[AcGuid],[Debit],[Credit],[CurrencyGuid],[CurrencyVal],[CostGuid],[ObverseAcGuid],[Note])
	Select
		@EnGuid,
		[Number],
		[AccountGuid],
		[Value],
		0,
		@CurrencyGuid,
		@CurrencyVal,
		[CostGuid],
		[ObverseAccountGuid],
		[Note]
	From
		#ChecksAccountDetail
	where
		Case when @Kind = 0 then 2 else 1 end = Kind
		
	-- 
	Insert into [DEntry]
	([ParentGuid],[Number],[AcGuid],[Debit],[Credit],[CurrencyGuid],[CurrencyVal],[CostGuid],[ObverseAcGuid],[Note])
	Select
		@EnGuid,
		99+[Number],
		[AccountGuid],
		0,
		[Value],
		@CurrencyGuid,
		@CurrencyVal,
		[CostGuid],
		[ObverseAccountGuid],
		[Note]
	From
		#ChecksAccountDetail
	where
		Case when @Kind = 0 then 1 else 2 end = Kind
		
		
	INSERT INTO [LinkEntry_Checks]
	(
		[CheckGuid],
		[EntryGuid],
		[EntryNum],
		[Kind]
	)
	SELECT	
		@CheckGuid,
		@EnGuid,
		@EnNum,
		1600

	


GO

SET ANSI_NULLS, QUOTED_IDENTIFIER ON
GO

Create Trigger [TRG_Trace_Secondary_Entry]
on [Secondary_Entry]
 
for update
As
	SET NOCOUNT ON;
	if Not exists(Select Value from DMD_const where vName = 'ActiveLogCardUpdate' and Value = '1' ) return
	
	Declare @UserGuid uniqueidentifier, @Guid uniqueidentifier
	Set @Guid = NEWID()
	
	Select Top 1 @UserGuid = userGuid From CurrentUsers where Spid = @@SPID
			
	insert into [Trace]
	([Guid],[ParentGuid],[Date],[userGuid],[HostName],[ParentTbl])
	Select Top 1
		@Guid,
		N.Guid,
		GETDATE(),
		@UserGuid,
		Host_Name(),
		'Secondary_Entry'
	From
		[inserted] n 
		
		
	insert into [TraceDetail]
	([ParentGuid],[Caption],[Old],[New],[Tbl])
	Select Top 1
		@Guid,
		'' as [Caption],
		D.[TypeGuid] as [old],
		N.[TypeGuid] as [New],
		'[EntryType]'
	From
		[deleted] d
		inner join [inserted] n on D.Guid = N.Guid
	where
		N.[TypeGuid] <> D.[TypeGuid]
		
	insert into [TraceDetail]
	([ParentGuid],[Caption],[Old],[New],[Tbl])
	Select Top 1
		@Guid,
		' ' as [Caption],
		D.[SecLvl] as [old],
		N.[SecLvl] as [New],
		''
	From
		[deleted] d
		inner join [inserted] n on D.Guid = N.Guid
	where
		N.[SecLvl] <> D.[SecLvl]
		
	insert into [TraceDetail]
	([ParentGuid],[Caption],[Old],[New],[Tbl])
	Select Top 1
		@Guid,
		'' as [Caption],
		D.[Mark] as [old],
		N.[Mark] as [New],
		''
	From
		[deleted] d
		inner join [inserted] n on D.Guid = N.Guid
	where
		N.[Mark] <> D.[Mark]
		
		
	insert into [TraceDetail]
	([ParentGuid],[Caption],[Old],[New],[Tbl])
	Select Top 1
		@Guid,
		'' as [Caption],
		D.[AccountGuid] as [old],
		N.[AccountGuid] as [New],
		'Account'
	From
		[deleted] d
		inner join [inserted] n on D.Guid = N.Guid
	where
		N.[AccountGuid] <> D.[AccountGuid]
		
	insert into [TraceDetail]
	([ParentGuid],[Caption],[Old],[New],[Tbl])
	Select Top 1
		@Guid,
		'' as [Caption],
		dbo.fndate(D.[Date]) as [old],
		dbo.fndate(N.[Date]) as [New],
		''
	From
		[deleted] d
		inner join [inserted] n on D.Guid = N.Guid
	where
		N.[Date] <> D.[Date]
		
	insert into [TraceDetail]
	([ParentGuid],[Caption],[Old],[New],[Tbl])
	Select Top 1
		@Guid,
		'' as [Caption],
		D.[Note] as [old],
		N.[Note] as [New],
		''
	From
		[deleted] d
		inner join [inserted] n on D.Guid = N.Guid
	where
		N.[Note] <> D.[Note]
		
	insert into [TraceDetail]
	([ParentGuid],[Caption],[Old],[New],[Tbl])
	Select Top 1
		@Guid,
		'' as [Caption],
		D.[CurrencyGuid] as [old],
		N.[CurrencyGuid] as [New],
		'Currency'
	From
		[deleted] d
		inner join [inserted] n on D.Guid = N.Guid
	where
		N.[CurrencyGuid] <> D.[CurrencyGuid]
		
	insert into [TraceDetail]
	([ParentGuid],[Caption],[Old],[New],[Tbl])
	Select Top 1
		@Guid,
		'' as [Caption],
		D.[CurrencyVal] as [old],
		N.[CurrencyVal] as [New],
		''
	From
		[deleted] d
		inner join [inserted] n on D.Guid = N.Guid
	where
		N.[CurrencyVal] <> D.[CurrencyVal]
		
	insert into [TraceDetail]
	([ParentGuid],[Caption],[Old],[New],[Tbl])
	Select Top 1
		@Guid,
		'' as [Caption],
		D.[UserGuid] as [old],
		N.[UserGuid] as [New],
		'[Realty_Users]'
	From
		[deleted] d
		inner join [inserted] n on D.Guid = N.Guid
	where
		N.[UserGuid] <> D.[UserGuid]
		
	insert into [TraceDetail]
	([ParentGuid],[Caption],[Old],[New],[Tbl])
	Select Top 1
		@Guid,
		'' as [Caption],
		D.[BranchGuid] as [old],
		N.[BranchGuid] as [New],
		'Branch'
	From
		[deleted] d
		inner join [inserted] n on D.Guid = N.Guid
	where
		N.[BranchGuid] <> D.[BranchGuid]
		
	insert into [TraceDetail]
	([ParentGuid],[Caption],[Old],[New],[Tbl])
	Select Top 1
		@Guid,
		'' as [Caption],
		D.[SalesManGuid] as [old],
		N.[SalesManGuid] as [New],
		'SalesMan'
	From
		[deleted] d
		inner join [inserted] n on D.Guid = N.Guid
	where
		N.[SalesManGuid] <> D.[SalesManGuid]
		
	insert into [TraceDetail]
	([ParentGuid],[Caption],[Old],[New],[Tbl])
	Select Top 1
		@Guid,
		'' as [Caption],
		D.[ContractGuid] as [old],
		N.[ContractGuid] as [New],
		'vwAllContract'
	From
		[deleted] d
		inner join [inserted] n on D.Guid = N.Guid
	where
		N.[ContractGuid] <> D.[ContractGuid]
		
	insert into [TraceDetail]
	([ParentGuid],[Caption],[Old],[New],[Tbl])
	Select Top 1
		@Guid,
		' ' as [Caption],
		D.[CheckCreateEntry] as [old],
		N.[CheckCreateEntry] as [New],
		''
	From
		[deleted] d
		inner join [inserted] n on D.Guid = N.Guid
	where
		N.[CheckCreateEntry] <> D.[CheckCreateEntry]
		
	insert into [TraceDetail]
	([ParentGuid],[Caption],[Old],[New],[Tbl])
	Select Top 1
		@Guid,
		'' as [Caption],
		D.[IsRounded] as [old],
		N.[IsRounded] as [New],
		''
	From
		[deleted] d
		inner join [inserted] n on D.Guid = N.Guid
	where
		N.[IsRounded] <> D.[IsRounded]
		
	insert into [TraceDetail]
	([ParentGuid],[Caption],[Old],[New],[Tbl])
	Select  Top 1
		@Guid,
		' ' as [Caption],
		D.[Debit] as [old],
		N.[Debit] as [New],
		''
	From
		[deleted] d
		inner join [inserted] n on D.Guid = N.Guid
	where
		N.[Debit] <> D.[Debit]

	insert into [TraceDetail]
	([ParentGuid],[Caption],[Old],[New],[Tbl])
	Select  Top 1
		@Guid,
		' ' as [Caption],
		D.[Credit] as [old],
		N.[Credit] as [New],
		''
	From
		[deleted] d
		inner join [inserted] n on D.Guid = N.Guid
	where
		N.[Credit] <> D.[Credit]
		
	insert into [TraceDetail]
	([ParentGuid],[Caption],[Old],[New],[Tbl])
	Select  Top 1
		@Guid,
		' ' as [Caption],
		D.[Itemcount] as [old],
		N.[Itemcount] as [New],
		''
	From
		[deleted] d
		inner join [inserted] n on D.Guid = N.Guid
	where
		N.[Itemcount] <> D.[Itemcount]
		
	delete Trace From Trace t left join [TraceDetail] D on T.guid = D.ParentGuid
	where
		d.ParentGuid is Null and t.Guid = @Guid


GO

SET ANSI_NULLS, QUOTED_IDENTIFIER ON
GO

Create Procedure [PrcCreateEntryChecksCollection]
(
	@CheckGuid uniqueidentifier = '{4134E164-2A09-4AA7-A64E-938500EB7573}',
	@Kind INT = 1,
	@immediate bit = 0
)
 
as

	Set nocount on
	if Not exists(Select * from ChecksCollection where CheckGuid = @CheckGuid and Kind = @Kind)
	return
	
	Declare @CollectedEntryTypeGuid uniqueidentifier
	if @Kind = 1 -- 
	select
		@CollectedEntryTypeGuid = T.CollectedEntryTypeGuid
	from
		Checks C
		inner join CheckType T on T.Guid = C.TypeGuid
	where
		C.Guid = @CheckGuid
		
	--   
	if @Kind = 1 and isNull(@CollectedEntryTypeGuid, 0x0) <> 0x0
	begin
		--Print @CheckGuid
		--Print @CollectedEntryTypeGuid
		exec [PrcCreateEntryTypeChecksCollection] @CheckGuid, @CollectedEntryTypeGuid, @Kind, @immediate
		return
	end

	/*
	else
	Delete
		[LinkEntryType_Checks]
	where
		[CheckGuid] = @CheckGuid
		AND [kind] = 1660 + @Kind
	*/
	
	Declare 
			@EnNum int,
			@EnGuid [uniqueidentifier]
	
	--  
	Select 
		@EnNum = isnull([EntryNum],0)
		,@EnGuid = isnull([EntryGuid],0x0)
	From
		[LinkEntry_Checks]
	where
		[CheckGuid] = @CheckGuid
		and [Kind] = 1660+@Kind		

	if isnull(@EnNum,0) = 0
	begin	
		Select @EnNum = IsNull(Max([Number]),0) + 1 from [HEntry]
		Set @EnGuid = Newid()
	END
	
--	return
	--   
	Delete
		[LinkEntry_Checks]
	where
		[CheckGuid] = @CheckGuid
		AND [kind] = 1660 + @Kind
		
	--Select * from [HEntry] where Number = @EnNum

	DECLARE 
		@CreateEntry BIT,
		@AutoPostedEntry Bit
	

	SELECT	TOP 1
		@CreateEntry = CASE WHEN @Kind = 0 THEN 
								Case when ([PosdetCreatedEntry] = 1 and ([PosdetAutoCreatedEntry] = 1 OR @immediate = 1)) 
								then 1 else 0 
								end
							WHEN @Kind = 1 THEN 
								Case when ([collectedCreatedEntry] = 1 and ([collectedAutoCreatedEntry] = 1 OR @immediate = 1)) 
								then 1 else 0 
								end
							WHEN @Kind = 2 THEN 
								Case when ([EndorsementCreatedEntry] = 1 and ([EndorsementAutoCreatedEntry] = 1 OR @immediate = 1)) 
								then 1 else 0 
								end
							WHEN @Kind = 3 THEN 
								Case when ([ReturnedCreatedEntry] = 1 and ([ReturnedAutoCreatedEntry] = 1 OR @immediate = 1)) 
								then 1 else 0 
								end
						END,
		@AutoPostedEntry = CASE WHEN @Kind = 0 THEN [PosdetAutoPostedEntry]
							WHEN @Kind = 1 THEN [collectedAutoPostedEntry]
							WHEN @Kind = 2 THEN [EndorsementAutoPostedEntry]
							WHEN @Kind = 3 THEN [ReturnedAutoPostedEntry]
						END
	FROM
		[CheckType] T
		inner join [Checks] C on C.TypeGuid = T.Guid
	WHERE
		C.[Guid] = @CheckGuid

	
	DECLARE
		@CheckKind INT,
		@SecLvl Int,
		@mark Bit,
		@Value Float,
		@CurrencyGUID [uniqueidentifier],
		@CurrencyVal [float],
		@Date DateTime,

		@DebitAccountGuid [uniqueidentifier]  ,
		@DebitCostGuid [uniqueidentifier]  ,
		@CreditAccountGuid [uniqueidentifier]  ,
		@CreditCostGuid [uniqueidentifier]  ,
		@Commission Float,
		@CommCostGuid [uniqueidentifier],
		@CommCostCreditGuid [uniqueidentifier],
		@CommNote Varchar(256),
		@LossComm Bit,
		@CommType int,
		@CommAccountGuid [uniqueidentifier],
		@CommAccountCreditGuid [uniqueidentifier],
		@Note Varchar(256),
		@Delay FLOAT,
		@DelayNote Varchar(256),
		@DelayAccountDebitGuid [uniqueidentifier]  ,
		@DelayAccountCreditGuid [uniqueidentifier] ,
		@DelayCostGuid [uniqueidentifier]  ,
		@BranchGuid [uniqueidentifier],
		
		@OperationCreateEntry bit,
		@ReturnCreateEntry bit,
		@CommCreateEntry bit,

		@IsRounded bit

	SELECT
		@CheckKind				= [T].[CheckKind],
		@SecLvl					= [L].[SecLvl],
		@Mark					= [L].[Mark],
		@Value					= [C].[Value],
		@CurrencyGUID			= [C].[CurrencyGUID],
		@CurrencyVal			= [C].[CurrencyVal],
		@Date					= [L].[Date],

		@DebitAccountGuid		= [L].[DebitAccountGuid],
		@DebitCostGuid			= [L].[DebitCostGuid],
		@CreditAccountGuid		= [L].[CreditAccountGuid],
		@CreditCostGuid			= [L].[CreditCostGuid],
		@Commission				= [L].[Commission],
		@CommCostGuid			= Case when T.CommMoveCost = 1 then L.[CommCostGuid] end,
		@CommCostCreditGuid			= Case when T.CommMoveCostCredit = 1 then L.[CommCostGuid] end,
		@CommNote 				= [L].[CommNote],
		@LossComm				= [L].[LossComm],
		@CommType				= [T].[CommType],
		@CommAccountGuid		= [L].[CommAccountGuid],
		@CommAccountCreditGuid	= [L].[CommAccountCreditGuid],
		@Note					= [L].[Note],
		@Delay					= [L].[Delay],
		@DelayNote 				= [L].[DelayNote],
		@DelayCostGuid			= [L].[DelayCostGuid],
		@DelayAccountDebitGuid	= [L].[DelayAccountDebitGuid],
		@DelayAccountCreditGuid = [L].[DelayAccountCreditGuid],
		@BranchGuid				= [C].[BranchGuid],
		@IsRounded				= IsNull(L.IsRounded,0),

		@OperationCreateEntry	= L.OperationCreateEntry,
		@ReturnCreateEntry		= L.ReturnCreateEntry,
		@CommCreateEntry		= L.CommCreateEntry

	FROM 
		[Checks] [C]
		INNER JOIN [ChecksCollection] [L] ON [L].[CheckGuid] = [C].[Guid]
		INNER JOIN [CheckType] [T] ON [T].[Guid] = [C].[TypeGuid]
	WHERE
		[C].[Guid] = @CheckGuid
		AND [L].[Kind] = @Kind

	--Select @ReturnCreateEntry
	
	if isNull(@Delay,0) = 0
	Set @ReturnCreateEntry = 0

	if isNull(@Commission,0) = 0
	Set @CommCreateEntry = 0

	--Select @CreateEntry ,  @ReturnCreateEntry , @CommCreateEntry

	if (@IsRounded = 0)
	if (@CreateEntry = 1) or ( (@ReturnCreateEntry = 1 or @CommCreateEntry = 1 ) )
	BEGIN
			--Select 'True'
			Insert Into [HEntry]
			([Guid],[SecLvl],[Number],[Mark],[Date], [CurrencyGuid], [CurrencyVal], [Note], [ParentKind], [BranchGuid], [IsPosted])
			Select
				@EnGuid,
				@SecLvl,
				@EnNum,
				@Mark,
				@Date,
				@CurrencyGuid,
				@CurrencyVal,
				'',
				1660 + @Kind,
				@BranchGuid,
				@AutoPostedEntry
				
			Declare @DetailNum Int
			Set @DetailNum = 0

			Declare @CheckValue Float,
					@CommValue Float

			Set @CheckValue = Case when @LossComm = 1 then
														Case
															when @CommType = 0 then @Value - @Commission
															else @Value
														end
									else
									@Value
							  end

			Set @CommValue = @Commission
				
			if (not (@Kind = 1 and isNull(@CollectedEntryTypeGuid, 0x0) <> 0x0)) --      
				and (@OperationCreateEntry = 1) 
			begin
				Insert into [DEntry]
		 		([ParentGuid],[Number],[AcGuid],[Debit],[Credit],[CurrencyGuid],[CurrencyVal],[CostGuid],[Note],[ObverseAcGuid])
				Select
					@EnGuid,
					@DetailNum,
					@DebitAccountGuid,
					@CheckValue,
					0,
					@CurrencyGuid,
					@CurrencyVal,
					@DebitCostGuid,
					@Note,
					@CreditAccountGuid
					
				
				Set @DetailNum = @DetailNum + 1
				Insert into [DEntry]
		 		([ParentGuid],[Number],[AcGuid],[Debit],[Credit],[CurrencyGuid], [CurrencyVal],[CostGuid],[Note],[ObverseAcGuid])
				Select
					@EnGuid,
					@DetailNum,
					@CreditAccountGuid,
					0,
					@CheckValue,
					@CurrencyGuid,
					@CurrencyVal,
					@CreditCostGuid,
					@Note,
					@DebitAccountGuid
			end

			
			IF (@CommCreateEntry = 1) and (@LossComm = 1)  --  
			BEGIN
				Set @DetailNum = @DetailNum + 1
				Insert into [DEntry]
		 		([ParentGuid],[Number],[AcGuid],[Debit],[Credit],[CurrencyGuid], [CurrencyVal],[CostGuid],[Note],[ObverseAcGuid])
				Select
					@EnGuid,
					@DetailNum,
					@CommAccountGuid,
					@CommValue,					
					0,
					@CurrencyGuid,
					@CurrencyVal,
					@CommCostGuid,
					@CommNote,
					@CommAccountCreditGuid

					Set @DetailNum = @DetailNum + 1
					Insert into [DEntry]
			 		([ParentGuid],[Number],[AcGuid],[Debit],[Credit],[CurrencyGuid], [CurrencyVal],[CostGuid],[Note],[ObverseAcGuid])
					Select
						@EnGuid,
						@DetailNum,
						@CommAccountCreditGuid,
						0,
						@Commission,
						@CurrencyGuid,
						@CurrencyVal,
						@CommCostCreditGuid,
						@CommNote,
						@CommAccountGuid
			END

			
			--
			IF (@ReturnCreateEntry = 1) and (@Delay <> 0 )
			BEGIN
				Set @DetailNum = @DetailNum + 1
				Insert into [DEntry]
		 		([ParentGuid],[Number],[AcGuid],[Debit],[Credit],[CurrencyGuid], [CurrencyVal],[CostGuid],[Note],[ObverseAcGuid])
				Select
					@EnGuid,
					@DetailNum,
					@DelayAccountDebitGuid,
					@Delay,
					0,
					@CurrencyGuid,
					@CurrencyVal,
					@DelayCostGuid,
					@DelayNote,
					@DelayAccountCreditGuid

				Set @DetailNum = @DetailNum + 1
				Insert into [DEntry]
		 		([ParentGuid],[Number],[AcGuid],[Debit],[Credit],[CurrencyGuid], [CurrencyVal],[CostGuid],[Note],[ObverseAcGuid])
				Select
					@EnGuid,
					@DetailNum,
					@DelayAccountCreditGuid,
					0,
					@Delay,
					@CurrencyGuid,
					@CurrencyVal,
					@DelayCostGuid,
					@DelayNote,
					@DelayAccountDebitGuid
			END
			
			if @DetailNum = 0
			Delete HEntry where Guid = @EnGuid
			else
			INSERT INTO [LinkEntry_Checks]
			(
				[CheckGuid],
				[EntryGuid],
				[EntryNum],
				[Kind]
			)
			SELECT	
				@CheckGuid,
				@EnGuid,
				@EnNum,
				1660+@Kind
	end


GO

SET ANSI_NULLS, QUOTED_IDENTIFIER ON
GO

Create Proc [PrcIncomList3]
(
	@AccountGuid [uniqueidentifier]= 0X0
	,@BranchGuid [uniqueidentifier] = 0x0
	,@CostGuid [uniqueidentifier] = 0x0
	,@CurrencyGuid [uniqueidentifier] = '11111111-C748-4B13-8B91-1E9B299DF1C1'
	,@CurrencyVal Float = 1
	,@IsPosted Bit = 1
	,@IsNotPosted Bit = 1
	,@Date1 DateTime = '1/2/2007'
	,@Date2 DateTime = '12/30/2019'
    ,@ContainOldEntry Bit = 0
	,@PriceMode int = 1
	,@SpecificPrice int = -1
)
 
as
	set nocount on 
	
	Select * Into dbo.#fnGetAccountList_BS from [dbo].[fnGetAccountList](@AccountGuid)
	Select * Into dbo.#fnGetAccountList from [dbo].[fnGetAccountList](0x0)
	
	Select 
		O.* 
	Into #fnGetCostList_BS 
	from 
		[dbo].[fnGetCostList](@CostGuid) C
		inner join [Cost] O on O.Guid = C.GUID
	
	Set noCount on
	--  
	Select
		[Ac2].[Code] COLLATE database_default as [Code]
		,[Ac2].[Code]+'-'+[Ac2].[Name] COLLATE database_default as [AccountName]
		,[Ac].[Level]
		,isnull([Ac].[Path],'') as [Path]
		,[Ac2].[Guid]
		,[Ac2].[ParentGuid]
		,Case when Type = 0 then [Ac2].[FinalGuid] 
			  when Type = 1 then [Ac2].[ParentGuid] 
		end as [FinalGuid]
		,[Ac2].[Type]
		,Cast('' as Varchar(256)) COLLATE database_default as [Sort]
		,Isnull([SAc].[AcNSons],0) as [AcNSons]
	into #Ac
	From
		#fnGetAccountList [Ac] 
		inner join [vwAccount] [Ac2] on [Ac2].[Guid] = [Ac].[Guid]
		left join [dbo].#fnGetAccountList_BS [AcF] on [AcF].[Guid] = [Ac2].[FinalGuid]   
		left join (Select 
						Count(Number)as [AcNSons] 
						,[ParentGuid] 
					From 
						[Account] [SAc] 
					Group By
						[ParentGuid]					
				)[SAc] on [SAc].[ParentGuid] = [Ac2].[Guid]
--	Select * from #Ac
--	return

	--   
	/*
	Select 
		[Ac].[Guid] as [AcGuid]
		,Sum([En].[D_Debit]*
			Case when [En].[D_CurrencyGuid] = @CurrencyGuid then 1 
			else [En].[D_CurrencyVal] / @CurrencyVal end
			) as [Debit]
		,Sum([En].[D_Credit]*
			Case when [En].[D_CurrencyGuid] = @CurrencyGuid then 1 
			else [En].[D_CurrencyVal] / @CurrencyVal end
			) as [Credit]
	into #EntryOldYear
	from 
		[vwOldYearEntry] En
		inner Join [dbo].#fnGetAccountList [Ac] on [Ac].[Guid] = [En].[D_AcGuid]
		left Join #fnGetCostList_BS [Co2] on [Co2].[Guid] = [En].[D_CostGuid]
	where 
		([En].[H_Date] < @Date1 )
		and ([En].[H_BranchGuid] = @BranchGuid or @BranchGuid = 0x0)
		and ([Co2].[Guid] Is Not Null or @CostGuid = 0x0)
		and ([En].[D_IsVisible] = 1 or [En].[D_CurrencyGuid] = @CurrencyGuid)
		and (
				([En].[H_IsPosted] = 1 and @IsPosted = 1)
				or ([En].[H_IsPosted] = 0  and @IsNotPosted = 1)
			)
		and (En.isOldEntry = 0 or @ContainOldEntry = 1)
	Group By
		[Ac].[Guid]
	*/
	
	--  
	Select 
		[Ac].[Guid] as [AcGuid]
		,Sum([En].[D_Debit]*
			Case when [En].[D_CurrencyGuid] = @CurrencyGuid then 1 
			else [En].[D_CurrencyVal] / @CurrencyVal end
			) as [Debit]
		,Sum([En].[D_Credit]*
			Case when [En].[D_CurrencyGuid] = @CurrencyGuid then 1 
			else [En].[D_CurrencyVal] / @CurrencyVal end
			) as [Credit]
	into #Entry
	from 
		--[DEntry] [En]
		--inner Join [VwEntry] [M] on [M].[Guid] = [En].[ParentGuid]
		[vwOldYearEntry] En
		inner Join [dbo].#fnGetAccountList [Ac] on [Ac].[Guid] = [En].[D_AcGuid]
		left Join #fnGetCostList_BS [Co2] on [Co2].[Guid] = [En].[D_CostGuid]
	where 
		([En].[H_Date] between @Date1 And @Date2)
		and ([En].[H_BranchGuid] = @BranchGuid or @BranchGuid = 0x0)
		and ([Co2].[Guid] Is Not Null or @CostGuid = 0x0)
		and ([En].[D_IsVisible] = 1 or [En].[D_CurrencyGuid] = @CurrencyGuid)
		and (
				([En].[H_IsPosted] = 1 and @IsPosted = 1)
				or ([En].[H_IsPosted] = 0  and @IsNotPosted = 1)
			)
		and (En.isOldEntry = 0 or @ContainOldEntry = 1)
	Group By
		[Ac].[Guid]
		
	Create Table #IncList
	(
		[Name] varchar(255),
		[Balance] Float,
		[Band] float,
		[Code] varchar(255),
		[Sort] int,
		[Guid] uniqueidentifier,
		[Level] int
	)
	
	--    
	insert into #IncList	
	([Name],[Balance], [Band],[Code],[Sort],[level])
	Select 
		dbo.SC('    '),
		Null as [Balance], 
		1 as [Band],
		'1',
		1 [Sort],
		0 

	-- 
	Create Table #YearRes
	(
		Name varchar(255),
		balance float,
		Band Float,
		Code varchar(255),
		[Sort] Float,
		Guid uniqueidentifier,
		level int
	)
	
	Select
		*,
		Case when Band between 0 and 3 then 0 else 1 end as BalanceCalcoldYear
	into #incAccount
	From
		incAccount A
	
	insert into #YearRes
	exec [PrcIncomList]	@AccountGuid ,@BranchGuid ,@CostGuid ,@CurrencyGuid ,@CurrencyVal ,@IsPosted ,@IsNotPosted ,@Date1 ,@Date2 ,@ContainOldEntry ,@PriceMode ,@SpecificPrice 
	
	
	insert into #IncList	
	([Name],[Balance], [Band],[Code],[Sort],[level])
	Select 
		dbo.SC('  ()'),
		[Balance], 
		1 as [Band],
		'0301',
		1 [Sort],
		1 
	from 
		#YearRes	
	where
		Band= 3.1

	--    
	insert into #IncList
	([Name],[Balance], [Band],[Code],[Sort],[Guid],[level])
	Select 
		A.Name,
		SUM([Debit] - [Credit]) as Balance,
		1 as Band,
		A.[Code],
		1,
		A.[Guid],
		1
	from
		#incAccount A 
		left join IncAccountListDetail i on  A.Guid = I.ParentGuid
		left join #Entry E on I.AccountGuid = E.AcGuid
	where
		(Band2 = 1)
		and (isNull(BalanceCalcoldYear,0) = 0)
	Group by
		A.Name,A.Code, A.Band, A.[Guid]
		
	--    
	--      
	insert into #IncList
	([Name],[Balance], [Band],[Code],[Sort],[Guid],[level])
	Select 
		A.Name,
		-isNull(SUM(E.[Debit] - E.[Credit]),0) 
		--isNull(SUM(EO.[Debit] - EO.[Credit]),0)
		 as Balance,
		1 as Band,
		A.[Code],
		1,
		A.[Guid],
		1
	from
		#incAccount A 
		left join IncAccountListDetail i on  A.Guid = I.ParentGuid
		left join #Entry E on I.AccountGuid = E.AcGuid
		--left join #EntryOldYear EO on I.AccountGuid = EO.AcGuid
	where
		(Band2 = 1)
		and (isNull(BalanceCalcoldYear,0) = 1)
	Group by
		A.Name,A.Code, A.Band, A.[Guid]

	--    
	insert into #IncList	
	([Name],[Balance], [Band],[Code],[Sort])
	Select 
		dbo.SC('    '),
		Sum([Balance]), 
		[Band],
		'',
		2 [Sort] 
	from 
		#IncList	
	where
		Band = 1
	group by
		[Band]
	
	
	--    
	insert into #IncList
	([Name],[Balance], [Band],[Code],[Sort],[Guid])
	Select 
		A.Name,
		--isNull(SUM(EO.[Debit] - EO.[Credit]),0) - 
		-isNull(SUM(E.[Debit] - E.[Credit]),0) as Balance,
		2 as Band,
		A.[Code],
		1,
		A.[Guid]
	from
		#incAccount A 
		left join IncAccountListDetail i on  A.Guid = I.ParentGuid
		left join #Entry E on I.AccountGuid = E.AcGuid
		--left join #EntryOldYear EO on I.AccountGuid = EO.AcGuid
	where
		(Band2 = 2)
		and (isNull(BalanceCalcoldYear,0) = 0)
	Group by
		A.Name,A.Code, A.Band, A.[Guid]

	--    
	insert into #IncList	
	([Name],[Balance], [Band],[Code],[Sort])
	Select 
		dbo.SC('    '),
		Sum([Balance]), 
		[Band],
		'',
		2 [Sort] 
	from 
		#IncList	
	where
		Band = 2
	group by
		[Band]	


	--------------------------------------------
	--   
	insert into #IncList	
	([Name],[Balance], [Band],[Code],[Sort],[level])
	Select 
		dbo.SC('   '),
		Null as [Balance], 
		2 as [Band],
		'05',
		1 [Sort],
		0 
	
	--   
	--      
	insert into #IncList
	([Name],[Balance], [Band],[Code],[Sort],[Guid],[level])
	Select 
		A.Name,
		--isNull(SUM(EO.[Debit] - EO.[Credit]),0) - 
		-isNull(SUM(E.[Debit] - E.[Credit]),0) as Balance,
		2 as Band,
		A.[Code],
		1,
		A.[Guid],
		1
	from
		#incAccount A 
		left join IncAccountListDetail i on  A.Guid = I.ParentGuid
		left join #Entry E on I.AccountGuid = E.AcGuid
		--left join #EntryOldYear EO on I.AccountGuid = EO.AcGuid
	where
		(Band2 = 2)
		and (isNull(BalanceCalcoldYear,0) = 1)
	Group by
		A.Name,A.Code, A.Band, A.[Guid]
	
	--    
	insert into #IncList	
	([Name],[Balance], [Band],[Code],[Sort])
	Select 
		dbo.SC('    '),
		Sum([Balance]), 
		[Band],
		'',
		2 [Sort] 
	from 
		#IncList	
	where
		Band = 2
	group by
		[Band]	
	--------------------------------------------
			


	--   
	insert into #IncList	
	([Name],[Balance], [Band],[Code],[Sort],[level])
	Select 
		dbo.SC('   '),
		Null as [Balance], 
		3 as [Band],
		'1200',
		1 [Sort],
		0 
	
	--   
	--      
	insert into #IncList
	([Name],[Balance], [Band],[Code],[Sort],[Guid],[level])
	Select 
		A.Name,
		--isNull(SUM(EO.[Debit] - EO.[Credit]),0) - 
		- isNull(SUM(E.[Debit] - E.[Credit]),0) as Balance,
		3 as Band,
		A.[Code],
		1,
		A.[Guid],
		1
	from
		#incAccount A 
		left join IncAccountListDetail i on  A.Guid = I.ParentGuid
		left join #Entry E on I.AccountGuid = E.AcGuid
		--left join #EntryOldYear EO on I.AccountGuid = EO.AcGuid
	where
		(Band2 = 3)
		and (isNull(BalanceCalcoldYear,0) = 1)
	Group by
		A.Name,A.Code, A.Band, A.[Guid]
	
	--    
	insert into #IncList	
	([Name],[Balance], [Band],[Code],[Sort])
	Select 
		dbo.SC('    '),
		Sum([Balance]), 
		[Band],
		'',
		2 [Sort] 
	from 
		#IncList	
	where
		Band = 3
	group by
		[Band]	

	--     
	insert into #IncList	
	([Name],[Balance], [Band],[Code],[Sort])
	Select 
		dbo.SC('     '),
		Sum([Balance]), 
		4 as [Band],
		'',
		2 [Sort] 
	from 
		#IncList	
	where
		sort = 1
	--------------------------------------------

	--upDate #IncList	Set [Level] = G.[Level]
	--From
	--	#IncList L
	--	inner join dbo.fnGetIncAccountList(0x0) G on G.GUID= L.Guid
	

	Select * from #IncList	
	order by
		[Band],[Sort],[Level],Code

GO

SET ANSI_NULLS, QUOTED_IDENTIFIER ON
GO

Create Trigger [TRG_Trace_Building]
on [Building]
 
for update
As
	SET NOCOUNT ON;
	if Not exists(Select Value from DMD_const where vName = 'ActiveLogCardUpdate' and Value = '1' ) return
	
	Declare @UserGuid uniqueidentifier, @Guid uniqueidentifier
	Set @Guid = NEWID()
	
	Select Top 1 @UserGuid = userGuid From CurrentUsers where Spid = @@SPID
			
	insert into [Trace]
	([Guid],[ParentGuid],[Date],[userGuid],[HostName],[ParentTbl])
	Select Top 1
		@Guid,
		N.Guid,
		GETDATE(),
		@UserGuid,
		Host_Name(),
		'Building'
	From
		[inserted] n 
		
	insert into [TraceDetail]
	([ParentGuid],[Caption],[Old],[New],[Tbl])
	Select Top 1
		@Guid,
		' ' as [Caption],
		D.[SecLvl] as [old],
		N.[SecLvl] as [New],
		''
	From
		[deleted] d
		inner join [inserted] n on D.Guid = N.Guid
	where
		N.[SecLvl] <> D.[SecLvl]

	insert into [TraceDetail]
	([ParentGuid],[Caption],[Old],[New],[Tbl])
	Select Top 1
		@Guid,
		'' as [Caption],
		D.[Name] as [old],
		N.[Name] as [New],
		''
	From
		[deleted] d
		inner join [inserted] n on D.Guid = N.Guid
	where
		N.[Name] <> D.[Name]

	insert into [TraceDetail]
	([ParentGuid],[Caption],[Old],[New],[Tbl])
	Select Top 1
		@Guid,
		' ' as [Caption],
		D.[LtnName] as [old],
		N.[LtnName] as [New],
		''
	From
		[deleted] d
		inner join [inserted] n on D.Guid = N.Guid
	where
		N.[LtnName] <> D.[LtnName]

	insert into [TraceDetail]
	([ParentGuid],[Caption],[Old],[New],[Tbl])
	Select Top 1
		@Guid,
		' ' as [Caption],
		D.[BuildingCode] as [old],
		N.[BuildingCode] as [New],
		''
	From
		[deleted] d
		inner join [inserted] n on D.Guid = N.Guid
	where
		N.[BuildingCode] <> D.[BuildingCode]

	insert into [TraceDetail]
	([ParentGuid],[Caption],[Old],[New],[Tbl])
	Select Top 1
		@Guid,
		'' as [Caption],
		D.[Emirate] as [old],
		N.[Emirate] as [New],
		''
	From
		[deleted] d
		inner join [inserted] n on D.Guid = N.Guid
	where
		N.[Emirate] <> D.[Emirate]

	insert into [TraceDetail]
	([ParentGuid],[Caption],[Old],[New],[Tbl])
	Select Top 1
		@Guid,
		'' as [Caption],
		D.[Area] as [old],
		N.[Area] as [New],
		''
	From
		[deleted] d
		inner join [inserted] n on D.Guid = N.Guid
	where
		N.[Area] <> D.[Area]

	insert into [TraceDetail]
	([ParentGuid],[Caption],[Old],[New],[Tbl])
	Select Top 1
		@Guid,
		'' as [Caption],
		D.[Suburb] as [old],
		N.[Suburb] as [New],
		''
	From
		[deleted] d
		inner join [inserted] n on D.Guid = N.Guid
	where
		N.[Suburb] <> D.[Suburb]

	insert into [TraceDetail]
	([ParentGuid],[Caption],[Old],[New],[Tbl])
	Select Top 1
		@Guid,
		'' as [Caption],
		D.[Street] as [old],
		N.[Street] as [New],
		''
	From
		[deleted] d
		inner join [inserted] n on D.Guid = N.Guid
	where
		N.[Street] <> D.[Street]

	insert into [TraceDetail]
	([ParentGuid],[Caption],[Old],[New],[Tbl])
	Select Top 1
		@Guid,
		' ' as [Caption],
		D.[LtnEmirate] as [old],
		N.[LtnEmirate] as [New],
		''
	From
		[deleted] d
		inner join [inserted] n on D.Guid = N.Guid
	where
		N.[LtnEmirate] <> D.[LtnEmirate]

	insert into [TraceDetail]
	([ParentGuid],[Caption],[Old],[New],[Tbl])
	Select Top 1
		@Guid,
		' ' as [Caption],
		D.[LtnArea] as [old],
		N.[LtnArea] as [New],
		''
	From
		[deleted] d
		inner join [inserted] n on D.Guid = N.Guid
	where
		N.[LtnArea] <> D.[LtnArea]

	insert into [TraceDetail]
	([ParentGuid],[Caption],[Old],[New],[Tbl])
	Select Top 1
		@Guid,
		' ' as [Caption],
		D.[LtnSuburb] as [old],
		N.[LtnSuburb] as [New],
		''
	From
		[deleted] d
		inner join [inserted] n on D.Guid = N.Guid
	where
		N.[LtnSuburb] <> D.[LtnSuburb]

	insert into [TraceDetail]
	([ParentGuid],[Caption],[Old],[New],[Tbl])
	Select Top 1
		@Guid,
		' ' as [Caption],
		D.[LtnStreet] as [old],
		N.[LtnStreet] as [New],
		''
	From
		[deleted] d
		inner join [inserted] n on D.Guid = N.Guid
	where
		N.[LtnStreet] <> D.[LtnStreet]

	insert into [TraceDetail]
	([ParentGuid],[Caption],[Old],[New],[Tbl])
	Select Top 1
		@Guid,
		' ' as [Caption],
		D.[BasinNo] as [old],
		N.[BasinNo] as [New],
		''
	From
		[deleted] d
		inner join [inserted] n on D.Guid = N.Guid
	where
		N.[BasinNo] <> D.[BasinNo]

	insert into [TraceDetail]
	([ParentGuid],[Caption],[Old],[New],[Tbl])
	Select Top 1
		@Guid,
		' ' as [Caption],
		D.[PieceNo] as [old],
		N.[PieceNo] as [New],
		''
	From
		[deleted] d
		inner join [inserted] n on D.Guid = N.Guid
	where
		N.[PieceNo] <> D.[PieceNo]

	insert into [TraceDetail]
	([ParentGuid],[Caption],[Old],[New],[Tbl])
	Select Top 1
		@Guid,
		' ' as [Caption],
		D.[FloorCount] as [old],
		N.[FloorCount] as [New],
		''
	From
		[deleted] d
		inner join [inserted] n on D.Guid = N.Guid
	where
		N.[FloorCount] <> D.[FloorCount]

	insert into [TraceDetail]
	([ParentGuid],[Caption],[Old],[New],[Tbl])
	Select Top 1
		@Guid,
		' ' as [Caption],
		D.[ApartmentCount] as [old],
		N.[ApartmentCount] as [New],
		''
	From
		[deleted] d
		inner join [inserted] n on D.Guid = N.Guid
	where
		N.[ApartmentCount] <> D.[ApartmentCount]

	insert into [TraceDetail]
	([ParentGuid],[Caption],[Old],[New],[Tbl])
	Select Top 1
		@Guid,
		'    ' as [Caption],
		D.[ApartmentCountOfFloor] as [old],
		N.[ApartmentCountOfFloor] as [New],
		''
	From
		[deleted] d
		inner join [inserted] n on D.Guid = N.Guid
	where
		N.[ApartmentCountOfFloor] <> D.[ApartmentCountOfFloor]

	insert into [TraceDetail]
	([ParentGuid],[Caption],[Old],[New],[Tbl])
	Select Top 1
		@Guid,
		' ' as [Caption],
		D.[ShopCount] as [old],
		N.[ShopCount] as [New],
		''
	From
		[deleted] d
		inner join [inserted] n on D.Guid = N.Guid
	where
		N.[ShopCount] <> D.[ShopCount]

	insert into [TraceDetail]
	([ParentGuid],[Caption],[Old],[New],[Tbl])
	Select Top 1
		@Guid,
		' ' as [Caption],
		D.[Costunity] as [old],
		N.[Costunity] as [New],
		''
	From
		[deleted] d
		inner join [inserted] n on D.Guid = N.Guid
	where
		N.[Costunity] <> D.[Costunity]

	insert into [TraceDetail]
	([ParentGuid],[Caption],[Old],[New],[Tbl])
	Select Top 1
		@Guid,
		'' as [Caption],
		D.[AccountGuid] as [old],
		N.[AccountGuid] as [New],
		'[Account]'
	From
		[deleted] d
		inner join [inserted] n on D.Guid = N.Guid
	where
		N.[AccountGuid] <> D.[AccountGuid]

	insert into [TraceDetail]
	([ParentGuid],[Caption],[Old],[New],[Tbl])
	Select Top 1
		@Guid,
		'' as [Caption],
		D.[AccountBankBuildingGuid] as [old],
		N.[AccountBankBuildingGuid] as [New],
		'[Building]'
	From
		[deleted] d
		inner join [inserted] n on D.Guid = N.Guid
	where
		N.[AccountBankBuildingGuid] <> D.[AccountBankBuildingGuid]

	insert into [TraceDetail]
	([ParentGuid],[Caption],[Old],[New],[Tbl])
	Select Top 1
		@Guid,
		' ' as [Caption],
		D.[BuildingAccountGuid] as [old],
		N.[BuildingAccountGuid] as [New],
		'[Account]'
	From
		[deleted] d
		inner join [inserted] n on D.Guid = N.Guid
	where
		N.[BuildingAccountGuid] <> D.[BuildingAccountGuid]

	insert into [TraceDetail]
	([ParentGuid],[Caption],[Old],[New],[Tbl])
	Select Top 1
		@Guid,
		' ' as [Caption],
		D.[CostGuid] as [old],
		N.[CostGuid] as [New],
		'[Cost]'
	From
		[deleted] d
		inner join [inserted] n on D.Guid = N.Guid
	where
		N.[CostGuid] <> D.[CostGuid]

	insert into [TraceDetail]
	([ParentGuid],[Caption],[Old],[New],[Tbl])
	Select Top 1
		@Guid,
		'  ' as [Caption],
		D.[ParentRentAccountGuid] as [old],
		N.[ParentRentAccountGuid] as [New],
		'[Account]'
	From
		[deleted] d
		inner join [inserted] n on D.Guid = N.Guid
	where
		N.[ParentRentAccountGuid] <> D.[ParentRentAccountGuid]

	insert into [TraceDetail]
	([ParentGuid],[Caption],[Old],[New],[Tbl])
	Select Top 1
		@Guid,
		'   ' as [Caption],
		D.[ParentRentInsuranceAccountGuid] as [old],
		N.[ParentRentInsuranceAccountGuid] as [New],
		'[Account]'
	From
		[deleted] d
		inner join [inserted] n on D.Guid = N.Guid
	where
		N.[ParentRentInsuranceAccountGuid] <> D.[ParentRentInsuranceAccountGuid]

	insert into [TraceDetail]
	([ParentGuid],[Caption],[Old],[New],[Tbl])
	Select Top 1
		@Guid,
		'  ' as [Caption],
		D.[OpOwner] as [old],
		N.[OpOwner] as [New],
		''
	From
		[deleted] d
		inner join [inserted] n on D.Guid = N.Guid
	where
		N.[OpOwner] <> D.[OpOwner]

	insert into [TraceDetail]
	([ParentGuid],[Caption],[Old],[New],[Tbl])
	Select Top 1
		@Guid,
		' ' as [Caption],
		dbo.fnDate(D.[DatePurchase]) as [old],
		dbo.fnDate(N.[DatePurchase]) as [New],
		''
	From
		[deleted] d
		inner join [inserted] n on D.Guid = N.Guid
	where
		N.[DatePurchase] <> D.[DatePurchase]

	insert into [TraceDetail]
	([ParentGuid],[Caption],[Old],[New],[Tbl])
	Select Top 1
		@Guid,
		' ' as [Caption],
		D.[AmountPurchase] as [old],
		N.[AmountPurchase] as [New],
		''
	From
		[deleted] d
		inner join [inserted] n on D.Guid = N.Guid
	where
		N.[AmountPurchase] <> D.[AmountPurchase]

	insert into [TraceDetail]
	([ParentGuid],[Caption],[Old],[New],[Tbl])
	Select Top 1
		@Guid,
		' ' as [Caption],
		D.[CurrencyPurchase] as [old],
		N.[CurrencyPurchase] as [New],
		'Currency'
	From
		[deleted] d
		inner join [inserted] n on D.Guid = N.Guid
	where
		N.[CurrencyPurchase] <> D.[CurrencyPurchase]

	insert into [TraceDetail]
	([ParentGuid],[Caption],[Old],[New],[Tbl])
	Select Top 1
		@Guid,
		'  ' as [Caption],
		D.[CurrencyvalPurchase] as [old],
		N.[CurrencyvalPurchase] as [New],
		''
	From
		[deleted] d
		inner join [inserted] n on D.Guid = N.Guid
	where
		N.[CurrencyvalPurchase] <> D.[CurrencyvalPurchase]

	insert into [TraceDetail]
	([ParentGuid],[Caption],[Old],[New],[Tbl])
	Select Top 1
		@Guid,
		' ' as [Caption],
		D.[CustomerPurchase] as [old],
		N.[CustomerPurchase] as [New],
		'Customer'
	From
		[deleted] d
		inner join [inserted] n on D.Guid = N.Guid
	where
		N.[CustomerPurchase] <> D.[CustomerPurchase]

	insert into [TraceDetail]
	([ParentGuid],[Caption],[Old],[New],[Tbl])
	Select Top 1
		@Guid,
		' ' as [Caption],
		D.[PurchaseNotes] as [old],
		N.[PurchaseNotes] as [New],
		''
	From
		[deleted] d
		inner join [inserted] n on D.Guid = N.Guid
	where
		N.[PurchaseNotes] <> D.[PurchaseNotes]

	insert into [TraceDetail]
	([ParentGuid],[Caption],[Old],[New],[Tbl])
	Select Top 1
		@Guid,
		' ' as [Caption],
		D.[CkReceiptBuilding] as [old],
		N.[CkReceiptBuilding] as [New],
		''
	From
		[deleted] d
		inner join [inserted] n on D.Guid = N.Guid
	where
		N.[CkReceiptBuilding] <> D.[CkReceiptBuilding]

	insert into [TraceDetail]
	([ParentGuid],[Caption],[Old],[New],[Tbl])
	Select Top 1
		@Guid,
		' ' as [Caption],
		dbo.fnDate(D.[ReceiptDate]) as [old],
		dbo.fnDate(N.[ReceiptDate]) as [New],
		''
	From
		[deleted] d
		inner join [inserted] n on D.Guid = N.Guid
	where
		N.[ReceiptDate] <> D.[ReceiptDate]

	insert into [TraceDetail]
	([ParentGuid],[Caption],[Old],[New],[Tbl])
	Select Top 1
		@Guid,
		'' as [Caption],
		D.[ReceiptAmount] as [old],
		N.[ReceiptAmount] as [New],
		''
	From
		[deleted] d
		inner join [inserted] n on D.Guid = N.Guid
	where
		N.[ReceiptAmount] <> D.[ReceiptAmount]

	insert into [TraceDetail]
	([ParentGuid],[Caption],[Old],[New],[Tbl])
	Select Top 1
		@Guid,
		' ' as [Caption],
		D.[CurrencyReceipt] as [old],
		N.[CurrencyReceipt] as [New],
		'Currency'
	From
		[deleted] d
		inner join [inserted] n on D.Guid = N.Guid
	where
		N.[CurrencyReceipt] <> D.[CurrencyReceipt]

	insert into [TraceDetail]
	([ParentGuid],[Caption],[Old],[New],[Tbl])
	Select Top 1
		@Guid,
		'  ' as [Caption],
		D.[CurrencyvalReceipt] as [old],
		N.[CurrencyvalReceipt] as [New],
		''
	From
		[deleted] d
		inner join [inserted] n on D.Guid = N.Guid
	where
		N.[CurrencyvalReceipt] <> D.[CurrencyvalReceipt]

	insert into [TraceDetail]
	([ParentGuid],[Caption],[Old],[New],[Tbl])
	Select Top 1
		@Guid,
		' ' as [Caption],
		D.[ReceiptNote] as [old],
		N.[ReceiptNote] as [New],
		''
	From
		[deleted] d
		inner join [inserted] n on D.Guid = N.Guid
	where
		N.[ReceiptNote] <> D.[ReceiptNote]

	insert into [TraceDetail]
	([ParentGuid],[Caption],[Old],[New],[Tbl])
	Select Top 1
		@Guid,
		'' as [Caption],
		D.[Note] as [old],
		N.[Note] as [New],
		''
	From
		[deleted] d
		inner join [inserted] n on D.Guid = N.Guid
	where
		N.[Note] <> D.[Note]

	insert into [TraceDetail]
	([ParentGuid],[Caption],[Old],[New],[Tbl])
	Select Top 1
		@Guid,
		'' as [Caption],
		D.[OwnerAccountGuid] as [old],
		N.[OwnerAccountGuid] as [New],
		'[Account]'
	From
		[deleted] d
		inner join [inserted] n on D.Guid = N.Guid
	where
		N.[OwnerAccountGuid] <> D.[OwnerAccountGuid]

	insert into [TraceDetail]
	([ParentGuid],[Caption],[Old],[New],[Tbl])
	Select Top 1
		@Guid,
		' ' as [Caption],
		D.[IdentityValue] as [old],
		N.[IdentityValue] as [New],
		''
	From
		[deleted] d
		inner join [inserted] n on D.Guid = N.Guid
	where
		N.[IdentityValue] <> D.[IdentityValue]

	insert into [TraceDetail]
	([ParentGuid],[Caption],[Old],[New],[Tbl])
	Select Top 1
		@Guid,
		' ' as [Caption],
		D.[CurrencyIdentityGUID] as [old],
		N.[CurrencyIdentityGUID] as [New],
		'Currency'
	From
		[deleted] d
		inner join [inserted] n on D.Guid = N.Guid
	where
		N.[CurrencyIdentityGUID] <> D.[CurrencyIdentityGUID]

	insert into [TraceDetail]
	([ParentGuid],[Caption],[Old],[New],[Tbl])
	Select Top 1
		@Guid,
		'  ' as [Caption],
		D.[CurrencyValIdentity] as [old],
		N.[CurrencyValIdentity] as [New],
		''
	From
		[deleted] d
		inner join [inserted] n on D.Guid = N.Guid
	where
		N.[CurrencyValIdentity] <> D.[CurrencyValIdentity]

	insert into [TraceDetail]
	([ParentGuid],[Caption],[Old],[New],[Tbl])
	Select Top 1
		@Guid,
		'  ' as [Caption],
		dbo.fnDate(D.[IdentityBeginDate]) as [old],
		dbo.fnDate(N.[IdentityBeginDate]) as [New],
		''
	From
		[deleted] d
		inner join [inserted] n on D.Guid = N.Guid
	where
		N.[IdentityBeginDate] <> D.[IdentityBeginDate]

	insert into [TraceDetail]
	([ParentGuid],[Caption],[Old],[New],[Tbl])
	Select Top 1
		@Guid,
		'  ' as [Caption],
		dbo.fnDate(D.[IdentityEndDate]) as [old],
		dbo.fnDate(N.[IdentityEndDate]) as [New],
		''
	From
		[deleted] d
		inner join [inserted] n on D.Guid = N.Guid
	where
		N.[IdentityEndDate] <> D.[IdentityEndDate]

	insert into [TraceDetail]
	([ParentGuid],[Caption],[Old],[New],[Tbl])
	Select Top 1
		@Guid,
		'       ' as [Caption],
		dbo.fnDate(D.[UsedEndDate]) as [old],
		dbo.fnDate(N.[UsedEndDate]) as [New],
		''
	From
		[deleted] d
		inner join [inserted] n on D.Guid = N.Guid
	where
		N.[UsedEndDate] <> D.[UsedEndDate]

	insert into [TraceDetail]
	([ParentGuid],[Caption],[Old],[New],[Tbl])
	Select Top 1
		@Guid,
		'   ' as [Caption],
		D.[BHouseFloor] as [old],
		N.[BHouseFloor] as [New],
		''
	From
		[deleted] d
		inner join [inserted] n on D.Guid = N.Guid
	where
		N.[BHouseFloor] <> D.[BHouseFloor]

	insert into [TraceDetail]
	([ParentGuid],[Caption],[Old],[New],[Tbl])
	Select Top 1
		@Guid,
		'     ' as [Caption],
		D.[BHouseFlatCount] as [old],
		N.[BHouseFlatCount] as [New],
		''
	From
		[deleted] d
		inner join [inserted] n on D.Guid = N.Guid
	where
		N.[BHouseFlatCount] <> D.[BHouseFlatCount]

	insert into [TraceDetail]
	([ParentGuid],[Caption],[Old],[New],[Tbl])
	Select Top 1
		@Guid,
		'  ' as [Caption],
		D.[MBalanceFloor] as [old],
		N.[MBalanceFloor] as [New],
		''
	From
		[deleted] d
		inner join [inserted] n on D.Guid = N.Guid
	where
		N.[MBalanceFloor] <> D.[MBalanceFloor]

	insert into [TraceDetail]
	([ParentGuid],[Caption],[Old],[New],[Tbl])
	Select Top 1
		@Guid,
		'    ' as [Caption],
		D.[MBalanceFlatCount] as [old],
		N.[MBalanceFlatCount] as [New],
		''
	From
		[deleted] d
		inner join [inserted] n on D.Guid = N.Guid
	where
		N.[MBalanceFlatCount] <> D.[MBalanceFlatCount]

	insert into [TraceDetail]
	([ParentGuid],[Caption],[Old],[New],[Tbl])
	Select Top 1
		@Guid,
		'  ' as [Caption],
		D.[OfficeFloor] as [old],
		N.[OfficeFloor] as [New],
		''
	From
		[deleted] d
		inner join [inserted] n on D.Guid = N.Guid
	where
		N.[OfficeFloor] <> D.[OfficeFloor]

	insert into [TraceDetail]
	([ParentGuid],[Caption],[Old],[New],[Tbl])
	Select Top 1
		@Guid,
		'   ' as [Caption],
		D.[OfficeCount] as [old],
		N.[OfficeCount] as [New],
		''
	From
		[deleted] d
		inner join [inserted] n on D.Guid = N.Guid
	where
		N.[OfficeCount] <> D.[OfficeCount]

	insert into [TraceDetail]
	([ParentGuid],[Caption],[Old],[New],[Tbl])
	Select Top 1
		@Guid,
		'  ' as [Caption],
		D.[ParkingFloor] as [old],
		N.[ParkingFloor] as [New],
		''
	From
		[deleted] d
		inner join [inserted] n on D.Guid = N.Guid
	where
		N.[ParkingFloor] <> D.[ParkingFloor]

	insert into [TraceDetail]
	([ParentGuid],[Caption],[Old],[New],[Tbl])
	Select Top 1
		@Guid,
		'   ' as [Caption],
		D.[ParkingCount] as [old],
		N.[ParkingCount] as [New],
		''
	From
		[deleted] d
		inner join [inserted] n on D.Guid = N.Guid
	where
		N.[ParkingCount] <> D.[ParkingCount]

	insert into [TraceDetail]
	([ParentGuid],[Caption],[Old],[New],[Tbl])
	Select Top 1
		@Guid,
		'    ' as [Caption],
		D.[ParkingFloorUnder] as [old],
		N.[ParkingFloorUnder] as [New],
		''
	From
		[deleted] d
		inner join [inserted] n on D.Guid = N.Guid
	where
		N.[ParkingFloorUnder] <> D.[ParkingFloorUnder]

	insert into [TraceDetail]
	([ParentGuid],[Caption],[Old],[New],[Tbl])
	Select Top 1
		@Guid,
		'     ' as [Caption],
		D.[ParkingCountUnder] as [old],
		N.[ParkingCountUnder] as [New],
		''
	From
		[deleted] d
		inner join [inserted] n on D.Guid = N.Guid
	where
		N.[ParkingCountUnder] <> D.[ParkingCountUnder]

	insert into [TraceDetail]
	([ParentGuid],[Caption],[Old],[New],[Tbl])
	Select Top 1
		@Guid,
		'  ' as [Caption],
		D.[FlatDriverCount] as [old],
		N.[FlatDriverCount] as [New],
		''
	From
		[deleted] d
		inner join [inserted] n on D.Guid = N.Guid
	where
		N.[FlatDriverCount] <> D.[FlatDriverCount]

	insert into [TraceDetail]
	([ParentGuid],[Caption],[Old],[New],[Tbl])
	Select Top 1
		@Guid,
		'  ' as [Caption],
		D.[FlatServantCount] as [old],
		N.[FlatServantCount] as [New],
		''
	From
		[deleted] d
		inner join [inserted] n on D.Guid = N.Guid
	where
		N.[FlatServantCount] <> D.[FlatServantCount]

	insert into [TraceDetail]
	([ParentGuid],[Caption],[Old],[New],[Tbl])
	Select Top 1
		@Guid,
		' ' as [Caption],
		D.[StoreCount] as [old],
		N.[StoreCount] as [New],
		''
	From
		[deleted] d
		inner join [inserted] n on D.Guid = N.Guid
	where
		N.[StoreCount] <> D.[StoreCount]

	insert into [TraceDetail]
	([ParentGuid],[Caption],[Old],[New],[Tbl])
	Select Top 1
		@Guid,
		'  ' as [Caption],
		D.[CreateEntryPurchase] as [old],
		N.[CreateEntryPurchase] as [New],
		''
	From
		[deleted] d
		inner join [inserted] n on D.Guid = N.Guid
	where
		N.[CreateEntryPurchase] <> D.[CreateEntryPurchase]

	insert into [TraceDetail]
	([ParentGuid],[Caption],[Old],[New],[Tbl])
	Select Top 1
		@Guid,
		'  ' as [Caption],
		D.[CrearteEntryInvestment] as [old],
		N.[CrearteEntryInvestment] as [New],
		''
	From
		[deleted] d
		inner join [inserted] n on D.Guid = N.Guid
	where
		N.[CrearteEntryInvestment] <> D.[CrearteEntryInvestment]

	insert into [TraceDetail]
	([ParentGuid],[Caption],[Old],[New],[Tbl])
	Select Top 1
		@Guid,
		' ' as [Caption],
		D.[OwnerName] as [old],
		N.[OwnerName] as [New],
		''
	From
		[deleted] d
		inner join [inserted] n on D.Guid = N.Guid
	where
		N.[OwnerName] <> D.[OwnerName]

	insert into [TraceDetail]
	([ParentGuid],[Caption],[Old],[New],[Tbl])
	Select Top 1
		@Guid,
		' ' as [Caption],
		D.[CommissionPercent] as [old],
		N.[CommissionPercent] as [New],
		''
	From
		[deleted] d
		inner join [inserted] n on D.Guid = N.Guid
	where
		N.[CommissionPercent] <> D.[CommissionPercent]

	insert into [TraceDetail]
	([ParentGuid],[Caption],[Old],[New],[Tbl])
	Select Top 1
		@Guid,
		' ' as [Caption],
		D.[AccountCommIncomeGuid] as [old],
		N.[AccountCommIncomeGuid] as [New],
		'Account'
	From
		[deleted] d
		inner join [inserted] n on D.Guid = N.Guid
	where
		N.[AccountCommIncomeGuid] <> D.[AccountCommIncomeGuid]

	insert into [TraceDetail]
	([ParentGuid],[Caption],[Old],[New],[Tbl])
	Select Top 1
		@Guid,
		' ' as [Caption],
		D.[BuildingCost] as [old],
		N.[BuildingCost] as [New],
		''
	From
		[deleted] d
		inner join [inserted] n on D.Guid = N.Guid
	where
		N.[BuildingCost] <> D.[BuildingCost]

	insert into [TraceDetail]
	([ParentGuid],[Caption],[Old],[New],[Tbl])
	Select Top 1
		@Guid,
		' ' as [Caption],
		D.[BuildingNo] as [old],
		N.[BuildingNo] as [New],
		''
	From
		[deleted] d
		inner join [inserted] n on D.Guid = N.Guid
	where
		N.[BuildingNo] <> D.[BuildingNo]

	insert into [TraceDetail]
	([ParentGuid],[Caption],[Old],[New],[Tbl])
	Select Top 1
		@Guid,
		' ' as [Caption],
		D.[BondType] as [old],
		N.[BondType] as [New],
		''
	From
		[deleted] d
		inner join [inserted] n on D.Guid = N.Guid
	where
		N.[BondType] <> D.[BondType]

	insert into [TraceDetail]
	([ParentGuid],[Caption],[Old],[New],[Tbl])
	Select Top 1
		@Guid,
		' ' as [Caption],
		D.[BondNo] as [old],
		N.[BondNo] as [New],
		''
	From
		[deleted] d
		inner join [inserted] n on D.Guid = N.Guid
	where
		N.[BondNo] <> D.[BondNo]

	insert into [TraceDetail]
	([ParentGuid],[Caption],[Old],[New],[Tbl])
	Select Top 1
		@Guid,
		' ' as [Caption],
		dbo.fnDate(D.[BondDate]) as [old],
		dbo.fnDate(N.[BondDate]) as [New],
		''
	From
		[deleted] d
		inner join [inserted] n on D.Guid = N.Guid
	where
		N.[BondDate] <> D.[BondDate]

	insert into [TraceDetail]
	([ParentGuid],[Caption],[Old],[New],[Tbl])
	Select Top 1
		@Guid,
		'' as [Caption],
		D.[RentInfoGuid] as [old],
		N.[RentInfoGuid] as [New],
		'[RentInfo]'
	From
		[deleted] d
		inner join [inserted] n on D.Guid = N.Guid
	where
		N.[RentInfoGuid] <> D.[RentInfoGuid]

	insert into [TraceDetail]
	([ParentGuid],[Caption],[Old],[New],[Tbl])
	Select Top 1
		@Guid,
		'' as [Caption],
		D.[OwnerGuid] as [old],
		N.[OwnerGuid] as [New],
		'[Owner]'
	From
		[deleted] d
		inner join [inserted] n on D.Guid = N.Guid
	where
		N.[OwnerGuid] <> D.[OwnerGuid]

	insert into [TraceDetail]
	([ParentGuid],[Caption],[Old],[New],[Tbl])
	Select Top 1
		@Guid,
		'' as [Caption],
		D.[BankName] as [old],
		N.[BankName] as [New],
		''
	From
		[deleted] d
		inner join [inserted] n on D.Guid = N.Guid
	where
		N.[BankName] <> D.[BankName]

	insert into [TraceDetail]
	([ParentGuid],[Caption],[Old],[New],[Tbl])
	Select Top 1
		@Guid,
		' ' as [Caption],
		D.[BankAccCode] as [old],
		N.[BankAccCode] as [New],
		''
	From
		[deleted] d
		inner join [inserted] n on D.Guid = N.Guid
	where
		N.[BankAccCode] <> D.[BankAccCode]

	insert into [TraceDetail]
	([ParentGuid],[Caption],[Old],[New],[Tbl])
	Select Top 1
		@Guid,
		'    ' as [Caption],
		D.[ShowInContract] as [old],
		N.[ShowInContract] as [New],
		''
	From
		[deleted] d
		inner join [inserted] n on D.Guid = N.Guid
	where
		N.[ShowInContract] <> D.[ShowInContract]
		
	delete Trace From Trace t left join [TraceDetail] D on T.guid = D.ParentGuid
	where
		d.ParentGuid is Null and t.Guid = @Guid


GO

SET ANSI_NULLS, QUOTED_IDENTIFIER ON
GO

Create Trigger [TRG_Trace_villa]
on [villa]
 
for update
As
	SET NOCOUNT ON;
	if Not exists(Select Value from DMD_const where vName = 'ActiveLogCardUpdate' and Value = '1' ) return
	
	Declare @UserGuid uniqueidentifier, @Guid uniqueidentifier
	Set @Guid = NEWID()
	
	Select Top 1 @UserGuid = userGuid From CurrentUsers where Spid = @@SPID
			
	insert into [Trace]
	([Guid],[ParentGuid],[Date],[userGuid],[HostName])
	Select Top 1
		@Guid,
		N.Guid,
		GETDATE(),
		@UserGuid,
		Host_Name()
	From
		[inserted] n 
		
	insert into [TraceDetail]
	([ParentGuid],[Caption],[Old],[New],[Tbl])
	Select Top 1
		@Guid,
		' ' as [Caption],
		D.[SecLvl] as [old],
		N.[SecLvl] as [New],
		''
	From
		[deleted] d
		inner join [inserted] n on D.Guid = N.Guid
	where
		N.[SecLvl] <> D.[SecLvl]
		
	insert into [TraceDetail]
	([ParentGuid],[Caption],[Old],[New],[Tbl])
	Select Top 1
		@Guid,
		'' as [Caption],
		D.[Ban] as [old],
		N.[Ban] as [New],
		''
	From
		[deleted] d
		inner join [inserted] n on D.Guid = N.Guid
	where
		N.[Ban] <> D.[Ban]

	insert into [TraceDetail]
	([ParentGuid],[Caption],[Old],[New],[Tbl])
	Select Top 1
		@Guid,
		'  ' as [Caption],
		D.[WaterCounter] as [old],
		N.[WaterCounter] as [New],
		''
	From
		[deleted] d
		inner join [inserted] n on D.Guid = N.Guid
	where
		N.[WaterCounter] <> D.[WaterCounter]
		
	insert into [TraceDetail]
	([ParentGuid],[Caption],[Old],[New],[Tbl])
	Select Top 1
		@Guid,
		'  ' as [Caption],
		D.[ElectricityCounter] as [old],
		N.[ElectricityCounter] as [New],
		''
	From
		[deleted] d
		inner join [inserted] n on D.Guid = N.Guid
	where
		N.[ElectricityCounter] <> D.[ElectricityCounter]
		
	insert into [TraceDetail]
	([ParentGuid],[Caption],[Old],[New],[Tbl])
	Select Top 1
		@Guid,
		' ' as [Caption],
		D.[ComplexName] as [old],
		N.[ComplexName] as [New],
		''
	From
		[deleted] d
		inner join [inserted] n on D.Guid = N.Guid
	where
		N.[ComplexName] <> D.[ComplexName]
		
	insert into [TraceDetail]
	([ParentGuid],[Caption],[Old],[New],[Tbl])
	Select Top 1
		@Guid,
		'' as [Caption],
		D.[Emirate] as [old],
		N.[Emirate] as [New],
		''
	From
		[deleted] d
		inner join [inserted] n on D.Guid = N.Guid
	where
		N.[Emirate] <> D.[Emirate]
		
	insert into [TraceDetail]
	([ParentGuid],[Caption],[Old],[New],[Tbl])
	Select Top 1
		@Guid,
		'' as [Caption],
		D.[Area] as [old],
		N.[Area] as [New],
		''
	From
		[deleted] d
		inner join [inserted] n on D.Guid = N.Guid
	where
		N.[Area] <> D.[Area]
		
	insert into [TraceDetail]
	([ParentGuid],[Caption],[Old],[New],[Tbl])
	Select Top 1
		@Guid,
		'' as [Caption],
		D.[Street] as [old],
		N.[Street] as [New],
		''
	From
		[deleted] d
		inner join [inserted] n on D.Guid = N.Guid
	where
		N.[Street] <> D.[Street]
		
	insert into [TraceDetail]
	([ParentGuid],[Caption],[Old],[New],[Tbl])
	Select Top 1
		@Guid,
		'' as [Caption],
		D.[Suburb] as [old],
		N.[Suburb] as [New],
		''
	From
		[deleted] d
		inner join [inserted] n on D.Guid = N.Guid
	where
		N.[Suburb] <> D.[Suburb]
		
	insert into [TraceDetail]
	([ParentGuid],[Caption],[Old],[New],[Tbl])
	Select Top 1
		@Guid,
		' ' as [Caption],
		D.[PieceNo] as [old],
		N.[PieceNo] as [New],
		''
	From
		[deleted] d
		inner join [inserted] n on D.Guid = N.Guid
	where
		N.[PieceNo] <> D.[PieceNo]
		
	insert into [TraceDetail]
	([ParentGuid],[Caption],[Old],[New],[Tbl])
	Select Top 1
		@Guid,
		' ' as [Caption],
		D.[BasinNo] as [old],
		N.[BasinNo] as [New],
		''
	From
		[deleted] d
		inner join [inserted] n on D.Guid = N.Guid
	where
		N.[BasinNo] <> D.[BasinNo]
		
	insert into [TraceDetail]
	([ParentGuid],[Caption],[Old],[New],[Tbl])
	Select Top 1
		@Guid,
		'' as [Caption],
		D.[VillaNo] as [old],
		N.[VillaNo] as [New],
		''
	From
		[deleted] d
		inner join [inserted] n on D.Guid = N.Guid
	where
		N.[VillaNo] <> D.[VillaNo]
		
	insert into [TraceDetail]
	([ParentGuid],[Caption],[Old],[New],[Tbl])
	Select Top 1
		@Guid,
		' ' as [Caption],
		D.[DocType] as [old],
		N.[DocType] as [New],
		''
	From
		[deleted] d
		inner join [inserted] n on D.Guid = N.Guid
	where
		N.[DocType] <> D.[DocType]
		
	insert into [TraceDetail]
	([ParentGuid],[Caption],[Old],[New],[Tbl])
	Select Top 1
		@Guid,
		' ' as [Caption],
		D.[DocNo] as [old],
		N.[DocNo] as [New],
		''
	From
		[deleted] d
		inner join [inserted] n on D.Guid = N.Guid
	where
		N.[DocNo] <> D.[DocNo]
		
	insert into [TraceDetail]
	([ParentGuid],[Caption],[Old],[New],[Tbl])
	Select Top 1
		@Guid,
		' ' as [Caption],
		dbo.fnDate(D.[DocDate]) as [old],
		dbo.fnDate(N.[DocDate]) as [New],
		''
	From
		[deleted] d
		inner join [inserted] n on D.Guid = N.Guid
	where
		N.[DocDate] <> D.[DocDate]
		
	insert into [TraceDetail]
	([ParentGuid],[Caption],[Old],[New],[Tbl])
	Select Top 1
		@Guid,
		'' as [Caption],
		D.[VillaAccountGuid] as [old],
		N.[VillaAccountGuid] as [New],
		'[Account]'
	From
		[deleted] d
		inner join [inserted] n on D.Guid = N.Guid
	where
		N.[VillaAccountGuid] <> D.[VillaAccountGuid]
		
	insert into [TraceDetail]
	([ParentGuid],[Caption],[Old],[New],[Tbl])
	Select Top 1
		@Guid,
		' ' as [Caption],
		D.[CostGuid] as [old],
		N.[CostGuid] as [New],
		'[Cost]'
	From
		[deleted] d
		inner join [inserted] n on D.Guid = N.Guid
	where
		N.[CostGuid] <> D.[CostGuid]
		
	insert into [TraceDetail]
	([ParentGuid],[Caption],[Old],[New],[Tbl])
	Select Top 1
		@Guid,
		'  ' as [Caption],
		D.[AccountBankVillaGuid] as [old],
		N.[AccountBankVillaGuid] as [New],
		'Account'
	From
		[deleted] d
		inner join [inserted] n on D.Guid = N.Guid
	where
		N.[AccountBankVillaGuid] <> D.[AccountBankVillaGuid]
		
	insert into [TraceDetail]
	([ParentGuid],[Caption],[Old],[New],[Tbl])
	Select Top 1
		@Guid,
		'' as [Caption],
		D.[RentInfoGuid] as [old],
		N.[RentInfoGuid] as [New],
		'RentInfo'
	From
		[deleted] d
		inner join [inserted] n on D.Guid = N.Guid
	where
		N.[RentInfoGuid] <> D.[RentInfoGuid]
		
	insert into [TraceDetail]
	([ParentGuid],[Caption],[Old],[New],[Tbl])
	Select Top 1
		@Guid,
		'' as [Caption],
		D.[BranchGuid] as [old],
		N.[BranchGuid] as [New],
		''
	From
		[deleted] d
		inner join [inserted] n on D.Guid = N.Guid
	where
		N.[BranchGuid] <> D.[BranchGuid]
		
	insert into [TraceDetail]
	([ParentGuid],[Caption],[Old],[New],[Tbl])
	Select Top 1
		@Guid,
		' ' as [Caption],
		D.[FloorCount] as [old],
		N.[FloorCount] as [New],
		''
	From
		[deleted] d
		inner join [inserted] n on D.Guid = N.Guid
	where
		N.[FloorCount] <> D.[FloorCount]
		
	insert into [TraceDetail]
	([ParentGuid],[Caption],[Old],[New],[Tbl])
	Select Top 1
		@Guid,
		' ' as [Caption],
		D.[BalconyCount] as [old],
		N.[BalconyCount] as [New],
		''
	From
		[deleted] d
		inner join [inserted] n on D.Guid = N.Guid
	where
		N.[BalconyCount] <> D.[BalconyCount]
		
	insert into [TraceDetail]
	([ParentGuid],[Caption],[Old],[New],[Tbl])
	Select Top 1
		@Guid,
		'  ' as [Caption],
		D.[RoomCount] as [old],
		N.[RoomCount] as [New],
		''
	From
		[deleted] d
		inner join [inserted] n on D.Guid = N.Guid
	where
		N.[RoomCount] <> D.[RoomCount]
		
	insert into [TraceDetail]
	([ParentGuid],[Caption],[Old],[New],[Tbl])
	Select Top 1
		@Guid,
		'  ' as [Caption],
		D.[OtherRoomCount] as [old],
		N.[OtherRoomCount] as [New],
		''
	From
		[deleted] d
		inner join [inserted] n on D.Guid = N.Guid
	where
		N.[OtherRoomCount] <> D.[OtherRoomCount]
		
	insert into [TraceDetail]
	([ParentGuid],[Caption],[Old],[New],[Tbl])
	Select Top 1
		@Guid,
		'  ' as [Caption],
		D.[ServiceRoomCount] as [old],
		N.[ServiceRoomCount] as [New],
		''
	From
		[deleted] d
		inner join [inserted] n on D.Guid = N.Guid
	where
		N.[ServiceRoomCount] <> D.[ServiceRoomCount]
		
	insert into [TraceDetail]
	([ParentGuid],[Caption],[Old],[New],[Tbl])
	Select Top 1
		@Guid,
		' ' as [Caption],
		D.[BathroomCount] as [old],
		N.[BathroomCount] as [New],
		''
	From
		[deleted] d
		inner join [inserted] n on D.Guid = N.Guid
	where
		N.[BathroomCount] <> D.[BathroomCount]
		
	insert into [TraceDetail]
	([ParentGuid],[Caption],[Old],[New],[Tbl])
	Select Top 1
		@Guid,
		'  ' as [Caption],
		D.[StairsInternal] as [old],
		N.[StairsInternal] as [New],
		''
	From
		[deleted] d
		inner join [inserted] n on D.Guid = N.Guid
	where
		N.[StairsInternal] <> D.[StairsInternal]
		
	insert into [TraceDetail]
	([ParentGuid],[Caption],[Old],[New],[Tbl])
	Select Top 1
		@Guid,
		' ' as [Caption],
		D.[RoomState] as [old],
		N.[RoomState] as [New],
		''
	From
		[deleted] d
		inner join [inserted] n on D.Guid = N.Guid
	where
		N.[RoomState] <> D.[RoomState]
		
	insert into [TraceDetail]
	([ParentGuid],[Caption],[Old],[New],[Tbl])
	Select Top 1
		@Guid,
		' ' as [Caption],
		D.[LandArea] as [old],
		N.[LandArea] as [New],
		''
	From
		[deleted] d
		inner join [inserted] n on D.Guid = N.Guid
	where
		N.[LandArea] <> D.[LandArea]
		
	insert into [TraceDetail]
	([ParentGuid],[Caption],[Old],[New],[Tbl])
	Select Top 1
		@Guid,
		'  ' as [Caption],
		D.[LandAreaBuilding] as [old],
		N.[LandAreaBuilding] as [New],
		''
	From
		[deleted] d
		inner join [inserted] n on D.Guid = N.Guid
	where
		N.[LandAreaBuilding] <> D.[LandAreaBuilding]
		
	insert into [TraceDetail]
	([ParentGuid],[Caption],[Old],[New],[Tbl])
	Select Top 1
		@Guid,
		' ' as [Caption],
		D.[FinishingState] as [old],
		N.[FinishingState] as [New],
		''
	From
		[deleted] d
		inner join [inserted] n on D.Guid = N.Guid
	where
		N.[FinishingState] <> D.[FinishingState]
		
	insert into [TraceDetail]
	([ParentGuid],[Caption],[Old],[New],[Tbl])
	Select Top 1
		@Guid,
		'   ' as [Caption],
		D.[SecurityType] as [old],
		N.[SecurityType] as [New],
		''
	From
		[deleted] d
		inner join [inserted] n on D.Guid = N.Guid
	where
		N.[SecurityType] <> D.[SecurityType]
		
	insert into [TraceDetail]
	([ParentGuid],[Caption],[Old],[New],[Tbl])
	Select Top 1
		@Guid,
		'  ' as [Caption],
		D.[SecuritySystem] as [old],
		N.[SecuritySystem] as [New],
		''
	From
		[deleted] d
		inner join [inserted] n on D.Guid = N.Guid
	where
		N.[SecuritySystem] <> D.[SecuritySystem]
		
	insert into [TraceDetail]
	([ParentGuid],[Caption],[Old],[New],[Tbl])
	Select Top 1
		@Guid,
		'  ' as [Caption],
		D.[wall] as [old],
		N.[wall] as [New],
		''
	From
		[deleted] d
		inner join [inserted] n on D.Guid = N.Guid
	where
		N.[wall] <> D.[wall]
		
	insert into [TraceDetail]
	([ParentGuid],[Caption],[Old],[New],[Tbl])
	Select Top 1
		@Guid,
		'  ' as [Caption],
		D.[wallState] as [old],
		N.[wallState] as [New],
		''
	From
		[deleted] d
		inner join [inserted] n on D.Guid = N.Guid
	where
		N.[wallState] <> D.[wallState]
		
	insert into [TraceDetail]
	([ParentGuid],[Caption],[Old],[New],[Tbl])
	Select Top 1
		@Guid,
		'  ' as [Caption],
		D.[lightingCount] as [old],
		N.[lightingCount] as [New],
		''
	From
		[deleted] d
		inner join [inserted] n on D.Guid = N.Guid
	where
		N.[lightingCount] <> D.[lightingCount]
		
	insert into [TraceDetail]
	([ParentGuid],[Caption],[Old],[New],[Tbl])
	Select Top 1
		@Guid,
		'  ' as [Caption],
		D.[ParkingCount] as [old],
		N.[ParkingCount] as [New],
		''
	From
		[deleted] d
		inner join [inserted] n on D.Guid = N.Guid
	where
		N.[ParkingCount] <> D.[ParkingCount]
		
	insert into [TraceDetail]
	([ParentGuid],[Caption],[Old],[New],[Tbl])
	Select Top 1
		@Guid,
		'  ' as [Caption],
		D.[ParkingArea] as [old],
		N.[ParkingArea] as [New],
		''
	From
		[deleted] d
		inner join [inserted] n on D.Guid = N.Guid
	where
		N.[ParkingArea] <> D.[ParkingArea]
		
	insert into [TraceDetail]
	([ParentGuid],[Caption],[Old],[New],[Tbl])
	Select Top 1
		@Guid,
		' ' as [Caption],
		D.[ParkingShaded] as [old],
		N.[ParkingShaded] as [New],
		''
	From
		[deleted] d
		inner join [inserted] n on D.Guid = N.Guid
	where
		N.[ParkingShaded] <> D.[ParkingShaded]
		
	insert into [TraceDetail]
	([ParentGuid],[Caption],[Old],[New],[Tbl])
	Select Top 1
		@Guid,
		' ' as [Caption],
		D.[PoolCount] as [old],
		N.[PoolCount] as [New],
		''
	From
		[deleted] d
		inner join [inserted] n on D.Guid = N.Guid
	where
		N.[PoolCount] <> D.[PoolCount]
		
	insert into [TraceDetail]
	([ParentGuid],[Caption],[Old],[New],[Tbl])
	Select Top 1
		@Guid,
		' ' as [Caption],
		D.[PoolState] as [old],
		N.[PoolState] as [New],
		''
	From
		[deleted] d
		inner join [inserted] n on D.Guid = N.Guid
	where
		N.[PoolState] <> D.[PoolState]
		
	insert into [TraceDetail]
	([ParentGuid],[Caption],[Old],[New],[Tbl])
	Select Top 1
		@Guid,
		'  ' as [Caption],
		D.[PoolSystem] as [old],
		N.[PoolSystem] as [New],
		''
	From
		[deleted] d
		inner join [inserted] n on D.Guid = N.Guid
	where
		N.[PoolSystem] <> D.[PoolSystem]
		
	insert into [TraceDetail]
	([ParentGuid],[Caption],[Old],[New],[Tbl])
	Select Top 1
		@Guid,
		' ' as [Caption],
		D.[PlaygroundCount] as [old],
		N.[PlaygroundCount] as [New],
		''
	From
		[deleted] d
		inner join [inserted] n on D.Guid = N.Guid
	where
		N.[PlaygroundCount] <> D.[PlaygroundCount]
		
	insert into [TraceDetail]
	([ParentGuid],[Caption],[Old],[New],[Tbl])
	Select Top 1
		@Guid,
		' ' as [Caption],
		D.[PlaygroundArea] as [old],
		N.[PlaygroundArea] as [New],
		''
	From
		[deleted] d
		inner join [inserted] n on D.Guid = N.Guid
	where
		N.[PlaygroundArea] <> D.[PlaygroundArea]
		
	insert into [TraceDetail]
	([ParentGuid],[Caption],[Old],[New],[Tbl])
	Select Top 1
		@Guid,
		' ' as [Caption],
		D.[GardenCount] as [old],
		N.[GardenCount] as [New],
		''
	From
		[deleted] d
		inner join [inserted] n on D.Guid = N.Guid
	where
		N.[GardenCount] <> D.[GardenCount]
		
	insert into [TraceDetail]
	([ParentGuid],[Caption],[Old],[New],[Tbl])
	Select Top 1
		@Guid,
		' ' as [Caption],
		D.[GardenArea] as [old],
		N.[GardenArea] as [New],
		''
	From
		[deleted] d
		inner join [inserted] n on D.Guid = N.Guid
	where
		N.[GardenArea] <> D.[GardenArea]
		
	insert into [TraceDetail]
	([ParentGuid],[Caption],[Old],[New],[Tbl])
	Select Top 1
		@Guid,
		' ' as [Caption],
		D.[GardenState] as [old],
		N.[GardenState] as [New],
		''
	From
		[deleted] d
		inner join [inserted] n on D.Guid = N.Guid
	where
		N.[GardenState] <> D.[GardenState]
		
	insert into [TraceDetail]
	([ParentGuid],[Caption],[Old],[New],[Tbl])
	Select Top 1
		@Guid,
		' ' as [Caption],
		D.[OfferType] as [old],
		N.[OfferType] as [New],
		''
	From
		[deleted] d
		inner join [inserted] n on D.Guid = N.Guid
	where
		N.[OfferType] <> D.[OfferType]
		
	insert into [TraceDetail]
	([ParentGuid],[Caption],[Old],[New],[Tbl])
	Select Top 1
		@Guid,
		' ' as [Caption],
		D.[OfferState] as [old],
		N.[OfferState] as [New],
		''
	From
		[deleted] d
		inner join [inserted] n on D.Guid = N.Guid
	where
		N.[OfferState] <> D.[OfferState]
		
	insert into [TraceDetail]
	([ParentGuid],[Caption],[Old],[New],[Tbl])
	Select Top 1
		@Guid,
		'' as [Caption],
		D.[Restrained] as [old],
		N.[Restrained] as [New],
		''
	From
		[deleted] d
		inner join [inserted] n on D.Guid = N.Guid
	where
		N.[Restrained] <> D.[Restrained]
		
	insert into [TraceDetail]
	([ParentGuid],[Caption],[Old],[New],[Tbl])
	Select Top 1
		@Guid,
		' ' as [Caption],
		D.[RestrainedUserGuid] as [old],
		N.[RestrainedUserGuid] as [New],
		''
	From
		[deleted] d
		inner join [inserted] n on D.Guid = N.Guid
	where
		N.[RestrainedUserGuid] <> D.[RestrainedUserGuid]
		
	insert into [TraceDetail]
	([ParentGuid],[Caption],[Old],[New],[Tbl])
	Select Top 1
		@Guid,
		'' as [Caption],
		D.[CustomerName] as [old],
		N.[CustomerName] as [New],
		''
	From
		[deleted] d
		inner join [inserted] n on D.Guid = N.Guid
	where
		N.[CustomerName] <> D.[CustomerName]
		
	insert into [TraceDetail]
	([ParentGuid],[Caption],[Old],[New],[Tbl])
	Select Top 1
		@Guid,
		' ' as [Caption],
		D.[CustomerPhone] as [old],
		N.[CustomerPhone] as [New],
		''
	From
		[deleted] d
		inner join [inserted] n on D.Guid = N.Guid
	where
		N.[CustomerPhone] <> D.[CustomerPhone]
		
	insert into [TraceDetail]
	([ParentGuid],[Caption],[Old],[New],[Tbl])
	Select Top 1
		@Guid,
		'' as [Caption],
		D.[Details] as [old],
		N.[Details] as [New],
		''
	From
		[deleted] d
		inner join [inserted] n on D.Guid = N.Guid
	where
		N.[Details] <> D.[Details]
		
	insert into [TraceDetail]
	([ParentGuid],[Caption],[Old],[New],[Tbl])
	Select Top 1
		@Guid,
		'' as [Caption],
		D.[LtnArea] as [old],
		N.[LtnArea] as [New],
		''
	From
		[deleted] d
		inner join [inserted] n on D.Guid = N.Guid
	where
		N.[LtnArea] <> D.[LtnArea]
		
	insert into [TraceDetail]
	([ParentGuid],[Caption],[Old],[New],[Tbl])
	Select Top 1
		@Guid,
		'' as [Caption],
		D.[LtnEmirate] as [old],
		N.[LtnEmirate] as [New],
		''
	From
		[deleted] d
		inner join [inserted] n on D.Guid = N.Guid
	where
		N.[LtnEmirate] <> D.[LtnEmirate]
		
	insert into [TraceDetail]
	([ParentGuid],[Caption],[Old],[New],[Tbl])
	Select Top 1
		@Guid,
		'' as [Caption],
		D.[LtnSuburb] as [old],
		N.[LtnSuburb] as [New],
		''
	From
		[deleted] d
		inner join [inserted] n on D.Guid = N.Guid
	where
		N.[LtnSuburb] <> D.[LtnSuburb]
		
	insert into [TraceDetail]
	([ParentGuid],[Caption],[Old],[New],[Tbl])
	Select Top 1
		@Guid,
		'' as [Caption],
		D.[LtnStreet] as [old],
		N.[LtnStreet] as [New],
		''
	From
		[deleted] d
		inner join [inserted] n on D.Guid = N.Guid
	where
		N.[LtnStreet] <> D.[LtnStreet]
		
	insert into [TraceDetail]
	([ParentGuid],[Caption],[Old],[New],[Tbl])
	Select Top 1
		@Guid,
		' ' as [Caption],
		D.[LtnDocType] as [old],
		N.[LtnDocType] as [New],
		''
	From
		[deleted] d
		inner join [inserted] n on D.Guid = N.Guid
	where
		N.[LtnDocType] <> D.[LtnDocType]
		
	insert into [TraceDetail]
	([ParentGuid],[Caption],[Old],[New],[Tbl])
	Select Top 1
		@Guid,
		'' as [Caption],
		D.[CuOwnerGuid] as [old],
		N.[CuOwnerGuid] as [New],
		'Customer'
	From
		[deleted] d
		inner join [inserted] n on D.Guid = N.Guid
	where
		N.[CuOwnerGuid] <> D.[CuOwnerGuid]
		
	insert into [TraceDetail]
	([ParentGuid],[Caption],[Old],[New],[Tbl])
	Select Top 1
		@Guid,
		'' as [Caption],
		D.[unity] as [old],
		N.[unity] as [New],
		''
	From
		[deleted] d
		inner join [inserted] n on D.Guid = N.Guid
	where
		N.[unity] <> D.[unity]
		
	delete Trace From Trace t left join [TraceDetail] D on T.guid = D.ParentGuid
	where
		d.ParentGuid is Null and t.Guid = @Guid


GO

SET ANSI_NULLS, QUOTED_IDENTIFIER ON
GO

Create Procedure [DistributionWalletProfit]
(
	@Guid uniqueidentifier = '60D735E2-766D-4B24-8F56-7F4CCDD808D0',
	@RoundKind int = 0
)
 
as
	CREATE TABLE #FlatWallet
	(
		[Building] [varchar](256) NULL,
		[Flat] [varchar](513) NULL,
		[MainCost] [float] NULL,
		[Expense] [float] NULL,
		[BeginDate] [datetime] NULL,
		[SaleDate] [datetime] NULL,
		[DayCount] [int] NULL,
		[SaleValue] [float] NULL,
		[Profit] [float] NULL,
		[BuildingGuid] [uniqueidentifier] NULL,
		[FlatGuid] [uniqueidentifier] NULL
	)

	insert into #FlatWallet
	exec [PrcGetFlatWallet] @Guid

	insert into #FlatWallet
	exec [PrcGetShopWallet] @Guid

	insert into #FlatWallet
	exec [PrcGetParkingWallet] @Guid

	insert into #FlatWallet
	exec [PrcGetLandWallet] @Guid

	insert into #FlatWallet
	exec [PrcGetVillaWallet] @Guid


	Select 
		[P].[CustName],
		[p].[BeginDate] as [CustBeginDate],
		[p].[EndDate] as [CustEndDate],
		[P].[Value],
		[F].[Flat],
		[F].[BeginDate] as [FlatBeginDate],
		[F].[saleDate] as [FlatSaleDate],
		DateDiff(Day, [F].[BeginDate], [F].[SaleDate]) as [AllDay],
		[F].[Profit],
		Case when [P].[endDate] >= [F].[SaleDate] then
		DateDiff(Day
					,Case when [F].[BeginDate] < [P].[BeginDate] then [P].[BeginDate] else [F].[BeginDate] end
					,Case when [F].[SaleDate] < [P].[endDate] then [F].[SaleDate] else [P].[endDate] end
				) end
		as [DayWork]
		,[F].[FlatGuid]
		,[P].[Number]
		Into #Res
	From 
		(Select
			[P1].[Number],
			[P1].[ParentGuid],
			[C].[Name] as [CustName],
			[p1].[BeginDate],
			[p1].[EndDate],
			[P1].[Value]
		From
			[Partnerwallet] [P1]
			inner join [vwCustomer] [C] on [C].[Guid] = [P1].[CustGuid]
		) [P],
		#FlatWallet [F]
	where
		[P].[ParentGuid] = @Guid
	Order By 
		[P].[Number]

	--      
	Select 
		[FlatGuid] as [Fw_FlatGuid],
		Sum([Value] * [DayWork] / Case when [AllDay] <> 0 then [AllDay] end)  as [FW_ValueWork]
		into #FlatValueWork
	from 
		#Res
	Group By
		[FlatGuid]

	--Select * from #FlatValueWork

	Select 
		[R].* 
		--   =  *    /   
		,[Value] * [DayWork] / Case when [AllDay] <> 0 then [AllDay] end
		as [ValueWork]
		--   =    /    
		,
		Case when [Value] * [DayWork] / Case when [AllDay] <> 0 then [AllDay] end <> 0 then [Profit] 
		/
		[FW_ValueWork]

		end *100
		as [Percent]
		--  =   *   
		,(
			Case when [Value] * [DayWork] / Case when [AllDay] <> 0 then [AllDay] end <> 0 then [Profit] 
			/
			[FW_ValueWork]

			end
		)
		*
		[Value] * [DayWork] / Case when [AllDay] <> 0 then [AllDay] end
		as [CustProfit]
		,Cast([R].[Number] as Varchar(256))+[CustName] as [Order]
		, 0 as [Kind]
	into #Res2
	from 
		#Res [R]
		inner join #FlatValueWork [F] on [F].[Fw_FlatGuid] = [R].[FlatGuid]

	--Select * from #REs2

	Insert into #Res2
	Select
		Dbo.SC('')+': ' +[CustName],
		Null as [CustBeginDate],
		Null as [CustEndDate],
		[Value],
		'' as [Flat],
		Null as [FlatBeginDate],
		Null as [FlatSaleDate],
		Null as [AllDay],
		Sum([Profit]),
		Null as [DayWork],
		0x0 as [FlatGuid],
		0 as [Number],
		dbo.FnMyRound([ValueWork], @RoundKind),
		Sum([Percent]),
		dbo.FnMyRound(Sum([CustProfit]), @RoundKind),
		Max([Order]) + 'Z',
		1 as [kind]
	From
		#Res2
	Group By
		[CustName],[ValueWork], [Value]

	
	-- 
	Insert into #Res2
	Select
		Dbo.SC(''),
		Null as [CustBeginDate],
		Null as [CustEndDate],
		Sum([Value]),
		'' as [Flat],
		Null as [FlatBeginDate],
		Null as [FlatSaleDate],
		Null as [AllDay],
		[Profit],
		null as [DayWork],
		0x0 as [FlatGuid],
		0 as [Number],
		dbo.FnMyRound(Sum([ValueWork]), @RoundKind),
		avg([Percent]),
		dbo.FnMyRound(Sum([CustProfit]), @RoundKind),
		Max([Order]) + 'Z',
		2 as [kind]
	From
		#Res2
	where
		[Kind] = 0
	Group By
		[Profit]


	Select * from #Res2
	Order By [Order], [Kind]
	

GO

SET ANSI_NULLS, QUOTED_IDENTIFIER ON
GO

Create Procedure [PrcPrintReceiptServicesContract]
(
	@Guid uniqueidentifier = '44BAA61B-A0A7-43B5-B07B-299242BD419B',
	@Only Varchar(256) = '',
	@OnlyAr Varchar(256) = '',
	@OnlyEn Varchar(256) = '',	
	@OnlySumCheckAr Varchar(256) = '',	
	@OnlySumChecken Varchar(256) = '',	
	@OnlySumCashAr Varchar(256) = '',	
    @OnlySumCashEn Varchar(256) = '',
    @PrintCheckEnryOnly bit = 0
	
)
 
as
	Set NoCount On
	
	--  
	Declare @SumCheck Float, @SumCach Float, @SumPay Float
	
	Select
		@SumCheck = Sum([Value])
	From
		[LinkCheckContract] [C]
		inner join (Select Distinct Guid From [Resource] where [Spid] = @@Spid) [R] on [R].[Guid] = [C].ParentGuid
	where
		[ContractGuid] = @Guid

	Select
		@SumCach = isnull(Sum([Value] * [CurrencyVal]),0)
	From
		vwServicesContractCachPayment [C]
		inner join (Select Distinct Guid From [Resource] where [Spid] = @@Spid) [R] on [R].[Guid] = [C].[Guid]
	where
		[ContractGuid] = @Guid

	Set @SumPay = ISNULL(@SumCheck,0) + ISNULL(@SumCach,0)

	if @PrintCheckEnryOnly = 0
	begin
		
		/*
		Select 
			@SumPay = @SumPay + IsNull(OtherFee,0) + IsNull(InsuranceValue,0) + IsNull(CertificatValue,0)
		From
			[vwLeaseApartment]
		where 
			([Guid] = @Guid or @Guid = 0x0)		
		*/
		
		Select
			[A].[Number],
			[A].[ContractNo],
			
			[A].[CustName],
			[A].[CustArName],
			[A].[CustLtnName],
			[A].[CustomerPhonejob],
			[A].[CustomerMobile],
			[A].[CustomerNationality],
			
			[cu].[Barcode] as [Cust_Barcode], 			[cu].[Name] as [Cust_Name], 			[cu].[LtnName] as [Cust_LtnName], 			[cu].[CardKind] as [Cust_CardKind], 			[cu].[CardKind2] as [Cust_CardKind2], 			[cu].[Nationality] as [Cust_Nationality], 			[cu].[LtnNationality] as [Cust_LtnNationality], 			[cu].[Profession] as [Cust_Profession], 			[cu].[LtnProfession] as [Cust_LtnProfession], 			[cu].[PassportNO] as [Cust_PassportNO], 			[cu].[PassportExpireDate] as [Cust_PassportExpireDate], 			[cu].[Domicile] as [Cust_Domicile], 			[cu].[Security] as [Cust_Security], 			[cu].[LtnSecurity] as [Cust_LtnSecurity], 			[cu].[PhoneJob] as [Cust_PhoneJob], 			[cu].[Mobile] as [Cust_Mobile], 			[cu].[Note] as [Cust_Note], 			[cu].[Trademark] as [Cust_Trademark], 			[cu].[LtnTrademark] as [Cust_LtnTrademark], 			[cu].[MemoSecurity] as [Cust_MemoSecurity], 			[cu].[LtnMemoSecurity] as [Cust_LtnMemoSecurity], 			[cu].[Address] as [Cust_Address], 			[cu].[LtnAddress] as [Cust_LtnAddress], 			[cu].[BoxNo] as [Cust_BoxNo], 			[cu].[PersonalityNo1] as [Cust_PersonalityNo1], 			[cu].[PersonalityNo2] as [Cust_PersonalityNo2], 			[cu].[Fax] as [Cust_Fax], 			[cu].[EMail] as [Cust_EMail], 			[cu].[Adjective] as [Cust_Adjective], 			[cu].[LtnAdjective] as [Cust_LtnAdjective], 			[cu].[CkHideInSearch] as [Cust_CkHideInSearch], 			[cu].[ban] as [Cust_ban], 			[cu].[BankName] as [Cust_BankName], 			[cu].[BankAccCode] as [Cust_BankAccCode], 			[cu].[Birthday] as [Cust_Birthday], 			[cu].[DomicileEndDate] as [Cust_DomicileEndDate], 			[cu].[PersonalityEndDate] as [Cust_PersonalityEndDate], 			[cu].[CustNote1] as [Cust_CustNote1], 			[cu].[CustNote2] as [Cust_CustNote2], 			[cu].[CustNote3] as [Cust_CustNote3], 			[cu].[CustNote4] as [Cust_CustNote4], 			[cu].[CustNote5] as [Cust_CustNote5], 			[cu].[CustNote6] as [Cust_CustNote6], 			[cu].[CustNote7] as [Cust_CustNote7], 			[cu].[banContract] as [Cust_banContract], 
			
			@SumCheck as [SumCheck],
			@SumCach as [SumCach],
			@SumPay as [SumPay], 
			@Only as [OnlySumCheck], 
			@OnlyAr as [OnlySumCheckAr], 
			@OnlyEn as [OnlySumCheckEn], 

			@OnlySumCheckAr as OnlySumCheckAr,
			@OnlySumChecken as OnlySumChecken,
			@OnlySumCashAr as OnlySumCashAr,
			@OnlySumCashEn AS OnlySumCashEn,

			[A].[EditDate],
			[A].[FromDate],
			[A].[ToDate],
			[A].[BuildingName],
			[A].[BuildingArName],
			[A].[BuildingLtnName],
			[A].[Note2],

			[A].[Rent] as [ContractValue],

			[A].[DiscountPercent],
			[A].[DiscountValue],
			[A].[Rent] - [A].[DiscountValue] as [RentAfterDiscount],	

			[A].[MonthlyValue] ,
			[A].[MonthlyValue] * 12.00 as [YearValue],
			[A].[CurrencyName],
			[A].[DiscountPercent],
			[A].[DiscountValue],
			[A].[OtherFee],
			[A].[NewStateStr], --  
			A.Purpose,
			A.Trademark,
			A.whereabouts,
			A.RentDuration,
			A.LtnRentDuration,
			A.Rentype,
			A.LtnRentype,
			A.TermsOfPayment,
			A.LtnTermsOfPayment,
			
			Case when isnull([A].NewState,0) = 0 then dbo.sc('') else dbo.sc('') end as [NewSate],
			Case when isnull([A].NewState,0) = 0 then '' else '' end as [ArNewSate],
			Case when isnull([A].NewState,0) = 0 then 'New' else 'Renewal' end as [LtnNewSate]
		From 
			vwServicesContract A
			inner join Customer Cu on Cu.Guid = A.CustomerGuid
		where 
			([A].[Guid] = @Guid or @Guid = 0x0)
	end

	Create Table [#Tbl]
	(
		[Number] int,
		[BankName] Varchar(256),
		[Value] Float,
		[Currency] Varchar(256),
		[No]  Varchar(256),
		[EditDate] DateTime,
		[DueDate] DateTime,
		[State] Varchar(256),
		[Note3] Varchar(256),
		[Note] Varchar(256)
	)

	Insert Into [#Tbl]
	Select
		P.Number,
		[BankName],
		[LL].[Value] as [Value],
		[CurrencyName]  as [Currency],
		[No],
		P.Date as [EditDate],
		[DueDate],
		Case 		
			when  [C3].[CheckGuid] is not null then dbo.SC('')
			when  [C1].[CheckGuid] is not null then dbo.SC('') 
			when  [C4].[CheckGuid] is not null then dbo.SC(' ') 
			when  [C].[CheckGuid] is not null then dbo.SC('') 
			when  [C2].[CheckGuid] is not null then dbo.SC('') 
		end as [State],
		[P].[Note3],
		[P].[Note]
	From
		[vwChecks] [P]
		inner join [LinkCheckContract] LL on LL.ParentGuid = P.Guid
 		left join [vwChecksCollection] [C] on [C].[CheckGuid] = [P].[Guid] and [C].[Kind] = 0
 		left join [vwChecksCollection] [C1] on [C1].[CheckGuid] = [P].[Guid] and [C1].[Kind] = 1
 		left join [vwChecksCollection] [C2] on [C2].[CheckGuid] = [P].[Guid] and [C2].[Kind] = 2
 		left join [vwChecksCollection] [C3] on [C3].[CheckGuid] = [P].[Guid] and [C3].[Kind] = 3
 		left join [ChecksPartialCollection]  [C4] on [C4].[CheckGuid] = [P].[Guid] and [C3].[Kind] = 3
		inner join (Select Distinct Guid From [Resource] where [Spid] = @@Spid) [R] on [R].[Guid] = [P].[Guid]
	where
		LL.[ContractGuid] = @Guid


	Select * from [#Tbl]
	Order By
		[DueDate], [No]

	Select
		C.Number,
		C.[RecieptVoucherNumber],
		C.SNumber,
		dbo.sc('') as [BankName],
		[Value]  as [Value],
		[Currency]  as [Currency],
		'' as [No],
		[Date],
		'' as State,
		[C].[HNote],
		[C].[DNote]
	From
		vwServicesContractCachPayment [C]
		inner join (Select Distinct Guid From [Resource] where [Spid] = @@Spid) [R] on [R].[Guid] = [C].[Guid] 
	where
		[ContractGuid] = @Guid
	Order By
		[Number],[DNumber]


GO

SET ANSI_NULLS, QUOTED_IDENTIFIER ON
GO

Create Procedure [PrcPrintMaintenanceContract]
(
	@Guid uniqueidentifier = 'D0718394-B515-49FA-A93F-19F27E95CCF5'
	,@OnlyValue Varchar(256) = ''
	,@OnlyValueAr Varchar(256) = ''
	,@OnlyValueEn Varchar(256) = ''
	,@OnlyMonthlyValue Varchar(256) = ''
	,@OnlyArMonthlyValue Varchar(256) = ''
	,@OnlyLtnMonthlyValue Varchar(256) = ''
)
 
as
	----  
	Declare @ChecksCollection Float
	Select 
		@ChecksCollection = Sum([P].[Value])
	From
		[vwChecks] [P]
		left join [vwChecksCollection] [C1] on [C1].[CheckGuid] = [P].[Guid] and [C1].[Kind] = 1
		left join (
						Select 
							[CheckGuid],
							Sum([Value]) as [Value] 
						From
							[ChecksPartialCollection] 
						Group By
							[CheckGuid]
					) [C4] on [C4].[CheckGuid] = [P].[Guid]
		left join [vwChecksCollection] [C3] on [C3].[CheckGuid] = [P].[Guid] and [C3].[Kind] = 3
 	where
 		(P.[ContractGuid] = @Guid)
 		and (
		Case

			when  ([C1].[CheckGuid] is not null) or 
				  ([C4].[CheckGuid] is Not Null ) and ([C4].[Value] >= [P].[Value])	 then 1
			else
				0
		end ) = 1 
		and [C3].[CheckGuid] is Null
 			

	--  
	Declare @SumCheck Float, @SumCach Float, @SumPay Float
	
	Select
		@SumCheck = Sum([Value] * [CurrencyVal])
	From
		[Checks] [C]
		inner join (Select Distinct Guid From [Resource] where [Spid] = @@Spid) [R] on [R].[Guid] = [C].[Guid]
	where
		[ContractGuid] = @Guid

	Select
		@SumCach = isnull(Sum([Value] * [CurrencyVal]),0)
	From
		[vwMaintenanceContractCachPayment] [C]
		inner join (Select Distinct Guid From [Resource] where [Spid] = @@Spid) [R] on [R].[Guid] = [C].[Guid]
	where
		[ContractGuid] = @Guid

	--Select @SumPay , @SumCheck, @SumCach

	Set @SumPay = ISNULL(@SumCheck,0) + ISNULL(@SumCach,0)

 			
	Select * into #infofldBuidling from [fnInfoFld] (0x0, 0)
	
	Declare 
			@CreateByUser varchar(255),
			@CreateDate Datetime,

			@LastUpdateByUser varchar(255),
			@LastUpdateDate Datetime
	
		
	Select 
		GetDate() as [NowDate],
		dbo.FnFormatDate(GetDate()) as [NowDate_Gr],

		@OnlyValue as [OnlyValue],
		@OnlyValueAr as [OnlyValueAr],
		@OnlyValueEn as [OnlyValueEn],
		@OnlyMonthlyValue as [OnlyMonthlyValue],
		@OnlyArMonthlyValue as [OnlyArMonthlyValue],
		@OnlyLtnMonthlyValue as [OnlyLtnMonthlyValue],

		dbo.[FnGetDayName]([EditDate], 0) as [DayNameofEditDate] ,
		dbo.[FnGetDayName]([EditDate], 1) as [LtnDayNameofEditDate] ,
		dbo.FnFormatDate([EditDate]) as [EditDate_Gr],
		
		dbo.FnFormatDate([FromDate]) as [FromDate_Gr],
		dbo.FnFormatDate([ToDate]) as [ToDate_Gr],
		
		DATEDIFF(DAY, ToDate, FromDate) as ContractDays,
		Case when ContractFinish = 1 then 
		DATEDIFF(DAY, ToDate, ContractFinishDate) 
		end as ContractDaysDifference,

		dbo.FnFormatDate([A].[License1Date1]) as [License1Date1_Gr],
		dbo.FnFormatDate([A].[License2Date1]) as [License2Date1_Gr],
		dbo.FnFormatDate([A].[License3Date1]) as [License3Date1_Gr],
		dbo.FnFormatDate([A].[License1Date2]) as [License1Date2_Gr],
		dbo.FnFormatDate([A].[License2Date2]) as [License2Date2_Gr],
		dbo.FnFormatDate([A].[License3Date2]) as [License3Date2_Gr],

		dbo.FnFormatDate([A].[ContractFinishDate]) as [ContractFinishDate_Gr],

		(Select SUM(Value) From [vwMaintenanceContractCachPayment] where ContractGuid = A.Guid) as SumCachPayment,
		@ChecksCollection as [SumChecksCollection],
				
		C.CustNote1,
		C.CustNote2,
		C.CustNote3,
		C.CustNote4,
		C.CustNote5,
		C.CustNote6,
		C.CustNote7,
		
		@SumCheck as [SumCheck],
		@SumCach as [SumCach],
		@SumPay as [SumPay], 

		[A].[Guid],
		
		(Select Top 1 [UserName] From vwRealty_LogCard where CardGuid = A.Guid order by Date) as [CreateByUser],
		(Select Top 1 [Date] From vwRealty_LogCard where CardGuid = A.Guid order by Date) as [CreateDate],
		(Select Top 1 [UserName] From vwRealty_LogCard where CardGuid = A.Guid order by Date desc) as [LastUpdateByUser],
		(Select Top 1 [Date] From vwRealty_LogCard where CardGuid = A.Guid order by Date desc) as [LastUpdateDate]
	from 
		[vwMaintenanceContract] [A]
		left join [vwCustomer] [C] on [C].[Guid] = [A].[CustomerGuid]
	where
		[A].[Guid] = @Guid or @Guid = 0x0


GO

SET ANSI_NULLS, QUOTED_IDENTIFIER ON
GO

Create Procedure [PrcCreateElectricityBillEntry]
(
	@Guid uniqueidentifier = 'E3AA1310-B8B3-4ABB-89D5-54D95317E212'
)
 
as
	Declare 
			@EnNum int,
			@EnGuid [uniqueidentifier]

	--  
	Select 
		@EnNum = isnull([Number],0)
	From
		[HEntry]
	where
		[Guid] = @Guid

	Set @EnGuid = @Guid

	if isnull(@EnNum,0) = 0
	begin	
		Select @EnNum = IsNull(Max([Number]),0) + 1 from [HEntry]
	END


	--   
	Delete
		[Hentry]
	where
		[Guid] = @Guid

	DECLARE 
		@CreateEntry BIT,
		@AutoPostedEntry Bit

	SELECT	TOP 1
		@CreateEntry = [CreatedEntry],
		@AutoPostedEntry = [AutoPostedEntry]	
	FROM
		[ElectricityType]
	WHERE
		Guid = (		
				Select 
					[TypeGuid] 
				From 
					[ElectricityBill]
				WHERE
					[Guid] =@Guid
				)

	Declare 
		@SecLvl Int,
		@mark Bit,
		@Date DateTime,
		@AcCustGuid [uniqueidentifier] ,
		@Consumption Float,
		@WaterValue Float,
		@FineValue Float,
		@FeeValue Float,
		@DrainageValue Float,
		@Discount Float,
		@Extra Float,
		@IncomeAccountGuid [uniqueidentifier],
		@WaterAccountGuid [uniqueidentifier],
		@DrainageAccountGuid [uniqueidentifier],
		@FineAccountGuid [uniqueidentifier],
		@FeeAccountGuid [uniqueidentifier],
		@ExtraAccountGuid [uniqueidentifier] ,
		@DiscountAccountGuid [uniqueidentifier] ,
		@CurrencyGuid [uniqueidentifier] ,
		@CurrencyVal Float,
		@Note Varchar(256),
		@WaterNote Varchar(256),
		@DrainageNote Varchar(256),
		@DiscountNote Varchar(256),
		@ExtraNote Varchar(256),
		@ConsumptionNote Varchar(256),
		@FineNote Varchar(256),
		@FeeNote Varchar(256),
		@CreateBilltEntry Bit


	Select 
		@SecLvl = [B].[SecLvl],
		@Mark = [B].[Mark],
		@Date = [B].[Date],
		@AcCustGuid = [Cu].[AcGuid],
		@Discount = [B].[Discount],
		@Extra = [B].[Extra],
		@Consumption = [B].[Consumption],
		@WaterValue = [WaterValue],
		@DrainageValue = [DrainageValue],
		@FineValue = [FineValue],
		@FeeValue = [FeeValue],
		@IncomeAccountGuid = [IncomeAccountGuid],
		@WaterAccountGuid = [WaterAccountGuid],
		@FineAccountGuid = [FineAccountGuid],
		@FeeAccountGuid = [FeeAccountGuid],
		@DrainageAccountGuid = [DrainageAccountGuid],
		@ExtraAccountGuid = [ExtraAccountGuid],
		@DiscountAccountGuid = [DiscountAccountGuid],
		@CurrencyGuid = [B].[CurrencyGuid],
		@CurrencyVal = [B].[CurrencyVal],
		@Note = [B].[Note],
		@CreateBilltEntry = [B].[CreateBilltEntry],
		@WaterNote = B.WaterNote,
		@DrainageNote = B.DrainageNote,
		@DiscountNote = B.DiscountNote,
		@ExtraNote = B.ExtraNote,
		@FineNote = B.FineNote,
		@FeeNote = B.FeeNote,
		@ConsumptionNote = B.ConsumptionNote
	From 
		[ElectricityBill] [B]
		inner join [Customer] [Cu] on [Cu].[Guid] = [B].[CustGuid]
	where
		[B].[Guid]=@Guid
		
	Select @FineAccountGuid
	
	if (@CreateEntry = 1) and (@CreateBilltEntry = 1)
	begin

			Insert Into [HEntry]
			([Guid],[Mark],[SecLvl],[Number],[Date], [CurrencyGuid], [CurrencyVal], [Note], [ParentKind], [BranchGuid],[IsPosted])
			Select
				@EnGuid,
				@Mark,
				@SecLvl,
				@EnNum,
				@Date,
				@CurrencyGuid,
				@CurrencyVal,
				@Note,
				180,
				Null,
				@AutoPostedEntry
				
			Declare @DetailNum Int
			Set @DetailNum = 0
			
			if @Consumption <> 0 
			begin
				Insert into [DEntry]
		 		([ParentGuid],[Number],[AcGuid],[Debit],[Credit],[CurrencyGuid],[CurrencyVal],[CostGuid],[ObverseAcGuid],[Note])
				Select
					@EnGuid,
					@DetailNum,
					@AcCustGuid,
					@Consumption,
					0,
					@CurrencyGuid,
					@CurrencyVal,
					Null as [CostGuid],
					@IncomeAccountGuid,
					@ConsumptionNote
					
				Set @DetailNum = @DetailNum + 1
				Insert into [DEntry]
		 		([ParentGuid],[Number],[AcGuid],[Debit],[Credit],[CurrencyGuid],[CurrencyVal],[CostGuid],[ObverseAcGuid],[Note])
				Select
					@EnGuid,
					@DetailNum,
					@IncomeAccountGuid,
					0,
					@Consumption,
					@CurrencyGuid,
					@CurrencyVal,
					Null as [CostGuid],
					@AcCustGuid,
					@ConsumptionNote
			end

			--
			if @WaterValue <> 0
			begin
				Insert into [DEntry]
		 		([ParentGuid],[Number],[AcGuid],[Debit],[Credit],[CurrencyGuid],[CurrencyVal],[CostGuid],[ObverseAcGuid],[Note])
				Select
					@EnGuid,
					@DetailNum,
					@AcCustGuid,
					@WaterValue,
					0,
					@CurrencyGuid,
					@CurrencyVal,
					Null as [CostGuid],
					@WaterAccountGuid,
					@WaterNote

				Set @DetailNum = @DetailNum + 1
				Insert into [DEntry]
		 		([ParentGuid],[Number],[AcGuid],[Debit],[Credit],[CurrencyGuid],[CurrencyVal],[CostGuid],[ObverseAcGuid],[Note])
				Select
					@EnGuid,
					@DetailNum,
					@WaterAccountGuid,
					0,
					@WaterValue,
					@CurrencyGuid,
					@CurrencyVal,
					Null as [CostGuid],
					@AcCustGuid,
					@WaterNote
			end

			--
			if @DrainageValue <> 0
			begin
				Insert into [DEntry]
		 		([ParentGuid],[Number],[AcGuid],[Debit],[Credit],[CurrencyGuid],[CurrencyVal],[CostGuid],[ObverseAcGuid],[Note])
				Select
					@EnGuid,
					@DetailNum,
					@AcCustGuid,
					@DrainageValue,
					0,
					@CurrencyGuid,
					@CurrencyVal,
					Null as [CostGuid],
					@DrainageAccountGuid,
					@DrainageNote

				Set @DetailNum = @DetailNum + 1
				Insert into [DEntry]
		 		([ParentGuid],[Number],[AcGuid],[Debit],[Credit],[CurrencyGuid],[CurrencyVal],[CostGuid],[ObverseAcGuid],[Note])
				Select
					@EnGuid,
					@DetailNum,
					@DrainageAccountGuid,
					0,
					@DrainageValue,
					@CurrencyGuid,
					@CurrencyVal,
					Null as [CostGuid],
					@AcCustGuid,
					@DrainageNote
			end

			--
			if @FineValue <> 0
			begin
				Insert into [DEntry]
		 		([ParentGuid],[Number],[AcGuid],[Debit],[Credit],[CurrencyGuid],[CurrencyVal],[CostGuid],[ObverseAcGuid],[Note])
				Select
					@EnGuid,
					@DetailNum,
					@AcCustGuid,
					@FineValue,
					0,
					@CurrencyGuid,
					@CurrencyVal,
					Null as [CostGuid],
					@FineAccountGuid,
					@FineNote

				Set @DetailNum = @DetailNum + 1
				Insert into [DEntry]
		 		([ParentGuid],[Number],[AcGuid],[Debit],[Credit],[CurrencyGuid],[CurrencyVal],[CostGuid],[ObverseAcGuid],[Note])
				Select
					@EnGuid,
					@DetailNum,
					@FineAccountGuid,
					0,
					@FineValue,
					@CurrencyGuid,
					@CurrencyVal,
					Null as [CostGuid],
					@AcCustGuid,
					@FineNote
			end

			--
			if @FeeValue <> 0
			begin
				Insert into [DEntry]
		 		([ParentGuid],[Number],[AcGuid],[Debit],[Credit],[CurrencyGuid],[CurrencyVal],[CostGuid],[ObverseAcGuid],[Note])
				Select
					@EnGuid,
					@DetailNum,
					@AcCustGuid,
					@FeeValue,
					0,
					@CurrencyGuid,
					@CurrencyVal,
					Null as [CostGuid],
					@FeeAccountGuid,
					@FeeNote

				Set @DetailNum = @DetailNum + 1
				Insert into [DEntry]
		 		([ParentGuid],[Number],[AcGuid],[Debit],[Credit],[CurrencyGuid],[CurrencyVal],[CostGuid],[ObverseAcGuid],[Note])
				Select
					@EnGuid,
					@DetailNum,
					@FeeAccountGuid,
					0,
					@FeeValue,
					@CurrencyGuid,
					@CurrencyVal,
					Null as [CostGuid],
					@AcCustGuid,
					@FeeNote
			end

		if @Discount <> 0 
		begin
			Set @DetailNum = @DetailNum + 1
			Insert into [DEntry]
		 	([ParentGuid],[Number],[AcGuid],[Debit],[Credit],[CurrencyGuid],[CurrencyVal],[CostGuid],[ObverseAcGuid],[Note])
			Select
				@EnGuid,
				@DetailNum,
				@DiscountAccountGuid,
				@Discount,
				0,
				@CurrencyGuid,
				@CurrencyVal,
				Null as [CostGuid],
				@AcCustGuid,
				@DiscountNote
			Set @DetailNum = @DetailNum + 1
			Insert into [DEntry]
		 	([ParentGuid],[Number],[AcGuid],[Debit],[Credit],[CurrencyGuid],[CurrencyVal],[CostGuid],[ObverseAcGuid],[Note])
			Select
				@EnGuid,
				@DetailNum,
				@AcCustGuid,
				0,
				@Discount,
				@CurrencyGuid,
				@CurrencyVal,
				Null as [CostGuid],
				@DiscountAccountGuid,
				@DiscountNote
		end
		if @Extra <> 0 
		begin
			Set @DetailNum = @DetailNum + 1
			Insert into [DEntry]
		 	([ParentGuid],[Number],[AcGuid],[Debit],[Credit],[CurrencyGuid],[CurrencyVal],[CostGuid],[ObverseAcGuid],[Note])
			Select
				@EnGuid,
				@DetailNum,
				@AcCustGuid,
				@Extra,
				0,
				@CurrencyGuid,
				@CurrencyVal,
				Null as [CostGuid],
				@ExtraAccountGuid,
				@ExtraNote
			Set @DetailNum = @DetailNum + 1
			Insert into [DEntry]
		 	([ParentGuid],[Number],[AcGuid],[Debit],[Credit],[CurrencyGuid],[CurrencyVal],[CostGuid],[ObverseAcGuid],[Note])
			Select
				@EnGuid,
				@DetailNum,
				@ExtraAccountGuid,
				0,
				@Extra,
				@CurrencyGuid,
				@CurrencyVal,
				Null as [CostGuid],
				@AcCustGuid,
				@ExtraNote
		end	
	end

	Select * from HEntry where Guid = @Guid
	

GO

SET ANSI_NULLS, QUOTED_IDENTIFIER ON
GO

Create Procedure [PrcPrintReceiptParkingContract]
(
	@Guid uniqueidentifier = 'D238C064-5D99-44C1-975F-8F2CEBE2D6B1',
	@Only Varchar(256) = '',
	@OnlyAr Varchar(256) = '',
	@OnlyEn Varchar(256) = ''
)
 
as
	Set NoCount On
		--  
	Declare @SumCheck Float, @SumCach Float, @SumPay Float
	
	Select
		@SumCheck = Sum([Value])
	From
		[LinkCheckContract] [C]
		inner join (Select Distinct Guid From [Resource] where [Spid] = @@Spid) [R] on [R].[Guid] = [C].ParentGuid
	where
		[ContractGuid] = @Guid

	Select
		@SumCach = isnull(Sum([Value] * [CurrencyVal]),0)
	From
		[vwContractParkingCachPayment] [C]
		inner join [Resource] [R] on [R].[Guid] = [C].[Guid] and [Spid] = @@Spid
	where
		[ContractGuid] = @Guid

	Set @SumPay = ISNULL(@SumCheck,0) + ISNULL(@SumCach,0)

	Select
		[C].[Number],
		[C].[ContractNo],
		[C].[CustName],
		[C].[CustArName],
		[C].[CustLtnName],
		
		[cu].[Barcode] as [Cust_Barcode], 		[cu].[Name] as [Cust_Name], 		[cu].[LtnName] as [Cust_LtnName], 		[cu].[CardKind] as [Cust_CardKind], 		[cu].[CardKind2] as [Cust_CardKind2], 		[cu].[Nationality] as [Cust_Nationality], 		[cu].[LtnNationality] as [Cust_LtnNationality], 		[cu].[Profession] as [Cust_Profession], 		[cu].[LtnProfession] as [Cust_LtnProfession], 		[cu].[PassportNO] as [Cust_PassportNO], 		[cu].[PassportExpireDate] as [Cust_PassportExpireDate], 		[cu].[Domicile] as [Cust_Domicile], 		[cu].[Security] as [Cust_Security], 		[cu].[LtnSecurity] as [Cust_LtnSecurity], 		[cu].[PhoneJob] as [Cust_PhoneJob], 		[cu].[Mobile] as [Cust_Mobile], 		[cu].[Note] as [Cust_Note], 		[cu].[Trademark] as [Cust_Trademark], 		[cu].[LtnTrademark] as [Cust_LtnTrademark], 		[cu].[MemoSecurity] as [Cust_MemoSecurity], 		[cu].[LtnMemoSecurity] as [Cust_LtnMemoSecurity], 		[cu].[Address] as [Cust_Address], 		[cu].[LtnAddress] as [Cust_LtnAddress], 		[cu].[BoxNo] as [Cust_BoxNo], 		[cu].[PersonalityNo1] as [Cust_PersonalityNo1], 		[cu].[PersonalityNo2] as [Cust_PersonalityNo2], 		[cu].[Fax] as [Cust_Fax], 		[cu].[EMail] as [Cust_EMail], 		[cu].[Adjective] as [Cust_Adjective], 		[cu].[LtnAdjective] as [Cust_LtnAdjective], 		[cu].[CkHideInSearch] as [Cust_CkHideInSearch], 		[cu].[ban] as [Cust_ban], 		[cu].[BankName] as [Cust_BankName], 		[cu].[BankAccCode] as [Cust_BankAccCode], 		[cu].[Birthday] as [Cust_Birthday], 		[cu].[DomicileEndDate] as [Cust_DomicileEndDate], 		[cu].[PersonalityEndDate] as [Cust_PersonalityEndDate], 		[cu].[CustNote1] as [Cust_CustNote1], 		[cu].[CustNote2] as [Cust_CustNote2], 		[cu].[CustNote3] as [Cust_CustNote3], 		[cu].[CustNote4] as [Cust_CustNote4], 		[cu].[CustNote5] as [Cust_CustNote5], 		[cu].[CustNote6] as [Cust_CustNote6], 		[cu].[CustNote7] as [Cust_CustNote7], 		[cu].[banContract] as [Cust_banContract], 
		C.AccountBalance,
		
		@SumCheck as [SumCheck],
		@SumCach as [SumCach],
		@SumPay as [SumPay], 
		@Only as [OnlySumCheck], 
		@OnlyAr as [OnlySumCheckAr], 
		@OnlyEn as [OnlySumCheckEn], 
		[C].[FromDate],
		[C].[ToDate],

		C.ContractDays,
		C.ContractDaysDifference,

		[C].[BuildingName],
		[C].[BuildingArName],
		[C].[BuildingLtnName],
		[C].[No],
		[C].[Note2],
		[C].[Rent] as [ContractValue],
		[C].[CurrencyName],
		[C].[InsuranceValueOld],
		[C].[InsuranceValue],
		[C].[CommissionFromCustValue],
		[C].[CommissionFromOwnerValue],
		[C].[ContractPrice],
		[C].[CertificatValue],
		[R].[Name] as [HirerName],
		[C].[CardNo],
		[C].[CarNo],
		[C].[CarType],
		[C].[CarColor],
		[C].[Emirate],
		[C].[parkingNo],
		[C].[No],
		Case when isnull(NewState,0) = 0 then dbo.sc('') else dbo.sc('') end as [NewSate],
		Case when isnull(NewState,0) = 0 then '' else '' end as [ArNewSate],
		Case when isnull(NewState,0) = 0 then 'New' else 'Renewal' end as [LtnNewSate],
		S.Name as [SalesMan]
	From 
		[vwParkingContract] [C]
		left join [RentInfo] [R] on [R].[Guid] = [C].[RentInfoGuid]
		left join Salesman S on S.Guid = [C].[SalesManGuid]
		inner join Customer Cu on Cu.Guid = C.CustomerGuid
	where 
		([C].[Guid] = @Guid or @Guid = 0x0)


	Create Table [#Tbl]
	(
		[Number] int,
		[BankName] Varchar(256),
		[Value] Float,
		[Currency] Varchar(256),
		[No]  Varchar(256),
		[EditDate] DateTime,
		[DueDate] DateTime,
		[State] Varchar(256),
		[Note] Varchar(256)
	)

	Insert Into [#Tbl]
	Select
		P.Number,
		[BankName],
		Cast([LL].[Value] as Varchar(20)) as [Value],
		[CurrencyName]  as [Currency],
		[No],
		P.Date as [EditDate],
		[DueDate],
		Case 		
			when  [C3].[CheckGuid] is not null then dbo.SC('')
			when  [C1].[CheckGuid] is not null then dbo.SC('') 
			when  [C4].[CheckGuid] is not null then dbo.SC(' ') 
			when  [C].[CheckGuid] is not null then dbo.SC('') 
			when  [C2].[CheckGuid] is not null then dbo.SC('') 
		end as [State],
		[P].[Note3]
	From
		[vwChecks] [P]
		inner join [LinkCheckContract] LL on LL.ParentGuid = P.Guid
 		left join [vwChecksCollection] [C] on [C].[CheckGuid] = [P].[Guid] and [C].[Kind] = 0
 		left join [vwChecksCollection] [C1] on [C1].[CheckGuid] = [P].[Guid] and [C1].[Kind] = 1
 		left join [vwChecksCollection] [C2] on [C2].[CheckGuid] = [P].[Guid] and [C2].[Kind] = 2
 		left join [vwChecksCollection] [C3] on [C3].[CheckGuid] = [P].[Guid] and [C3].[Kind] = 3
 		left join [ChecksPartialCollection]  [C4] on [C4].[CheckGuid] = [P].[Guid] and [C3].[Kind] = 3
		inner join (Select Distinct Guid From [Resource] where [Spid] = @@Spid) [R] on [R].[Guid] = [P].[Guid]
	where
		LL.[ContractGuid] = @Guid

	Select * from [#Tbl]
	Order By
		[DueDate], [No]

	Select
		dbo.sc('') as [BankName],
		Cast([Value] as Varchar(20)) as [Value],
		[Currency]  as [Currency],
		'' as [No],
		[Date],
		'' as State,
		[C].[HNote],
		[C].[DNote]
	From
		[vwContractParkingCachPayment] [C]
		inner join [Resource] [R] on [R].[Guid] = [C].[Guid] and [Spid] = @@Spid
	where
		[ContractGuid] = @Guid


GO

SET ANSI_NULLS, QUOTED_IDENTIFIER ON
GO

Create Procedure [PrcCheckBuildingYear]
(
	@State int = 0,
	@ContainPartialCollection bit = 1,
	@CheckDueDate Bit = 1,
	@Date1 DateTime = '1/1/2010',
	@Date2 DateTime = '1/1/2010'
)
 
as
	Select 
		Case when [C].[CheckGuid] is null then 0 else 1 end as [IsPosted],
		Case when [C1].[CheckGuid] is Not null then 1 else 0 end As [IsCollection],
		Case when [C4].[CheckGuid] is Not null then 1 else 0 end as [IsPartialCollection],
		Case when [C2].[CheckGuid] is null then 0 else 1 end as [IsEndorsement],
		Case when [C3].[CheckGuid] is null then 0 else 1 end as [IsReturned],
		[P].[Value],
		[C4].[Value] as [CollectionValue],
		[P].[Value] - [C4].[Value] as [RestValue],
		[P].[DueDate],
		[T].[BuildingName],
		[P].[Guid]
	Into #Res1
	From
		[vwChecks] [P]
		inner join (	
					Select Distinct
							[T1].[Guid],
							[T1].[BuildingName]
					From
						[vwAllContract] [T1]
						inner join [Resource] [RS2] on [RS2].[Guid] = [T1].[BuildingGuid] and [RS2].[Spid] = @@Spid and [RS2].[Kind] = 99
					)[T] on [T].[Guid] = [P].[ContractGuid]

		inner join [Resource] [RS] on [RS].[Guid] = [P].[TypeGuid] and [RS].[Spid] = @@Spid and [RS].[Kind] = 3000

		left join [vwChecksCollection] [C] on [C].[CheckGuid] = [P].[Guid] and [C].[Kind] = 0
		left join [vwChecksCollection] [C1] on [C1].[CheckGuid] = [P].[Guid] and [C1].[Kind] = 1
		left join [vwChecksCollection] [C2] on [C2].[CheckGuid] = [P].[Guid] and [C2].[Kind] = 2
		left join [vwChecksCollection] [C3] on [C3].[CheckGuid] = [P].[Guid] and [C3].[Kind] = 3
		left join (
						Select 
							[CheckGuid],
							Sum([Value]) as [Value] 
						From
							[ChecksPartialCollection] 
						Group By
							[CheckGuid]
					) [C4] on [C4].[CheckGuid] = [P].[Guid]

  	where
 		([P].[DueDate] Between @Date1 and @Date2 or @CheckDueDate = 0)


--  	Select Guid, * from #Res1 	Order By Guid
 -- 	return

	Select
		[BuildingName],
		Sum( Case when dbo.FnMonth([DueDate]) = 1 then [Value] end ) as [Month1],
		Sum( Case when dbo.FnMonth([DueDate]) = 2 then [Value] end ) as [Month2],
		Sum( Case when dbo.FnMonth([DueDate]) = 3 then [Value] end ) as [Month3],
		Sum( Case when dbo.FnMonth([DueDate]) = 4 then [Value] end ) as [Month4],
		Sum( Case when dbo.FnMonth([DueDate]) = 5 then [Value] end ) as [Month5],
		Sum( Case when dbo.FnMonth([DueDate]) = 6 then [Value] end ) as [Month6],
		Sum( Case when dbo.FnMonth([DueDate]) = 7 then [Value] end ) as [Month7],
		Sum( Case when dbo.FnMonth([DueDate]) = 8 then [Value] end ) as [Month8],
		Sum( Case when dbo.FnMonth([DueDate]) = 9 then [Value] end ) as [Month9],
		Sum( Case when dbo.FnMonth([DueDate]) = 10 then [Value] end ) as [Month10],
		Sum( Case when dbo.FnMonth([DueDate]) = 11 then [Value] end ) as [Month11],
		Sum( Case when dbo.FnMonth([DueDate]) = 12 then [Value] end ) as [Month12],
		Sum([Value]) [MonthTotal]
		,0 as [Kind]
	Into #Month
	From
		#Res1
	where
		-- 
		(@State = 3 and [IsReturned] = 1)
		
		or 
		-- 
		(@State = 2 and [IsCollection] = 1 and [IsReturned] = 0)

		or 
		-- 
		(@State = 1 and [IsPosted] = 1 and [IsCollection] = 0 and [IsReturned] = 0)

		or 
		-- 
		(@State = 0 and [IsPosted] = 0 and [IsCollection] = 0 and [IsReturned] = 0)

	Group By
		[BuildingName]
	Order By
		[BuildingName]

	if @ContainPartialCollection = 1
	insert Into #Month
	Select
		[BuildingName],
		Sum( Case when dbo.FnMonth([DueDate]) = 1 then 
															Case when @State = 2 then [CollectionValue]
																 when @State = 0 then [Value] - [CollectionValue]
															end
			 end ) as [Month1],
		Sum( Case when dbo.FnMonth([DueDate]) = 2 then
															Case when @State = 2 then [CollectionValue]
																 when @State = 0 then [Value] - [CollectionValue]
															end
			 end ) as [Month2],
		Sum( Case when dbo.FnMonth([DueDate]) = 3 then
															Case when @State = 2 then [CollectionValue]
																 when @State = 0 then [Value] - [CollectionValue]
															end
			 end ) as [Month3],
		Sum( Case when dbo.FnMonth([DueDate]) = 4 then
															Case when @State = 2 then [CollectionValue]
																 when @State = 0 then [Value] - [CollectionValue]
															end
			 end ) as [Month4],
		Sum( Case when dbo.FnMonth([DueDate]) = 5 then
															Case when @State = 2 then [CollectionValue]
																 when @State = 0 then [Value] - [CollectionValue]
															end
			 end ) as [Month5],
		Sum( Case when dbo.FnMonth([DueDate]) = 6 then
															Case when @State = 2 then [CollectionValue]
																 when @State = 0 then [Value] - [CollectionValue]
															end
			 end ) as [Month6],
		Sum( Case when dbo.FnMonth([DueDate]) = 7 then
															Case when @State = 2 then [CollectionValue]
																 when @State = 0 then [Value] - [CollectionValue]
															end
			 end ) as [Month7],
		Sum( Case when dbo.FnMonth([DueDate]) = 8 then
															Case when @State = 2 then [CollectionValue]
																 when @State = 0 then [Value] - [CollectionValue]
															end
			 end ) as [Month8],
		Sum( Case when dbo.FnMonth([DueDate]) = 9 then
															Case when @State = 2 then [CollectionValue]
																 when @State = 0 then [Value] - [CollectionValue]
															end
			 end ) as [Month9],
		Sum( Case when dbo.FnMonth([DueDate]) = 10 then
															Case when @State = 2 then [CollectionValue]
																 when @State = 0 then [Value] - [CollectionValue]
															end
			 end ) as [Month10],
		Sum( Case when dbo.FnMonth([DueDate]) = 11 then
															Case when @State = 2 then [CollectionValue]
																 when @State = 0 then [Value] - [CollectionValue]
															end
			 end ) as [Month11],
		Sum( Case when dbo.FnMonth([DueDate]) = 12 then
															Case when @State = 2 then [CollectionValue]
																 when @State = 0 then [Value] - [CollectionValue]
															end
			 end ) as [Month12],

		Sum( Case when @State = 2 then [CollectionValue]
				  when @State = 0 then [Value] - [CollectionValue]
			 end
			) as [MonthTotal]
		,0 as [Kind]
	From
		#Res1
	where
		-- 
		(@State = 3 and [IsReturned] = 1)
		
		or 
		-- 
		(@State = 2 and [IsCollection] = 1 and [IsReturned] = 0)

		or 
		-- 
		(@State = 1 and [IsPosted] = 1 and [IsCollection] = 0 and [IsReturned] = 0)

		or 
		-- 
		(@State = 0 and [IsPosted] = 0 and [IsCollection] = 0 and [IsReturned] = 0)

	Group By
		[BuildingName]
	Order By
		[BuildingName]

	-- 
	insert into #Month
	Select 	
		dbo.SC(''),
		Sum([Month1]) as [Month1],
		Sum([Month2]) as [Month2],
		Sum([Month3]) as [Month3],
		Sum([Month4]) as [Month4],
		Sum([Month5]) as [Month5],
		Sum([Month6]) as [Month6],
		Sum([Month7]) as [Month7],
		Sum([Month8]) as [Month8],
		Sum([Month9]) as [Month9],
		Sum([Month10]) as [Month10],
		Sum([Month11]) as [Month11],
		Sum([Month12]) as [Month12],
		Sum([MonthTotal]) as [MonthTotal]
		,1 as [Kind]
	from 
		#Month


	Select 	
		[BuildingName],
		Sum([Month1]) as [Month1],
		Sum([Month2]) as [Month2],
		Sum([Month3]) as [Month3],
		Sum([Month4]) as [Month4],
		Sum([Month5]) as [Month5],
		Sum([Month6]) as [Month6],
		Sum([Month7]) as [Month7],
		Sum([Month8]) as [Month8],
		Sum([Month9]) as [Month9],
		Sum([Month10]) as [Month10],
		Sum([Month11]) as [Month11],
		Sum([Month12]) as [Month12],
		Sum([MonthTotal]) as [MonthTotal],
		[Kind]
	Into #End
	from 
		#Month
	Group By
		[Kind], [BuildingName]

	Select 
		* 
	from 
		#End
	Order By
		[Kind], [BuildingName]

GO

SET ANSI_NULLS, QUOTED_IDENTIFIER ON
GO

Create Procedure [PrcPaperMonetary]
(
	@Account UniqueIdentifier = 0x0,
	@obverseAccount UniqueIdentifier = 0x0,--'794F7D2E-F02D-4148-8CDF-448E669A4556',
	@AccountWith int = 3,
	@BranchGuid UniqueIdentifier = 0x0,
	@ContractGuid UniqueIdentifier = 0x0,
	@SalesManGuid UniqueIdentifier = 0x0,
	@BankName Varchar(256) = '',
	@FlatGuid UniqueIdentifier = 0x0,
	@ShopGuid UniqueIdentifier = 0x0,
	@ParkingGuid UniqueIdentifier = 0x0,
	@beneficiary Varchar(256) = '',
	@NonState  Bit = 0,
	@CkEnd Bit = 1,
	@ChecksPartialCollection Bit = 1,
	@ChecksPartialCollectionOption int = 2,
	@ShowStateOnly bit = 1,
	@IsPosted Bit = 1,
	@IsEndorsement Bit = 1,
	@IsReturn Bit = 1,
	@ReturnCause Varchar(256) = '',
	@CbEndReturn int = 2
	,@ShowIsCheck Bit = 1
	,@ShowIsNotCheck Bit = 1
	,@Lawsuit int = 2
	,@Date1 Datetime = '2008-1-1'
	,@Date2 Datetime = '2017-12-31'
	,@EditDate1 Datetime = '2009-1-1'
	,@EditDate2 Datetime = '2017-12-31'
	,@CkEditDate Bit = 0
	,@CkDueDate Bit = 0

	,@ActiveOperationDate bit = 1,
    @OperationDateWith int = 2,
    @OperationDate1 Datetime = '4/8/2017',
    @OperationDate2 Datetime = '4/8/2017'

	,@ActiveChecksCollectionNote Bit = 0
	,@OperationChecksCollectionNote int = 0	
	,@ChecksCollectionNote Varchar(256) = '' 

	,@ActiveNote Bit = 0
	,@OperationNote int = 0
	,@CheckNote  Varchar(256) = ''

	,@uActiveNote Bit = 0
	,@uOperationNote int = 0
	,@uCheckNote  Varchar(256) = ''

	,@ActiveContractList Bit = 0
	,@ActiveBuildingList Bit = 0
	,@UnLinkContractOnly Bit = 0
	,@UnLinkContract Bit = 0
	,@SMS int = 2
	,@Mark Bit = 1
	,@NotMark Bit = 1
	,@Deposition int = 2
)
 
as

	Set NoCount On


	---  Parameter ----------
	Set @Account = ISNULL(@Account, 0x0)
    Set	@obverseAccount = IsNull(@obverseAccount, 0x0)
	Set @AccountWith = ISNULL(@AccountWith, 3)
    Set	@BranchGuid = IsNull(@BranchGuid, 0x0)
    Set	@ContractGuid = IsNull(@ContractGuid, 0x0)
    Set	@SalesManGuid = IsNull(@SalesManGuid, 0x0)
	Set @BankName = isNull(@BankName, '')
    Set	@FlatGuid = IsNull(@FlatGuid, 0x0)
    Set	@ShopGuid = IsNull(@ShopGuid, 0x0)
    Set	@ParkingGuid = IsNull(@ParkingGuid, 0x0)
	Set	@beneficiary = ISNULL(@beneficiary, '')
	Set @NonState  = ISNULL(@NonState, 0)
	Set @CkEnd = ISNULL(@CkEnd, 0)
	Set @ChecksPartialCollection = ISNULL(@ChecksPartialCollection, 0)
	Set @ChecksPartialCollectionOption = ISNULL(@ChecksPartialCollectionOption, 2)
	Set @ShowStateOnly = isNull(@ShowStateOnly, 1)
	Set @IsPosted = ISNULL(@IsPosted, 0)
	Set @IsEndorsement = ISNULL(@IsEndorsement, 0)
	Set @IsReturn = ISNULL(@IsReturn, 0)
	Set @ReturnCause = ISNULL(@ReturnCause, '')
	Set @CbEndReturn = ISNULL(@CbEndReturn, 2)
	Set @ShowIsCheck  = ISNULL(@ShowIsCheck, 1)
	Set @ShowIsNotCheck = ISNULL(@ShowIsNotCheck, 1)
	Set @Lawsuit = ISNULL(@Lawsuit,2)
	Set @Date1 = ISNULL(@Date1, Cast(Cast(DATEPART(YEAR, GETDATE()) as varchar(4))+ '-01-01' as Datetime))
	Set @Date2  = ISNULL(@Date2, Cast(Cast(DATEPART(YEAR, GETDATE()) as varchar(4))+ '-12-31' as Datetime))
	Set @EditDate1 = ISNULL(@EditDate1, Cast(Cast(DATEPART(YEAR, GETDATE()) as varchar(4))+ '-01-01' as Datetime))
	Set @EditDate2  = ISNULL(@EditDate2, Cast(Cast(DATEPART(YEAR, GETDATE()) as varchar(4))+ '-12-31' as Datetime))
	Set @CkEditDate  = ISNULL(@CkEditDate, 0)
	Set @CkDueDate  = ISNULL(@CkDueDate, 0)
	Set @ActiveOperationDate = ISNULL(@ActiveOperationDate, 0)
    Set @OperationDateWith  = ISNULL(@OperationDateWith, 1)
	Set @OperationDate1 = ISNULL(@OperationDate1, Cast(Cast(DATEPART(YEAR, GETDATE()) as varchar(4))+ '-01-01' as Datetime))
	Set @OperationDate2  = ISNULL(@OperationDate2, Cast(Cast(DATEPART(YEAR, GETDATE()) as varchar(4))+ '-12-31' as Datetime))
	Set @ActiveChecksCollectionNote  = ISNULL(@ActiveChecksCollectionNote, 0)
	Set @OperationChecksCollectionNote = ISNULL(@OperationChecksCollectionNote, 0)	
	Set @ChecksCollectionNote  = ISNULL(@ChecksCollectionNote, '')
	Set @ActiveNote = ISNULL(@ActiveNote, 0)
	Set @OperationNote = ISNULL(@OperationNote, 0)
	Set @CheckNote = ISNULL(@CheckNote, '')
	Set @uActiveNote  = ISNULL(@uActiveNote, 0)
	Set @uOperationNote = ISNULL(@uOperationNote, 0)
	Set @uCheckNote = ISNULL(@uCheckNote, '')
	Set @ActiveContractList = ISNULL(@ActiveContractList, 0)
	Set @ActiveBuildingList = ISNULL(@ActiveBuildingList, 0)
	Set @UnLinkContractOnly = ISNULL(@UnLinkContractOnly, 0)
	Set @UnLinkContract = ISNULL(@UnLinkContract, 0)
	Set @SMS = ISNULL(@SMS, 2)
	Set @Mark = ISNULL(@Mark, 1)
	Set @NotMark = ISNULL(@NotMark, 1)
	Set @Deposition = ISNULL(@Deposition, 2)
	----End Parameter ---------


	Declare @Msg varchar(255),
			@MsgConst varchar(255)
	Set @MsgConst = dbo.SC('  ')
			
	Set @Msg = @MsgConst
	exec PrcSetProgrss @Msg, 100, 0

	--  
	if @OperationChecksCollectionNote = 0 --
	Set @ChecksCollectionNote = '%'+@ChecksCollectionNote+'%'
	
	--  
	if @OperationNote = 0 --
	Set @CheckNote = '%'+@CheckNote+'%'

	--  
	if @uOperationNote = 0 --
	Set @uCheckNote = '%'+@uCheckNote+'%'

	-- 
	if @Date2 = '1899-12-30'
	Select @Date2 = Max([DueDate]) From [Checks]

	if @EditDate2 = '1899-12-30'
	Select @EditDate2 = Max([Date]) From [Checks]

	Declare @Check Bit,
			@NotCheck Bit
	Set @Check = 1
	Set @NotCheck = 0

	Create 	Table #R
	(
		[Number] int,
		[TypeName] Varchar(256),
		[IsPosted] Varchar(256),
		[IsCollection] Varchar(256),
		[IsPartialCollection] Varchar(256),
		[IsEndorsement] Varchar(256),
		[IsReturned] Varchar(256),
		[CollectionValue] Float,		
		[RestValue] Float,		

		[PostedDate] Datetime,
		[CollectionDate] Datetime,
		[EndorsementDate] Datetime,
		[ReturnedDate] Datetime,
		[ReturnFine] Float,
		
		[ReturnedFinishDate] Datetime,
		[ReturnedFinished] bit,
		

		[AccountCode]Varchar(256),
		[AccountName]Varchar(256),
		[ObverseAccountCode] Varchar(256),
		[ObverseAccountName] Varchar(256),
		[No] Varchar(256),
		[Value] Float,
		[Date] DateTime,
		[DueDate] DateTime,
		[endDueDate] DateTime,
		[BankName]Varchar(256),
		[Note] Varchar(256),
		[Note3] Varchar(4000),
		[BuildingName] Varchar(256),
		[FlatNo] Varchar(256),
		[FloorNo] Varchar(256),
		[beneficiary] Varchar(256),
		[Check] Bit,
		[Lawsuit] Bit,
		[checkkind] int,
		[Guid] UniqueIdentifier,

		[Emirate] Varchar(256),
		[BuildingArea] Varchar(256),
		[Suburb] Varchar(256),
		[Street] Varchar(256),
		[BasinNo] Varchar(256),
		[PieceNo] Varchar(256),
		[BuildingNo] Varchar(256),
		[BondType] Varchar(256),
		[BondNo] Varchar(256),
		[SalesMan] Varchar(256),
		[FlatKind] Varchar(256),
		[ApartmentType] Varchar(256),
		[Class] Varchar(256),
		[FlatArea] Varchar(256),
		[FlatAreaunity] Varchar(256),
		[CustomerPhonejob]  Varchar(256),
		[CustomerMobile] Varchar(256),
		[CustomerNationality] Varchar(256),
		[BuildingGuid] uniqueidentifier,
		[SalesManGuid] uniqueidentifier,
		[CheckCurrencyGuid] uniqueidentifier,
		[SMSSended] Bit,
		[SMSCount] int,
		[Mark] Bit,
		[Deposition] Bit,
		[ContractGuid] uniqueidentifier,
		[ContractValue] Float,
		[EntryNo] int,
		[CostGuid] uniqueidentifier,
		[CostObverseGuid] uniqueidentifier,
		AccountGuid uniqueidentifier,
		[obverseAccountGuid] uniqueidentifier,
		[CostDebit] Varchar(256),
		[CostCredit] Varchar(256)
	)
	Set @Msg = @MsgConst+' .'
	exec PrcSetProgrss @Msg, 100, 5

	Select 
		[ObjGuid],
		[IdReport],
		Count(*) as [Count]
	into #RepSMS3
	From
		[RepSMSCount] 
	where
		[IdReport] = 3003
	Group By
		[ObjGuid],
		[IdReport]

	Select 
		[CheckGuid],
		Sum([Value]) as [Value] 
	into #ChecksPartialCollection
	From
		[ChecksPartialCollection] 
	Group By
		[CheckGuid]
					
	Select	* into #vwChecksCollection0	From vwChecksCollection	where [Kind] = 0
	Select	* into #vwChecksCollection1	From vwChecksCollection	where [Kind] = 1
	Select	* into #vwChecksCollection2	From vwChecksCollection	where [Kind] = 2
	Select	* into #vwChecksCollection3	From vwChecksCollection	where [Kind] = 3
	
	CREATE CLUSTERED INDEX #IXCheckGuid0 ON #vwChecksCollection0([CheckGuid])	
	CREATE CLUSTERED INDEX #IXCheckGuid1 ON #vwChecksCollection1([CheckGuid])	
	CREATE CLUSTERED INDEX #IXCheckGuid2 ON #vwChecksCollection2([CheckGuid])	
	CREATE CLUSTERED INDEX #IXCheckGuid3 ON #vwChecksCollection3([CheckGuid])	
	
	Insert into #R
	Select 
		[P].[Number],
		[P].[TypeName],

		Case when [C].[CheckGuid] is null then '' else dbo.SC('') end as [IsPosted],

		Case
			when ([C1].[CheckGuid] is Null) then '' 
			when ([C1].[CheckGuid] is Not Null) then dbo.SC('') 
		end as [IsCollection],

		Case 
			when [C4].[CheckGuid] is Null then '' 
			when ([C4].[CheckGuid] is Not Null ) then dbo.SC(' ')
		end as [IsPartialCollection],

		Case when [C2].[CheckGuid] is null then '' else dbo.SC('') end as [IsEndorsement],
		Case when [C3].[CheckGuid] is null then '' else dbo.SC('') end as [IsReturned],

		[C4].[Value] as [CollectionValue],
		[P].[Value] - [C4].[Value] as [RestValue],

		[C].[Date] as [PostedDate],
		[C1].[Date] as [CollectionDate],
		[C2].[Date] as [EndorsementDate],
		[C3].[Date] as [ReturnedDate],
		[C3].[Delay] as [ReturnFine],

		[C3].[FinishDate] as [ReturnedFinishDate],
		[C3].[Finished] as [ReturnedFinished],

		[P].[AccountCode],
		[P].[AccountName],

		[P].[ObverseAccountCode],
		[P].[ObverseAccountName]

		,[P].[No]
		,[P].[Value]
		,[P].[Date]
		,[P].[DueDate]
		,[P].[EndDueDate]
		,[P].[BankName]
		,[P].[Note]
		,[P].[Note3]
		,'' as [BuildingName]
		,'' as [FlatNo]
		,'' as [FloorNo]
		,p.[beneficiary]
		
		,@NotCheck as [Check]
		,[Lawsuit]	 
		,[checkkind]
		,[P].[Guid]

		,'' as [Emirate]
		,'' as [BuildingArea]
		,'' as [Suburb]
		,'' as [Street]
		,'' as [BasinNo]
		,'' as [PieceNo]
		,'' as [BuildingNo]
		,'' as [BondType]
		,'' as [BondNo]
		,'' as [SalesMan]
		,'' as [FlatKind]
		,'' as [ApartmentType]
		,'' as [Class]
		,'' as [FlatArea]
		,'' as [FlatAreaunity]
		,'' as [CustomerPhonejob]
		,'' as [CustomerMobile]
		,'' as [CustomerNationality]
		,0x0 as [BuildingGuid]
		,0x0 as [SalesManGuid]
		,[P].[CurrencyGuid] as [CheckCurrencyGuid]
			 
		,@NotCheck as [SMSSended],
			 
		Cast(0 as int) as [SMSCount],

		[P].[Mark],
		[p].[Deposition],
		[P].[ContractGuid],
		0 as [ContractValue],
		0 as [EntryNo],
		[P].[CostGuid],
		[p].[CostObverseGuid],
		[P].[Account] as AccountGuid,
		[P].[obverseAccount] as [obverseAccountGuid],
		'' as [CostDebit],
		'' as [CostCredit]
	From
		[vwChecks] [P]
		inner join [Resource] [RS] on [RS].[Guid] = [P].[TypeGuid] and [RS].[Spid] = @@Spid and [RS].[Kind] = 3000
		left join #vwChecksCollection0 [C] on [C].[CheckGuid] = [P].[Guid] 
		left join #vwChecksCollection1 [C1] on [C1].[CheckGuid] = [P].[Guid] 
		left join #vwChecksCollection2 [C2] on [C2].[CheckGuid] = [P].[Guid] 
		left join #vwChecksCollection3 [C3] on [C3].[CheckGuid] = [P].[Guid]  --
		left join #ChecksPartialCollection [C4] on [C4].[CheckGuid] = [P].[Guid]
  	where
  		(P.Lawsuit = @Lawsuit or @Lawsuit = 2)
		and (
			--([P].[Account] = @Account  and @AccountWith = 0) or
			([C].[DebitAccountGuid] = @Account  and @AccountWith = 1) or --
			([C1].[DebitAccountGuid] = @Account  and @AccountWith = 2) or -- 
			--([C4].[DebitAccountGuid] = @Account  and @AccountWith = 3) or --  
			([C2].[DebitAccountGuid] = @Account  and @AccountWith = 4) or -- 
			([C3].[DebitAccountGuid] = @Account  and @AccountWith = 5) --
			Or @Account = 0x0 
			or @AccountWith = 0
			or @AccountWith = 3
		)
		and(
			(C.Date between @OperationDate1 and @OperationDate2 and @OperationDateWith = 0)
			or (C1.Date between @OperationDate1 and @OperationDate2 and @OperationDateWith = 1)
			or ( C4.CheckGuid is Not Null  and @OperationDateWith = 2)
			or (C2.Date between @OperationDate1 and @OperationDate2 and @OperationDateWith = 3)
			or (C3.Date between @OperationDate1 and @OperationDate2 and @OperationDateWith = 4)
			or (C3.FinishDate between @OperationDate1 and @OperationDate2 and @OperationDateWith = 5)
			
			or @ActiveOperationDate = 0
			--or @AccountWith = 0 -- 
			)

		and
		(
			--([P].[obverseAccount] = @obverseAccount  and @AccountWith = 0) or
			([C].[creditAccountGuid] = @obverseAccount  and @AccountWith = 1) or
			([C1].[creditAccountGuid] = @obverseAccount  and @AccountWith = 2) or
			--([C4].[creditAccountGuid] = @obverseAccount  and @AccountWith = 3) or
			([C2].[creditAccountGuid] = @obverseAccount  and @AccountWith = 4) or
			([C3].[creditAccountGuid] = @obverseAccount  and @AccountWith = 5)
			Or @obverseAccount = 0x0
			or @AccountWith = 0
			or @AccountWith = 3
		)

 		and ([P].[BranchGuid] = @BranchGuid or @BranchGuid = 0x0)
 		and ([P].[beneficiary] = @beneficiary or @beneficiary = '')
  		and ([P].[BankName] = @BankName or @BankName = '')
  		and ([P].[ContractGuid] = @ContractGuid or @ContractGuid = 0x0)
		and ([p].[SalesManGuid] = @SalesManGuid or @SalesManGuid = 0x0)
		and (
					(
  						--
  						(
  							(
  							(Case when [C2].[CheckGuid] is null then 0 else 1 end = 1)
							and (Case when [C].[CheckGuid] is null then 0 else 1 end = 0)
							and (Case when [C1].[CheckGuid] is null then 0 else 1 end = 0)
							and (Case when [C3].[CheckGuid] is null then 0 else 1 end = 0)
							and (Case when [C4].[CheckGuid] is null then 0 else 1 end = 0)
							)
  							and @IsEndorsement = 1
						)
					)
				or(
  						--  
  						(
  							(
  							(Case when [C].[CheckGuid] is null then 0 else 1 end = 1)
  							and (Case when [C2].[CheckGuid] is null then 0 else 1 end = 0)
							and (Case when [C1].[CheckGuid] is null then 0 else 1 end = 0)
							and (Case when [C3].[CheckGuid] is null then 0 else 1 end = 0)
							and (Case when [C4].[CheckGuid] is null then 0 else 1 end = 0)
							)
							and @IsPosted = 1
						)
						
					)
					
				or(
						-- 
						(
  							(
  							(Case when [C2].[CheckGuid] is null then 0 else 1 end = 0)
							and (Case when [C3].[CheckGuid] is null then 0 else 1 end = 0)
							)
							and (Case 
								when ([C1].[CheckGuid] is Null) then 0
								when ([C1].[CheckGuid] is Not Null) then 1
							end = 1 )
							and @CkEnd = 1
							
						)
						
					)
				or(
						-- 
						(
  							(
									Case when [C3].[CheckGuid] is null then 0 else 1 end = 1 
									and ([C3].[Finished] = @CbEndReturn or @CbEndReturn = 2)
									
									--     
									and [C4].[CheckGuid] is Null
									
									and (IsNull([C3].ReturnCause,'') = @ReturnCause or @ReturnCause = '')
								)
								and @IsReturn = 1
						)
						
					)
  				or (
		  				
  						--  	
  						(
							(Case 
								when [C4].[CheckGuid] is Null then 0
								when ([C4].[CheckGuid] is Not Null ) then
								Case 
									when ([C4].Value < P.Value and @ChecksPartialCollectionOption = 1) or @ChecksPartialCollectionOption = 2 then 1
									when ([C4].Value >= P.Value and @ChecksPartialCollectionOption = 0) or @ChecksPartialCollectionOption = 2 then 1
								end
							end = 1 )
							and @ChecksPartialCollection = 1
						)
						
  					)
  					
 				or (
 						(
 							(Case when [C].[CheckGuid] is null then 0 else 1 end = 0)
 							and (Case when [C1].[CheckGuid] is null then 0 else 1 end = 0)
 							and (Case when [C2].[CheckGuid] is null then 0 else 1 end = 0)
 							and (Case when [C3].[CheckGuid] is null then 0 else 1 end = 0)
 							and (Case when [C4].[CheckGuid] is null then 0 else 1 end = 0)
 						)
 						and @NonState = 1
 					)
 					
  			)
	  		
 		and ([P].[DueDate] Between @Date1 And @Date2 or @CkDueDate = 0)
 		and ([P].[Date] Between @EditDate1 And @EditDate2 or @CkEditDate = 0)
 
 		and 
 			(
 				[P].[Note3] Like @CheckNote 
 				or @ActiveNote = 0
 			)
 			
 		and 
 			(
 				[P].[Note] Like @uCheckNote
				or [P].[Note2] Like @uCheckNote
 				or @uActiveNote = 0
 			)

 		and 
 			(
 				[C].[Note] Like @ChecksCollectionNote 
 				 or [C1].[Note] Like @ChecksCollectionNote
 				 or [C2].[Note] Like @ChecksCollectionNote
 				 or [C3].[Note] Like @ChecksCollectionNote
 				or @ActiveChecksCollectionNote = 0
 			)
		and (
				(isNull([P].[Mark],0)= 1 and @Mark = 1)
				or (isNull([P].[Mark],0) = 0 and @NotMark = 1)
			)
		and (
				isNull([p].[Deposition],0) = @Deposition or @Deposition = 2
			)

	--Select * from #R Return
	
	if (@ActiveOperationDate = 1) and (@OperationDateWith = 2)
	begin
		Select Distinct
			R.Guid
		into #DelOperationDate2
		from
			#R R
			inner join [ChecksPartialCollection] P on p.CheckGuid = R.Guid
		where
			Not (P.Date between @OperationDate1 and @OperationDate2) 

		--Select * from #DelOperationDate2
		
		Delete #R 
		from
			#R R
			inner join #DelOperationDate2 P on p.Guid = R.Guid
	end

	
	Update #R Set AccountName = dbo.SC(' '), 
				  AccountCode = dbo.SC(' ')
	From
		#R R
		inner join ChecksAccountDetail D on D.[ParentGuid] = R.Guid and Kind = 1
		
	Update #R Set ObverseAccountName = dbo.SC(' '),
				  ObverseAccountCode = dbo.SC(' ')
	From
		#R R
		inner join ChecksAccountDetail D on D.[ParentGuid] = R.Guid and Kind = 2


										   
	 if (@Account <> 0x0) and (@AccountWith = 0)
	 begin
		
		Select 
			Distinct [ParentGuid]
		into #ChecksAccountDetail1
		from 
			ChecksAccountDetail D
			inner join #R R on D.[ParentGuid] = R.Guid and Kind = 1 and D.[AccountGuid] = @Account
			
		Delete #R
		From
			#R R
			left join #ChecksAccountDetail1 D on D.[ParentGuid] = R.Guid 
		where
			(D.[ParentGuid] is Null)
			and (R.AccountGuid <> @Account)
	 end
	
	 if (@obverseAccount <> 0x0) and (@AccountWith = 0)
	 begin
		Select 
			Distinct [ParentGuid]
		into #ChecksAccountDetail2
		from 
			ChecksAccountDetail D
			inner join #R R on D.[ParentGuid] = R.Guid and Kind = 2 and D.[AccountGuid] = @obverseAccount

		Delete #R
		From
			#R R
			left join #ChecksAccountDetail2 D on D.[ParentGuid] = R.Guid 
		where
			D.[ParentGuid] is Null
			and (R.obverseAccountGuid <> @obverseAccount)
			
	 end
	 
	 

	Set @Msg = @MsgConst+' ..'
	exec PrcSetProgrss @Msg, 100, 60

	update #R Set [Check] = @Check
	From	
		#R C
		inner join RepCheck R on [R].[ObjGuid] = [C].[Guid] and [R].[IdReport] = 3000

	if @ShowIsCheck = 0
	Delete #R where [Check] = 1
	
	if @ShowIsNotCheck = 0
	Delete #R where [Check] = 0
		

	update #R Set SMSSended = @Check
	From	
		#R P
		inner join [RepSMS] [SMS2] on [SMS2].[ObjGuid] = [P].[Guid] and [SMS2].[IdReport] = 3003

	if @SMS <> 2
	Delete #R where SMSSended <> @SMS

	update #R Set SMSCount = SMS3.[COUNT]
	From
		#R p
		inner join #repSMS3 [SMS3] on [SMS3].[ObjGuid] = [P].[Guid]		

	--      
	if @ShowStateOnly = 1
	delete
		#R
	where
		([IsPosted] <> '' and ((@CkEnd = 1 and [IsCollection] <> '') or (@ChecksPartialCollection = 1 and [IsPartialCollection] <> '') or (@IsEndorsement = 1 and [IsEndorsement] <> '') or (@IsReturn = 1 and [IsReturned] <> '')))
		or ([IsCollection] <> '' and ((@IsPosted = 1 and [IsPosted] <> '') or (@ChecksPartialCollection = 1 and [IsPartialCollection] <> '') or (@IsEndorsement = 1 and [IsEndorsement] <> '') or (@IsReturn = 1 and [IsReturned] <> '')))
		or ([IsPartialCollection] <> '' and ((@CkEnd = 1 and [IsCollection] <> '') or (@IsPosted = 1 and [IsPosted] <> '') or (@IsEndorsement = 1 and [IsEndorsement] <> '') or (@IsReturn = 1 and [IsReturned] <> '')))
		or ([IsEndorsement] <> '' and ((@CkEnd = 1 and [IsCollection] <> '') or (@IsPosted = 1 and [IsPosted] <> '') or (@ChecksPartialCollection = 1 and [IsPartialCollection] <> '') or (@IsReturn = 1 and [IsReturned] <> '')))
		or ([IsReturned] <> '' and ((@CkEnd = 1 and [IsCollection] <> '') or (@IsPosted = 1 and [IsPosted] <> '') or (@ChecksPartialCollection = 1 and [IsPartialCollection] <> '') or (@IsEndorsement = 1 and [IsEndorsement] <> '')))
	------------------
	
	Set @Msg = @MsgConst+' ...'
	exec PrcSetProgrss @Msg, 100, 65

	--     
	if (@AccountWith = 3) and (@Account <> 0x0)
	delete
		[#R]
	from
		[#R] R
		inner join [ChecksPartialCollection] P on R.Guid = P.CheckGuid and P.[DebitAccountGuid] <> @Account

	--Select 	
	--	*
	--from
	--	[#R] R
	--	inner join [ChecksPartialCollection] P on R.Guid = P.CheckGuid and P.[CreditAccountGuid] = @obverseAccount

	if (@AccountWith = 3) and (@obverseAccount <> 0x0)
	delete
		[#R]
	from
		[#R] R
		inner join [ChecksPartialCollection] P on R.Guid = P.CheckGuid and P.[CreditAccountGuid] <> @obverseAccount

	--    
	if @UnLinkContractOnly = 1
	Delete #R
	where
		ContractGuid Is not Null

	--Select * from #R return
	
	--    
	if @FlatGuid <> 0x0
	Delete #R
	From
		#R [P]
		left join [vwAllContract] [L] on [L].[Guid] = [P].[ContractGuid]
	where
 		([L].RealtyGuid <> @FlatGuid )

	--    
	if @ShopGuid <> 0x0
	Delete #R
	From
		#R [P]
		left join [vwAllContract] [L] on [L].[Guid] = [P].[ContractGuid]
	where
 		([L].RealtyGuid <> @ShopGuid )
 				

	--    
	if @ParkingGuid <> 0x0
	Delete #R
	From
		#R [P]
		left join [vwAllContract] [L] on [L].[Guid] = [P].[ContractGuid]
	where
 		([L].RealtyGuid <> @ParkingGuid )

	Set @Msg = @MsgConst+' '+ '....'
	exec PrcSetProgrss @Msg, 100, 70

	if @UnLinkContractOnly = 0
	Update #R
	Set
		[BuildingName] = [L].[BuildingName]
		,[FlatNo] = [L].[FlatNo]
		,[FloorNo] = [L].[FloorNo]
		,[Emirate] = [L].[Emirate]
		,[BuildingArea] = [L].[BuildingArea]
		,[Suburb] = [L].[Suburb]
		,[Street] = [L].[Street]
		,[BasinNo] = [L].[BasinNo]
		,[PieceNo] = [L].[PieceNo]
		,[BuildingNo] = [L].[BuildingNo]
		,[BondType] = [L].[BondType]
		,[BondNo] = [L].[BondNo]
		,[FlatKind] = [L].[FlatKind]
		,[ApartmentType] = [L].[ApartmentType]
		,[Class] = [L].[Class]
		,[FlatArea] = [L].[FlatArea]
		,[FlatAreaunity] = [L].[FlatAreaunity]
		,[CustomerPhonejob] = [L].[CustomerPhonejob]
		,[CustomerMobile] = [L].[CustomerMobile]
		,[CustomerNationality] = [L].[CustomerNationality]
		,[BuildingGuid]= [L].[BuildingGuid]
		,[SalesManGuid] = [L].[SalesManGuid]
		,[ContractValue] = L.[RentAfterDiscount]
	From
		#R [P]
		inner join [vwLeaseApartment] [L] on [L].[Guid] = [P].[ContractGuid]
	where
 		(([L].[ApartmentGuid] = @FlatGuid or @FlatGuid = 0x0))
 		and (([L].[ShopGuid] = @ShopGuid or @ShopGuid = 0x0))


	Set @Msg = @MsgConst+' '+ '.....'
	exec PrcSetProgrss @Msg, 100, 75

	if @UnLinkContractOnly = 0
	Update #R
	Set
		[BuildingName] = [L].[BuildingName]
		,[FlatNo] = [L].[PNo]
		,[FloorNo] = ''
		,[Emirate] = [L].[Emirate]
		,[BuildingArea] = [L].[BuildingArea]
		,[Suburb] = [L].[Suburb]
		,[Street] = [L].[Street]
		,[BasinNo] = [L].[BasinNo]
		,[PieceNo] = [L].[PieceNo]
		,[BuildingNo] = [L].[BuildingNo]
		,[BondType] = [L].[BondType]
		,[BondNo] = [L].[BondNo]
		,[SalesMan] = ''--[L].[SalesMan]
		,[FlatKind] = ''--[L].[FlatKind]
		,[ApartmentType] = ''--[L].[ApartmentType]
		,[Class] = [L].[Class]
		,[FlatArea] = [L].[FlatArea]
		,[FlatAreaunity] = [L].[FlatAreaunity]
		,[CustomerPhonejob] = [L].[CustomerPhonejob]
		,[CustomerMobile] = [L].[CustomerMobile]
		,[CustomerNationality] = [L].[CustomerNationality]
		,[BuildingGuid]= [L].[BuildingGuid]
		,[SalesManGuid] = [L].[SalesManGuid] 
		,[ContractValue] = L.[Rent]
	From
		#R [P]
		inner join (
					Select [Ll].*, 
							--[B].[Emirate],
							[B].[Area] as [BuildingArea],
							[B].[Suburb],
							[B].[Street],
							[B].[BasinNo],
							[B].[PieceNo],
							[B].[BuildingNo],
							[B].[BondType],
							[B].[BondNo],
							'' as [Class],
							[F].[Area] as [FlatArea],
							[F].[unity] as [FlatAreaunity]
					From
						[vwParkingContract] [Ll]
						inner join [Building] [B] on [B].[Guid] = [lL].[BuildingGuid]
						inner join [Parking] [F] on [F].[Guid] = [Ll].[ParkingGuid]

			) [L] on [L].[Guid] = [P].[ContractGuid]
	where
 		(([L].[ParkingGuid] = @ParkingGuid or @ParkingGuid = 0x0))


	Set @Msg = @MsgConst+' '+ '......'
	exec PrcSetProgrss @Msg, 100, 80

	--   
	Update #R
	Set
		[BuildingName] = [L].[Name]
		,[CustomerPhonejob] = [L].[CustomerPhonejob]
		,[CustomerMobile] = [L].[CustomerMobile]
		,[SalesManGuid] = [L].[SalesManGuid]
		,[ContractValue] = L.[Rent]
		,[CustomerNationality] = [L].[CustomerNationality]
	From
		#R [P]
		inner join [vwLandContract] [L] on [L].[Guid] = [P].[ContractGuid]


	UpDate #R Set [SalesMan] = [L].[Name] 
	From
		#R R
		inner join vwSalesman L on L.Guid = r.SalesManGuid

	--  
	UpDate #R Set EntryNo = IsNull([L].[EntryNum] ,0)
	From
		#R R
		inner join [LinkEntry_Checks] L on l.CheckGuid = R.Guid
	where
		l.Kind = 1600
		--inner join HEntry h on h.Guid = r.Guid


	--  
	if @ActiveContractList = 1
	begin

		Set @Msg = @MsgConst+' '+dbo.SC(' ')+ '.......'
		exec PrcSetProgrss @Msg, 100, 90

		Select 
			[R].[Guid]
		into #CheckContract	
		From
			#R [R]
			inner join [Checks] [K] On [K].[Guid] = [R].[Guid]
			inner join [vwAllContractGuid] [C] On [C].[Guid] = [K].[ContractGuid]
			inner join [Resource] [RS] on [RS].[Guid] = [C].[TypeGuid] and [RS].[Spid] = @@Spid and [RS].[Kind] = 102

		Delete #R
		From
			#R [R]
			left join #CheckContract [C] On [C].[Guid] = [R].[Guid]
		where
			[C].[Guid] is Null
			and ([ContractGuid] is Not Null or @UnLinkContract = 0)
	end

	
	Set @Msg = @MsgConst+' '+ '........'
	exec PrcSetProgrss @Msg, 100, 92


	-- 
	if @ActiveBuildingList = 1
	begin
		Update #R Set BuildingGuid = C.BuildingGuid
		From
			#R R
			inner join [LinkCheckContract] L on L.parentGuid = R.Guid
			inner join [vwLeaseApartment] C on C.Guid = L.ContractGuid

		Delete #R
		From
			#R [L]
			left join [Resource] [R] on [R].[Guid] = [L].[BuildingGuid] and [R].[Kind] = 99 and [R].[Spid] = @@Spid 
		where
			[R].[Guid] Is Null
			and L.BuildingGuid <> 0x0
			and ([ContractGuid] is not Null or @UnLinkContract = 0)
	end
	

	update #R Set CostDebit = substring(Co.code +'-'+ Co.Name, 0, 256)
	From
		#R R
		inner join Cost Co on R.CostGuid = Co.Guid

	update #R Set CostCredit = substring(Co.code +'-'+ Co.Name, 0, 256)
	From
		#R R
		inner join Cost Co on R.CostObverseGuid = Co.Guid

	Set @Msg = @MsgConst+' '+ '.........'
	exec PrcSetProgrss @Msg, 100, 95


	--Res1 
	Select Distinct *
		,0 As [OPeration] 
	Into #RR
	From 
		#R
		
	Select
		*
		--,dbo.FnStrToAscii([No]) as [Sort_No]
	From
		#RR
 	Order By
 		--dbo.FnStrToAscii([No]), 
 		[No],[dueDate]


	Update #RR
	Set 
		[IsPosted] = IsNull([IsPosted],''),
		[IsCollection] = IsNull([IsCollection],''),
		[IsPartialCollection] = IsNull([IsPartialCollection],''),
		[IsEndorsement] = IsNull([IsEndorsement],''),
		[IsReturned] = IsNull([IsReturned],'')
		
	Set @Msg = @MsgConst+' '+ '..........'
	exec PrcSetProgrss @Msg, 100, 95

	-- Res2
	Select
		[TypeName],
		--NotPosted
		Case when IsNull([IsPosted],'') = '' and (IsNull([IsCollection],'') = '' and IsNull([IsPartialCollection],'') = '')
				and (IsNull([IsEndorsement],'') = '') and IsNull([IsReturned],'') = '' 
		then Count(*) end as [IsNotPosted],
		
		Case when IsNull([IsPosted],'') = '' and (IsNull([IsCollection],'') = '' and IsNull([IsPartialCollection],'') = '')
				and (IsNull([IsEndorsement],'') = '') and IsNull([IsReturned],'') = '' 
		then Sum([Value]) end as [IsNotPostedValue],

		--Posted
		Case when 
					([IsPosted] <> '') and ([IsReturned] = '') and ([IsEndorsement] = '')
		then Count(*) end as [IsPosted],
		Case when 
					([IsPosted] <> '') and ([IsReturned] = '') and ([IsEndorsement] = '')
		then Sum([Value]) end as [IsPostedValue],

		--Collection
		Case when ([IsCollection] <> '' ) and (IsNull([IsReturned],'') = '') and(IsNull([IsEndorsement],'') = '')	
		then Count(*) end as [IsCollection],
		Case when ([IsCollection] <> '' ) and (IsNull([IsReturned],'') = '') and(IsNull([IsEndorsement],'') = '')	
		then Sum([Value]) end as [IsCollectionValue],

		--PartialCollection
		Case when 
			([IsPartialCollection] <> '' ) and ([IsCollection] = '') and ([IsEndorsement] = '')	
		then Count(*) end as [IsPartialCollection],
		Case when ([IsPartialCollection] <> '' ) and ([IsCollection] = '') and ([IsEndorsement] = '')	
		then Sum([CollectionValue]) end as [IsPartialCollectionValue],
		Case when ([IsPartialCollection] <> '' ) and ([IsCollection] = '') and ([IsEndorsement] = '')
		then Sum([restValue]) end as [RestValue],

		--Endorsement
		Case when ([IsEndorsement] <> '') and ([IsReturned] = '') 
		then Count(*) end as [IsEndorsement],
		Case when ([IsEndorsement] <> '') and ([IsReturned] = '') 
		then Sum([Value]) end as [IsEndorsementValue],

		--Returned
		Case when ([IsReturned] <> '' ) and ([IsPartialCollection] = '')
		then Count(*) end as [IsReturned],
		Case when ([IsReturned] <> '')  and ([IsPartialCollection] = '')
		then Sum([Value]) end as [IsReturnedValue],
		SUM([ReturnFine]) as [ReturnFine],

		Sum([Value]) as [Total],
		[checkkind]
	into #G
	From
		#RR
	Group By
		[TypeName],[Number],[checkkind],[IsPosted], [IsCollection],[IsPartialCollection], [IsEndorsement], [IsReturned]
	
		
	Set @Msg = @MsgConst+' '+ '...........'
	exec PrcSetProgrss @Msg, 100, 95
	
	Select
		[TypeName],
		Sum([IsNotPosted]) as [IsNotPosted],
		Sum([IsNotPostedValue]) as [IsNotPostedValue],
		Sum([IsPosted]) as [IsPosted],
		Sum([IsPostedValue]) as [IsPostedValue],
		Sum([IsCollection]) as [IsCollection],
		Sum([IsCollectionValue]) as [IsCollectionValue],
		Sum([IsPartialCollection]) as [IsPartialCollection],
		Sum([IsPartialCollectionValue]) as [IsPartialCollectionValue],
		Sum([RestValue]) as [RestValue],
		Sum([IsEndorsement]) as [IsEndorsement],
		Sum([IsEndorsementValue]) as [IsEndorsementValue],
		Sum([IsReturned]) as [IsReturned],
		Sum([IsReturnedValue]) as [IsReturnedValue],
		SUM([ReturnFine]) as [ReturnFine],
		isnull(Sum([IsNotPosted]),0)+isnull(Sum([IsPosted]),0) + isnull(Sum([IsCollection]),0) +	isnull(Sum([IsEndorsement]),0) +	isnull(Sum([IsReturned]),0) + isnull(Sum([IsPartialCollection]),0) [All],
		
		Sum([Total]) as [Total],
		Sum([Total]) * Case when [checkkind] = 0 then 1 else -1 end as [RTotal],
		0 as [Sort]
	Into #G2
	From
		#G
	Group By
		[TypeName], [checkkind]

	Insert into #G2
	Select
		dbo.SC('') as [TypeName],
		Sum([IsNotPosted]) as [IsNotPosted],
		Sum([IsNotPostedValue]) as [IsNotPostedValue],
		Sum([IsPosted]) as [IsPosted],
		Sum([IsPostedValue]) as [IsPostedValue],
		Sum([IsCollection]) as [IsCollection],
		Sum([IsCollectionValue]) as [IsCollectionValue],
		Sum([IsPartialCollection]) as [IsPartialCollection],
		Sum([IsPartialCollectionValue]) as [IsPartialCollectionValue],
		Sum([RestValue]) as [RestValue],
		Sum([IsEndorsement]) as [IsEndorsement],
		Sum([IsEndorsementValue]) as [IsEndorsementValue],
		Sum([IsReturned]) as [IsReturned],
		Sum([IsReturnedValue]) as [IsReturnedValue],
		SUM([ReturnFine]) as [ReturnFine],
		isnull(Sum([IsNotPosted]),0)+ isnull(Sum([IsPosted]),0) + isnull(Sum([IsCollection]),0) +	isnull(Sum([IsEndorsement]),0) +	isnull(Sum([IsReturned]),0) as [All],

		Sum([RTotal]) as [Total],
		Sum([RTotal]) as [RTotal],
		1 as [Sort]
	From
		#G2
	
	Set @Msg = ''
	exec PrcSetProgrss @Msg, 0, 0

	
	Select * from #G2  Order By Sort
	
	-- 
	Select 
		[TypeName],
		Case when dbo.FnMonth([DueDate]) = 1 then Sum([Value]) else 0 end as [Value1],
		Case when dbo.FnMonth([DueDate]) = 2 then Sum([Value]) else 0 end as [Value2],
		Case when dbo.FnMonth([DueDate]) = 3 then Sum([Value]) else 0 end as [Value3],
		Case when dbo.FnMonth([DueDate]) = 4 then Sum([Value]) else 0 end as [Value4],
		Case when dbo.FnMonth([DueDate]) = 5 then Sum([Value]) else 0 end as [Value5],
		Case when dbo.FnMonth([DueDate]) = 6 then Sum([Value]) else 0 end as [Value6],
		Case when dbo.FnMonth([DueDate]) = 7 then Sum([Value]) else 0 end as [Value7],
		Case when dbo.FnMonth([DueDate]) = 8 then Sum([Value]) else 0 end as [Value8],
		Case when dbo.FnMonth([DueDate]) = 9 then Sum([Value]) else 0 end as [Value9],
		Case when dbo.FnMonth([DueDate]) = 10 then Sum([Value]) else 0 end as [Value10],
		Case when dbo.FnMonth([DueDate]) = 11 then Sum([Value]) else 0 end as [Value11],
		Case when dbo.FnMonth([DueDate]) = 12 then Sum([Value]) else 0 end as [Value12]
	Into #Y
	from 
		#RR
	Group By
		[TypeName],
		[DueDate]


	Select
		[TypeName],
		Sum([Value1]) as [Value1],
		Sum([Value2]) as [Value2],
		Sum([Value3]) as [Value3],
		Sum([Value4]) as [Value4],
		Sum([Value5]) as [Value5],
		Sum([Value6]) as [Value6],
		Sum([Value7]) as [Value7],
		Sum([Value8]) as [Value8],
		Sum([Value9]) as [Value9],
		Sum([Value10]) as [Value10],
		Sum([Value11]) as [Value11],
		Sum([Value12]) as [Value12],
		Sum([Value1])+Sum([Value2])+Sum([Value3])+Sum([Value4])+Sum([Value5])+Sum([Value6])+Sum([Value7])+Sum([Value8])+Sum([Value9])+Sum([Value10])+Sum([Value11])+Sum([Value12]) as [All]
	from
		#Y
	Group By
		[TypeName]


	Declare @AllCount int
	Select @AllCount  = COUNT(*) from #R

	Select 
	[CustomerNationality], COUNT(*) as [Count] , 
	100.00 * COUNT(*) / @AllCount * 1.00 as [Percent] , @AllCount as AllCount from #R 
	group by
		[CustomerNationality]
	order by
		[Percent] desc
		
		

GO

SET ANSI_NULLS, QUOTED_IDENTIFIER ON
GO

Create Procedure [PrcCreateBeginMat]
(
	@ToDataBase Varchar(256) = 'StriktDb20143',
	@BillType uniqueidentifier = '1F0A773B-A080-474A-B76B-31C4F04947C8',

	@PriceMode int = 3,
	@SpecificPrice int = 0,
		
	@Date Datetime = '1/1/2014'
)
 
as
	Set Nocount on 
	
	declare @DefCurrency Varchar(256)
	Select @DefCurrency = Value from dmd_const where vName = 'DefCurrency'
	
	if dbo.fnobjectExists('##BillStore') = 1
	Drop Table ##BillStore
	
	if dbo.fnobjectExists('##MatPrice') = 1
	Drop Table ##MatPrice
	
	Create Table ##BillStore
	(
		id int identity(1,1),
		[BillGuid] uniqueidentifier default newid(),
		[StoreGuid] uniqueidentifier
	)

	insert into ##BillStore ([StoreGuid])
	Select Distinct [StoreGuid] from [MatBalance]

	Declare @Sql Varchar(5000)
	
--	Print @Sql
	Exec(@Sql)
	
	
	--
	Select	Distinct
		ParentGuid as MatGuid,
		mt.[DefUnity]
	into #MatDis
	From	
		[MatBalance] v
		inner join Mat mt on v.ParentGuid = mt.Guid
		
	Create Table ##MatPrice
	(
		[MatGuid] uniqueidentifier,
		[Price] Float
	)
	
	insert into ##MatPrice
	Select F.[MatGuid], Price 
	from 
		dbo.[FnMatPrice] (0x0, 1, 0,@PriceMode, @SpecificPrice) F
		inner join #MatDis Mt on Mt.MatGuid = F.MatGuid
	
	
	Set @Sql = '
	insert into '+@ToDataBase+'..[Bill]
	([Number], [Guid], [SecLvl], [TypeGuid], [Date], [CustGuid], [CurrencyGuid], [CurrencyVal], [PayType], [StoreGuid], [CustAccGuid], [CostGuid], [BranchGuid], [Class], [Note], [EntryGuid], [EntryNumber], [CheckCreateEntry], [ItemsTotal], [ItemsDiscount], [ItemsExtra], [BuExtra], [BuDiscount], [BuOnly], [IsPosted])
	Select
		id as [Number], 
		[BillGuid] as [Guid], 
		1 as [SecLvl], 
		'''+Cast(@BillType as Varchar(255))+''' as [TypeGuid], 
		'''+CAST(@Date as Varchar(255))+''' as [Date], 
		Null as [CustGuid], 
		'''+@DefCurrency+''' as [CurrencyGuid], 
		1 as [CurrencyVal], 
		0 as [PayType], 
		[StoreGuid] as [StoreGuid], 
		null as [CustAccGuid], 
		null as [CostGuid], 
		null as [BranchGuid], 
		'''' as [Class], 
		dbo.sc(''  '') as [Note], 
		Null as [EntryGuid], 
		0 as [EntryNumber], 
		0 as [CheckCreateEntry], 
		0 as [ItemsTotal], 
		0 as [ItemsDiscount], 
		0 as [ItemsExtra], 
		0 as [BuExtra], 
		0 as [BuDiscount], 
		'''' as [BuOnly], 
		1 as [IsPosted]
	from
		##BillStore'

--	Print @Sql
	Exec(@Sql)

	Declare @StoreGuid uniqueidentifier,
			@BillGuid uniqueidentifier
	
	DECLARE @cursor_Name CURSOR 
	Set @cursor_Name = CURSOR FAST_FORWARD FOR 

	SELECT [BillGuid] ,[StoreGuid] FROM ##BillStore

	OPEN @cursor_Name
	FETCH NEXT FROM @cursor_Name INTO @BillGuid, @StoreGuid
	
	WHILE @@FETCH_STATUS = 0
	BEGIN
			Set @Sql = '
			insert into '+@ToDataBase+'..[BillDetail]
			([Number], [ParentGuid], [MatGuid], [Qty], [Qty2], [Qty3], [Price], [TotalPrice], [Bonus], [StoreGuid], [DiscountPercent], [Discount], [ExtraPercent], [Extra], [Note], [ProductDate], [ExpireDate], [CostGuid], [Class], [Length], [width], [height], [Count], [ItemUnit])
			Select
				1 as [Number], 
				S.BillGuid as [ParentGuid], 
				b.[ParentGuid] as [MatGuid], 
				b.[Qty], 
				b.[Qty2], 
				b.[Qty3], 
				P.Price as [Price], 
				P.Price * b.Qty as [TotalPrice], 
				0 as [Bonus], 
				b.[StoreGuid], 
				0 as [DiscountPercent], 
				0 as [Discount], 
				0 as [ExtraPercent], 
				0 as [Extra], 
				dbo.sc(''  '') as [Note], 
				Null as [ProductDate], Null as [ExpireDate], 
				Null as [CostGuid], 
				'''' as [Class], 
				0 as [Length], 
				0 as [width], 
				0 as [height], 
				0 as [Count], 
				1 as [ItemUnit]
			From
				[MatBalance] B
				inner join ##BillStore S on S.StoreGuid = b.StoreGuid and S.BillGuid = '+''''+Cast(@BillGuid as varchar(255))+'''
				inner join ##MatPrice P on P.MatGuid = b.[ParentGuid]
			where
				(Qty > 0)

			'
		
			--Print @Sql
			Exec(@Sql)
		
			Set @Sql = 
			'exec '+@ToDataBase+'.dbo.PrcBill_BillPost '+''''+Cast(@BillGuid as varchar(255))+''''
		
		--	Print @Sql
			Exec(@Sql)

	  FETCH NEXT FROM @cursor_Name INTO @BillGuid, @StoreGuid
	
	END
	
	CLOSE @cursor_Name
	DEALLOCATE @cursor_Name

	Drop Table ##BillStore
	Drop Table ##MatPrice

GO

SET ANSI_NULLS, QUOTED_IDENTIFIER ON
GO

Create Procedure [PrcChangeFlatPrice]
(
	@BuildingGuid uniqueidentifier = 0x0,
	@ApartmentType Varchar(256) = '',
	@FlatKind Varchar(256) = '',
	@Area Float = 0,
	@NewDate Datetime = '1/1/2007',
	
	@Option Int = 2,
	
	@Rent Float = 1485,
	@NewRent  Float = 20,
	
	@RoundKind int  = 0

	,@SalesKind int = 1
	,@Note Varchar(256) = ''
	,@Overlooking Varchar(256) = ''
)
 
as
	--   
	if 	@Option  = 0
	begin
		insert into [ChangeFlatPrice]
		([Number],[ParentGuid],[Date],[Price],[CurrencyGuid], [Kind])
		Select
			isNull([M].[MaxNumber],1),
			[F].[Guid],
			@NewDate,
			dbo.FnMyRound(@Rent, @RoundKind),
			[F].[CostCurrencyGUID]
			,@SalesKind
		From
			[Apartment][F]
			left join (
							Select
								[ParentGuid],
								isnull(Max([Number]),0) + 1 as [MaxNumber]
							From
								[ChangeFlatPrice] [C]
							Group By
								[ParentGuid]
						) [M] on [M].[ParentGuid] = [F].[Guid]
		where 
			([F].[BuildingGuid] = @BuildingGuid or @BuildingGuid = 0x0) 
			and ([ApartmentType] = @ApartmentType or @ApartmentType = '')
			and ([FlatKind] = @FlatKind or @FlatKind = '')
			and ([Area] = @Area Or @Area = 0)
			and ([Note] = @Note or @Note = '')
			and ([F].[Overlooking] = @Overlooking or @Overlooking	 = '')
	
		Select @@RowCount as [RowCount]
	end


	if 	@Option  = 1
	begin
		insert into [ChangeFlatPrice]
		([Number],[ParentGuid],[Date],[Price],[CurrencyGuid], [Kind])
		Select
			isNull([M].[MaxNumber],1),
			[F].[Guid],
			@NewDate,
			dbo.FnMyRound([R].[Rent]+@Rent, @RoundKind),
			R.[RentCurrencyGuid]
			,@SalesKind
		From
			[Apartment][F]
			left join (
							Select
								[ParentGuid],
								isnull(Max([Number]),0) + 1 as [MaxNumber]
							From
								[ChangeFlatPrice] [C]
							Group By
								[ParentGuid]
						) [M] on [M].[ParentGuid] = [F].[Guid]
			left join (
							Select
								[ParentGuid],
								[Price] as [Rent],
								[CurrencyGuid] as [RentCurrencyGuid]
							From
								[ChangeFlatPrice] [C]
							where
								[Number] = (Select Max([Number]) From [ChangeFlatPrice] [C2] where [C].[ParentGuid] = [C2].[ParentGuid])									
						) [R] on [R].[ParentGuid] = [F].[Guid]
	
		where 
			([F].[BuildingGuid] = @BuildingGuid or @BuildingGuid = 0x0) 
			and ([ApartmentType] = @ApartmentType or @ApartmentType = '')
			and ([FlatKind] = @FlatKind or @FlatKind = '')
			and ([Area] = @Area Or @Area = 0)
			and ([Note] = @Note or @Note = '')
			and ([F].[Overlooking] = @Overlooking or @Overlooking	 = '')
	
		Select @@RowCount as [RowCount]
	end


	--   
	if 	@Option  = 2
	begin
		insert into [ChangeFlatPrice]
		([Number],[ParentGuid],[Date],[Price],[CurrencyGuid], [Kind])
		Select
			isNull([M].[MaxNumber],1),
			[F].[Guid],
			@NewDate,
			dbo.FnMyRound([R].[Rent]*@Rent, @RoundKind),
			R.[RentCurrencyGuid]
			,@SalesKind
		From
			[Apartment][F]
			left join (
							Select
								[ParentGuid],
								isnull(Max([Number]),0) + 1 as [MaxNumber]
							From
								[ChangeFlatPrice] [C]
							Group By
								[ParentGuid]
						) [M] on [M].[ParentGuid] = [F].[Guid]
			left join (
							Select
								[ParentGuid],
								[Price] as [Rent],
								[CurrencyGuid] as [RentCurrencyGuid]
							From
								[ChangeFlatPrice] [C]
							where
								[Number] = (Select Max([Number]) From [ChangeFlatPrice] [C2] where [C].[ParentGuid] = [C2].[ParentGuid])									
						) [R] on [R].[ParentGuid] = [F].[Guid]
	
		where 
			([F].[BuildingGuid] = @BuildingGuid or @BuildingGuid = 0x0) 
			and ([ApartmentType] = @ApartmentType or @ApartmentType = '')
			and ([FlatKind] = @FlatKind or @FlatKind = '')
			and ([Area] = @Area Or @Area = 0)
			and ([Note] = @Note or @Note = '')
			and ([F].[Overlooking] = @Overlooking or @Overlooking	 = '')
	
		Select @@RowCount as [RowCount]
	end
	

	--   
	if 	@Option  = 3
	begin
		insert into [ChangeFlatPrice]
		([Number],[ParentGuid],[Date],[Price],[CurrencyGuid], [Kind])
		Select
			isNull([M].[MaxNumber],1),
			[F].[Guid],
			@NewDate,
			dbo.FnMyRound([R].[Rent]+([R].[Rent]*@Rent /100), @RoundKind),
			R.[RentCurrencyGuid]
			,@SalesKind
		From
			[Apartment][F]
			left join (
							Select
								[ParentGuid],
								isnull(Max([Number]),0) + 1 as [MaxNumber]
							From
								[ChangeFlatPrice] [C]
							Group By
								[ParentGuid]
						) [M] on [M].[ParentGuid] = [F].[Guid]
			left join (
							Select
								[ParentGuid],
								[Price] as [Rent],
								[CurrencyGuid] as [RentCurrencyGuid]
							From
								[ChangeFlatPrice] [C]
							where
								[Number] = (Select Max([Number]) From [ChangeFlatPrice] [C2] where [C].[ParentGuid] = [C2].[ParentGuid])									
						) [R] on [R].[ParentGuid] = [F].[Guid]
	
		where 
			([F].[BuildingGuid] = @BuildingGuid or @BuildingGuid = 0x0) 
			and ([ApartmentType] = @ApartmentType or @ApartmentType = '')
			and ([FlatKind] = @FlatKind or @FlatKind = '')
			and ([Note] = @Note or @Note = '')
			and ([Area] = @Area Or @Area = 0)
			and ([F].[Overlooking] = @Overlooking or @Overlooking	 = '')
	
		Select @@RowCount as [RowCount]
	end

	--    
	if 	@Option  = 4
	begin
		insert into [ChangeFlatPrice]
		([Number],[ParentGuid],[Date],[Price],[CurrencyGuid], [Kind])
		Select
			isNull([M].[MaxNumber],1),
			[F].[Guid],
			@NewDate,
			dbo.FnMyRound(@NewRent, @RoundKind),
			R.[RentCurrencyGuid]
			,@SalesKind
		From
			[Apartment][F]
			left join (
							Select
								[ParentGuid],
								isnull(Max([Number]),0) + 1 as [MaxNumber]
							From
								[ChangeFlatPrice] [C]
							Group By
								[ParentGuid]
						) [M] on [M].[ParentGuid] = [F].[Guid]
			left join (
							Select
								[ParentGuid],
								[Price] as [Rent],
								[CurrencyGuid] as [RentCurrencyGuid]
							From
								[ChangeFlatPrice] [C]
							where
								[Number] = (Select Max([Number]) From [ChangeFlatPrice] [C2] where [C].[ParentGuid] = [C2].[ParentGuid])									
						) [R] on [R].[ParentGuid] = [F].[Guid]
	
		where 
			([F].[BuildingGuid] = @BuildingGuid or @BuildingGuid = 0x0) 
			and ([ApartmentType] = @ApartmentType or @ApartmentType = '')
			and ([Area] = @Area Or @Area = 0)
			and ([FlatKind] = @FlatKind or @FlatKind = '')
			and [R].[Rent] = @Rent
			and ([Note] = @Note or @Note = '')
			and ([F].[Overlooking] = @Overlooking or @Overlooking	 = '')
	
		Select @@RowCount as [RowCount]
	end

	

GO

SET ANSI_NULLS, QUOTED_IDENTIFIER ON
GO

Create Procedure [PrcPrintContract]
(
	@Guid uniqueidentifier = 'D0718394-B515-49FA-A93F-19F27E95CCF5'
	,@OnlyValue Varchar(256) = ''
	,@OnlyValueAr Varchar(256) = ''
	,@OnlyValueEn Varchar(256) = ''
	,@OnlyMonthlyValue Varchar(256) = ''
	,@OnlyArMonthlyValue Varchar(256) = ''
	,@OnlyLtnMonthlyValue Varchar(256) = ''
)
 
as
	----  
	Declare @ChecksCollection Float
	Select 
		@ChecksCollection = Sum([P].[Value])
	From
		[vwChecks] [P]
		left join [vwChecksCollection] [C1] on [C1].[CheckGuid] = [P].[Guid] and [C1].[Kind] = 1
		left join (
						Select 
							[CheckGuid],
							Sum([Value]) as [Value] 
						From
							[ChecksPartialCollection] 
						Group By
							[CheckGuid]
					) [C4] on [C4].[CheckGuid] = [P].[Guid]
		left join [vwChecksCollection] [C3] on [C3].[CheckGuid] = [P].[Guid] and [C3].[Kind] = 3
 	where
 		(P.[ContractGuid] = @Guid)
 		and (
		Case

			when  ([C1].[CheckGuid] is not null) or 
				  ([C4].[CheckGuid] is Not Null ) and ([C4].[Value] >= [P].[Value])	 then 1
			else
				0
		end ) = 1 
		and [C3].[CheckGuid] is Null
 			

	--  
	Declare @SumCheck Float, @SumCach Float, @SumPay Float
	
	Select
		@SumCheck = Sum([Value] * [CurrencyVal])
	From
		[Checks] [C]
		inner join (Select Distinct Guid From [Resource] where [Spid] = @@Spid) [R] on [R].[Guid] = [C].[Guid]
	where
		[ContractGuid] = @Guid

	Select
		@SumCach = isnull(Sum([Value] * [CurrencyVal]),0)
	From
		[vwContractCachPayment] [C]
		inner join (Select Distinct Guid From [Resource] where [Spid] = @@Spid) [R] on [R].[Guid] = [C].[Guid]
	where
		[ContractGuid] = @Guid

	--Select @SumPay , @SumCheck, @SumCach

	Set @SumPay = ISNULL(@SumCheck,0) + ISNULL(@SumCach,0)

 			
	Select * into #infofldBuidling from [fnInfoFld] (0x0, 0)
	
	Declare 
			@CreateByUser varchar(255),
			@CreateDate Datetime,

			@LastUpdateByUser varchar(255),
			@LastUpdateDate Datetime
	
		
	Select 
		GetDate() as [NowDate],
		dbo.FnFormatDate(GetDate()) as [NowDate_Gr],
		[A].[Number],
		[A].[ContractNo],
		[C].[ArName] as [CustArName],
		[C].[LtnName] as [CustLtnName],
		[C].[Address] as [CustomerAddress],
		[C].[Nationality] as [CustomerNationality],
		[C].[PassportNO] as [CustomerPassportNO], 
		[C].[Profession] as [CustomerProfession],
		[C].[Domicile] as [CustomerDomicile],
		[C].[DomicileEndDate] as [CustomerDomicileEndDate],
		[C].[Security] as [CustomerSecurity],
		[C].[MemoSecurity] as [CustomerMemoSecurity],
		[C].[BoxNo] as [CustomerBoxNo],
		[C].[PersonalityNo1] as [CustomerPersonalityNo1],
		[C].[PersonalityNo2] as [CustomerPersonalityNo2],
		[C].[PersonalityEndDate] as [CustomerPersonalityEndDate],
		[C].[Adjective]as [CustomerAdjective],
		[C].[Fax]	as [CustomerFax],
		[C].[PhoneJob]	as [CustomerPhoneJob],
		[C].[Mobile]	as [CustomerMobile],
		[C].[Email]	as [CustomerEmail],

		[C].[PassportNO] as [CustomerPassportNO],
		[C].[PassportExpireDate] as [CustomerPassportExpireDate],	
		dbo.FnFormatDate([C].[PassportExpireDate]) as [CustomerPassportExpireDate_Gr],

		[B].[Name] as [BuildingName],
		[B].[ArName] as [BuildingarName],
		[B].[LtnName] as [BuildingLtnName],
		
		Case when [LeaseKind] = 0 or [LeaseKind] = 2 then [P].[No] 
			 when [LeaseKind] = 1 or [LeaseKind] = 3 then [S].[No] 
		end
		as [No],
		Case when [LeaseKind] = 0 or [LeaseKind] = 2 then [P].[Emirate] 
			 when [LeaseKind] = 1 or [LeaseKind] = 3 then [S].[Emirate] 
		end
		as [RealtyEmirate],


		Case when [LeaseKind] = 0 or [LeaseKind] = 2 then [P].[FlatBondType] 
			 when [LeaseKind] = 1 or [LeaseKind] = 3 then [S].[ShopBondType] 
		end
		as [UnitBondType],

		Case when [LeaseKind] = 0 or [LeaseKind] = 2 then [P].[FlatBondNo] 
			 when [LeaseKind] = 1 or [LeaseKind] = 3 then [S].[ShopBondNo] 
		end
		as [UnitBondNo],

		Case when [LeaseKind] = 0 or [LeaseKind] = 2 then [P].[FlatBondDate] 
			 when [LeaseKind] = 1 or [LeaseKind] = 3 then [S].[ShopBondDate] 
		end
		as [UnitBondDate],

		[B].[Emirate],
		[B].[Suburb],
		[B].[Area],
		[B].[Street],
		[B].[BuildingNo],
		[B].[BondType] as [BuildingBondType],
		[B].[BondNo] as [BuildingBondNo],
		[B].[BondDate] as [BuildingBondDate],
		dbo.FnFormatDate([B].[BondDate]) as [BuildingBondDate_Gr],

		[B].[LtnEmirate],
		[B].[LtnArea],
		[B].[LtnSuburb],
		[B].[LtnStreet],
		
		[B].[BankName] as [BuildingBankName],
		[B].[BankAccCode] as [BuildingBankAccCode],
		
		[A].[ApartmentType] as [Descreption],
		Case when [P].[Guid] is not Null then [P].[FlatKind] else [S].[ShopKind] end as [FlatType],
        [A].[RentDuration],
        [A].[Rentype],
        [A].[TermsOfPayment],

		[A].[Rent] as [Value],
		[A].[DiscountPercent],
		[A].[DiscountValue],
		[A].[Rent] - [A].[DiscountValue] as [RentAfterDiscount],	

		@OnlyValue as [OnlyValue],
		@OnlyValueAr as [OnlyValueAr],
		@OnlyValueEn as [OnlyValueEn],
		@OnlyMonthlyValue as [OnlyMonthlyValue],
		@OnlyArMonthlyValue as [OnlyArMonthlyValue],
		@OnlyLtnMonthlyValue as [OnlyLtnMonthlyValue],
		[My].[Code] as [Currency],
		[Purpose],
		
		[EditDate] as [EditDate],
		dbo.[FnGetDayName]([EditDate], 0) as [DayNameofEditDate] ,
		dbo.[FnGetDayName]([EditDate], 1) as [LtnDayNameofEditDate] ,
		dbo.FnFormatDate([EditDate]) as [EditDate_Gr],
		
		[FromDate] as [FromDate],
		dbo.FnFormatDate([FromDate]) as [FromDate_Gr],
		
		[ToDate] as [ToDate],
		dbo.FnFormatDate([ToDate]) as [ToDate_Gr],
		
		DATEDIFF(DAY, ToDate, FromDate) as ContractDays,
		Case when ContractFinish = 1 then 
		DATEDIFF(DAY, ToDate, ContractFinishDate) 
		end as ContractDaysDifference,
		
		[A].[Note],
		[A].[Note2],
		[LeaseKind],

		[A].[ResidentCount],
		[A].[ElectricityInsurance],

	    [R].[Name] as [Rent_Name],
	    [R].[LtnName] as [Rent_LtnName],
	    [R].[Adjective]  as [Rent_Adjective],
	    [R].[Nationality]  as [Rent_Nationality],
	    [R].[Work]  as [Rent_Work],
	    [R].[PersonalityNo]   as [Rent_PersonalityNo],
		[R].[WorkCardNo]   as [Rent_CardNo],
	    [R].[Address]  as [Rent_Address],
	    [R].[Phone]  as [Rent_Phone],
	    [R].[Mobile]  as [Rent_Mobile],
	    [R].[BoxNo]  as [Rent_BoxNo],
		[R].[Fax]  as [Rent_FaxNo],
	    [R].[EMail]  as [Rent_EMail],
		
		[R].[PassportNO] as [Rent_PassportNO],
		[R].[PassportExpireDate] as [Rent_PassportExpireDate],	
		dbo.FnFormatDate([R].[PassportExpireDate]) as [Rent_PassportExpireDate_Gr],

		[B].[PieceNo],
		[B].[BasinNo],	
		[P].[FloorNo],
		
		Case when [P].[Guid] is not Null then [P].[Area] else [S].[Area] end as [FlatArea],
		Case when [P].[Guid] is not Null then [P].[unity] else [S].[unity] end as [FlatAreaunity],

		Case when [P].[Guid] is not Null then [P].[LtnFlatKind] else [S].[LtnShopKind] end as [FlatLtnFlatKind],
		Case when [P].[Guid] is not Null then [P].[LtnApartmentType] else [S].[LtnDescription] end as [FlatLtnApartmentType],
		Case when [P].[Guid] is not Null then [P].[Class] else [S].[Class] end as [RealtyClass],
		Case when [P].[Guid] is not Null then [P].[LtnClass] else '' end as [FlaLtnClass],
		Case when [P].[Guid] is not Null then [P].[LtnOverlooking] else [S].[LtnOverlooking] end as [FlatLtnOverlooking],

		[A].[RentContractType],
		[A].[MonthlyValue],
		[A].[MonthlyValue] * 12.00 as [YearValue],

		Case when [LeaseKind] = 0 or [LeaseKind] = 2 then [P].[WaterCounter] 
			 when [LeaseKind] = 1 or [LeaseKind] = 3 then [S].[WaterCounter] 
		end as [WaterCounter],

		Case when [LeaseKind] = 0 or [LeaseKind] = 2 then [P].[ElectricityCounter] 
			 when [LeaseKind] = 1 or [LeaseKind] = 3 then [S].[ElectricityCounter] 
		end as [ElectricityCounter],

		[A].[ElectricityCounter] as [ContractElectricityCounter],

		[A].[License1No],
		[A].[License2No],
		[A].[License3No],
		[A].[License1Date1],
		dbo.FnFormatDate([A].[License1Date1]) as [License1Date1_Gr],
		[A].[License2Date1],
		dbo.FnFormatDate([A].[License2Date1]) as [License2Date1_Gr],
		[A].[License3Date1],
		dbo.FnFormatDate([A].[License3Date1]) as [License3Date1_Gr],
		[A].[License1Date2],
		dbo.FnFormatDate([A].[License1Date2]) as [License1Date2_Gr],
		[A].[License2Date2],
		dbo.FnFormatDate([A].[License2Date2]) as [License2Date2_Gr],
		[A].[License3Date2],
		dbo.FnFormatDate([A].[License3Date2]) as [License3Date2_Gr],

		[A].[Ltnwhereabouts],
		[A].[LtnPurpose],
		[A].[LtnRentDuration],
		[A].[LtnRentype],
		[A].[LtnTermsOfPayment],
		[A].[Trademark],
		[C].[Trademark] as [CustomerTrademark],

	    [OW].[Name] as [Owner_Name],
	    [OW].[LtnName] as [Owner_LtnName],
	    [OW].[Nationality]  as [Owner_Nationality],
	    [OW].[PersonalityNo]   as [Owner_PersonalityNo],
	    [OW].[Address]  as [Owner_Address],
	    [OW].[Phone]  as [Owner_Phone],
	    [OW].[Mobile]  as [Owner_Mobile],
	    [OW].[BoxNo]  as [Owner_BoxNo],
		[OW].[Fax]  as [Owner_FaxNo],
	    [OW].[EMail]  as [Owner_EMail],
		[Sl].[Name] as [SalesMan],
		[Sl].[ltnName] as [SalesManltnName],
		[T].[Code] as [TypeCode],
		[T].[Code]+CAST(A.Number as Varchar(256)) as [TypeCode_Number],
		[C].[BankName] as [CustBankName],
		[C].[BankAccCode] as [CustBankAccCode],
		[Ac].[code] AS [AccountCode],
		[Ac].[Balance] AS [AccountBalance],	
		
		[A].[ContractFinishDate],
		dbo.FnFormatDate([A].[ContractFinishDate]) as [ContractFinishDate_Gr],
		[A].[LeaveDate],
		dbo.FnFormatDate([A].[LeaveDate]) as [LeaveDate_Gr],
		[A].[ResultingAmount2],
		[A].[ResultingAmount],
		[A].[ResultingNote],
		[A].[Fine],
		[A].[FineNote],
		(Select Sum(value) from FlatContractFee Where ParentGuid = A.Guid) AS [SumFee],
		
		[A].[InsuranceValueOld],
		[A].[InsuranceValue],
		[A].[ContractPrice],
		[A].[CertificatValue],
		
		[A].[CommissionFromCustValue],
		[A].[CommissionFromCustPercent],

		[A].[CommissionFromOwnerValue] ,
		[A].[CommissionFromOwnerPercent],
		(Select SUM(Value) From vwContractCachPayment where ContractGuid = A.Guid) as SumCachPayment,
		@ChecksCollection as [SumChecksCollection],
				
		C.CustNote1,
		C.CustNote2,
		C.CustNote3,
		C.CustNote4,
		C.CustNote5,
		C.CustNote6,
		C.CustNote7,

		
		bf.[FldValue1] as [BuildingFldValue1],
		bf.[FldValue2] as [BuildingFldValue2],
		bf.[FldValue3] as [BuildingFldValue3],
		bf.[FldValue4] as [BuildingFldValue4],
		bf.[FldValue5] as [BuildingFldValue5],
		bf.[FldValue6] as [BuildingFldValue6],
		bf.[FldValue7] as [BuildingFldValue7],
		bf.[FldValue8] as [BuildingFldValue8],
		bf.[FldValue9] as [BuildingFldValue9],
		bf.[FldValue10] as [BuildingFldValue10],
		bf.[FldValue11] as [BuildingFldValue11],
		bf.[FldValue12] as [BuildingFldValue12],
		bf.[FldValue13] as [BuildingFldValue13],
		bf.[FldValue14] as [BuildingFldValue14],
		bf.[FldValue15] as [BuildingFldValue15],
		
		@SumCheck as [SumCheck],
		@SumCach as [SumCach],
		@SumPay as [SumPay], 

		[A].[Guid],
		
		(Select Top 1 [UserName] From vwRealty_LogCard where CardGuid = A.Guid order by Date) as [CreateByUser],
		(Select Top 1 [Date] From vwRealty_LogCard where CardGuid = A.Guid order by Date) as [CreateDate],
		(Select Top 1 [UserName] From vwRealty_LogCard where CardGuid = A.Guid order by Date desc) as [LastUpdateByUser],
		(Select Top 1 [Date] From vwRealty_LogCard where CardGuid = A.Guid order by Date desc) as [LastUpdateDate]
	from 
		[LeaseApartment] [A]
		left join [vwBuilding] [B] On [A].[BuildingGuid] = [B].[Guid]
		LEFT join #infofldBuidling bf on bf.Guid = B.Guid
		left join [vwApartment] [P] on [P].[Guid] = [A].[ApartmentGuid]
		left join [vwShop] [S] on [S].[Guid] = [A].[ApartmentGuid]
		left join [vwCustomer] [C] on [C].[Guid] = [A].[CustomerGuid]
		left join [vwAccount] [AC] on [C].[AcGuid] = [AC].[Guid]
		left join [vwCurrency] [My] on [My].[Guid] = [A].[CurrencyGuid]
		left join [RentInfo] [R] on [R].[Guid] = [A].[RentInfoGuid]
		left join [vwOwner] [OW] on [OW].[Guid] = [B].[ownerGuid]
		left join [vwSalesMan] [Sl] on [Sl].[Guid] = [A].[SalesManGuid]
		inner join [ContractType] T on T.Guid = A.TypeGuid
	where
		[A].[Guid] = @Guid or @Guid = 0x0


GO

SET ANSI_NULLS, QUOTED_IDENTIFIER ON
GO

Create Procedure [PrcReCreateCheckEntry]
(
	@Date1 DateTime = 0,
	@Date2 DateTime = 0,
	@ActiveDate bit = 0,
	@Op_Check bit = 0,
    @Op_Post bit = 0,
    @Op_Collection bit = 1,
    @Op_PartCollection bit = 0,
    @Op_Endorsement bit = 0,
    @Op_Returned bit = 0,
    @UpdateCheckwithdefaultaccount bit = 0
)
 
as
	Set noCount on 
	
	Declare @Guid uniqueidentifier,
			@CreateEntry Bit,
			@isRounded Bit
	Declare @RowCount int

	--ForWaitProgress	
	exec PrcSetProgrss '', 100, 0
	Declare @AllCount int	
	Select
		@AllCount = COUNT(*)
	From 
		[Checks] S
		inner join [CheckType] T on T.Guid = S.TypeGuid
		inner join [Resource] R on R.Guid = S.TypeGuid and R.Spid = @@SPID
	where
		(S.Date between @Date1 and @Date2 or @ActiveDate = 0)
	Declare @Msg varchar(255),
			@MsgConst varchar(255)
	Set @MsgConst = dbo.SC('      ')
			
	Set @Msg = @MsgConst +' '+'0 / '+Cast(@AllCount as Varchar(25))
	exec PrcSetProgrss @Msg, @AllCount, 0
	--ForWaitProgress	End
	


	Alter Table Checks Disable Trigger all

	DECLARE cursor_Name CURSOR FAST_FORWARD FOR 
	Select 
		S.[Guid],
		Case when T.[CreatedEntry]  = 1 and S.CheckCreateEntry = 1 then 1 else 0 end as [CreateEntry],
		isRounded
	From 
		[Checks] S
		inner join [CheckType] T on T.Guid = S.TypeGuid
		inner join [Resource] R on R.Guid = S.TypeGuid and R.Spid = @@SPID
	where
		(S.Date between @Date1 and @Date2 or @ActiveDate = 0)
		

	Set @RowCount = 0
	
	Declare @Counter int
	Set @Counter = 0
	
	OPEN cursor_Name
	FETCH NEXT FROM cursor_Name INTO @Guid, @CreateEntry, @isRounded
	
	WHILE @@FETCH_STATUS = 0
	BEGIN


		--ForWaitProgress	
		Set @Counter = @Counter + 1

		Set @Msg = @MsgConst +' '+Cast(@Counter as Varchar(25)) +' / '+Cast(@AllCount as Varchar(25))
		exec PrcSetProgrss @Msg, @AllCount, @Counter

		if @Op_Check = 1 
		if @UpdateCheckwithdefaultaccount = 1
		begin
			update Checks Set obverseAccount = T.DefAccountGuid
			From
				Checks C
				inner join checkType T on T.Guid = C.TypeGuid
			where
				C.Guid = @Guid
		end
		
		--    
		if @UpdateCheckwithdefaultaccount = 1 and @Op_Collection = 1 
		begin
			update ChecksCollection Set DebitCostGuid = C.CostGuid
			From
				ChecksCollection cc
				inner join Checks C on c.Guid = CC.checkGuid
				inner join checkType T on T.Guid = C.TypeGuid
			where
				C.Guid = @Guid
				and t.collectedMoveCostDebit = 1
				and cc.Kind = 1

			update ChecksCollection Set CreditCostGuid = C.CostGuid
			From
				ChecksCollection cc
				inner join Checks C on c.Guid = CC.checkGuid
				inner join checkType T on T.Guid = C.TypeGuid
			where
				C.Guid = @Guid
				and t.collectedMoveCostCredit = 1
				and cc.Kind = 1
		end

		if @Op_Check = 1 
		begin
			if @CreateEntry = 1 and @isRounded = 0
			begin
				exec [PrcCreateChecksEntry] @Guid
			end
			else
			Delete LinkEntry_Checks where CheckGuid = @Guid and [Kind] = 1600
		end
		
		if @Op_Post = 1
		begin
			/*
			--     
			Update ChecksCollection Set DebitCostGuid = K.CostGuid
			From
				ChecksCollection C 
				inner join Checks K on K.Guid = C.CheckGuid
				inner Join CheckType T on T.Guid = K.TypeGuid
			where
				(T.PostMoveCostDebit = 1)
				and (K.Guid = @Guid)
			*/		
			exec PrcCreateEntryChecksCollection @Guid, 0
		end

		--Print @Guid
		if @Op_Collection = 1
		begin
			exec PrcCreateEntryChecksCollection @Guid, 1
		end

		if @Op_Endorsement = 1
		begin
			exec PrcCreateEntryChecksCollection @Guid, 2
		end

		if @Op_Returned = 1
		begin
			exec PrcCreateEntryChecksCollection @Guid, 3
		end

		if @Op_PartCollection = 1
		begin
			--    
			if @UpdateCheckwithdefaultaccount = 1 and @Op_PartCollection = 1
			begin
				update ChecksPartialCollection Set DebitCostGuid = C.CostGuid
				From
					ChecksPartialCollection cc
					inner join Checks C on c.Guid = CC.checkGuid
					inner join checkType T on T.Guid = C.TypeGuid
				where
					C.Guid = @Guid
					and t.partialMoveCostDebit = 1
					
				update ChecksPartialCollection Set CreditCostGuid = C.CostGuid
				From
					ChecksPartialCollection cc
					inner join Checks C on c.Guid = CC.checkGuid
					inner join checkType T on T.Guid = C.TypeGuid
				where
					C.Guid = @Guid
					and t.partialMoveCostCredit = 1
			end

			exec PrcReCreateEntryChecksPartialCollection @Guid
		end

	  Set @RowCount = @RowCount + 1
	  
	  --Print @RowCount
	  FETCH NEXT FROM cursor_Name INTO @Guid, @CreateEntry, @isRounded
	
	END
	
	CLOSE cursor_Name
	DEALLOCATE cursor_Name

	Alter Table Checks Enable Trigger all


	--ForWaitProgress	
	Set @Msg = dbo.SC('')
	exec PrcSetProgrss @Msg, 0, 0

	if dbo.fnInRoundProcess() = 0
	Select @RowCount as [RowCount]
		

GO

SET ANSI_NULLS, QUOTED_IDENTIFIER ON
GO

Create Procedure [dbo].[PrcSpreadingPermission]
(
	@UserGuid uniqueidentifier = '6E5BB828-3126-423C-ACE5-5D14B4548D9A'
)
 
as

	Update Realty_Users Set 
		[SecLvl] = (Select [SecLvl] From Realty_Users where Guid = @UserGuid),
		[bAdmin] = (Select [bAdmin] From Realty_Users where Guid = @UserGuid),
		[UserSecLvl] = (Select [UserSecLvl] From Realty_Users where Guid = @UserGuid),
		[BranchGuid] = (Select [BranchGuid] From Realty_Users where Guid = @UserGuid)
	From
		Realty_Users R 
		inner join [Resource] S on S.Guid = R.Guid
		
	--[Realty_Detail_users] 
	Delete 
		[Realty_Detail_users] 
	From
		[Realty_Detail_users] D
		inner join [Resource] S on S.Guid = D.[ParentGuid]
	where
		S.SPID = @@Spid
		
	insert into [Realty_Detail_users]
	([Number],[ParentGuid],[IdCard],[Permit],[Str])
	Select
		[Number],R.Guid,[IdCard],[Permit],[Str]
	From
		[Realty_Detail_users] D, [Resource] R
	where
		R.Kind = 3333 and SPID = @@Spid
		and 
		D.ParentGuid = @UserGuid
		
	--[EntryTypePrivilege]
	Delete 
		[EntryTypePrivilege]
	From
		[EntryTypePrivilege] D
		inner join [Resource] S on S.Guid = D.[UserGuid]
	where
		S.SPID = @@Spid
		
	insert into [EntryTypePrivilege]
	([UserGuid],[EntryTypeGuid],[Open],[Add],[Edit],[Del],[Mark],[MarkEdit],[MarkDel],[Print],[Design])
	Select
		R.Guid,D.[EntryTypeGuid],D.[Open],D.[Add],D.[Edit],D.[Del],D.[Mark],D.[MarkEdit],D.[MarkDel],D.[Print],D.[Design]
	From
		[EntryTypePrivilege] D, [Resource] R
	where
		R.Kind = 3333 and SPID = @@Spid
		and 
		D.[UserGuid] = @UserGuid
	
	--[ContractTypePrivilege]
	Delete 
		[ContractTypePrivilege]
	From
		[ContractTypePrivilege] D
		inner join [Resource] S on S.Guid = D.[UserGuid]
	where
		S.SPID = @@Spid
		
	insert into [ContractTypePrivilege]
	([UserGuid],[ContractTypeGuid],[Open],[Add],[Edit],[Del],[Mark],[MarkEdit],[MarkDel],[Print],[Design],[Field7],[Field8],[Field9],[Field10],[Field11],[Field12],[Field13],[Field14],[Field15],[Field16],[MaxDiscount])
	Select
		R.Guid,[ContractTypeGuid],[Open],[Add],[Edit],[Del],[Mark],[MarkEdit],[MarkDel],[Print],[Design],[Field7],[Field8],[Field9],[Field10],[Field11],[Field12],[Field13],[Field14],[Field15],[Field16],[MaxDiscount]
	From
		[ContractTypePrivilege] D, [Resource] R
	where
		R.Kind = 3333 and SPID = @@Spid
		and 
		D.[UserGuid] = @UserGuid
		
	--[CheckTypePrivilege]
	Delete 
		[CheckTypePrivilege]
	From
		[CheckTypePrivilege] D
		inner join [Resource] S on S.Guid = D.[UserGuid]
	where
		S.SPID = @@Spid
		
	insert into [CheckTypePrivilege]
	([UserGuid],[CheckTypeGuid],[Open],[Add],[Edit],[Del],[Mark],[MarkEdit],[Markdel],[Print],[Design],[Posted],[collected],[Endorsement],[Returned])
	Select
		R.Guid,[CheckTypeGuid],[Open],[Add],[Edit],[Del],[Mark],[MarkEdit],[Markdel],[Print],[Design],[Posted],[collected],[Endorsement],[Returned]
	From
		[CheckTypePrivilege] D, [Resource] R
	where
		R.Kind = 3333 and SPID = @@Spid
		and 
		D.[UserGuid] = @UserGuid
		
	--[ElectricityTypePrivilege]
	Delete 
		[ElectricityTypePrivilege]
	From
		[ElectricityTypePrivilege] D
		inner join [Resource] S on S.Guid = D.[UserGuid]
	where
		S.SPID = @@Spid
		
	insert into [ElectricityTypePrivilege]
	([UserGuid],[ElectricityTypeGuid],[Open],[Add],[Edit],[Del],[Mark],[MarkEdit],[MarkDel],[Print],[Design],[Field1],[Field2],[MaxDiscount])
	Select
		R.Guid,[ElectricityTypeGuid],[Open],[Add],[Edit],[Del],[Mark],[MarkEdit],[MarkDel],[Print],[Design],[Field1],[Field2],[MaxDiscount]
	From
		[ElectricityTypePrivilege] D, [Resource] R
	where
		R.Kind = 3333 and SPID = @@Spid
		and 
		D.[UserGuid] = @UserGuid


	--[[MenuPrivilege]]
	Delete 
		[MenuPrivilege]
	From
		[MenuPrivilege] D
		inner join [Resource] S on S.Guid = D.[UserGuid]
	where
		S.SPID = @@Spid
		
	insert into [MenuPrivilege]
	([UserGuid],[MenuName])
	Select
		R.Guid,D.[MenuName]
	From
		[MenuPrivilege] D, [Resource] R
	where
		R.Kind = 3333 and SPID = @@Spid
		and 
		D.[UserGuid] = @UserGuid


GO

SET ANSI_NULLS, QUOTED_IDENTIFIER ON
GO

Create Procedure [PrcAlarmEndPeriodNotendContract]
(
	@All Bit = 1
)
 
as
	Declare @Check Bit,
			@NotCheck Bit
	Set @Check = 1
	Set @NotCheck = 0


	Create Table #AlarmEndPeriodNotendContract
	(
		[ContractNo] Varchar(256),
		[BuildingName] Varchar(256),
		[BuildingltnName] Varchar(256),
		[BuildingArName] Varchar(256),
		[CustomerName] Varchar(256),
		[CustomerltnName] Varchar(256),
		[CustomerArName] Varchar(256),
		[No] Varchar(256),
		[FlatKind] Varchar(256),
		[Floor] Varchar(256),
		[FromDate] Datetime,
		[ToDate] Datetime,
		[Datediff] int,
		[LeaseKind] int,
		[AlertPrinted] Bit,
		[AlertPrint] Bit,
		[Guid] uniqueidentifier
	)
	
	insert into #AlarmEndPeriodNotendContract
	Select 
		[ContractNo],
		[B].[Name] as [BuildingName],
		[B].[ltnName] as [BuildingltnName],
		[B].[ArName] as [BuildingArName],
		[cu].[Name] as [CustomerName],
		[cu].[ltnName] as [CustomerltnName],
		[cu].[arName] as [CustomerArName],
		Case when Isnull([A].[No], '') <> '' then [A].[No] else [S].[No] end as [No],
		Case when Isnull([A].[No], '') <> '' then dbo.SC('') else dbo.SC('') end as [FlatKind],
		Case when Isnull([A].[No], '') <> '' then [A].[FloorNo] else Null end as [Floor],
		[FromDate],
		[ToDate],
		DateDiff(Day,  [ToDate], GetDate()) as [Datediff],
		[LeaseKind],
		Case when [R2].[ObjGuid] is null then ( @NotCheck )
			 when [R2].[ObjGuid] is not null  then @Check end as [AlertPrinted],
		Null as [AlertPrint],
		[L].[Guid]
	From
		[vbLeaseApartment] [L]
		inner join [vwBuilding] [B] On [L].[BuildingGuid] = [B].[Guid]
		inner join [vwCustomer] [cu] on [cu].[Guid] = [L].[CustomerGuid]
		left join [vwApartment] [A] On [A].[Guid] = [L].[ApartmentGuid]
		left join [vwShop] [S] On [S].[Guid] = [L].[ApartmentGuid]
		left join [RepCheck] [R] on [R].[ObjGuid] = [L].[Guid] and [R].[IdReport] = 9001
		left join [RepCheck] [R2] on [R2].[ObjGuid] = [L].[Guid] and [R2].[IdReport] = 9000
	where
		([LeaseKind] = 0 or [LeaseKind] = 1)
		and ([Todate] <= GetDate() and [ContractFinish] = 0)
		and ([R].[ObjGuid] is Not Null or @All = 1)
		
	insert into #AlarmEndPeriodNotendContract
	Select 
		[ContractNo],
		[B].[Name] as [BuildingName],
		[B].[ltnName] as [BuildingltnName],
		[B].[ArName] as [BuildingArName],
		[cu].[Name] as [CustomerName],
		[cu].[ltnName] as [CustomerltnName],
		[cu].[arName] as [CustomerArName],
		[A].[No]as [No],
		dbo.SC('') as [FlatKind],
		'' as [Floor],
		[FromDate],
		[ToDate],
		case when DateDiff(Day,  [ToDate], GetDate()) > 0 then DateDiff(Day,  [ToDate], GetDate()) end as [Datediff],
		[ContractKind],

		Case when [R2].[ObjGuid] is null then ( @NotCheck )
			 when [R2].[ObjGuid] is not null  then @Check end as [AlertPrinted],
		Null as [AlertPrint],
		[L].[Guid]
	From
		[vbParkingContract] [L]
		inner join [vwBuilding] [B] On [L].[BuildingGuid] = [B].[Guid]
		inner join [vwCustomer] [cu] on [cu].[Guid] = [L].[CustomerGuid]
		left join [vwParking] [A] On [A].[Guid] = [L].[ParkingGuid]
		left join [RepCheck] [R] on [R].[ObjGuid] = [L].[Guid] and [R].[IdReport] = 9001
		left join [RepCheck] [R2] on [R2].[ObjGuid] = [L].[Guid] and [R2].[IdReport] = 9000
		left join (Select 
						[ObjGuid],
						[IdReport],
						Count(*) as [Count]
					From
						[RepCheckCount] 
					Group By
						[ObjGuid],
						[IdReport]
					)[R3] on [R3].[ObjGuid] = [L].[Guid] and [R3].[IdReport] = 9000

 	where
 		([ContractKind] = 4)
		and 
		([Todate] <= GetDate() and [ContractFinish] = 0)
		and ([R].[ObjGuid] is Not Null or @All = 1)
		
	insert into #AlarmEndPeriodNotendContract
	Select 
		[ContractNo],
		'' as [BuildingName],
		'' as [BuildingltnName],
		'' as [BuildingArName],
		[cu].[Name] as [CustomerName],
		[cu].[ltnName] as [CustomerltnName],
		[cu].[arName] as [CustomerArName],
		[L].[Name]as [No],
		Case when [ContractKind] = 6 or [ContractKind] = 7 then dbo.SC('')
		 when [ContractKind] = 8 or [ContractKind] = 9 then dbo.SC('')
		end 
		as [FlatKind],
		'' as [Floor],
		[FromDate],
		[ToDate],
		case when DateDiff(Day,  [ToDate], GetDate()) > 0 then DateDiff(Day,  [ToDate], GetDate()) end as [Datediff],
		[ContractKind],

		Case when [R2].[ObjGuid] is null then ( @NotCheck )
			 when [R2].[ObjGuid] is not null  then @Check end as [AlertPrinted],
		Null as [AlertPrint],

		[L].[Guid]
	From
		[vwLandContract] [L]
		inner join [vwCustomer] [cu] on [cu].[Guid] = [L].[CustomerGuid]
		left join [RepCheck] [R] on [R].[ObjGuid] = [L].[Guid] and [R].[IdReport] = 9001
		left join [RepCheck] [R2] on [R2].[ObjGuid] = [L].[Guid] and [R2].[IdReport] = 9000
		left join (Select 
						[ObjGuid],
						[IdReport],
						Count(*) as [Count]
					From
						[RepCheckCount] 
					Group By
						[ObjGuid],
						[IdReport]
					)[R3] on [R3].[ObjGuid] = [L].[Guid] and [R3].[IdReport] = 9000
 	where
 		([ContractKind] = 4)
		and ([Todate] <= GetDate() and [ContractFinish] = 0)
		and ([R].[ObjGuid] is Not Null or @All = 1)

	Select
		*
	From
		#AlarmEndPeriodNotendContract
	Order By 
		BuildingName, [Datediff]

GO

SET ANSI_NULLS, QUOTED_IDENTIFIER ON
GO

Create Procedure [PrcEndFlatContract]
(
	@MaxDate int = 42644
)
 
as
	
	Declare @RC int

	----Diable Index
	exec PrcCheckIndex '', 'LeaseApartment', 0

	--
	Declare @SalesMan uniqueidentifier	
	Select @SalesMan = [Str] from [Realty_Detail_users]
    where [ParentGuid]=(Select Top 1 userGuid from CurrentUsers where Spid = @@spid)
    and [IdCard]= 34
    
    if @SalesMan = 0x0
    Set @SalesMan = Null
    
	
	--    
	Select
		ApartmentGuid,
		MAX(FromDate) as FromDate
	into #LastContract
    From 	
		LeaseApartment [Tb]
		inner join Resource R on R.Guid = tb.Guid and Spid = @@Spid
	where
		[Tb].[IsAutoRenewal] = 1
	Group by
		ApartmentGuid
	
	-- 
	Declare @p_FromDate Datetime,
			@p_ToDate Datetime,
			@P_RealtyGuid uniqueidentifier
			
	Create Table #T_RNConmp_contra
	(Number int, Guid uniqueidentifier)
	DECLARE @cursor_Name CURSOR 
	Set @cursor_Name = CURSOR FAST_FORWARD FOR 

	Select
		[Tb].[ApartmentGuid], 
		Case 
			when [ContractFinish] = 0 then Dateadd(Day,1,[ToDate]) 
			when [ContractFinish] = 1 then Dateadd(Day,1,[ContractFinishDate]) 
		end as [FromDate],
		
		Case when Period <> 12 then dbo.FnAddDate('m',Period+1,
											Case 
												when [ContractFinish] = 0 then [ToDate]
												when [ContractFinish] = 1 then [ContractFinishDate]
											end)
			 when Period = 12 then Dateadd(Day,DATEDIFF(Day, [Tb].Fromdate, [Tb].Todate),
											Case 
												when [ContractFinish] = 0 then [ToDate]
												when [ContractFinish] = 1 then [ContractFinishDate]
											end)
		end as [ToDate]
	From 	
		LeaseApartment [Tb]
		inner join [vwContractType] [T] on [T].[Guid] = [tb].[TypeGuid]
		inner join Resource R on R.Guid = tb.Guid and Spid = @@Spid
		
		inner join #LastContract L on L.ApartmentGuid = tb.ApartmentGuid and L.FromDate = tb.FromDate
	
	OPEN @cursor_Name
	FETCH NEXT FROM @cursor_Name INTO @P_RealtyGuid, @p_FromDate, @p_ToDate
			
	
	WHILE @@FETCH_STATUS = 0
	BEGIN
		insert into #T_RNConmp_contra
		exec PrcTestRentedFlat 0x0, @P_RealtyGuid, @p_FromDate, @p_ToDate
	  FETCH NEXT FROM @cursor_Name INTO @P_RealtyGuid, @p_FromDate, @p_ToDate
	
	END
	
	CLOSE @cursor_Name
	DEALLOCATE @cursor_Name
	-------------
	
	-- 
	Update
		LeaseApartment
	set
		ContractFinish = 1,
		ContractFinishDate = tb.ToDate
    From 	
		LeaseApartment [Tb]
		inner join [vwContractType] [T] on [T].[Guid] = [tb].[TypeGuid]
		inner join Resource R on R.Guid = tb.Guid and Spid = @@Spid
		
		inner join #LastContract L on L.ApartmentGuid = tb.ApartmentGuid and L.FromDate = tb.FromDate
	where
		Tb.Guid Not in (Select Guid from #T_RNConmp_contra)
	
	insert into dbo.[LeaseApartment] 
	([Number], [Guid], [SecLvl], [EditDate], [Mark], [TypeGuid], [ContractNo], [CustomerGuid], [RentInfoGuid], [SalesManGuid], [BuildingGuid], [ApartmentGuid], [ApartmentType], [CostGuid], [FromDate], [ToDate], [Period], [RentContractType], [Rent], [MonthlyValue], [CurrencyGuid], [CurrencyVal], [PayType], [Note], [Note2], [Trademark], [Purpose], [Whereabouts], [LeaseKind], [RevenueAccountGuid], [CustAccountGuid], [CommissionFromCustPercent], [CommissionFromCustValue], [AcCommissionFromCustGuid], [AcCommissionFromCustNote], [CommissionFromOwnerPercent], [CommissionFromOwnerValue], [AcCommissionFromOwnerGuid], [AcCommissionFromOwnerNote], [CreateContractEntry], [ContractFinish], [ContractFinishDate], [ResultingAmount], [ResultingAmount2], [RoundKind], [ResultingNote], [Fine], [FineAccount], [CreateResultingEntry], [FineNote], [InsuranceValuePercent], [InsuranceValue], [InsuranceAccountGuid], [InsuranceValueOld], [ContractPrice], [AccountContractPrice], [CertificatValue], [AccountCertificatValue], [RentDuration], [Rentype], [TermsOfPayment], [ResidentCount], [ElectricityInsurance], [Step1Complete], [Step2Complete], [Step3Complete], [Step4Complete], [Step5Complete], [Certification], [DiscountPercent], [DiscountValue], [DiscountAccountGuid], [UserGuid], [BranchGuid], [ElectricityCounter], [FineRevenueAccountGUID], [NewState], [OtherFee], [OtherFeeAccountGUID], [License1No], [License2No], [License3No], [License1Date1], [License2Date1], [License3Date1], [License1Date2], [License2Date2], [License3Date2], [Ltnwhereabouts], [LtnPurpose], [LtnRentDuration], [LtnRentype], [LtnTermsOfPayment], [IsRounded], [Leave], [LeaveDate], [CountOldContract], [AcquittancePrinted], [AcquittancePrintDate], [AcquittancePrintedByGuid], [Judicial], [PrvContractGuid],  [IsAutoRenewal])
	Select	
		Null as [Number], 
		Newid() as [Guid], 
		[Tb].[SecLvl], 
		dbo.fndateonly(GETDATE()) as [EditDate], 
		[Tb].[Mark], 
		[Tb].[TypeGuid], 
		[Tb].[ContractNo]+'/2' as [ContractNo], 
		[Tb].[CustomerGuid], 
		[Tb].[RentInfoGuid], 
		@SalesMan as [SalesManGuid], 
		[Tb].[BuildingGuid], 
		[Tb].[ApartmentGuid], 
		[Tb].[ApartmentType], 
		[Tb].[CostGuid], 
		Case 
			when [ContractFinish] = 0 then Dateadd(Day,1,[ToDate]) 
			when [ContractFinish] = 1 then Dateadd(Day,1,[ContractFinishDate]) 
		end as [FromDate],
		
		Case when Period <> 12 then dbo.FnAddDate('m',Period+1,
											Case 
												when [ContractFinish] = 0 then [ToDate]
												when [ContractFinish] = 1 then [ContractFinishDate]
											end)
			 when Period = 12 then Dateadd(Day,DATEDIFF(Day, [Tb].Fromdate, [Tb].Todate),
											Case 
												when [ContractFinish] = 0 then [ToDate]
												when [ContractFinish] = 1 then [ContractFinishDate]
											end)
		end as [ToDate],
		[Tb].[Period], 
		[Tb].[RentContractType], 
		[Tb].[Rent], 
		[Tb].[MonthlyValue], 
		[Tb].[CurrencyGuid], 
		[Tb].[CurrencyVal], 
		[Tb].[PayType], 
		[Tb].[Note], 
		[Tb].[Note2], 
		[Tb].[Trademark], 
		[Tb].[Purpose], 
		[Tb].[Whereabouts], 
		[Tb].[LeaseKind], 
		[Tb].[RevenueAccountGuid], 
		[Tb].[CustAccountGuid], 
		case when SUBSTRING([OpNewContract], 4, 1) = '1' then [CommissionFromCustPercent] else 0 end [CommissionFromCustPercent], 
		case when SUBSTRING([OpNewContract], 4, 1) = '1' then [CommissionFromCustValue] else 0 end as [CommissionFromCustValue],
		[Tb].[AcCommissionFromCustGuid], 
		[Tb].[AcCommissionFromCustNote], 
		case when SUBSTRING([OpNewContract], 5, 1) = '1' then [CommissionFromOwnerPercent] else 0 end [CommissionFromOwnerPercent], 
		case when SUBSTRING([OpNewContract], 5, 1) = '1' then [CommissionFromOwnerValue] else 0 end [CommissionFromOwnerValue],
		[Tb].[AcCommissionFromOwnerGuid], 
		[Tb].[AcCommissionFromOwnerNote], 
		[Tb].[CreateContractEntry], 
		Cast( 0 as bit) as [ContractFinish], 
		Cast( Null as DateTime)  as [ContractFinishDate],
		0 as [ResultingAmount],
		0 as [ResultingAmount2],
		[Tb].[RoundKind], 
		[Tb].[ResultingNote], 
		0 as [Fine],
		[Tb].[FineAccount], 
		Cast( 0 as bit) as [CreateResultingEntry],
		[Tb].[FineNote], 
		[Tb].[InsuranceValuePercent], 
		0 as [InsuranceValue],
		[Tb].[InsuranceAccountGuid], 
		[InsuranceValue] + Isnull([InsuranceValueOld],0) as [InsuranceValueOld],
		case when SUBSTRING([OpNewContract], 1, 1) = '1' then [ContractPrice] else 0 end as [ContractPrice], 
		[Tb].[AccountContractPrice], 
		case when SUBSTRING([OpNewContract], 2, 1) = '1' then [CertificatValue] else 0 end [CertificatValue],
		[Tb].[AccountCertificatValue], 
		[Tb].[RentDuration], 
		[Tb].[Rentype], 
		[Tb].[TermsOfPayment], 
		[Tb].[ResidentCount], 
		[Tb].[ElectricityInsurance], 
		[Tb].[Step1Complete], 
		[Tb].[Step2Complete], 
		[Tb].[Step3Complete], 
		[Tb].[Step4Complete], 
		[Tb].[Step5Complete], 
		[Tb].[Certification], 
		[Tb].[DiscountPercent], 
		[Tb].[DiscountValue], 
		[Tb].[DiscountAccountGuid], 
		[Tb].[UserGuid], 
		[Tb].[BranchGuid], 
		[Tb].[ElectricityCounter], 
		[Tb].[FineRevenueAccountGUID], 
		[Tb].[NewState], 
		case when SUBSTRING([OpNewContract], 3, 1) = '1' then [OtherFee] else 0 end OtherFee,		
		
		[Tb].[OtherFeeAccountGUID], 
		[Tb].[License1No], 
		[Tb].[License2No], 
		[Tb].[License3No], 
		[Tb].[License1Date1], 
		[Tb].[License2Date1], 
		[Tb].[License3Date1], 
		[Tb].[License1Date2], 
		[Tb].[License2Date2], 
		[Tb].[License3Date2], 
		[Tb].[Ltnwhereabouts], 
		[Tb].[LtnPurpose],
        [Tb].[LtnRentDuration],
        [Tb].[LtnRentype],
        [Tb].[LtnTermsOfPayment],
        [Tb].[IsRounded],
        [Tb].[Leave],
        [Tb].[LeaveDate],
        [Tb].[CountOldContract],
        [Tb].[AcquittancePrinted],
        [Tb].[AcquittancePrintDate],
        [Tb].[AcquittancePrintedByGuid],
        [Tb].[Judicial],
        [Tb].[PrvContractGuid],
        [Tb].[IsAutoRenewal]
    From 	
		LeaseApartment [Tb]
		inner join [vwContractType] [T] on [T].[Guid] = [tb].[TypeGuid]
		inner join Resource R on R.Guid = tb.Guid and Spid = @@Spid
		
		inner join #LastContract L on L.ApartmentGuid = tb.ApartmentGuid and L.FromDate = tb.FromDate
	where
		[Tb].[IsAutoRenewal] = 1
		and Tb.ApartmentGuid Not in (Select Guid from #T_RNConmp_contra)
	
	Set @RC = @@ROWCOUNT

	Declare @CreateEntry bit, 
			@Guid uniqueidentifier,
			@TypeGuid uniqueidentifier
			
	--  
		Create Table #T_RNCon
		(
			[Id] int Identity(1,1),
			[Guid] Uniqueidentifier,
			[TypeGuid] Uniqueidentifier,
			CreateEntry bit
		)
		insert into #T_RNCon
		([Guid], [TypeGuid],CreateEntry)	
		Select 
			[Guid],
			[TypeGuid],
			CreateContractEntry
		From
			[LeaseApartment]
		where 
			[Number] is Null
		Order By
			[FromDate]

		Alter Table [LeaseApartment] Disable Trigger All
		
		--	  
		DECLARE cursor_Name CURSOR FAST_FORWARD FOR 
		Select Guid, [TypeGuid],CreateEntry from #T_RNCon
		
		OPEN cursor_Name
		FETCH NEXT FROM cursor_Name INTO @Guid, @TypeGuid,@CreateEntry
		
		WHILE @@FETCH_STATUS = 0
		BEGIN
			Update [LeaseApartment] Set Number = (Select Max(Number) + 1 From [LeaseApartment] where TypeGuid = @TypeGuid)
			where 
				(Guid = @Guid )
				
			if @CreateEntry = 1
			begin
				exec [PrcCreateContractFlatShopEntry] @Guid, @MaxDate
			end
			else
			begin
				Delete HEntry where Guid = @Guid 
			end
			
		  FETCH NEXT FROM cursor_Name INTO @Guid, @TypeGuid,@CreateEntry
		
		END
		
		CLOSE cursor_Name
		DEALLOCATE cursor_Name
		
		
		Alter Table [LeaseApartment] Enable Trigger All

	
	exec PrcCheckIndex '', 'LeaseApartment', 1
	
	Select 
		@RC as [RowCount],
		(Select Count(*) from #T_RNConmp_contra) as FailCount


GO

SET ANSI_NULLS, QUOTED_IDENTIFIER ON
GO

Create Trigger [TRG_Trace_ChecksPartialCollection]
on [ChecksPartialCollection]
 
for update
As
	SET NOCOUNT ON;
	if Not exists(Select Value from DMD_const where vName = 'ActiveLogCardUpdate' and Value = '1' ) return
	
	Declare @UserGuid uniqueidentifier, @Guid uniqueidentifier
	Set @Guid = NEWID()
	
	Select Top 1 @UserGuid = userGuid From CurrentUsers where Spid = @@SPID
			
	insert into [Trace]
	([Guid],[ParentGuid],[Date],[userGuid],[HostName],ParentTbl )
	Select Top 1
		@Guid,
		N.Guid,
		GETDATE(),
		@UserGuid,
		Host_Name(),
		'ChecksPartialCollection'
	From
		[inserted] n 
		
	insert into [TraceDetail]
	([ParentGuid],[Caption],[Old],[New],[Tbl])
	Select Top 1
		@Guid,
		' ' as [Caption],
		D.[SecLvl] as [old],
		N.[SecLvl] as [New],
		''
	From
		[deleted] d
		inner join [inserted] n on D.Guid = N.Guid
	where
		N.[SecLvl] <> D.[SecLvl]
		
	insert into [TraceDetail]
	([ParentGuid],[Caption],[Old],[New],[Tbl])
	Select Top 1
		@Guid,
		'' as [Caption],
		D.[Mark] as [old],
		N.[Mark] as [New],
		''
	From
		[deleted] d
		inner join [inserted] n on D.Guid = N.Guid
	where
		N.[Mark] <> D.[Mark]
		
	insert into [TraceDetail]
	([ParentGuid],[Caption],[Old],[New],[Tbl])
	Select Top 1
		@Guid,
		'' as [Caption],
		dbo.fnDate(D.[Date]) as [old],
		dbo.fnDate(N.[Date]) as [New],
		''
	From
		[deleted] d
		inner join [inserted] n on D.Guid = N.Guid
	where
		N.[Date] <> D.[Date]
		
	insert into [TraceDetail]
	([ParentGuid],[Caption],[Old],[New],[Tbl])
	Select Top 1
		@Guid,
		'' as [Caption],
		D.[CheckGuid] as [old],
		N.[CheckGuid] as [New],
		'[checks]'
	From
		[deleted] d
		inner join [inserted] n on D.Guid = N.Guid
	where
		N.[CheckGuid] <> D.[CheckGuid]
		
	insert into [TraceDetail]
	([ParentGuid],[Caption],[Old],[New],[Tbl])
	Select Top 1
		@Guid,
		' ' as [Caption],
		D.[DebitAccountGuid] as [old],
		N.[DebitAccountGuid] as [New],
		'[Account]'
	From
		[deleted] d
		inner join [inserted] n on D.Guid = N.Guid
	where
		N.[DebitAccountGuid] <> D.[DebitAccountGuid]
		
	insert into [TraceDetail]
	([ParentGuid],[Caption],[Old],[New],[Tbl])
	Select Top 1
		@Guid,
		' ' as [Caption],
		D.[DebitCostGuid] as [old],
		N.[DebitCostGuid] as [New],
		'[Cost]'
	From
		[deleted] d
		inner join [inserted] n on D.Guid = N.Guid
	where
		N.[DebitCostGuid] <> D.[DebitCostGuid]
		
	insert into [TraceDetail]
	([ParentGuid],[Caption],[Old],[New],[Tbl])
	Select Top 1
		@Guid,
		' ' as [Caption],
		D.[CreditAccountGuid] as [old],
		N.[CreditAccountGuid] as [New],
		'[Account]'
	From
		[deleted] d
		inner join [inserted] n on D.Guid = N.Guid
	where
		N.[CreditAccountGuid] <> D.[CreditAccountGuid]
		
	insert into [TraceDetail]
	([ParentGuid],[Caption],[Old],[New],[Tbl])
	Select Top 1
		@Guid,
		' ' as [Caption],
		D.[CreditCostGuid] as [old],
		N.[CreditCostGuid] as [New],
		'[Cost]'
	From
		[deleted] d
		inner join [inserted] n on D.Guid = N.Guid
	where
		N.[CreditCostGuid] <> D.[CreditCostGuid]
		
	insert into [TraceDetail]
	([ParentGuid],[Caption],[Old],[New],[Tbl])
	Select Top 1
		@Guid,
		' ' as [Caption],
		D.[Value] as [old],
		N.[Value] as [New],
		''
	From
		[deleted] d
		inner join [inserted] n on D.Guid = N.Guid
	where
		N.[Value] <> D.[Value]
		
	insert into [TraceDetail]
	([ParentGuid],[Caption],[Old],[New],[Tbl])
	Select Top 1
		@Guid,
		'' as [Caption],
		D.[Commission] as [old],
		N.[Commission] as [New],
		''
	From
		[deleted] d
		inner join [inserted] n on D.Guid = N.Guid
	where
		N.[Commission] <> D.[Commission]
		
	insert into [TraceDetail]
	([ParentGuid],[Caption],[Old],[New],[Tbl])
	Select Top 1
		@Guid,
		' ' as [Caption],
		D.[LossComm] as [old],
		N.[LossComm] as [New],
		''
	From
		[deleted] d
		inner join [inserted] n on D.Guid = N.Guid
	where
		N.[LossComm] <> D.[LossComm]
		
	insert into [TraceDetail]
	([ParentGuid],[Caption],[Old],[New],[Tbl])
	Select Top 1
		@Guid,
		'  ' as [Caption],
		D.[CommAccountGuid] as [old],
		N.[CommAccountGuid] as [New],
		'[Account]'
	From
		[deleted] d
		inner join [inserted] n on D.Guid = N.Guid
	where
		N.[CommAccountGuid] <> D.[CommAccountGuid]
		
	insert into [TraceDetail]
	([ParentGuid],[Caption],[Old],[New],[Tbl])
	Select Top 1
		@Guid,
		'  ' as [Caption],
		D.[CommAccountCreditGuid] as [old],
		N.[CommAccountCreditGuid] as [New],
		'[Account]'
	From
		[deleted] d
		inner join [inserted] n on D.Guid = N.Guid
	where
		N.[CommAccountCreditGuid] <> D.[CommAccountCreditGuid]
		
	insert into [TraceDetail]
	([ParentGuid],[Caption],[Old],[New],[Tbl])
	Select Top 1
		@Guid,
		'  ' as [Caption],
		D.[CommCostGuid] as [old],
		N.[CommCostGuid] as [New],
		'[Cost]'
	From
		[deleted] d
		inner join [inserted] n on D.Guid = N.Guid
	where
		N.[CommCostGuid] <> D.[CommCostGuid]
		
	insert into [TraceDetail]
	([ParentGuid],[Caption],[Old],[New],[Tbl])
	Select Top 1
		@Guid,
		' ' as [Caption],
		D.[CommNote] as [old],
		N.[CommNote] as [New],
		''
	From
		[deleted] d
		inner join [inserted] n on D.Guid = N.Guid
	where
		N.[CommNote] <> D.[CommNote]
		
	insert into [TraceDetail]
	([ParentGuid],[Caption],[Old],[New],[Tbl])
	Select Top 1
		@Guid,
		'' as [Caption],
		D.[CurrencyGUID] as [old],
		N.[CurrencyGUID] as [New],
		'[Currency]'
	From
		[deleted] d
		inner join [inserted] n on D.Guid = N.Guid
	where
		N.[CurrencyGUID] <> D.[CurrencyGUID]
		
	insert into [TraceDetail]
	([ParentGuid],[Caption],[Old],[New],[Tbl])
	Select Top 1
		@Guid,
		' ' as [Caption],
		D.[CurrencyVal] as [old],
		N.[CurrencyVal] as [New],
		''
	From
		[deleted] d
		inner join [inserted] n on D.Guid = N.Guid
	where
		N.[CurrencyVal] <> D.[CurrencyVal]
		
	insert into [TraceDetail]
	([ParentGuid],[Caption],[Old],[New],[Tbl])
	Select Top 1
		@Guid,
		'' as [Caption],
		D.[Note] as [old],
		N.[Note] as [New],
		''
	From
		[deleted] d
		inner join [inserted] n on D.Guid = N.Guid
	where
		N.[Note] <> D.[Note]
		
	delete Trace From Trace t left join [TraceDetail] D on T.guid = D.ParentGuid
	where
		d.ParentGuid is Null and t.Guid = @Guid


GO

SET ANSI_NULLS, QUOTED_IDENTIFIER ON
GO

Create Procedure [PrcCreateBillEntry]
(
	@BillGuid uniqueidentifier = '5848B689-85F9-4104-B9FE-D1209086D636'
)
 
AS
	Set NoCount on 
	Declare 
			@EnNum int,
			@EnGuid [uniqueidentifier]

	--  

	Select 
		@EnNum = isnull([EntryNumber],0)
		,@EnGuid = isnull([EntryGuid],0x0)
	From
		[Bill]
	where
		[Guid] = @BillGuid

	
	if isnull(@EnNum,0) = 0
	begin	
		Select @EnNum = IsNull(Max([Number]),0) + 1 from [HEntry]
	END
	
	if isnull(@EnGuid,0x0) = 0x0
	Set @EnGuid = Newid()


	--   
	Update Bill Set EntryGuid = Null
	where
		[Guid] = @BillGuid	
	
	Delete
		[HEntry]
	where
		[Guid] = @EnGuid

	if Exists(Select Number From HEntry where Number = @EnNum )
	Select @EnNum = IsNull(Max([Number]),0) + 1 from [HEntry]
		
	--return
	DECLARE 
		@Kind int,
		@CreateEntry BIT,
		@AutoPostedEntry Bit,
		@CheckCreateEntry Bit,
		@DefMatAccountGuid uniqueidentifier,
		@CustAccountGuid uniqueidentifier,
		@DetailEntryByMat bit
		
	SELECT	TOP 1
		@CreateEntry = t.[EntryCreated],
		@AutoPostedEntry = t.[EntryCreatedAuto],
		@CheckCreateEntry = b.[CheckCreateEntry],
		@AutoPostedEntry = T.[AutoPostedEntry],
		@DefMatAccountGuid = T.DefMatAccountGuid,
		@CustAccountGuid = b.CustAccGuid,
		@Kind = Case when T.[BillKind] = 0 or T.[BillKind] = 3 or T.[BillKind] = 4 then 0 else 1 end,
		@DetailEntryByMat = T.DetailEntryByMat
	FROM
		[BillType] T
		inner join Bill B on B.TypeGuid = t.Guid
	WHERE
		b.Guid = @BillGuid
	
	if (@CreateEntry = 1) and (@CheckCreateEntry = 1)
	begin
			
			Declare @Bi_Tbl Table 
			(
				[CustAccGuid] uniqueidentifier,
				[Value] Float,
				[CurrencyGuid] uniqueidentifier,
				[CurrencyVal] Float,
				[CostGuid] uniqueidentifier,
				[Note] varchar(255)
			)
			
			insert into @Bi_Tbl
			Select
				[B].CustAccGuid,
				SUM(D.[TotalPrice] - D.Discount + D.Extra),
				[B].[CurrencyGuid],
				[B].[CurrencyVal],
				Case when D.[CostGuid] is Null then [B].[CostGuid] else D.[CostGuid] end,
				[B].[Note]
			From
				[Bill] B
				inner join BillDetail D on D.ParentGuid = B.Guid
			where
				B.[Guid] = @BillGuid
			Group By
				B.[CurrencyGuid],
				B.[CurrencyVal],
				Case when D.[CostGuid] is Null then [B].[CostGuid] else D.[CostGuid] end,
				B.CustAccGuid,
				[B].[Note],
				Case when @DetailEntryByMat = 1 then MatGuid else 0x0 end

			--Select * from @Bi_Tbl
			
			Declare @Di_Tbl Table 
			(
				[AccountGuid] uniqueidentifier,
				[Discount] Float,
				[extra] Float,
				[CurrencyGuid] uniqueidentifier,
				[CurrencyVal] Float,
				obverseAccountGuid uniqueidentifier,
				[CostGuid] uniqueidentifier,
				[Note] varchar(255)
			)
			
			insert into @Di_Tbl
			Select
				[D].AccountGuid,
				IsNull(D.Discount,0) as Discount,
				isNull(Extra,0) as Extra,
				[D].[CurrencyGuid],
				[D].[CurrencyVal],
				D.[obverseAccountGuid],
				[D].[CostGuid],
				[D].[Note]
			From
				BillDiscount D 
			where
				D.[ParentGuid] = @BillGuid
				and IsNull(D.Discount,0) + isNull(Extra,0) > 0
				
			Declare @SumDiscountExtra Float
			Select
				@SumDiscountExtra = IsNull(Sum(discount - extra),0)
			from
				@Di_Tbl
			
			Insert Into [HEntry]
			([Guid],[SecLvl],[Number],[Date], [CurrencyGuid], [CurrencyVal], [Note], [ParentKind], [BranchGuid], [IsPosted])
			Select
				@EnGuid,
				[SecLvl],
				@EnNum,
				[Date],
				[CurrencyGuid], 
				[CurrencyVal], 
				[Note],
				22 as [ParentKind], 
				[BranchGuid], 
				@AutoPostedEntry as [IsPosted]
			From	
				Bill
			where
				[Guid] = @BillGuid
				
			Declare @DetailNum Int
			Set @DetailNum = 0
		
			--Select @Kind, * from @Bi_Tbl
			Create Table #DEntry
			(
				[Number] int,
				[ParentGuid]  [uniqueidentifier] ,
				[AcGuid] [uniqueidentifier] ,
				[Debit] [Float],
				[Credit] [Float],
				[CurrencyGuid] [uniqueidentifier]  ,
				[CurrencyVal] Float,
				[ObverseAcGuid]  [uniqueidentifier] ,
				[CostGuid] [uniqueidentifier] ,
				[Note] Varchar(256)
			)
			
			Insert into #DEntry
		 	([ParentGuid],[Number],[AcGuid],[Debit],[Credit],[CurrencyGuid],[CurrencyVal],[CostGuid],[ObverseAcGuid],[Note])
			Select
				@EnGuid,
				@DetailNum,
				Case when @Kind = 0 then @DefMatAccountGuid
					 when @Kind = 1 then B.CustAccGuid end,
				B.Value,
				0,
				B.[CurrencyGuid],
				B.[CurrencyVal],
				B.[CostGuid],
				Case when @Kind = 1 then @DefMatAccountGuid
					 when @Kind = 0 then B.CustAccGuid end,
				[B].[Note]
			From
				@Bi_Tbl B
				
			
				
			Set @DetailNum = @DetailNum + 1
			
			Insert into #DEntry
		 	([ParentGuid],[Number],[AcGuid],[Debit],[Credit],[CurrencyGuid],[CurrencyVal],[CostGuid],[ObverseAcGuid],[Note])
			Select
				@EnGuid,
				@DetailNum,
				Case when @Kind = 0 then B.CustAccGuid
					 when @Kind = 1 then @DefMatAccountGuid end,
				0,
				B.Value,
				B.[CurrencyGuid],
				B.[CurrencyVal],
				B.[CostGuid],
				Case when @Kind = 1 then B.CustAccGuid
					 when @Kind = 0 then @DefMatAccountGuid end,
				[B].[Note]
			From
				@Bi_Tbl B
				
			
			
			--Set @DetailNum = @DetailNum + (Select COUNT(*) From BillDetail where ParentGuid = @BillGuid)
			--   
			Set @DetailNum = @DetailNum + 1
			Insert into #DEntry
		 	([ParentGuid],[Number],[AcGuid],[Debit],[Credit],[CurrencyGuid],[CurrencyVal],[CostGuid],[ObverseAcGuid],[Note])
			Select
				@EnGuid,
				@DetailNum,
				B.AccountGuid,
					 
				Case when @Kind = 0 then Extra
					 when @Kind = 1 then Discount end,
					 
				Case when @Kind = 1 then Extra
					 when @Kind = 0 then Discount end,
					 
				B.[CurrencyGuid],
				B.[CurrencyVal],
				B.[CostGuid],
				case when b.obverseAccountGuid IS Null then @CustAccountGuid else b.obverseAccountGuid  end,
				[B].[Note]
			From
				@Di_Tbl B
			
			Set @DetailNum = @DetailNum + 1
			Insert into #DEntry
		 	([ParentGuid],[Number],[AcGuid],[Debit],[Credit],[CurrencyGuid],[CurrencyVal],[CostGuid],[ObverseAcGuid],[Note])
			Select
				@EnGuid,
				@DetailNum,
				case when b.obverseAccountGuid IS Null then @CustAccountGuid else b.obverseAccountGuid  end,
					 
				Case when @Kind = 1 then Extra
					 when @Kind = 0 then Discount end,
					 
				Case when @Kind = 0 then Extra
					 when @Kind = 1 then Discount end,

				B.[CurrencyGuid],
				B.[CurrencyVal],
				B.[CostGuid],
				case when b.obverseAccountGuid IS Null then @DefMatAccountGuid else b.AccountGuid  end,
				
				[B].[Note]
			From
				@Di_Tbl B
			
			
			Update Bill Set EntryGuid = @EnGuid, EntryNumber = @EnNum
			where
				[Guid] = @BillGuid
		end

		insert into DEntry
		([ParentGuid],[Number],[AcGuid],[Debit],[Credit],[CurrencyGuid],[CurrencyVal],[CostGuid],[ObverseAcGuid],[Note])
		Select 
			@EnGuid,
			min([Number]),
			d.AcGuid , 
			Case when Sum(Debit-Credit) > 0 then Sum(Debit-Credit) else 0 end as Debit,
			Case when Sum(Debit-Credit) < 0 then -Sum(Debit-Credit) else 0 end as Credit,
			[CurrencyGuid],
			[CurrencyVal],
			[CostGuid],
			[ObverseAcGuid],
			[Note]
		from 
			#DEntry D 
		Group by
			d.AcGuid,
			[CurrencyGuid],
			[CurrencyVal],
			[CostGuid],
			[ObverseAcGuid],
			[Note],
			Case when @DetailEntryByMat = 1 then (Debit-Credit) else 0 end

		Select 
			[AcGuid],
			ac.Name , 
			Case when Sum(Debit-Credit) > 0 then Sum(Debit-Credit) else 0 end as Debit,
			Case when Sum(Debit-Credit) < 0 then -Sum(Debit-Credit) else 0 end as Credit,
			[ObverseAcGuid]
		from 
			#DEntry D 
			inner join Account ac on ac.Guid = d.AcGuid
		Group by
			[AcGuid],ac.Name, [ObverseAcGuid],
			Case when @DetailEntryByMat = 1 then (Debit-Credit) else 0 end


GO

SET ANSI_NULLS, QUOTED_IDENTIFIER ON
GO

Create Procedure [dbo].[PrcMatBillsDetail]
(
	@GroupGuid uniqueidentifier = 0x0,
	@MatGuid uniqueidentifier = 0x0,
	@StoreGuid uniqueidentifier = 0x0,
	@CostGuid uniqueidentifier = 0x0,
	@Class Varchar(256) = '',
	@Unit int = 2,
	@BillPost int = 2,

	@CurrencyGuid [uniqueidentifier] = '11111111-C748-4B13-8B91-1E9B299DF1C1',
	@CurrencyVal Float = 1,
	
	@CkDate Bit = 0,
	@Date1 DateTime = '1/1/2007',
	@Date2 DateTime = '1/1/2016'
)
 
as
	--Declare @BillChange bit
	--Select @BillChange = Value From DMD_const where VName = 'BillChange'
	--if @BillChange is Null Set @BillChange = 1
	--if @BillChange = 0 return
	--delete DMD_const where VName = 'BillChange'
	--insert into DMD_const Select 'BillChange', '0'
	
	select * into #fnGetGroupList from dbo.fnGetGroupList(@GroupGuid)
	select * into #fnGetStoreList from dbo.fnGetStoreList(@StoreGuid)
	select * into #fnGetCostList from dbo.fnGetCostList(@CostGuid)
	
	--Select * from #fnGetStoreList
	
	Create Table #MatMove
	(
		[BuNumber] int,
		[BuDate] DateTime,
		[buPayType] int,
		[BuPayTypeStr] Varchar(256) COLLATE database_default,
		[BuClass] Varchar(256) COLLATE database_default,
		[BuNote] Varchar(256) COLLATE database_default,
		[BillPost] Varchar(256) COLLATE database_default,
		[BtName] Varchar(256) COLLATE database_default,
		[CuName] Varchar(256) COLLATE database_default,
		[CuPhoneJob] Varchar(256) COLLATE database_default,
		[CuMobile] Varchar(256) COLLATE database_default,
		[CuAddress] Varchar(256) COLLATE database_default,
		[MyName] Varchar(256) COLLATE database_default,
		[BuCurrencyVal] Float,
		[AcCode] Varchar(256) COLLATE database_default,
		[AcName] Varchar(256) COLLATE database_default,
		
		[StCode] Varchar(256) COLLATE database_default,
		[StName] Varchar(256) COLLATE database_default,
		
		[CoCode] Varchar(256) COLLATE database_default,
		[CoName] Varchar(256) COLLATE database_default,

		[biNumber] int,
		[MatCode] Varchar(256) COLLATE database_default,
		[MatName] Varchar(256) COLLATE database_default,
		[MatLtnName] Varchar(256) COLLATE database_default,
		[GroupName] Varchar(256) COLLATE database_default,
		[ItemUnitStr] Varchar(256) COLLATE database_default,
		[Qty] Float,
		[Unit] Varchar(256) COLLATE database_default,

		[Qty2] Float,
		[Unity2] Varchar(256) COLLATE database_default ,

		[Qty3] Float,
		[Unity3] Varchar(256) COLLATE database_default,

		[Price] Float,
		[PurAvgPrice] Float,
		[TotalPrice] Float,
		[Bonus] Float,
		[DiscountPercent] Float,
		[Discount] Float,
		[ExtraPercent] Float,
		[Extra] Float,
		[Note] Varchar(256) COLLATE database_default,
		[ProductDate] Datetime,
		[ExpireDate] Datetime,
		[Class] Varchar(256) COLLATE database_default,
		[Length] Float,
		[width] Float,
		[height] Float,
		[Count] Float,
		[BuGuid] Uniqueidentifier,
		[MatGuid] Uniqueidentifier,
		[MatType] int,
		[StoreGuid] uniqueidentifier,
		[CostGuid] Uniqueidentifier,
		
		[CustGuid] Uniqueidentifier,
		[CustAccGuid] Uniqueidentifier,
		
		[TypeGuid] Uniqueidentifier,
		[CurrencyGuid] Uniqueidentifier,
		[CurrencyVal] Float,
		[BtInOut] int,
		[Kind] int,
		[BtBillKind] [int] NULL,
		[btPriceEffected] Bit
	)
	
	insert into #MatMove
	Select 
		[Bu].[BuNumber],
		[Bu].[BuDate],
		[Bu].[BuPayType],
		[Bu].[BuPayTypeStr],
		[Bu].[BuClass],
		[Bu].[BuNote],
		[Bu].[BillPost],
		[Bu].[BtName],
		[Bu].[CuName],
		[Bu].[CuPhoneJob],
		[Bu].[CuMobile],
		[Bu].[CuAddress],
		[Bu].[MyName],
		[Bu].[BuCurrencyVal],
		[Bu].[AcCode],
		[Bu].[AcName],
				
		'' as [StCode],
		'' as [StName],
		'' as [CoCode],
		'' as [CoName],
		d.Number,		[mt].[Code] as MatCode,		[mt].[Name] as [MatName],		[mt].[LtnName] as [MatltnName],		[mt].[GroupName],				Case when [d].[ItemUnit] = 1 then ''			 when [d].[ItemUnit] = 2 then ''			 when [d].[ItemUnit] = 3 then ''		end as [ItemUnitStr],				Case when @Unit = 1 then [d].[Qty]
			 when @Unit = 2 then [d].[Qty2]
			 when @Unit = 3 then [d].[Qty3]
			 when @Unit = 4 then 
								Case when [d].[ItemUnit] = 1 then [d].[Qty]									 when [d].[ItemUnit] = 2 then [d].[Qty2]									 when [d].[ItemUnit] = 3 then [d].[Qty3]								end
			 when @Unit = 0 then 
								Case when mt.[DefUnity] = 1 then [d].[Qty]
									 when mt.[DefUnity] = 2 then [d].[Qty2]
									 when mt.[DefUnity] = 3 then [d].[Qty3]
								end
		end as [Qty],
		Case when @Unit = 1 then mt.[Unity1]
			 when @Unit = 2 then mt.[Unity2]
			 when @Unit = 3 then mt.[Unity3]
			 when @Unit = 4 then 
								Case when [d].[ItemUnit] = 1 then mt.[Unity1]									 when [d].[ItemUnit] = 2 then mt.[Unity2]									 when [d].[ItemUnit] = 3 then mt.[Unity3]								end
			 when @Unit = 0 then 
								Case when mt.[DefUnity] = 1 then mt.[Unity1]
									 when mt.[DefUnity] = 2 then mt.[Unity2]
									 when mt.[DefUnity] = 3 then mt.[Unity3]
								end	
		end as [Unit],
		
		[d].[Qty2],
		mt.[Unity2],
		[d].[Qty3],
		mt.[Unity3],
		
		/*
		Case when @Unit = 1 then [d].[Price]
			 when @Unit = 2 then [d].[Price] * Case when mt.[UnityFact2] <> 0 then mt.[UnityFact2] end
			 when @Unit = 3 then [d].[Price] * Case when mt.[UnityFact3] <> 0 then mt.[UnityFact3] end
			 when @Unit = 4 then 
								Case when [d].[ItemUnit] = 1 then [d].[Price]
									 when [d].[ItemUnit] = 2 then [d].[Price] / Case when mt.[UnityFact2] <> 0 then mt.[UnityFact2] end
									 when [d].[ItemUnit] = 3 then [d].[Price] / Case when mt.[UnityFact3] <> 0 then mt.[UnityFact3] end
								end	
			 when @Unit = 0 then 
								Case when mt.[DefUnity] = 1 then [d].[Price]
									 when mt.[DefUnity] = 2 then [d].[Price] / Case when mt.[UnityFact2] <> 0 then mt.[UnityFact2] end
									 when mt.[DefUnity] = 3 then [d].[Price] / Case when mt.[UnityFact3] <> 0 then mt.[UnityFact3] end
								end	
		end as [Price],*/
		[Price],
		[d].[PurAvgPrice],
		[d].[TotalPrice],		[d].[Bonus],		[d].[DiscountPercent],		[d].[Discount] +						IsNull(						( 						((([d]. [TotalPrice] - [d].[Discount] + [D].[Extra] )* 100)/ 						Case when ([BuItemsTotal] - [BuitemsDiscount] + [BuitemsExtra]) <> 0 then ([BuItemsTotal] - [BuitemsDiscount] + [BuitemsExtra]) end)						* ([BuDiscount]-[BuitemsDiscount]) / 100						)						,0)						,		[d].[ExtraPercent],		[d].[Extra]						+IsNull(						( 						(([d].[TotalPrice] * 100)/ 						Case when ([BuItemsTotal] - [BuitemsDiscount] + [BuitemsExtra]) <> 0 then ([BuItemsTotal] - [BuitemsDiscount] + [BuitemsExtra]) end)						* ([BuExtra] - [BuItemsExtra]) / 100						)						,0)		,				[d].[Note],		[d].[ProductDate],		[d].[ExpireDate],		[d].[Class],		[d].[Length],		[d].[width],		[d].[height],		[d].[Count],		[BuGuid],
		[mt].[Guid] as MatGuid,
		[mt].MatType,
		D.StoreGuid,
		[bu].[buCostGuid],

		[buCustGuid],
		[BuCustAccGuid],
		
		Bu.[BuTypeGuid],
		[buCurrencyGuid],
		[buCurrencyVal],
		[BtInOut],		1,		bu.BtBillKind,		[btPriceEffected]	From 
		[vwbill] Bu
		inner join BillDetail D on d.ParentGuid = buGuid
		inner join vwMat mt on mt.Guid = d.MatGuid
		inner join dbo.#fnGetGroupList G on G.Guid = mt.GroupGuid
		inner join dbo.#fnGetStoreList Sl on Sl.Guid = D.StoreGuid
		inner join [vwStore] [St] on St.Guid = D.StoreGuid
	where
		(d.matGuid = @MatGuid or @MatGuid = 0x0)
		and (
				(d.class = @Class or @Class = '')
				or (bu.buclass = @Class or @Class = '')
			)
			
		and (
				(BuisPosted = 0 and @BillPost = 0)
				or (BuisPosted = 1 and @BillPost = 1)
				or @BillPost = 2
			)
		and ([BuDate] Between @Date1 And @Date2 or @CkDate = 0)
		
	Update #MatMove Set [DisCountPercent] = DisCount * 100 / Case when TotalPrice <> 0 then TotalPrice end
	Update #MatMove Set [ExtraPercent] = Extra * 100 / Case when TotalPrice <> 0 then TotalPrice end
	
	--
	Select 
		[b].[Number] as [BuNumber], 		[b].[Date] as [BuDate], 		[B].[PayType],		Case when [b].[PayType] = 0 then '' 			 when [b].[PayType] = 1 then '' 		end COLLATE database_default as [BuPayTypeStr],		[b].[Class] COLLATE database_default as [BuClass], 		[b].[Note] COLLATE database_default as [BuNote], 		Case when b.isPosted = 0 then dbo.SC(' ')
			 when b.isPosted = 1 then dbo.SC('')
		end COLLATE database_default as [TransPost],
		[t].[Name] COLLATE database_default as [BtName],
		[m].[Name] COLLATE database_default as [MyName],
		[m].[CurrencyVal] as [BuCurrencyVal],

		[b].StoreInGuid,
		[b].StoreOutGuid,
		[b].[CostInGuid],
		[b].[CostoutGuid],
					
		d.Number as BiNumber,		[mt].[Code] COLLATE database_default as MatCode,		[mt].[Name] COLLATE database_default as [MatName],		[mt].[LtnName] COLLATE database_default as [MatltnName],		[mt].[GroupName] COLLATE database_default as [GroupName],		Case when [d].[ItemUnit] = 1 then ''			 when [d].[ItemUnit] = 2 then ''			 when [d].[ItemUnit] = 3 then ''		end COLLATE database_default as [ItemUnitStr],				Case when @Unit = 1 then [d].[Qty]
			 when @Unit = 2 then [d].[Qty2]
			 when @Unit = 3 then [d].[Qty3]
			 when @Unit = 0 then 
								Case when mt.[DefUnity] = 1 then [d].[Qty]
									 when mt.[DefUnity] = 2 then [d].[Qty2]
									 when mt.[DefUnity] = 3 then [d].[Qty3]
								end
		end as [Qty],
		Case when @Unit = 1 then mt.[Unity1]
			 when @Unit = 2 then mt.[Unity2]
			 when @Unit = 3 then mt.[Unity3]
			 when @Unit = 0 then 
								Case when mt.[DefUnity] = 1 then mt.[Unity1]
									 when mt.[DefUnity] = 2 then mt.[Unity2]
									 when mt.[DefUnity] = 3 then mt.[Unity3]
								end	
		end COLLATE database_default as [Unit],
		
		[d].[Qty2],
		mt.[Unity2] COLLATE database_default as [Unity2],
		[d].[Qty3],
		mt.[Unity3] COLLATE database_default as [Unity3],

		Case when @Unit = 1 then [d].[Price]
			 when @Unit = 2 then [d].[Price] / Case when mt.[UnityFact2] <> 0 then mt.[UnityFact2] end
			 when @Unit = 3 then [d].[Price] / Case when mt.[UnityFact3] <> 0 then mt.[UnityFact3] end
			 when @Unit = 0 then 
								Case when mt.[DefUnity] = 1 then [d].[Price]
									 when mt.[DefUnity] = 2 then [d].[Price] / Case when mt.[UnityFact2] <> 0 then mt.[UnityFact2] end
									 when mt.[DefUnity] = 3 then [d].[Price] / Case when mt.[UnityFact3] <> 0 then mt.[UnityFact3] end
								end	
		end as [Price],
		0 as PurAvgPrice,
		[d].[TotalPrice],		[d].[Bonus],		[d].[DiscountPercent],		[d].[Discount],		[d].[ExtraPercent],		[d].[Extra],				[d].[Note] COLLATE database_default as [Note],		[d].[ProductDate],		[d].[ExpireDate],		[d].[Class] COLLATE database_default as [Class],		[d].[Length],		[d].[width],		[d].[height],		[d].[Count],		[B].[Guid] as BuGuid,		[mt].[Guid] as MatGuid,		[mt].MatType,		[b].TypeGuid,		B.CurrencyGuid,		B.CurrencyVal	into #Trans	From 
		[vbTrans] [B]
		inner join TransType [t] on [t].Guid = [b].TypeGuid
		inner join Currency [m] on [m].Guid = [b].CurrencyGuid
		inner join TransDetail D on d.ParentGuid = b.Guid
		inner join vwMat mt on mt.Guid = d.MatGuid
		inner join dbo.#fnGetGroupList G on G.Guid = mt.GroupGuid
	where
		(d.matGuid = @MatGuid or @MatGuid = 0x0)
		and (d.class = @Class or @Class = '')
		and (
				(B.isPosted = 0 and @BillPost = 0)
				or (B.isPosted = 1 and @BillPost = 1)
				or @BillPost = 2
			)
		and ([B].[Date] Between @Date1 And @Date2 or @CkDate = 0)

	
	if @StoreGuid <> 0x0
	begin
		Delete #Trans
		From
			#Trans T
			left join #fnGetStoreList St on (st.Guid = T.[StoreinGuid] or st.Guid = T.[StoreOutGuid])
		where
			St.Guid is null
	end

	
	if @CostGuid <> 0x0
	begin
		Delete #Trans
		From
			#Trans T
			left join #fnGetCostList St on st.Guid = T.[CostinGuid] 
		where
			St.Guid is null

		Delete #Trans
		From
			#Trans T
			left join #fnGetCostList St on st.Guid = T.[CostoutGuid] 
		where
			St.Guid is null
	end

	-- 
	insert into #MatMove
	Select 
		[Bu].[BuNumber],
		[Bu].[BuDate],
		[Bu].[PayType],
		[Bu].[BuPayTypeStr],
		[Bu].[BuClass],
		[Bu].[BuNote],
		[Bu].[TransPost],
		[Bu].[BtName] +' '+  dbo.SC(''),
		''  as [CuName],
		''  as [CuPhoneJob],
		''  as [CuMobile],
		''  as [CuAddress],
		[Bu].[MyName],
		[Bu].[BuCurrencyVal],
		''  as [AcCode],
		''  as [AcName],
				
		'' as [StCode],
		'' as [StName],
		'' as [CoCode],
		'' as [CoName],
		biNumber,		[Bu].MatCode,		[Bu].[MatName],		[Bu].[MatltnName],		[Bu].[GroupName],				[Bu].[ItemUnitStr],				[Bu].[Qty],
		[Bu].[Unit],
		
		[bu].[Qty2],
		bu.[Unity2],
		[bu].[Qty3],
		bu.[Unity3],

		[Bu].[Price],
		0 as PurAvgPrice,
		[Bu].[TotalPrice],		[Bu].[Bonus],		[Bu].[DiscountPercent],		[Bu].[Discount],		[Bu].[ExtraPercent],		[Bu].[Extra],				[Bu].[Note],		[Bu].[ProductDate],		[Bu].[ExpireDate],		[Bu].[Class],		[Bu].[Length],		[Bu].[width],		[Bu].[height],		[bu].[Count],		[Bu].[BuGuid],
		[Bu].[MatGuid],
		[bu].MatType,
		Bu.[StoreInGuid],	
		[Bu].[CostinGuid],
		
		0x0 as [BuCustGuid],
		0x0 as [BuCustAccGuid],
		
		TypeGuid,
		CurrencyGuid,		CurrencyVal,		1,		2,		1 as BtBillKind,		0 as [btPriceEffected]			From 
		#Trans Bu
		inner join #fnGetStoreList St on St.Guid = Bu.StoreinGuid

	-- 
	insert into #MatMove
	Select 
		[Bu].[BuNumber],
		[Bu].[BuDate],
		[Bu].[PayType],
		[Bu].[BuPayTypeStr],
		[Bu].[BuClass],
		[Bu].[BuNote],
		[Bu].[TransPost],
		[Bu].[BtName] +' '+  dbo.SC(''),
		''  as [CuName],
		''  as [CuPhoneJob],
		''  as [CuMobile],
		''  as [CuAddress],
		[Bu].[MyName],
		[Bu].[BuCurrencyVal],
		''  as [AcCode],
		''  as [AcName],
				
		'' as [StCode],
		'' as [StName],
		'' as [CoCode],
		'' as [CoName],
		biNumber,		[Bu].MatCode,		[Bu].[MatName],		[Bu].[MatltnName],		[Bu].[GroupName],				[Bu].[ItemUnitStr],				[Bu].[Qty] ,
		[Bu].[Unit],
		
		[bu].[Qty2],
		bu.[Unity2],
		[bu].[Qty3],
		bu.[Unity3],

		[Bu].[Price],
		0 as PurAvgPrice,
		[Bu].[TotalPrice],		[Bu].[Bonus] * -1,		[Bu].[DiscountPercent],		[Bu].[Discount],		[Bu].[ExtraPercent],		[Bu].[Extra],				[Bu].[Note],		[Bu].[ProductDate],		[Bu].[ExpireDate],		[Bu].[Class],		[Bu].[Length],		[Bu].[width],		[Bu].[height],		[bu].[Count],		[Bu].[BuGuid],
		[Bu].[MatGuid],
		[bu].MatType,
		Bu.[StoreOutGuid],	
		[Bu].[CostOutGuid],

		0x0 as [BuCustGuid],
		0x0 as [BuCustAccGuid],
		
		TypeGuid,
		CurrencyGuid,		CurrencyVal,		-1,		2,		-1 as BtBillKind,		0 as [btPriceEffected]			From 
		#Trans Bu
		inner join #fnGetStoreList St on St.Guid = Bu.StoreOutGuid


	--Store
	Update 
		#MatMove
	Set
		StCode = St.Code,
		StName = St.Name
	From
		#MatMove M
		inner join Store St on St.Guid = M.StoreGuid

	--Cost
	Update 
		#MatMove
	Set
		CoCode = Co.Code,
		CoName = Co.Name
	From
		#MatMove M
		inner join Cost Co on Co.Guid = M.CostGuid

	-- 
	Update 
		#MatMove
	Set
		Price = Price * 
					Case 
						when bu.[CurrencyGuid] = @CurrencyGuid then 1
						else
						bu.buCurrencyval / Case when @Currencyval <> 0 then @Currencyval end
					end,
		TotalPrice = TotalPrice * 
					Case 
						when bu.[CurrencyGuid] = @CurrencyGuid then 1
						else
						bu.buCurrencyval / Case when @Currencyval <> 0 then @Currencyval end
					end,
		Discount = Discount * 
					Case 
						when bu.[CurrencyGuid] = @CurrencyGuid then 1
						else
						bu.buCurrencyval / Case when @Currencyval <> 0 then @Currencyval end
					end,
		Extra = Extra * 
					Case 
						when bu.[CurrencyGuid] = @CurrencyGuid then 1
						else
						bu.buCurrencyval / Case when @Currencyval <> 0 then @Currencyval end
					end,
		[CurrencyGuid] = @CurrencyGuid,
		MyName = (Select Name From vwCurrency where Guid = @CurrencyGuid),
		buCurrencyVal = @CurrencyVal,
		CurrencyVal = @CurrencyVal
	From
		#MatMove bu

	if Exists(Select Top 1 * From sysObjects where Name = 'MatBillsDetail')
	Drop Table [MatBillsDetail]
	
	Select * into MatBillsDetail from #MatMove
	
	--Select * from MatBillsDetail
	

GO

SET ANSI_NULLS, QUOTED_IDENTIFIER ON
GO

Create Procedure [dbo].[PrcMatMove]
(
	@GroupGuid uniqueidentifier = 0x0,
	@MatGuid uniqueidentifier = 0x0,
 	@StoreGuid uniqueidentifier = 0x0,
	@CostGuid uniqueidentifier = 0x0,
	@Class Varchar(256) = '',
	@Unit int = 0,
	@BillPost int = 2,
	@ActiveNote Bit = 0,
	@OperationNote int = 0,
	@Note Varchar(256) = '',

	@CurrencyGuid uniqueidentifier = 0x0,
	@CurrencyVal Float = 1,
	@NegativeOnly bit = 0,
	@CkDate Bit = 0,
	@Date1 DateTime = '1/1/2007',
	@Date2 DateTime = '1/1/2017'
)
 
as
	if [dbo].[fnIsSQL2005]() = 0 
	begin
		Declare @Ms varchar(255)
		Set @Ms = dbo.SC('    sql 2008  ')
		RAISERROR (@Ms, 16, 1)
		return
	end
	
	Set nocount on
	exec [dbo].[PrcMatBillsDetail] @GroupGuid ,@MatGuid ,@StoreGuid,@CostGuid,@Class,@Unit,@BillPost,@CurrencyGuid, @Currencyval, @CkDate,@Date1,@Date2	

	--Select * from MatBillsDetail
	
	
	--  
	if @OperationNote = 0 --
	Set @Note = '%'+@Note+'%'
	
	Select 
		[Bu].[BuNumber],
		[Bu].[BiNumber],
		[Bu].[BuDate],
		[Bu].MatCode,		[Bu].[MatName],		Case when BtInOut = 1 then  [Bu].[Qty] else 0 end AS QtyIn,
		Case when BtInOut = -1 then  [Bu].[Qty] else 0 end AS QtyOut,
		[Bu].[Price],
		[Bu].[TotalPrice],		[Bu].StoreGuid,
		[Bu].[BtInOut],		Bu.Kind,		bu.BtBillKind,
		[Bu].[BuPayTypeStr],
		[Bu].[BuClass],
		[Bu].[BuNote],
		[Bu].[BillPost],
		[Bu].[BtName],
		[Bu].[CuName],
		[Bu].[CuPhoneJob],
		[Bu].[CuMobile],
		[Bu].[CuAddress],
		[Bu].[MyName],
		[Bu].[BuCurrencyVal],
		[Bu].[AcCode],
		[Bu].[AcName],
				
		[Bu].[StCode],
		[Bu].[StName],
		[Bu].[CoCode],
		[Bu].[CoName],
		[Bu].[MatltnName],		[Bu].[GroupName],				[Bu].[ItemUnitStr],				[Bu].[Unit],
		[Bu].[Bonus],		[Bu].[DiscountPercent],		[Bu].[Discount],		[Bu].[ExtraPercent],		[Bu].[Extra],		[Bu].[Note],		[Bu].[ProductDate],		[Bu].[ExpireDate],		[Bu].[Class],		[Bu].[Length],		[Bu].[width],		[Bu].[height],		[Bu].[Count],		[Bu].[BuGuid],
		[Bu].[CostGuid],
		Cast(0 as Float) as AvgPrice,
		[Bu].matGuid
	into #MatMove
	From
		MatBillsDetail Bu		
		inner join vwMat mt on mt.Guid = bu.MatGuid
		inner join [Resource] [R] on R.Guid = Bu.TypeGuid and R.Spid = @@Spid and (btInOut = isNull(R.Tag, 0) or isNull(R.Tag, 0) = 0)
	where
 		(
 				([Bu].[BuNote] Like @Note)
 				or ([Bu].[Note] Like @Note)
 				or @ActiveNote = 0
 			)
	
	
	Create Table #AvgPriceTbl 
	(	
		[BuDate] Datetime,
		[BuNumber] int,
		[BiNumber] int,
		[matGuid] uniqueidentifier,
		[BuGuid] uniqueidentifier,
		[AvgPrice] Float
	)

	
	insert into #AvgPriceTbl
	exec PrcCalcAvgPrice @GroupGuid,
						 @MatGuid,
 						 @StoreGuid,
						 @CostGuid,
						 @Class,
						 @Unit,
						 @BillPost,
						 @CurrencyGuid,
						 @CurrencyVal,
						 @CkDate,
						 @Date1,
						 @Date2,
						 1 --@ShowResult 
	
	--return
	--Select * from #AvgPriceTbl return
	
	CREATE CLUSTERED INDEX #IXMATMOVE ON #MatMove([budate], [BuNumber], [MatCode])

	Alter Table #MatMove add id int identity(1,1)
	
	Update #MatMove Set AvgPrice = P.AvgPrice
	From
		#MatMove M
		inner join #AvgPriceTbl P on P.BuGuid = M.[BuGuid]
								and  P.BiNumber = M.BiNumber
								and  P.MatGuid = M.MatGuid
	

	if @NegativeOnly = 1
	begin
		Select 
			* 
			,(Select Sum(QtyIn - QtyOut) From #MatMove m2 
				where 
					m.id >= m2.id 
					and m.MatCode = m2.MatCode
					and m.StoreGuid = m2.StoreGuid
			) as [Balance]
			,Case when ([btInOut] = -1) and (Kind <> 2) then ([TotalPrice] - Discount + Extra) - (avgPrice * (QtyIn - QtyOut)) end AS Profit
		into #ResMatMove
		from 
			#MatMove m
		Order By
			[budate], Kind, [btInOut] * -1 , [BuNumber], [MatCode]
		Select		
			*
		From
			#ResMatMove
		where
			[Balance] < 0
		Order By
			[budate], Kind, [btInOut] * -1 , [BuNumber], [MatCode]	end
	else
		Select 
			* 
			,(Select Sum(QtyIn - QtyOut) From #MatMove m2 
				where 
					m.id >= m2.id 
					and m.MatCode = m2.MatCode
					and m.StoreGuid = m2.StoreGuid
			) as [Balance]
			,Case when ([btInOut] = -1) and (Kind <> 2) then ([TotalPrice] - Discount + Extra) - (avgPrice * (QtyOut - QtyIn )) end AS Profit
		from 
			#MatMove m
		Order By
			[budate], Kind, [btInOut] * -1 , [BuNumber], [MatCode]	

GO

SET ANSI_NULLS, QUOTED_IDENTIFIER ON
GO
Create Procedure [dbo].[PrcContractInsurance]
(
	@CustGuid uniqueidentifier = 0x0,
	@BuildingGuid uniqueidentifier = 0x0,
	@FlatGuid uniqueidentifier = 0x0,
	@ShopGuid uniqueidentifier = 0x0,
	@ParkingGuid  uniqueidentifier = 0x0,
	@ContractState int = 2,
	@Datewith int = 0,
	@Date1 DateTime = '1/1/2007',
	@Date2 DateTime = '1/1/2011',
	@ShowIsCheck bit = 1,
	@ShowIsNotCheck Bit = 1,
	@CkShowNonInsourance Bit = 0,
	@ReturnInsurance int = 2
)
 
as
	Set NoCount On
	Declare @Tbl Table
	(
		[Customer] Varchar(256),
		[BuildingName] Varchar(256),
		[Flat] Varchar(256),
		[FloorNo] Varchar(256),
		[ContractNo] Varchar(256),
		[ContractState]  Varchar(256),
		[Insurance] Float,
		[InsuranceOld] Float,
		IsReturnInsurance bit,
		ReturnInsuranceDate Datetime,
		[ContractGuid] uniqueidentifier
	)

	-- 	
	if (@ParkingGuid = 0x0) and (@ShopGuid = 0x0)
	Insert into @Tbl 
	Select
		[Cu].[name] 
		,[B].[Name] as [BuildingName]
		,dbo.SC('')+' '+[A].[No] as [FlatNo]
		,[A].[FloorNo]
		,[L].[ContractNo]
		,Case when ([L].[ToDate] <= GetDate()) or ([L].[ContractFinish] = 1) then dbo.sc(' ')  
			  when [L].[ToDate] > GetDate() then dbo.sc('  ') end as [ContractState]
		,[L].[InsuranceValue]
		,[L].[InsuranceValueOld]
		,L.IsReturnInsurance
		,L.ReturnInsuranceDate
		,[L].[Guid]
	from 
		[vwBuilding] [B]
		Inner join [vwApartment] [A] On [A].[BuildingGuid] = [B].[Guid]
		Inner join [LeaseApartment] [L] On [A].[Guid] = [L].[ApartmentGuid] --and [LeaseKind]  = 0
		inner join [vwContractType] [T] on [T].[Guid] = [L].[TypeGuid]  
		Inner join [Resource] [R2] on [R2].[Guid] = [T].[Guid]  and [R2].[Kind] = 102 and [R2].[spid] = @@Spid 
		Inner join [vwCustomer] [Cu] on [Cu].[Guid] = [L].[CustomerGuid] 
	where
		([B].[Guid] = @BuildingGuid or @BuildingGuid = 0x0)
		and ([Cu].[Guid] = @CustGuid or @CustGuid = 0x0)
 		and (([L].[ApartmentGuid] = @FlatGuid or @FlatGuid = 0x0))
		and 
			(
				((([L].[ToDate] <= GetDate()) or ([L].[ContractFinish] = 1)) and @ContractState = 0)
			  	or ([L].[ToDate] > GetDate() and @ContractState = 1)
				or @ContractState = 2
			)

		and (
				(
					([L].[FromDate] >= @Date1 and @Datewith  = 0)
					and ([L].[FromDate] <= @Date2 and @Datewith  = 0 or @Date2 = '12/30/1899')
				)
				or
				(
					([L].[ToDate] >= @Date1 and @Datewith  = 1)
					and ([L].[ToDate] <= @Date2 and @Datewith  = 1 or @Date2 = '12/30/1899')
				)
			) 
		and(
			[L].[InsuranceValue] <> 0 or @CkShowNonInsourance = 1
			)
		and (L.isReturnInsurance = @ReturnInsurance or @ReturnInsurance = 2)


	-- 	
	if (@ParkingGuid = 0x0) and (@FlatGuid = 0x0)
	Insert into @Tbl 
	Select
		[Cu].[name] 
		,[B].[Name] as [BuildingName]
		,dbo.SC('')+' '+[A].[No] as [FlatNo]
		,'' as [FloorNo]
		,[L].[ContractNo]
		,Case when ([L].[ToDate] <= GetDate()) or ([L].[ContractFinish] = 1) then dbo.sc(' ')  
			  when [L].[ToDate] > GetDate() then dbo.sc('  ') end as [ContractState]
		,[L].[InsuranceValue]
		,[L].[InsuranceValueOld]
		,L.IsReturnInsurance
		,L.ReturnInsuranceDate
		,[L].[Guid]
	from 
		[vwBuilding] [B]
		Inner join [vwShop] [A] On [A].[BuildingGuid] = [B].[Guid]
		Inner join [LeaseApartment] [L] On [A].[Guid] = [L].[ApartmentGuid] --and [LeaseKind]  = 0
		inner join [vwContractType] [T] on [T].[Guid] = [L].[TypeGuid]  
		Inner join [Resource] [R2] on [R2].[Guid] = [T].[Guid]  and [R2].[Kind] = 102 and [R2].[spid] = @@Spid 
		Inner join [vwCustomer] [Cu] on [Cu].[Guid] = [L].[CustomerGuid] 
	where
		([B].[Guid] = @BuildingGuid or @BuildingGuid = 0x0)
		and ([Cu].[Guid] = @CustGuid or @CustGuid = 0x0)
 		and (([L].[ApartmentGuid] = @ShopGuid or @ShopGuid = 0x0))
		and 
			(
				((([L].[ToDate] <= GetDate()) or ([L].[ContractFinish] = 1)) and @ContractState = 0)
			  	or ([L].[ToDate] > GetDate() and @ContractState = 1)
				or @ContractState = 2
			)

		and (
				(
					([L].[FromDate] >= @Date1 and @Datewith  = 0)
					and ([L].[FromDate] <= @Date2 and @Datewith  = 0 or @Date2 = '12/30/1899')
				)
				or
				(
					([L].[ToDate] >= @Date1 and @Datewith  = 1)
					and ([L].[ToDate] <= @Date2 and @Datewith  = 1 or @Date2 = '12/30/1899')
				)
			) 
		and(
			[L].[InsuranceValue] <> 0 or @CkShowNonInsourance = 1
			)
		and (L.isReturnInsurance = @ReturnInsurance or @ReturnInsurance = 2)

	--
	if (@FlatGuid = 0x0) and (@FlatGuid = 0x0)
	Insert into @Tbl 
	Select
		[Cu].[name] 
		,[B].[Name] as [BuildingName]
		,dbo.SC('')+' '+[A].[No] as [FlatNo]
		,[A].[FloorNo]
		,[L].[ContractNo]
		,Case when ([L].[ToDate] <= GetDate()) or ([L].[ContractFinish] = 1) then dbo.sc(' ')  
			  when [L].[ToDate] > GetDate() then dbo.sc('  ') end as [ContractState]
		,[L].[InsuranceValue]
		,[L].[InsuranceValueOld]
		,L.IsReturnInsurance
		,L.ReturnInsuranceDate
		,[L].[Guid]
	from 
		[vwBuilding] [B]
		Inner join [vwParking] [A] On [A].[BuildingGuid] = [B].[Guid]
		Inner join [ParkingContract] [L] On [A].[Guid] = [L].[ParkingGuid] --and [LeaseKind]  = 0
		inner join [vwContractType] [T] on [T].[Guid] = [L].[TypeGuid]  
		Inner join [Resource] [R2] on [R2].[Guid] = [T].[Guid]  and [R2].[Kind] = 102 and [R2].[spid] = @@Spid 
		Inner join [vwCustomer] [Cu] on [Cu].[Guid] = [L].[CustomerGuid] 
	where
		([B].[Guid] = @BuildingGuid or @BuildingGuid = 0x0)
		and ([Cu].[Guid] = @CustGuid or @CustGuid = 0x0)
 		and (([L].[ParkingGuid] = @ParkingGuid or @ParkingGuid = 0x0))
		and 
			(
				((([L].[ToDate] <= GetDate()) or ([L].[ContractFinish] = 1)) and @ContractState = 0)
			  	or ([L].[ToDate] > GetDate() and @ContractState = 1)
				or @ContractState = 2
			)

		and (
				(
					([L].[FromDate] >= @Date1 and @Datewith  = 0)
					and ([L].[FromDate] <= @Date2 and @Datewith  = 0 or @Date2 = '12/30/1899')
				)
				or
				(
					([L].[ToDate] >= @Date1 and @Datewith  = 1)
					and ([L].[ToDate] <= @Date2 and @Datewith  = 1 or @Date2 = '12/30/1899')
				)
			) 
		and(
			[L].[InsuranceValue] <> 0 or @CkShowNonInsourance = 1
			)
		and (L.isReturnInsurance = @ReturnInsurance or @ReturnInsurance = 2)


	Declare @PCheck Bit 
	Set @PCheck = 1	
	Declare @PNotCheck Bit 
	Set @PNotCheck = 0

	Select 
		[E].*,
		isnull([Insurance],0) + isNull([InsuranceOld],0) as [SumInsurance],
		Case when [R].[ObjGuid] is null then @PNotCheck
			 when [R].[ObjGuid] is not null  then @PCheck end as [Check]
	From
		@Tbl [E]
		left join [RepCheck] [R] on [R].[ObjGuid] = [E].[ContractGuid] and [R].[IdReport] = 8000
	where
		([R].[ObjGuid] is not null and @ShowIsCheck = 1)
		or
		([R].[ObjGuid] is null and @ShowIsNotCheck = 1)
	Order By 
		[BuildingName],
		[Flat]

	Select 
		Sum(isnull([Insurance],0) + isNull([InsuranceOld],0)) as [SumInsurance],
		Sum(isnull([Insurance],0)) as [Insurance],
		Sum(isNull([InsuranceOld],0)) as [InsuranceOld]
	From
		@Tbl [E]
		left join [RepCheck] [R] on [R].[ObjGuid] = [E].[ContractGuid] and [R].[IdReport] = 8000
	where
		([R].[ObjGuid] is not null and @ShowIsCheck = 1)
		or
		([R].[ObjGuid] is null and @ShowIsNotCheck = 1)

GO

SET ANSI_NULLS, QUOTED_IDENTIFIER ON
GO

Create Procedure [PrcWarningEndedContract]
(
	@CustGuid uniqueidentifier = 0x0,
	@FlatNo Varchar(256) = '',
	@FloorNo Varchar(256) = '',	
	@FlatKind Varchar(256) = '',	
	@ApartmentType Varchar(256) = '',	
	@Class Varchar(256) = '',	
	@Day Int = 0,
	@Day2 Int = 0,
	@All bit = 1,
	@Date1 DateTime = '2009-1-1',
	@Date2 DateTime = '2012-1-1',
	@CheckDate Bit = 1,
	@DayAndDateState int = 0

	,@ActiveNote Bit = 0
	,@OperationNote int = 0
	,@RealtyNote  Varchar(256) = '' 
	,@ContractActiveNote Bit = 0
	,@ContractOpNote int = 0
	,@ContractNote  Varchar(256) = '' 
    ,@ContractCount1 int = 0
    ,@ContractCount2 int = 0
	,@SMS int = 2
)
 
as
	Declare @Check Bit,
			@NotCheck Bit
	Set @Check = 1
	Set @NotCheck = 0

	--  
	if @OperationNote = 0 --
	Set @RealtyNote = '%'+@RealtyNote+'%'
	
	--  
	if @ContractOpNote = 0 --
	Set @ContractNote = '%'+@ContractNote+'%'

	CREATE TABLE #R
	(
		[ContractNo] [varchar](256),
		[BuildingName] [varchar](256),
		[BuildingltnName] [varchar](256),
		[BuildingArName] [varchar](256),
		
		[OwnerName] [varchar](255),
		[RealtyOwnerName] [varchar](255),
		[RentName] [varchar](255),
		
		[CustomerName] [varchar](256),
		[CustomerltnName] [varchar](256),
		[CustomerArName] [varchar](256),
		[PhoneJob] [varchar](256),
		[CustomerMobile] [varchar](256),
		[CustomerEMail] [varchar](256),
		[No] [varchar](512),
		[FlatKind] [varchar](256),
		[Floor] [varchar](256),
		[ApartmentType] [varchar](256),
		[FromDate] [datetime],
		[ToDate] [datetime],
		[Datediff] [int],
		[RentAfterDiscount] [float],
		[LeaseKind] [int],
		[Judicial] bit,
		[RealtyRent] Float,
		CountOldContract int,
		CountCurrentContract int,
		[AlertPrinted] [bit],
		[AlertPrintedDate] [datetime],
		[AlertPrintedCount] [int],
		[AlertPrint] [int],
		[SMSSended] [bit],
		[SMSCount] [int],
		[Guid] [uniqueidentifier],
		[FlatNote] [varchar](256),
		[ContractNote] [varchar](8000),
		[Bulding_Emirate] [varchar](256),
		[Bulding_Area] [varchar](256),
		[Bulding_Street] [varchar](256),
		[Bulding_BuildingNo] [varchar](256),
		[Bulding_PieceNo] [varchar](256),
		[Bulding_BasinNo] [varchar](256),
		[Bulding_BondType] [varchar](256),
		[Bulding_BondNo] [varchar](256),
		[Bulding_BondDate] [datetime],
		[Operation] bit,
		[FlatContract] [varchar](255),
		[AddPercent] Float,
		[AddValue] Float,
		ContractTag int,
		[PayType] varchar(255),
		[txt_RentDuration] varchar(255),
		[txt_Rentype] varchar(255),
		[txt_TermsOfPayment] varchar(255),
		[txt_LtnRentDuration] varchar(255),
		[txt_LtnRentype] varchar(255),
		[txt_LtnTermsOfPayment] varchar(255)
	)
	
	
	-- 
	Insert into #R
	Select 
		[ContractNo],
		[B].[Name] as [BuildingName],
		[B].[ltnName] as [BuildingltnName],
		[B].[ArName] as [BuildingArName],
		
		Onr.Name as [OwnerName],
		Case when Isnull([A].[No], '') <> '' then OA.Name else OS.Name end	as [RealtyOwnerName],
		
		rf.Name as [RentName],
		
		[cu].[Name] as [CustomerName],
		[cu].[ltnName] as [CustomerltnName],
		[cu].[arName] as [CustomerArName],
		[cu].[PhoneJob], 
		[cu].[Mobile], 
		[cu].[EMail], 
		Case when Isnull([A].[No], '') <> '' then [A].[No] else [S].[No] end as [No],
		Case when Isnull([A].[No], '') <> '' then dbo.SC('') else dbo.SC('') end as [FlatKind],
		Case when Isnull([A].[No], '') <> '' then [A].[FloorNo] else Null end as [Floor],
		Case when Isnull([A].[No], '') <> '' then [A].[ApartmentType] else [S].[Description] end as [ApartmentType],
		[FromDate],
		[ToDate],
		case when DateDiff(Day,  [ToDate], GetDate()) > 0 then DateDiff(Day,  [ToDate], GetDate()) end as [Datediff],
		[L].[Rent] - [L].[DiscountValue] as [RentAfterDiscount],
		[LeaseKind],
		L.Judicial,
		Case when Isnull([A].[No], '') <> '' then
			A.Rent
		else 
			S.Rent
		end as [RealtyRent],
		l.CountOldContract,
		(Select IsNull(COUNT(*),0) 	From [LeaseApartment] where
			CustomerGuid = l.CustomerGuid
			and ApartmentGuid = l.ApartmentGuid),
			
		Case when [R2].[ObjGuid] is null then ( @NotCheck )
			 when [R2].[ObjGuid] is not null  then @Check end as [AlertPrinted],
		[R2].[Date] as [AlertPrintedDate],
		[R3].[Count] as [AlertPrintedCount],
		Null as [AlertPrint],

		Case when [SMS2].[ObjGuid] is null then ( @NotCheck )
			 when [SMS2].[ObjGuid] is not null  then @Check end as [SMSSended],
		[SMS3].[Count] as [SMSCount],

		[L].[Guid]
		,[A].[Note] as [FlatNote]
		,[L].[Note2] as [ContractNote]
		,[B].[Emirate] as [Bulding_Emirate]
		,[B].[Area] as [Bulding_Area]
		,[B].[Street] as [Bulding_Street]
		,[B].[BuildingNo] as [Bulding_BuildingNo]
		,[B].[PieceNo] as [Bulding_PieceNo]
		,[B].[BasinNo] as [Bulding_BasinNo]
		,[B].[BondType] as [Bulding_BondType]
		,[B].[BondNo] as [Bulding_BondNo]
		,[B].[BondDate] as [Bulding_BondDate]
		, 0 as [Operation]
		,'' as [FlatContract]
		,L.[AddPercent]
		,L.[AddValue]
		,1 as [ContractTag]
		,Case 
			when L.PayType = 0 then dbo.SC('')
			when L.PayType = 1 then dbo.SC('')
			when L.PayType = 2 then dbo.SC(' ')
			when L.PayType = 3 then dbo.SC('')
		end as paytype
		,L.[RentDuration]
		,L.[Rentype]
		,L.[TermsOfPayment]
		,L.[LtnRentDuration]
		,L.[LtnRentype]
		,L.[LtnTermsOfPayment]
	From
		[vbLeaseApartment] [L]
		inner join [vwBuilding] [B] On [L].[BuildingGuid] = [B].[Guid]

		LEFT join [vwOwner] Onr on onr.Guid = b.OwnerGuid
		LEFT join [RentInfo] rf on rf.Guid = L.[RentInfoGuid]

		inner join [Resource] [RS] on [RS].[Guid] = [B].[Guid] and [RS].[Spid] = @@Spid and [RS].[Kind] = 4001
		inner join [Resource] [RS2] on [RS2].[Guid] = [L].[TypeGuid] and [RS2].[Spid] = @@Spid and [RS2].[Kind] = 4002
		inner join [vwCustomer] [cu] on [cu].[Guid] = [L].[CustomerGuid]
		left join [vwApartment] [A] On [A].[Guid] = [L].[ApartmentGuid]
		left join [vwShop] [S] On [S].[Guid] = [L].[ApartmentGuid]

		left join [vwCustomer] [OA] on [OA].[Guid] = [A].CustOwnerGuid
		left join [vwCustomer] [OS] on [OS].[Guid] = [S].CustGuid

		left join [RepCheck] [R] on [R].[ObjGuid] = [L].[Guid] and [R].[IdReport] = 9001
		left join [RepCheck] [R2] on [R2].[ObjGuid] = [L].[Guid] and [R2].[IdReport] = 9000
		left join (Select 
						[ObjGuid],
						[IdReport],
						Count(*) as [Count]
					From
						[RepCheckCount] 
					Group By
						[ObjGuid],
						[IdReport]
					)[R3] on [R3].[ObjGuid] = [L].[Guid] and [R3].[IdReport] = 9000

		left join [RepSMS] [SMS2] on [SMS2].[ObjGuid] = [L].[Guid] and [SMS2].[IdReport] = 9000
		left join (Select 
						[ObjGuid],
						[IdReport],
						Count(*) as [Count]
					From
						[RepSMSCount] 
					Group By
						[ObjGuid],
						[IdReport]
					)[SMS3] on [SMS3].[ObjGuid] = [L].[Guid] and [SMS3].[IdReport] = 9000
 	where
  		(([Todate] <= GetDate() and [ContractFinish] = 0) Or @DayAndDateState = 1)
  		and((
  				(DateDiff(Day,  [ToDate], GetDate()) between @Day and @Day2) or (@Day = 0 and @Day2 = 0))
  				Or @DayAndDateState = 1
  			)
 		and (
 				(
 					([Todate] Between @Date1 And @Date2) and [ContractFinish] = 0
 				)
 				Or @DayAndDateState = 0
 			)

		and (
				([SMS2].[ObjGuid] is Not Null and @SMS = 0)
				or ([SMS2].[ObjGuid] is Null and @SMS = 1)
				or @SMS = 2
			)

 		and ([LeaseKind] = 0 or [LeaseKind] = 1)
 		and ([R].[ObjGuid] is Not Null or @All = 1)
  		and ([L].[CustomerGuid] = @CustGuid or @CustGuid = 0x0)
  		and ([A].[No] = @FlatNo or [S].[No] = @FlatNo or @FlatNo = '')
  		and ([A].[FloorNo] = @FloorNo or @FloorNo = '')
  		and ([A].[FlatKind] = @FlatKind or @FlatKind = '')
  		and ([A].[ApartmentType] = @ApartmentType or @ApartmentType = '')
  		and ([A].[Class] = @Class or @Class = '')
 		and 
 			(
 				[A].[Note] Like @RealtyNote 
 				or @ActiveNote = 0
 			)
 
 		and 
 			(
 				[L].[Note2] Like @ContractNote 
 				or @ContractActiveNote = 0
 			)


	Order By
		[B].[Name],
		DateDiff(Day,  [ToDate], GetDate())
		

	--
	Insert into #R
	Select 
		[ContractNo],
		[B].[Name] as [BuildingName],
		[B].[ltnName] as [BuildingltnName],
		[B].[ArName] as [BuildingArName],
		
		Onr.Name as [OwnerName],
		'' as [RealtyOwnerName],
		
		rf.Name as [RentName],
		
		[cu].[Name] as [CustomerName],
		[cu].[ltnName] as [CustomerltnName],
		[cu].[arName] as [CustomerArName],
		[cu].[PhoneJob], 
		[cu].[Mobile], 
		[cu].[EMail], 
		[A].[No]as [No],
		dbo.SC('') as [FlatKind],
		'' as [Floor],
		[A].[Description] as [ApartmentType],
		[FromDate],
		[ToDate],
		case when DateDiff(Day,  [ToDate], GetDate()) > 0 then DateDiff(Day,  [ToDate], GetDate()) end as [Datediff],
		[L].[Rent] as [RentAfterDiscount],
		[ContractKind],
		L.Judicial,
		A.rent,
		0 AS CountOldContract,
		(Select IsNull(COUNT(*),0) + 1 	From [ParkingContract] where
			CustomerGuid = l.CustomerGuid
			and ParkingGuid = l.ParkingGuid)
		AS CountCurrentContract,
		Case when [R2].[ObjGuid] is null then ( @NotCheck )
			 when [R2].[ObjGuid] is not null  then @Check end as [AlertPrinted],
		[R2].[Date] as [AlertPrintedDate],
		[R3].[Count] as [AlertPrintedCount],
		Null as [AlertPrint],

		Case when [SMS2].[ObjGuid] is null then ( @NotCheck )
			 when [SMS2].[ObjGuid] is not null  then @Check end as [SMSSended],
		[SMS3].[Count] as [SMSCount],

		[L].[Guid]
		,[A].[Note] as [FlatNote]
		,[L].[Note2] as [ContractNote]
		,[B].[Emirate] as [Bulding_Emirate]
		,[B].[Area] as [Bulding_Area]
		,[B].[Street] as [Bulding_Street]
		,[B].[BuildingNo] as [Bulding_BuildingNo]
		,[B].[PieceNo] as [Bulding_PieceNo]
		,[B].[BasinNo] as [Bulding_BasinNo]
		,[B].[BondType] as [Bulding_BondType]
		,[B].[BondNo] as [Bulding_BondNo]
		,[B].[BondDate] as [Bulding_BondDate]
		, 0 as [Operation]
		,(Select Top 1 FlatNo from vwLeaseApartment where Guid = [FlatContractGuid])
		,L.[AddPercent]
		,L.[AddValue]
		,2 as [ContractTag]

		,Case 
			when L.PayType = 0 then dbo.SC('')
			when L.PayType = 1 then dbo.SC('')
			when L.PayType = 2 then dbo.SC(' ')
			when L.PayType = 3 then dbo.SC('')
		end as paytype

		,L.[RentDuration]
		,L.[Rentype]
		,L.[TermsOfPayment]
		,L.[LtnRentDuration]
		,L.[LtnRentype]
		,L.[LtnTermsOfPayment]
	From
		[vbParkingContract] [L]
		inner join [vwBuilding] [B] On [L].[BuildingGuid] = [B].[Guid]
		
		LEFT join [vwOwner] Onr on onr.Guid = b.OwnerGuid
		LEFT join [RentInfo] rf on rf.Guid = L.[RentInfoGuid]

		inner join [Resource] [RS] on [RS].[Guid] = [B].[Guid] and [RS].[Spid] = @@Spid and [RS].[Kind] = 4001
		inner join [Resource] [RS2] on [RS2].[Guid] = [L].[TypeGuid] and [RS2].[Spid] = @@Spid and [RS2].[Kind] = 4002
		inner join [vwCustomer] [cu] on [cu].[Guid] = [L].[CustomerGuid]
		left join [vwParking] [A] On [A].[Guid] = [L].[ParkingGuid]
		left join [RepCheck] [R] on [R].[ObjGuid] = [L].[Guid] and [R].[IdReport] = 9001
		left join [RepCheck] [R2] on [R2].[ObjGuid] = [L].[Guid] and [R2].[IdReport] = 9000
		left join (Select 
						[ObjGuid],
						[IdReport],
						Count(*) as [Count]
					From
						[RepCheckCount] 
					Group By
						[ObjGuid],
						[IdReport]
					)[R3] on [R3].[ObjGuid] = [L].[Guid] and [R3].[IdReport] = 9000

		left join [RepSMS] [SMS2] on [SMS2].[ObjGuid] = [L].[Guid] and [SMS2].[IdReport] = 9000
		left join (Select 
						[ObjGuid],
						[IdReport],
						Count(*) as [Count]
					From
						[RepSMSCount] 
					Group By
						[ObjGuid],
						[IdReport]
					)[SMS3] on [SMS3].[ObjGuid] = [L].[Guid] and [SMS3].[IdReport] = 9000
 	where
  		(([Todate] <= GetDate() and [ContractFinish] = 0) Or @DayAndDateState = 1)
  		and((
  				(DateDiff(Day,  [ToDate], GetDate()) between @Day and @Day2) or (@Day = 0 and @Day2 = 0))
  				Or @DayAndDateState = 1
  			)
 		and (
 				(
 					([Todate] Between @Date1 And @Date2) and [ContractFinish] = 0
 				)
 				Or @DayAndDateState = 0
 			)

		and (
				([SMS2].[ObjGuid] is Not Null and @SMS = 0)
				or ([SMS2].[ObjGuid] is Null and @SMS = 1)
				or @SMS = 2
			)

 		and ([ContractKind] = 4)
 		and ([R].[ObjGuid] is Not Null or @All = 1)
  		and ([L].[CustomerGuid] = @CustGuid or @CustGuid = 0x0)
  		and ([A].[No] = @FlatNo or @FlatNo = '')
  		and ([A].[FloorNo] = @FloorNo or @FloorNo = '')
  		and ([A].[ParkingKind] = @FlatKind or @FlatKind = '')
  		and ([A].[Description] = @ApartmentType or @ApartmentType = '')
 		and 
 			(
 				[A].[Note] Like @RealtyNote 
 				or @ActiveNote = 0
 			)
 
 		and 
 			(
 				[L].[Note2] Like @ContractNote 
 				or @ContractActiveNote = 0
 			)


	Order By
		[B].[Name],
		DateDiff(Day,  [ToDate], GetDate())		
		
	
	--
	Insert into #R
	Select 
		[ContractNo],
		'' as [BuildingName],
		'' as [BuildingltnName],
		'' as [BuildingArName],
		
		'' as [OwnerName],
		'' as [RealtyOwnerName],
		
		'' as [RentName],
		
		[cu].[Name] as [CustomerName],
		[cu].[ltnName] as [CustomerltnName],
		[cu].[arName] as [CustomerArName],
		[cu].[PhoneJob], 
		[cu].[Mobile], 
		[cu].[EMail], 
		[L].[Name]as [No],
		Case when [ContractKind] = 6 or [ContractKind] = 7 then dbo.SC('')
		 when [ContractKind] = 8 or [ContractKind] = 9 then dbo.SC('')
		end 
		as [FlatKind],
		'' as [Floor],
		[LandType],
		[FromDate],
		[ToDate],
		case when DateDiff(Day,  [ToDate], GetDate()) > 0 then DateDiff(Day,  [ToDate], GetDate()) end as [Datediff],
		[L].[Rent] as [RentAfterDiscount],
		[ContractKind],
		L.Judicial,
		0 as RealtyRent,
		0 as CountOldContract,
		(Select IsNull(COUNT(*),0) + 1 	From LandContract where
			CustomerGuid = l.CustomerGuid
			and (LandGuid = l.LandGuid or VillaGuid = l.VillaGuid))
		AS CountCurrentContract,
		Case when [R2].[ObjGuid] is null then ( @NotCheck )
			 when [R2].[ObjGuid] is not null  then @Check end as [AlertPrinted],
		[R2].[Date] as [AlertPrintedDate],
		[R3].[Count] as [AlertPrintedCount],
		Null as [AlertPrint],

		Case when [SMS2].[ObjGuid] is null then ( @NotCheck )
			 when [SMS2].[ObjGuid] is not null  then @Check end as [SMSSended],
		[SMS3].[Count] as [SMSCount],

		[L].[Guid]
		,[L].UnitNote as [FlatNote]
		,[L].[Note2] as [ContractNote]
		,'' as [Bulding_Emirate]
		,'' as [Bulding_Area]
		,'' as [Bulding_Street]
		,'' as [Bulding_BuildingNo]
		,'' as [Bulding_PieceNo]
		,'' as [Bulding_BasinNo]
		,'' as [Bulding_BondType]
		,'' as [Bulding_BondNo]
		,'' as [Bulding_BondDate]
		, 0 as [Operation]
		,'' as [FlatContract]
		,L.[AddPercent]
		,L.[AddValue]
		,3 as [ContractTag]

		,Case 
			when L.PayType = 0 then dbo.SC('')
			when L.PayType = 1 then dbo.SC('')
			when L.PayType = 2 then dbo.SC(' ')
			when L.PayType = 3 then dbo.SC('')
		end as paytype

		,L.[RentDuration]
		,L.[Rentype]
		,L.[TermsOfPayment]
		,L.[LtnRentDuration]
		,L.[LtnRentype]
		,L.[LtnTermsOfPayment]
	From
		[vwLandContract] [L]
		inner join [Resource] [RS2] on [RS2].[Guid] = [L].[TypeGuid] and [RS2].[Spid] = @@Spid and [RS2].[Kind] = 4002
		inner join [vwCustomer] [cu] on [cu].[Guid] = [L].[CustomerGuid]
		left join [RepCheck] [R] on [R].[ObjGuid] = [L].[Guid] and [R].[IdReport] = 9001
		left join [RepCheck] [R2] on [R2].[ObjGuid] = [L].[Guid] and [R2].[IdReport] = 9000
		left join (Select 
						[ObjGuid],
						[IdReport],
						Count(*) as [Count]
					From
						[RepCheckCount] 
					Group By
						[ObjGuid],
						[IdReport]
					)[R3] on [R3].[ObjGuid] = [L].[Guid] and [R3].[IdReport] = 9000

		left join [RepSMS] [SMS2] on [SMS2].[ObjGuid] = [L].[Guid] and [SMS2].[IdReport] = 9000
		left join (Select 
						[ObjGuid],
						[IdReport],
						Count(*) as [Count]
					From
						[RepSMSCount] 
					Group By
						[ObjGuid],
						[IdReport]
					)[SMS3] on [SMS3].[ObjGuid] = [L].[Guid] and [SMS3].[IdReport] = 9000
 	where
  		(([Todate] <= GetDate() and [ContractFinish] = 0) Or @DayAndDateState = 1)
  		and(
  				(DateDiff(Day,  [ToDate], GetDate()) between @Day and @Day2) or (@Day = 0 and @Day2 = 0)
  				Or @DayAndDateState = 1
  			)
 		and (
 				(
 					([Todate] Between @Date1 And @Date2) and [ContractFinish] = 0
 				)
 				Or @DayAndDateState = 0
 			)

		and (
				([SMS2].[ObjGuid] is Not Null and @SMS = 0)
				or ([SMS2].[ObjGuid] is Null and @SMS = 1)
				or @SMS = 2
			)

 		and ([ContractKind] in (7,9))
 		and ([R].[ObjGuid] is Not Null or @All = 1)
		and ([L].[CustomerGuid] = @CustGuid or @CustGuid = 0x0)
  		and ([L].[Name] = @FlatNo or @FlatNo = '')
 		and 
 			(
 				[L].[UnitNote] Like @RealtyNote 
 				or @ActiveNote = 0
 			)
 
 		and 
 			(
 				[L].[Note2] Like @ContractNote 
 				or @ContractActiveNote = 0
 			)


	Order By
		DateDiff(Day,  [ToDate], GetDate())				
		
		
	Select
		*,
		isNull(CountOldContract,0) + ISNULL(CountCurrentContract ,0) as [AllContractCount],
		isNull([RentAfterDiscount],0) + isNull([AddValue],0) as [RentAfterAdd],
		0 as [SMS],
		0 as [MsgSend]
	From
		#R
	where
		(isNull(CountOldContract,0) + ISNULL(CountCurrentContract ,0)) between @ContractCount1 and @ContractCount2 or (@ContractCount1 = 0 and @ContractCount2 = 0)
	Order By
		[DateDiff]

	Select 
		COUNT(*) as [Count],
		SUM([RentAfterDiscount]) as [RentAfterDiscount]
	From
		#R
	where
		(isNull(CountOldContract,0) + ISNULL(CountCurrentContract ,0)) between @ContractCount1 and @ContractCount2 or (@ContractCount1 = 0 and @ContractCount2 = 0)
		

GO

SET ANSI_NULLS, QUOTED_IDENTIFIER ON
GO

Create Procedure [PrcCheckLatePayment]
(
	@AcGuid uniqueidentifier = 0x0,
	@ContractGuid uniqueidentifier = 0x0,
	@LateDay int = 10,
	@ActiveBuildingList bit = 0,
	@WithoutReturnCheck Bit = 1,
	@CheckNonDueDate Bit = 1,
	@Date1 DateTime = '5/31/2009',
	@Date2 DateTime = '5/31/2013'
)
 
as
	Set @Date1 = GetDate()
	
	Declare @DeservedDate DateTime 
	Set @DeservedDate = @Date1  -@LateDay
	
	-- 
	Create Table [#CheckLatePayment_tmp_CashValue]
	(
		[Guid] uniqueidentifier,
		[ContractGuid] uniqueidentifier,
		[value] Float
	)
	
	insert into [#CheckLatePayment_tmp_CashValue]
	Select
		[Guid],
		[ContractGuid],
		[value]
	From
		[vwContractCachPayment]
	where
		ContractGuid = 	@ContractGuid
	
	
	--    
	insert into [#CheckLatePayment_tmp_CashValue]
	Select
		[Guid],
		[ContractGuid],
		[value]
	From
		[vwLandContractCachPayment]
	where
		ContractGuid = 	@ContractGuid


	--  
	Delete #CheckLatePayment_tmp_CashValue
	From
		#CheckLatePayment_tmp_CashValue C
		inner join HEntry H on H.Guid = C.Guid
	where
		H.ParentKind in (1600, 1660, 1661, 1662, 1663, 1664, 1670)
		
	Select
		ContractGuid,
		SUM(Value) as CashValue
	into #CheckLatePayment_CashValue
	From	
		#CheckLatePayment_tmp_CashValue
	Group By
		[ContractGuid]
		
	--Select * from #CheckLatePayment_CashValue
	
	--  
	Select 
		Sum([K].[Value]) as [ColleactionValue],
		[K].[ContractGuid]
	into #CheckLatePayment_ColleactionValue
	From
		[Checks] [K] 
		inner Join [ChecksCollection] [L] on [L].[CheckGuid] = [K].[Guid] and  Kind = 1
	where
		ContractGuid = 	@ContractGuid
	Group By
		[K].[ContractGuid]	

	--   
	Select 
		Min(K.dueDate) as [MinDate],
		Max(K.dueDate) as [MaxDate],
		Sum([K].[Value]) as [SumBehind],
		COUNT(K.Number) as [Count],
		[K].[ContractGuid]
	into #CheckLatePayment_R1
	From 
		[Checks] [K] 
		left Join [ChecksCollection] [L] on [L].[CheckGuid] = [K].[Guid] and  Kind = 1
	where
		[K].[DueDate] <= @DeservedDate  --GetDate() -  @LateDay
		and ([L].[CheckGuid] is null)
		and ([K].[ContractGuid] = @ContractGuid or @ContractGuid = 0x0)		
	Group By
		[K].[ContractGuid]	
		

		
	Select 
		Sum([L].[Value]) as [SumCollector],
		[K].[ContractGuid]
	into #CheckLatePayment_R2
	From 
		[ChecksPartialCollection]  [L]
		inner join [Checks] [K] on [L].[CheckGuid] = [K].[Guid]
	where
		([K].[ContractGuid] = @ContractGuid or @ContractGuid = 0x0)		
	Group By
		[K].[ContractGuid]	
		
	--    	
	Select 
		K.Guid as [CheckGuid],
		SUM(L.Value) as [CollValue]
	into #CheckLatePayment_RCollPValue
	From 
		[ChecksPartialCollection]  [L]
		inner join [Checks] [K] on [L].[CheckGuid] = [K].[Guid]
	where
		([K].[DueDate] <= @Date1)
		and ([K].[ContractGuid] = @ContractGuid or @ContractGuid = 0x0)				
	Group By
		K.Guid
	
	Select 
		Sum([K].[Value]) - isNull(Sum([L].[CollValue]),0) as SumDeservedPartial,
		[K].[ContractGuid]
	into #CheckLatePayment_R3
	From 
		#CheckLatePayment_RCollPValue  [L]
		inner join [Checks] [K] on [L].[CheckGuid] = [K].[Guid]
	where
		([K].[DueDate] <= @Date1)
		and ([K].[ContractGuid] = @ContractGuid or @ContractGuid = 0x0)				
	Group By
		[K].[ContractGuid]	
			
	--  
	Select 
		Sum([K].[Value]) as [SumDeserved],
		[K].[ContractGuid]
	into #CheckLatePayment_Deserved
	From 
		[Checks] [K] 
		left Join [ChecksCollection] [L] on [L].[CheckGuid] = [K].[Guid] and  L.Kind = 1
		left Join [ChecksCollection] [R] on [R].[CheckGuid] = [K].[Guid] and  R.Kind = 3
		left Join [ChecksPartialCollection] [PL] on [PL].[CheckGuid] = [K].[Guid] --and  Kind = 1
	where
		([K].[DueDate] <= @Date1)
		--and ([K].[DueDate] > @DeservedDate)
		and ([L].[CheckGuid] is null)
		and ([PL].[CheckGuid] is null)
		and ([K].[ContractGuid] = @ContractGuid or @ContractGuid = 0x0)	
		and ([R].[CheckGuid] is Null or @WithoutReturnCheck = 0)
		and ([K].NoneDueDate = 0 or @CheckNonDueDate = 0)
	Group By
		[K].[ContractGuid]	--,[R].[CheckGuid]
		
		
	--Select * from #CheckLatePayment_Deserved
	--where 
	--	ContractGuid = (Select Guid From LeaseApartment where Number = 543)
		
		
	--Select * from #CheckLatePayment_Deserved
					
	Create Table #Res
	(
		[ContractName] Varchar(256),
		[CustName] Varchar(256),
		[ContractNo] Varchar(256),
		[ContractGuid] uniqueidentifier,
		[Value] Float,
		[LastDate] DateTime,
		[LastValue]Float,
		[CashValue] Float,
		[SumCollector]Float,
		[SumCollectorPartial] Float,
		[SumDeservedPartial] Float,
		[SumDeserved]Float,
		[LastDeservedDate]DateTime,
		[SumBehind] Float,
		[MinDate] datetime,
		[MaxDate] datetime,
		[CountBehind] int,
		[TotalCheckCollector] Float,
		[FloorNo] Varchar(256),
		[FlatNo] Varchar(256),
		[BuildingName] Varchar(256),
		[BuildingGuid] uniqueidentifier
	)
	
	insert into #Res
	Select 
		[C].[TypeName],
		[C].[CustName],
		[C].[ContractNo],
		[C].[Guid],
		isNull([C].[Value],0),
		[L].[LastDate],
		isNull([L2].[LastValue],0),
		isNull([CashValue],0) as [CashValue],
		isNull([CashValue],0) + isNull([PL3].[SumCollector],0) as  [SumCollector],
		isNull([PL3].[SumCollector],0) as SumCollectorPartial,
		isNull([PL33].SumDeservedPartial,0) as SumDeservedPartial,
		isNull([L4].[SumDeserved],0) ,
		[L5].[LastDeservedDate],
		isNull([L6].[SumBehind],0) - isNull([PL3].[SumCollector],0),
		[l6].[MinDate],
		[l6].[MaxDate],
		[L6].[count] as [CountBehind],
		isNull([cc].[ColleactionValue],0) as [TotalCheckCollector],
		[C].[FloorNo],
		[C].[FlatNo],
		[C].[BuildingName],
		[C].[BuildingGuid] 
	From 
		[vwAllContract] [C] 
		left join #CheckLatePayment_CashValue CV on Cv.ContractGuid = C.Guid
		left join #CheckLatePayment_ColleactionValue CC on CC.ContractGuid = C.Guid
		--  
		left join (
					Select 
						Max([L].[Date]) [LastDate],
						[K].[ContractGuid]
					From 
						[ChecksCollection]  [L]
						inner join [Checks] [K] on [L].[CheckGuid] = [K].[Guid]
					where Kind = 1
					Group By
						[K].[ContractGuid]	
					) [L] On [L].[ContractGuid] = [C].[Guid]
		--  
		left join (
					Select 
						[L].[Value] as [LastValue],
						[K].[ContractGuid]
					From 
						[ChecksCollection]  [L]
						inner join [Checks] [K] on [L].[CheckGuid] = [K].[Guid]
					where Kind = 1
					and
						[L].[Date] = (
										Select 
											Max([LL].[Date]) [LastDate]
										From 
											[ChecksCollection]  [LL]
											inner join [Checks] [KK] on [LL].[CheckGuid] = [KK].[Guid]
										where Kind = 1
										and [KK].[ContractGuid] = [K].[ContractGuid]
										)
					) [L2] On [L2].[ContractGuid] = [C].[Guid]
		
		--   
		left join #CheckLatePayment_R2 [PL3] On [PL3].[ContractGuid] = [C].[Guid]
		--   
		left join #CheckLatePayment_R3 [PL33] On [PL33].[ContractGuid] = [C].[Guid]
		--   
		left join #CheckLatePayment_Deserved [L4] On [L4].[ContractGuid] = [C].[Guid]
		--    
		left join (
					Select
						Max([K].[DueDate]) as [LastDeservedDate],
						[K].[ContractGuid]
					From 
						[Checks] [K] 
						left Join [ChecksCollection] [L] on [L].[CheckGuid] = [K].[Guid] and  Kind = 1
					where
						([K].[DueDate] < = @Date2 or @Date2 = 0 or @Date2 = 2)
						and ([L].[CheckGuid] is null)
					Group By
						[K].[ContractGuid]	
					) [L5] On [L5].[ContractGuid] = [C].[Guid]
		--   
		left join #CheckLatePayment_R1 [L6] On [L6].[ContractGuid] = [C].[Guid]
		inner join [Resource] [RS] on [RS].[Guid] = [C].[TypeGuid] and [RS].[Spid] = @@Spid and [RS].[Kind] = 3001
		--inner join [Resource] [RS2] on [RS2].[Guid] = [C].[BuildingGuid] and [RS2].[Spid] = @@Spid and [RS2].[Kind] = 4001
	where
		([C].[CustAcGuid] = @AcGuid or @AcGuid = 0x0)
		and ([C].[Guid] = @ContractGuid or @ContractGuid = 0x0)
		

	Delete #Res where isNull([SumBehind] ,0) = 0
	
	-- 
	if @ActiveBuildingList = 1
	begin
		Delete #Res
		From
			#Res [L]
			left join [Resource] [R] on [R].[Guid] = [L].[BuildingGuid] and [R].[Kind] = 4001 and [R].[Spid] = @@Spid 
		where
			[R].[Guid] Is Null
			and L.BuildingGuid <> 0x0
			and ([ContractGuid] is not Null )
	end
		

	Select 
		*, 
		isNull([SumDeserved],0) + isnull([SumDeservedPartial],0) as [SumDeservedPay]
	From 
		#Res
		
	Select
		Sum([Value]) as [Value],
		Sum([CashValue]) as [CashValue],
		Sum([SumCollector]) as SumCollector,
		Sum(SumDeserved) as SumDeserved,
		Sum([SumBehind]) as [SumBehind],
		Sum(isNull([SumDeserved],0) + isnull([SumDeservedPartial],0)) as [SumDeservedPay],
		SUM([TotalCheckCollector]) as [TotalCheckCollector],
		Sum(SumDeservedPartial) as SumDeservedPartial,
		Sum(SumCollectorPartial) as SumCollectorPartial
	From
		#Res

GO

SET ANSI_NULLS, QUOTED_IDENTIFIER ON
GO

Create Procedure [PrcPrintReceiptMaintenanceContract]
(
	@Guid uniqueidentifier = '44BAA61B-A0A7-43B5-B07B-299242BD419B',
	@Only Varchar(256) = '',
	@OnlyAr Varchar(256) = '',
	@OnlyEn Varchar(256) = '',	
	@OnlySumCheckAr Varchar(256) = '',	
	@OnlySumChecken Varchar(256) = '',	
	@OnlySumCashAr Varchar(256) = '',	
    @OnlySumCashEn Varchar(256) = '',
    @PrintCheckEnryOnly bit = 0
	
)
 
as
	Set NoCount On
	
	--  
	Declare @SumCheck Float, @SumCach Float, @SumPay Float
	
	Select
		@SumCheck = Sum([Value])
	From
		[LinkCheckContract] [C]
		inner join (Select Distinct Guid From [Resource] where [Spid] = @@Spid) [R] on [R].[Guid] = [C].ParentGuid
	where
		[ContractGuid] = @Guid

	Select
		@SumCach = isnull(Sum([Value] * [CurrencyVal]),0)
	From
		vwMaintenanceContractCachPayment [C]
		inner join (Select Distinct Guid From [Resource] where [Spid] = @@Spid) [R] on [R].[Guid] = [C].[Guid]
	where
		[ContractGuid] = @Guid

	Set @SumPay = ISNULL(@SumCheck,0) + ISNULL(@SumCach,0)

	if @PrintCheckEnryOnly = 0
	begin
		
		/*
		Select 
			@SumPay = @SumPay + IsNull(OtherFee,0) + IsNull(InsuranceValue,0) + IsNull(CertificatValue,0)
		From
			[vwLeaseApartment]
		where 
			([Guid] = @Guid or @Guid = 0x0)		
		*/
		
		Select
			[A].[Number],
			[A].[ContractNo],
			
			[A].[CustName],
			[A].[CustArName],
			[A].[CustLtnName],
			[A].[CustomerPhonejob],
			[A].[CustomerMobile],
			[A].[CustomerNationality],
			
			[cu].[Barcode] as [Cust_Barcode], 			[cu].[Name] as [Cust_Name], 			[cu].[LtnName] as [Cust_LtnName], 			[cu].[CardKind] as [Cust_CardKind], 			[cu].[CardKind2] as [Cust_CardKind2], 			[cu].[Nationality] as [Cust_Nationality], 			[cu].[LtnNationality] as [Cust_LtnNationality], 			[cu].[Profession] as [Cust_Profession], 			[cu].[LtnProfession] as [Cust_LtnProfession], 			[cu].[PassportNO] as [Cust_PassportNO], 			[cu].[PassportExpireDate] as [Cust_PassportExpireDate], 			[cu].[Domicile] as [Cust_Domicile], 			[cu].[Security] as [Cust_Security], 			[cu].[LtnSecurity] as [Cust_LtnSecurity], 			[cu].[PhoneJob] as [Cust_PhoneJob], 			[cu].[Mobile] as [Cust_Mobile], 			[cu].[Note] as [Cust_Note], 			[cu].[Trademark] as [Cust_Trademark], 			[cu].[LtnTrademark] as [Cust_LtnTrademark], 			[cu].[MemoSecurity] as [Cust_MemoSecurity], 			[cu].[LtnMemoSecurity] as [Cust_LtnMemoSecurity], 			[cu].[Address] as [Cust_Address], 			[cu].[LtnAddress] as [Cust_LtnAddress], 			[cu].[BoxNo] as [Cust_BoxNo], 			[cu].[PersonalityNo1] as [Cust_PersonalityNo1], 			[cu].[PersonalityNo2] as [Cust_PersonalityNo2], 			[cu].[Fax] as [Cust_Fax], 			[cu].[EMail] as [Cust_EMail], 			[cu].[Adjective] as [Cust_Adjective], 			[cu].[LtnAdjective] as [Cust_LtnAdjective], 			[cu].[CkHideInSearch] as [Cust_CkHideInSearch], 			[cu].[ban] as [Cust_ban], 			[cu].[BankName] as [Cust_BankName], 			[cu].[BankAccCode] as [Cust_BankAccCode], 			[cu].[Birthday] as [Cust_Birthday], 			[cu].[DomicileEndDate] as [Cust_DomicileEndDate], 			[cu].[PersonalityEndDate] as [Cust_PersonalityEndDate], 			[cu].[CustNote1] as [Cust_CustNote1], 			[cu].[CustNote2] as [Cust_CustNote2], 			[cu].[CustNote3] as [Cust_CustNote3], 			[cu].[CustNote4] as [Cust_CustNote4], 			[cu].[CustNote5] as [Cust_CustNote5], 			[cu].[CustNote6] as [Cust_CustNote6], 			[cu].[CustNote7] as [Cust_CustNote7], 			[cu].[banContract] as [Cust_banContract], 
			
			@SumCheck as [SumCheck],
			@SumCach as [SumCach],
			@SumPay as [SumPay], 
			@Only as [OnlySumCheck], 
			@OnlyAr as [OnlySumCheckAr], 
			@OnlyEn as [OnlySumCheckEn], 

			@OnlySumCheckAr as OnlySumCheckAr,
			@OnlySumChecken as OnlySumChecken,
			@OnlySumCashAr as OnlySumCashAr,
			@OnlySumCashEn AS OnlySumCashEn,

			[A].[EditDate],
			[A].[FromDate],
			[A].[ToDate],
			--[A].[BuildingName],
			--[A].[BuildingArName],
			--[A].[BuildingLtnName],
			[A].[Note2],

			[A].[Rent] as [ContractValue],

			[A].[DiscountPercent],
			[A].[DiscountValue],
			[A].[Rent] - [A].[DiscountValue] as [RentAfterDiscount],	

			[A].[MonthlyValue] ,
			[A].[MonthlyValue] * 12.00 as [YearValue],
			[A].[CurrencyName],
			[A].[DiscountPercent],
			[A].[DiscountValue],
			[A].[OtherFee],
			[A].[NewStateStr], --  
			A.Purpose,
			A.Trademark,
			A.whereabouts,
			A.RentDuration,
			A.LtnRentDuration,
			A.Rentype,
			A.LtnRentype,
			A.TermsOfPayment,
			A.LtnTermsOfPayment,
			
			Case when isnull([A].NewState,0) = 0 then dbo.sc('') else dbo.sc('') end as [NewSate],
			Case when isnull([A].NewState,0) = 0 then '' else '' end as [ArNewSate],
			Case when isnull([A].NewState,0) = 0 then 'New' else 'Renewal' end as [LtnNewSate]
		From 
			vwMaintenanceContract A
			inner join Customer Cu on Cu.Guid = A.CustomerGuid
		where 
			([A].[Guid] = @Guid or @Guid = 0x0)
	end

	Create Table [#Tbl]
	(
		[Number] int,
		[BankName] Varchar(256),
		[Value] Float,
		[Currency] Varchar(256),
		[No]  Varchar(256),
		[EditDate] DateTime,
		[DueDate] DateTime,
		[State] Varchar(256),
		[Note3] Varchar(256),
		[Note] Varchar(256)
	)

	Insert Into [#Tbl]
	Select
		P.Number,
		[BankName],
		[LL].[Value] as [Value],
		[CurrencyName]  as [Currency],
		[No],
		P.Date as [EditDate],
		[DueDate],
		Case 		
			when  [C3].[CheckGuid] is not null then dbo.SC('')
			when  [C1].[CheckGuid] is not null then dbo.SC('') 
			when  [C4].[CheckGuid] is not null then dbo.SC(' ') 
			when  [C].[CheckGuid] is not null then dbo.SC('') 
			when  [C2].[CheckGuid] is not null then dbo.SC('') 
		end as [State],
		[P].[Note3],
		[P].[Note]
	From
		[vwChecks] [P]
		inner join [LinkCheckContract] LL on LL.ParentGuid = P.Guid
 		left join [vwChecksCollection] [C] on [C].[CheckGuid] = [P].[Guid] and [C].[Kind] = 0
 		left join [vwChecksCollection] [C1] on [C1].[CheckGuid] = [P].[Guid] and [C1].[Kind] = 1
 		left join [vwChecksCollection] [C2] on [C2].[CheckGuid] = [P].[Guid] and [C2].[Kind] = 2
 		left join [vwChecksCollection] [C3] on [C3].[CheckGuid] = [P].[Guid] and [C3].[Kind] = 3
 		left join [ChecksPartialCollection]  [C4] on [C4].[CheckGuid] = [P].[Guid] and [C3].[Kind] = 3
		inner join (Select Distinct Guid From [Resource] where [Spid] = @@Spid) [R] on [R].[Guid] = [P].[Guid]
	where
		LL.[ContractGuid] = @Guid


	Select * from [#Tbl]
	Order By
		[DueDate], [No]

	Select
		C.Number,
		C.[RecieptVoucherNumber],
		C.SNumber,
		dbo.sc('') as [BankName],
		[Value]  as [Value],
		[Currency]  as [Currency],
		'' as [No],
		[Date],
		'' as State,
		[C].[HNote],
		[C].[DNote]
	From
		vwMaintenanceContractCachPayment [C]
		inner join (Select Distinct Guid From [Resource] where [Spid] = @@Spid) [R] on [R].[Guid] = [C].[Guid] 
	where
		[ContractGuid] = @Guid
	Order By
		[Number],[DNumber]


GO

SET ANSI_NULLS, QUOTED_IDENTIFIER ON
GO

Create Procedure [PrcPrintCheckCustom]
(
	@FlatGuid UniqueIdentifier = 0x0,
	@ShopGuid UniqueIdentifier = 0x0,
	@ParkingGuid UniqueIdentifier = 0x0
)
 
as
	Set NoCount On

	Declare @Check Bit,
			@NotCheck Bit
	Set @Check = 1
	Set @NotCheck = 0


	Create 	Table #R
	(
		[Number] int,
		[ReceiptNo] Float,
		[TypeName] Varchar(256),
		[IsPosted]Varchar(256),
		[IsCollection]Varchar(256),
		[IsEndorsement]Varchar(256),
		[IsReturned]Varchar(256),

		[CollectionValue] Float,		
		[RestValue] Float,		

		[PostedDate] Datetime,
		[CollectionDate] Datetime,
		[EndorsementDate] Datetime,
		[ReturnedDate] Datetime,
		[ReturnFine] Float,

		[AccountCode]Varchar(256),
		[AccountName]Varchar(256),
		[AccountNameAr]Varchar(256),
		[AccountNameLtn]Varchar(256),
		[No] bigint,
		[Value] Float,
		[Date] DateTime,
		[DueDate] DateTime,
		[BankName]Varchar(256),
		[Note] Varchar(256),
		[Note3] Varchar(256),
		[BuildingName] Varchar(256),
		[BuildingLtnName] Varchar(256),

		[ContractNo] Varchar(256),
		[RentAfterDiscount] Float,
		[Contract_FromDate] Datetime,
		[Contract_ToDate] Datetime,

		[FlatNo] Varchar(256),
		[FloorNo] Varchar(256),
		[Check] Bit,
		[checkkind] int,
		[Guid] UniqueIdentifier,

		[Emirate] Varchar(256),
		[BuildingArea] Varchar(256),
		[Suburb] Varchar(256),
		[Street] Varchar(256),
		[BasinNo] Varchar(256),
		[PieceNo] Varchar(256),
		[BuildingNo] Varchar(256),
		[BondType] Varchar(256),
		[BondNo] Varchar(256),
		[FlatKind] Varchar(256),
		[ApartmentType] Varchar(256),
		[Class] Varchar(256),
		[FlatArea] Varchar(256),
		[FlatAreaunity] Varchar(256),
		[CustomerPhonejob]  Varchar(256),
		[CustomerMobile] Varchar(256),
		[CustomerNationality] Varchar(256),
		[EntryNo] int,
		[Tag] int
	)


	if @ParkingGuid = 0x0 and  @FlatGuid = 0x0 and @ShopGuid = 0x0
	Insert into #R
	Select 
		[P].[Number],
		[P].[ReceiptNo],
		[P].[TypeName],

		Case when [C].[CheckGuid] is null then '' else dbo.SC('') end as [IsPosted],
		Case when [C1].[CheckGuid] is null then '' else dbo.SC('') end as [IsCollection],
		Case when [C2].[CheckGuid] is null then '' else dbo.SC('') end as [IsEndorsement],
		Case when [C3].[CheckGuid] is null then '' else dbo.SC('') end as [IsReturned],

		0 as [CollectionValue],
		0 as [RestValue],		

		[C].[Date] as [PostedDate],
		[C1].[Date] as [CollectionDate],
		[C2].[Date] as [EndorsementDate],
		[C3].[Date] as [ReturnedDate],
		[C3].[Delay] as [ReturnFine],

		[P].[AccountCode],
		[P].[AccountName],
		[P].[AccountNameAr],
		[P].[AccountNameLtn]

		,[P].[No]
		,[P].[Value]
		,[P].[Date]
		,[P].[DueDate]
		,[P].[BankName]
		,[P].[Note]
		,[P].[Note3]
		,'' as [BuildingName]
		,'' as [BuildingLtnName]
		,'' as [ContractNo]
		,0 as [RentAfterDiscount]
		,Null as [Contract_FromDate]
		,Null as [Contract_ToDate]
		,'' as [FlatNo]
		,'' as  [FloorNo]
		,Case when [R].[ObjGuid] is null then ( @NotCheck )
			 when [R].[ObjGuid] is not null  then @Check end as [Check]
		,[checkkind]
		,[P].[Guid]

		,'' as [Emirate]
		,'' as [BuildingArea]
		,'' as [Suburb]
		,'' as [Street]
		,'' as [BasinNo]
		,'' as [PieceNo]
		,'' as [BuildingNo]
		,'' as [BondType]
		,'' as [BondNo]
		,'' as [FlatKind]
		,'' as [ApartmentType]
		,'' as [Class]
		,'' as [FlatArea]
		,'' as [FlatAreaunity]
		,'' as [CustomerPhonejob]
		,'' as [CustomerMobile]
		,'' as [CustomerNationality]
		,0 as [EntryNo]
		,RS.Tag 
	From
		[vwChecks] [P]
		left join [RepCheck] [R] on [R].[ObjGuid] = [P].[Guid] and [R].[IdReport] = 3000
		inner join [Resource] [RS] on [RS].[Guid] = [P].[Guid]   and [RS].[Spid] = @@Spid and [RS].[Kind] = 3000
		left join [vwChecksCollection] [C] on [C].[CheckGuid] = [P].[Guid] and [C].[Kind] = 0
		left join [vwChecksCollection] [C1] on [C1].[CheckGuid] = [P].[Guid] and [C1].[Kind] = 1
		left join [vwChecksCollection] [C2] on [C2].[CheckGuid] = [P].[Guid] and [C2].[Kind] = 2
		left join [vwChecksCollection] [C3] on [C3].[CheckGuid] = [P].[Guid] and [C3].[Kind] = 3
	where
		([P].[ContractGuid] is null)

	if @ParkingGuid = 0x0 and  @FlatGuid = 0x0 and @ShopGuid = 0x0
	Insert into #R
	Select 
		[P].[Number],
		[P].[ReceiptNo],
		[P].[TypeName],

		Case when [C].[CheckGuid] is null then '' else dbo.SC('') end as [IsPosted],
		Case when [C1].[CheckGuid] is null then '' else dbo.SC('') end as [IsCollection],
		Case when [C2].[CheckGuid] is null then '' else dbo.SC('') end as [IsEndorsement],
		Case when [C3].[CheckGuid] is null then '' else dbo.SC('') end as [IsReturned],

		0 as [CollectionValue],
		0 as [RestValue],		

		[C].[Date] as [PostedDate],
		[C1].[Date] as [CollectionDate],
		[C2].[Date] as [EndorsementDate],
		[C3].[Date] as [ReturnedDate],
		[C3].[Delay] as [ReturnFine],

		[P].[AccountCode],
		[P].[AccountName],
		[P].[AccountNameAr],
		[P].[AccountNameLtn]

		,[P].[No]
		,[P].[Value]
		,[P].[Date]
		,[P].[DueDate]
		,[P].[BankName]
		,[P].[Note]
		,[P].[Note3]
		,'' as [BuildingName]
		,'' as [BuildingLtnName]
		,[L].[ContractNo]
		,[L].[Rent] as [RentAfterDiscount]
		,[L].[FromDate] as [Contract_FromDate]
		,[L].[ToDate] as [Contract_ToDate]
		,[L].[Name] as [FlatNo]
		,'' as [FloorNo]
		,Case when [R].[ObjGuid] is null then ( @NotCheck )
			 when [R].[ObjGuid] is not null  then @Check end as [Check]
		,[checkkind]
		,[P].[Guid]

		,'' as [Emirate]
		,'' as [BuildingArea]
		,'' as [Suburb]
		,'' as [Street]
		,'' as [BasinNo]
		,'' as [PieceNo]
		,'' as [BuildingNo]
		,'' as [BondType]
		,'' as [BondNo]
		,Case when [ContractKind] = 6 or [ContractKind] = 7 then dbo.SC('')
		 when [ContractKind] = 8 or [ContractKind] = 9 then dbo.SC('')
		end 
		as [FlatKind]
		,'' as [ApartmentType]
		,'' as [Class]
		,'' as [FlatArea]
		,'' as [FlatAreaunity]
		,[L].[CustomerPhonejob]
		,[L].[CustomerMobile]
		,L.[CustomerNationality]
		,0 as [EntryNo]
		,RS.Tag 
	From
		[vwChecks] [P]
		inner join [vwLandContract] [L] on [L].[Guid] = [P].[ContractGuid]
		left join [RepCheck] [R] on [R].[ObjGuid] = [P].[Guid] and [R].[IdReport] = 3000
		inner join [Resource] [RS] on [RS].[Guid] = [P].[Guid]  and [RS].[Spid] = @@Spid and [RS].[Kind] = 3000
		left join [vwChecksCollection] [C] on [C].[CheckGuid] = [P].[Guid] and [C].[Kind] = 0
		left join [vwChecksCollection] [C1] on [C1].[CheckGuid] = [P].[Guid] and [C1].[Kind] = 1
		left join [vwChecksCollection] [C2] on [C2].[CheckGuid] = [P].[Guid] and [C2].[Kind] = 2
		left join [vwChecksCollection] [C3] on [C3].[CheckGuid] = [P].[Guid] and [C3].[Kind] = 3
		
	if (@ParkingGuid = 0x0) --and Not (@FlatGuid = 0x0 and @ShopGuid = 0x0)
	Insert into #R
	Select 
		[P].[Number],
		[P].[ReceiptNo],
		[P].[TypeName],

		Case when [C].[CheckGuid] is null then '' else dbo.SC('') end as [IsPosted],
		Case when [C1].[CheckGuid] is null then '' else dbo.SC('') end as [IsCollection],
		Case when [C2].[CheckGuid] is null then '' else dbo.SC('') end as [IsEndorsement],
		Case when [C3].[CheckGuid] is null then '' else dbo.SC('') end as [IsReturned],

		0 as [CollectionValue],
		0 as [RestValue],		

		[C].[Date] as [PostedDate],
		[C1].[Date] as [CollectionDate],
		[C2].[Date] as [EndorsementDate],
		[C3].[Date] as [ReturnedDate],
		[C3].[Delay] as [ReturnFine],

		[P].[AccountCode],
		[P].[AccountName],
		[P].[AccountNameAr],
		[P].[AccountNameLtn]

		,[P].[No]
		,[P].[Value]
		,[P].[Date]
		,[P].[DueDate]
		,[P].[BankName]
		,[P].[Note]
		,[P].[Note3]
		,[L].[BuildingName]
		,[L].[BuildingLtnName]
		,[L].[ContractNo]
		,L.[RentAfterDiscount]
		,[L].[FromDate] as [Contract_FromDate]
		,[L].[ToDate] as [Contract_ToDate]
		,[L].[FlatNo]
		,[L].[FloorNo]
		,Case when [R].[ObjGuid] is null then ( @NotCheck )
			 when [R].[ObjGuid] is not null  then @Check end as [Check]
		,[checkkind]
		,[P].[Guid]

		,[L].[Emirate]
		,[L].[BuildingArea]
		,[L].[Suburb]
		,[L].[Street]
		,[L].[BasinNo]
		,[L].[PieceNo]
		,[L].[BuildingNo]
		,[L].[BondType]
		,[L].[BondNo]
		,[L].[FlatKind]
		,[L].[ApartmentType]
		,[L].[Class]
		,[L].[FlatArea]
		,[L].[FlatAreaunity]
		,[L].[CustomerPhonejob]
		,[L].[CustomerMobile]
		,L.[CustomerNationality]
		,0 as [EntryNo]
		,RS.Tag 
	From
		[vwChecks] [P]
		inner join [vwLeaseApartment] [L] on [L].[Guid] = [P].[ContractGuid]
		left join [RepCheck] [R] on [R].[ObjGuid] = [P].[Guid] and [R].[IdReport] = 3000
		inner join [Resource] [RS] on [RS].[Guid] = [P].[Guid]  and [RS].[Spid] = @@Spid and [RS].[Kind] = 3000
		left join [vwChecksCollection] [C] on [C].[CheckGuid] = [P].[Guid] and [C].[Kind] = 0
		left join [vwChecksCollection] [C1] on [C1].[CheckGuid] = [P].[Guid] and [C1].[Kind] = 1
		left join [vwChecksCollection] [C2] on [C2].[CheckGuid] = [P].[Guid] and [C2].[Kind] = 2
		left join [vwChecksCollection] [C3] on [C3].[CheckGuid] = [P].[Guid] and [C3].[Kind] = 3


	if (@FlatGuid = 0x0 and @ShopGuid = 0x0) --and @ParkingGuid <> 0x0
	Insert into #R
	Select 
		[P].[Number],
		[P].[ReceiptNo],
		[P].[TypeName],

		Case when [C].[CheckGuid] is null then '' else dbo.SC('') end as [IsPosted],
		Case when [C1].[CheckGuid] is null then '' else dbo.SC('') end as [IsCollection],
		Case when [C2].[CheckGuid] is null then '' else dbo.SC('') end as [IsEndorsement],
		Case when [C3].[CheckGuid] is null then '' else dbo.SC('') end as [IsReturned],

		0 as [CollectionValue],
		0 as [RestValue],		

		[C].[Date] as [PostedDate],
		[C1].[Date] as [CollectionDate],
		[C2].[Date] as [EndorsementDate],
		[C3].[Date] as [ReturnedDate],
		[C3].[Delay] as [ReturnFine],

		[Ac].[Code] as [AccountCode],
		[Ac].[Name] as [AccountName],
		[Ac].[ArName] as [AccountNameAr],
		[Ac].[LtnName] as [AccountNameLtn]

		,[P].[No]
		,[P].[Value]
		,[P].[Date]
		,[P].[DueDate]
		,[P].[BankName]
		,[P].[Note]
		,[P].[Note3]
		,[L].[BuildingName]
		,[L].[BuildingLtnName]
		,[L].[ContractNo]
		,L.[Rent]
		,[L].[FromDate] as [Contract_FromDate]
		,[L].[ToDate] as [Contract_ToDate]

		,[L].[PNo]
		,'' as [FloorNo]
		,Case when [R].[ObjGuid] is null then ( @NotCheck )
			 when [R].[ObjGuid] is not null  then @Check end as [Check],
		[checkkind],	
		[P].[Guid]

		,[L].[Emirate]
		,[L].[BuildingArea]
		,[L].[Suburb]
		,[L].[Street]
		,[L].[BasinNo]
		,[L].[PieceNo]
		,[L].[BuildingNo]
		,[L].[BondType]
		,[L].[BondNo]
		,'' as [FlatKind]
		,'' as [ApartmentType]
		,[L].[Class]
		,[L].[FlatArea]
		,[L].[FlatAreaunity]
		,[L].[CustomerPhonejob]
		,[L].[CustomerMobile]
		,L.[CustomerNationality]
		,0 as [EntryNo]
		,RS.Tag 
	From
		[vwChecks] [P]
		Inner Join [vwAccount] [Ac] On [P].[Account] = [Ac].[Guid]
		inner join (
					Select [LL].*, 
							--[B].[Emirate],
							[B].[Area] as [BuildingArea],
							[B].[Suburb],
							[B].[Street],
							[B].[BasinNo],
							[B].[PieceNo],
							[B].[BuildingNo],
							[B].[BondType],
							[B].[BondNo],
							'' as [Class],
							[F].[Area] as [FlatArea],
							[F].[unity] as [FlatAreaunity]
					From
						[vwParkingContract] [LL]
						inner join [Building] [B] on [B].[Guid] = [LL].[BuildingGuid]
						inner join [Parking] [F] on [F].[Guid] = [LL].[ParkingGuid]
			)[L] on [L].[Guid] = [P].[ContractGuid]
		left join [RepCheck] [R] on [R].[ObjGuid] = [P].[Guid] and [R].[IdReport] = 3000
		inner join [Resource] [RS] on [RS].[Guid] = [P].[Guid]   and [RS].[Spid] = @@Spid and [RS].[Kind] = 3000
		left join [vwChecksCollection] [C] on [C].[CheckGuid] = [P].[Guid] and [C].[Kind] = 0
		left join [vwChecksCollection] [C1] on [C1].[CheckGuid] = [P].[Guid] and [C1].[Kind] = 1
		left join [vwChecksCollection] [C2] on [C2].[CheckGuid] = [P].[Guid] and [C2].[Kind] = 2
		left join [vwChecksCollection] [C3] on [C3].[CheckGuid] = [P].[Guid] and [C3].[Kind] = 3


	--  
	UpDate #R Set EntryNo = [L].[EntryNum] 
	From
		#R R
		inner join [LinkEntry_Checks] L on l.CheckGuid = R.Guid


	--  
	Update
		#R
	Set IsCollection = dbo.SC(' '),
		[CollectionValue] = [C].[Value],
		[RestValue] = [R].[Value] - [C].[Value]
	From
		#R [R]
		inner join (
						Select 
							[CheckGuid],
							Sum([Value]) as [Value] 
						From
							[ChecksPartialCollection] 
						Group By
							[CheckGuid]
					) [C] on [C].[CheckGuid] = [R].[Guid]


	Create Table [#TblId]
	(
		[Guid] Uniqueidentifier,
		[Id] int Identity(1,1)
	)
	
	Insert into #TblId
	([Guid])
	Select [Guid] From #R
	Order By [Tag],[ReceiptNo],[dueDate], [No]

	Alter Table #R Add [Id] int

	Declare @MaxReceiptNo Float
	Set @MaxReceiptNo = (Select isNull(Max([ReceiptNo]),0) From [Checks] )

	--   
	UpDate #R Set [ReceiptNo] = @MaxReceiptNo + [T].[Id]
	From
		#R [R]
		inner join [#TblId] [T] on [T].[Guid] = [R].[Guid]
	where
		isnull([ReceiptNo],0) = 0

	--    
	UpDate [Checks] Set [ReceiptNo] = @MaxReceiptNo + [T].[Id]
	From
		[Checks] [R]
		inner join [#TblId] [T] on [T].[Guid] = [R].[Guid]
	where
		isnull([ReceiptNo],0) = 0

	Select 
		[R].*,
		[O].[Only],
		[O].[LtnOnly],
		0 As [OPeration] 
	From 
		#R [R]
		inner join [OnlyCheck] [O] on [O].[Guid] = [R].[Guid]   and [O].[Spid] = @@Spid
 	Order By 
 		Tag, [dueDate], [No], ReceiptNo


	/*
	-- Res2
	Select
		[TypeName],
		Case when [IsPosted] = '' and [IsCollection] = ''
				and ([IsEndorsement] = '') and [IsReturned] = '' then Count(*) end as [IsNotPosted],

		Case when 
					([IsPosted] <> '') and ([IsReturned] = '') 
		then Count(*) end as [IsPosted],

		Case when ([IsCollection] <> '') and ([IsPosted] = '') and ([IsReturned] = '') 
				and([IsEndorsement] = '')	
		then Count(*) end as [IsCollection],

		Case when ([IsEndorsement] <> '') and ([IsReturned] = '') 
		then Count(*) end as [IsEndorsement],

		Case when [IsReturned] <> '' 
		then Count(*) end as [IsReturned],

		Sum([Value]) as [Total],
		[checkkind]
	into #G
	From
		#R
	Group By
		[TypeName],[Number],[checkkind],[IsPosted], [IsCollection], [IsEndorsement], [IsReturned]
		
	Select
		[TypeName],
		Sum([IsNotPosted]) as [IsNotPosted],
		Sum([IsPosted]) as [IsPosted],
		Sum([IsCollection]) as [IsCollection],
		Sum([IsEndorsement]) as [IsEndorsement],
		Sum([IsReturned]) as [IsReturned],
		isnull(Sum([IsNotPosted]),0)+isnull(Sum([IsPosted]),0) + isnull(Sum([IsCollection]),0) +	isnull(Sum([IsEndorsement]),0) +	isnull(Sum([IsReturned]),0) as [All],
		Sum([Total]) as [Total],
		Sum([Total]) * Case when [checkkind] = 0 then 1 else -1 end as [RTotal],
		0 as [Sort]
	Into #G2
	From
		#G
	Group By
		[TypeName], [checkkind]
	
	Insert into #G2
	Select
		dbo.SC('') as [TypeName],
		Sum([IsNotPosted]) as [IsNotPosted],
		Sum([IsPosted]) as [IsPosted],
		Sum([IsCollection]) as [IsCollection],
		Sum([IsEndorsement]) as [IsEndorsement],
		Sum([IsReturned]) as [IsReturned],
		isnull(Sum([IsNotPosted]),0)+ isnull(Sum([IsPosted]),0) + isnull(Sum([IsCollection]),0) +	isnull(Sum([IsEndorsement]),0) +	isnull(Sum([IsReturned]),0) as [All],
		Sum([RTotal]) as [Total],
		Sum([RTotal]) as [RTotal],
		1 as [Sort]
	From
		#G2
	
	Select * from #G2 Order By Sort
	*/
	Declare @AllCount int
	Select @AllCount  = COUNT(*) from #R


	Select 
		[CustomerNationality], 
		COUNT(*) as [Count] , 
		100.00 * COUNT(*) / @AllCount * 1.00 as [Percent] , 
		@AllCount as AllCount 
	from 
		#R 
	group by
		[CustomerNationality]
	order by
		[Percent] desc

GO

SET ANSI_NULLS, QUOTED_IDENTIFIER ON
GO

Create Procedure [PrcCreateEntrytypeChecksPartialCollection]
(
	@CollectionGuid uniqueidentifier = '383C4089-ADC3-470B-80C5-3042CA07F0EE',
	@CheckGuid uniqueidentifier = 'BA31BD68-DB22-42EA-BFA8-4E8EF4235659',
	@TypeGuid uniqueidentifier = '090E44FF-AE92-4744-8430-5CF559E58FB1',
	@Sender int = 0,
	@PartialCollectedEntryTypeGuid uniqueidentifier = '28291D9D-4954-42FD-BCFA-25AF9187005D'
)
 
as
	Declare @CeGuid uniqueidentifier,
			@ContractGuid uniqueidentifier
	
	Select
		@CeGuid = L.SecEntryGuid ,
		@ContractGuid = C.[ContractGuid]
	from
		[Checks] [C]
		INNER JOIN [ChecksPartialCollection] [L] ON [L].[CheckGuid] = [C].[Guid]
	where
		L.Guid = @CollectionGuid
		
	if isNull(@ceGuid, 0x0) = 0x0
	begin
		Set @ceGuid = NEWID()
		
		update
			[ChecksPartialCollection]
		set 
			SecEntryGuid = @CeGuid
		where
			Guid = @CollectionGuid
	end
	
	Declare 
			@EnNum int

	--  
	Select 
		@EnNum = isnull([h].[Number],0)
	From
		[Secondary_Entry] H
	where
		[H].[Guid] = @CeGuid

	if isnull(@EnNum,0) = 0
	begin	
		Select @EnNum = IsNull(Max([Number]),0) + 1 from [Secondary_Entry]
		where
			typeGuid = @PartialCollectedEntryTypeGuid
	END

	--    
	Delete [ContractCachPayment] where [EntryGuid] = @CeGuid
	Delete [LandContractCachPayment] where [EntryGuid] = @CeGuid
	Delete [ContractParkingCachPayment] where [EntryGuid] = @CeGuid
	Delete [ElectricityCachPayment] where [EntryGuid] = @CeGuid
	

	--    
	Delete
		[Secondary_Entry]
	where
		[Guid] = @CeGuid

	DECLARE 
		@CreateEntry BIT,
		@AutoPostedEntry Bit,
		@checkPayKind int

	
	SELECT	TOP 1
		@CreateEntry = 
		Case when [partialcollectedCreatedEntry] = 1 and (
													([partialcollectedAutoCreatedEntry] = 1) or (@Sender = 1)
												   ) then 1 else 0 end,
		@AutoPostedEntry = [partialcollectedAutoPostedEntry],
		@checkPayKind = [CheckKind]
	FROM
		[CheckType]
	WHERE
		Guid = @TypeGuid

	DECLARE
		@CheckKind INT,
		@SecLvl Int,
		@CheckNumber Int,
		@Value Float,
		@CurrencyGUID [uniqueidentifier],
		@CurrencyVal [float],
		@Date DateTime,

		@DebitAccountGuid [uniqueidentifier]  ,
		@DebitCostGuid [uniqueidentifier]  ,
		@CreditAccountGuid [uniqueidentifier]  ,
		@CreditCostGuid [uniqueidentifier]  ,
		@Commission Float,
		@CommCostGuid [uniqueidentifier],
		@CommCostCreditGuid [uniqueidentifier],
		@CommNote varchar(256),
		@LossComm Bit,
		@CommType int,
		@CommAccountGuid [uniqueidentifier],
		@CommAccountCreditGuid [uniqueidentifier],
		@Note Varchar(256),
		@BranchGuid [uniqueidentifier],
		@IsRounded bit
		
	SELECT
		@CheckKind				= [T].[CheckKind],
		@SecLvl					= [C].[SecLvl],
		@CheckNumber			= [C].[number],
		@Value					= [L].[Value],
		@CurrencyGUID			= [C].[CurrencyGUID],
		@CurrencyVal			= [C].[CurrencyVal],
		@Date					= [L].[Date],

		@DebitAccountGuid		= [L].[DebitAccountGuid],
		@DebitCostGuid			= [L].[DebitCostGuid],
		@CreditAccountGuid		= [L].[CreditAccountGuid],
		@CreditCostGuid			= [L].[CreditCostGuid],
		@Commission				= [L].[Commission],
		@CommCostGuid			= Case when T.CommMoveCost = 1 then L.[CommCostGuid] end,
		@CommCostCreditGuid			= Case when T.CommMoveCostCredit = 1 then L.[CommCostGuid] end,
		@CommNote 				= [L].[CommNote],
		@LossComm				= [L].[LossComm],
		@CommType				= [T].[CommType],
		@CommAccountGuid		= [L].[CommAccountGuid],
		@CommAccountCreditGuid	= [L].[CommAccountCreditGuid],
		@Note					= [L].[Note],
		@BranchGuid				= [C].[BranchGuid],
		@IsRounded				= IsNull(l.IsRounded,0)
	FROM 
		[Checks] [C]
		INNER JOIN [ChecksPartialCollection] [L] ON [L].[CheckGuid] = [C].[Guid]
		INNER JOIN [CheckType] [T] ON [T].[Guid] = [C].[TypeGuid]
	WHERE
		[L].[Guid] = @CollectionGuid 


	if (@CreateEntry = 1) and (@IsRounded = 0)
	BEGIN
			insert into [Secondary_Entry]
			([Guid],[Number],[Seclvl],[Mark],[Date],[ReceiptNo],[AccountGuid],[Kind],[CurrencyGuid],[CurrencyVal],[Note],[BranchGuid],[TypeGuid],[ContractGuid],[CheckCreateEntry],[SalesManGuid])
			Select
				@ceGuid,
				@EnNum,
				@SecLvl as [Seclvl],
				0 as [Mark],
				@Date as [Date],
				@CheckNumber as [ReceiptNo],
				Case when @checkPayKind = 0 then @DebitAccountGuid else @CreditAccountGuid end as [AccountGuid],
				0 as [Kind],
				@CurrencyGuid as [CurrencyGuid],
				@CurrencyVal as [CurrencyVal],
				@Note as [Note],
				@BranchGuid as [BranchGuid],
				@PartialCollectedEntryTypeGuid as [TypeGuid],
				@ContractGuid as [ContractGuid],
				1 as [CheckCreateEntry],
				Null as [SalesManGuid]
				
			Declare @DetailNum Int
			Set @DetailNum = 0

			Declare @CheckValue Float,
					@CommValue Float

			Set @CheckValue = Case when @LossComm = 1 then
														Case
															when @CommType = 0 then @Value - @Commission
															else @Value
														end
									else
									@Value
							  end

			Set @CommValue = @Commission
				
			insert into [Secondary_EntryDetail]
			([ParentGuid],[Number],[AcGuid],[Debit],[Credit],[CurrencyGuid],[CurrencyVal],[Note],[ObverseAcGuid],[CostGuid])
			Select
				@ceGuid,
				@DetailNum as [Number],
				Case when @checkPayKind = 0 then @CreditAccountGuid else @DebitAccountGuid end as [AcGuid],
				Case when @checkPayKind = 0 then 0 else @CheckValue end as [Debit],
				Case when @checkPayKind = 0 then @CheckValue else 0 end as [Credit],
				@CurrencyGuid,
				@CurrencyVal,
				@Note,
				Case when @checkPayKind = 0 then @DebitAccountGuid else @CreditAccountGuid end as [ObverseAcGuid],
				@CreditCostGuid [CostGuid]


			IF @LossComm = 1  and 1 = 2 -- --  
			BEGIN
				Set @DetailNum = @DetailNum + 1

				insert into [Secondary_EntryDetail]
				([ParentGuid],[Number],[AcGuid],[Debit],[Credit],[CurrencyGuid],[CurrencyVal],[Note],[ObverseAcGuid],[CostGuid])
				Select
					@ceGuid,
					@DetailNum as [Number],
					Case when @checkPayKind = 0 then @CommAccountCreditGuid else @DebitAccountGuid end as [AcGuid],
					Case when @checkPayKind = 0 then 0 else @CommValue end as [Debit],
					Case when @checkPayKind = 0 then @CommValue else 0 end as [Credit],
					@CurrencyGuid,
					@CurrencyVal,
					@CommNote,
					Case when @checkPayKind = 0 then @DebitAccountGuid else @CommAccountCreditGuid end as [ObverseAcGuid],
					@CreditCostGuid [CostGuid]				
			END
			
			exec [PrcCreateEntryFromEntryType] @ceGuid, @ContractGuid


	end

	--    
	--      
	/*
	if Exists(Select Top 1 * From [HEntry] where [Guid] = @CollectionGuid )
	begin
		Declare @ContractKind int
				,@ContractGuid uniqueidentifier
		Set @ContractKind = -1
		
		Select
			@ContractKind = Al.[Kind] ,
			@ContractGuid = [Al].[Guid]
		FROM 
			[Checks] [C]
			INNER JOIN [ChecksPartialCollection] [L] ON [L].[CheckGuid] = [C].[Guid]
			INNER JOIN [CheckType] [T] ON [T].[Guid] = [C].[TypeGuid]
			inner join [vwAllContract] [Al] on [Al].[Guid] = [C].[ContractGuid]
		WHERE
			[L].[Guid] = @CollectionGuid 

		--   
		
		if @ContractKind = 0
		begin
			
			Insert into [ContractCachPayment] 
			([ContractGuid], [EntryGuid])
			Select
				@ContractGuid,
				@CollectionGuid 
			
		end

		--   
		if @ContractKind = 1
		begin
			Insert into [ContractParkingCachPayment] 
			([ContractGuid], [EntryGuid])
			Select
				@ContractGuid,
				@CollectionGuid 
		end

		--   
		if @ContractKind = 2
		begin
			Insert into [LandContractCachPayment] 
			([ContractGuid], [EntryGuid])
			Select
				@ContractGuid,
				@CollectionGuid 
		end

		if @ContractKind is Null
		begin
			
			Select
				@ContractGuid = [Al].[Guid]
			FROM 
				[Checks] [C]
				INNER JOIN [ChecksPartialCollection] [L] ON [L].[CheckGuid] = [C].[Guid]
				INNER JOIN [CheckType] [T] ON [T].[Guid] = [C].[TypeGuid]
				inner join [vwElectricityBill] [Al] on [Al].[Guid] = [C].[ContractGuid]
			WHERE
				[L].[Guid] = @CollectionGuid 
				
			if isNull(@ContractGuid, 0x0) <> 0x0	
			Insert into [ElectricityCachPayment] 
			([ContractGuid], [EntryGuid])
			Select
				@ContractGuid,
				@CollectionGuid 
			
		end
	end
	*/


GO

SET ANSI_NULLS, QUOTED_IDENTIFIER ON
GO
Create Procedure [PrcTransferCardAsstes]
(
	@RoKind int = 2,
	@ToDataBaseName Varchar(256) = 'NewDataBaseName',
	@UntilDate Datetime = '2015-12-31',
	@BeginDate Datetime = '2016-1-1'
)
 
as
	Declare @V Varchar(8000) 


	EXEC PrcDeleteTable 'ContractLandAssets',@ToDataBaseName
	EXEC PrcDeleteTable 'ContractFlatAssets',@ToDataBaseName
	EXEC PrcDeleteTable 'AssetsDepreciationDetail',@ToDataBaseName
	EXEC PrcDeleteTable 'AssetsDepreciation',@ToDataBaseName
	EXEC PrcDeleteTable 'AssetsChangeArea',@ToDataBaseName
	EXEC PrcDeleteTable 'AssetsOperation',@ToDataBaseName
	EXEC PrcDeleteTable 'Assets',@ToDataBaseName
	EXEC PrcDeleteTable 'AssetsArea',@ToDataBaseName
	EXEC PrcDeleteTable 'AssetsGroup',@ToDataBaseName
	
	
	EXEC PrcTransferTable  'AssetsGroup',@ToDataBaseName
	EXEC PrcTransferTable  'AssetsArea',@ToDataBaseName
	
	set @V = '
	exec dbo.PrcCheckConstraint '''+@ToDataBaseName+''', ''Assets'', ''0'''
	Print @V
	exec (@V)
	
	EXEC PrcTransferTable  'Assets',@ToDataBaseName

	set @V = '
	exec dbo.PrcCheckConstraint '''+@ToDataBaseName+''', ''Assets'', ''1'''
	Print @V
	exec (@V)

	--------------
	set @V = '
	exec dbo.PrcCheckConstraint '''+@ToDataBaseName+''', ''AssetsOperation'', ''0'''
	Print @V
	exec (@V)

	EXEC PrcTransferTable  'AssetsOperation',@ToDataBaseName
	
	set @V = '
	exec dbo.PrcCheckConstraint '''+@ToDataBaseName+''', ''AssetsOperation'', ''0'''
	Print @V
	exec (@V)

	--   
	Set @V = '
	Alter Table '+@ToDataBaseName+'..[AssetsOperation] Disable Trigger All'
	exec (@v)

	Set @V = '
	UpDate '+@ToDataBaseName+'..[AssetsOperation] Set [IsRounded] = 1 where [Date] <'+''''+CAST(@UntilDate as varchar(255))+''''
	exec(@V)

 	Set @V = 'Update '+@ToDataBaseName+'..[AssetsOperation] Set [Date] = '''+CAST(@BeginDate as VARchar(20))+''' where [IsRounded] = 1 '
	exec(@V)

	Set @V = '
	Alter Table '+@ToDataBaseName+'..[AssetsOperation] Enable Trigger All'
	exec (@v)

	----------------
	
	EXEC PrcTransferTable  'AssetsChangeArea',@ToDataBaseName

	set @V = '
	exec dbo.PrcCheckConstraint '''+@ToDataBaseName+''', ''AssetsDepreciation'', ''0'''
	Print @V
	exec (@V)

	EXEC PrcTransferTable  'AssetsDepreciation',@ToDataBaseName
	EXEC PrcTransferTable  'AssetsDepreciationDetail',@ToDataBaseName

	set @V = '
	exec dbo.PrcCheckConstraint '''+@ToDataBaseName+''', ''AssetsDepreciation'', ''1'''
	Print @V
	exec (@V)

	--   
	Set @V = '
	Alter Table '+@ToDataBaseName+'..[AssetsDepreciation] Disable Trigger All'
	exec (@v)

	Set @V = '
	UpDate '+@ToDataBaseName+'..[AssetsDepreciation] Set [IsRounded] = 1 where [Date] <'+''''+CAST(@UntilDate as varchar(255))+''''
	exec(@V)

 	Set @V = 'Update '+@ToDataBaseName+'..[AssetsDepreciation] Set [Date] = '''+CAST(@BeginDate as VARchar(20))+''' where [IsRounded] = 1 '
	exec(@V)

	Set @V = '
	Alter Table '+@ToDataBaseName+'..[AssetsDepreciation] Enable Trigger All'
	exec (@v)
	------------
	set @V = '
	exec dbo.PrcCheckConstraint '''+@ToDataBaseName+''', ''ContractFlatAssets'', ''0'''
	Print @V
	exec (@V)

	EXEC PrcTransferTable  'ContractFlatAssets',@ToDataBaseName

	set @V = '
	exec dbo.PrcCheckConstraint '''+@ToDataBaseName+''', ''ContractFlatAssets'', ''1'''
	Print @V
	exec (@V)

	------------
	set @V = '
	exec dbo.PrcCheckConstraint '''+@ToDataBaseName+''', ''ContractLandAssets'', ''0'''
	Print @V
	exec (@V)

	EXEC PrcTransferTable  'ContractLandAssets',@ToDataBaseName

	set @V = '
	exec dbo.PrcCheckConstraint '''+@ToDataBaseName+''', ''ContractLandAssets'', ''1'''
	Print @V
	exec (@V)	
	
	-- 
	Declare @AssetsOperationGuid uniqueidentifier
	DECLARE cursor_Name CURSOR FAST_FORWARD FOR 
	SELECT 
		Guid
	FROM 
		AssetsOperation
	Order By Date
	
	OPEN cursor_Name
	FETCH NEXT FROM cursor_Name INTO @AssetsOperationGuid
	
	WHILE @@FETCH_STATUS = 0
	BEGIN
	  
	  exec PrcCreateAssetsOperationEntry @AssetsOperationGuid
	  FETCH NEXT FROM cursor_Name INTO @AssetsOperationGuid
	
	END
	
	CLOSE cursor_Name
	DEALLOCATE cursor_Name


	-- 
	Declare @AssetsDepreciationGuid uniqueidentifier
	DECLARE cursor_Name CURSOR FAST_FORWARD FOR 
	SELECT 
		Guid
	FROM 
		AssetsDepreciation
	Order By Date
	
	OPEN cursor_Name
	FETCH NEXT FROM cursor_Name INTO @AssetsDepreciationGuid
	
	WHILE @@FETCH_STATUS = 0
	BEGIN
	  
	  exec PrcCreateAssetsDepreciationEntry @AssetsDepreciationGuid
	  FETCH NEXT FROM cursor_Name INTO @AssetsDepreciationGuid
	
	END
	
	CLOSE cursor_Name
	DEALLOCATE cursor_Name
	

GO

SET ANSI_NULLS, QUOTED_IDENTIFIER ON
GO

Create Procedure [PrcCreateBeginEntry]
(
	@ToDataBase Varchar(256) = 'A222',
	@CostDeailt Bit = 0,
	@AcCloseFinal uniqueIdentifier = '8B3414C8-D3ED-4A1B-B3EA-42BB5D9CE5DF',
	@Date Datetime = '1/1/2017',
	@UntilDate  Datetime = '12/31/2016'
)
 
as

	Set Nocount on 
	
	exec ('exec '+@ToDataBase+'..[PrcAddUser]')

	Declare @Msg varchar(255)
	Set @Msg = dbo.SC(' ') + ' '+ dbo.SC('')
	exec PrcSetProgrss @Msg, 100, 0

	--    
	Create Table #Currency
	(
		[CurrencyGuid] uniqueidentifier,
		[CurrencyVal] Float
	)

	Declare @Guid uniqueidentifier
	DECLARE cursor_Name CURSOR FAST_FORWARD FOR 
	SELECT [Guid]
	FROM [Currency]
	
	OPEN cursor_Name
	FETCH NEXT FROM cursor_Name INTO @Guid
	
	WHILE @@FETCH_STATUS = 0
	BEGIN
	  insert into #Currency
		Select 
			@Guid as [CurrencyGuid],
			(Select Top 1 [Rate] From [ChangeCurrencyRate] where [CurrencyGuid] =  @Guid Order By [Date] Desc, [Number] Desc)
	  		  
	  FETCH NEXT FROM cursor_Name INTO @Guid
	END
	
	CLOSE cursor_Name
	DEALLOCATE cursor_Name

	update #Currency
	Set [CurrencyVal] = [C].[CurrencyVal]
	From
		#Currency [C1]
		inner join [Currency] [C] on [C].[Guid] = [C1].[CurrencyGuid]
	where
		[C1].[CurrencyVal] is Null

	update #Currency Set [CurrencyVal] = 1
	where
		[CurrencyVal]  = 0

	Set @Msg = dbo.SC(' ') + ' '+ dbo.SC('')
	exec PrcSetProgrss @Msg, 100, 10

	--  
	Select 
		[Ac].*
	into #Ac
	From
		[vwMovingAccount] [Ac]	
		inner join [Resource] [R] on [R].[Guid] = [Ac].[FinalGuid] and [spid] = @@Spid
	where
		[Type] = 0


	Set @Msg = dbo.SC(' ') + ' '+ dbo.SC(' ')
	exec PrcSetProgrss @Msg, 100, 30
	--  

	Select 
		@Date as [Date]
		,[En].[AcGuid]
		,[Ac2].[Code]
		,[M].[BranchGuid]
		,Case when @CostDeailt = 1 then [En].[CostGuid] end as [CostGuid]
		,IsNull(Sum([En].[Debit]*
			Case when [En].[CurrencyGuid] = [Ac2].[CurrencyGuid] then 1 
			else [En].[CurrencyVal] / [C].[CurrencyVal] end
			),0) as [Debit]
		,IsNull(Sum([En].[Credit]*
			Case when [En].[CurrencyGuid] = [Ac2].[CurrencyGuid] then 1 
			else [En].[CurrencyVal] / [C].[CurrencyVal] end
			),0) as [Credit]
		,[Ac2].[CurrencyGuid]
		,[C].[CurrencyVal]
	into #Ent
	from 
		[DEntry] [En]
		inner Join [vwEntry] [M] on [M].[Guid] = [En].[ParentGuid]
		inner join #Ac [Ac2] on [Ac2].[Guid] = [En].[AcGuid]
		inner join #Currency [C] on [C].[CurrencyGuid] = [Ac2].[CurrencyGuid]
	where 
		([En].[IsVisible] = 1 or [En].[CurrencyGuid] = [Ac2].[CurrencyGuid])
		and ([Type] = 0)
		and (M.[Date] <= @UntilDate)
	Group By
		[En].[AcGuid]
		,[M].[BranchGuid]
		,Case when @CostDeailt = 1 then [En].[CostGuid] end
		,[Ac2].[CurrencyGuid]
		,[C].[CurrencyVal]
		,[Ac2].[Code]

	--Select * from #Ent where Code = '114'

	Create Table #Entry
	(
		[Id] int Identity(1,1)
		,[Date] DateTime
		,[AcGuid] uniqueidentifier
		,[BranchGuid]  uniqueidentifier
		,[CostGuid]  uniqueidentifier
		,[Debit] Float
		,[Credit] Float
		,[CurrencyGuid]  uniqueidentifier
		,[CurrencyVal] Float
	)

	insert into #Entry
	([Date], [AcGuid], [BranchGuid], [CostGuid], [Debit], [Credit], [CurrencyGuid], [CurrencyVal])
	Select 
		[Date], [AcGuid], [BranchGuid], [CostGuid], 
		Case when Sum([Debit]) > Sum([Credit]) then  Sum([Debit] - [Credit]) else 0 end as [Debit],
		Case when Sum([Credit]) > Sum([Debit]) then  Sum([Credit] - [Debit]) else 0 end as [Credit],
		[CurrencyGuid], [CurrencyVal]
	from 
		#Ent
	Group By		
		[Credit],[Date],[Code], [AcGuid], [BranchGuid], [CostGuid], [CurrencyGuid], [CurrencyVal]
	Having 
		Sum([Debit] - [Credit]) <> 0
	Order By
		[Credit], [Code]
		

	Declare @EntryGuid Varchar(256)
	Set @EntryGuid = '111C583B-8377-1118-111C-111AAE645086'

	Declare @Sql Varchar(5000)
	Set @Sql = '
	delete '+@ToDataBase+'..[Hentry]
	where [Guid] ='''+@EntryGuid+''''
	
	Print @Sql
	Exec(@Sql)
	
	Set @Msg = dbo.SC(' ') + ' '+ dbo.SC(' ')
	exec PrcSetProgrss @Msg, 100, 60

	Set @Sql = '
	insert into '+@ToDataBase+'..[Hentry]
		([Guid], [Number], [SecLvl], [Date], [CurrencyGuid], [CurrencyVal], [Note], [ParentKind], [UserGuid], [BranchGuid], [IsPosted])
	Select
		'''+@EntryGuid+''', 
		1 as [Number], 
		0 as [SecLvl], 
		(Select Top 1 [date] From #Entry) as [date], 
		(Select Top 1 [CurrencyGuid] From #Entry Order By [Debit]) As [CurrencyGuid], 
		(Select Top 1 [CurrencyVal] From #Entry Order By [Debit]) as [CurrencyVal], 
		'' '' as [Note], 
		0 as [ParentKind], 
		Null as [UserGuid], 
		Null as [BranchGuid],
		1'
	
	Print @Sql
	Exec(@Sql)

	Set @Msg = dbo.SC(' ') + ' '+ dbo.SC(' ')
	exec PrcSetProgrss @Msg, 100, 70

	Set @Sql = '
	insert into '+@ToDataBase+'..DEntry
	([Number], [Guid], [ParentGuid], [AcGuid], [Debit], [Credit], [CurrencyGuid], [CurrencyVal], [ObverseAcGuid], [CostGuid], [Note], [IsVisible])
	Select
		E.[Id], 
		Newid() as [Guid], 
		'''+@EntryGuid+''' as [ParentGuid], 
		E.[AcGuid], 
		E.[Debit], 
		E.[Credit], 
		E.[CurrencyGuid], 
		E.[CurrencyVal], 
		Null as [ObverseAcGuid], 
		E.[CostGuid], 
		'' '' as [Note], 
		1 as [IsVisible]
	From
		#Entry E
		inner join '+@ToDataBase+'..[Account] Ac on Ac.Guid = E.[AcGuid]
	Order By [id]
	'

--	Print @Sql
	Exec(@Sql)
	
	Set @Msg = dbo.SC(' ') + ' '+ dbo.SC(' ')
	exec PrcSetProgrss @Msg, 100, 90

	--  
	Declare @Cur Uniqueidentifier
			,@CurVal Float
	Set @Cur = (Select [CurrencyGuid] From [Account] where [Guid] = @AcCloseFinal)
	Set @CurVal =  (Select [CurrencyVal] From #Currency where [CurrencyGuid] = @Cur)

	
	Set @Sql = '
	insert into '+@ToDataBase+'..DEntry
	([Number], [Guid], [ParentGuid], [AcGuid], [Debit], [Credit], [CurrencyGuid], [CurrencyVal], [ObverseAcGuid], [CostGuid], [Note], [IsVisible])
	Select
		(Select Max([Id]) + 1 From #Entry), 
		Newid() as [Guid], 
		'''+@EntryGuid+''' as [ParentGuid], 
		'''+Cast(@AcCloseFinal as Varchar(256))+''', 
		(Select Case when Sum([Debit]*[CurrencyVal]/'+Cast(@CurVal as Varchar(256))+') < Sum([Credit]*[CurrencyVal]/'+Cast(@CurVal as Varchar(256))+') then Sum([Credit]*[CurrencyVal]/'+Cast(@CurVal as Varchar(256))+') - Sum([Debit]*[CurrencyVal]/'+Cast(@CurVal as Varchar(256))+') else 0 end From #Entry) as [Debit], 
		(Select Case when Sum([Debit]*[CurrencyVal]/'+Cast(@CurVal as Varchar(256))+') > Sum([Credit]*[CurrencyVal]/'+Cast(@CurVal as Varchar(256))+') then Sum([Debit]*[CurrencyVal]/'+Cast(@CurVal as Varchar(256))+') - Sum([Credit]*[CurrencyVal]/'+Cast(@CurVal as Varchar(256))+') else 0 end From #Entry) as [Credit],
		'''+Cast(@Cur as Varchar(256))+''' as [CurrencyGuid], 
		'+Cast(@CurVal as Varchar(256))+' as [CurrencyVal], 
		Null as [ObverseAcGuid], 
		Null as [CostGuid], 
		'' '' as [Note], 
		1 as [IsVisible]
	'
	
	Print @Sql
	Exec(@Sql)
	
	Set @Msg = dbo.SC(' ') + ' '+ dbo.SC('')
	exec PrcSetProgrss @Msg, 0, 0

	Select 1 as [end]
	
	--Select * from A116..DEntry where ParentGuid = @EntryGuid


GO

SET ANSI_NULLS, QUOTED_IDENTIFIER ON
GO
Create Procedure [PrcUpdateMatPrice]
(
	@GroupGuid uniqueidentifier = 0x0,
	@MatGuid uniqueidentifier = 0x0,
 	@StoreGuid uniqueidentifier = 0x0
)
 
as
	Declare @Unit int Set @Unit = 0
			
	Select 
		Bu.buDate as BuDate,
				Case when @Unit = 1 then [d].[Qty]
			 when @Unit = 2 then [d].[Qty2]
			 when @Unit = 3 then [d].[Qty3]
			 when @Unit = 0 then 
								Case when mt.[DefUnity] = 1 then [d].[Qty]
									 when mt.[DefUnity] = 2 then [d].[Qty2]
									 when mt.[DefUnity] = 3 then [d].[Qty3]
								end
		end * [BtInOut] as [Qty],

		Case when @Unit = 1 then [d].[Price]
			 when @Unit = 2 then [d].[Price] / Case when mt.[UnityFact2] <> 0 then mt.[UnityFact2] end
			 when @Unit = 3 then [d].[Price] / Case when mt.[UnityFact3] <> 0 then mt.[UnityFact3] end
			 when @Unit = 0 then 
								Case when mt.[DefUnity] = 1 then [d].[Price]
									 when mt.[DefUnity] = 2 then [d].[Price] / Case when mt.[UnityFact2] <> 0 then mt.[UnityFact2] end
									 when mt.[DefUnity] = 3 then [d].[Price] / Case when mt.[UnityFact3] <> 0 then mt.[UnityFact3] end
								end	
		end 
		*
		Case 
			when bu.[buCurrencyGuid] = mt.[CurrencyGuid] then 1
			else
			bu.buCurrencyval / Case when mt.Currencyval <> 0 then mt.Currencyval end
		end
		 * [BtInOut] as [Price],
		BtInOut,		btBillKind,		[D].[MatGuid]	into #TmpMatPrice	From
		[vwbill] Bu
		inner join [BillDetail] D on d.ParentGuid = buGuid
		inner join [Mat] mt on mt.Guid = d.MatGuid
		--inner join [Resource] rs on rs.Guid = d.MatGuid and rs.spid = @@spid
	where
		(BuisPosted = 1)
		and (mt.MatType = 0 )
		and ([btPriceEffected] = 1)

	--Select * from #TmpMatPrice
	
	Create Table #AvgPriceTbl 
	(	
		[BuDate] Datetime,
		[BuNumber] int,
		[BiNumber] int,
		[matGuid] uniqueidentifier,
		[BuGuid] uniqueidentifier,
		[AvgPrice] Float
	)

	Delete [Resource] where Spid = @@Spid
	insert into [Resource] 
	(Guid)
	Select Guid from billtype

	insert into #AvgPriceTbl
	exec PrcCalcAvgPrice @GroupGuid,
						 @MatGuid,
 						 @StoreGuid,
						 0x0, --@CostGuid,
						 '', --@Class,
						 0 ,--@Unit,
						 2, --@BillPost,
						 0x0 ,--@CurrencyGuid,
						 1 ,--@CurrencyVal,
						 0 ,-- @CkDate,
						 0,--@Date1,
						 0--@Date2 
						 
	CREATE CLUSTERED INDEX #IX_AvgPriceTbl ON #AvgPriceTbl([budate], [BuNumber], [MatGuid])

	Alter Table #AvgPriceTbl add id int identity(1,1)
	Select Max(Id) as id, MatGuid into #MaxMatGuidavgPrice from #AvgPriceTbl group by MatGuid
	--Select * from #MaxMatGuidavgPrice
	
	Select
		v.matGuid,
		p.avgPrice
	into #TblMatLastAvgPrice
	From
		#MaxMatGuidavgPrice V
		inner join #AvgPriceTbl P on v.MatGuid = p.MatGuid and p.id = v.id
		
	/*
	Select
		[MatGuid],
		Sum([Qty] * [Price]) / Case when Sum([Qty]) <> 0 then Sum([Qty]) end as [avgPrice]
	into #TmpAvgPrice
	From
		#TmpMatPrice
	Group By
		[MatGuid]
		
	Select * from #TmpAvgPrice*/
	
	update Mat
	Set
		AvgPrice = t.AvgPrice
	From
		mat mt 
		inner join #TblMatLastAvgPrice T on T.matGuid = mt.Guid
		
	Select
		[MatGuid],
		Max(BuDate) as [MaxDate]
	into #tmpLastDate
	From
		#TmpMatPrice
	where	
		([btBillKind] in (0,2,4))
	Group By
		[MatGuid]
	
	Select
		T.MatGuid,
		Max(T.Price) as LastPrice,
		m.MaxDate
	into #tmpLastPrice
	From
		#tmpLastDate M
		inner join #TmpMatPrice T on T.budate = M.MaxDate and M.MatGuid = T.MatGuid
	where	
		([btBillKind] in (0,2,4))
	Group By
		T.MatGuid,
		m.MaxDate
	
	
	update Mat
	Set
		LastPrice = t.LastPrice,
		LastPriceDate = t.MaxDate
	From
		mat mt 
		inner join #tmpLastPrice T on T.matGuid = mt.Guid
		

	Select
		T.MatGuid,
		Max(T.Price) as MaxPrice
	into #tmpMaxPrice
	From
		#TmpMatPrice T
	where	
		([btBillKind] in (0,2,4))
	Group By
		T.MatGuid

	update Mat
	Set
		MaxPrice = t.MaxPrice
	From
		mat mt 
		inner join #TmpMaxPrice T on T.matGuid = mt.Guid


	-- 
	Select
		[MatGuid],
		-Sum([Qty] * [Price]) / Case when Sum([Qty]) <> 0 then Sum([Qty]) end as [avgPrice]
	into #TmpSaleAvgPrice
	From
		#TmpMatPrice
	where	
		([btBillKind] in (1,3,5))
	Group By
		[MatGuid]
		
	update Mat
	Set
		SaleAvgPrice = t.AvgPrice
	From
		mat mt 
		inner join #TmpSaleAvgPrice T on T.matGuid = mt.Guid

	Select
		[MatGuid],
		Max(BuDate) as [MaxDate]
	into #tmpSaleLastDate
	From
		#TmpMatPrice
	where	
		([btBillKind] in (1,3,5))
	Group By
		[MatGuid]
	
	Select
		T.MatGuid,
		Max(-T.Price) as LastPrice,
		m.MaxDate
	into #tmpSaleLastPrice
	From
		#tmpSaleLastDate M
		inner join #TmpMatPrice T on T.budate = M.MaxDate and M.MatGuid = T.MatGuid
	where	
		([btBillKind] in (1,3,5))
	Group By
		T.MatGuid,
		m.MaxDate
	
	
	update Mat
	Set
		SaleLastPrice = t.LastPrice,
		SaleLastPriceDate = t.MaxDate
	From
		mat mt 
		inner join #tmpSaleLastPrice T on T.matGuid = mt.Guid
		

	Select
		T.MatGuid,
		Max(-T.Price) as MaxPrice
	into #tmpSaleMaxPrice
	From
		#TmpMatPrice T
	where	
		([btBillKind] in (1,3,5))
	Group By
		T.MatGuid

	update Mat
	Set
		SaleMaxPrice = t.MaxPrice
	From
		mat mt 
		inner join #TmpSaleMaxPrice T on T.matGuid = mt.Guid


GO

SET ANSI_NULLS, QUOTED_IDENTIFIER ON
GO

Create Procedure [PrcPrintLandContract]
(
	@Guid uniqueidentifier = 0x0
	,@OnlyValue Varchar(256) = ''
)
 
as
	Select 
		GetDate() as [NowDate],
		dbo.FnFormatDate(GetDate()) as [NowDate_Gr],
		[A].[Number],
		[A].[ContractNo],
		[C].[ArName] as [CustArName],
		[C].[LtnName] as [CustLtnName],
		[C].[Address] as [CustomerAddress],
		[C].[Nationality] as [CustomerNationality],
		[C].[PassportNO] as [CustomerPassportNO], 
		[C].[Profession] as [CustomerProfession],
		[C].[Domicile] as [CustomerDomicile],
		[C].[Security] as [CustomerSecurity],
		[C].[MemoSecurity] as [CustomerMemoSecurity],
		[C].[BoxNo] as [CustomerBoxNo],
		[C].[PersonalityNo1] as [CustomerPersonalityNo1],
		[C].[PersonalityNo2] as [CustomerPersonalityNo2],
		[C].[Adjective]as [CustomerAdjective],
		[C].[Fax]	as [CustomerFax],
		[C].[PhoneJob]	as [CustomerPhoneJob],
		[C].[Mobile]	as [CustomerMobile],
		[C].[Email]	as [CustomerEmail],

		[C].[PassportNO] as [CustomerPassportNO],
		[C].[PassportExpireDate] as [CustomerPassportExpireDate],
		dbo.FnFormatDate([C].[PassportExpireDate]) as [CustomerPassportExpireDate_Gr],	
		[A].[ContractPrice],
		(Select Sum(Value) From LandContractFee where ParentGuid = A.Guid) as SumFee,

		Case when [Contractkind] = 6 then [P].[EarthNo] 
			 when [Contractkind] = 7 then [p].[EarthNo] 
			 when [Contractkind] = 8 then [S].[VillaNo] 
			 when [Contractkind] = 9 then [S].[VillaNo]  end
		as [RealtyNo],
		
		Case when [S].[Guid] is not Null then [S].[VillaNo] else [P].[No] end as [NO],
		
		Case when [Contractkind] = 6 then [P].[Name] 
			 when [Contractkind] = 7 then [p].[Name] 
			 when [Contractkind] = 8 then [S].[VillaNo] 
			 when [Contractkind] = 9 then [S].[VillaNo]  end
		as [Name],

		Case when [Contractkind] = 6 then [P].[LtnName]
			 when [Contractkind] = 7 then [p].[LtnName]
			 when [Contractkind] = 8 then [S].[VillaNo] 
			 when [Contractkind] = 9 then [S].[VillaNo]  end
		as [LtnName],

		Case when [Contractkind] = 6 then [P].[LandType]
			 when [Contractkind] = 7 then [p].[LandType]
			 when [Contractkind] = 8 then ''
			 when [Contractkind] = 9 then '' end
		as [LandType],
		
		Case when [Contractkind] = 6 then [P].[City]
			 when [Contractkind] = 7 then [p].[City]
			 when [Contractkind] = 8 then ''
			 when [Contractkind] = 9 then '' end
		as [LandCity],
		
		Case when [Contractkind] = 6 then [P].[Region]
			 when [Contractkind] = 7 then [p].[Region]
			 when [Contractkind] = 8 then s.Area
			 when [Contractkind] = 9 then s.Area end
		as [Region],

		Case when [Contractkind] = 6 then [P].[Space]
			 when [Contractkind] = 7 then [p].[Space]
			 when [Contractkind] = 8 then s.[BasinNo]
			 when [Contractkind] = 9 then s.[BasinNo] end
		as [BasinNo],
		
		Case when [Contractkind] = 6 then [P].EarthNo
			 when [Contractkind] = 7 then [p].EarthNo
			 when [Contractkind] = 8 then s.PieceNo
			 when [Contractkind] = 9 then s.PieceNo end
		as [PieceNo],
		
		Case when [Contractkind] = 6 then [P].EarthNo
			 when [Contractkind] = 7 then [p].EarthNo
			 when [Contractkind] = 8 then s.PieceNo
			 when [Contractkind] = 9 then s.PieceNo end
		as [PieceNo],

		Case when [Contractkind] = 6 then [P].license
			 when [Contractkind] = 7 then [p].license
			 when [Contractkind] = 8 then s.DocType
			 when [Contractkind] = 9 then s.DocType end
		as [DocType],
		
		Case when [Contractkind] = 6 then [P].Area
			 when [Contractkind] = 7 then [p].Area
			 when [Contractkind] = 8 then s.LandArea
			 when [Contractkind] = 9 then s.LandArea end
		as [Area],
		
		Case when [Contractkind] = 6 then [P].unity
			 when [Contractkind] = 7 then [p].unity
			 when [Contractkind] = 8 then ''
			 when [Contractkind] = 9 then '' end
		as [AreaUnity],

        [A].[RentDuration],
        [A].[Rentype],
        [A].[TermsOfPayment],
		[A].[Rent] as [Value],
		[A].[DiscountValue]	,
		@OnlyValue as [OnlyValue],
		[My].[Code] as [Currency],
		[A].[InsuranceValueOld],
		[A].[InsuranceValue],
		[A].[ElectricityInsurance],
		[A].[CertificatValue] as [AuthenticationFee],
		[A].[CertificatValue] ,
		[A].[OtherFee],	
		
		[Purpose],

		[FromDate],
		dbo.FnFormatDate([FromDate]) AS [FromDate_Gr],
		[ToDate] as [ToDate],
		dbo.FnFormatDate([ToDate]) as [ToDate_Gr],

		DATEDIFF(DAY, ToDate, FromDate) as ContractDays,
		Case when ContractFinish = 1 then 
		DATEDIFF(DAY, ToDate, ContractFinishDate) 
		end as ContractDaysDifference,

		[A].[Note],
		[A].[Note2],
		[Contractkind],

		[A].[ElectricityInsurance],

	    [R].[Name] as [Rent_Name],
	    [R].[LtnName] as [Rent_LtnName],
	    [R].[Adjective]  as [Rent_Adjective],
	    [R].[Nationality]  as [Rent_Nationality],
	    [R].[Work]  as [Rent_Work],
	    [R].[PersonalityNo]   as [Rent_PersonalityNo],
		[R].[WorkCardNo]   as [Rent_CardNo],
	    [R].[Address]  as [Rent_Address],
	    [R].[Phone]  as [Rent_Phone],
	    [R].[Mobile]  as [Rent_Mobile],
	    [R].[BoxNo]  as [Rent_BoxNo],
		[R].[Fax]  as [Rent_FaxNo],
	    [R].[EMail]  as [Rent_EMail],

		[R].[PassportNO] as [Rent_PassportNO],
		[C].[PassportExpireDate] as [CustomerPassportExpireDate],	
		dbo.FnFormatDate([C].[PassportExpireDate]) as [CustomerPassportExpireDate_Gr],
			
		Case when [P].[Guid] is not Null then [P].[Region] else [S].[Area] end as [FlatArea],

		Case when [P].[Guid] is not Null then [P].[LandType] else '' end as [LandType],
		Case when [P].[Guid] is not Null then [P].[LtnLandType] else '' end as [LtnLandType],
		Case when [P].[Guid] is not Null then [P].[LtnCity] else '' end as [LtnCity],
		Case when [P].[Guid] is not Null then [P].[LtnRegion] else [S].[LtnArea] end as [LtnRegion],
		Case when [P].[Guid] is not Null then [P].[LtnSpace] else '' end as [LtnSpace],
		Case when [P].[Guid] is not Null then [P].[Ltnlicense] else [S].[LtnDocType] end as [Ltnlicense] ,
		Case when [P].[Guid] is not Null then [P].[Ltnside] else '' end as [Ltnside],


		Case when [S].[Guid] is not Null then [S].ComplexName else '' end as ComplexName,
		Case when [S].[Guid] is not Null then [S].Emirate else '' end as Emirate,
		Case when [S].[Guid] is not Null then [S].Suburb else '' end as Suburb,
		Case when [S].[Guid] is not Null then [S].Street else [P].[StreetName] end as Street,
		Case when [S].[Guid] is not Null then [S].PieceNo else '' end as PieceNo,
		Case when [S].[Guid] is not Null then [S].BasinNo else [P].[Space] end as BasinNo,
		Case when [S].[Guid] is not Null then [S].WaterCounter else '' end as WaterCounter,
		Case when [S].[Guid] is not Null then [S].ElectricityCounter else '' end as ElectricityCounter,
		Case when [S].[Guid] is not Null then [S].DocType else [p].license end as DocType,
		Case when [S].[Guid] is not Null then [S].DocNo else [P].licenseNo end as DocNo,
		Case when [S].[Guid] is not Null then [S].DocDate else [P].licenseDate end as DocDate,
		Case when [S].[Guid] is not Null then dbo.FnFormatDate([S].DocDate) else dbo.FnFormatDate([P].licenseDate) end as DocDate_Gr,
		

		Case when [P].[Guid] is not Null then [P].[Area] else [S].[LandArea] end as [LandArea],
		[S].[LandAreaBuilding]	,

		[A].[License1No],
		[A].[License2No],
		[A].[License3No],
		[A].[License1Date1],
		dbo.FnFormatDate([A].[License1Date1]) as [License1Date1_Gr],
		[A].[License2Date1],
		dbo.FnFormatDate([A].[License2Date1]) as [License2Date1_Gr],
		[A].[License3Date1],
		dbo.FnFormatDate([A].[License3Date1]) as [License3Date1_Gr],
		[A].[License1Date2],
		dbo.FnFormatDate([A].[License1Date2]) as [License1Date2_Gr],
		[A].[License2Date2],
		dbo.FnFormatDate([A].[License2Date2]) as [License2Date2_Gr],
		[A].[License3Date2],
		dbo.FnFormatDate([A].[License3Date2]) as [License3Date2_Gr],

		[A].[Ltnwhereabouts],
		[A].[LtnPurpose],
		[A].[LtnRentDuration],
		[A].[LtnRentype],
		[A].[LtnTermsOfPayment],

		[A].[ElectricityCounter],
		[Sl].[Name] as [SalesMan],
		[T].[Code] as [TypeCode],
		[T].[Code]+CAST(A.Number as Varchar(256)) as [TypeCode_Number],
		[C].[BankName] as [CustBankName],
		[C].[BankAccCode] as [CustBankAccCode],
		[Ac].[code] AS [AccountCode],
		[Ac].[Balance] AS [AccountBalance],
		[A].[Trademark],


		[A].[CommissionFromCustValue],
		[A].[CommissionFromCustPercent],

		[A].[CommissionFromOwnerValue] ,
		[A].[CommissionFromOwnerPercent],

		[A].[Guid],

		(Select Top 1 [UserName] From vwRealty_LogCard where CardGuid = A.Guid order by Date) as [CreateByUser],
		(Select Top 1 [Date] From vwRealty_LogCard where CardGuid = A.Guid order by Date) as [CreateDate],
		(Select Top 1 [UserName] From vwRealty_LogCard where CardGuid = A.Guid order by Date desc) as [LastUpdateByUser],
		(Select Top 1 [Date] From vwRealty_LogCard where CardGuid = A.Guid order by Date desc) as [LastUpdateDate]
	from 
		[LandContract] [A]
		inner join [vwContractType] [t] on [t].[Guid] = [A].[TypeGuid]
		left join [vwEarth] [P] on [P].[Guid] = [A].[LandGuid]
		left join [vwVilla] [S] on [S].[Guid] = [A].[VillaGuid]
		left join [vwCustomer] [C] on [C].[Guid] = [A].[CustomerGuid]
		left join [vwAccount] [AC] on [C].[AcGuid] = [AC].[Guid]
		left join [vwCurrency] [My] on [My].[Guid] = [A].[CurrencyGuid]
		left join [RentInfo] [R] on [R].[Guid] = [A].[RentInfoGuid]
		left join [vwSalesMan] [Sl] on [Sl].[Guid] = [A].[SalesManGuid]
	where
		[A].[Guid] = @Guid or @Guid = 0x0


GO

SET ANSI_NULLS, QUOTED_IDENTIFIER ON
GO

Create Procedure [RepFlatSales]
(
	@CustGuid uniqueidentifier = 0x0
	,@Emirate Varchar(256) = ''
	,@Suburb Varchar(256) = ''
	,@Area Varchar(256) = ''
	,@Street Varchar(256) = ''
	,@FlatKind Varchar(256) = ''
	,@Class Varchar(256) = ''
	,@ApartmentType Varchar(256) = ''
	,@FlatArea1 Float = 0
	,@FlatArea2 Float = 0
	,@Unity Varchar(256) = ''
	,@SalesState int = 0
	,@Date1 DateTime = '1/1/2007'
	,@Date2 DateTime = '1/1/2009'
	,@SalesManGuid uniqueidentifier = 0x0
	,@ShowFlat Bit = 1
	,@ShowShop Bit = 1
)
 
as
	
	Declare @Tbl Table
	(
		[FlatNo] Varchar(256)
		,[BuildingName] Varchar(256)
		,[FlatKind] Varchar(256)
		,[FlatType] Varchar(256)
		,[Class] Varchar(256)
		,[FlatArea] Float
		,[State]  Varchar(256)
		,[Emirate] Varchar(256)
		,[Suburb] Varchar(256)
		,[Area] Varchar(256)
		,[Street] Varchar(256)
		,[CustName] Varchar(256)
		,[CustPhone] Varchar(256)
		,[ContractDateBegin] Datetime
		,[ContractValue] Float
		,[ContractGuid] uniqueidentifier
		,[AcGuid] uniqueidentifier
	)
	
	if @ShowFlat = 1
	Insert into @Tbl 
	Select 
		[A].[No] as [FlatNo]
		,[B].[Name] as [BuildingName]
		,[A].[FlatKind] as [FlatKind]
		,[A].[ApartmentType] as [FlatType]
		,[A].[Class] as [Class]
		,[A].[Area] as [FlatArea]
		,Case when [L].[Guid] is null then dbo.sc(' ') else dbo.sc('') end as [State]
		,[B].[Emirate] as [Emirate]
		,[B].[Suburb] as [Suburb]
		,[B].[Area] as [Area]
		,[B].[Street] as [Street]
		,[Cu].[Name] as [CustName]
		,[Cu].[Mobile] as [CustPhone]
		,[L].[FromDate] as [ContractDateBegin]
		,([L].[Rent] - [L].[DiscountValue]) * [L].[CurrencyVal] as [ContractValue]
		,[L].[Guid] as [ContractGuid]
		,l.CustAccountGuid
	from 
		[vwBuilding] [B]
		Inner join [vwApartment] [A] On [A].[BuildingGuid] = [B].[Guid]
		Inner join [Resource] [R] on [R].[Guid] = [B].[Guid] and [spid] = @@Spid
		left join [LeaseApartment] [L] On [A].[Guid] = [L].[ApartmentGuid] and [LeaseKind]  = 2
		left join [vwCustomer] [Cu] on [Cu].[Guid] = [L].[CustomerGuid] 
 	where
 		([Cu].[Guid] = @CustGuid or @CustGuid = 0x0)
 		and([B].[Emirate] = @Emirate or @Emirate = '')
		and ([B].[Suburb] = @Suburb or @Suburb = '')
		and ([B].[Area] = @Area or @Area = '')
		and ([B].[Street] = @Street or @Street = '')
		and ([A].[FlatKind] = @FlatKind or @FlatKind = '')
		and ([A].[Class] = @Class or @Class = '')
		and ([A].[ApartmentType] = @ApartmentType or @ApartmentType = '')
		and ([A].[Area] between @FlatArea1 and @FlatArea2 or @FlatArea2 = 0) 
		and ([Unity] = @Unity or @Unity = '')
		and (
				([L].[Guid] is not null and @SalesState = 0)
				or ([L].[Guid] is null and @SalesState = 1)
				or @SalesState = 2
			)
		and 
			(
				([L].[FromDate] between @Date1 and @Date2)
				or @SalesState <> 0
			)

		and ([L].[SalesManGuid] = @SalesManGuid or @SalesManGuid = 0x0)

	if @ShowShop = 1
	Insert into @Tbl 
	Select 
		[A].[No] as [FlatNo]
		,[B].[Name] as [BuildingName]
		,dbo.sc('') as [FlatKind]
		,'' as [FlatType]
		,'' as [Class]
		,[A].[Area] as [FlatArea]
		,Case when [L].[Guid] is null then dbo.sc(' ') else dbo.sc('') end as [State]
		,[B].[Emirate] as [Emirate]
		,[B].[Suburb] as [Suburb]
		,[B].[Area] as [Area]
		,[B].[Street] as [Street]
		,[Cu].[Name] as [CustName]
		,[Cu].[Mobile] as [CustPhone]
		,[L].[FromDate] as [ContractDateBegin]
		,([L].[Rent] - [L].[DiscountValue]) * [L].[CurrencyVal] as [ContractValue]
		,[L].[Guid] as [ContractGuid]
		,l.CustAccountGuid
	from 
		[vwBuilding] [B]
		Inner join [vwShop] [A] On [A].[BuildingGuid] = [B].[Guid]
		Inner join [Resource] [R] on [R].[Guid] = [B].[Guid] and [spid] = @@Spid
		left join [LeaseApartment] [L] On [A].[Guid] = [L].[ApartmentGuid] and [LeaseKind]  = 2
		left join [vwCustomer] [Cu] on [Cu].[Guid] = [L].[CustomerGuid] 
	where
		([Cu].[Guid] = @CustGuid or @CustGuid = 0x0)
 		and	([B].[Emirate] = @Emirate or @Emirate = '')
		and ([B].[Suburb] = @Suburb or @Suburb = '')
		and ([B].[Area] = @Area or @Area = '')
		and ([B].[Street] = @Street or @Street = '')
		and ([A].[Area] between @FlatArea1 and @FlatArea2 or @FlatArea2 = 0) 
		and ([Unity] = @Unity or @Unity = '')
		and (
				([L].[Guid] is not null and @SalesState = 0)
				or ([L].[Guid] is null and @SalesState = 1)
				or @SalesState = 2
			)
		and 
			(
				([L].[FromDate] between @Date1 and @Date2)
				or @SalesState <> 0
			)

		and ([L].[SalesManGuid] = @SalesManGuid or @SalesManGuid = 0x0)

	-- 
	Select
		[P].[ContractGuid],
		Sum(IsNull([P].[Value] * [P].[CurrencyVal],0)) as [Total],
		Sum(IsNull([C1].[Value] * [C1].[CurrencyVal],0)) as [Collection]
--		+  IsNull([pc].[Value] * [pc].[CurrencyVal],0)) 
	Into #Collection
	From
		[vwChecks] [P]
		left join [vwChecksCollection] [C1] on [C1].[CheckGuid] = [P].[Guid] and [C1].[Kind] = 1
--		left join [ChecksPartialCollection] [pc] on [pc].[CheckGuid] = [P].[Guid]
		inner join @Tbl [t] on [t].[ContractGuid] = [P].[ContractGuid]
	Group By
		[P].[ContractGuid]

	-- 
	Select
		[P].[ContractGuid],
		Sum(IsNull([P].[Value] * [P].[CurrencyVal],0)) as [Cash]
	Into #Cash
	From
		[vwContractCachPayment] [P]
		inner join @Tbl [t] on [t].[ContractGuid] = [P].[ContractGuid] and P.AcGuid = t.AcGuid
	Group By
		[P].[ContractGuid]

	Select 
		t.*,
		isNull([C].[Collection],0) as [Collection],
		isNull([C].[Total],0) - isNull([C].[Collection],0) as [CheckNotCollection],
		isNull([h].[Cash],0) as [Cash],
		IsNull([C].[Collection],0) + IsNull([h].[Cash],0) as [TotalPays],
		isNull([ContractValue],0) - IsNull([C].[Collection],0) - IsNull([h].[Cash],0) as [ContractRest],
		isNull(t.ContractValue,0) - IsNull([h].[Cash],0) - isNull([C].[Total],0) as [CustBalance],
		1 as Kind
	into #EndRes
	From
		@Tbl [t] 
		left join #Collection [C] on [t].[ContractGuid] = [C].[ContractGuid]
		left join #Cash [h] on [t].[ContractGuid] = [h].[ContractGuid]
	
	Insert into #EndRes
	Select
		Null as [FlatNo],		dbo.SC('') as [BuildingName],		Null as [FlatKind],		Null as [FlatType],		Null as [Class],		Null as [FlatArea],		Null as [State],		Null as [Emirate],		Null as [Suburb],		Null as [Area],		Null as [Street],		Null as [CustName],		Null as [CustPhone],		Null as [ContractDateBegin],		Sum([ContractValue]),		Null as [ContractGuid],		Null as [AcGuid],		IsNull(Sum([Collection]),0),		IsNull(Sum([CheckNotCollection]),0),		IsNull(Sum([Cash]),0),		IsNull(Sum([TotalPays]),0),		IsNull(Sum([ContractRest]),0),		IsNull(Sum([CustBalance]),0),		2 as [Kind]
	From
		#EndRes
		

	Select
		*
	From
		#Endres
	Order By 
		Kind,
		[BuildingName],
		[FlatNo]


GO

SET ANSI_NULLS, QUOTED_IDENTIFIER ON
GO

Create Trigger [TRG_Trace_CheckType]
on [CheckType]
 
for update
As
	SET NOCOUNT ON;
	if Not exists(Select Value from DMD_const where vName = 'ActiveLogCardUpdate' and Value = '1' ) return
	
	Declare @UserGuid uniqueidentifier, @Guid uniqueidentifier
	Set @Guid = NEWID()
	
	Select Top 1 @UserGuid = userGuid From CurrentUsers where Spid = @@SPID
			
	insert into [Trace]
	([Guid],[ParentGuid],[Date],[userGuid],[HostName],ParentTbl )
	Select Top 1
		@Guid,
		N.Guid,
		GETDATE(),
		@UserGuid,
		Host_Name(),
		'CheckType'
	From
		[inserted] n 
		
	insert into [TraceDetail]
	([ParentGuid],[Caption],[Old],[New],[Tbl])
	Select Top 1
		@Guid,
		' ' as [Caption],
		D.[SecLvl] as [old],
		N.[SecLvl] as [New],
		''
	From
		[deleted] d
		inner join [inserted] n on D.Guid = N.Guid
	where
		N.[SecLvl] <> D.[SecLvl]
		
	insert into [TraceDetail]
	([ParentGuid],[Caption],[Old],[New],[Tbl])
	Select Top 1
		@Guid,
		'  ' as [Caption],
		D.[CheckKind] as [old],
		N.[CheckKind] as [New],
		''
	From
		[deleted] d
		inner join [inserted] n on D.Guid = N.Guid
	where
		N.[CheckKind] <> D.[CheckKind]
		
	insert into [TraceDetail]
	([ParentGuid],[Caption],[Old],[New],[Tbl])
	Select Top 1
		@Guid,
		'' as [Caption],
		D.[Code] as [old],
		N.[Code] as [New],
		''
	From
		[deleted] d
		inner join [inserted] n on D.Guid = N.Guid
	where
		N.[Code] <> D.[Code]
		
	insert into [TraceDetail]
	([ParentGuid],[Caption],[Old],[New],[Tbl])
	Select Top 1
		@Guid,
		'' as [Caption],
		D.[Name] as [old],
		N.[Name] as [New],
		''
	From
		[deleted] d
		inner join [inserted] n on D.Guid = N.Guid
	where
		N.[Name] <> D.[Name]
		
	insert into [TraceDetail]
	([ParentGuid],[Caption],[Old],[New],[Tbl])
	Select Top 1
		@Guid,
		' ' as [Caption],
		D.[ltnName] as [old],
		N.[ltnName] as [New],
		''
	From
		[deleted] d
		inner join [inserted] n on D.Guid = N.Guid
	where
		N.[ltnName] <> D.[ltnName]
		
	insert into [TraceDetail]
	([ParentGuid],[Caption],[Old],[New],[Tbl])
	Select Top 1
		@Guid,
		' ' as [Caption],
		D.[Menu] as [old],
		N.[Menu] as [New],
		''
	From
		[deleted] d
		inner join [inserted] n on D.Guid = N.Guid
	where
		N.[Menu] <> D.[Menu]
		
	insert into [TraceDetail]
	([ParentGuid],[Caption],[Old],[New],[Tbl])
	Select Top 1
		@Guid,
		'  ' as [Caption],
		D.[LtnMenu] as [old],
		N.[LtnMenu] as [New],
		''
	From
		[deleted] d
		inner join [inserted] n on D.Guid = N.Guid
	where
		N.[LtnMenu] <> D.[LtnMenu]
		
	insert into [TraceDetail]
	([ParentGuid],[Caption],[Old],[New],[Tbl])
	Select Top 1
		@Guid,
		' ' as [Caption],
		D.[ShortCut] as [old],
		N.[ShortCut] as [New],
		''
	From
		[deleted] d
		inner join [inserted] n on D.Guid = N.Guid
	where
		N.[ShortCut] <> D.[ShortCut]
		
	insert into [TraceDetail]
	([ParentGuid],[Caption],[Old],[New],[Tbl])
	Select Top 1
		@Guid,
		' ' as [Caption],
		D.[CreatedEntry] as [old],
		N.[CreatedEntry] as [New],
		''
	From
		[deleted] d
		inner join [inserted] n on D.Guid = N.Guid
	where
		N.[CreatedEntry] <> D.[CreatedEntry]
		
	insert into [TraceDetail]
	([ParentGuid],[Caption],[Old],[New],[Tbl])
	Select Top 1
		@Guid,
		'   ' as [Caption],
		D.[AutoCreatedEntry] as [old],
		N.[AutoCreatedEntry] as [New],
		''
	From
		[deleted] d
		inner join [inserted] n on D.Guid = N.Guid
	where
		N.[AutoCreatedEntry] <> D.[AutoCreatedEntry]
		
	insert into [TraceDetail]
	([ParentGuid],[Caption],[Old],[New],[Tbl])
	Select Top 1
		@Guid,
		'   ' as [Caption],
		D.[AutoPostedEntry] as [old],
		N.[AutoPostedEntry] as [New],
		''
	From
		[deleted] d
		inner join [inserted] n on D.Guid = N.Guid
	where
		N.[AutoPostedEntry] <> D.[AutoPostedEntry]
		
	insert into [TraceDetail]
	([ParentGuid],[Caption],[Old],[New],[Tbl])
	Select Top 1
		@Guid,
		' ' as [Caption],
		D.[DefAccountGuid] as [old],
		N.[DefAccountGuid] as [New],
		'[Account]'
	From
		[deleted] d
		inner join [inserted] n on D.Guid = N.Guid
	where
		N.[DefAccountGuid] <> D.[DefAccountGuid]
		
	insert into [TraceDetail]
	([ParentGuid],[Caption],[Old],[New],[Tbl])
	Select Top 1
		@Guid,
		' ' as [Caption],
		D.[Posted] as [old],
		N.[Posted] as [New],
		''
	From
		[deleted] d
		inner join [inserted] n on D.Guid = N.Guid
	where
		N.[Posted] <> D.[Posted]
		
	insert into [TraceDetail]
	([ParentGuid],[Caption],[Old],[New],[Tbl])
	Select Top 1
		@Guid,
		'  ' as [Caption],
		D.[PosdetCreatedEntry] as [old],
		N.[PosdetCreatedEntry] as [New],
		''
	From
		[deleted] d
		inner join [inserted] n on D.Guid = N.Guid
	where
		N.[PosdetCreatedEntry] <> D.[PosdetCreatedEntry]
		
	insert into [TraceDetail]
	([ParentGuid],[Caption],[Old],[New],[Tbl])
	Select Top 1
		@Guid,
		'    ' as [Caption],
		D.[PosdetAutoCreatedEntry] as [old],
		N.[PosdetAutoCreatedEntry] as [New],
		''
	From
		[deleted] d
		inner join [inserted] n on D.Guid = N.Guid
	where
		N.[PosdetAutoCreatedEntry] <> D.[PosdetAutoCreatedEntry]
		
	insert into [TraceDetail]
	([ParentGuid],[Caption],[Old],[New],[Tbl])
	Select Top 1
		@Guid,
		'   ' as [Caption],
		D.[PosdetAutoPostedEntry] as [old],
		N.[PosdetAutoPostedEntry] as [New],
		''
	From
		[deleted] d
		inner join [inserted] n on D.Guid = N.Guid
	where
		N.[PosdetAutoPostedEntry] <> D.[PosdetAutoPostedEntry]
		
	insert into [TraceDetail]
	([ParentGuid],[Caption],[Old],[New],[Tbl])
	Select Top 1
		@Guid,
		' ' as [Caption],
		D.[PostedDefAccountGuid] as [old],
		N.[PostedDefAccountGuid] as [New],
		'[Account]'
	From
		[deleted] d
		inner join [inserted] n on D.Guid = N.Guid
	where
		N.[PostedDefAccountGuid] <> D.[PostedDefAccountGuid]
		
	insert into [TraceDetail]
	([ParentGuid],[Caption],[Old],[New],[Tbl])
	Select Top 1
		@Guid,
		' ' as [Caption],
		D.[PostedDefCreditAccountGuid] as [old],
		N.[PostedDefCreditAccountGuid] as [New],
		'[Account]'
	From
		[deleted] d
		inner join [inserted] n on D.Guid = N.Guid
	where
		N.[PostedDefCreditAccountGuid] <> D.[PostedDefCreditAccountGuid]
		
	insert into [TraceDetail]
	([ParentGuid],[Caption],[Old],[New],[Tbl])
	Select Top 1
		@Guid,
		'      ' as [Caption],
		D.[DefCustPosted] as [old],
		N.[DefCustPosted] as [New],
		''
	From
		[deleted] d
		inner join [inserted] n on D.Guid = N.Guid
	where
		N.[DefCustPosted] <> D.[DefCustPosted]
		
	insert into [TraceDetail]
	([ParentGuid],[Caption],[Old],[New],[Tbl])
	Select Top 1
		@Guid,
		'      ' as [Caption],
		D.[PostMoveCostDebit] as [old],
		N.[PostMoveCostDebit] as [New],
		''
	From
		[deleted] d
		inner join [inserted] n on D.Guid = N.Guid
	where
		N.[PostMoveCostDebit] <> D.[PostMoveCostDebit]
		
	insert into [TraceDetail]
	([ParentGuid],[Caption],[Old],[New],[Tbl])
	Select Top 1
		@Guid,
		'      ' as [Caption],
		D.[PostMoveCostCredit] as [old],
		N.[PostMoveCostCredit] as [New],
		''
	From
		[deleted] d
		inner join [inserted] n on D.Guid = N.Guid
	where
		N.[PostMoveCostCredit] <> D.[PostMoveCostCredit]
		
	insert into [TraceDetail]
	([ParentGuid],[Caption],[Old],[New],[Tbl])
	Select Top 1
		@Guid,
		' ' as [Caption],
		D.[collected] as [old],
		N.[collected] as [New],
		''
	From
		[deleted] d
		inner join [inserted] n on D.Guid = N.Guid
	where
		N.[collected] <> D.[collected]
		
	insert into [TraceDetail]
	([ParentGuid],[Caption],[Old],[New],[Tbl])
	Select Top 1
		@Guid,
		'  ' as [Caption],
		D.[collectedCreatedEntry] as [old],
		N.[collectedCreatedEntry] as [New],
		''
	From
		[deleted] d
		inner join [inserted] n on D.Guid = N.Guid
	where
		N.[collectedCreatedEntry] <> D.[collectedCreatedEntry]
		
	insert into [TraceDetail]
	([ParentGuid],[Caption],[Old],[New],[Tbl])
	Select Top 1
		@Guid,
		'    ' as [Caption],
		D.[collectedAutoCreatedEntry] as [old],
		N.[collectedAutoCreatedEntry] as [New],
		''
	From
		[deleted] d
		inner join [inserted] n on D.Guid = N.Guid
	where
		N.[collectedAutoCreatedEntry] <> D.[collectedAutoCreatedEntry]
		
	insert into [TraceDetail]
	([ParentGuid],[Caption],[Old],[New],[Tbl])
	Select Top 1
		@Guid,
		'  ' as [Caption],
		D.[CollectedEntryTypeGuid] as [old],
		N.[CollectedEntryTypeGuid] as [New],
		''
	From
		[deleted] d
		inner join [inserted] n on D.Guid = N.Guid
	where
		N.[CollectedEntryTypeGuid] <> D.[CollectedEntryTypeGuid]
		
	insert into [TraceDetail]
	([ParentGuid],[Caption],[Old],[New],[Tbl])
	Select Top 1
		@Guid,
		'   ' as [Caption],
		D.[collectedAutoPostedEntry] as [old],
		N.[collectedAutoPostedEntry] as [New],
		''
	From
		[deleted] d
		inner join [inserted] n on D.Guid = N.Guid
	where
		N.[collectedAutoPostedEntry] <> D.[collectedAutoPostedEntry]
		
	insert into [TraceDetail]
	([ParentGuid],[Caption],[Old],[New],[Tbl])
	Select Top 1
		@Guid,
		'      ' as [Caption],
		D.[collectedSanctionCustObverse] as [old],
		N.[collectedSanctionCustObverse] as [New],
		''
	From
		[deleted] d
		inner join [inserted] n on D.Guid = N.Guid
	where
		N.[collectedSanctionCustObverse] <> D.[collectedSanctionCustObverse]
		
	insert into [TraceDetail]
	([ParentGuid],[Caption],[Old],[New],[Tbl])
	Select Top 1
		@Guid,
		' ' as [Caption],
		D.[collectedDefAccountGuid] as [old],
		N.[collectedDefAccountGuid] as [New],
		'[Account]'
	From
		[deleted] d
		inner join [inserted] n on D.Guid = N.Guid
	where
		N.[collectedDefAccountGuid] <> D.[collectedDefAccountGuid]
		
	insert into [TraceDetail]
	([ParentGuid],[Caption],[Old],[New],[Tbl])
	Select Top 1
		@Guid,
		' ' as [Caption],
		D.[collectedDefAccountObverseGuid] as [old],
		N.[collectedDefAccountObverseGuid] as [New],
		'[Account]'
	From
		[deleted] d
		inner join [inserted] n on D.Guid = N.Guid
	where
		N.[collectedDefAccountObverseGuid] <> D.[collectedDefAccountObverseGuid]
		
	insert into [TraceDetail]
	([ParentGuid],[Caption],[Old],[New],[Tbl])
	Select Top 1
		@Guid,
		'  ' as [Caption],
		D.[CommAccountDebitGuid] as [old],
		N.[CommAccountDebitGuid] as [New],
		'[Account]'
	From
		[deleted] d
		inner join [inserted] n on D.Guid = N.Guid
	where
		N.[CommAccountDebitGuid] <> D.[CommAccountDebitGuid]
		
	insert into [TraceDetail]
	([ParentGuid],[Caption],[Old],[New],[Tbl])
	Select Top 1
		@Guid,
		'  ' as [Caption],
		D.[CommAccountCreditGuid] as [old],
		N.[CommAccountCreditGuid] as [New],
		'[Account]'
	From
		[deleted] d
		inner join [inserted] n on D.Guid = N.Guid
	where
		N.[CommAccountCreditGuid] <> D.[CommAccountCreditGuid]
		
	insert into [TraceDetail]
	([ParentGuid],[Caption],[Old],[New],[Tbl])
	Select Top 1
		@Guid,
		' ' as [Caption],
		D.[CommType] as [old],
		N.[CommType] as [New],
		''
	From
		[deleted] d
		inner join [inserted] n on D.Guid = N.Guid
	where
		N.[CommType] <> D.[CommType]
		
	insert into [TraceDetail]
	([ParentGuid],[Caption],[Old],[New],[Tbl])
	Select Top 1
		@Guid,
		'     ' as [Caption],
		D.[collectedMoveCostDebit] as [old],
		N.[collectedMoveCostDebit] as [New],
		''
	From
		[deleted] d
		inner join [inserted] n on D.Guid = N.Guid
	where
		N.[collectedMoveCostDebit] <> D.[collectedMoveCostDebit]
		
	insert into [TraceDetail]
	([ParentGuid],[Caption],[Old],[New],[Tbl])
	Select Top 1
		@Guid,
		'      ' as [Caption],
		D.[collectedMoveCostCredit] as [old],
		N.[collectedMoveCostCredit] as [New],
		''
	From
		[deleted] d
		inner join [inserted] n on D.Guid = N.Guid
	where
		N.[collectedMoveCostCredit] <> D.[collectedMoveCostCredit]
		
	insert into [TraceDetail]
	([ParentGuid],[Caption],[Old],[New],[Tbl])
	Select Top 1
		@Guid,
		'      ' as [Caption],
		D.[CommMoveCost] as [old],
		N.[CommMoveCost] as [New],
		''
	From
		[deleted] d
		inner join [inserted] n on D.Guid = N.Guid
	where
		N.[CommMoveCost] <> D.[CommMoveCost]
		
	insert into [TraceDetail]
	([ParentGuid],[Caption],[Old],[New],[Tbl])
	Select Top 1
		@Guid,
		'      ' as [Caption],
		D.[CommMoveCostCredit] as [old],
		N.[CommMoveCostCredit] as [New],
		''
	From
		[deleted] d
		inner join [inserted] n on D.Guid = N.Guid
	where
		N.[CommMoveCostCredit] <> D.[CommMoveCostCredit]
		
	insert into [TraceDetail]
	([ParentGuid],[Caption],[Old],[New],[Tbl])
	Select Top 1
		@Guid,
		'  ' as [Caption],
		D.[partialcollected] as [old],
		N.[partialcollected] as [New],
		''
	From
		[deleted] d
		inner join [inserted] n on D.Guid = N.Guid
	where
		N.[partialcollected] <> D.[partialcollected]
		
	insert into [TraceDetail]
	([ParentGuid],[Caption],[Old],[New],[Tbl])
	Select Top 1
		@Guid,
		'   ' as [Caption],
		D.[partialcollectedCreatedEntry] as [old],
		N.[partialcollectedCreatedEntry] as [New],
		''
	From
		[deleted] d
		inner join [inserted] n on D.Guid = N.Guid
	where
		N.[partialcollectedCreatedEntry] <> D.[partialcollectedCreatedEntry]
		
	insert into [TraceDetail]
	([ParentGuid],[Caption],[Old],[New],[Tbl])
	Select Top 1
		@Guid,
		'     ' as [Caption],
		D.[partialcollectedAutoCreatedEntry] as [old],
		N.[partialcollectedAutoCreatedEntry] as [New],
		''
	From
		[deleted] d
		inner join [inserted] n on D.Guid = N.Guid
	where
		N.[partialcollectedAutoCreatedEntry] <> D.[partialcollectedAutoCreatedEntry]
		
	insert into [TraceDetail]
	([ParentGuid],[Caption],[Old],[New],[Tbl])
	Select Top 1
		@Guid,
		'  ' as [Caption],
		D.[partialCollectedEntryTypeGuid] as [old],
		N.[partialCollectedEntryTypeGuid] as [New],
		''
	From
		[deleted] d
		inner join [inserted] n on D.Guid = N.Guid
	where
		N.[partialCollectedEntryTypeGuid] <> D.[partialCollectedEntryTypeGuid]
		
	insert into [TraceDetail]
	([ParentGuid],[Caption],[Old],[New],[Tbl])
	Select Top 1
		@Guid,
		'     ' as [Caption],
		D.[partialcollectedAutoPostedEntry] as [old],
		N.[partialcollectedAutoPostedEntry] as [New],
		''
	From
		[deleted] d
		inner join [inserted] n on D.Guid = N.Guid
	where
		N.[partialcollectedAutoPostedEntry] <> D.[partialcollectedAutoPostedEntry]
		
	insert into [TraceDetail]
	([ParentGuid],[Caption],[Old],[New],[Tbl])
	Select Top 1
		@Guid,
		'        ' as [Caption],
		D.[partialcollectedSanctionCustObverse] as [old],
		N.[partialcollectedSanctionCustObverse] as [New],
		''
	From
		[deleted] d
		inner join [inserted] n on D.Guid = N.Guid
	where
		N.[partialcollectedSanctionCustObverse] <> D.[partialcollectedSanctionCustObverse]
		
	insert into [TraceDetail]
	([ParentGuid],[Caption],[Old],[New],[Tbl])
	Select Top 1
		@Guid,
		' ' as [Caption],
		D.[partialcollectedDefAccountGuid] as [old],
		N.[partialcollectedDefAccountGuid] as [New],
		'[Account]'
	From
		[deleted] d
		inner join [inserted] n on D.Guid = N.Guid
	where
		N.[partialcollectedDefAccountGuid] <> D.[partialcollectedDefAccountGuid]
		
	insert into [TraceDetail]
	([ParentGuid],[Caption],[Old],[New],[Tbl])
	Select Top 1
		@Guid,
		' ' as [Caption],
		D.[partialcollectedDefAccountObverseGuid] as [old],
		N.[partialcollectedDefAccountObverseGuid] as [New],
		'[Account]'
	From
		[deleted] d
		inner join [inserted] n on D.Guid = N.Guid
	where
		N.[partialcollectedDefAccountObverseGuid] <> D.[partialcollectedDefAccountObverseGuid]
		
	insert into [TraceDetail]
	([ParentGuid],[Caption],[Old],[New],[Tbl])
	Select Top 1
		@Guid,
		'     ' as [Caption],
		D.[partialMoveCostDebit] as [old],
		N.[partialMoveCostDebit] as [New],
		''
	From
		[deleted] d
		inner join [inserted] n on D.Guid = N.Guid
	where
		N.[partialMoveCostDebit] <> D.[partialMoveCostDebit]
		
	insert into [TraceDetail]
	([ParentGuid],[Caption],[Old],[New],[Tbl])
	Select Top 1
		@Guid,
		'     ' as [Caption],
		D.[partialMoveCostCredit] as [old],
		N.[partialMoveCostCredit] as [New],
		''
	From
		[deleted] d
		inner join [inserted] n on D.Guid = N.Guid
	where
		N.[partialMoveCostCredit] <> D.[partialMoveCostCredit]
		
	insert into [TraceDetail]
	([ParentGuid],[Caption],[Old],[New],[Tbl])
	Select Top 1
		@Guid,
		' ' as [Caption],
		D.[Endorsement] as [old],
		N.[Endorsement] as [New],
		''
	From
		[deleted] d
		inner join [inserted] n on D.Guid = N.Guid
	where
		N.[Endorsement] <> D.[Endorsement]
		
	insert into [TraceDetail]
	([ParentGuid],[Caption],[Old],[New],[Tbl])
	Select Top 1
		@Guid,
		'  ' as [Caption],
		D.[EndorsementCreatedEntry] as [old],
		N.[EndorsementCreatedEntry] as [New],
		''
	From
		[deleted] d
		inner join [inserted] n on D.Guid = N.Guid
	where
		N.[EndorsementCreatedEntry] <> D.[EndorsementCreatedEntry]
		
	insert into [TraceDetail]
	([ParentGuid],[Caption],[Old],[New],[Tbl])
	Select Top 1
		@Guid,
		'    ' as [Caption],
		D.[EndorsementAutoCreatedEntry] as [old],
		N.[EndorsementAutoCreatedEntry] as [New],
		''
	From
		[deleted] d
		inner join [inserted] n on D.Guid = N.Guid
	where
		N.[EndorsementAutoCreatedEntry] <> D.[EndorsementAutoCreatedEntry]
		
	insert into [TraceDetail]
	([ParentGuid],[Caption],[Old],[New],[Tbl])
	Select Top 1
		@Guid,
		'   ' as [Caption],
		D.[EndorsementAutoPostedEntry] as [old],
		N.[EndorsementAutoPostedEntry] as [New],
		''
	From
		[deleted] d
		inner join [inserted] n on D.Guid = N.Guid
	where
		N.[EndorsementAutoPostedEntry] <> D.[EndorsementAutoPostedEntry]
		
	insert into [TraceDetail]
	([ParentGuid],[Caption],[Old],[New],[Tbl])
	Select Top 1
		@Guid,
		' ' as [Caption],
		D.[EndorsementDefAccountDebitGuid] as [old],
		N.[EndorsementDefAccountDebitGuid] as [New],
		'[Account]'
	From
		[deleted] d
		inner join [inserted] n on D.Guid = N.Guid
	where
		N.[EndorsementDefAccountDebitGuid] <> D.[EndorsementDefAccountDebitGuid]
		
	insert into [TraceDetail]
	([ParentGuid],[Caption],[Old],[New],[Tbl])
	Select Top 1
		@Guid,
		' ' as [Caption],
		D.[EndorsementDefAccountCreateGuid] as [old],
		N.[EndorsementDefAccountCreateGuid] as [New],
		'[Account]'
	From
		[deleted] d
		inner join [inserted] n on D.Guid = N.Guid
	where
		N.[EndorsementDefAccountCreateGuid] <> D.[EndorsementDefAccountCreateGuid]
		
	insert into [TraceDetail]
	([ParentGuid],[Caption],[Old],[New],[Tbl])
	Select Top 1
		@Guid,
		'     ' as [Caption],
		D.[EndorsementMoveCostDebit] as [old],
		N.[EndorsementMoveCostDebit] as [New],
		''
	From
		[deleted] d
		inner join [inserted] n on D.Guid = N.Guid
	where
		N.[EndorsementMoveCostDebit] <> D.[EndorsementMoveCostDebit]
		
	insert into [TraceDetail]
	([ParentGuid],[Caption],[Old],[New],[Tbl])
	Select Top 1
		@Guid,
		'     ' as [Caption],
		D.[EndorsementMoveCostCredit] as [old],
		N.[EndorsementMoveCostCredit] as [New],
		''
	From
		[deleted] d
		inner join [inserted] n on D.Guid = N.Guid
	where
		N.[EndorsementMoveCostCredit] <> D.[EndorsementMoveCostCredit]
		
	insert into [TraceDetail]
	([ParentGuid],[Caption],[Old],[New],[Tbl])
	Select Top 1
		@Guid,
		' ' as [Caption],
		D.[Returned] as [old],
		N.[Returned] as [New],
		''
	From
		[deleted] d
		inner join [inserted] n on D.Guid = N.Guid
	where
		N.[Returned] <> D.[Returned]
		
	insert into [TraceDetail]
	([ParentGuid],[Caption],[Old],[New],[Tbl])
	Select Top 1
		@Guid,
		'  ' as [Caption],
		D.[ReturnedCreatedEntry] as [old],
		N.[ReturnedCreatedEntry] as [New],
		''
	From
		[deleted] d
		inner join [inserted] n on D.Guid = N.Guid
	where
		N.[ReturnedCreatedEntry] <> D.[ReturnedCreatedEntry]
		
	insert into [TraceDetail]
	([ParentGuid],[Caption],[Old],[New],[Tbl])
	Select Top 1
		@Guid,
		'     ' as [Caption],
		D.[ReturnedAutoCreatedEntry] as [old],
		N.[ReturnedAutoCreatedEntry] as [New],
		''
	From
		[deleted] d
		inner join [inserted] n on D.Guid = N.Guid
	where
		N.[ReturnedAutoCreatedEntry] <> D.[ReturnedAutoCreatedEntry]
		
	insert into [TraceDetail]
	([ParentGuid],[Caption],[Old],[New],[Tbl])
	Select Top 1
		@Guid,
		'   ' as [Caption],
		D.[ReturnedAutoPostedEntry] as [old],
		N.[ReturnedAutoPostedEntry] as [New],
		''
	From
		[deleted] d
		inner join [inserted] n on D.Guid = N.Guid
	where
		N.[ReturnedAutoPostedEntry] <> D.[ReturnedAutoPostedEntry]
		
	insert into [TraceDetail]
	([ParentGuid],[Caption],[Old],[New],[Tbl])
	Select Top 1
		@Guid,
		'   /    ' as [Caption],
		D.[ReturnedSanctionCustAccountDefAccount] as [old],
		N.[ReturnedSanctionCustAccountDefAccount] as [New],
		''
	From
		[deleted] d
		inner join [inserted] n on D.Guid = N.Guid
	where
		N.[ReturnedSanctionCustAccountDefAccount] <> D.[ReturnedSanctionCustAccountDefAccount]
		
	insert into [TraceDetail]
	([ParentGuid],[Caption],[Old],[New],[Tbl])
	Select Top 1
		@Guid,
		' ' as [Caption],
		D.[ReturnedDefAccountGuid] as [old],
		N.[ReturnedDefAccountGuid] as [New],
		'[Account]'
	From
		[deleted] d
		inner join [inserted] n on D.Guid = N.Guid
	where
		N.[ReturnedDefAccountGuid] <> D.[ReturnedDefAccountGuid]
		
	insert into [TraceDetail]
	([ParentGuid],[Caption],[Old],[New],[Tbl])
	Select Top 1
		@Guid,
		' ' as [Caption],
		D.[ReturnedDefAccountCreditGuid] as [old],
		N.[ReturnedDefAccountCreditGuid] as [New],
		'[Account]'
	From
		[deleted] d
		inner join [inserted] n on D.Guid = N.Guid
	where
		N.[ReturnedDefAccountCreditGuid] <> D.[ReturnedDefAccountCreditGuid]
		
	insert into [TraceDetail]
	([ParentGuid],[Caption],[Old],[New],[Tbl])
	Select Top 1
		@Guid,
		'      ' as [Caption],
		D.[EnableAtherOperationOnReturn] as [old],
		N.[EnableAtherOperationOnReturn] as [New],
		''
	From
		[deleted] d
		inner join [inserted] n on D.Guid = N.Guid
	where
		N.[EnableAtherOperationOnReturn] <> D.[EnableAtherOperationOnReturn]
		
	insert into [TraceDetail]
	([ParentGuid],[Caption],[Old],[New],[Tbl])
	Select Top 1
		@Guid,
		'     ' as [Caption],
		D.[ReturnMoveCostDebit] as [old],
		N.[ReturnMoveCostDebit] as [New],
		''
	From
		[deleted] d
		inner join [inserted] n on D.Guid = N.Guid
	where
		N.[ReturnMoveCostDebit] <> D.[ReturnMoveCostDebit]
		
	insert into [TraceDetail]
	([ParentGuid],[Caption],[Old],[New],[Tbl])
	Select Top 1
		@Guid,
		'     ' as [Caption],
		D.[ReturnMoveCostCredit] as [old],
		N.[ReturnMoveCostCredit] as [New],
		''
	From
		[deleted] d
		inner join [inserted] n on D.Guid = N.Guid
	where
		N.[ReturnMoveCostCredit] <> D.[ReturnMoveCostCredit]
		
	insert into [TraceDetail]
	([ParentGuid],[Caption],[Old],[New],[Tbl])
	Select Top 1
		@Guid,
		' ' as [Caption],
		D.[delayDefAccountGuid] as [old],
		N.[delayDefAccountGuid] as [New],
		'[Account]'
	From
		[deleted] d
		inner join [inserted] n on D.Guid = N.Guid
	where
		N.[delayDefAccountGuid] <> D.[delayDefAccountGuid]
		
	insert into [TraceDetail]
	([ParentGuid],[Caption],[Old],[New],[Tbl])
	Select Top 1
		@Guid,
		' ' as [Caption],
		D.[delayDefAccountObverseGuid] as [old],
		N.[delayDefAccountObverseGuid] as [New],
		'[Account]'
	From
		[deleted] d
		inner join [inserted] n on D.Guid = N.Guid
	where
		N.[delayDefAccountObverseGuid] <> D.[delayDefAccountObverseGuid]
		
	insert into [TraceDetail]
	([ParentGuid],[Caption],[Old],[New],[Tbl])
	Select Top 1
		@Guid,
		'   /     ' as [Caption],
		D.[delaySanctionCustAccountDefAccount] as [old],
		N.[delaySanctionCustAccountDefAccount] as [New],
		''
	From
		[deleted] d
		inner join [inserted] n on D.Guid = N.Guid
	where
		N.[delaySanctionCustAccountDefAccount] <> D.[delaySanctionCustAccountDefAccount]
		
	insert into [TraceDetail]
	([ParentGuid],[Caption],[Old],[New],[Tbl])
	Select Top 1
		@Guid,
		'  ' as [Caption],
		D.[DefPrintPath] as [old],
		N.[DefPrintPath] as [New],
		''
	From
		[deleted] d
		inner join [inserted] n on D.Guid = N.Guid
	where
		N.[DefPrintPath] <> D.[DefPrintPath]
		
	insert into [TraceDetail]
	([ParentGuid],[Caption],[Old],[New],[Tbl])
	Select Top 1
		@Guid,
		'  ' as [Caption],
		D.[NoteForm1] as [old],
		N.[NoteForm1] as [New],
		''
	From
		[deleted] d
		inner join [inserted] n on D.Guid = N.Guid
	where
		N.[NoteForm1] <> D.[NoteForm1]
		
	insert into [TraceDetail]
	([ParentGuid],[Caption],[Old],[New],[Tbl])
	Select Top 1
		@Guid,
		'  ' as [Caption],
		D.[LtnNoteForm1] as [old],
		N.[LtnNoteForm1] as [New],
		''
	From
		[deleted] d
		inner join [inserted] n on D.Guid = N.Guid
	where
		N.[LtnNoteForm1] <> D.[LtnNoteForm1]
		
	insert into [TraceDetail]
	([ParentGuid],[Caption],[Old],[New],[Tbl])
	Select Top 1
		@Guid,
		'  ' as [Caption],
		D.[NoteForm2] as [old],
		N.[NoteForm2] as [New],
		''
	From
		[deleted] d
		inner join [inserted] n on D.Guid = N.Guid
	where
		N.[NoteForm2] <> D.[NoteForm2]
		
	insert into [TraceDetail]
	([ParentGuid],[Caption],[Old],[New],[Tbl])
	Select Top 1
		@Guid,
		'   ' as [Caption],
		D.[LtnNoteForm2] as [old],
		N.[LtnNoteForm2] as [New],
		''
	From
		[deleted] d
		inner join [inserted] n on D.Guid = N.Guid
	where
		N.[LtnNoteForm2] <> D.[LtnNoteForm2]
		
	insert into [TraceDetail]
	([ParentGuid],[Caption],[Old],[New],[Tbl])
	Select Top 1
		@Guid,
		' ' as [Caption],
		D.[NotePosted] as [old],
		N.[NotePosted] as [New],
		''
	From
		[deleted] d
		inner join [inserted] n on D.Guid = N.Guid
	where
		N.[NotePosted] <> D.[NotePosted]
		
	insert into [TraceDetail]
	([ParentGuid],[Caption],[Old],[New],[Tbl])
	Select Top 1
		@Guid,
		'  ' as [Caption],
		D.[LtnNotePosted] as [old],
		N.[LtnNotePosted] as [New],
		''
	From
		[deleted] d
		inner join [inserted] n on D.Guid = N.Guid
	where
		N.[LtnNotePosted] <> D.[LtnNotePosted]
		
	insert into [TraceDetail]
	([ParentGuid],[Caption],[Old],[New],[Tbl])
	Select Top 1
		@Guid,
		' ' as [Caption],
		D.[Notecollected] as [old],
		N.[Notecollected] as [New],
		''
	From
		[deleted] d
		inner join [inserted] n on D.Guid = N.Guid
	where
		N.[Notecollected] <> D.[Notecollected]
		
	insert into [TraceDetail]
	([ParentGuid],[Caption],[Old],[New],[Tbl])
	Select Top 1
		@Guid,
		'  ' as [Caption],
		D.[LtnNotecollected] as [old],
		N.[LtnNotecollected] as [New],
		''
	From
		[deleted] d
		inner join [inserted] n on D.Guid = N.Guid
	where
		N.[LtnNotecollected] <> D.[LtnNotecollected]
		
	insert into [TraceDetail]
	([ParentGuid],[Caption],[Old],[New],[Tbl])
	Select Top 1
		@Guid,
		'  ' as [Caption],
		D.[NotecollectedPartial] as [old],
		N.[NotecollectedPartial] as [New],
		''
	From
		[deleted] d
		inner join [inserted] n on D.Guid = N.Guid
	where
		N.[NotecollectedPartial] <> D.[NotecollectedPartial]
		
	insert into [TraceDetail]
	([ParentGuid],[Caption],[Old],[New],[Tbl])
	Select Top 1
		@Guid,
		'   ' as [Caption],
		D.[LtnNotecollectedPartial] as [old],
		N.[LtnNotecollectedPartial] as [New],
		''
	From
		[deleted] d
		inner join [inserted] n on D.Guid = N.Guid
	where
		N.[LtnNotecollectedPartial] <> D.[LtnNotecollectedPartial]
		
	insert into [TraceDetail]
	([ParentGuid],[Caption],[Old],[New],[Tbl])
	Select Top 1
		@Guid,
		' ' as [Caption],
		D.[NoteEndorsement] as [old],
		N.[NoteEndorsement] as [New],
		''
	From
		[deleted] d
		inner join [inserted] n on D.Guid = N.Guid
	where
		N.[NoteEndorsement] <> D.[NoteEndorsement]
		
	insert into [TraceDetail]
	([ParentGuid],[Caption],[Old],[New],[Tbl])
	Select Top 1
		@Guid,
		'  ' as [Caption],
		D.[LtnNoteEndorsement] as [old],
		N.[LtnNoteEndorsement] as [New],
		''
	From
		[deleted] d
		inner join [inserted] n on D.Guid = N.Guid
	where
		N.[LtnNoteEndorsement] <> D.[LtnNoteEndorsement]
		
	insert into [TraceDetail]
	([ParentGuid],[Caption],[Old],[New],[Tbl])
	Select Top 1
		@Guid,
		' ' as [Caption],
		D.[NoteReturn] as [old],
		N.[NoteReturn] as [New],
		''
	From
		[deleted] d
		inner join [inserted] n on D.Guid = N.Guid
	where
		N.[NoteReturn] <> D.[NoteReturn]
		
	insert into [TraceDetail]
	([ParentGuid],[Caption],[Old],[New],[Tbl])
	Select Top 1
		@Guid,
		'  ' as [Caption],
		D.[LtnNoteReturn] as [old],
		N.[LtnNoteReturn] as [New],
		''
	From
		[deleted] d
		inner join [inserted] n on D.Guid = N.Guid
	where
		N.[LtnNoteReturn] <> D.[LtnNoteReturn]
		
	insert into [TraceDetail]
	([ParentGuid],[Caption],[Old],[New],[Tbl])
	Select Top 1
		@Guid,
		' ' as [Caption],
		D.[PostedDate] as [old],
		N.[PostedDate] as [New],
		''
	From
		[deleted] d
		inner join [inserted] n on D.Guid = N.Guid
	where
		N.[PostedDate] <> D.[PostedDate]
		
	insert into [TraceDetail]
	([ParentGuid],[Caption],[Old],[New],[Tbl])
	Select Top 1
		@Guid,
		' ' as [Caption],
		D.[partialcollectedDate] as [old],
		N.[partialcollectedDate] as [New],
		''
	From
		[deleted] d
		inner join [inserted] n on D.Guid = N.Guid
	where
		N.[partialcollectedDate] <> D.[partialcollectedDate]
		
	insert into [TraceDetail]
	([ParentGuid],[Caption],[Old],[New],[Tbl])
	Select Top 1
		@Guid,
		' ' as [Caption],
		D.[collectedDate] as [old],
		N.[collectedDate] as [New],
		''
	From
		[deleted] d
		inner join [inserted] n on D.Guid = N.Guid
	where
		N.[collectedDate] <> D.[collectedDate]
		
	insert into [TraceDetail]
	([ParentGuid],[Caption],[Old],[New],[Tbl])
	Select Top 1
		@Guid,
		' ' as [Caption],
		D.[EndorsementDate] as [old],
		N.[EndorsementDate] as [New],
		''
	From
		[deleted] d
		inner join [inserted] n on D.Guid = N.Guid
	where
		N.[EndorsementDate] <> D.[EndorsementDate]
		
	insert into [TraceDetail]
	([ParentGuid],[Caption],[Old],[New],[Tbl])
	Select Top 1
		@Guid,
		' ' as [Caption],
		D.[ReturnedDate] as [old],
		N.[ReturnedDate] as [New],
		''
	From
		[deleted] d
		inner join [inserted] n on D.Guid = N.Guid
	where
		N.[ReturnedDate] <> D.[ReturnedDate]
		
	insert into [TraceDetail]
	([ParentGuid],[Caption],[Old],[New],[Tbl])
	Select Top 1
		@Guid,
		'  ' as [Caption],
		D.[AutoSMSAfterAdd] as [old],
		N.[AutoSMSAfterAdd] as [New],
		''
	From
		[deleted] d
		inner join [inserted] n on D.Guid = N.Guid
	where
		N.[AutoSMSAfterAdd] <> D.[AutoSMSAfterAdd]
		
	insert into [TraceDetail]
	([ParentGuid],[Caption],[Old],[New],[Tbl])
	Select Top 1
		@Guid,
		'  ' as [Caption],
		D.[SMSMsg] as [old],
		N.[SMSMsg] as [New],
		''
	From
		[deleted] d
		inner join [inserted] n on D.Guid = N.Guid
	where
		N.[SMSMsg] <> D.[SMSMsg]
		
	insert into [TraceDetail]
	([ParentGuid],[Caption],[Old],[New],[Tbl])
	Select Top 1
		@Guid,
		'  ' as [Caption],
		D.[SMSMsgEn] as [old],
		N.[SMSMsgEn] as [New],
		''
	From
		[deleted] d
		inner join [inserted] n on D.Guid = N.Guid
	where
		N.[SMSMsgEn] <> D.[SMSMsgEn]
		
	insert into [TraceDetail]
	([ParentGuid],[Caption],[Old],[New],[Tbl])
	Select Top 1
		@Guid,
		'   ' as [Caption],
		D.[SMSChecksCollectionAutoSend] as [old],
		N.[SMSChecksCollectionAutoSend] as [New],
		''
	From
		[deleted] d
		inner join [inserted] n on D.Guid = N.Guid
	where
		N.[SMSChecksCollectionAutoSend] <> D.[SMSChecksCollectionAutoSend]
		
	insert into [TraceDetail]
	([ParentGuid],[Caption],[Old],[New],[Tbl])
	Select Top 1
		@Guid,
		'       ' as [Caption],
		D.[SMSChecksCollectionImmediate] as [old],
		N.[SMSChecksCollectionImmediate] as [New],
		''
	From
		[deleted] d
		inner join [inserted] n on D.Guid = N.Guid
	where
		N.[SMSChecksCollectionImmediate] <> D.[SMSChecksCollectionImmediate]
		
	insert into [TraceDetail]
	([ParentGuid],[Caption],[Old],[New],[Tbl])
	Select Top 1
		@Guid,
		'         ' as [Caption],
		D.[SMSChecksCollectionDay] as [old],
		N.[SMSChecksCollectionDay] as [New],
		''
	From
		[deleted] d
		inner join [inserted] n on D.Guid = N.Guid
	where
		N.[SMSChecksCollectionDay] <> D.[SMSChecksCollectionDay]
		
	insert into [TraceDetail]
	([ParentGuid],[Caption],[Old],[New],[Tbl])
	Select Top 1
		@Guid,
		'  ' as [Caption],
		D.[SMSChecksCollectionMsg] as [old],
		N.[SMSChecksCollectionMsg] as [New],
		''
	From
		[deleted] d
		inner join [inserted] n on D.Guid = N.Guid
	where
		N.[SMSChecksCollectionMsg] <> D.[SMSChecksCollectionMsg]
		
	insert into [TraceDetail]
	([ParentGuid],[Caption],[Old],[New],[Tbl])
	Select Top 1
		@Guid,
		'  ' as [Caption],
		D.[SMSChecksCollectionMsgEN] as [old],
		N.[SMSChecksCollectionMsgEN] as [New],
		''
	From
		[deleted] d
		inner join [inserted] n on D.Guid = N.Guid
	where
		N.[SMSChecksCollectionMsgEN] <> D.[SMSChecksCollectionMsgEN]
		
	insert into [TraceDetail]
	([ParentGuid],[Caption],[Old],[New],[Tbl])
	Select Top 1
		@Guid,
		'    ' as [Caption],
		D.[SMSChecksPartialCollectionAutoSend] as [old],
		N.[SMSChecksPartialCollectionAutoSend] as [New],
		''
	From
		[deleted] d
		inner join [inserted] n on D.Guid = N.Guid
	where
		N.[SMSChecksPartialCollectionAutoSend] <> D.[SMSChecksPartialCollectionAutoSend]
		
	insert into [TraceDetail]
	([ParentGuid],[Caption],[Old],[New],[Tbl])
	Select Top 1
		@Guid,
		'  ' as [Caption],
		D.[SMSChecksPartialCollectionMsg] as [old],
		N.[SMSChecksPartialCollectionMsg] as [New],
		''
	From
		[deleted] d
		inner join [inserted] n on D.Guid = N.Guid
	where
		N.[SMSChecksPartialCollectionMsg] <> D.[SMSChecksPartialCollectionMsg]
		
	insert into [TraceDetail]
	([ParentGuid],[Caption],[Old],[New],[Tbl])
	Select Top 1
		@Guid,
		'  ' as [Caption],
		D.[SMSChecksPartialCollectionMsgEN] as [old],
		N.[SMSChecksPartialCollectionMsgEN] as [New],
		''
	From
		[deleted] d
		inner join [inserted] n on D.Guid = N.Guid
	where
		N.[SMSChecksPartialCollectionMsgEN] <> D.[SMSChecksPartialCollectionMsgEN]
		
	insert into [TraceDetail]
	([ParentGuid],[Caption],[Old],[New],[Tbl])
	Select Top 1
		@Guid,
		'   ' as [Caption],
		D.[SMSCheckReturnAutoSend] as [old],
		N.[SMSCheckReturnAutoSend] as [New],
		''
	From
		[deleted] d
		inner join [inserted] n on D.Guid = N.Guid
	where
		N.[SMSCheckReturnAutoSend] <> D.[SMSCheckReturnAutoSend]
		
	insert into [TraceDetail]
	([ParentGuid],[Caption],[Old],[New],[Tbl])
	Select Top 1
		@Guid,
		'       ' as [Caption],
		D.[SMSCheckReturnImmediate] as [old],
		N.[SMSCheckReturnImmediate] as [New],
		''
	From
		[deleted] d
		inner join [inserted] n on D.Guid = N.Guid
	where
		N.[SMSCheckReturnImmediate] <> D.[SMSCheckReturnImmediate]
		
	insert into [TraceDetail]
	([ParentGuid],[Caption],[Old],[New],[Tbl])
	Select Top 1
		@Guid,
		'         ' as [Caption],
		D.[SMSCheckReturnDay] as [old],
		N.[SMSCheckReturnDay] as [New],
		''
	From
		[deleted] d
		inner join [inserted] n on D.Guid = N.Guid
	where
		N.[SMSCheckReturnDay] <> D.[SMSCheckReturnDay]
		
	insert into [TraceDetail]
	([ParentGuid],[Caption],[Old],[New],[Tbl])
	Select Top 1
		@Guid,
		'  ' as [Caption],
		D.[SMSCheckReturnMsg] as [old],
		N.[SMSCheckReturnMsg] as [New],
		''
	From
		[deleted] d
		inner join [inserted] n on D.Guid = N.Guid
	where
		N.[SMSCheckReturnMsg] <> D.[SMSCheckReturnMsg]
		
	insert into [TraceDetail]
	([ParentGuid],[Caption],[Old],[New],[Tbl])
	Select Top 1
		@Guid,
		'  ' as [Caption],
		D.[SMSCheckReturnMsgEn] as [old],
		N.[SMSCheckReturnMsgEn] as [New],
		''
	From
		[deleted] d
		inner join [inserted] n on D.Guid = N.Guid
	where
		N.[SMSCheckReturnMsgEn] <> D.[SMSCheckReturnMsgEn]
		
	insert into [TraceDetail]
	([ParentGuid],[Caption],[Old],[New],[Tbl])
	Select Top 1
		@Guid,
		'      ' as [Caption],
		D.[SMSChecksDue] as [old],
		N.[SMSChecksDue] as [New],
		''
	From
		[deleted] d
		inner join [inserted] n on D.Guid = N.Guid
	where
		N.[SMSChecksDue] <> D.[SMSChecksDue]
		
	insert into [TraceDetail]
	([ParentGuid],[Caption],[Old],[New],[Tbl])
	Select Top 1
		@Guid,
		' ' as [Caption],
		D.[SMSChecksDueDay] as [old],
		N.[SMSChecksDueDay] as [New],
		''
	From
		[deleted] d
		inner join [inserted] n on D.Guid = N.Guid
	where
		N.[SMSChecksDueDay] <> D.[SMSChecksDueDay]
		
	insert into [TraceDetail]
	([ParentGuid],[Caption],[Old],[New],[Tbl])
	Select Top 1
		@Guid,
		'  ' as [Caption],
		D.[SMSChecksDueMsg] as [old],
		N.[SMSChecksDueMsg] as [New],
		''
	From
		[deleted] d
		inner join [inserted] n on D.Guid = N.Guid
	where
		N.[SMSChecksDueMsg] <> D.[SMSChecksDueMsg]
		
	insert into [TraceDetail]
	([ParentGuid],[Caption],[Old],[New],[Tbl])
	Select Top 1
		@Guid,
		'  ' as [Caption],
		D.[SMSChecksDueMsgEn] as [old],
		N.[SMSChecksDueMsgEn] as [New],
		''
	From
		[deleted] d
		inner join [inserted] n on D.Guid = N.Guid
	where
		N.[SMSChecksDueMsgEn] <> D.[SMSChecksDueMsgEn]
		
	delete Trace From Trace t left join [TraceDetail] D on T.guid = D.ParentGuid
	where
		d.ParentGuid is Null and t.Guid = @Guid


GO

SET ANSI_NULLS, QUOTED_IDENTIFIER ON
GO

Create Procedure [RepParkingRent]
(
	@ParkingNo Varchar(256) = ''
	,@Emirate Varchar(256) = ''
	,@Suburb Varchar(256) = ''
	,@Area Varchar(256) = ''
	,@Street Varchar(256) = ''
	,@RentState int = 2
	,@ContractState int = 2
	,@CustGuid uniqueidentifier = 0x0
	,@Datewith int = 0
	,@Date1 DateTime = '12/30/1899'
	,@Date2 DateTime = '12/30/1899'
	,@RentInfoGuid uniqueidentifier = 0x0
	,@SalesManGuid uniqueidentifier = 0x0
	,@Judicial int = 2
	,@Nationality Varchar(256) = ''
	,@CheckDate Bit = 0
	,@ShowAccumulate Bit = 0
	,@ShowAccumulateEndContract Bit = 1
	,@BanRealty int = 2
	,@ContractValue int = 2
)
 
as
	
	--    
	Select
		[ParkingGuid],
		Max([FromDate]) as [FromDate]
	Into #LastContract	
	From
		[ParkingContract]
	Group By
		[ParkingGuid]

	Select 
		Case 
			when [ContractFinish] = 0 and [ToDate] >= GetDate() then [ToDate]
			when [ContractFinish] = 0 and [ToDate] < GetDate() then GetDate()
			when [ContractFinish] = 1  then [ContractFinishDate]
		end as [EndContractDate],
		[C].*
	Into #ParkingContract
	From
		[ParkingContract] [C]
		inner join #LastContract [L] on [L].[ParkingGuid] = [C].[ParkingGuid] and [L].[FromDate] = [C].[FromDate]
		Inner join [Resource] [R] on [R].[Guid] = [C].BuildingGuid and [spid] = @@Spid
	where
		 (
				(([C].Rent - [C].DiscountValue) <> 0 and @ContractValue = 0) or
				(([C].Rent - [C].DiscountValue) = 0 and @ContractValue = 1) or
				@ContractValue = 2
			)
	
		
	--Select * from #ParkingContract
	

	Select Distinct
		Pc.[ParkingContractGuid],
		ac.ApartmentNo
	into #LinkParking
	From
		[LinkParkingContract] Pc
		inner join [vwLeaseApartment] Ac on Ac.Guid = pc.ParentGuid
		inner join [#ParkingContract] L on pc.[ParkingContractGuid] = L.Guid
		
	
	Select 
		[A].[Number],
		[A].[No] as [ParkingNo]
		,[B].[Name] as [BuildingName]

		,Case when [L].[ContractFinish] = 0 then  dbo.sc('') 
			  else dbo.SC(' ') 
		end as [State]

		
		,Case when [L].[ContractFinish] = 0 then
			 Case when (([L].[ToDate] <= GetDate()) or ([L].[ContractFinish] = 1)) or (@Date2 > [L].[ToDate]) then dbo.sc(' ')  
				  when ([L].[ToDate] > GetDate()) and ([L].[ContractFinish] = 0) then dbo.sc('  ')  end 
		 end as [ContractState]

		,[B].[Emirate] as [BuildingEmirate]
		,[B].[Suburb] as [Suburb]
		,[B].[Area] as [Area]
		,[B].[Street] as [Street]
		,[Cu].[Name] as [CustName]
		,[Cu].[Mobile] as [CustPhone]
		,[Cu].[Nationality] [CustNationality]
		,Case when [L].[ContractFinish] = 0 then [L].[FromDate] end as [ContractDateBegin]
		,Case when [L].[ContractFinish] = 0 then[L].[ToDate] end as [ContractDateEnd]
		,Case when [L].[ContractFinish] = 0 then [L].[Guid] end as [ContractGuid]
		,[Sales].[Number] as SalesNumber
		,[A].[Judicial]
		,[A].[Sale]
		,[A].[Rent]
		,[L].[Description]
		,l.Rent as [ContractRent]
		,Lc.ApartmentNo

		,L.[CardNo]
		,L.[CarNo]
		,L.[CarType]
		,L.[CarColor]
		,L.[Emirate]

		,L.[InsuranceValue]
		,L.[InsuranceValueOld]
		,A.Guid as ParkingGuid
		,[L].[ContractFinish]
	into #TblRarkingRent
	from 
		[vwBuilding] [B]
		Inner join [vwParkingAll] [A] On [A].[BuildingGuid] = [B].[Guid]
		Inner join [Resource] [R] on [R].[Guid] = [B].[Guid] and [spid] = @@Spid
--		left join [#ParkingContract] [L] On [A].[Guid] = [L].[ParkingGuid] --and [ContractKind]  = 4

		left join [#ParkingContract] [L] On [A].[Guid] = [L].[ParkingGuid] and [L].[ContractKind]  = 4

		left join [vwCustomer] [Cu] on [Cu].[Guid] = [L].[CustomerGuid] 
		left join (
					Select
						Max(Number) as [Number],
						[ParkingGuid]
					From
						[ParkingContract]
					where 
						[ContractKind]  = 0
					Group By 
						[ParkingGuid]
					) [LastLease] On [LastLease].[Number] = [L].[Number] and [LastLease].[ParkingGuid] = [L].[ParkingGuid]
		left join (
					Select
						Max(Number) as [Number],
						[ParkingGuid]
					From
						[ParkingContract]
					where 
						[ContractKind]  = 1
					Group By 
						[ParkingGuid]
					) [Sales] On [Sales].[ParkingGuid] = [L].[Guid]
		--  
		left join #LinkParking LC on Lc.[ParkingContractGuid] = L.Guid

	where
 		([Cu].[Guid] = @CustGuid or @CustGuid = 0x0)
		and (Cu.Nationality = @Nationality or @Nationality = '')
		and ([A].[No] = @ParkingNo or @ParkingNo = '')
		And ([B].[Emirate] = @Emirate or @Emirate = '')
		and ([B].[Suburb] = @Suburb or @Suburb = '')
		and ([B].[Area] = @Area or @Area = '')
		and ([B].[Street] = @Street or @Street = '')
		and ([A].[Judicial] = @Judicial or @Judicial = 2)
		and (
  				(Case when [L].[ContractFinish] = 0 then 0 else 1 end = @RentState)
  				or @RentState = 2
			)
		and 
			(
				([L].[ToDate] <= GetDate() and @ContractState = 0)
			  	or ([L].[ToDate] > GetDate() and @ContractState = 1)
				or @ContractState = 2
			)

		and ([L].[RentInfoGuid] = @RentInfoGuid or @RentInfoGuid = 0x0)
		and ([L].[SalesManGuid] = @SalesManGuid or @SalesManGuid = 0x0)
		
		-- 
		and ([Sales].[ParkingGuid] is Null)
		and (A.Ban = @banRealty or @banRealty = 2)		
		
	if @ShowAccumulate = 0
	Delete #TblRarkingRent From #TblRarkingRent [T] inner join [AccumulateParking] [F] on [F].[ParkingGuid] = [T].[ParkingGuid] 

	if @ShowAccumulateEndContract = 0
	begin
	Delete #TblRarkingRent 
	From 
		#TblRarkingRent [T] 
		inner join [AccumulateParking] [F] on [F].[ParentGuid] = [T].[ParkingGuid] and isnull([t].[ContractFinish],1) = 1
		inner join [AccumulateParking] [F2] on [F2].ParkingGuid = [F].[ParkingGuid] and isnull([T].[ContractFinish],0) = 0
	end
		
	Select
		*
	From
		#TblRarkingRent
	Order By 
		[BuildingName],
		dbo.FnStrToAscii([ParkingNo])
		

GO

SET ANSI_NULLS, QUOTED_IDENTIFIER ON
GO

Create Trigger [TRG_Trace_Trans]
on [Trans]
 
for update
As
	SET NOCOUNT ON;
	if Not exists(Select Value from DMD_const where vName = 'ActiveLogCardUpdate' and Value = '1' ) return
	
	Declare @UserGuid uniqueidentifier, @Guid uniqueidentifier
	Set @Guid = NEWID()
	
	Select Top 1 @UserGuid = userGuid From CurrentUsers where Spid = @@SPID
			
	insert into [Trace]
	([Guid],[ParentGuid],[Date],[userGuid],[HostName])
	Select Top 1
		@Guid,
		N.Guid,
		GETDATE(),
		@UserGuid,
		Host_Name()
	From
		[inserted] n 
		
	insert into [TraceDetail]
	([ParentGuid],[Caption],[Old],[New],[Tbl])
	Select Top 1
		@Guid,
		' ' as [Caption],
		D.[SecLvl] as [old],
		N.[SecLvl] as [New],
		''
	From
		[deleted] d
		inner join [inserted] n on D.Guid = N.Guid
	where
		N.[SecLvl] <> D.[SecLvl]
		
		
	insert into [TraceDetail]
	([ParentGuid],[Caption],[Old],[New],[Tbl])
	Select Top 1
		@Guid,
		'' as [Caption],
		dbo.fnDate(D.[Date]) as [old],
		dbo.fnDate(N.[Date]) as [New],
		''
	From
		[deleted] d
		inner join [inserted] n on D.Guid = N.Guid
	where
		N.[Date] <> D.[Date]
		
	insert into [TraceDetail]
	([ParentGuid],[Caption],[Old],[New],[Tbl])
	Select Top 1
		@Guid,
		'' as [Caption],
		D.[CurrencyGuid] as [old],
		N.[CurrencyGuid] as [New],
		'[Currency]'
	From
		[deleted] d
		inner join [inserted] n on D.Guid = N.Guid
	where
		N.[CurrencyGuid] <> D.[CurrencyGuid]
		
	insert into [TraceDetail]
	([ParentGuid],[Caption],[Old],[New],[Tbl])
	Select Top 1
		@Guid,
		' ' as [Caption],
		D.[CurrencyVal] as [old],
		N.[CurrencyVal] as [New],
		''
	From
		[deleted] d
		inner join [inserted] n on D.Guid = N.Guid
	where
		N.[CurrencyVal] <> D.[CurrencyVal]
		
	insert into [TraceDetail]
	([ParentGuid],[Caption],[Old],[New],[Tbl])
	Select Top 1
		@Guid,
		' ' as [Caption],
		D.[PayType] as [old],
		N.[PayType] as [New],
		''
	From
		[deleted] d
		inner join [inserted] n on D.Guid = N.Guid
	where
		N.[PayType] <> D.[PayType]
		
	insert into [TraceDetail]
	([ParentGuid],[Caption],[Old],[New],[Tbl])
	Select Top 1
		@Guid,
		' ' as [Caption],
		D.[StoreOutGuid] as [old],
		N.[StoreOutGuid] as [New],
		'[Store]'
	From
		[deleted] d
		inner join [inserted] n on D.Guid = N.Guid
	where
		N.[StoreOutGuid] <> D.[StoreOutGuid]
		
		
	insert into [TraceDetail]
	([ParentGuid],[Caption],[Old],[New],[Tbl])
	Select Top 1
		@Guid,
		'  ' as [Caption],
		D.[CostOutGuid] as [old],
		N.[CostOutGuid] as [New],
		'[Cost]'
	From
		[deleted] d
		inner join [inserted] n on D.Guid = N.Guid
	where
		N.[CostOutGuid] <> D.[CostOutGuid]
		
	insert into [TraceDetail]
	([ParentGuid],[Caption],[Old],[New],[Tbl])
	Select Top 1
		@Guid,
		' ' as [Caption],
		D.[StoreInGuid] as [old],
		N.[StoreInGuid] as [New],
		'[Store]'
	From
		[deleted] d
		inner join [inserted] n on D.Guid = N.Guid
	where
		N.[StoreInGuid] <> D.[StoreInGuid]
		
	insert into [TraceDetail]
	([ParentGuid],[Caption],[Old],[New],[Tbl])
	Select Top 1
		@Guid,
		'  ' as [Caption],
		D.[CostInGuid] as [old],
		N.[CostInGuid] as [New],
		'[Cost]'
	From
		[deleted] d
		inner join [inserted] n on D.Guid = N.Guid
	where
		N.[CostInGuid] <> D.[CostInGuid]
		
	insert into [TraceDetail]
	([ParentGuid],[Caption],[Old],[New],[Tbl])
	Select Top 1
		@Guid,
		'' as [Caption],
		D.[BranchGuid] as [old],
		N.[BranchGuid] as [New],
		'[Branch]'
	From
		[deleted] d
		inner join [inserted] n on D.Guid = N.Guid
	where
		N.[BranchGuid] <> D.[BranchGuid]
		
	insert into [TraceDetail]
	([ParentGuid],[Caption],[Old],[New],[Tbl])
	Select Top 1
		@Guid,
		'' as [Caption],
		D.[Class] as [old],
		N.[Class] as [New],
		''
	From
		[deleted] d
		inner join [inserted] n on D.Guid = N.Guid
	where
		N.[Class] <> D.[Class]
		
	insert into [TraceDetail]
	([ParentGuid],[Caption],[Old],[New],[Tbl])
	Select Top 1
		@Guid,
		'' as [Caption],
		D.[Note] as [old],
		N.[Note] as [New],
		''
	From
		[deleted] d
		inner join [inserted] n on D.Guid = N.Guid
	where
		N.[Note] <> D.[Note]
		
		
	insert into [TraceDetail]
	([ParentGuid],[Caption],[Old],[New],[Tbl])
	Select Top 1
		@Guid,
		'' as [Caption],
		D.[IsPosted] as [old],
		N.[IsPosted] as [New],
		''
	From
		[deleted] d
		inner join [inserted] n on D.Guid = N.Guid
	where
		N.[IsPosted] <> D.[IsPosted]
		
	delete Trace From Trace t left join [TraceDetail] D on T.guid = D.ParentGuid
	where
		d.ParentGuid is Null and t.Guid = @Guid


GO

SET ANSI_NULLS, QUOTED_IDENTIFIER ON
GO

Create Procedure [dbo].[PrcWarningEndContract]
(	
	@CustGuid uniqueidentifier = 0x0,
	@FlatNo Varchar(256) = '',
	@FloorNo Varchar(256) = '',	
	@FlatKind Varchar(256) = '',	
	@ApartmentType Varchar(256) = '',	
	@Class Varchar(256) = '',	
	@Day Int = 30,
	@All bit = 1, -- 

	@ActiveNote Bit = 0
	,@OperationNote int = 0
	,@RealtyNote  Varchar(256) = '' 
	,@ContractActiveNote Bit = 0
	,@ContractOpNote int = 0
	,@ContractNote  Varchar(256) = '' 

    ,@ContractCount1 int = 0
    ,@ContractCount2 int = 0

	,@SMS int = 2
)
 
as
	Set nocount on
	
	Declare @Check Bit,
			@NotCheck Bit
	Set @Check = 1
	Set @NotCheck = 0

	--  
	if @OperationNote = 0 --
	Set @RealtyNote = '%'+@RealtyNote+'%'
	
	--  
	if @ContractOpNote = 0 --
	Set @ContractNote = '%'+@ContractNote+'%'

	CREATE TABLE #R
	(
		[ContractNo] [varchar](256),
		[BuildingName] [varchar](256),
		[BuildingltnName] [varchar](256),
		[BuildingArName] [varchar](256),
		[OwnerName] [varchar](255),
		[OwnerArName] [varchar](255),
		[OwnerLtnName] [varchar](255),

		[LandlordName] [varchar](255),
		[LandlordArName] [varchar](255),
		[LandlordLtnName] [varchar](255),

		[RentName] [varchar](255),
		[No] [varchar](256),
		[FlatKind] [varchar](256),
		[Floor] [varchar](256),
		[CustomerName] [varchar](256),
		[CustomerltnName] [varchar](256),
		[CustomerArName] [varchar](256),
		[CustomerMobile] [varchar](256),
		[CustomerEMail] [varchar](256),
		[FromDate] [datetime],
		[ToDate] [datetime],
		[Datediff] Float,
		[RentAfterDiscount] [float],
		[LeaseKind] [int],
		[Note2] [varchar](1000),
		[AlertPrinted] [bit],
		[AlertPrintedDate] [datetime],
		[AlertPrintedCount] [int],
		[SMSSended] [bit],
		[SMSCount] [int],
		[AlertPrint] [int],
		[Guid] [uniqueidentifier],
		[FlatNote] [varchar](256),
		[ContractNote] [varchar](1000),
		[Bulding_Emirate] [varchar](256),
		[Bulding_Area] [varchar](256),
		[Bulding_Street] [varchar](256),
		[Bulding_BuildingNo] [varchar](256),
		[Bulding_PieceNo] [varchar](256),
		[Bulding_BasinNo] [varchar](256),
		[Bulding_BondType] [varchar](256),
		[Bulding_BondNo] [varchar](256),
		[Bulding_BondDate] [datetime],
		[FlatContract] [varchar](255),
		[Judicial] bit,
		[CountOldContract] int,
		[CountCurrentContract] int,
		[AddPercent] Float,
		[AddValue] Float,
		[ContractTag] int
	)

	
	--  
	Insert into #R
	Select 
		[ContractNo],
		[B].[Name] as [BuildingName],
		[B].[ltnName] as [BuildingltnName],
		[B].[ArName] as [BuildingArName],
		
		Onr.Name as [OwnerName],
		Onr.arName as [OwnerArName],
		Onr.LtnName as [OwnerLtnName],

		ld.Name as [LandlordName],
		ld.arName as [LandlordArName],
		ld.LtnName as [LandlordLtnName],

		rf.Name as [RentName],
		
		Case when Isnull([A].[No], '') <> '' then [A].[No] else [S].[No] end as [No],
		Case when Isnull([A].[No], '') <> '' then dbo.SC('') else dbo.SC('') end as [FlatKind],
		Case when Isnull([A].[No], '') <> '' then [A].[FloorNo] else Null end as [Floor],
		[cu].[Name] as [CustomerName],
		[cu].[ltnName] as [CustomerltnName],
		[cu].[arName] as [CustomerArName],
		[cu].[Mobile] as [CustomerMobile],
		[Cu].[EMail] as [CustomerEMail],
		[FromDate],
		[ToDate],
		DateDiff(Day, GetDate(), [ToDate]) as [Datediff],
		[L].[Rent] - [L].[DiscountValue] as [RentAfterDiscount],
		[LeaseKind],
		[L].[Note2],
		Case when [R2].[ObjGuid] is null then ( @NotCheck )
			 when [R2].[ObjGuid] is not null  then @Check end as [AlertPrinted],
		[R2].[Date] as [AlertPrintedDate],
		[R3].[Count] as [AlertPrintedCount],

		Case when [SMS2].[ObjGuid] is null then ( @NotCheck )
			 when [SMS2].[ObjGuid] is not null  then @Check end as [SMSSended],
		[SMS3].[Count] as [SMSCount],

		Null as [AlertPrint],
		[L].[Guid]
		,[A].[Note] as [FlatNote]
		,[L].[Note2] as [ContractNote]
		,[B].[Emirate] as [Bulding_Emirate]
		,[B].[Area] as [Bulding_Area]
		,[B].[Street] as [Bulding_Street]
		,[B].[BuildingNo] as [Bulding_BuildingNo]
		,[B].[PieceNo] as [Bulding_PieceNo]
		,[B].[BasinNo] as [Bulding_BasinNo]
		,[B].[BondType] as [Bulding_BondType]
		,[B].[BondNo] as [Bulding_BondNo]
		,[B].[BondDate] as [Bulding_BondDate]
		,'' as [FlatContract]
		,L.[Judicial],
		l.CountOldContract,
		(Select IsNull(COUNT(*),0) + 1 	From [LeaseApartment] where
			CustomerGuid = l.CustomerGuid
			and ApartmentGuid = l.ApartmentGuid)
		,L.[AddPercent]
		,L.[AddValue]
		,1 as [ContractTag]
	From
		[vbLeaseApartment] [L]
		inner join [vwBuilding] [B] On [L].[BuildingGuid] = [B].[Guid]

		LEFT join [vwOwner] LD on Ld.Guid = b.OwnerGuid
		LEFT join [vwOwner] onr on onr.Guid = b.OwnerName
		LEFT join [RentInfo] rf on rf.Guid = L.[RentInfoGuid]

		inner join [Resource] [RS] on [RS].[Guid] = [B].[Guid] and [RS].[Spid] = @@Spid and [RS].[Kind] = 3001
		inner join [Resource] [RS2] on [RS2].[Guid] = [L].[TypeGuid] and [RS2].[Spid] = @@Spid and [RS2].[Kind] = 3002
		inner join [vwCustomer] [cu] on [cu].[Guid] = [L].[CustomerGuid]
		left join [vwApartment] [A] On [A].[Guid] = [L].[ApartmentGuid]
		left join [vwShop] [S] On [S].[Guid] = [L].[ApartmentGuid]
		left join [RepCheck] [R] on [R].[ObjGuid] = [L].[Guid] and [R].[IdReport] = 7001
		left join [RepCheck] [R2] on [R2].[ObjGuid] = [L].[Guid] and [R2].[IdReport] = 7000
		left join (Select 
						[ObjGuid],
						[IdReport],
						Count(*) as [Count]
					From
						[RepCheckCount] 
					Group By
						[ObjGuid],
						[IdReport]
					)[R3] on [R3].[ObjGuid] = [L].[Guid] and [R3].[IdReport] = 7000

		left join [RepSMS] [SMS2] on [SMS2].[ObjGuid] = [L].[Guid] and [SMS2].[IdReport] = 7000
		left join (Select 
						[ObjGuid],
						[IdReport],
						Count(*) as [Count]
					From
						[RepSMSCount] 
					Group By
						[ObjGuid],
						[IdReport]
					)[SMS3] on [SMS3].[ObjGuid] = [L].[Guid] and [SMS3].[IdReport] = 7000
 	where
 		(DateDiff(Day, GetDate(), [ToDate]) <= @Day)
 		and (DateDiff(Day, GetDate(), [ToDate]) > 0)
 		and ([LeaseKind] = 0 or [LeaseKind] = 1)
 		and ([Contractfinish] = 0)
 		and ([R].[ObjGuid] is Not Null or @All = 1)
 
 		and (
 				([SMS2].[ObjGuid] is Not Null and @SMS = 0)
 				or ([SMS2].[ObjGuid] is Null and @SMS = 1)
 				or @SMS = 2
 			)
 
  		and ([L].[CustomerGuid] = @CustGuid or @CustGuid = 0x0)
  		and ([A].[No] = @FlatNo or @FlatNo = '')
  		and ([A].[FloorNo] = @FloorNo or @FloorNo = '')
  		and ([A].[FlatKind] = @FlatKind or @FlatKind = '')
  		and ([A].[ApartmentType] = @ApartmentType or @ApartmentType = '')
  		and ([A].[Class] = @Class or @Class = '')
 		and 
 			(
 				[A].[Note] Like @RealtyNote 
 				or @ActiveNote = 0
 			)
 
 		and 
 			(
 				[L].[Note2] Like @ContractNote 
 				or @ContractActiveNote = 0
			)

	Order By 
		[B].[Name],
		DateDiff(Day, GetDate(), [ToDate]) desc,
		[ContractNo],
		[ToDate]
		

	-- 
	Insert into #R
	Select 
		[ContractNo],
		[B].[Name] as [BuildingName],
		[B].[ltnName] as [BuildingltnName],
		[B].[ArName] as [BuildingArName],

		Onr.Name as [OwnerName],
		Onr.arName as [OwnerArName],
		Onr.LtnName as [OwnerLtnName],

		ld.Name as [LandlordName],
		ld.arName as [LandlordArName],
		ld.LtnName as [LandlordLtnName],

		rf.Name as [RentName],

		[A].[No]as [No],
		dbo.SC('') as [FlatKind],
		'' as [Floor],
		[cu].[Name] as [CustomerName],
		[cu].[ltnName] as [CustomerltnName],
		[cu].[arName] as [CustomerArName],
		[cu].[Mobile] as [CustomerMobile],
		[Cu].[EMail] as [CustomerEMail],
		[FromDate],
		[ToDate],
		DateDiff(Day, GetDate(), [ToDate]) as [Datediff],
		[L].[Rent] as [RentAfterDiscount],
		[ContractKind],
		[L].[Note2],
		Case when [R2].[ObjGuid] is null then ( @NotCheck )
			 when [R2].[ObjGuid] is not null  then @Check end as [AlertPrinted],
		[R2].[Date] as [AlertPrintedDate],
		[R3].[Count] as [AlertPrintedCount],

		Case when [SMS2].[ObjGuid] is null then ( @NotCheck )
			 when [SMS2].[ObjGuid] is not null  then @Check end as [SMSSended],
		[SMS3].[Count] as [SMSCount],

		Null as [AlertPrint],
		[L].[Guid]
		,[A].[Note] as [FlatNote]
		,[L].[Note2] as [ContractNote]
		,[B].[Emirate] as [Bulding_Emirate]
		,[B].[Area] as [Bulding_Area]
		,[B].[Street] as [Bulding_Street]
		,[B].[BuildingNo] as [Bulding_BuildingNo]
		,[B].[PieceNo] as [Bulding_PieceNo]
		,[B].[BasinNo] as [Bulding_BasinNo]
		,[B].[BondType] as [Bulding_BondType]
		,[B].[BondNo] as [Bulding_BondNo]
		,[B].[BondDate] as [Bulding_BondDate]
		,(Select Top 1 FlatNo from vwLeaseApartment where Guid = [FlatContractGuid])
		,L.[Judicial],
		0 AS CountOldContract,
		(Select IsNull(COUNT(*),0) + 1 	From [ParkingContract] where
			CustomerGuid = l.CustomerGuid
			and ParkingGuid = l.ParkingGuid)
		AS CountCurrentContract
		,L.[AddPercent]
		,L.[AddValue]
		,2 as [ContractTag]
	From
		[vbParkingContract] [L]
		inner join [vwBuilding] [B] On [L].[BuildingGuid] = [B].[Guid]

		LEFT join [vwOwner] LD on Ld.Guid = b.OwnerGuid
		LEFT join [vwOwner] onr on onr.Guid = b.OwnerName
		LEFT join [RentInfo] rf on rf.Guid = L.[RentInfoGuid]

		inner join [Resource] [RS] on [RS].[Guid] = [B].[Guid] and [RS].[Spid] = @@Spid and [RS].[Kind] = 3001
		inner join [Resource] [RS2] on [RS2].[Guid] = [L].[TypeGuid] and [RS2].[Spid] = @@Spid and [RS2].[Kind] = 3002
		inner join [vwCustomer] [cu] on [cu].[Guid] = [L].[CustomerGuid]
		left join [vwParking] [A] On [A].[Guid] = [L].[ParkingGuid]
		left join [RepCheck] [R] on [R].[ObjGuid] = [L].[Guid] and [R].[IdReport] = 7001
		left join [RepCheck] [R2] on [R2].[ObjGuid] = [L].[Guid] and [R2].[IdReport] = 7000
		left join (Select 
						[ObjGuid],
						[IdReport],
						Count(*) as [Count]
					From
						[RepCheckCount] 
					Group By
						[ObjGuid],
						[IdReport]
					)[R3] on [R3].[ObjGuid] = [L].[Guid] and [R3].[IdReport] = 7000

		left join [RepSMS] [SMS2] on [SMS2].[ObjGuid] = [L].[Guid] and [SMS2].[IdReport] = 7000
		left join (Select 
						[ObjGuid],
						[IdReport],
						Count(*) as [Count]
					From
						[RepSMSCount] 
					Group By
						[ObjGuid],
						[IdReport]
					)[SMS3] on [SMS3].[ObjGuid] = [L].[Guid] and [SMS3].[IdReport] = 7000
 	where
 		(DateDiff(Day, GetDate(), [ToDate]) <= @Day)
 		and (DateDiff(Day, GetDate(), [ToDate]) > 0)
 		and ([ContractKind] = 4)
 		and ([Contractfinish] = 0)
 		and ([R].[ObjGuid] is Not Null or @All = 1)
 
 		and (
 				([SMS2].[ObjGuid] is Not Null and @SMS = 0)
 				or ([SMS2].[ObjGuid] is Null and @SMS = 1)
 				or @SMS = 2
 			)
 
  		and ([L].[CustomerGuid] = @CustGuid or @CustGuid = 0x0)
  		and ([A].[No] = @FlatNo or @FlatNo = '')
  		and ([A].[FloorNo] = @FloorNo or @FloorNo = '')
  		and ([A].[ParkingKind] = @FlatKind or @FlatKind = '')
  		and ([A].[Description] = @ApartmentType or @ApartmentType = '')
  		--and ([A].[Class] = @Class or @Class = '')
 		and 
 			(
 				[A].[Note] Like @RealtyNote 
 				or @ActiveNote = 0
 			)
 
 		and 
 			(
 				[L].[Note2] Like @ContractNote 
 				or @ContractActiveNote = 0
			)

	Order By 
		[B].[Name],
		DateDiff(Day, GetDate(), [ToDate]) desc,
		[ContractNo],
		[ToDate]
		
	


	--  
	Insert into #R
	Select 
		[ContractNo],
		'' as [BuildingName],
		'' as [BuildingltnName],
		'' as [BuildingArName],
		
		'' as [OwnerName],
		'' as [OwnerArName],
		'' as [OwnerLtnName],

		'' as [LandlordName],
		'' as [LandlordArName],
		'' as [LandlordLtnName],

		'' as [RentName],
		
		[L].[Name]as [No],
		Case when [ContractKind] = 6 or [ContractKind] = 7 then dbo.SC('')
		 when [ContractKind] = 8 or [ContractKind] = 9 then dbo.SC('')
		end 
		as [FlatKind],
		'' as [Floor],
		[cu].[Name] as [CustomerName],
		[cu].[ltnName] as [CustomerltnName],
		[cu].[arName] as [CustomerArName],
		[cu].[Mobile] as [CustomerMobile],
		[Cu].[EMail] as [CustomerEMail],
		[FromDate],
		[ToDate],
		DateDiff(Day, GetDate(), [ToDate]) as [Datediff],
		[L].[Rent] as [RentAfterDiscount],
		[ContractKind],
		[L].[Note2],
		Case when [R2].[ObjGuid] is null then ( @NotCheck )
			 when [R2].[ObjGuid] is not null  then @Check end as [AlertPrinted],
		[R2].[Date] as [AlertPrintedDate],
		[R3].[Count] as [AlertPrintedCount],

		Case when [SMS2].[ObjGuid] is null then ( @NotCheck )
			 when [SMS2].[ObjGuid] is not null  then @Check end as [SMSSended],
		[SMS3].[Count] as [SMSCount],

		Null as [AlertPrint],
		[L].[Guid]
		,[L].UnitNote as [FlatNote]
		,[L].[Note2] as [ContractNote]
		,'' as [Bulding_Emirate]
		,'' as [Bulding_Area]
		,'' as [Bulding_Street]
		,'' as [Bulding_BuildingNo]
		,'' as [Bulding_PieceNo]
		,'' as [Bulding_BasinNo]
		,'' as [Bulding_BondType]
		,'' as [Bulding_BondNo]
		,Null as [Bulding_BondDate]
		,'' as [FlatContract]
		,L.[Judicial],
		0 as CountOldContract,
		(Select IsNull(COUNT(*),0) + 1 	From LandContract where
			CustomerGuid = l.CustomerGuid
			and (LandGuid = l.LandGuid or VillaGuid = l.VillaGuid))
		AS CountCurrentContract
		,L.[AddPercent]
		,L.[AddValue]
		,3 as [ContractTag]
	From
		[vwLandContract] [L]
		inner join [Resource] [RS2] on [RS2].[Guid] = [L].[TypeGuid] and [RS2].[Spid] = @@Spid and [RS2].[Kind] = 3002
		inner join [vwCustomer] [cu] on [cu].[Guid] = [L].[CustomerGuid]
		left join [RepCheck] [R] on [R].[ObjGuid] = [L].[Guid] and [R].[IdReport] = 7001
		left join [RepCheck] [R2] on [R2].[ObjGuid] = [L].[Guid] and [R2].[IdReport] = 7000
		left join (Select 
						[ObjGuid],
						[IdReport],
						Count(*) as [Count]
					From
						[RepCheckCount] 
					Group By
						[ObjGuid],
						[IdReport]
					)[R3] on [R3].[ObjGuid] = [L].[Guid] and [R3].[IdReport] = 7000

		left join [RepSMS] [SMS2] on [SMS2].[ObjGuid] = [L].[Guid] and [SMS2].[IdReport] = 7000
		left join (Select 
						[ObjGuid],
						[IdReport],
						Count(*) as [Count]
					From
						[RepSMSCount] 
					Group By
						[ObjGuid],
						[IdReport]
					)[SMS3] on [SMS3].[ObjGuid] = [L].[Guid] and [SMS3].[IdReport] = 7000
 	where
 		(DateDiff(Day, GetDate(), [ToDate]) <= @Day)
 		and (DateDiff(Day, GetDate(), [ToDate]) > 0)
 		and ([ContractKind] = 7 or [ContractKind] = 9)
 		and ([Contractfinish] = 0)
 		and ([R].[ObjGuid] is Not Null or @All = 1)
 
 		and (
 				([SMS2].[ObjGuid] is Not Null and @SMS = 0)
 				or ([SMS2].[ObjGuid] is Null and @SMS = 1)
 				or @SMS = 2
 			)
 
  		and ([L].[CustomerGuid] = @CustGuid or @CustGuid = 0x0)
  		and ([L].[Name] = @FlatNo or @FlatNo = '')
 		and 
 			(
 				[L].[UnitNote] Like @RealtyNote 
 				or @ActiveNote = 0
 			)
 
 		and 
 			(
 				[L].[Note2] Like @ContractNote 
 				or @ContractActiveNote = 0
			)

	Order By 
		DateDiff(Day, GetDate(), [ToDate]) desc,
		[ContractNo],
		[ToDate]

	Select 
		COUNT(*) as [Count],
		SUM([RentAfterDiscount]) as [RentAfterDiscount]
	From
		#R
	where
		(isNull(CountOldContract,0) + ISNULL(CountCurrentContract ,0)) between @ContractCount1 and @ContractCount2 or (@ContractCount1 = 0 and @ContractCount2 = 0)

	Select
		*,
		isNull(CountOldContract,0) + ISNULL(CountCurrentContract ,0) as [AllContractCount],
		isNull([RentAfterDiscount],0) + isNull([AddValue],0) as [RentAfterAdd],
		0 as [Operation],
		0 as [SMS],
		0 as [MsgSend]
	From
		#R
	where
		(isNull(CountOldContract,0) + ISNULL(CountCurrentContract ,0)) between @ContractCount1 and @ContractCount2 or (@ContractCount1 = 0 and @ContractCount2 = 0)
	Order By
		[BuildingName], 
		[Datediff],
		[ContractNo],
		[ToDate]
		

GO

SET ANSI_NULLS, QUOTED_IDENTIFIER ON
GO

Create Procedure [PrcCreateContractLandVillEntry]
(
	@ContractGuid uniqueidentifier = 'CC0F55C4-1A38-4604-870D-F84B4B7F036A',
	@MaxDate int = 42644
)
 
AS
	Set NoCount on 
	Declare 
			@EnNum int,
			@EnGuid [uniqueidentifier]

	--  
	Select 
		@EnNum = isnull([Number],0)
		,@EnGuid = isnull([Guid],0x0)
	From
		[Hentry]
	where
		[Guid] = @ContractGuid

	if isnull(@EnNum,0) = 0
	begin	
		Select @EnNum = IsNull(Max([Number]),0) + 1 from [HEntry]
	END
	
	if isnull(@EnGuid,0x0) = 0x0
	Set @EnGuid = @ContractGuid

	if Exists(Select Number From HEntry where Number = @EnNum and [Guid] <> @EnGuid)
	Select @EnNum = IsNull(Max([Number]),0) + 1 from [HEntry]

	--   
	Delete
		[HEntry]
	where
		[Guid] = @EnGuid

		
	--return
	DECLARE 
		@FlatNo Varchar(256),
		@FlatOwner int,
		@EntryDate Datetime,
		@AutoCreateEntry bit,
		@CreateEntry bit,
		@MoveCost bit,
		@MoveCostCredit bit,
		@MoveCostWithIncom bit,
		@MoveCostWithInconEndContract bit,
		@MoveCostWithFineEndContract bit,
		@MoveCostWithInsurance bit,
		@MoveCostWithContractPrice bit,
		@MoveCostWithCertificat bit,
		@MoveCostWithFee bit,
		@MoveCostWithclientComm bit,
		@MoveCostWithOwnerComm bit,
		@MoveCostWithDiscount bit,
		@MoveCostWithDiscountCredit bit,
		@MoveCostWithIncomCredit bit,
		@MoveCostWithInconEndContractCredit bit,
		@MoveCostWithFineEndContractCredit bit,
		@MoveCostWithInsuranceCredit bit,
		@MoveCostWithContractPriceCredit bit,
		@MoveCostWithCertificatCredit bit,
		@MoveCostWithFeeCredit bit,
		@MoveCostWithclientCommCredit bit,
		@MoveCostWithOwnerCommCredit bit,
		@SecLvl int,
		@CurrencyGuid uniqueidentifier,
		@CurrencyVal Float,
		@TypeName varchar(256),
		@ContractNumber int,
		@Note2 varchar(256),
		@ContractKind int,
		@AutoPostedEntry bit,
		@Mark bit,
		@RealtyGuid uniqueidentifier,
		@BuildingGuid uniqueidentifier,
		@EntryNote Varchar(255),
		@DetailNum Int,
		@Rent Float,
		@CostGuid  uniqueidentifier,
		@CustAccountGuid uniqueidentifier,
		@RevenueAccountGuid uniqueidentifier,
		@CommissionFromCustValue Float,
		@AcCommissionFromCustGuid uniqueidentifier,
		@AcCommissionFromCustNote varchar(256),
		@AcCustOwnerGuid uniqueidentifier,
		@CommissionFromOwnerValue Float,
		@AcCommissionFromOwnerGuid uniqueidentifier,
		@AcCommissionFromOwnerNote varchar(256),
		@UnearnedrRevenue bit,
		@Fromdate datetime,
		@Todate datetime,
		@AcIncomNextYearGuid uniqueidentifier,
		@InsuranceValue Float,
		@InsuranceAccountGuid uniqueidentifier,
		@CertificatValue Float,
		@AccountCertificatValueGuid uniqueidentifier,
		@OtherFeeAccountGuid uniqueidentifier,
		@OtherFee Float,

		@ContractPrice Float,
		@AccountContractPriceGuid uniqueidentifier,
		@DiscountValue fLoat,
		@DiscountAccountGuid uniqueidentifier,
		@BranchGuid uniqueidentifier,
		
		@CommissionFromSalesManrPercent fLoat,
		@CommissionFromSalesManValue fLoat,
		@AcSalesManCommissionGuid uniqueidentifier,
		@AcCommissionExpenseGuid uniqueidentifier,
		@SalesManCommNote varchar(255),

		@p_LandSale int = 6,
		@p_LandRent int = 7,
		@p_VillaSale int = 8,
		@p_VillaRent int = 9
	
	SELECT	TOP 1
		@FlatNo = C.Name,
		@FlatOwner = C.LandOwner,
		@EntryDate = Case when T.EntryDate = 0 then C.FromDate else C.EditDate end,
		@AutoCreateEntry = T.AutoCreateEntry,
		@AutoPostedEntry = T.AutoPostedEntry,
		@CreateEntry = T.CreateEntry,
		@MoveCost = T.MoveCost,
		@MoveCostCredit = T.MoveCostCredit,

		@MoveCostWithIncom = T.MoveCostWithIncom,
		@MoveCostWithInconEndContract = T.MoveCostWithInconEndContract,
		@MoveCostWithFineEndContract = T.MoveCostWithFineEndContract,
		@MoveCostWithInsurance = T.MoveCostWithInsurance,
		@MoveCostWithContractPrice = T.MoveCostWithContractPrice,
		@MoveCostWithCertificat = T.MoveCostWithCertificat,
		@MoveCostWithFee = T.MoveCostWithFee,
		@MoveCostWithclientComm = T.MoveCostWithclientComm,
		@MoveCostWithOwnerComm = T.MoveCostWithOwnerComm,

		@MoveCostWithDiscount = T.MoveCostWithDiscount,
		@MoveCostWithDiscountCredit = T.MoveCostWithDiscountCredit,

		@MoveCostWithIncomCredit = T.MoveCostWithIncomCredit,
		@MoveCostWithInconEndContractCredit = T.MoveCostWithInconEndContractCredit,
		@MoveCostWithFineEndContractCredit = T.MoveCostWithFineEndContractCredit,
		@MoveCostWithInsuranceCredit = T.MoveCostWithInsuranceCredit,
		@MoveCostWithContractPriceCredit = T.MoveCostWithContractPriceCredit,
		@MoveCostWithCertificatCredit = T.MoveCostWithCertificatCredit,
		@MoveCostWithFeeCredit = T.MoveCostWithFeeCredit,
		@MoveCostWithclientCommCredit = T.MoveCostWithclientCommCredit,
		@MoveCostWithOwnerCommCredit = T.MoveCostWithOwnerCommCredit,
		@SecLvl = C.SecLvl,
		@CurrencyGuid = C.CurrencyGuid,
		@CurrencyVal = C.CurrencyVal,
		@TypeName = T.Name,
		@ContractNumber = C.Number ,
		@Note2 = C.Note2,
		@ContractKind = C.ContractKind,
		@AutoPostedEntry = T.AutoPostedEntry,
		@Mark = C.Mark,
		@RealtyGuid = C.LandGuid,
		--@BuildingGuid = C.BuildingGuid,
		@Rent = C.Rent,
		@CostGuid = C.CostGuid,
		@CustAccountGuid = C.CustAccountGuid,
		@RevenueAccountGuid = C.RevenueAccountGuid,
		@CommissionFromCustValue = C.CommissionFromCustValue,
		@AcCommissionFromCustGuid = C.AcCommissionFromCustGuid,
		@AcCommissionFromCustNote = '', --C.AcCommissionFromCustNote,
		@CommissionFromOwnerValue = C.CommissionFromOwnerValue,
		@AcCommissionFromOwnerGuid = C.AcCommissionFromOwnerGuid ,
		@AcCommissionFromOwnerNote = '', --C.AcCommissionFromOwnerNote,
		@UnearnedrRevenue = Case when (T.UnearnedrRevenue = 0) or (C.Todate <= @MaxDate) then 0 else 1 end,
		@Fromdate = C.FromDate,
		@Todate = C.ToDate,
		@AcIncomNextYearGuid = C.AcIncomNextYearGuid,
		@InsuranceValue = C.InsuranceValue,
		@InsuranceAccountGuid = C.InsuranceAccountGuid,
		@CertificatValue = C.CertificatValue,
		@AccountCertificatValueGuid = C.AccountCertificatValue,
		@OtherFee = C.OtherFee,
		@OtherFeeAccountGuid = C.OtherFeeAccountGUID,

		@ContractPrice = C.ContractPrice,
		@AccountContractPriceGuid = C.AccountContractPrice,
		@DiscountValue = C.DiscountValue,
		@DiscountAccountGuid = C.DiscountAccountGuid,
		@BranchGuid = C.BranchGuid,
		@EntryNote = [T].[ContractNote],

		@CommissionFromSalesManrPercent = C.[CommissionFromSalesManrPercent],
		@CommissionFromSalesManValue = C.CommissionFromSalesManValue,
		@AcSalesManCommissionGuid = C.AcSalesManCommissionGuid,
		@AcCommissionExpenseGuid = C.AcCommissionExpenseGuid,
		@SalesManCommNote = C.SalesManCommNote

	FROM
		[vwLandContract]  C
		inner join [vwContractType] T on T.Guid = C.TypeGuid
	WHERE
		C.Guid = @ContractGuid
	
	--Set @EntryNote = @TypeName +' '+dbo.sc(' ')+' '+CAST( @ContractNumber as varchar(255)) +' '+dbo.sc(' ')+' '+@FlatNo +' '+@Note2
	Select 
		@EntryNote  =				REPLACE(REPLACE(REPLACE(REPLACE(REPLACE(REPLACE(
									REPLACE(REPLACE(REPLACE(REPLACE(REPLACE(REPLACE(
									@EntryNote, '[N]', TypeNameAr),
									'[M]', TypeNameLtn),
									'[A]', CustArName),
									'[B]', CustltnName),
									'[C]', FlatNo),
									'[D]', BuildingArName),
									'[E]', BuildingLtnName),
									'[F]', dbo.fndate(EditDate)),
									'[G]', dbo.fndate(Fromdate)),
									'[H]', dbo.fndate(Todate)),
									'[K]', ContractNo),
									'[L]', Cast(Value as varchar(50)))
									
	from 
		[vwAllContract]
	where
		Guid = @ContractGuid
		
	--Select @FlatOwner Return
	if (@ContractKind = @p_LandRent) or (@ContractKind = @p_LandSale)
	begin
		select
			@AcCustOwnerGuid = [Cu].[AcGuid]
		from
			vwEarth P
			inner join [Customer] [Cu] on [P].[CuOwnerGuid] = [Cu].[Guid]
		where
			[P].[Guid] = @RealtyGuid 
	end
		
	if (@ContractKind = @p_VillaSale) or (@ContractKind = @p_VillaRent)
	begin
		select
			@AcCustOwnerGuid = [Cu].[AcGuid]
		from
			vwVilla P
			inner join [Customer] [Cu] on [P].CuOwnerGuid = [Cu].[Guid]
		where
			[P].[Guid] = @RealtyGuid 
	end
	
	if (@FlatOwner = 0 or @FlatOwner = -1)
	begin
		if (@ContractKind = @p_LandSale or @ContractKind = @p_VillaSale ) --   
		begin
				Insert Into [HEntry]
				([Guid],[SecLvl],[Number],[Date], [CurrencyGuid], [CurrencyVal], [Note], [ParentKind], [BranchGuid], [IsPosted], Mark)
				Select
					@EnGuid,
					@SecLvl,
					@EnNum,
					@EntryDate,
					@CurrencyGuid,
					@CurrencyVal,
					@EntryNote as [Note],
					1000+@ContractKind as [ParentKind], 
					@BranchGuid as [BranchGuid], 
					@AutoPostedEntry as [IsPosted],
					@Mark
					
				Set @DetailNum = 0
				
				Insert into [DEntry]
		 		([ParentGuid],[Number],[AcGuid],[Debit],[Credit],[CurrencyGuid],[CurrencyVal],[CostGuid],[ObverseAcGuid],[Note])
				Select
					@EnGuid,
					@DetailNum,
					@CustAccountGuid,
					@Rent as Debit,
					0 as Credit,
					@CurrencyGuid,
					@CurrencyVal,
					Case when @MoveCost = 1 then @CostGuid end,
					Null as [ObverseAcGuid],
					@EntryNote

				-- 
				Declare @CostPrice Float
				Set @CostPrice = 0
				
				/*
				if @ContractKind = @p_LandSale or @ContractKind = @p_LandRent
				Select	@CostPrice = CostPrice	From Earth where Guid = @RealtyGuid
				
				if @ContractKind = @p_VillaSale or @ContractKind = @p_VillaRent
				Select	@CostPrice = CostPrice	From Villa where Guid = @RealtyGuid
				*/
				if @CostPrice > 0
				begin
					Declare @BuildingAcGuid uniqueidentifier
					Select @BuildingAcGuid = BuildingAccountGuid From Building where Guid = @BuildingGuid
					
					if IsNull(@BuildingAcGuid,0x0) <> 0x0
					begin
						Set @DetailNum = @DetailNum + 1
						Insert into [DEntry]
		 				([ParentGuid],[Number],[AcGuid],[Debit],[Credit],[CurrencyGuid],[CurrencyVal],[CostGuid],[ObverseAcGuid],[Note])
						Select
							@EnGuid,
							@DetailNum,
							@BuildingAcGuid,
							0 as Debit,
							@CostPrice as Credit,
							@CurrencyGuid,
							@CurrencyVal,
							Case when @MoveCost = 1 then @CostGuid end,
							Null as [ObverseAcGuid],
							@EntryNote
					end
				end
				
				if @CostPrice <= @Rent
				begin
						Set @DetailNum = @DetailNum + 1
						Insert into [DEntry]
		 				([ParentGuid],[Number],[AcGuid],[Debit],[Credit],[CurrencyGuid],[CurrencyVal],[CostGuid],[ObverseAcGuid],[Note])
						Select
							@EnGuid,
							@DetailNum,
							@RevenueAccountGuid,
							0 as Debit,
							@Rent - @CostPrice as Credit,
							@CurrencyGuid,
							@CurrencyVal,
							Case when @MoveCostWithIncomCredit = 1 then @CostGuid end,
							@CustAccountGuid as [ObverseAcGuid],
							@EntryNote
				end
				if @CostPrice > @Rent
				begin
						Set @DetailNum = @DetailNum + 1
						Insert into [DEntry]
		 				([ParentGuid],[Number],[AcGuid],[Debit],[Credit],[CurrencyGuid],[CurrencyVal],[CostGuid],[ObverseAcGuid],[Note])
						Select
							@EnGuid,
							@DetailNum,
							@RevenueAccountGuid,
							@CostPrice - @Rent as Debit,
							0 as Credit,
							@CurrencyGuid,
							@CurrencyVal,
							Case when @MoveCostWithIncom = 1 then @CostGuid end,
							@CustAccountGuid as [ObverseAcGuid],
							@EntryNote
				end
				
				if @CommissionFromCustValue > 0
				begin
						Set @DetailNum = @DetailNum + 1
						Insert into [DEntry]
		 				([ParentGuid],[Number],[AcGuid],[Debit],[Credit],[CurrencyGuid],[CurrencyVal],[CostGuid],[ObverseAcGuid],[Note])
						Select
							@EnGuid,
							@DetailNum,
							@CustAccountGuid,
							@CommissionFromCustValue as Debit,
							0 as Credit,
							@CurrencyGuid,
							@CurrencyVal,
							Case when @MoveCost = 1 then @CostGuid end,
							@AcCommissionFromCustGuid as [ObverseAcGuid],
							@AcCommissionFromCustNote

						Set @DetailNum = @DetailNum + 1
						Insert into [DEntry]
		 				([ParentGuid],[Number],[AcGuid],[Debit],[Credit],[CurrencyGuid],[CurrencyVal],[CostGuid],[ObverseAcGuid],[Note])
						Select
							@EnGuid,
							@DetailNum,
							@AcCommissionFromCustGuid,
							0 as Debit,
							@CommissionFromCustValue as Credit,
							@CurrencyGuid,
							@CurrencyVal,
							Case when @MoveCostWithclientCommCredit = 1 then @CostGuid end,
							@CustAccountGuid as [ObverseAcGuid],
							@AcCommissionFromCustNote
				end
				
				if @CommissionFromOwnerValue > 0
				begin
						Set @DetailNum = @DetailNum + 1
						Insert into [DEntry]
		 				([ParentGuid],[Number],[AcGuid],[Debit],[Credit],[CurrencyGuid],[CurrencyVal],[CostGuid],[ObverseAcGuid],[Note])
						Select
							@EnGuid,
							@DetailNum,
							@AcCustOwnerGuid,
							@CommissionFromOwnerValue as Debit,
							0 as Credit,
							@CurrencyGuid,
							@CurrencyVal,
							Case when @MoveCostWithOwnerComm = 1 then @CostGuid end,
							@AcCommissionFromOwnerGuid as [ObverseAcGuid],
							@EntryNote

						Set @DetailNum = @DetailNum + 1
						Insert into [DEntry]
		 				([ParentGuid],[Number],[AcGuid],[Debit],[Credit],[CurrencyGuid],[CurrencyVal],[CostGuid],[ObverseAcGuid],[Note])
						Select
							@EnGuid,
							@DetailNum,
							@AcCommissionFromOwnerGuid,
							0 as Debit,
							@CommissionFromOwnerValue as Credit,
							@CurrencyGuid,
							@CurrencyVal,
							Case when @MoveCostWithclientCommCredit = 1 then @CostGuid end,
							@AcCustOwnerGuid as [ObverseAcGuid],
							@AcCommissionFromOwnerNote
				end
				
				if @CommissionFromSalesManValue > 0
				begin
						Set @DetailNum = @DetailNum + 1
						Insert into [DEntry]
		 				([ParentGuid],[Number],[AcGuid],[Debit],[Credit],[CurrencyGuid],[CurrencyVal],[CostGuid],[ObverseAcGuid],[Note])
						Select
							@EnGuid,
							@DetailNum,
							@AcCommissionExpenseGuid,
							@CommissionFromSalesManValue as Debit,
							0 as Credit,
							@CurrencyGuid,
							@CurrencyVal,
							Case when @MoveCost = 1 then @CostGuid end,
							@AcSalesManCommissionGuid as [ObverseAcGuid],
							Case when @SalesManCommNote <> '' then @SalesManCommNote else @EntryNote end

						Set @DetailNum = @DetailNum + 1
						Insert into [DEntry]
		 				([ParentGuid],[Number],[AcGuid],[Debit],[Credit],[CurrencyGuid],[CurrencyVal],[CostGuid],[ObverseAcGuid],[Note])
						Select
							@EnGuid,
							@DetailNum,
							@AcSalesManCommissionGuid,
							0 as Debit,
							@CommissionFromSalesManValue as Credit,
							@CurrencyGuid,
							@CurrencyVal,
							Case when @MoveCostWithclientCommCredit = 1 then @CostGuid end,
							@AcCommissionExpenseGuid as [ObverseAcGuid],
							Case when @SalesManCommNote <> '' then @SalesManCommNote else @EntryNote end
				end
		end	--   
	
		if (@ContractKind = @p_LandRent) or (@ContractKind = @p_VillaRent)
		begin
				Insert Into [HEntry]
				([Guid],[SecLvl],[Number],[Date], [CurrencyGuid], [CurrencyVal], [Note], [ParentKind], [BranchGuid], [IsPosted], Mark)
				Select
					@EnGuid,
					@SecLvl,
					@EnNum,
					@EntryDate,
					@CurrencyGuid,
					@CurrencyVal,
					@EntryNote as [Note],
					1000+@ContractKind as [ParentKind], 
					@BranchGuid as [BranchGuid], 
					@AutoPostedEntry as [IsPosted],
					@Mark
					
				Set @DetailNum = 0
				
				if @Rent <> 0
				begin
						Insert into [DEntry]
		 				([ParentGuid],[Number],[AcGuid],[Debit],[Credit],[CurrencyGuid],[CurrencyVal],[CostGuid],[ObverseAcGuid],[Note])
						Select
							@EnGuid,
							@DetailNum,
							@CustAccountGuid as [AccountGuid],
							Case when @UnearnedrRevenue = 0 then @Rent else (@Rent - @DiscountValue) end as Debit,
							0 as Credit,
							@CurrencyGuid,
							@CurrencyVal,
							Case when @MoveCost = 1 then @CostGuid end,
							@RevenueAccountGuid as [ObverseAcGuid],
							@EntryNote as [Note]
							
						if @UnearnedrRevenue = 0 
						begin
							Set @DetailNum = @DetailNum + 1
							Insert into [DEntry]
		 					([ParentGuid],[Number],[AcGuid],[Debit],[Credit],[CurrencyGuid],[CurrencyVal],[CostGuid],[ObverseAcGuid],[Note])
							Select
								@EnGuid,
								@DetailNum,
								@RevenueAccountGuid as [AccountGuid],
								0 as Debit,
								@Rent as Credit,
								@CurrencyGuid,
								@CurrencyVal,
								Case when @MoveCostWithIncomCredit = 1 then @CostGuid end,
								@CustAccountGuid as [ObverseAcGuid],
								@EntryNote as [Note]
						end
						else
						begin
							Set @DetailNum = @DetailNum + 1
							Insert into [DEntry]
		 					([ParentGuid],[Number],[AcGuid],[Debit],[Credit],[CurrencyGuid],[CurrencyVal],[CostGuid],[ObverseAcGuid],[Note])
							Select
								@EnGuid,
								@DetailNum,
								@RevenueAccountGuid as [AccountGuid],
								0 as Debit,
								(((@Rent - @DiscountValue) / dbo.fnGetCountDayofYear()) * (dbo.fnDaysBetween(@fromdate, @MaxDate))) as Credit,
								@CurrencyGuid,
								@CurrencyVal,
								Case when @MoveCostWithIncomCredit = 1 then @CostGuid end,
								@CustAccountGuid as [ObverseAcGuid],
								@EntryNote as [Note]
		
							Set @DetailNum = @DetailNum + 1
							Insert into [DEntry]
		 					([ParentGuid],[Number],[AcGuid],[Debit],[Credit],[CurrencyGuid],[CurrencyVal],[CostGuid],[ObverseAcGuid],[Note])
							Select
								@EnGuid,
								@DetailNum,
								@AcIncomNextYearGuid as [AccountGuid],
								0 as Debit,
								(@Rent - @DiscountValue) - (((@Rent - @DiscountValue) / dbo.fnGetCountDayofYear()) * (dbo.fnDaysBetween(@fromdate, @MaxDate))) as Credit,
								@CurrencyGuid,
								@CurrencyVal,
								Case when @MoveCostWithIncomCredit = 1 then @CostGuid end,
								@CustAccountGuid as [ObverseAcGuid],
								@EntryNote as [Note]
						end
				end
				
				if @InsuranceValue <> 0
				begin
						--Select @InsuranceValue ,@CustAccountGuid, @InsuranceAccountGuid

						Set @DetailNum = @DetailNum + 1
						Insert into [DEntry]
	 					([ParentGuid],[Number],[AcGuid],[Debit],[Credit],[CurrencyGuid],[CurrencyVal],[CostGuid],[ObverseAcGuid],[Note])
						Select
							@EnGuid,
							@DetailNum,
							@CustAccountGuid,
							@InsuranceValue,
							0,
							@CurrencyGuid,
							@CurrencyVal,
							Case when @MoveCost = 1 then @CostGuid end,
							@InsuranceAccountGuid,
							@EntryNote

						Set @DetailNum = @DetailNum + 1
						Insert into [DEntry]
	 					([ParentGuid],[Number],[AcGuid],[Debit],[Credit],[CurrencyGuid],[CurrencyVal],[CostGuid],[ObverseAcGuid],[Note])
						Select
							@EnGuid,
							@DetailNum,
							@InsuranceAccountGuid,
							0,
							@InsuranceValue,
							@CurrencyGuid,
							@CurrencyVal,
							Case when @MoveCostWithInsuranceCredit = 1 then @CostGuid end,
							@CustAccountGuid,
							@EntryNote
				end
				
				if @CommissionFromCustValue > 0
				begin
						Set @DetailNum = @DetailNum + 1
						Insert into [DEntry]
	 					([ParentGuid],[Number],[AcGuid],[Debit],[Credit],[CurrencyGuid],[CurrencyVal],[CostGuid],[ObverseAcGuid],[Note])
						Select
							@EnGuid,
							@DetailNum,
							@CustAccountGuid,
							@CommissionFromCustValue as Debit,
							0 as Credit,
							@CurrencyGuid,
							@CurrencyVal,
							Case when @MoveCost = 1 then @CostGuid end,
							@AcCommissionFromCustGuid as [ObverseAcGuid],
							@AcCommissionFromCustNote

						Set @DetailNum = @DetailNum + 1
						Insert into [DEntry]
	 					([ParentGuid],[Number],[AcGuid],[Debit],[Credit],[CurrencyGuid],[CurrencyVal],[CostGuid],[ObverseAcGuid],[Note])
						Select
							@EnGuid,
							@DetailNum,
							@AcCommissionFromCustGuid,
							0 as Debit,
							@CommissionFromCustValue as Credit,
							@CurrencyGuid,
							@CurrencyVal,
							Case when @MoveCostWithclientCommCredit = 1 then @CostGuid end,
							@CustAccountGuid as [ObverseAcGuid],
							@AcCommissionFromCustNote
				end	
				if @CommissionFromOwnerValue > 0
				begin

						Set @DetailNum = @DetailNum + 1
						Insert into [DEntry]
	 					([ParentGuid],[Number],[AcGuid],[Debit],[Credit],[CurrencyGuid],[CurrencyVal],[CostGuid],[ObverseAcGuid],[Note])
						Select
							@EnGuid,
							@DetailNum,
							@AcCustOwnerGuid,
							@CommissionFromOwnerValue as Debit,
							0 as Credit,
							@CurrencyGuid,
							@CurrencyVal,
							Case when @MoveCostWithOwnerComm = 1 then @CostGuid end,
							@AcCommissionFromOwnerGuid as [ObverseAcGuid],
							@EntryNote

						Set @DetailNum = @DetailNum + 1
						Insert into [DEntry]
	 					([ParentGuid],[Number],[AcGuid],[Debit],[Credit],[CurrencyGuid],[CurrencyVal],[CostGuid],[ObverseAcGuid],[Note])
						Select
							@EnGuid,
							@DetailNum,
							@AcCommissionFromOwnerGuid,
							0 as Debit,
							@CommissionFromOwnerValue as Credit,
							@CurrencyGuid,
							@CurrencyVal,
							Case when @MoveCostWithOwnerCommCredit = 1 then @CostGuid end,
							@AcCustOwnerGuid as [ObverseAcGuid],
							@AcCommissionFromOwnerNote
				end
				
				if @CommissionFromSalesManValue > 0
				begin
						Set @DetailNum = @DetailNum + 1
						Insert into [DEntry]
		 				([ParentGuid],[Number],[AcGuid],[Debit],[Credit],[CurrencyGuid],[CurrencyVal],[CostGuid],[ObverseAcGuid],[Note])
						Select
							@EnGuid,
							@DetailNum,
							@AcCommissionExpenseGuid,
							@CommissionFromSalesManValue as Debit,
							0 as Credit,
							@CurrencyGuid,
							@CurrencyVal,
							Case when @MoveCost = 1 then @CostGuid end,
							@AcSalesManCommissionGuid as [ObverseAcGuid],
							Case when @SalesManCommNote <> '' then @SalesManCommNote else @EntryNote end

						Set @DetailNum = @DetailNum + 1
						Insert into [DEntry]
		 				([ParentGuid],[Number],[AcGuid],[Debit],[Credit],[CurrencyGuid],[CurrencyVal],[CostGuid],[ObverseAcGuid],[Note])
						Select
							@EnGuid,
							@DetailNum,
							@AcSalesManCommissionGuid,
							0 as Debit,
							@CommissionFromSalesManValue as Credit,
							@CurrencyGuid,
							@CurrencyVal,
							Case when @MoveCostWithclientCommCredit = 1 then @CostGuid end,
							@AcCommissionExpenseGuid as [ObverseAcGuid],
							Case when @SalesManCommNote <> '' then @SalesManCommNote else @EntryNote end
				end

				if @CertificatValue > 0
				begin
						Set @DetailNum = @DetailNum + 1
						Insert into [DEntry]
	 					([ParentGuid],[Number],[AcGuid],[Debit],[Credit],[CurrencyGuid],[CurrencyVal],[CostGuid],[ObverseAcGuid],[Note])
						Select
							@EnGuid,
							@DetailNum,
							@CustAccountGuid,
							@CertificatValue as Debit,
							0 as Credit,
							@CurrencyGuid,
							@CurrencyVal,
							Case when @MoveCost = 1 then @CostGuid end,
							@AccountCertificatValueGuid as [ObverseAcGuid],
							@EntryNote

						Set @DetailNum = @DetailNum + 1
						Insert into [DEntry]
	 					([ParentGuid],[Number],[AcGuid],[Debit],[Credit],[CurrencyGuid],[CurrencyVal],[CostGuid],[ObverseAcGuid],[Note])
						Select
							@EnGuid,
							@DetailNum,
							@AccountCertificatValueGuid,
							0 as Debit,
							@CertificatValue as Credit,
							@CurrencyGuid,
							@CurrencyVal,
							Case when @MoveCostWithCertificatCredit = 1 then @CostGuid end,
							@CustAccountGuid as [ObverseAcGuid],
							@EntryNote
				end	
				
				if @OtherFee > 0
				begin
						Set @DetailNum = @DetailNum + 1
						Insert into [DEntry]
	 					([ParentGuid],[Number],[AcGuid],[Debit],[Credit],[CurrencyGuid],[CurrencyVal],[CostGuid],[ObverseAcGuid],[Note])
						Select
							@EnGuid,
							@DetailNum,
							@CustAccountGuid,
							@OtherFee as Debit,
							0 as Credit,
							@CurrencyGuid,
							@CurrencyVal,
							Case when @MoveCost = 1 then @CostGuid end,
							@OtherFeeAccountGuid as [ObverseAcGuid],
							@EntryNote

						Set @DetailNum = @DetailNum + 1
						Insert into [DEntry]
	 					([ParentGuid],[Number],[AcGuid],[Debit],[Credit],[CurrencyGuid],[CurrencyVal],[CostGuid],[ObverseAcGuid],[Note])
						Select
							@EnGuid,
							@DetailNum,
							@OtherFeeAccountGuid,
							0 as Debit,
							@OtherFee as Credit,
							@CurrencyGuid,
							@CurrencyVal,
							Case when @MoveCostWithFeeCredit = 1 then @CostGuid end,
							@CustAccountGuid as [ObverseAcGuid],
							@EntryNote
				end	
				
				exec [dbo].[PrcCreateEntryFromLandContractFee] @ContractGuid

				if @ContractPrice > 0
				begin
						Set @DetailNum = @DetailNum + 1
						Insert into [DEntry]
	 					([ParentGuid],[Number],[AcGuid],[Debit],[Credit],[CurrencyGuid],[CurrencyVal],[CostGuid],[ObverseAcGuid],[Note])
						Select
							@EnGuid,
							@DetailNum,
							@CustAccountGuid,
							@ContractPrice as Debit,
							0 as Credit,
							@CurrencyGuid,
							@CurrencyVal,
							Case when @MoveCost = 1 then @CostGuid end,
							@AccountContractPriceGuid as [ObverseAcGuid],
							@EntryNote

						Set @DetailNum = @DetailNum + 1
						Insert into [DEntry]
	 					([ParentGuid],[Number],[AcGuid],[Debit],[Credit],[CurrencyGuid],[CurrencyVal],[CostGuid],[ObverseAcGuid],[Note])
						Select
							@EnGuid,
							@DetailNum,
							@AccountContractPriceGuid,
							0 as Debit,
							@ContractPrice as Credit,
							@CurrencyGuid,
							@CurrencyVal,
							Case when @MoveCostWithFeeCredit = 1 then @CostGuid end,
							@CustAccountGuid as [ObverseAcGuid],
							@EntryNote
				end	
			end
		end
		
		if (@FlatOwner <> 0) and (@FlatOwner <> -1)
		begin
			Insert Into [HEntry]
			([Guid],[SecLvl],[Number],[Date], [CurrencyGuid], [CurrencyVal], [Note], [ParentKind], [BranchGuid], [IsPosted], Mark)
			Select
				@EnGuid,
				@SecLvl,
				@EnNum,
				@EntryDate,
				@CurrencyGuid,
				@CurrencyVal,
				@EntryNote as [Note],
				1000+@ContractKind as [ParentKind], 
				@BranchGuid  as [BranchGuid], 
				@AutoPostedEntry as [IsPosted],
				@Mark
				
			Set @DetailNum = 0
			
			--rent
			Set @DetailNum = @DetailNum + 1
			Insert into [DEntry]
			([ParentGuid],[Number],[AcGuid],[Debit],[Credit],[CurrencyGuid],[CurrencyVal],[CostGuid],[ObverseAcGuid],[Note])
			Select
				@EnGuid,
				@DetailNum,
				@CustAccountGuid,
				@rent,
				0,
				@CurrencyGuid,
				@CurrencyVal,
				Case when @MoveCost = 1 then @CostGuid end,
				@RevenueAccountGuid,
				@EntryNote
				
			Set @DetailNum = @DetailNum + 1
			Insert into [DEntry]
			([ParentGuid],[Number],[AcGuid],[Debit],[Credit],[CurrencyGuid],[CurrencyVal],[CostGuid],[ObverseAcGuid],[Note])
			Select
				@EnGuid,
				@DetailNum,
				@RevenueAccountGuid,
				0,
				@rent,
				@CurrencyGuid,
				@CurrencyVal,
				Case when @MoveCostWithIncomCredit = 1 then @CostGuid end,
				@CustAccountGuid,
				@EntryNote

			--Insurance
			if @InsuranceValue <> 0
			begin
				Select @InsuranceValue ,@CustAccountGuid, @InsuranceAccountGuid

				Set @DetailNum = @DetailNum + 1
				Insert into [DEntry]
				([ParentGuid],[Number],[AcGuid],[Debit],[Credit],[CurrencyGuid],[CurrencyVal],[CostGuid],[ObverseAcGuid],[Note])
				Select
					@EnGuid,
					@DetailNum,
					@CustAccountGuid,
					@InsuranceValue,
					0,
					@CurrencyGuid,
					@CurrencyVal,
					Case when @MoveCost = 1 then @CostGuid end,
					@InsuranceAccountGuid,
					@EntryNote
					
				Set @DetailNum = @DetailNum + 1
				Insert into [DEntry]
				([ParentGuid],[Number],[AcGuid],[Debit],[Credit],[CurrencyGuid],[CurrencyVal],[CostGuid],[ObverseAcGuid],[Note])
				Select
					@EnGuid,
					@DetailNum,
					@InsuranceAccountGuid,
					0,
					@InsuranceValue,
					@CurrencyGuid,
					@CurrencyVal,
					Case when @MoveCostWithInsuranceCredit = 1 then @CostGuid end,
					@CustAccountGuid,
					@EntryNote
			end

			if @CommissionFromCustValue > 0
			begin
					Set @DetailNum = @DetailNum + 1
					Insert into [DEntry]
		 			([ParentGuid],[Number],[AcGuid],[Debit],[Credit],[CurrencyGuid],[CurrencyVal],[CostGuid],[ObverseAcGuid],[Note])
					Select
						@EnGuid,
						@DetailNum,
						@CustAccountGuid,
						@CommissionFromCustValue as Debit,
						0 as Credit,
						@CurrencyGuid,
						@CurrencyVal,
						Case when @MoveCost = 1 then @CostGuid end,
						@AcCommissionFromCustGuid as [ObverseAcGuid],
						@AcCommissionFromCustNote

					Set @DetailNum = @DetailNum + 1
					Insert into [DEntry]
		 			([ParentGuid],[Number],[AcGuid],[Debit],[Credit],[CurrencyGuid],[CurrencyVal],[CostGuid],[ObverseAcGuid],[Note])
					Select
						@EnGuid,
						@DetailNum,
						@AcCommissionFromCustGuid,
						0 as Debit,
						@CommissionFromCustValue as Credit,
						@CurrencyGuid,
						@CurrencyVal,
						Case when @MoveCostWithclientCommCredit = 1 then @CostGuid end,
						@CustAccountGuid as [ObverseAcGuid],
						@AcCommissionFromCustNote
			end

			if @CommissionFromOwnerValue > 0
			begin

					Set @DetailNum = @DetailNum + 1
					Insert into [DEntry]
		 			([ParentGuid],[Number],[AcGuid],[Debit],[Credit],[CurrencyGuid],[CurrencyVal],[CostGuid],[ObverseAcGuid],[Note])
					Select
						@EnGuid,
						@DetailNum,
						@AcCustOwnerGuid,
						@CommissionFromOwnerValue as Debit,
						0 as Credit,
						@CurrencyGuid,
						@CurrencyVal,
						Case when @MoveCostWithOwnerComm = 1 then @CostGuid end,
						@AcCommissionFromOwnerGuid as [ObverseAcGuid],
						@EntryNote

					Set @DetailNum = @DetailNum + 1
					Insert into [DEntry]
		 			([ParentGuid],[Number],[AcGuid],[Debit],[Credit],[CurrencyGuid],[CurrencyVal],[CostGuid],[ObverseAcGuid],[Note])
					Select
						@EnGuid,
						@DetailNum,
						@AcCommissionFromOwnerGuid,
						0 as Debit,
						@CommissionFromOwnerValue as Credit,
						@CurrencyGuid,
						@CurrencyVal,
						Case when @MoveCostWithclientCommCredit = 1 then @CostGuid end,
						@AcCustOwnerGuid as [ObverseAcGuid],
						@AcCommissionFromOwnerNote
			end

				if @CommissionFromSalesManValue > 0
				begin
						Set @DetailNum = @DetailNum + 1
						Insert into [DEntry]
		 				([ParentGuid],[Number],[AcGuid],[Debit],[Credit],[CurrencyGuid],[CurrencyVal],[CostGuid],[ObverseAcGuid],[Note])
						Select
							@EnGuid,
							@DetailNum,
							@AcCommissionExpenseGuid,
							@CommissionFromSalesManValue as Debit,
							0 as Credit,
							@CurrencyGuid,
							@CurrencyVal,
							Case when @MoveCost = 1 then @CostGuid end,
							@AcSalesManCommissionGuid as [ObverseAcGuid],
							Case when @SalesManCommNote <> '' then @SalesManCommNote else @EntryNote end

						Set @DetailNum = @DetailNum + 1
						Insert into [DEntry]
		 				([ParentGuid],[Number],[AcGuid],[Debit],[Credit],[CurrencyGuid],[CurrencyVal],[CostGuid],[ObverseAcGuid],[Note])
						Select
							@EnGuid,
							@DetailNum,
							@AcSalesManCommissionGuid,
							0 as Debit,
							@CommissionFromSalesManValue as Credit,
							@CurrencyGuid,
							@CurrencyVal,
							Case when @MoveCostWithclientCommCredit = 1 then @CostGuid end,
							@AcCommissionExpenseGuid as [ObverseAcGuid],
							Case when @SalesManCommNote <> '' then @SalesManCommNote else @EntryNote end
				end

			if @CertificatValue > 0
			begin
					Set @DetailNum = @DetailNum + 1
					Insert into [DEntry]
					([ParentGuid],[Number],[AcGuid],[Debit],[Credit],[CurrencyGuid],[CurrencyVal],[CostGuid],[ObverseAcGuid],[Note])
					Select
						@EnGuid,
						@DetailNum,
						@CustAccountGuid,
						@CertificatValue,
						0,
						@CurrencyGuid,
						@CurrencyVal,
						Case when @MoveCost = 1 then @CostGuid end,
						@AccountCertificatValueGuid,
						@EntryNote

					Set @DetailNum = @DetailNum + 1
					Insert into [DEntry]
					([ParentGuid],[Number],[AcGuid],[Debit],[Credit],[CurrencyGuid],[CurrencyVal],[CostGuid],[ObverseAcGuid],[Note])
					Select
						@EnGuid,
						@DetailNum,
						@AccountCertificatValueGuid,
						0 as Debit,
						@CertificatValue as Credit,
						@CurrencyGuid,
						@CurrencyVal,
						Case when @MoveCostWithCertificatCredit = 1 then @CostGuid end,
						@CustAccountGuid as [ObverseAcGuid],
						@EntryNote
			end	
			if @OtherFee > 0
			begin
					Set @DetailNum = @DetailNum + 1
					Insert into [DEntry]
					([ParentGuid],[Number],[AcGuid],[Debit],[Credit],[CurrencyGuid],[CurrencyVal],[CostGuid],[ObverseAcGuid],[Note])
					Select
						@EnGuid,
						@DetailNum,
						@CustAccountGuid,
						@OtherFee as Debit,
						0 as Credit,
						@CurrencyGuid,
						@CurrencyVal,
						Case when @MoveCost = 1 then @CostGuid end,
						@OtherFeeAccountGuid as [ObverseAcGuid],
						@EntryNote

					Set @DetailNum = @DetailNum + 1
					Insert into [DEntry]
					([ParentGuid],[Number],[AcGuid],[Debit],[Credit],[CurrencyGuid],[CurrencyVal],[CostGuid],[ObverseAcGuid],[Note])
					Select
						@EnGuid,
						@DetailNum,
						@OtherFeeAccountGuid,
						0 as Debit,
						@OtherFee as Credit,
						@CurrencyGuid,
						@CurrencyVal,
						Case when @MoveCostWithFeeCredit = 1 then @CostGuid end,
						@CustAccountGuid as [ObverseAcGuid],
						@EntryNote
			end	
			
			exec [dbo].[PrcCreateEntryFromLandContractFee] @ContractGuid

			if @ContractPrice > 0
			begin
					Set @DetailNum = @DetailNum + 1
					Insert into [DEntry]
					([ParentGuid],[Number],[AcGuid],[Debit],[Credit],[CurrencyGuid],[CurrencyVal],[CostGuid],[ObverseAcGuid],[Note])
					Select
						@EnGuid,
						@DetailNum,
						@CustAccountGuid,
						@ContractPrice as Debit,
						0 as Credit,
						@CurrencyGuid,
						@CurrencyVal,
						Case when @MoveCost = 1 then @CostGuid end,
						@AccountContractPriceGuid as [ObverseAcGuid],
						@EntryNote

					Set @DetailNum = @DetailNum + 1
					Insert into [DEntry]
					([ParentGuid],[Number],[AcGuid],[Debit],[Credit],[CurrencyGuid],[CurrencyVal],[CostGuid],[ObverseAcGuid],[Note])
					Select
						@EnGuid,
						@DetailNum,
						@AccountContractPriceGuid,
						0 as Debit,
						@ContractPrice as Credit,
						@CurrencyGuid,
						@CurrencyVal,
						Case when @MoveCostWithFeeCredit = 1 then @CostGuid end,
						@CustAccountGuid as [ObverseAcGuid],
						@EntryNote
			end	
		end

		if (@DiscountValue > 0) and (@UnearnedrRevenue = 0)
		begin
				Set @DetailNum = @DetailNum + 1
					Insert into [DEntry]
					([ParentGuid],[Number],[AcGuid],[Debit],[Credit],[CurrencyGuid],[CurrencyVal],[CostGuid],[ObverseAcGuid],[Note])
					Select
					@EnGuid,
					@DetailNum,
					@DiscountAccountGuid,
					@DiscountValue as Debit,
					0 as Credit,
					@CurrencyGuid,
					@CurrencyVal,
					Case when @MoveCostWithDiscount = 1 then @CostGuid end,
					@custAccountGuid,
					dbo.SC('  ') + @EntryNote

				Set @DetailNum = @DetailNum + 1
				Insert into [DEntry]
				([ParentGuid],[Number],[AcGuid],[Debit],[Credit],[CurrencyGuid],[CurrencyVal],[CostGuid],[ObverseAcGuid],[Note])
				Select
					@EnGuid,
					@DetailNum,
					@custAccountGuid,
					0,
					@DiscountValue,
					@CurrencyGuid,
					@CurrencyVal,
					Case when @MoveCostWithDiscountCredit = 1 then @CostGuid end,
					@DiscountAccountGuid as [ObverseAcGuid],
					dbo.SC('  ') + @EntryNote
		end	

		exec PrcDoDistributiveEntry @EnGuid
		
		Update [Hentry] Set IsPosted = 1 where Guid = @EnGuid
		

GO

SET ANSI_NULLS, QUOTED_IDENTIFIER ON
GO

Create view [vwLeaseApartment]
 
as
	Select 
		[TypeGuid],
		[EditDate],
		[DeliverDate],
		[Mark],
		[ContractNo],
		[T].[Name] as [TypeName],
		[T].[Name]+ ' / ' + Cast([A].[Number] as Varchar(10)) as [ArLeaseKind],
		[B].[Name] as [BuildingName],
		[B].[ArName] as [BuildingArName],
		[B].[LtnName] as [BuildingLtnName],

		[B].[Name] +' '+
		Case when [T].[ContractKind] = 0 then dbo.SC(' ')
			 when [T].[ContractKind] = 1 then dbo.SC(' ')
			 when [T].[ContractKind] = 2 then dbo.SC(' ')
			 when [T].[ContractKind] = 3 then dbo.SC(' ') end
		+' /'+
		Case when Isnull([P].[Guid],0x0) <> 0x0 then isNull([B].[BuildingCode],'') + Isnull([P].[No],P.Number ) 
			 when Isnull([S].[Guid],0x0) <> 0x0 then Isnull([S].[No],S.Number ) 
		 end +'/' 
		as [ApartmentNo],
		
		[B].[BuildingCode],
		Case when Isnull([P].[No],'') <> '' then [B].[BuildingCode]+[P].[No]
			 when Isnull([S].[No],'') <> '' then [S].[No]
		end as [FlatNo],
		 
		Case when Isnull([P].[No],'') <> '' then [P].[FlatKind]
			 when Isnull([S].[No],'') <> '' then [S].[ShopKind]
		 end as [FlatKind],
		[T].[ContractKind],
		[T].[ContractKind] as [Leasekind],
		[T].[Name] + Cast([A].[Number] as Varchar(10))  as [Contract], 

		isnull([P].[Guid],0x0) as [FlatGuid],
		isnull([S].[Guid],0x0) as [ShopGuid],
		A.[ApartmentGuid],		
		Case when isnull([P].[Guid],0x0) <> 0x0 then [P].[FlatOwner] else [S].[FlatOwner] end as [FlatOwner],
		[Cu].[Name] as [CustName],
		[Cu].[ArName] as [CustArName],
		[Cu].[LtnName] as [CustLtnName],
		[Cu].[Phonejob] as [CustomerPhonejob],
		[Cu].[Mobile] as [CustomerMobile],
		[Cu].[Nationality] as [CustomerNationality],
		[Cu].[accountBalance],
		[A].[BuildingGuid],
		[A].[SalesManGuid],
		[A].[Guid],
		[A].[Number],
		[A].[CustomerGuid],
		Case when Isnull([P].[No],'') <> '' then [P].[ApartmentType]
			 when Isnull([S].[No],'') <> '' then [S].[Description]
		 end as [ApartmentType],
		[A].[FromDate],
		dbo.fnDate([A].[FromDate]) as [FromDateHG],
		[A].[ToDate],
		dbo.fnDate([A].[ToDate]) as [ToDateHG],
		DATEDIFF(DAY, A.ToDate, A.FromDate) as ContractDays,
		Case when A.ContractFinish = 1 then 
		DATEDIFF(DAY, A.ToDate, A.ContractFinishDate) 
		end as ContractDaysDifference,
		
		[A].[Rent],
		[A].[RentContractType],
		[A].[MonthlyValue],
		[A].[MonthlyValue] * 12.00 as [YearValue],
		[A].[CurrencyGuid],
		[A].[CurrencyVal],
		[A].[PayType],
		[A].[Note],
		[A].[Note2],
		[A].[Purpose],
		[A].[RevenueAccountGuid],
		[A].[CustAccountGuid],
		[A].[CommissionFromCustPercent],
		[A].[CommissionFromCustValue],
		[A].[AcCommissionFromCustGuid],
		[A].[CommissionFromOwnerPercent],
		[A].[CommissionFromOwnerValue],
		[A].[AcCommissionFromOwnerGuid],
		[A].[ContractFinish],
		[A].[ContractFinishDate],
		[A].[EditContractFinishDate],
		[A].[ResultingAmount],
		[A].[Fine],
		[A].[FineAccount],
		[A].[CreateResultingEntry],
		[A].[InsuranceValue],
		[A].[InsuranceValueOld],
		[A].[ContractPrice],
		[A].[AccountContractPrice],
		[A].[CertificatValue],
		[A].[AccountCertificatValue],
		[A].[RentDuration],
		[A].[Rentype],
		[A].[TermsOfPayment],
		[A].[Seclvl],
		[A].[RentInfoGuid],
		[A].[Step1Complete],
		[A].[Step2Complete],
		[A].[Step3Complete],
		[A].[Step4Complete],
		[A].[Step5Complete],
		[A].[Certification],
		[A].[ElectricityInsurance],
		[A].[ResidentCount],
		[A].[CreateContractEntry],
		[A].[Whereabouts],		
		[A].[DiscountPercent],
		[A].[DiscountValue],
		[A].[Rent] - [A].[DiscountValue] as [RentAfterDiscount],	
		[A].[DiscountAccountGuid],
		[Cr].[Code] as [CurrencyName],
		[A].[BranchGuid],
		[A].[ResultingAmount2],
		[A].[RoundKind],

		Case 
			when ([T].[ContractKind] = 0) or ([T].[ContractKind] = 1) then 
				Case 
					when 
						Case when [ContractFinish] = 0 then [ToDate] else [ContractFinishDate] end 
						<= GetDate() then -- 
											Case when [ContractFinish] = 0 then dbo.SC('     ') 
											else
											dbo.SC('    ') end
					when 
						Case when [ContractFinish] = 0 then [ToDate] else [ContractFinishDate] end 
						> GetDate() then dbo.SC(' ') 
				end
			when ([T].[ContractKind] = 2) or ([T].[ContractKind] = 3) then dbo.SC('')
				
		end as [ContractState],

		Case 
			when ([T].[ContractKind] = 0) or ([T].[ContractKind] = 1) then 
				Case 
					when [ContractFinish] = 0 then dbo.SC('') 
					else
					Case 
							when 
								exists(Select 
									Guid
								From 
										LeaseApartment [Q] 
								where 
									[T].[ContractKind] = [T].[ContractKind]
									and [Q].[CustomerGuid] = [A].[CustomerGuid]
									and [Q].[ApartmentGuid] = [A].[ApartmentGuid]
									and [Q].[FromDate] >= [A].[ContractFinishDate]
									and [Q].[Guid] <> [A].[Guid]
								)  then dbo.SC(' ') 
					else
						dbo.SC(' ') 
					end
				end
			when ([T].[ContractKind] = 2) or ([T].[ContractKind] = 3) then ''
		end as [FlatState],
		[A].[Period],
		[p].[FloorNo],

		[B].[Emirate],
		[B].[Area] as [BuildingArea],
		[B].[Suburb],
		[B].[Street],
		[B].[BasinNo],
		[B].[PieceNo],
		[B].[BuildingNo],
		[B].[BondType],
		[B].[BondNo],

		[B].[BankName] as [BuildingBankName],
		[B].[BankAccCode] as [BuildingBankAccCode],

		[P].[Class],
		Case when isnull([P].[Guid],0x0) <> 0x0 then [P].[Area] else [S].[Area] end as [FlatArea],
		Case when isnull([P].[Guid],0x0) <> 0x0 then [P].[unity] else [S].[unity] end as [FlatAreaunity],
		[A].[ElectricityCounter],
		[A].[FineRevenueAccountGUID],
		Case when [ContractFinish] = 0 then [ToDate] else [ContractFinishDate]  end as [EndDate],
		[A].[ResultingNote],
		[A].[FineNote],
		[A].[NewState],
		Case when [A].[NewState] = 0 then dbo.SC('') else dbo.SC('') End as [NewStateStr],
		[A].[InsuranceValuePercent],
		[A].[OtherFee],
		[A].[OtherFeeAccountGUID],

		[A].[License1No],
		[A].[License2No],
		[A].[License3No],
		[A].[License1Date1],
		[A].[License2Date1],
		[A].[License3Date1],
		[A].[License1Date2],
		[A].[License2Date2],
		[A].[License3Date2],
		[A].[Ltnwhereabouts],
		[A].[LtnPurpose],
		[A].[LtnRentDuration],
		[A].[LtnRentype],
		[A].[LtnTermsOfPayment],
		[A].[Trademark],

		Case when Isnull([P].[Guid],0x0) <> 0x0 then [P].[CostGuid]
			 when Isnull([S].[Guid],0x0) <> 0x0 then [S].[CostGuid]
		 end as [UnitCostGuid],
		 
		Case when Isnull([P].[Guid],0x0) <> 0x0 then [P].[Judicial]
			 when Isnull([S].[Guid],0x0) <> 0x0 then [S].[Judicial]
		 end as [Judicial],
		[A].[CostGuid],
		[AcCommissionFromCustNote],
		[AcCommissionFromOwnerNote],
		A.[IsRounded],
		[Leave],
		[LeaveDate],
		[CountOldContract],
		A.[InsuranceAccountGuid],
		[A].[AcquittancePrinted],
		[A].[AcquittancePrintDate],
		[A].[Judicial] as [ContractJudicial],
		[A].AcquittancePrintedByGuid,
		[A].[PrvContractGuid],
		[T].[OpNewContract],
		A.IsAutoRenewal,
		A.AcIncomNextYearGuid,
		A.IsReturnInsurance,
		A.ReturnInsuranceDate,
		A.[AddPercent],
		A.[AddValue],
		A.[CommissionFromSalesManrPercent],
		A.[CommissionFromSalesManValue],
		A.[AcSalesManCommissionGuid],
		A.[AcCommissionExpenseGuid],
		A.[SalesManCommNote]
	from 
		[vbLeaseApartment] [A]
		inner join [vwContractType] [T] on [T].[Guid] = [A].[TypeGuid]
		inner join [vwBuilding] [B] On [A].[BuildingGuid] = [B].[Guid]
		left join [Apartment] [P] on [P].[Guid] = [A].[ApartmentGuid]
		left join [Shop] [S] on [S].[Guid] = [A].[ApartmentGuid]
		left join [vwcustomer] [Cu] On [Cu].[Guid] = [A].[CustomerGuid]
		inner join [Currency] [Cr] On [Cr].[Guid] = [A].[CurrencyGuid]


GO

SET ANSI_NULLS, QUOTED_IDENTIFIER ON
GO

Create Procedure [PrcAutoRenewalContract]
(
	@MaxDate int = 42644,
	@EndOnly Bit = 1
)
 
as
	
	Declare @RC int

	----Diable Index
	exec PrcCheckIndex '', 'LeaseApartment', 0

	--
	Declare @SalesMan uniqueidentifier	
	Select @SalesMan = [Str] from [Realty_Detail_users]
    where [ParentGuid]=(Select Top 1 userGuid from CurrentUsers where Spid = @@spid)
    and [IdCard]= 34
    
    if @SalesMan = 0x0
    Set @SalesMan = Null
    
	--    
	Select
		ApartmentGuid,
		MAX(FromDate) as FromDate
	into #LastContract
    From 	
		LeaseApartment [Tb]
		inner join Resource R on R.Guid = tb.Guid and Spid = @@Spid
	where
		[Tb].[IsAutoRenewal] = 1
	Group by
		ApartmentGuid
	
	-- 
	if @EndOnly = 1 
	Update
		LeaseApartment
	set
		ContractFinish = 1,
		ContractFinishDate = tb.ToDate
    From 	
		LeaseApartment [Tb]
		inner join [vwContractType] [T] on [T].[Guid] = [tb].[TypeGuid]
		inner join Resource R on R.Guid = tb.Guid and Spid = @@Spid
		
		inner join #LastContract L on L.ApartmentGuid = tb.ApartmentGuid and L.FromDate = tb.FromDate
	where
		--(([Tb].[IsAutoRenewal] = 1) or (@EndOnly = 1))and
		 (isNull(ContractFinish,0) = 0)
		--and Tb.Guid Not in (Select Guid from #T_RNConmp_contra)

	Set @RC = @@ROWCOUNT

	
	if @EndOnly = 1 
	begin
		Select 
			@RC as [RowCount],
			0 as FailCount

		return
	end
	
	-- 
	Declare @p_FromDate Datetime,
			@p_ToDate Datetime,
			@P_RealtyGuid uniqueidentifier
			
	Create Table #T_RNConmp_contra
	(Number int, Guid uniqueidentifier)
	DECLARE @cursor_Name CURSOR 
	Set @cursor_Name = CURSOR FAST_FORWARD FOR 

	Select
		[Tb].[ApartmentGuid], 
		Case 
			when [ContractFinish] = 0 then Dateadd(Day,1,[ToDate]) 
			when [ContractFinish] = 1 then Dateadd(Day,1,[ContractFinishDate]) 
		end as [FromDate],
		
		Case when Period <> 12 then dbo.FnAddDate('m',Period+1,
											Case 
												when [ContractFinish] = 0 then [ToDate]
												when [ContractFinish] = 1 then [ContractFinishDate]
											end)
			 when Period = 12 then Dateadd(Day,DATEDIFF(Day, [Tb].Fromdate, [Tb].Todate),
											Case 
												when [ContractFinish] = 0 then [ToDate]
												when [ContractFinish] = 1 then [ContractFinishDate]
											end)
		end as [ToDate]
	From 	
		LeaseApartment [Tb]
		inner join [vwContractType] [T] on [T].[Guid] = [tb].[TypeGuid]
		inner join Resource R on R.Guid = tb.Guid and Spid = @@Spid
		
		inner join #LastContract L on L.ApartmentGuid = tb.ApartmentGuid and L.FromDate = tb.FromDate
	where
		([Tb].[IsAutoRenewal] = 1) or (@EndOnly = 1)
	
	OPEN @cursor_Name
	FETCH NEXT FROM @cursor_Name INTO @P_RealtyGuid, @p_FromDate, @p_ToDate
			
	WHILE @@FETCH_STATUS = 0
	BEGIN
		insert into #T_RNConmp_contra
		exec PrcTestRentedFlat 0x0, @P_RealtyGuid, @p_FromDate, @p_ToDate
	  FETCH NEXT FROM @cursor_Name INTO @P_RealtyGuid, @p_FromDate, @p_ToDate
	
	END
	
	CLOSE @cursor_Name
	DEALLOCATE @cursor_Name
	-------------
	
	Update
		LeaseApartment
	set
		ContractFinish = 1,
		ContractFinishDate = tb.ToDate
    From 	
		LeaseApartment [Tb]
		inner join [vwContractType] [T] on [T].[Guid] = [tb].[TypeGuid]
		inner join Resource R on R.Guid = tb.Guid and Spid = @@Spid
		
		inner join #LastContract L on L.ApartmentGuid = tb.ApartmentGuid and L.FromDate = tb.FromDate
	where
		([Tb].[IsAutoRenewal] = 1) 
		and (isNull(ContractFinish,0) = 0)
		and Tb.Guid Not in (Select Guid from #T_RNConmp_contra)

	insert into dbo.[LeaseApartment] 
	([Number], [Guid], [SecLvl], [EditDate], [Mark], [TypeGuid], [ContractNo], [CustomerGuid], [RentInfoGuid], [SalesManGuid], [BuildingGuid], [ApartmentGuid], [ApartmentType], [CostGuid], [FromDate], [ToDate], [Period], [RentContractType], [Rent], [MonthlyValue], [CurrencyGuid], [CurrencyVal], [PayType], [Note], [Note2], [Trademark], [Purpose], [Whereabouts], [LeaseKind], [RevenueAccountGuid], [CustAccountGuid], [CommissionFromCustPercent], [CommissionFromCustValue], [AcCommissionFromCustGuid], [AcCommissionFromCustNote], [CommissionFromOwnerPercent], [CommissionFromOwnerValue], [AcCommissionFromOwnerGuid], [AcCommissionFromOwnerNote], [CreateContractEntry], [ContractFinish], [ContractFinishDate], [ResultingAmount], [ResultingAmount2], [RoundKind], [ResultingNote], [Fine], [FineAccount], [CreateResultingEntry], [FineNote], [InsuranceValuePercent], [InsuranceValue], [InsuranceAccountGuid], [InsuranceValueOld], [ContractPrice], [AccountContractPrice], [CertificatValue], [AccountCertificatValue], [RentDuration], [Rentype], [TermsOfPayment], [ResidentCount], [ElectricityInsurance], [Step1Complete], [Step2Complete], [Step3Complete], [Step4Complete], [Step5Complete], [Certification], [DiscountPercent], [DiscountValue], [DiscountAccountGuid], [UserGuid], [BranchGuid], [ElectricityCounter], [FineRevenueAccountGUID], [NewState], [OtherFee], [OtherFeeAccountGUID], [License1No], [License2No], [License3No], [License1Date1], [License2Date1], [License3Date1], [License1Date2], [License2Date2], [License3Date2], [Ltnwhereabouts], [LtnPurpose], [LtnRentDuration], [LtnRentype], [LtnTermsOfPayment], [IsRounded], [Leave], [LeaveDate], [CountOldContract], [AcquittancePrinted], [AcquittancePrintDate], [AcquittancePrintedByGuid], [Judicial], [PrvContractGuid],  [IsAutoRenewal])
	Select	
		Null as [Number], 
		Newid() as [Guid], 
		[Tb].[SecLvl], 
		dbo.fndateonly(GETDATE()) as [EditDate], 
		[Tb].[Mark], 
		[Tb].[TypeGuid], 
		[Tb].[ContractNo]+'/2' as [ContractNo], 
		[Tb].[CustomerGuid], 
		[Tb].[RentInfoGuid], 
		@SalesMan as [SalesManGuid], 
		[Tb].[BuildingGuid], 
		[Tb].[ApartmentGuid], 
		[Tb].[ApartmentType], 
		[Tb].[CostGuid], 
		Case 
			when [ContractFinish] = 0 then Dateadd(Day,1,[ToDate]) 
			when [ContractFinish] = 1 then Dateadd(Day,1,[ContractFinishDate]) 
		end as [FromDate],
		
		Case when Period <> 12 then dbo.FnAddDate('m',Period+1,
											Case 
												when [ContractFinish] = 0 then [ToDate]
												when [ContractFinish] = 1 then [ContractFinishDate]
											end)
			 when Period = 12 then Dateadd(Day,DATEDIFF(Day, [Tb].Fromdate, [Tb].Todate),
											Case 
												when [ContractFinish] = 0 then [ToDate]
												when [ContractFinish] = 1 then [ContractFinishDate]
											end)
		end as [ToDate],
		[Tb].[Period], 
		[Tb].[RentContractType], 
		[Tb].[Rent], 
		[Tb].[MonthlyValue], 
		[Tb].[CurrencyGuid], 
		[Tb].[CurrencyVal], 
		[Tb].[PayType], 
		[Tb].[Note], 
		[Tb].[Note2], 
		[Tb].[Trademark], 
		[Tb].[Purpose], 
		[Tb].[Whereabouts], 
		[Tb].[LeaseKind], 
		[Tb].[RevenueAccountGuid], 
		[Tb].[CustAccountGuid], 
		case when SUBSTRING([OpNewContract], 4, 1) = '1' then [CommissionFromCustPercent] else 0 end [CommissionFromCustPercent], 
		case when SUBSTRING([OpNewContract], 4, 1) = '1' then [CommissionFromCustValue] else 0 end as [CommissionFromCustValue],
		[Tb].[AcCommissionFromCustGuid], 
		[Tb].[AcCommissionFromCustNote], 
		case when SUBSTRING([OpNewContract], 5, 1) = '1' then [CommissionFromOwnerPercent] else 0 end [CommissionFromOwnerPercent], 
		case when SUBSTRING([OpNewContract], 5, 1) = '1' then [CommissionFromOwnerValue] else 0 end [CommissionFromOwnerValue],
		[Tb].[AcCommissionFromOwnerGuid], 
		[Tb].[AcCommissionFromOwnerNote], 
		[Tb].[CreateContractEntry], 
		Cast( 0 as bit) as [ContractFinish], 
		Cast( Null as DateTime)  as [ContractFinishDate],
		0 as [ResultingAmount],
		0 as [ResultingAmount2],
		[Tb].[RoundKind], 
		[Tb].[ResultingNote], 
		0 as [Fine],
		[Tb].[FineAccount], 
		Cast( 0 as bit) as [CreateResultingEntry],
		[Tb].[FineNote], 
		[Tb].[InsuranceValuePercent], 
		0 as [InsuranceValue],
		[Tb].[InsuranceAccountGuid], 
		[InsuranceValue] + Isnull([InsuranceValueOld],0) as [InsuranceValueOld],
		case when SUBSTRING([OpNewContract], 1, 1) = '1' then [ContractPrice] else 0 end as [ContractPrice], 
		[Tb].[AccountContractPrice], 
		case when SUBSTRING([OpNewContract], 2, 1) = '1' then [CertificatValue] else 0 end [CertificatValue],
		[Tb].[AccountCertificatValue], 
		[Tb].[RentDuration], 
		[Tb].[Rentype], 
		[Tb].[TermsOfPayment], 
		[Tb].[ResidentCount], 
		[Tb].[ElectricityInsurance], 
		[Tb].[Step1Complete], 
		[Tb].[Step2Complete], 
		[Tb].[Step3Complete], 
		[Tb].[Step4Complete], 
		[Tb].[Step5Complete], 
		[Tb].[Certification], 
		[Tb].[DiscountPercent], 
		[Tb].[DiscountValue], 
		[Tb].[DiscountAccountGuid], 
		[Tb].[UserGuid], 
		[Tb].[BranchGuid], 
		[Tb].[ElectricityCounter], 
		[Tb].[FineRevenueAccountGUID], 
		[Tb].[NewState], 
		case when SUBSTRING([OpNewContract], 3, 1) = '1' then [OtherFee] else 0 end OtherFee,		
		
		[Tb].[OtherFeeAccountGUID], 
		[Tb].[License1No], 
		[Tb].[License2No], 
		[Tb].[License3No], 
		[Tb].[License1Date1], 
		[Tb].[License2Date1], 
		[Tb].[License3Date1], 
		[Tb].[License1Date2], 
		[Tb].[License2Date2], 
		[Tb].[License3Date2], 
		[Tb].[Ltnwhereabouts], 
		[Tb].[LtnPurpose],
		[Tb].[LtnRentDuration],
		[Tb].[LtnRentype],
		[Tb].[LtnTermsOfPayment],
		[Tb].[IsRounded],
		[Tb].[Leave],
		[Tb].[LeaveDate],
		[Tb].[CountOldContract],
		[Tb].[AcquittancePrinted],
		[Tb].[AcquittancePrintDate],
		[Tb].[AcquittancePrintedByGuid],
		[Tb].[Judicial],
		[Tb].[PrvContractGuid],
		[Tb].[IsAutoRenewal]
	From 	
		LeaseApartment [Tb]
		inner join [vwContractType] [T] on [T].[Guid] = [tb].[TypeGuid]
		inner join Resource R on R.Guid = tb.Guid and Spid = @@Spid
		
		inner join #LastContract L on L.ApartmentGuid = tb.ApartmentGuid and L.FromDate = tb.FromDate
	where
		[Tb].[IsAutoRenewal] = 1
		and Tb.ApartmentGuid Not in (Select Guid from #T_RNConmp_contra)
	
	Set @RC = @@ROWCOUNT
	
	Declare @CreateEntry bit, 
			@Guid uniqueidentifier,
			@TypeGuid uniqueidentifier
			
	--  
		Create Table #T_RNCon
		(
			[Id] int Identity(1,1),
			[Guid] Uniqueidentifier,
			[TypeGuid] Uniqueidentifier,
			CreateEntry bit
		)
		insert into #T_RNCon
		([Guid], [TypeGuid],CreateEntry)	
		Select 
			[Guid],
			[TypeGuid],
			CreateContractEntry
		From
			[LeaseApartment]
		where 
			[Number] is Null
		Order By
			[FromDate]

		Alter Table [LeaseApartment] Disable Trigger All
		
		--	  
		DECLARE cursor_Name CURSOR FAST_FORWARD FOR 
		Select Guid, [TypeGuid],CreateEntry from #T_RNCon
		
		OPEN cursor_Name
		FETCH NEXT FROM cursor_Name INTO @Guid, @TypeGuid,@CreateEntry
		
		WHILE @@FETCH_STATUS = 0
		BEGIN
			Update [LeaseApartment] Set Number = (Select Max(Number) + 1 From [LeaseApartment] where TypeGuid = @TypeGuid)
			where 
				(Guid = @Guid )
				
			if @CreateEntry = 1
			begin
				exec [PrcCreateContractFlatShopEntry] @Guid, @MaxDate
			end
			else
			begin
				Delete HEntry where Guid = @Guid 
			end
			
		  FETCH NEXT FROM cursor_Name INTO @Guid, @TypeGuid,@CreateEntry
		
		END
		
		CLOSE cursor_Name
		DEALLOCATE cursor_Name
		
		
		Alter Table [LeaseApartment] Enable Trigger All

	
	exec PrcCheckIndex '', 'LeaseApartment', 1
	
	Select 
		@RC as [RowCount],
		(Select Count(*) from #T_RNConmp_contra) as FailCount


GO
